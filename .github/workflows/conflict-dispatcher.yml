name: conflict-dispatcher

on:
  push:
    branches: [master]

jobs:
  find-and-dispatch:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
      actions: write
    steps:
      - name: Find conflicting PRs and trigger restacks
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          REPO="${{ github.repository }}"

          # Get all open PRs
          echo "Fetching open PRs..."
          prs=$(gh api "repos/$REPO/pulls" --jq '.[] | {number: .number, head_ref: .head.ref, base_ref: .base.ref}')

          if [ -z "$prs" ]; then
            echo "No open PRs found"
            exit 0
          fi

          echo "Found PRs:"
          echo "$prs" | jq -c '.'

          # Process each PR
          echo "$prs" | jq -c '.' | while read -r pr; do
            pr_number=$(echo "$pr" | jq -r '.number')
            head_ref=$(echo "$pr" | jq -r '.head_ref')
            base_ref=$(echo "$pr" | jq -r '.base_ref')

            echo ""
            echo "Checking PR #$pr_number (branch: $head_ref, base: $base_ref)..."

            # Skip stacked PRs (base branch is not master/main)
            if [ "$base_ref" != "master" ] && [ "$base_ref" != "main" ]; then
              echo "  Skipping: stacked PR (base is $base_ref)"
              continue
            fi

            # Get mergeable state (requires separate API call for each PR)
            # Note: GitHub may return null for mergeable if it hasn't computed yet
            pr_details=$(gh api "repos/$REPO/pulls/$pr_number" --jq '{mergeable: .mergeable, mergeable_state: .mergeable_state}')
            mergeable=$(echo "$pr_details" | jq -r '.mergeable')
            mergeable_state=$(echo "$pr_details" | jq -r '.mergeable_state')

            echo "  Mergeable: $mergeable, State: $mergeable_state"

            # Handle unknown state - GitHub may not have computed mergeability yet
            if [ "$mergeable" = "null" ] || [ "$mergeable_state" = "unknown" ]; then
              echo "  Skipping: mergeable state unknown (GitHub still computing)"
              continue
            fi

            # Only process PRs with conflicts
            if [ "$mergeable_state" != "dirty" ]; then
              echo "  Skipping: no conflicts (state: $mergeable_state)"
              continue
            fi

            echo "  PR #$pr_number has conflicts - triggering auto-restack"

            # Add has-conflicts label
            gh pr edit "$pr_number" --add-label "has-conflicts" 2>/dev/null || \
              gh label create "has-conflicts" --color "d93f0b" --description "PR has merge conflicts" 2>/dev/null && \
              gh pr edit "$pr_number" --add-label "has-conflicts"

            # Trigger auto-restack workflow
            gh workflow run auto-restack.yml \
              -f pr_number="$pr_number" \
              -f branch="$head_ref"

            echo "  Triggered auto-restack for PR #$pr_number"
          done

          echo ""
          echo "Conflict dispatcher complete"
