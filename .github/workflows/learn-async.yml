# REQUIRED REPOSITORY SETTING:
# Settings > Actions > General > Workflow permissions
# ✓ Enable "Allow GitHub Actions to create and approve pull requests"
#
# Without this setting, PR creation will fail with:
# "GitHub Actions is not permitted to create or approve pull requests"

name: learn-async
run-name: "Learn async: #${{ inputs.issue_number }}${{ inputs.distinct_id && format(':{0}', inputs.distinct_id) || '' }}"

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Plan issue number to learn from"
        required: true
        type: string
      model_name:
        description: "Claude model to use"
        required: false
        type: string
        default: "claude-haiku-4-5"
      distinct_id:
        description: "Unique identifier for run discovery (base36)"
        required: false
        type: string
        default: ""

concurrency:
  group: learn-async-${{ inputs.issue_number }}
  cancel-in-progress: true

jobs:
  learn:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Validate required secrets
        env:
          ERK_PAT: ${{ secrets.ERK_QUEUE_GH_PAT }}
        run: |
          if [ -z "$ERK_PAT" ]; then
            echo "::error title=Missing Secret::ERK_QUEUE_GH_PAT secret is not configured or has expired. Add a PAT with 'repo' scope at: Settings → Secrets and variables → Actions"
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.ERK_QUEUE_GH_PAT }}
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          python-version: "3.13"

      - name: Install Claude Code
        uses: ./.github/actions/setup-claude-code

      - name: Install erk
        run: uv tool install -e . --with-editable ./packages/erk-shared

      - name: Validate Claude credentials
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: erk exec validate-claude-credentials

      - name: Configure git
        run: |
          git config user.name "erk-bot"
          git config user.email "erk-bot@users.noreply.github.com"

      - name: Detect trunk branch
        id: trunk
        run: |
          result=$(erk exec detect-trunk-branch)
          echo "branch=$(echo "$result" | jq -r '.trunk_branch')" >> $GITHUB_OUTPUT

      - name: Create learn branch
        id: branch
        run: |
          BRANCH_NAME="learn-${{ inputs.issue_number }}-${{ github.run_id }}"
          git checkout -b "$BRANCH_NAME" "${{ steps.trunk.outputs.branch }}"
          git push -u origin "$BRANCH_NAME"
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Run learn command
        id: learn
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.ERK_QUEUE_GH_PAT }}
        run: |
          set +e
          claude --print \
            --model ${{ inputs.model_name }} \
            --output-format stream-json \
            --dangerously-skip-permissions \
            --verbose \
            "/erk:learn ${{ inputs.issue_number }}"
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit $EXIT_CODE

      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain docs/ .claude/) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and create PR
        id: create_pr
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.ERK_QUEUE_GH_PAT }}
        run: |
          git add docs/ .claude/
          git commit -m "Learn from plan #${{ inputs.issue_number }}"
          git push origin "${{ steps.branch.outputs.name }}"

          PR_RESPONSE=$(gh api repos/${{ github.repository }}/pulls \
            -X POST \
            -f title="Learn from plan #${{ inputs.issue_number }}" \
            -f body="Documentation updates extracted from plan #${{ inputs.issue_number }}.

          Generated by [learn-async workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})." \
            -f head="${{ steps.branch.outputs.name }}" \
            -f base="${{ steps.trunk.outputs.branch }}" \
            -f draft=true)

          PR_NUMBER=$(echo "$PR_RESPONSE" | jq -r '.number')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Update learn status (PR created)
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.ERK_QUEUE_GH_PAT }}
        run: |
          erk exec track-learn-result \
            --issue ${{ inputs.issue_number }} \
            --status pending_review \
            --plan-pr ${{ steps.create_pr.outputs.pr_number }}

      - name: Post comment if no changes
        if: steps.changes.outputs.has_changes == 'false'
        env:
          GH_TOKEN: ${{ secrets.ERK_QUEUE_GH_PAT }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ inputs.issue_number }}/comments \
            -X POST \
            -f body="No documentation updates extracted from this plan.

          [Workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

      - name: Update learn status (no plan)
        if: steps.changes.outputs.has_changes == 'false'
        env:
          GH_TOKEN: ${{ secrets.ERK_QUEUE_GH_PAT }}
        run: |
          erk exec track-learn-result \
            --issue ${{ inputs.issue_number }} \
            --status completed_no_plan

      - name: Cleanup branch if no changes
        if: steps.changes.outputs.has_changes == 'false'
        run: |
          git checkout "${{ steps.trunk.outputs.branch }}"
          git push origin --delete "${{ steps.branch.outputs.name }}" || true
