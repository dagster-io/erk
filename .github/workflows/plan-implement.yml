name: plan-implement
run-name: "${{ inputs.plan_id }}:${{ inputs.distinct_id }}"

on:
  workflow_dispatch:
    inputs:
      plan_id:
        description: "Plan identifier to implement"
        required: true
        type: string
      submitted_by:
        description: "GitHub username of the person who submitted the issue"
        required: true
        type: string
      distinct_id:
        description: "Unique identifier for run discovery (base36)"
        required: true
        type: string
      plan_title:
        description: "Plan title for workflow run display"
        required: true
        type: string
      branch_name:
        description: "Branch name for implementation (created by submit command)"
        required: true
        type: string
      pr_number:
        description: "PR number for implementation (created by submit command)"
        required: true
        type: string
      model_name:
        description: "Claude model to use for implementation"
        required: false
        type: string
        default: "claude-opus-4-6"
      base_branch:
        description: "Base branch for the implementation PR (may be stacked, not always trunk)"
        required: true
        type: string
      plan_backend:
        description: "Plan backend type (github or draft_pr)"
        required: false
        type: string
        default: "github"
  workflow_call:
    inputs:
      plan_id:
        description: "Plan identifier to implement"
        required: true
        type: string
      submitted_by:
        description: "GitHub username of the person who submitted the issue"
        required: true
        type: string
      distinct_id:
        description: "Unique identifier for run discovery (base36)"
        required: false
        type: string
        default: "called"
      plan_title:
        description: "Plan title for workflow run display"
        required: true
        type: string
      branch_name:
        description: "Branch name for implementation (created by submit command)"
        required: true
        type: string
      pr_number:
        description: "PR number for implementation (created by submit command)"
        required: true
        type: string
      model_name:
        description: "Claude model to use for implementation"
        required: false
        type: string
        default: "claude-opus-4-6"
      base_branch:
        description: "Base branch for the implementation PR (may be stacked, not always trunk)"
        required: true
        type: string
      plan_backend:
        description: "Plan backend type (github or draft_pr)"
        required: false
        type: string
        default: "github"

concurrency:
  group: implement-plan-${{ inputs.plan_id }}
  cancel-in-progress: true

jobs:
  implement:
    if: vars.CLAUDE_ENABLED != 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: write
      pull-requests: write
      issues: write
    env:
      ERK_PLAN_BACKEND: ${{ inputs.plan_backend }}
    steps:
      - name: Validate required secrets
        env:
          ERK_PAT: ${{ secrets.ERK_QUEUE_GH_PAT }}
        run: |
          if [ -z "$ERK_PAT" ]; then
            echo "::error title=Missing Secret::ERK_QUEUE_GH_PAT secret is not configured or has expired. Add a PAT with 'repo' scope at: Settings → Secrets and variables → Actions"
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.ERK_QUEUE_GH_PAT }}
          fetch-depth: 0

      - uses: ./.github/actions/erk-remote-setup
        with:
          erk-pat: ${{ secrets.ERK_QUEUE_GH_PAT }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude-code-oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Detect trunk branch
        id: trunk
        run: |
          result=$(erk exec detect-trunk-branch)
          echo "trunk_branch=$(echo "$result" | jq -r '.trunk_branch')" >> $GITHUB_OUTPUT

      - name: Set branch and PR from inputs
        id: find_pr
        run: |
          echo "branch_name=${{ inputs.branch_name }}" >> $GITHUB_OUTPUT
          echo "pr_number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
          echo "pr_exists=true" >> $GITHUB_OUTPUT
          echo "Using branch: ${{ inputs.branch_name }}"
          echo "Using PR: #${{ inputs.pr_number }}"

      - name: Checkout implementation branch
        env:
          BRANCH_NAME: ${{ steps.find_pr.outputs.branch_name }}
          PLAN_ID: ${{ inputs.plan_id }}
          SUBMITTED_BY: ${{ inputs.submitted_by }}
          GH_TOKEN: ${{ github.token }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          git fetch origin "$BRANCH_NAME"
          git checkout "$BRANCH_NAME"
          rm -rf .worker-impl
          erk exec create-worker-impl-from-issue "$PLAN_ID"
          if [ $? -ne 0 ]; then
            if [ "$ERK_PLAN_BACKEND" = "draft_pr" ]; then
              gh pr comment "$PLAN_ID" --body "Could not fetch plan content for plan #$PLAN_ID."
            else
              gh issue comment "$PLAN_ID" --body "Could not fetch plan content for plan #$PLAN_ID."
            fi
            exit 1
          fi
          git config user.name "$SUBMITTED_BY"
          git config user.email "$SUBMITTED_BY@users.noreply.github.com"
          git add .worker-impl
          if [[ -n $(git status --porcelain) ]]; then
            git commit -m "Update plan for plan #$PLAN_ID (rerun)"
            git push origin "$BRANCH_NAME"
          fi
          echo "Checked out branch: $BRANCH_NAME"

      - name: Post workflow started comment
        env:
          PLAN_ID: ${{ inputs.plan_id }}
          BRANCH_NAME: ${{ steps.find_pr.outputs.branch_name }}
          PR_NUMBER: ${{ inputs.pr_number }}
          GH_TOKEN: ${{ github.token }}
        run: |
          erk exec post-workflow-started-comment \
            --plan-id "$PLAN_ID" \
            --branch-name "$BRANCH_NAME" \
            --pr-number "$PR_NUMBER" \
            --run-id "${{ github.run_id }}" \
            --run-url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --repository "${{ github.repository }}"

      - name: Add remote execution note to PR
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
          GH_TOKEN: ${{ github.token }}
          WORKFLOW_RUN_ID: ${{ github.run_id }}
          WORKFLOW_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          erk exec add-remote-execution-note \
            --pr-number "$PR_NUMBER" \
            --run-id "$WORKFLOW_RUN_ID" \
            --run-url "$WORKFLOW_RUN_URL"

      - name: Set up implementation folder
        run: |
          cp -r .worker-impl .impl
          echo "Copied .worker-impl/ to .impl/"
          cat > .impl/run-info.json <<EOF
          {
            "run_id": "${{ github.run_id }}",
            "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF
          echo "Created .impl/run-info.json"

      - name: Remove plan staging dirs from git tracking
        env:
          BRANCH_NAME: ${{ steps.find_pr.outputs.branch_name }}
          SUBMITTED_BY: ${{ inputs.submitted_by }}
        run: |
          NEEDS_CLEANUP=false
          git config user.name "$SUBMITTED_BY"
          git config user.email "$SUBMITTED_BY@users.noreply.github.com"
          if [ -d .worker-impl/ ]; then
            git rm -rf .worker-impl/
            NEEDS_CLEANUP=true
          fi
          if [ -d .erk/impl-context/ ]; then
            git rm -rf .erk/impl-context/
            NEEDS_CLEANUP=true
          fi
          if [ "$NEEDS_CLEANUP" = true ]; then
            git commit -m "Remove plan staging dirs before implementation"
            git push origin "$BRANCH_NAME"
            echo "Removed plan staging dirs from git tracking (content preserved in .impl/)"
          fi

      - name: Save pre-implementation HEAD
        id: pre_impl
        run: echo "head=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Run implementation
        id: implement
        run: |
          set +e
          claude --print \
            --model ${{ inputs.model_name }} \
            --output-format stream-json \
            --dangerously-skip-permissions \
            --verbose \
            "/erk:plan-implement $PLAN_ID"
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          if [ $EXIT_CODE -eq 0 ]; then
            echo "implementation_success=true" >> $GITHUB_OUTPUT
          else
            echo "implementation_success=false" >> $GITHUB_OUTPUT
          fi
          exit 0
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ inputs.pr_number }}
          PLAN_ID: ${{ inputs.plan_id }}

      - name: Capture session ID
        id: session
        if: always()
        run: |
          if OUTPUT=$(erk exec capture-session-info --path "$GITHUB_WORKSPACE" 2>/dev/null); then
            eval "$OUTPUT"
            echo "session_id=$SESSION_ID" >> "$GITHUB_OUTPUT"
            echo "session_file=$SESSION_FILE" >> "$GITHUB_OUTPUT"
            echo "Captured session ID: $SESSION_ID"
            echo "Session file: $SESSION_FILE"
          else
            echo "No session found for: $GITHUB_WORKSPACE"
          fi

      - name: Upload session to gist and update plan header
        if: always() && steps.session.outputs.session_id
        env:
          GH_TOKEN: ${{ secrets.ERK_QUEUE_GH_PAT }}
          PLAN_ID: ${{ inputs.plan_id }}
          SESSION_ID: ${{ steps.session.outputs.session_id }}
          SESSION_FILE: ${{ steps.session.outputs.session_file }}
        run: |
          erk exec upload-session \
            --session-file "$SESSION_FILE" \
            --session-id "$SESSION_ID" \
            --source remote \
            --plan-id "$PLAN_ID"

      - name: Update plan header with remote impl info
        if: always() && steps.session.outputs.session_id
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.ERK_QUEUE_GH_PAT }}
          PLAN_ID: ${{ inputs.plan_id }}
          RUN_ID: ${{ github.run_id }}
          SESSION_ID: ${{ steps.session.outputs.session_id }}
          BRANCH_NAME: ${{ inputs.branch_name }}
        run: |
          erk exec update-plan-remote-session \
            --plan-id "$PLAN_ID" \
            --run-id "$RUN_ID" \
            --session-id "$SESSION_ID" \
            --branch-name "$BRANCH_NAME"

      - name: Handle implementation outcome
        id: handle_outcome
        if: steps.implement.outputs.implementation_success == 'true'
        env:
          BASE_BRANCH: ${{ inputs.base_branch }}
          PLAN_ID: ${{ inputs.plan_id }}
          PLAN_TITLE: ${{ inputs.plan_title }}
          PR_NUMBER: ${{ inputs.pr_number }}
          PRE_IMPL_HEAD: ${{ steps.pre_impl.outputs.head }}
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check for uncommitted changes (staged or unstaged) excluding .worker-impl/ and .impl/
          UNCOMMITTED=$(git status --porcelain | grep -v '^\s*D.*\.worker-impl/' | grep -v '\.impl/' || true)

          # Check for new commits since pre-implementation
          CURRENT_HEAD=$(git rev-parse HEAD)
          NEW_COMMITS="false"
          if [ "$CURRENT_HEAD" != "$PRE_IMPL_HEAD" ]; then
            NEW_COMMITS="true"
            echo "New commits detected since pre-implementation HEAD"
          fi

          # Has changes if either condition is true
          if [ -z "$UNCOMMITTED" ] && [ "$NEW_COMMITS" = "false" ]; then
            echo "No code changes detected, handling gracefully..."

            # Gather diagnostic info
            git fetch origin "$BASE_BRANCH" --quiet
            BEHIND_COUNT=$(git rev-list HEAD.."origin/$BASE_BRANCH" --count 2>/dev/null || echo "0")
            RECENT_COMMITS=$(git log HEAD.."origin/$BASE_BRANCH" --oneline --max-count=5 2>/dev/null || echo "")

            # Call exec command to handle no-changes scenario
            erk exec handle-no-changes \
              --pr-number "$PR_NUMBER" \
              --plan-id "$PLAN_ID" \
              --behind-count "$BEHIND_COUNT" \
              --base-branch "$BASE_BRANCH" \
              --original-title "$PLAN_TITLE" \
              --recent-commits "$RECENT_COMMITS" \
              --run-url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Implementation produced changes:"
            if [ -n "$UNCOMMITTED" ]; then
              echo "Uncommitted changes:"
              echo "$UNCOMMITTED"
            fi
            if [ "$NEW_COMMITS" = "true" ]; then
              echo "New commits since $PRE_IMPL_HEAD:"
              git log --oneline "$PRE_IMPL_HEAD"..HEAD
            fi
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Submit branch with proper commit message
        id: submit
        continue-on-error: true
        if: steps.implement.outputs.implementation_success == 'true' && steps.handle_outcome.outputs.has_changes == 'true'
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          PLAN_ID: ${{ inputs.plan_id }}
          BRANCH_NAME: ${{ steps.find_pr.outputs.branch_name }}
          SUBMITTED_BY: ${{ inputs.submitted_by }}
        run: |
          git config user.name "$SUBMITTED_BY"
          git config user.email "$SUBMITTED_BY@users.noreply.github.com"
          claude --print \
            --model ${{ inputs.model_name }} \
            --output-format stream-json \
            --dangerously-skip-permissions \
            --verbose \
            "/erk:git-pr-push Implement plan #$PLAN_ID"
          echo "impl_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Handle merge conflicts if push failed
        id: handle_conflicts
        if: steps.submit.outcome == 'failure'
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ github.token }}
        run: |
          erk exec rebase-with-conflict-resolution \
            --target-branch "${{ inputs.base_branch }}" \
            --branch-name "${{ steps.find_pr.outputs.branch_name }}" \
            --model "${{ inputs.model_name }}"

      - name: Mark PR ready for review
        if: steps.implement.outputs.implementation_success == 'true' && steps.handle_outcome.outputs.has_changes == 'true' && (steps.submit.outcome == 'success' || steps.handle_conflicts.outcome == 'success')
        env:
          GH_TOKEN: ${{ github.token }}
          BRANCH_NAME: ${{ steps.find_pr.outputs.branch_name }}
        run: |
          gh pr ready "$BRANCH_NAME"
          echo "PR marked ready for review"

      - name: Clean up plan staging dirs after implementation
        if: steps.implement.outputs.implementation_success == 'true' && steps.handle_outcome.outputs.has_changes == 'true' && (steps.submit.outcome == 'success' || steps.handle_conflicts.outcome == 'success')
        env:
          BRANCH_NAME: ${{ steps.find_pr.outputs.branch_name }}
          SUBMITTED_BY: ${{ inputs.submitted_by }}
        run: |
          git fetch origin "$BRANCH_NAME"
          git reset --hard "origin/$BRANCH_NAME"
          NEEDS_CLEANUP=false
          git config user.name "$SUBMITTED_BY"
          git config user.email "$SUBMITTED_BY@users.noreply.github.com"
          if [ -d .worker-impl/ ]; then
            git rm -rf .worker-impl/
            NEEDS_CLEANUP=true
          fi
          if [ -d .erk/impl-context/ ]; then
            git rm -rf .erk/impl-context/
            NEEDS_CLEANUP=true
          fi
          if [ "$NEEDS_CLEANUP" = true ]; then
            git commit -m "Remove plan staging dirs after implementation"
            git push origin "$BRANCH_NAME"
            echo "Cleaned up plan staging dirs"
          fi

      - name: Update PR body with implementation summary
        continue-on-error: true
        if: steps.implement.outputs.implementation_success == 'true' && steps.handle_outcome.outputs.has_changes == 'true' && (steps.submit.outcome == 'success' || steps.handle_conflicts.outcome == 'success')
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ github.token }}
        run: |
          erk exec ci-update-pr-body \
            --plan-id "${{ inputs.plan_id }}" \
            --run-id "${{ github.run_id }}" \
            --run-url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Trigger CI workflows
        if: steps.implement.outputs.implementation_success == 'true' && steps.handle_outcome.outputs.has_changes == 'true' && (steps.submit.outcome == 'success' || steps.handle_conflicts.outcome == 'success')
        env:
          BRANCH_NAME: ${{ steps.find_pr.outputs.branch_name }}
          SUBMITTED_BY: ${{ inputs.submitted_by }}
        run: |
          git config user.name "$SUBMITTED_BY"
          git config user.email "$SUBMITTED_BY@users.noreply.github.com"
          git fetch origin "$BRANCH_NAME"
          git reset --hard "origin/$BRANCH_NAME"
          git commit --allow-empty -m "Trigger CI workflows"
          git push origin "$BRANCH_NAME"
          echo "CI workflows triggered via push event"

      - name: Fail workflow if implementation failed
        if: steps.implement.outputs.implementation_success != 'true'
        run: |
          echo "Implementation failed with exit code: ${{ steps.implement.outputs.exit_code }}"
          exit 1
