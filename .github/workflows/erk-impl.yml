name: Implementation Dispatch
run-name: "${{ inputs.issue_number }}:${{ inputs.distinct_id }}"

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: "GitHub issue number to implement"
        required: true
        type: string
      submitted_by:
        description: "GitHub username of the person who submitted the issue"
        required: true
        type: string
      distinct_id:
        description: "Unique identifier for run discovery (base36)"
        required: true
        type: string
      issue_title:
        description: "Issue title for workflow run display"
        required: true
        type: string
      branch_name:
        description: "Branch name for implementation (created by submit command)"
        required: true
        type: string
      pr_number:
        description: "PR number for implementation (created by submit command)"
        required: true
        type: string

concurrency:
  group: implement-issue-${{ github.event.inputs.issue_number }}
  cancel-in-progress: true

jobs:
  implement:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.ERK_QUEUE_GH_PAT }}
          fetch-depth: 0

      - name: Setup all tools
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          source $HOME/.cargo/env
          curl -fsSL https://claude.ai/install.sh | bash
          npm install -g prettier
          cd $GITHUB_WORKSPACE
          uv tool install --from . --with ./packages/erk-shared --with ./packages/dot-agent-kit erk
          erk kit install erk --force

      - name: Configure git
        env:
          SUBMITTED_BY: ${{ inputs.submitted_by }}
        run: |
          source $HOME/.cargo/env
          erk kit exec erk configure-git-user --username "$SUBMITTED_BY"

      - name: Detect trunk branch
        id: trunk
        run: |
          source $HOME/.cargo/env
          TRUNK=$(erk kit exec erk detect-trunk-branch | jq -r '.trunk_branch')
          echo "trunk_branch=$TRUNK" >> $GITHUB_OUTPUT

      - name: Set branch and PR from inputs
        id: find_pr
        run: |
          echo "branch_name=${{ inputs.branch_name }}" >> $GITHUB_OUTPUT
          echo "pr_number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
          echo "pr_exists=true" >> $GITHUB_OUTPUT
          echo "Using branch: ${{ inputs.branch_name }}"
          echo "Using PR: #${{ inputs.pr_number }}"

      - name: Checkout implementation branch
        env:
          BRANCH_NAME: ${{ steps.find_pr.outputs.branch_name }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          SUBMITTED_BY: ${{ inputs.submitted_by }}
          GH_TOKEN: ${{ github.token }}
        run: |
          source $HOME/.cargo/env
          git fetch origin "$BRANCH_NAME"
          git checkout "$BRANCH_NAME"
          erk kit exec erk clean-worker-impl
          erk kit exec erk create-worker-impl-from-issue "$ISSUE_NUMBER"
          if [ $? -ne 0 ]; then
            gh issue comment "$ISSUE_NUMBER" --body "Could not fetch plan content for issue #$ISSUE_NUMBER."
            exit 1
          fi
          erk kit exec erk configure-git-user --username "$SUBMITTED_BY"
          git add .worker-impl
          erk kit exec erk commit-and-push-if-dirty --branch "$BRANCH_NAME" --message "Update plan for issue #$ISSUE_NUMBER (rerun)"
          echo "Checked out branch: $BRANCH_NAME"

      - name: Post workflow started comment
        env:
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          BRANCH_NAME: ${{ steps.find_pr.outputs.branch_name }}
          PR_NUMBER: ${{ inputs.pr_number }}
          GH_TOKEN: ${{ github.token }}
        run: |
          source $HOME/.cargo/env
          erk kit exec erk post-workflow-started-comment \
            --issue-number "$ISSUE_NUMBER" \
            --branch-name "$BRANCH_NAME" \
            --pr-number "$PR_NUMBER" \
            --run-id "${{ github.run_id }}" \
            --run-url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --repository "${{ github.repository }}"

      - name: Add remote execution note to PR
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
          GH_TOKEN: ${{ github.token }}
          WORKFLOW_RUN_ID: ${{ github.run_id }}
          WORKFLOW_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          source $HOME/.cargo/env
          erk kit exec erk add-remote-execution-note \
            --pr-number "$PR_NUMBER" \
            --run-id "$WORKFLOW_RUN_ID" \
            --run-url "$WORKFLOW_RUN_URL"

      - name: Set up implementation folder
        run: |
          source $HOME/.cargo/env
          cp -r .worker-impl .impl
          echo "Copied .worker-impl/ to .impl/"
          erk kit exec erk create-impl-run-info \
            --run-id "${{ github.run_id }}" \
            --run-url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --output-dir .impl
          echo "Created .impl/run-info.json"

      - name: Run implementation
        id: implement
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ github.token }}
        run: |
          source $HOME/.cargo/env
          erk kit exec erk set-gha-exit-status --output-var implementation_success -- \
            claude --print \
              --model claude-sonnet-4-5-20250929 \
              --output-format stream-json \
              --dangerously-skip-permissions \
              --verbose \
              "/erk:plan-implement"
          erk kit exec erk clean-worker-impl
          echo "Removed .worker-impl/ before submission"

      - name: Submit branch with proper commit message
        id: submit
        if: steps.implement.outputs.implementation_success == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          BRANCH_NAME: ${{ steps.find_pr.outputs.branch_name }}
          SUBMITTED_BY: ${{ inputs.submitted_by }}
        run: |
          source $HOME/.cargo/env
          erk kit exec erk configure-git-user --username "$SUBMITTED_BY"
          claude --print \
            --model claude-sonnet-4-5-20250929 \
            --output-format stream-json \
            --dangerously-skip-permissions \
            --verbose \
            "/git:pr-push Implement issue #$ISSUE_NUMBER"
          echo "impl_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Mark PR ready for review
        if: steps.implement.outputs.implementation_success == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          BRANCH_NAME: ${{ steps.find_pr.outputs.branch_name }}
        run: |
          gh pr ready "$BRANCH_NAME"
          echo "PR marked ready for review"

      - name: Update PR body with implementation summary
        if: steps.implement.outputs.implementation_success == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          BRANCH_NAME: ${{ steps.find_pr.outputs.branch_name }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
        run: |
          source $HOME/.cargo/env
          erk kit exec erk update-pr-body --branch "$BRANCH_NAME" --issue-number "$ISSUE_NUMBER"
          echo "PR body updated with implementation summary"

      - name: Trigger CI workflows
        if: steps.implement.outputs.implementation_success == 'true'
        env:
          BRANCH_NAME: ${{ steps.find_pr.outputs.branch_name }}
          SUBMITTED_BY: ${{ inputs.submitted_by }}
        run: |
          source $HOME/.cargo/env
          erk kit exec erk configure-git-user --username "$SUBMITTED_BY"
          erk kit exec erk trigger-ci-push --branch "$BRANCH_NAME" --message "Trigger CI workflows"
          echo "CI workflows triggered via push event"
