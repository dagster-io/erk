name: ci

on:
  push:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: write # Needed for autofix to push

jobs:
  check-submission:
    if: github.event.pull_request.draft != true
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      skip: ${{ steps.check.outputs.skip }}
    steps:
      - uses: actions/checkout@v4
      - name: Check for submission folder
        id: check
        uses: ./.github/actions/check-worker-impl

  # === Style Checks (parallel) ===
  format:
    needs: check-submission
    if: github.event.pull_request.draft != true && needs.check-submission.outputs.skip == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-python-uv
      - name: Check Python formatting
        run: make format-check

  lint:
    needs: check-submission
    if: github.event.pull_request.draft != true && needs.check-submission.outputs.skip == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-python-uv
      - name: Run ruff linting
        run: make lint

  prettier:
    needs: check-submission
    if: github.event.pull_request.draft != true && needs.check-submission.outputs.skip == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-prettier
      - name: Check markdown formatting
        run: prettier --check '**/*.md' --ignore-path .gitignore

  docs-check:
    needs: check-submission
    if: github.event.pull_request.draft != true && needs.check-submission.outputs.skip == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-python-uv
      - uses: ./.github/actions/setup-prettier
      - name: Check AGENTS.md standard compliance
        run: make md-check
      - name: Validate agent documentation frontmatter
        run: make docs-validate
      - name: Check generated docs are in sync
        run: make docs-sync-check

  # === Type/Test Checks (parallel) ===
  ty:
    needs: check-submission
    if: github.event.pull_request.draft != true && needs.check-submission.outputs.skip == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-python-uv
      - name: Run ty
        run: make ty

  unit-tests:
    needs: check-submission
    if: github.event.pull_request.draft != true && needs.check-submission.outputs.skip == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13", "3.14"]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ matrix.python-version }}
      - uses: ./.github/actions/setup-graphite
      - name: Run unit tests
        run: make test

  integration-tests:
    needs: check-submission
    if: github.event.pull_request.draft != true && needs.check-submission.outputs.skip == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-python-uv
      - uses: ./.github/actions/setup-graphite
      - name: Run integration tests
        run: make test-integration

  # === Autofix (runs after ALL checks) ===
  autofix:
    needs: [format, lint, prettier, docs-check, ty, unit-tests, integration-tests]
    if: |
      always() &&
      github.ref_name != 'master' &&
      github.ref_name != 'main' &&
      (github.event_name == 'pull_request' || github.event_name == 'push') &&
      (github.event_name != 'pull_request' || github.event.pull_request.draft != true) &&
      (needs.format.result == 'failure' ||
       needs.lint.result == 'failure' ||
       needs.prettier.result == 'failure' ||
       needs.docs-check.result == 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Discover PR
        id: discover-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "has_pr=true" >> $GITHUB_OUTPUT
          else
            # Push event - check for open PR on this branch
            pr_number=$(gh api repos/${{ github.repository }}/pulls \
              --jq ".[] | select(.head.ref == \"${{ github.ref_name }}\" and .state == \"open\") | .number" \
              | head -1)
            if [ -n "$pr_number" ]; then
              echo "pr_number=$pr_number" >> $GITHUB_OUTPUT
              echo "has_pr=true" >> $GITHUB_OUTPUT
              echo "Found open PR #$pr_number for branch ${{ github.ref_name }}"
            else
              echo "has_pr=false" >> $GITHUB_OUTPUT
              echo "No open PR found for branch ${{ github.ref_name }}"
            fi
          fi

      - name: Skip if no PR
        if: steps.discover-pr.outputs.has_pr != 'true'
        run: |
          echo "No open PR for this branch, skipping autofix"
          exit 0

      - name: Get PR info
        id: pr
        if: steps.discover-pr.outputs.has_pr == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get PR details
          pr_data=$(gh api repos/${{ github.repository }}/pulls/${{ steps.discover-pr.outputs.pr_number }} --jq '{head_repo: .head.repo.full_name, base_repo: .base.repo.full_name}')

          # Security: Skip fork PRs to avoid executing untrusted code
          head_repo=$(echo "$pr_data" | jq -r '.head_repo')
          base_repo=$(echo "$pr_data" | jq -r '.base_repo')
          if [ "$head_repo" != "$base_repo" ]; then
            echo "PR is from a fork ($head_repo != $base_repo), skipping for security"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Skip if fork
        if: steps.pr.outputs.skip == 'true'
        run: |
          echo "Skipping autofix for fork PR"
          exit 0

      # Security: Fork PRs are blocked above before reaching this checkout.
      # Only same-repo PRs can trigger code execution in this privileged workflow.
      - uses: actions/checkout@v4
        if: steps.pr.outputs.skip != 'true' && steps.discover-pr.outputs.has_pr == 'true'
        with:
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref_name }}
          fetch-depth: 0

      - name: Check for submission folder
        if: steps.pr.outputs.skip != 'true' && steps.discover-pr.outputs.has_pr == 'true'
        id: check
        run: |
          if [ -d ".impl" ]; then
            echo "Found .impl folder, skipping autofix"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/setup-python@v5
        if: steps.check.outputs.skip != 'true' && steps.pr.outputs.skip != 'true' && steps.discover-pr.outputs.has_pr == 'true'
        with:
          python-version: "3.12"

      - name: Install uv
        if: steps.check.outputs.skip != 'true' && steps.pr.outputs.skip != 'true' && steps.discover-pr.outputs.has_pr == 'true'
        run: pip install uv

      # Inlined from .github/actions/setup-claude-erk to avoid CodeQL warning
      # about executing untrusted code from checkout in privileged workflow
      - name: Install erk
        if: steps.check.outputs.skip != 'true' && steps.pr.outputs.skip != 'true' && steps.discover-pr.outputs.has_pr == 'true'
        run: uv tool install --from . --with ./packages/erk-shared erk

      - uses: actions/setup-node@v4
        if: steps.check.outputs.skip != 'true' && steps.pr.outputs.skip != 'true' && steps.discover-pr.outputs.has_pr == 'true'
        with:
          node-version: "20"

      - name: Install prettier
        if: steps.check.outputs.skip != 'true' && steps.pr.outputs.skip != 'true' && steps.discover-pr.outputs.has_pr == 'true'
        run: npm install -g prettier@3.6.0

      - name: Setup Claude Code
        if: steps.check.outputs.skip != 'true' && steps.pr.outputs.skip != 'true' && steps.discover-pr.outputs.has_pr == 'true'
        uses: ./.github/actions/setup-claude-code

      - name: Collect failure context
        if: steps.check.outputs.skip != 'true' && steps.pr.outputs.skip != 'true' && steps.discover-pr.outputs.has_pr == 'true'
        id: failures
        run: |
          # Collect all job outcomes for Claude's context
          echo "format_result=${{ needs.format.result }}" >> $GITHUB_OUTPUT
          echo "lint_result=${{ needs.lint.result }}" >> $GITHUB_OUTPUT
          echo "prettier_result=${{ needs.prettier.result }}" >> $GITHUB_OUTPUT
          echo "docs_result=${{ needs.docs-check.result }}" >> $GITHUB_OUTPUT
          echo "ty_result=${{ needs.ty.result }}" >> $GITHUB_OUTPUT
          echo "unit_tests_result=${{ needs.unit-tests.result }}" >> $GITHUB_OUTPUT
          echo "integration_tests_result=${{ needs.integration-tests.result }}" >> $GITHUB_OUTPUT

      - name: Collect actual errors
        if: steps.check.outputs.skip != 'true' && steps.pr.outputs.skip != 'true' && steps.discover-pr.outputs.has_pr == 'true'
        id: errors
        run: |
          errors=""

          if [ "${{ needs.format.result }}" = "failure" ]; then
            errors+="=== RUFF FORMAT ERRORS ===\n"
            errors+="$(uv run ruff format --check . 2>&1 || true)\n\n"
          fi

          if [ "${{ needs.lint.result }}" = "failure" ]; then
            errors+="=== RUFF LINT ERRORS ===\n"
            errors+="$(uv run ruff check . 2>&1 || true)\n\n"
          fi

          if [ "${{ needs.prettier.result }}" = "failure" ]; then
            errors+="=== PRETTIER ERRORS ===\n"
            errors+="$(prettier --check '**/*.md' --ignore-path .gitignore 2>&1 || true)\n\n"
          fi

          if [ "${{ needs.docs-check.result }}" = "failure" ]; then
            errors+="=== DOCS CHECK ERRORS ===\n"
            errors+="$(make md-check 2>&1 || true)\n"
            errors+="$(make docs-validate 2>&1 || true)\n"
            errors+="$(make docs-sync-check 2>&1 || true)\n\n"
          fi

          # Save to file to avoid escaping issues
          echo -e "$errors" > /tmp/errors.txt

      - name: Run Claude autofix
        if: steps.check.outputs.skip != 'true' && steps.pr.outputs.skip != 'true' && steps.discover-pr.outputs.has_pr == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Get the embedded prompt and substitute placeholders
          prompt=$(erk exec get-embedded-prompt ci-autofix)
          prompt="${prompt//\$\{\{ needs.format.result \}\}/${{ needs.format.result }}}"
          prompt="${prompt//\$\{\{ needs.lint.result \}\}/${{ needs.lint.result }}}"
          prompt="${prompt//\$\{\{ needs.prettier.result \}\}/${{ needs.prettier.result }}}"
          prompt="${prompt//\$\{\{ needs.docs-check.result \}\}/${{ needs.docs-check.result }}}"
          prompt="${prompt//\$\{\{ needs.ty.result \}\}/${{ needs.ty.result }}}"
          prompt="${prompt//\$\{\{ needs.unit-tests.result \}\}/${{ needs.unit-tests.result }}}"
          prompt="${prompt//\$\{\{ needs.integration-tests.result \}\}/${{ needs.integration-tests.result }}}"

          # Read errors and substitute into prompt
          errors=$(cat /tmp/errors.txt)
          prompt="${prompt//\$ERRORS/$errors}"

          claude --print \
            --model claude-sonnet-4-20250514 \
            --output-format stream-json \
            --dangerously-skip-permissions \
            --verbose \
            --allowedTools 'Read(*),Bash(uv run ruff:*),Bash(prettier:*),Bash(make docs-sync:*),Bash(git:*)' \
            "$prompt"
