name: ci

on:
  push:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: write # Needed for autofix to push
  actions: write # Needed to re-trigger workflow after autofix push
  statuses: write # Needed for autofix to update commit status

concurrency:
  group: ci-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  check-submission:
    if: github.event.pull_request.draft != true && !contains(github.event.pull_request.labels.*.name, 'erk-plan-review')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      skip: ${{ steps.check.outputs.skip }}
    steps:
      - uses: actions/checkout@v4
      - name: Check for submission folder
        id: check
        uses: ./.github/actions/check-worker-impl

  # === Style Checks (parallel) ===
  format:
    needs: check-submission
    if: github.event.pull_request.draft != true && needs.check-submission.outputs.skip == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-python-uv
      - name: Check Python formatting
        run: make format-check

  lint:
    needs: check-submission
    if: github.event.pull_request.draft != true && needs.check-submission.outputs.skip == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-python-uv
      - name: Run ruff linting
        run: make lint

  prettier:
    needs: check-submission
    if: github.event.pull_request.draft != true && needs.check-submission.outputs.skip == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-prettier
      - name: Check markdown formatting
        run: prettier --check '**/*.md' --ignore-path .gitignore

  docs-check:
    needs: check-submission
    if: github.event.pull_request.draft != true && needs.check-submission.outputs.skip == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-python-uv
      - uses: ./.github/actions/setup-prettier
      - name: Check AGENTS.md standard compliance
        run: make md-check
      - name: Check agent documentation
        run: make docs-check

  # === Type/Test Checks (parallel) ===
  ty:
    needs: check-submission
    if: github.event.pull_request.draft != true && needs.check-submission.outputs.skip == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-python-uv
      - name: Run ty
        run: make ty

  unit-tests:
    needs: check-submission
    if: github.event.pull_request.draft != true && needs.check-submission.outputs.skip == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13", "3.14"]
      fail-fast: false
    env:
      UV_PYTHON: ${{ matrix.python-version }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ matrix.python-version }}
      - uses: ./.github/actions/setup-graphite
      - name: Run unit tests
        run: make test

  integration-tests:
    needs: check-submission
    if: github.event.pull_request.draft != true && needs.check-submission.outputs.skip == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-python-uv
      - uses: ./.github/actions/setup-graphite
      - name: Run integration tests
        run: make test-integration

  erkdesk-tests:
    needs: check-submission
    if: github.event.pull_request.draft != true && needs.check-submission.outputs.skip == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: erkdesk/pnpm-lock.yaml
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: erkdesk
      - name: Run erkdesk tests
        run: pnpm test
        working-directory: erkdesk

  # === Autofix (runs after ALL checks) ===
  autofix:
    needs:
      [format, lint, prettier, docs-check, ty, unit-tests, integration-tests]
    if: |
      always() &&
      github.ref_name != 'master' &&
      github.ref_name != 'main' &&
      (github.event_name == 'pull_request' || github.event_name == 'push') &&
      (github.event_name != 'pull_request' || github.event.pull_request.draft != true) &&
      (github.event_name != 'pull_request' || !contains(github.event.pull_request.labels.*.name, 'erk-plan-review')) &&
      (needs.format.result == 'failure' ||
       needs.lint.result == 'failure' ||
       needs.prettier.result == 'failure' ||
       needs.docs-check.result == 'failure' ||
       needs.ty.result == 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Discover PR
        id: discover-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "has_pr=true" >> $GITHUB_OUTPUT
          else
            # Push event - check for open PR on this branch
            pr_number=$(gh api repos/${{ github.repository }}/pulls \
              --jq ".[] | select(.head.ref == \"${{ github.ref_name }}\" and .state == \"open\") | .number" \
              | head -1)
            if [ -n "$pr_number" ]; then
              echo "pr_number=$pr_number" >> $GITHUB_OUTPUT
              echo "has_pr=true" >> $GITHUB_OUTPUT
              echo "Found open PR #$pr_number for branch ${{ github.ref_name }}"
            else
              echo "has_pr=false" >> $GITHUB_OUTPUT
              echo "No open PR found for branch ${{ github.ref_name }}"
            fi
          fi

      - name: Skip if no PR
        if: steps.discover-pr.outputs.has_pr != 'true'
        run: |
          echo "No open PR for this branch, skipping autofix"
          exit 0

      - name: Get PR info
        id: pr
        if: steps.discover-pr.outputs.has_pr == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get PR details
          pr_data=$(gh api repos/${{ github.repository }}/pulls/${{ steps.discover-pr.outputs.pr_number }} --jq '{head_repo: .head.repo.full_name, base_repo: .base.repo.full_name}')

          # Security: Skip fork PRs to avoid executing untrusted code
          head_repo=$(echo "$pr_data" | jq -r '.head_repo')
          base_repo=$(echo "$pr_data" | jq -r '.base_repo')
          if [ "$head_repo" != "$base_repo" ]; then
            echo "PR is from a fork ($head_repo != $base_repo), skipping for security"
            echo "is_fork=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "is_fork=false" >> $GITHUB_OUTPUT

      - name: Check erk-plan-review label
        id: check-label
        if: steps.discover-pr.outputs.has_pr == 'true' && steps.pr.outputs.is_fork != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          labels=$(gh api repos/${{ github.repository }}/pulls/${{ steps.discover-pr.outputs.pr_number }} --jq '[.labels[].name] | join(",")')
          if echo "$labels" | grep -q "erk-plan-review"; then
            echo "PR has erk-plan-review label, skipping autofix"
            echo "has_plan_review_label=true" >> $GITHUB_OUTPUT
          else
            echo "has_plan_review_label=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip if fork
        if: steps.pr.outputs.is_fork == 'true'
        run: |
          echo "Skipping autofix for fork PR"
          exit 0

      # Security: Fork PRs are blocked above before reaching this checkout.
      # Only same-repo PRs can trigger code execution in this privileged workflow.
      - uses: actions/checkout@v4
        if: steps.discover-pr.outputs.has_pr == 'true' && steps.pr.outputs.is_fork != 'true' && steps.check-label.outputs.has_plan_review_label != 'true'
        with:
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref_name }}
          fetch-depth: 0

      - name: Check for submission folder
        if: steps.discover-pr.outputs.has_pr == 'true' && steps.pr.outputs.is_fork != 'true' && steps.check-label.outputs.has_plan_review_label != 'true'
        id: check
        run: |
          if [ -d ".impl" ]; then
            echo "Found .impl folder, skipping autofix"
            echo "has_impl_folder=true" >> $GITHUB_OUTPUT
          else
            echo "has_impl_folder=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine if autofix should run
        id: should-autofix
        run: |
          if [[ "${{ steps.discover-pr.outputs.has_pr }}" == "true" && \
                "${{ steps.pr.outputs.is_fork }}" != "true" && \
                "${{ steps.check-label.outputs.has_plan_review_label }}" != "true" && \
                "${{ steps.check.outputs.has_impl_folder }}" != "true" ]]; then
            echo "run=true" >> "$GITHUB_OUTPUT"
          else
            echo "run=false" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/setup-python@v5
        if: steps.should-autofix.outputs.run == 'true'
        with:
          python-version: "3.12"

      - name: Install uv
        if: steps.should-autofix.outputs.run == 'true'
        run: pip install uv

      # Inlined from .github/actions/setup-claude-erk to avoid CodeQL warning
      # about executing untrusted code from checkout in privileged workflow
      - name: Install erk
        if: steps.should-autofix.outputs.run == 'true'
        run: |
          if [ -d "./packages/erk-shared" ]; then
            uv tool install --from . --with-editable ./packages/erk-shared erk
          else
            uv tool install --from . --with erk-shared erk
          fi

      - uses: actions/setup-node@v4
        if: steps.should-autofix.outputs.run == 'true'
        with:
          node-version: "20"

      - name: Install prettier
        if: steps.should-autofix.outputs.run == 'true'
        run: npm install -g prettier@3.6.0

      - uses: ./.github/actions/setup-graphite
        if: steps.should-autofix.outputs.run == 'true'

      - name: Setup Claude Code
        if: steps.should-autofix.outputs.run == 'true'
        uses: ./.github/actions/setup-claude-code

      - name: Collect failure context
        if: steps.should-autofix.outputs.run == 'true'
        id: failures
        run: |
          # Collect all job outcomes for Claude's context
          echo "format_result=${{ needs.format.result }}" >> $GITHUB_OUTPUT
          echo "lint_result=${{ needs.lint.result }}" >> $GITHUB_OUTPUT
          echo "prettier_result=${{ needs.prettier.result }}" >> $GITHUB_OUTPUT
          echo "docs_result=${{ needs.docs-check.result }}" >> $GITHUB_OUTPUT
          echo "ty_result=${{ needs.ty.result }}" >> $GITHUB_OUTPUT
          echo "unit_tests_result=${{ needs.unit-tests.result }}" >> $GITHUB_OUTPUT
          echo "integration_tests_result=${{ needs.integration-tests.result }}" >> $GITHUB_OUTPUT

      - name: Collect actual errors
        if: steps.should-autofix.outputs.run == 'true'
        id: errors
        run: |
          errors=""

          if [ "${{ needs.format.result }}" = "failure" ]; then
            errors+="=== RUFF FORMAT ERRORS ===\n"
            errors+="$(uv run ruff format --check . 2>&1 || true)\n\n"
          fi

          if [ "${{ needs.lint.result }}" = "failure" ]; then
            errors+="=== RUFF LINT ERRORS ===\n"
            errors+="$(uv run ruff check . 2>&1 || true)\n\n"
          fi

          if [ "${{ needs.prettier.result }}" = "failure" ]; then
            errors+="=== PRETTIER ERRORS ===\n"
            errors+="$(prettier --check '**/*.md' --ignore-path .gitignore 2>&1 || true)\n\n"
          fi

          if [ "${{ needs.docs-check.result }}" = "failure" ]; then
            errors+="=== DOCS CHECK ERRORS ===\n"
            errors+="$(make md-check 2>&1 || true)\n"
            errors+="$(make docs-check 2>&1 || true)\n\n"
          fi

          if [ "${{ needs.ty.result }}" = "failure" ]; then
            errors+="=== TY TYPE ERRORS ===\n"
            errors+="$(uv run ty check 2>&1 || true)\n\n"
          fi

          # Save to file to avoid escaping issues
          echo -e "$errors" > /tmp/errors.txt

      - name: Run Claude autofix
        if: steps.should-autofix.outputs.run == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Get embedded prompt with variable substitution
          echo "Debug: Getting ci-autofix prompt..."
          echo "Debug: erk location: $(which erk || echo 'not found')"
          echo "Debug: erk version: $(erk --version 2>&1 || echo 'version failed')"

          if ! prompt=$(erk exec get-embedded-prompt ci-autofix \
            --var "format=${{ needs.format.result }}" \
            --var "lint=${{ needs.lint.result }}" \
            --var "prettier=${{ needs.prettier.result }}" \
            --var "docs-check=${{ needs.docs-check.result }}" \
            --var "ty=${{ needs.ty.result }}" \
            --var "unit-tests=${{ needs.unit-tests.result }}" \
            --var "integration-tests=${{ needs.integration-tests.result }}" \
            --var-file "ERRORS=/tmp/errors.txt" 2>&1); then
            echo "Error: Failed to get ci-autofix prompt"
            echo "Command output: $prompt"
            exit 1
          fi

          # Verify prompt is not empty
          if [ -z "$prompt" ]; then
            echo "Error: ci-autofix prompt is empty (command succeeded but no output)"
            exit 1
          fi

          echo "Debug: Got prompt (${#prompt} chars)"

          echo "$prompt" | claude --print \
            --model claude-sonnet-4-20250514 \
            --output-format stream-json \
            --dangerously-skip-permissions \
            --verbose \
            --allowedTools 'Read(*),Edit(*),Bash(uv run ruff:*),Bash(uv run ty:*),Bash(prettier --write **/*.md:*),Bash(make docs-sync:*),Bash(git:*)'

      - name: Run full CI verification
        if: steps.should-autofix.outputs.run == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          erk exec ci-verify-autofix \
            --original-sha "${{ github.sha }}" \
            --repo "${{ github.repository }}"
