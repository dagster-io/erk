# Learn Extract Dispatch Workflow
#
# This workflow is triggered by `erk land --learn` to run the /erk:learn
# command remotely with session data from a gist.
#
# It downloads preprocessed sessions from a gist and runs /erk:learn,
# which creates a documentation plan issue.

name: learn-extract-dispatch
run-name: "Learn Extract: #${{ inputs.plan_issue_number }} â†’ PR #${{ inputs.pr_number }}"

on:
  workflow_dispatch:
    inputs:
      plan_issue_number:
        description: "Original plan issue number"
        required: true
        type: string
      pr_number:
        description: "Merged PR number"
        required: true
        type: string
      gist_url:
        description: "URL of preprocessed sessions gist"
        required: false
        type: string
      auto_implement:
        description: "Auto-implement resulting docs plan"
        required: false
        type: boolean
        default: false
      model_name:
        description: "Claude model to use"
        required: false
        type: string
        default: "claude-sonnet-4-5"

concurrency:
  group: learn-extract-${{ inputs.plan_issue_number }}
  cancel-in-progress: true

jobs:
  learn-extract:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.ERK_QUEUE_GH_PAT }}
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install erk
        run: uv tool install --from . --with ./packages/erk-shared erk

      - name: Configure git
        run: |
          git config user.name "erk-bot"
          git config user.email "erk-bot@users.noreply.github.com"

      - name: Detect trunk branch
        id: trunk
        run: |
          result=$(erk exec detect-trunk-branch)
          echo "branch=$(echo "$result" | jq -r '.trunk_branch')" >> $GITHUB_OUTPUT

      - name: Create learn branch
        id: branch
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="learn-extract-${{ inputs.plan_issue_number }}-${TIMESTAMP}"
          git checkout -b "$BRANCH_NAME" "${{ steps.trunk.outputs.branch }}"
          git push -u origin "$BRANCH_NAME"
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Create draft PR for tracking
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_URL=$(gh pr create \
            --base "${{ steps.trunk.outputs.branch }}" \
            --head "${{ steps.branch.outputs.name }}" \
            --title "Learn: Extract insights from plan #${{ inputs.plan_issue_number }}" \
            --body "Extracting insights from PR #${{ inputs.pr_number }} (plan #${{ inputs.plan_issue_number }})" \
            --draft)
          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "url=$PR_URL" >> $GITHUB_OUTPUT

      - name: Install Claude Code
        env:
          NPM_CONFIG_STRICT_SSL: "true"
        run: npm install -g @anthropic-ai/claude-code

      - name: Run learn command
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.ERK_QUEUE_GH_PAT }}
          CLAUDE_MODEL: ${{ inputs.model_name }}
        run: |
          # Build the learn command with optional gist-url
          LEARN_CMD="/erk:learn ${{ inputs.plan_issue_number }}"

          if [ -n "${{ inputs.gist_url }}" ]; then
            LEARN_CMD="$LEARN_CMD --gist-url ${{ inputs.gist_url }}"
          fi

          # Run Claude with the learn command
          claude --print "$LEARN_CMD" --model "${{ inputs.model_name }}"

      - name: Check for created docs plan
        id: docs_plan
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Look for recently created erk-learn issues
          DOCS_ISSUE=$(gh issue list \
            --label "erk-learn" \
            --state open \
            --json number,title,createdAt \
            --jq 'sort_by(.createdAt) | reverse | .[0].number // empty')

          if [ -n "$DOCS_ISSUE" ]; then
            echo "issue_number=$DOCS_ISSUE" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Auto-implement docs plan
        if: inputs.auto_implement == true && steps.docs_plan.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.ERK_QUEUE_GH_PAT }}
        run: |
          # Dispatch to erk-impl for the docs plan
          gh workflow run erk-impl.yml \
            -f issue_number="${{ steps.docs_plan.outputs.issue_number }}" \
            -f submitted_by="learn-extract-dispatch" \
            -f model_name="${{ inputs.model_name }}"

      - name: Post completion comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          COMMENT_BODY="## ðŸ“š Learn Extract Complete

          **Source:** PR #${{ inputs.pr_number }} (plan #${{ inputs.plan_issue_number }})"

          if [ "${{ steps.docs_plan.outputs.found }}" = "true" ]; then
            COMMENT_BODY="$COMMENT_BODY

          **Documentation Plan:** #${{ steps.docs_plan.outputs.issue_number }}"

            if [ "${{ inputs.auto_implement }}" = "true" ]; then
              COMMENT_BODY="$COMMENT_BODY
          **Status:** Auto-implementation dispatched"
            fi
          else
            COMMENT_BODY="$COMMENT_BODY

          **Result:** No documentation plan created (no actionable insights found)"
          fi

          gh pr comment "${{ steps.pr.outputs.number }}" --body "$COMMENT_BODY"

      - name: Close tracking PR if no docs plan
        if: steps.docs_plan.outputs.found != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr close "${{ steps.pr.outputs.number }}" --delete-branch
