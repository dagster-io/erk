name: Auto-Restack PR

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to restack"
        required: true
        type: string
      branch:
        description: "Branch name"
        required: true
        type: string

concurrency:
  group: auto-restack-${{ github.event.inputs.pr_number }}
  cancel-in-progress: true

jobs:
  restack:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0
          token: ${{ secrets.ERK_QUEUE_GH_PAT }}

      - name: Setup tools
        run: |
          # Install uv
          curl -LsSf https://astral.sh/uv/install.sh | sh
          source $HOME/.cargo/env

          # Install Claude Code
          curl -fsSL https://claude.ai/install.sh | bash

          # Install erk
          cd $GITHUB_WORKSPACE
          uv tool install --from . --with ./packages/erk-shared erk

          # Graphite auth will be configured via environment variable

      - name: Configure git
        run: |
          git config user.name "erk-bot"
          git config user.email "erk-bot@users.noreply.github.com"

      - name: Run auto-restack
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.ERK_QUEUE_GH_PAT }}
          GRAPHITE_TOKEN: ${{ secrets.GRAPHITE_TOKEN }}
        run: |
          source $HOME/.cargo/env
          erk pr auto-restack --dangerous

      - name: Push changes and cleanup
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin HEAD
          gh pr edit ${{ github.event.inputs.pr_number }} --remove-label "has-conflicts"
          echo "Auto-restack successful for PR #${{ github.event.inputs.pr_number }}"

      - name: Label on failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Add restack-failed label (create if needed)
          gh pr edit ${{ github.event.inputs.pr_number }} --add-label "restack-failed" 2>/dev/null || \
            gh label create "restack-failed" --color "b60205" --description "Auto-restack failed, manual resolution needed" 2>/dev/null && \
            gh pr edit ${{ github.event.inputs.pr_number }} --add-label "restack-failed"

          # Remove has-conflicts label
          gh pr edit ${{ github.event.inputs.pr_number }} --remove-label "has-conflicts" 2>/dev/null || true

          # Add comment explaining the failure
          gh pr comment ${{ github.event.inputs.pr_number }} --body "Auto-restack failed. Manual conflict resolution needed.

          **Workflow run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
