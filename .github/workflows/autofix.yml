name: autofix

on:
  workflow_run:
    workflows: ["python-format", "lint", "docs-check", "markdown-format"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  autofix:
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Get PR info from triggering workflow
        if: github.event_name == 'workflow_run'
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get PR associated with the workflow run
          pr_number=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }} \
            --jq '.pull_requests[0].number')

          if [ -z "$pr_number" ] || [ "$pr_number" = "null" ]; then
            echo "No PR associated with this workflow run"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get PR details
          pr_data=$(gh api repos/${{ github.repository }}/pulls/$pr_number --jq '{draft: .draft, head_ref: .head.ref, head_repo: .head.repo.full_name, base_repo: .base.repo.full_name}')

          is_draft=$(echo "$pr_data" | jq -r '.draft')
          if [ "$is_draft" = "true" ]; then
            echo "PR is a draft, skipping"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Security: Skip fork PRs to avoid executing untrusted code
          head_repo=$(echo "$pr_data" | jq -r '.head_repo')
          base_repo=$(echo "$pr_data" | jq -r '.base_repo')
          if [ "$head_repo" != "$base_repo" ]; then
            echo "PR is from a fork ($head_repo != $base_repo), skipping for security"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          head_ref=$(echo "$pr_data" | jq -r '.head_ref')
          echo "pr_number=$pr_number" >> $GITHUB_OUTPUT
          echo "head_ref=$head_ref" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Check if should skip
        if: github.event_name == 'workflow_run' && steps.pr.outputs.skip == 'true'
        run: |
          echo "Skipping autofix"
          exit 0

      # Security: Fork PRs are blocked above (lines 45-52) before reaching this checkout.
      # Only same-repo PRs can trigger code execution in this privileged workflow.
      # CodeQL query: actions/untrusted-checkout/critical - mitigated by fork check
      - uses: actions/checkout@v4
        if: github.event_name == 'workflow_dispatch' || steps.pr.outputs.skip != 'true'
        with:
          ref: ${{ github.event_name == 'workflow_run' && steps.pr.outputs.head_ref || github.head_ref }}
          fetch-depth: 0

      - name: Check for submission folder
        if: github.event_name == 'workflow_dispatch' || steps.pr.outputs.skip != 'true'
        id: check
        run: |
          if [ -d ".impl" ]; then
            echo "Found .impl folder, skipping autofix"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      # Inlined from .github/actions/setup-claude-erk to avoid CodeQL warning
      # about executing untrusted code from checkout in privileged workflow
      - name: Install erk
        if: steps.check.outputs.skip != 'true' && (github.event_name == 'workflow_dispatch' || steps.pr.outputs.skip != 'true')
        run: uv tool install --from . --with ./packages/erk-shared erk

      - uses: actions/setup-node@v4
        if: steps.check.outputs.skip != 'true' && (github.event_name == 'workflow_dispatch' || steps.pr.outputs.skip != 'true')
        with:
          node-version: "20"

      - name: Install prettier
        if: steps.check.outputs.skip != 'true' && (github.event_name == 'workflow_dispatch' || steps.pr.outputs.skip != 'true')
        run: npm install -g prettier@3.6.0

      - name: Fetch failure logs
        if: github.event_name == 'workflow_run' && steps.check.outputs.skip != 'true' && steps.pr.outputs.skip != 'true'
        id: logs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "workflow_name=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT

          # Get failed job logs
          logs=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/jobs \
            --jq '.jobs[] | select(.conclusion == "failure") | "Job: \(.name)\nConclusion: \(.conclusion)\nSteps:\n" + ([.steps[] | select(.conclusion == "failure") | "  - \(.name): \(.conclusion)"] | join("\n"))')

          # Also try to get the actual log output
          gh run view ${{ github.event.workflow_run.id }} --repo ${{ github.repository }} --log-failed > /tmp/failed_logs.txt 2>/dev/null || true

          if [ -s /tmp/failed_logs.txt ]; then
            logs="$logs

=== Failed Step Output ===
$(head -c 15000 /tmp/failed_logs.txt)"
          fi

          echo "logs<<EOF" >> $GITHUB_OUTPUT
          echo "$logs" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Claude autofix
        if: steps.check.outputs.skip != 'true' && (github.event_name == 'workflow_dispatch' || steps.pr.outputs.skip != 'true')
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            cat > /tmp/prompt.md << 'PROMPT_EOF'
          # Autofix CI Errors

          The "${{ steps.logs.outputs.workflow_name }}" workflow failed. Fix the errors and commit.

          ## Failure Output
          ${{ steps.logs.outputs.logs }}

          ## Rules
          - For ruff format errors: run `uv run ruff format <file>` on each file
          - For ruff lint errors: run `uv run ruff check --fix <file>` for auto-fixable errors
          - For prettier errors: run `prettier --write <file>` for each markdown file
          - Commit with message: "style: auto-fix CI errors"
          - Push the commit
          PROMPT_EOF
          else
            # Manual dispatch - collect errors directly
            errors=""
            if ! uv run ruff format --check . 2>&1; then
              errors+="=== RUFF FORMAT ERRORS ===\n"
              errors+="$(uv run ruff format --check . 2>&1 || true)\n\n"
            fi
            if ! uv run ruff check . 2>&1; then
              errors+="=== RUFF LINT ERRORS ===\n"
              errors+="$(uv run ruff check . 2>&1 || true)\n\n"
            fi
            if ! prettier --check '**/*.md' --ignore-path .gitignore 2>&1; then
              errors+="=== PRETTIER ERRORS ===\n"
              errors+="$(prettier --check '**/*.md' --ignore-path .gitignore 2>&1 || true)\n\n"
            fi

            if [ -z "$errors" ]; then
              echo "No errors found"
              exit 0
            fi

            cat > /tmp/prompt.md << PROMPT_EOF
          # Autofix CI Errors

          Fix the following errors on this PR. Read each file, apply the fix, then commit.

          ## Errors
          $(echo -e "$errors")

          ## Rules
          - For ruff format: run \`uv run ruff format <file>\` on each file
          - For ruff lint: run \`uv run ruff check --fix <file>\` for auto-fixable errors
          - For prettier: run \`prettier --write <file>\` for each markdown file
          - Commit with message: "style: auto-fix CI errors"
          - Push the commit
          PROMPT_EOF
          fi

          claude --print \
            --model claude-sonnet-4-20250514 \
            --allowedTools 'Read(*),Bash(uv run ruff:*),Bash(prettier:*),Bash(git:*)' \
            "$(cat /tmp/prompt.md)"
