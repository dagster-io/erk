# Learn Dispatch Workflow
#
# Runs /erk:learn on a completed plan issue to extract insights and patterns
# from the implementation session. This workflow is triggered asynchronously
# after a PR lands via `erk exec trigger-async-learn`.
#
# Output: Creates a new learn plan issue containing extracted lessons learned,
# architectural decisions, and reusable patterns from the implementation.

name: learn-dispatch
run-name: "${{ inputs.issue_number }}:${{ inputs.distinct_id }}"

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: "GitHub issue number to learn from"
        required: true
        type: string
      distinct_id:
        description: "Unique identifier for run discovery (base36)"
        required: true
        type: string

concurrency:
  group: learn-issue-${{ github.event.inputs.issue_number }}
  cancel-in-progress: true

jobs:
  learn:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.ERK_QUEUE_GH_PAT }}
          fetch-depth: 0

      - uses: ./.github/actions/erk-remote-setup
        with:
          erk-pat: ${{ secrets.ERK_QUEUE_GH_PAT }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude-code-oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Run learn workflow
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.ERK_QUEUE_GH_PAT }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          WORKFLOW_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          claude --print \
            --verbose \
            --model claude-haiku-4-5 \
            --output-format stream-json \
            --dangerously-skip-permissions \
            "/erk:learn $ISSUE_NUMBER"
