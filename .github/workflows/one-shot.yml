name: one-shot
run-name: "one-shot:${{ inputs.distinct_id }}"

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "Task description for autonomous execution"
        required: true
        type: string
      branch_name:
        description: "Branch to work on (created by CLI command)"
        required: true
        type: string
      pr_number:
        description: "Draft PR number (created by CLI command)"
        required: true
        type: string
      submitted_by:
        description: "GitHub username of the person who submitted"
        required: true
        type: string
      distinct_id:
        description: "Unique identifier for run discovery (base36)"
        required: true
        type: string
      model_name:
        description: "Claude model to use for execution"
        required: false
        type: string
        default: "claude-opus-4-6"
      objective_issue:
        description: "Objective issue number (when dispatched from implement --one-shot)"
        required: false
        type: string
        default: ""
      node_id:
        description: "Roadmap node ID (when dispatched from implement --one-shot)"
        required: false
        type: string
        default: ""
      plan_issue_number:
        description: "Plan entity number: issue number (github backend) or PR number (draft_pr backend)"
        required: false
        type: string
        default: ""
      plan_backend:
        description: "Plan backend type (github or draft_pr)"
        required: false
        type: string
        default: "github"

concurrency:
  group: one-shot-${{ inputs.branch_name }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  plan:
    if: vars.CLAUDE_ENABLED != 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      plan_id: ${{ steps.read_result.outputs.plan_id }}
      plan_title: ${{ steps.read_result.outputs.plan_title }}
      base_branch: ${{ steps.trunk.outputs.trunk_branch }}
    steps:
      - name: Validate required secrets
        env:
          ERK_PAT: ${{ secrets.ERK_QUEUE_GH_PAT }}
        run: |
          if [ -z "$ERK_PAT" ]; then
            echo "::error title=Missing Secret::ERK_QUEUE_GH_PAT secret is not configured or has expired. Add a PAT with 'repo' scope at: Settings > Secrets and variables > Actions"
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.ERK_QUEUE_GH_PAT }}
          fetch-depth: 0

      - uses: ./.github/actions/erk-remote-setup
        with:
          erk-pat: ${{ secrets.ERK_QUEUE_GH_PAT }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude-code-oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Checkout implementation branch
        env:
          BRANCH_NAME: ${{ inputs.branch_name }}
          SUBMITTED_BY: ${{ inputs.submitted_by }}
        run: |
          git fetch origin "$BRANCH_NAME"
          git checkout "$BRANCH_NAME"
          git config user.name "$SUBMITTED_BY"
          git config user.email "$SUBMITTED_BY@users.noreply.github.com"

      - name: Write prompt to .impl/prompt.md
        env:
          PROMPT: ${{ inputs.prompt }}
        run: |
          if [ -f .worker-impl/prompt.md ]; then
            echo "Prompt already committed to .worker-impl/prompt.md"
            mkdir -p .impl
            cp .worker-impl/prompt.md .impl/prompt.md
          else
            mkdir -p .impl
            printf '%s\n' "$PROMPT" > .impl/prompt.md
            echo "Prompt written to .impl/prompt.md from workflow input"
          fi

      - name: Detect trunk branch
        id: trunk
        run: |
          result=$(erk exec detect-trunk-branch)
          echo "trunk_branch=$(echo "$result" | jq -r '.trunk_branch')" >> $GITHUB_OUTPUT

      - name: Update lifecycle stage to planning
        if: inputs.plan_issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.ERK_QUEUE_GH_PAT }}
          PLAN_ISSUE_NUMBER: ${{ inputs.plan_issue_number }}
        run: |
          erk exec update-plan-header "$PLAN_ISSUE_NUMBER" lifecycle_stage=planning

      - name: Run one-shot planning
        id: plan
        run: |
          set +e
          claude --print \
            --model ${{ inputs.model_name }} \
            --output-format stream-json \
            --dangerously-skip-permissions \
            --verbose \
            "/erk:one-shot-plan $PLAN_ISSUE_NUMBER"
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          if [ $EXIT_CODE -eq 0 ]; then
            echo "plan_success=true" >> $GITHUB_OUTPUT
          else
            echo "plan_success=false" >> $GITHUB_OUTPUT
          fi
          exit 0
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.ERK_QUEUE_GH_PAT }}
          WORKFLOW_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          OBJECTIVE_ISSUE: ${{ inputs.objective_issue }}
          NODE_ID: ${{ inputs.node_id }}
          PLAN_ISSUE_NUMBER: ${{ inputs.plan_issue_number }}

      - name: Verify plan outputs exist
        if: steps.plan.outputs.plan_success == 'true'
        run: |
          if [ ! -f .impl/plan.md ]; then
            echo "::error::Planning succeeded but .impl/plan.md not found"
            exit 1
          fi
          if [ ! -f .impl/plan-result.json ]; then
            echo "::error::Planning succeeded but .impl/plan-result.json not found"
            exit 1
          fi
          echo "Plan outputs found: .impl/plan.md and .impl/plan-result.json"

      - name: Read plan result
        id: read_result
        if: steps.plan.outputs.plan_success == 'true'
        run: |
          PLAN_ID=$(jq -r '.issue_number' .impl/plan-result.json)
          PLAN_TITLE=$(jq -r '.title' .impl/plan-result.json)
          echo "plan_id=$PLAN_ID" >> $GITHUB_OUTPUT
          echo "plan_title=$PLAN_TITLE" >> $GITHUB_OUTPUT
          echo "Plan saved as #$PLAN_ID: $PLAN_TITLE"

      - name: Validate plan format
        if: steps.plan.outputs.plan_success == 'true' && steps.read_result.outputs.plan_id != ''
        env:
          GH_TOKEN: ${{ secrets.ERK_QUEUE_GH_PAT }}
        run: |
          erk plan check ${{ steps.read_result.outputs.plan_id }}

      - name: Register one-shot plan with issue and PR
        if: steps.plan.outputs.plan_success == 'true' && steps.read_result.outputs.plan_id != ''
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.ERK_QUEUE_GH_PAT }}
        run: |
          erk exec register-one-shot-plan \
            --issue-number "${{ steps.read_result.outputs.plan_id }}" \
            --run-id "${{ github.run_id }}" \
            --pr-number "${{ inputs.pr_number }}" \
            --submitted-by "${{ inputs.submitted_by }}" \
            --run-url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Update objective roadmap node
        if: >
          steps.plan.outputs.plan_success == 'true'
          && steps.read_result.outputs.plan_id != ''
          && inputs.objective_issue != ''
          && inputs.node_id != ''
        env:
          GH_TOKEN: ${{ secrets.ERK_QUEUE_GH_PAT }}
          OBJECTIVE_ISSUE: ${{ inputs.objective_issue }}
          NODE_ID: ${{ inputs.node_id }}
          PLAN_NUMBER: ${{ steps.read_result.outputs.plan_id }}
        run: |
          erk exec update-objective-node \
            "$OBJECTIVE_ISSUE" \
            --node "$NODE_ID" \
            --plan "$PLAN_NUMBER"

      - name: Fail workflow if planning failed
        if: steps.plan.outputs.plan_success != 'true'
        run: |
          echo "One-shot planning failed with exit code: ${{ steps.plan.outputs.exit_code }}"
          exit 1

  implement:
    needs: plan
    if: needs.plan.outputs.plan_id != ''
    uses: ./.github/workflows/plan-implement.yml
    with:
      plan_id: ${{ needs.plan.outputs.plan_id }}
      plan_title: ${{ needs.plan.outputs.plan_title }}
      submitted_by: ${{ inputs.submitted_by }}
      distinct_id: ${{ inputs.distinct_id }}
      branch_name: ${{ inputs.branch_name }}
      pr_number: ${{ inputs.pr_number }}
      model_name: ${{ inputs.model_name }}
      base_branch: ${{ needs.plan.outputs.base_branch }}
      plan_backend: ${{ inputs.plan_backend }}
    secrets: inherit
