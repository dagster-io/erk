name: one-shot
run-name: "one-shot:${{ inputs.distinct_id }}"

on:
  workflow_dispatch:
    inputs:
      instruction:
        description: "Task description for autonomous execution"
        required: true
        type: string
      branch_name:
        description: "Branch to work on (created by CLI command)"
        required: true
        type: string
      pr_number:
        description: "Draft PR number (created by CLI command)"
        required: true
        type: string
      submitted_by:
        description: "GitHub username of the person who submitted"
        required: true
        type: string
      distinct_id:
        description: "Unique identifier for run discovery (base36)"
        required: true
        type: string
      model_name:
        description: "Claude model to use for execution"
        required: false
        type: string
        default: "claude-sonnet-4-5"

concurrency:
  group: one-shot-${{ github.event.inputs.branch_name }}
  cancel-in-progress: true

jobs:
  execute:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Validate required secrets
        env:
          ERK_PAT: ${{ secrets.ERK_QUEUE_GH_PAT }}
        run: |
          if [ -z "$ERK_PAT" ]; then
            echo "::error title=Missing Secret::ERK_QUEUE_GH_PAT secret is not configured or has expired. Add a PAT with 'repo' scope at: Settings > Secrets and variables > Actions"
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.ERK_QUEUE_GH_PAT }}
          fetch-depth: 0

      - uses: ./.github/actions/erk-remote-setup
        with:
          erk-pat: ${{ secrets.ERK_QUEUE_GH_PAT }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude-code-oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Checkout implementation branch
        env:
          BRANCH_NAME: ${{ inputs.branch_name }}
          SUBMITTED_BY: ${{ inputs.submitted_by }}
        run: |
          git fetch origin "$BRANCH_NAME"
          git checkout "$BRANCH_NAME"
          git config user.name "$SUBMITTED_BY"
          git config user.email "$SUBMITTED_BY@users.noreply.github.com"

      - name: Write instruction to .impl/task.md
        env:
          INSTRUCTION: ${{ inputs.instruction }}
        run: |
          mkdir -p .impl
          printf '%s\n' "$INSTRUCTION" > .impl/task.md
          echo "Instruction written to .impl/task.md"

      - name: Save pre-implementation HEAD
        id: pre_impl
        run: echo "head=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Run one-shot execution
        id: execute
        run: |
          set +e
          claude --print \
            --model ${{ inputs.model_name }} \
            --output-format stream-json \
            --dangerously-skip-permissions \
            --verbose \
            "/erk:one-shot-execute"
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          if [ $EXIT_CODE -eq 0 ]; then
            echo "execution_success=true" >> $GITHUB_OUTPUT
          else
            echo "execution_success=false" >> $GITHUB_OUTPUT
          fi
          exit 0
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ github.token }}

      - name: Check for changes
        id: check_changes
        if: steps.execute.outputs.execution_success == 'true'
        env:
          PRE_IMPL_HEAD: ${{ steps.pre_impl.outputs.head }}
        run: |
          UNCOMMITTED=$(git status --porcelain | grep -v '\.impl/' || true)
          CURRENT_HEAD=$(git rev-parse HEAD)
          NEW_COMMITS="false"
          if [ "$CURRENT_HEAD" != "$PRE_IMPL_HEAD" ]; then
            NEW_COMMITS="true"
          fi

          if [ -z "$UNCOMMITTED" ] && [ "$NEW_COMMITS" = "false" ]; then
            echo "No code changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.execute.outputs.execution_success == 'true' && steps.check_changes.outputs.has_changes == 'true'
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          BRANCH_NAME: ${{ inputs.branch_name }}
          SUBMITTED_BY: ${{ inputs.submitted_by }}
        run: |
          git config user.name "$SUBMITTED_BY"
          git config user.email "$SUBMITTED_BY@users.noreply.github.com"
          claude --print \
            --model ${{ inputs.model_name }} \
            --output-format stream-json \
            --dangerously-skip-permissions \
            --verbose \
            "/erk:git-pr-push One-shot implementation"

      - name: Mark PR ready for review
        if: steps.execute.outputs.execution_success == 'true' && steps.check_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          BRANCH_NAME: ${{ inputs.branch_name }}
        run: |
          gh pr ready "$BRANCH_NAME"
          echo "PR marked ready for review"

      - name: Trigger CI workflows
        if: steps.execute.outputs.execution_success == 'true' && steps.check_changes.outputs.has_changes == 'true'
        env:
          BRANCH_NAME: ${{ inputs.branch_name }}
          SUBMITTED_BY: ${{ inputs.submitted_by }}
        run: |
          git config user.name "$SUBMITTED_BY"
          git config user.email "$SUBMITTED_BY@users.noreply.github.com"
          git fetch origin "$BRANCH_NAME"
          git reset --hard "origin/$BRANCH_NAME"
          git commit --allow-empty -m "Trigger CI workflows"
          git push origin "$BRANCH_NAME"
          echo "CI workflows triggered via push event"

      - name: Fail workflow if execution failed
        if: steps.execute.outputs.execution_success != 'true'
        run: |
          echo "One-shot execution failed with exit code: ${{ steps.execute.outputs.exit_code }}"
          exit 1
