name: pr-address
run-name: "pr-address:#${{ inputs.pr_number }}:${{ inputs.distinct_id }}"

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to address review comments"
        required: true
        type: string
      distinct_id:
        description: "Unique identifier for run discovery (base36)"
        required: true
        type: string
      model_name:
        description: "Claude model to use"
        required: false
        type: string
        default: "claude-sonnet-4-5"

concurrency:
  group: pr-address-${{ github.event.inputs.pr_number }}
  cancel-in-progress: true

jobs:
  address:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.ERK_QUEUE_GH_PAT }}
          fetch-depth: 0

      - uses: ./.github/actions/erk-remote-setup
        with:
          install-prettier: "true"
          git-user-name: "github-actions[bot]"
          git-user-email: "github-actions[bot]@users.noreply.github.com"
          erk-pat: ${{ secrets.ERK_QUEUE_GH_PAT }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude-code-oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Checkout PR branch
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
          GH_TOKEN: ${{ secrets.ERK_QUEUE_GH_PAT }}
        run: |
          gh pr checkout "$PR_NUMBER"
          echo "Checked out PR #$PR_NUMBER"

      - name: Save pre-implementation HEAD
        id: pre_impl
        run: echo "head=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Address PR review comments
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ inputs.pr_number }}
          MODEL_NAME: ${{ inputs.model_name }}
        run: |
          claude --print \
            --model "$MODEL_NAME" \
            --output-format stream-json \
            --dangerously-skip-permissions \
            --verbose \
            "/erk:pr-address"

      - name: Push changes
        env:
          GH_TOKEN: ${{ secrets.ERK_QUEUE_GH_PAT }}
        run: |
          if [ -z "$(git log --oneline @{upstream}..HEAD 2>/dev/null)" ]; then
            echo "No changes to push"
          else
            git push
            echo "Changes pushed successfully"
          fi

      - name: Generate and post summary comment
        if: always()
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
          PRE_HEAD: ${{ steps.pre_impl.outputs.head }}
          MODEL_NAME: ${{ inputs.model_name }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          JOB_STATUS: ${{ job.status }}
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get incremental diff and pipe to summary generator
          BODY=$(git diff "$PRE_HEAD"..HEAD | erk exec generate-pr-address-summary \
            --pr-number "$PR_NUMBER" \
            --pre-head "$PRE_HEAD" \
            --model-name "$MODEL_NAME" \
            --run-url "$RUN_URL" \
            --job-status "$JOB_STATUS")

          # Post or update comment using existing exec command
          erk exec post-or-update-pr-summary \
            --pr-number "$PR_NUMBER" \
            --marker "<!-- erk:pr-address-run -->" \
            --body "$BODY"
