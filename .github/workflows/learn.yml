# Learn Dispatch Workflow
#
# Runs /erk:learn on a completed plan to extract insights and patterns
# from the implementation session. This workflow is triggered asynchronously
# after a PR lands via `erk exec trigger-async-learn`.
#
# Output: Creates a new learn plan issue containing extracted lessons learned,
# architectural decisions, and reusable patterns from the implementation.

name: learn
run-name: "${{ inputs.plan_id }}:${{ inputs.distinct_id }}"

on:
  workflow_dispatch:
    inputs:
      plan_id:
        description: "Plan identifier to learn from"
        required: true
        type: string
      distinct_id:
        description: "Unique identifier for run discovery (base36)"
        required: true
        type: string
      gist_url:
        description: "URL of gist containing preprocessed learn materials"
        required: true
        type: string

concurrency:
  group: learn-plan-${{ github.event.inputs.plan_id }}
  cancel-in-progress: true

jobs:
  learn:
    if: vars.CLAUDE_ENABLED != 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.ERK_QUEUE_GH_PAT }}
          fetch-depth: 0

      - uses: ./.github/actions/erk-remote-setup
        with:
          erk-pat: ${{ secrets.ERK_QUEUE_GH_PAT }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude-code-oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Run learn workflow
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.ERK_QUEUE_GH_PAT }}
          PLAN_ID: ${{ inputs.plan_id }}
          GIST_URL: ${{ inputs.gist_url }}
          WORKFLOW_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          claude --print \
            --verbose \
            --model claude-opus-4-6 \
            --output-format stream-json \
            --dangerously-skip-permissions \
            "/erk:learn $PLAN_ID gist_url=$GIST_URL"
