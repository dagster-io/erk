# Exported from Render on 2025-08-04T17:31:04Z
# Generated from render.yaml.jinja - DO NOT EDIT DIRECTLY
# Run: uv run scripts/generate_render_yaml.py
{% set shared_env_vars = [
  "HONEYCOMB_API_KEY",
  "SECRET_ENCRYPTION_KEY",
  "ANTHROPIC_API_KEY",
  "GITHUB_TOKEN",
  "GITHUB_CLIENT_SECRET",
  "SLACK_BOT_TOKEN",
  "SLACK_SIGNING_SECRET",
  "SLACK_ADMIN_TOKEN",
  "COMPASS_DEV_TOOLS_BOT_TOKEN",
  "STRIPE_TOKEN",
  "STRIPE_PUBLISHABLE_KEY",
  "RENDER_API_KEY",
  "JWT_SECRET",
  "PROSPECTOR_DATA_BQ_JSON",
  "AWS_ACCESS_KEY_ID",
  "AWS_SECRET_ACCESS_KEY",
  "SEGMENT_WRITE_KEY",
  "TEMPORAL_ENDPOINT",
  "TEMPORAL_API_KEY"
] -%}

{%- set admin_panel_specific_vars = [
  "HTTP_PORT",
  "HTTP_HOST"
] -%}

{%- set temporal_workers = [
  {
    "name": "staging-temporal-worker",
    "dd_service": "compass-temporal-worker",
    "task_queue": "compass-queue"
  },
  {
    "name": "staging-temporal-worker-monitoring",
    "dd_service": "compass-temporal-worker-dataset-monitoring",
    "task_queue": "dataset-monitoring"
  }
] -%}

{%- macro render_shared_env_vars(indent=6) -%}
{% for var in shared_env_vars %}
{{ ' ' * indent }}- key: {{ var }}
{{ ' ' * indent }}  fromService:
{{ ' ' * indent }}    name: compass-bot
{{ ' ' * indent }}    type: web
{{ ' ' * indent }}    envVarKey: {{ var }}
{% endfor -%}
{%- endmacro -%}

databases:
  - name: compass-bot-db
    databaseName: compass_bot_db
    user: compass_bot_db_user
    plan: pro-4gb
    region: oregon
    postgresMajorVersion: "17"
    diskSizeGB: 5
# Core bot service and webserver
services:
  - type: web
    name: compass-bot
    runtime: docker
    repo: https://github.com/dagster-io/dagster-compass
    branch: master
    plan: pro plus
    envVars:
      - key: SECRET_ENCRYPTION_KEY
        sync: false
      - key: HONEYCOMB_API_KEY
        sync: false
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: GITHUB_TOKEN
        sync: false
      - key: GITHUB_CLIENT_SECRET
        sync: false
      - key: SLACK_BOT_TOKEN
        sync: false
      - key: SLACK_SIGNING_SECRET
        sync: false
      - key: SLACK_ADMIN_TOKEN
        sync: false
      - key: COMPASS_DEV_TOOLS_BOT_TOKEN
        sync: false
      - key: STRIPE_TOKEN
        sync: false
      - key: STRIPE_PUBLISHABLE_KEY
        sync: false
      - key: RENDER_API_KEY
        sync: false
      - key: JWT_SECRET
        sync: false
      - key: HTTP_PORT
        value: "3000"
      - key: HTTP_HOST
        value: "0.0.0.0"
      - key: PROSPECTOR_DATA_BQ_JSON
        sync: false
      - key: AWS_ACCESS_KEY_ID
        sync: false
      - key: AWS_SECRET_ACCESS_KEY
        sync: false
      - key: DD_ENV
        value: staging
      - key: DD_SERVICE
        value: compass-bot
      - key: DD_AGENT_HOST
        fromService:
          name: staging-datadog-agent
          type: pserv
          property: host
      - key: DD_AGENT_PORT
        value: 8126
      - key: REDIS_URL
        fromService:
          name: compass-redis-kv
          type: keyvalue
          property: connectionString
      - key: DATABASE_URL
        fromDatabase:
          name: compass-bot-db
          property: connectionString
      - key: SEGMENT_WRITE_KEY
        sync: false
      - key: TEMPORAL_ENDPOINT
        sync: false
      - key: TEMPORAL_API_KEY
        sync: false
    region: oregon
    dockerContext: .
    dockerfilePath: ./staging.Dockerfile
    autoDeployTrigger: commit
  # Datadog agent, to send APM and profiling to Datadog
  - type: pserv
    name: staging-datadog-agent
    plan: starter
    region: oregon
    runtime: docker
    dockerContext: .
    dockerfilePath: ./datadog-agent.Dockerfile
    autoDeployTrigger: commit
    envVars:
      - key: DD_API_KEY
        sync: false
  # Database tailscale reverse proxy
  - type: pserv
    name: compass-tailscale-staging
    runtime: docker
    repo: https://github.com/dagster-io/dagster-compass
    branch: master
    plan: starter
    region: oregon
    dockerContext: ./tailscale/db
    dockerfilePath: ./tailscale/db/tailscale.Dockerfile
    autoDeployTrigger: off
    disk:
      name: tailscale-staging-state
      mountPath: /var/tailscale
      sizeGB: 1
    envVars:
      - key: TAILSCALE_AUTHKEY
        sync: false
      - key: TAILSCALE_HOSTNAME
        value: staging-compass-db
      - key: COMPASS_BOT_DB_HOSTNAME
        fromDatabase:
          name: compass-bot-db
          property: host
  # Admin panel
  - type: pserv
    name: compass-admin-panel-staging
    runtime: docker
    repo: https://github.com/dagster-io/dagster-compass
    branch: master
    plan: starter
    region: oregon
    dockerContext: .
    dockerfilePath: ./staging.Dockerfile
    dockerCommand: uv run --frozen compass-admin --host 0.0.0.0 --port 8080 --config staging.csbot.config.yaml
    autoDeployTrigger: commit
    envVars:
{{ render_shared_env_vars() -}}
{%- for var in admin_panel_specific_vars %}
      - key: {{ var }}
        fromService:
          name: compass-bot
          type: web
          envVarKey: {{ var }}
{% endfor %}      - key: DATABASE_URL
        fromDatabase:
          name: compass-bot-db
          property: connectionString
  - type: pserv
    name: compass-tailscale-admin-panel-staging
    runtime: docker
    repo: https://github.com/dagster-io/dagster-compass
    branch: master
    plan: starter
    region: oregon
    dockerContext: ./tailscale/http-reverse-proxy
    dockerfilePath: ./tailscale/http-reverse-proxy/tailscale.Dockerfile
    autoDeployTrigger: off
    disk:
      name: tailscale-admin-panel-staging-state
      mountPath: /var/tailscale
      sizeGB: 1
    envVars:
      - key: TAILSCALE_AUTHKEY
        sync: false
      - key: TAILSCALE_HOSTNAME
        value: staging-compass-admin-panel
      - key: TARGET_SERVICE_HOSTNAME
        fromService:
          name: compass-admin-panel-staging
          type: pserv
          property: host
      - key: TARGET_SERVICE_PORT
        value: "8080"
  # Redis KV store
  - type: keyvalue
    name: compass-redis-kv
    plan: starter
    region: oregon
    maxmemoryPolicy: noeviction
    ipAllowList: []
{%- for worker in temporal_workers %}
  # Temporal worker{{ " for dataset monitoring" if "monitoring" in worker.name else "" }}
  - type: worker
    name: {{ worker.name }}
    runtime: docker
    repo: https://github.com/dagster-io/dagster-compass
    branch: master
    plan: pro plus
    region: oregon
    dockerContext: .
    dockerfilePath: ./staging.Dockerfile
    dockerCommand: uv run --frozen compass-temporal-worker start --config staging.csbot.config.yaml --max-concurrent-activities 10
    autoDeployTrigger: commit
    envVars:
{{ render_shared_env_vars() }}      - key: DATABASE_URL
        fromDatabase:
          name: compass-bot-db
          property: connectionString
      - key: DD_ENV
        value: staging
      - key: DD_SERVICE
        value: {{ worker.dd_service }}
      - key: DD_AGENT_HOST
        fromService:
          name: staging-datadog-agent
          type: pserv
          property: host
      - key: DD_AGENT_PORT
        value: 8126
      - key: TEMPORAL_TASK_QUEUE
        value: {{ worker.task_queue }}
{%- endfor %}

version: "1"
