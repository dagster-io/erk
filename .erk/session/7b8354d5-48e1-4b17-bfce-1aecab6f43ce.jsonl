{"type":"queue-operation","operation":"dequeue","timestamp":"2026-02-21T23:13:46.285Z","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce"}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","type":"user","message":{"role":"user","content":"<command-message>erk:plan-implement is running…</command-message>\n<command-name>/erk:plan-implement</command-name>\n<command-args>7780</command-args>"},"uuid":"903dfff2-810c-4b9f-a61c-b5cc99154b4d","timestamp":"2026-02-21T23:13:46.351Z"}
{"parentUuid":"903dfff2-810c-4b9f-a61c-b5cc99154b4d","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","type":"user","message":{"role":"user","content":[{"type":"text","text":"# /erk:plan-implement\n\nImplement a plan - either from a GitHub issue, a markdown file, an existing `.impl/` folder, or by saving the current plan first.\n\nThis is the primary implementation workflow - it orchestrates:\n\n1. Setting up the `.impl/` folder (from issue, file, existing folder, or fresh plan)\n2. Executing the implementation\n3. Running CI and submitting the PR\n\n## Prerequisites\n\n- Must be in a git repository managed by erk\n- GitHub CLI (`gh`) must be authenticated\n- One of:\n  - An issue number, URL, or file path argument\n  - An existing `.impl/` folder\n  - A plan in `~/.claude/plans/` (from plan mode)\n\n## Usage\n\n```bash\n/erk:plan-implement                    # Use .impl/ or save current plan\n/erk:plan-implement 2521               # Fetch and implement issue #2521\n/erk:plan-implement https://github.com/owner/repo/issues/2521  # URL form\n/erk:plan-implement ./my-plan.md       # Implement from local markdown file\n```\n\n---\n\n## Agent Instructions\n\n### Step 0: Parse Arguments\n\nExtract optional argument from `7780`:\n\n- **If numeric** (e.g., `2521`): Store as `ISSUE_ARG`\n- **If GitHub URL** (e.g., `https://github.com/owner/repo/issues/2521`): Extract number from path, store as `ISSUE_ARG`\n- **If path to file** (anything else non-empty): Store as `FILE_ARG`\n- **If empty**: Proceed to check `.impl/` folder\n\nStore either `ISSUE_ARG` (issue number) or `FILE_ARG` (file path), or neither if empty.\n\n### Step 1: Determine Implementation Source\n\nFollow this priority order:\n\n#### 1a. If ISSUE_ARG is provided\n\nFirst, check if `.impl/` already exists and is valid:\n\n```bash\nerk exec impl-init --json\n```\n\nIf this succeeds with `\"valid\": true`:\n\n- If `has_issue_tracking: false`: **Skip directly to Step 2d** (file-based plan, no remote to sync with).\n- If `has_issue_tracking: true`: **Still call `setup-impl-from-issue`** to ensure the local branch is synced with remote (see below). The command is idempotent — if already on the plan branch it just pulls the latest.\n\nOtherwise, set up from the specified issue:\n\n```bash\nerk exec setup-impl-from-issue <ISSUE_ARG>\n```\n\nThis command:\n\n- For draft-PR plans: checks out the plan branch and syncs with remote via pull-rebase\n- For issue-based plans: creates a feature branch from current branch (stacked) or trunk\n- Checks out the branch in the current worktree\n- Creates `.impl/` folder with the plan content\n- Saves issue reference for PR linking\n\nIf this fails, display the error and stop.\n\nThen run impl-init:\n\n```bash\nerk exec impl-init --json\n```\n\n#### 1a-file. If FILE_ARG is provided\n\nSet up from the specified markdown file:\n\n1. **Verify the file exists** using the Read tool\n2. **Extract the title** from the first `# ` heading in the file\n3. **Generate branch name** from the title (slugify: lowercase, replace spaces with hyphens, remove special chars)\n4. **Create a feature branch** (use devrun agent for gt commands):\n   ```bash\n   gt create <branch-name>\n   ```\n5. **Create `.impl/` folder** and copy the plan:\n   ```bash\n   mkdir -p .impl && cp <FILE_ARG> .impl/plan.md\n   ```\n\nThis is a local-only plan (no GitHub issue tracking).\n\nThen run impl-init:\n\n```bash\nerk exec impl-init --json\n```\n\nNote: `has_issue_tracking` will be `false` for file-based plans.\n\n#### 1b. If .impl/ already exists\n\nCheck if implementation is already set up:\n\n```bash\nerk exec impl-init --json\n```\n\nIf this succeeds with `\"valid\": true`:\n\n- If `has_issue_tracking: false`: **Skip directly to Step 2d** (file-based plan, no remote to sync with).\n- If `has_issue_tracking: true`: **Call `setup-impl-from-issue <issue_number>`** to sync the local branch with remote, then proceed to Step 2d. The `issue_number` is available in `.impl/issue.json`.\n\nIf it fails or returns `\"valid\": false`, continue to Step 2.\n\n#### 1c. Fall back to saving current plan\n\nIf neither argument nor valid `.impl/` exists, save the current plan from plan mode (Step 2).\n\n### Step 2: Save Plan to GitHub\n\nSave the current plan to GitHub and capture the issue number:\n\n```bash\nerk exec plan-save --format json --session-id=\"${CLAUDE_SESSION_ID}\"\n```\n\nParse the JSON output to get:\n\n- `issue_number`: The created issue number\n- `title`: The issue title (for branch naming)\n\nIf this fails, display the error and stop.\n\n### Step 2b: Create Branch and Setup .impl/\n\nNow set up the implementation environment using the saved issue:\n\n```bash\nerk exec setup-impl-from-issue <issue-number>\n```\n\nThis command:\n\n- Creates a feature branch from current branch (stacked) or trunk\n- Checks out the new branch in the current worktree\n- Creates `.impl/` folder with the plan content\n- Saves issue reference for PR linking\n\nIf this fails, display the error and stop.\n\n### Step 2c: Re-run Implementation Initialization\n\nRun impl-init again now that .impl/ is set up:\n\n```bash\nerk exec impl-init --json\n```\n\nUse the returned `phases` for TodoWrite entries. If validation fails, display error and stop.\n\n### Step 2d: Clean Up Plan Staging Directory (All Paths)\n\n**All setup paths converge here before Step 3.** If `.erk/impl-context/` exists in git tracking (from draft-PR plan save), remove it:\n\n```bash\nif [ -d .erk/impl-context/ ]; then\n  git rm -rf .erk/impl-context/\n  git commit -m \"Remove .erk/impl-context/ before implementation\"\n  git push origin \"$(git branch --show-current)\"\nfi\n```\n\nThis directory contains plan content committed during plan-save. It is idempotent — safe to run even when the directory doesn't exist.\n\n### Step 3: Read Plan and Load Context\n\nRead `.impl/plan.md` to understand:\n\n- Overall goal and context\n- Context & Understanding sections (API quirks, architectural insights, pitfalls)\n- Implementation phases and dependencies\n- Success criteria\n\n**Context Consumption**: Plans contain expensive discoveries. Ignoring `[CRITICAL:]` tags, \"Related Context:\" subsections, or \"DO NOT\" items causes repeated mistakes.\n\n### Step 4: Load Related Documentation\n\nIf plan contains \"Related Documentation\" section, load listed skills via Skill tool and read listed docs.\n\n### Step 5: Create TodoWrite Entries\n\nCreate todo entries for each phase from impl-init output.\n\n### Step 6: Signal GitHub Started\n\n```bash\nerk exec impl-signal started --session-id=\"${CLAUDE_SESSION_ID}\" 2>/dev/null || true\n```\n\nThis also deletes the Claude plan file (from `~/.claude/plans/`) since:\n\n- The content has been saved to GitHub issue\n- The content has been snapshotted to `.erk/scratch/`\n- Keeping it could cause confusion if the user tries to re-save\n\n### Step 7: Execute Each Phase Sequentially\n\nFor each phase:\n\n1. **Mark phase as in_progress** (in TodoWrite)\n2. **Read task requirements** carefully\n3. **Implement code AND tests together**:\n   - Load `dignified-python-313` skill for coding standards\n   - Load `fake-driven-testing` skill for test patterns\n   - Follow project AGENTS.md standards\n4. **Mark phase as completed** (in TodoWrite)\n5. **Report progress**: changes made, what's next\n\n**Important:** `.impl/plan.md` is immutable - NEVER edit during implementation\n\n### Step 8: Report Progress\n\nAfter each phase: report changes made and what's next.\n\n### Step 9: Final Verification\n\nConfirm all tasks executed, success criteria met, note deviations, summarize changes.\n\n### Step 10: Signal GitHub Ended\n\n```bash\nerk exec impl-signal ended --session-id=\"${CLAUDE_SESSION_ID}\" 2>/dev/null || true\n```\n\n### Step 10b: Upload Session for Async Learn\n\nUpload the current session to enable async learn:\n\n```bash\n# Capture session info\neval \"$(erk exec capture-session-info)\"\n\n# Get issue number from .impl/issue.json (jq extracts issue_number field)\nISSUE_NUMBER=$(jq -r '.issue_number // empty' .impl/issue.json 2>/dev/null || echo \"\")\n\n# Upload if we have both session and issue tracking\nif [ -n \"$SESSION_ID\" ] && [ -n \"$SESSION_FILE\" ] && [ -n \"$ISSUE_NUMBER\" ]; then\n  erk exec upload-session \\\n    --session-file \"$SESSION_FILE\" \\\n    --session-id \"$SESSION_ID\" \\\n    --source local \\\n    --issue-number \"$ISSUE_NUMBER\" || true\nfi\n```\n\nThis enables `erk learn --async` to work for locally-implemented PRs by uploading the session to a gist.\n\n### Step 11: Verify .impl/ Preserved\n\n**CRITICAL GUARDRAIL**: Verify the .impl/ folder was NOT deleted.\n\n```bash\nerk exec impl-verify\n```\n\nIf this fails, you have violated instructions. The .impl/ folder must be preserved for user review.\n\n### Step 12: Run CI Iteratively\n\n1. If `.erk/prompt-hooks/post-plan-implement-ci.md` exists: follow its instructions\n2. Otherwise: check CLAUDE.md/AGENTS.md for CI commands\n\n**Note:** `.worker-impl/` and `.erk/impl-context/` cleanup is handled by the workflow before implementation begins. For local execution, Step 2d handles `.erk/impl-context/` cleanup.\n\n**CRITICAL**: Never delete `.impl/` - leave for user review (no auto-commit).\n\n### Step 13: Submit PR\n\nPush the branch and create or update the PR using the Graphite-aware submit pipeline:\n\n```bash\nerk pr submit\n```\n\nThis handles pushing commits, creating/updating the PR, generating the PR description, and enhancing with Graphite stack metadata when available.\n\nAfter successful submission, signal lifecycle transition:\n\n```bash\nerk exec impl-signal submitted 2>/dev/null || true\n```\n\nThen validate PR rules:\n\n```bash\nerk pr check\n```\n\nIf checks fail, display output and warn user.\n\n### Step 14: Output Format\n\n- **Start**: \"Setting up implementation...\" or \"Fetching plan from issue #X...\"\n- **After setup**: \"Implementation environment ready, reading plan...\"\n- **Each phase**: \"Phase X: [brief description]\" with code changes\n- **End**: \"Plan execution complete. [Summary]\"\n\n---\n\n## Related Commands\n\n- `/erk:plan-save` - Save plan only, don't implement (for defer-to-later workflow)\n- `/erk:replan` - Re-plan an existing issue with current codebase state\n"}]},"isMeta":true,"uuid":"92941184-9c77-4d27-bd3a-0683312505fb","timestamp":"2026-02-21T23:13:46.351Z"}
{"parentUuid":"92941184-9c77-4d27-bd3a-0683312505fb","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","message":{"model":"claude-opus-4-6","id":"msg_01VcPMT5KNTECckzpaut8UNH","type":"message","role":"assistant","content":[{"type":"text","text":"\n\nI'll implement plan #7780. Let me start by setting up the implementation environment."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":11774,"cache_read_input_tokens":16494,"cache_creation":{"ephemeral_5m_input_tokens":11774,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4bP6VeUZppFQ7A9JHq","type":"assistant","uuid":"cf8f67c3-a7e9-4389-ae57-87e2c9afbb37","timestamp":"2026-02-21T23:13:49.752Z"}
{"parentUuid":"cf8f67c3-a7e9-4389-ae57-87e2c9afbb37","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","message":{"model":"claude-opus-4-6","id":"msg_01VcPMT5KNTECckzpaut8UNH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LBfWjnbVzdwfzb9KAQLwCY","name":"Bash","input":{"command":"erk exec impl-init --json 2>&1","description":"Check existing .impl/ folder"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":11774,"cache_read_input_tokens":16494,"cache_creation":{"ephemeral_5m_input_tokens":11774,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4bP6VeUZppFQ7A9JHq","type":"assistant","uuid":"f4527132-2a43-4fbc-90ef-b7e060921d3a","timestamp":"2026-02-21T23:13:50.462Z"}
{"parentUuid":"f4527132-2a43-4fbc-90ef-b7e060921d3a","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LBfWjnbVzdwfzb9KAQLwCY","type":"tool_result","content":"{\"valid\": true, \"impl_type\": \"impl\", \"has_issue_tracking\": true, \"related_docs\": {\"skills\": [], \"docs\": []}, \"issue_number\": 7780}","is_error":false}]},"uuid":"176fcf6d-de12-4133-a33c-83a64388e0b8","timestamp":"2026-02-21T23:13:51.686Z","toolUseResult":{"stdout":"{\"valid\": true, \"impl_type\": \"impl\", \"has_issue_tracking\": true, \"related_docs\": {\"skills\": [], \"docs\": []}, \"issue_number\": 7780}","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"176fcf6d-de12-4133-a33c-83a64388e0b8","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","message":{"model":"claude-opus-4-6","id":"msg_01KwPfJJxPWJjSLadnDACY5A","type":"message","role":"assistant","content":[{"type":"text","text":"The `.impl/` is valid with issue tracking. Let me sync with remote and read the plan."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":163,"cache_read_input_tokens":28268,"cache_creation":{"ephemeral_5m_input_tokens":163,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4bhcDrPUk7hyN967og","type":"assistant","uuid":"63dfa488-e36f-4f35-8be7-361d46b07549","timestamp":"2026-02-21T23:13:53.823Z"}
{"parentUuid":"63dfa488-e36f-4f35-8be7-361d46b07549","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","message":{"model":"claude-opus-4-6","id":"msg_01KwPfJJxPWJjSLadnDACY5A","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012bxeEkL61FogRX8Kmq4evV","name":"Bash","input":{"command":"erk exec setup-impl-from-issue 7780 2>&1","description":"Sync branch with remote"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":163,"cache_read_input_tokens":28268,"cache_creation":{"ephemeral_5m_input_tokens":163,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4bhcDrPUk7hyN967og","type":"assistant","uuid":"ae96bb71-31ec-4043-b677-fd71b7f30912","timestamp":"2026-02-21T23:13:54.610Z"}
{"parentUuid":"ae96bb71-31ec-4043-b677-fd71b7f30912","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","message":{"model":"claude-opus-4-6","id":"msg_01KwPfJJxPWJjSLadnDACY5A","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0143xWVT7mKDstZxDwu5gCzQ","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/.impl/plan.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":163,"cache_read_input_tokens":28268,"cache_creation":{"ephemeral_5m_input_tokens":163,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4bhcDrPUk7hyN967og","type":"assistant","uuid":"2f43819b-cd3a-400f-a705-5dcbe89d322f","timestamp":"2026-02-21T23:13:55.114Z"}
{"parentUuid":"2f43819b-cd3a-400f-a705-5dcbe89d322f","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012bxeEkL61FogRX8Kmq4evV","type":"tool_result","content":"Found existing .impl/ for plan #7780, skipping branch setup\n{\"success\": true, \"impl_path\": \"/home/runner/work/erk/erk/.impl\", \"issue_number\": 7780, \"issue_url\": \"https://github.com/dagster-io/erk/pull/7780\", \"branch\": \"planned/plan-consolidated-docum-02-21-1809\", \"plan_title\": \"\", \"no_impl\": false}","is_error":false}]},"uuid":"32f6f5a2-a9cf-4923-9652-2007a81b190f","timestamp":"2026-02-21T23:13:56.264Z","toolUseResult":{"stdout":"Found existing .impl/ for plan #7780, skipping branch setup\n{\"success\": true, \"impl_path\": \"/home/runner/work/erk/erk/.impl\", \"issue_number\": 7780, \"issue_url\": \"https://github.com/dagster-io/erk/pull/7780\", \"branch\": \"planned/plan-consolidated-docum-02-21-1809\", \"plan_title\": \"\", \"no_impl\": false}","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"32f6f5a2-a9cf-4923-9652-2007a81b190f","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0143xWVT7mKDstZxDwu5gCzQ","type":"tool_result","content":"     1→# Plan: Consolidated Documentation for Feb 21 Learn Sessions (Batch 2)\n     2→\n     3→> **Consolidates:** #7776, #7770, #7769, #7766, #7764\n     4→\n     5→## Context\n     6→\n     7→Five erk-learn plans were generated from implementation sessions on Feb 21, 2026. Each plan captures documentation gaps and tripwire candidates discovered during implementation work. The underlying code changes (PRs #7754, #7756, #7757, #7762, #7705) are all merged. This plan consolidates the remaining documentation work, focusing on the highest-impact items.\n     8→\n     9→## Source Plans\n    10→\n    11→| #    | Title                                                        | Items | Documented | Remaining |\n    12→| ---- | ------------------------------------------------------------ | ----- | ---------- | --------- |\n    13→| 7776 | Replace session gist archival with branch-based storage      | 26    | ~10%       | ~23       |\n    14→| 7769 | Consolidate draft-PR workflow docs / branch naming           | 14    | ~40%       | ~8        |\n    15→| 7770 | Learn skill draft PR vs issue display                        | 6     | ~60%       | ~3        |\n    16→| 7766 | Lazy tip sync for worktree pool                              | 8     | ~25%       | ~6        |\n    17→| 7764 | Draft PR plan list label duplication                         | 3     | 0%         | 3         |\n    18→\n    19→## Investigation Findings\n    20→\n    21→### Corrections to Original Plans\n    22→\n    23→- **#7776**: `docs/learned/sessions/lifecycle.md` lines 47-53 still describe gist-based persistence as current — must be rewritten to reflect branch-based storage\n    24→- **#7769**: Plan title says \"standardize from slash to hyphen\" but code uses `planned/` (slash) consistently — this was documentation consolidation only, not a code change\n    25→- **#7770**: Items #3 and #6 are already documented in `draft-pr-learn-pipeline.md` and `backend-aware-commands.md` respectively\n    26→- **#7766**: All assumptions verified correct; `slot-pool-architecture.md` exists but has no mention of the transparent sync behavior\n    27→- **#7764**: All assumptions verified correct; 0% implemented\n    28→\n    29→### Overlap Analysis\n    30→\n    31→- **Backend-aware display**: #7770 and #7766 both deal with backend-conditional behavior (CLI vs TUI). Merged into single CLI pattern doc (Step 5)\n    32→- **Tripwire additions**: Multiple plans add tripwires to the same files — batched by target file\n    33→- **Branch naming**: #7776 and #7769 both touch branch naming docs — merged into single fix (Step 2)\n    34→\n    35→## Implementation Steps\n    36→\n    37→### CRITICAL: Fix Stale Documentation\n    38→\n    39→#### Step 1: Rewrite session lifecycle gist references _(from #7776)_\n    40→\n    41→**File:** `docs/learned/sessions/lifecycle.md`\n    42→- Rewrite \"Why Gist-Based Persistence Exists\" section (lines 47-53) to \"Why Branch-Based Persistence Exists\"\n    43→- Update content to describe `session/{plan_id}` branch storage mechanism\n    44→- Remove/update any other gist references in the file\n    45→- **Source:** PR #7757 replaced gist archival with branch-based storage (commit c7f936340)\n    46→- **Verification:** No references to gist-based session storage remain as \"current\" system\n    47→\n    48→#### Step 2: Fix branch naming inconsistency _(from #7769)_\n    49→\n    50→**File:** `docs/learned/planning/branch-name-inference.md`\n    51→- Line 6: Change `plan-` prefix reference to `planned/` to match actual code\n    52→- Scan rest of file for any `plan-` vs `planned/` inconsistencies\n    53→- **Source:** Code in `docs/learned/erk/branch-naming.md` lines 50-62 confirms `planned/` (slash) prefix\n    54→- **Verification:** All branch naming references consistent across docs\n    55→\n    56→### HIGH: Missing Documentation for Implemented Features\n    57→\n    58→#### Step 3: Create lazy pool sync pattern doc _(from #7766)_\n    59→\n    60→**File:** `docs/learned/architecture/slot-pool-state-sync.md` (NEW)\n    61→- Document the lazy sync algorithm from PR #7756\n    62→- Cover: sync timing (runs after pool load, before allocation), edge cases, I/O optimization (mtime preservation when no changes)\n    63→- Reference: `src/erk/core/worktree_pool.py` for implementation details\n    64→- **Verification:** Document accurately describes the sync flow in the source code\n    65→\n    66→#### Step 4: Update slot pool architecture doc _(from #7766)_\n    67→\n    68→**File:** `docs/learned/erk/slot-pool-architecture.md`\n    69→- Add section on transparent state correction behavior from PR #7756\n    70→- Document: pool treats manual `git checkout`/`gt create` as valid, sync corrects mismatches silently\n    71→- **Verification:** Section reflects actual behavior in `worktree_pool.py`\n    72→\n    73→#### Step 5: Create CLI backend-aware display pattern doc _(from #7770, #7766)_\n    74→\n    75→**File:** `docs/learned/cli/backend-aware-display.md` (NEW)\n    76→- Document pattern for CLI commands that need to route behavior based on `plan_backend`\n    77→- Cover: `gh issue view` vs `gh pr view` routing, \"draft PR\" vs \"issue\" terminology, `ctx.plan_backend` usage\n    78→- Reference existing TUI pattern: `docs/learned/tui/backend-aware-commands.md`\n    79→- **Source:** Learn skill implementation in `src/erk/cli/commands/learn/learn_cmd.py`\n    80→- **Verification:** Pattern matches actual usage in learn_cmd.py\n    81→\n    82→#### Step 6: Update draft-pr-plan-backend.md _(from #7764)_\n    83→\n    84→**File:** `docs/learned/planning/draft-pr-plan-backend.md`\n    85→- Add \"Implementation Setup and .erk/impl-context/ Cleanup\" section\n    86→- Document: cleanup pattern, idempotency considerations, rebase conflict handling\n    87→- **Source:** PR #7762 implementation insights\n    88→- **Verification:** New section aligns with actual cleanup flow\n    89→\n    90→### MEDIUM: Tripwire Additions (batched by target file)\n    91→\n    92→#### Step 7: Add tripwires to `docs/learned/architecture/tripwires.md` _(from #7776, #7766)_\n    93→\n    94→Add these tripwires:\n    95→1. **Sync before allocation** (score 8-9/10) — Pool sync must run BEFORE `find_branch_assignment` call; silent bugs if skipped _(from #7766)_\n    96→2. **macOS sed syntax** (score 4/10) — macOS sed requires `sed -i ''` vs Linux `sed -i` _(from #7776)_\n    97→3. **Stash side effects on code execution** (score 4/10) — `git stash` changes working tree state which affects running processes _(from #7776)_\n    98→\n    99→**Verification:** Run `erk docs sync` after editing to update tripwire counts\n   100→\n   101→#### Step 8: Add tripwires to `docs/learned/planning/tripwires.md` _(from #7776, #7764)_\n   102→\n   103→Add these tripwires:\n   104→1. **Dual backend service consistency** (score 6/10) — `RealPlanListService` and `DraftPRPlanListService` must handle parameters identically; interface contracts not enforced by type system _(from #7764)_\n   105→2. **Git pull --rebase after impl-context cleanup** (score 4/10) — Required after cleanup commits to avoid merge conflicts _(from #7776)_\n   106→3. **GitHub CLI routing for plan backends** — Using `gh issue view` on a draft-PR plan produces confusing 404; route to `gh pr view` based on backend _(from #7770)_\n   107→\n   108→**Verification:** Run `erk docs sync` after editing to update tripwire counts\n   109→\n   110→#### Step 9: Add tripwires to `docs/learned/ci/tripwires.md` _(from #7764)_\n   111→\n   112→Add:\n   113→1. **Git rebase modify/delete conflict resolution** (score 5/10) — In rebase, \"them\" = upstream (opposite to merge); use `git rm` for conflicted staged files _(from #7764)_\n   114→\n   115→**Verification:** Run `erk docs sync` after editing to update tripwire counts\n   116→\n   117→#### Step 10: Add tripwire to `docs/learned/erk/tripwires.md` _(from #7769)_\n   118→\n   119→Add:\n   120→1. **Graphite cache mismatch after raw git** (score 7/10) — Running raw git commands (checkout, branch) without `gt track` causes Graphite cache to diverge from actual branch state _(from #7769)_\n   121→\n   122→**Verification:** Run `erk docs sync` after editing to update tripwire counts\n   123→\n   124→### LOW PRIORITY: Deferred Items\n   125→\n   126→These items from the source plans are deferred as lower impact:\n   127→- Schema migration pattern doc (`docs/learned/architecture/schema-migrations.md`) _(from #7776)_\n   128→- PR feedback workflow 5-phase structure _(from #7769)_\n   129→- Subagent isolation via Task tool _(from #7769)_\n   130→- False positive detection procedure _(from #7769)_\n   131→- Silent command verification pattern _(from #7769)_\n   132→- Plan-save output JSON schema doc _(from #7770)_\n   133→- \"Branch tip\" vs \"stack tip\" glossary entries _(from #7766)_\n   134→- Gist-related doc deprecation notices _(from #7776)_\n   135→- Prettier version consistency tripwire _(from #7776)_\n   136→- Git stash pattern tripwire _(from #7776)_\n   137→- I/O optimization test patterns _(from #7766)_\n   138→- FakeGit API documentation _(from #7776)_\n   139→- Discriminated union field migration pattern _(from #7776)_\n   140→- Gateway sub-gateway discovery pattern _(from #7776)_\n   141→\n   142→## Attribution\n   143→\n   144→Items by source:\n   145→- **#7776**: Steps 1, 2 (partial), 7 (items 2-3), 8 (item 2)\n   146→- **#7769**: Steps 2, 10\n   147→- **#7770**: Steps 5, 8 (item 3)\n   148→- **#7766**: Steps 3, 4, 7 (item 1)\n   149→- **#7764**: Steps 6, 8 (item 1), 9\n   150→\n   151→## Verification\n   152→\n   153→After all steps:\n   154→1. Run `erk docs sync` to regenerate tripwire counts and index\n   155→2. Run `make fast-ci` to verify no formatting/lint issues\n   156→3. Grep `docs/learned/` for stale gist references (should only appear in historical/reference context, not as \"current\" system)\n   157→4. Verify new files have correct frontmatter format\n   158→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"90417dce-c694-4b78-ace9-31fee1487386","timestamp":"2026-02-21T23:13:56.275Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/.impl/plan.md","content":"# Plan: Consolidated Documentation for Feb 21 Learn Sessions (Batch 2)\n\n> **Consolidates:** #7776, #7770, #7769, #7766, #7764\n\n## Context\n\nFive erk-learn plans were generated from implementation sessions on Feb 21, 2026. Each plan captures documentation gaps and tripwire candidates discovered during implementation work. The underlying code changes (PRs #7754, #7756, #7757, #7762, #7705) are all merged. This plan consolidates the remaining documentation work, focusing on the highest-impact items.\n\n## Source Plans\n\n| #    | Title                                                        | Items | Documented | Remaining |\n| ---- | ------------------------------------------------------------ | ----- | ---------- | --------- |\n| 7776 | Replace session gist archival with branch-based storage      | 26    | ~10%       | ~23       |\n| 7769 | Consolidate draft-PR workflow docs / branch naming           | 14    | ~40%       | ~8        |\n| 7770 | Learn skill draft PR vs issue display                        | 6     | ~60%       | ~3        |\n| 7766 | Lazy tip sync for worktree pool                              | 8     | ~25%       | ~6        |\n| 7764 | Draft PR plan list label duplication                         | 3     | 0%         | 3         |\n\n## Investigation Findings\n\n### Corrections to Original Plans\n\n- **#7776**: `docs/learned/sessions/lifecycle.md` lines 47-53 still describe gist-based persistence as current — must be rewritten to reflect branch-based storage\n- **#7769**: Plan title says \"standardize from slash to hyphen\" but code uses `planned/` (slash) consistently — this was documentation consolidation only, not a code change\n- **#7770**: Items #3 and #6 are already documented in `draft-pr-learn-pipeline.md` and `backend-aware-commands.md` respectively\n- **#7766**: All assumptions verified correct; `slot-pool-architecture.md` exists but has no mention of the transparent sync behavior\n- **#7764**: All assumptions verified correct; 0% implemented\n\n### Overlap Analysis\n\n- **Backend-aware display**: #7770 and #7766 both deal with backend-conditional behavior (CLI vs TUI). Merged into single CLI pattern doc (Step 5)\n- **Tripwire additions**: Multiple plans add tripwires to the same files — batched by target file\n- **Branch naming**: #7776 and #7769 both touch branch naming docs — merged into single fix (Step 2)\n\n## Implementation Steps\n\n### CRITICAL: Fix Stale Documentation\n\n#### Step 1: Rewrite session lifecycle gist references _(from #7776)_\n\n**File:** `docs/learned/sessions/lifecycle.md`\n- Rewrite \"Why Gist-Based Persistence Exists\" section (lines 47-53) to \"Why Branch-Based Persistence Exists\"\n- Update content to describe `session/{plan_id}` branch storage mechanism\n- Remove/update any other gist references in the file\n- **Source:** PR #7757 replaced gist archival with branch-based storage (commit c7f936340)\n- **Verification:** No references to gist-based session storage remain as \"current\" system\n\n#### Step 2: Fix branch naming inconsistency _(from #7769)_\n\n**File:** `docs/learned/planning/branch-name-inference.md`\n- Line 6: Change `plan-` prefix reference to `planned/` to match actual code\n- Scan rest of file for any `plan-` vs `planned/` inconsistencies\n- **Source:** Code in `docs/learned/erk/branch-naming.md` lines 50-62 confirms `planned/` (slash) prefix\n- **Verification:** All branch naming references consistent across docs\n\n### HIGH: Missing Documentation for Implemented Features\n\n#### Step 3: Create lazy pool sync pattern doc _(from #7766)_\n\n**File:** `docs/learned/architecture/slot-pool-state-sync.md` (NEW)\n- Document the lazy sync algorithm from PR #7756\n- Cover: sync timing (runs after pool load, before allocation), edge cases, I/O optimization (mtime preservation when no changes)\n- Reference: `src/erk/core/worktree_pool.py` for implementation details\n- **Verification:** Document accurately describes the sync flow in the source code\n\n#### Step 4: Update slot pool architecture doc _(from #7766)_\n\n**File:** `docs/learned/erk/slot-pool-architecture.md`\n- Add section on transparent state correction behavior from PR #7756\n- Document: pool treats manual `git checkout`/`gt create` as valid, sync corrects mismatches silently\n- **Verification:** Section reflects actual behavior in `worktree_pool.py`\n\n#### Step 5: Create CLI backend-aware display pattern doc _(from #7770, #7766)_\n\n**File:** `docs/learned/cli/backend-aware-display.md` (NEW)\n- Document pattern for CLI commands that need to route behavior based on `plan_backend`\n- Cover: `gh issue view` vs `gh pr view` routing, \"draft PR\" vs \"issue\" terminology, `ctx.plan_backend` usage\n- Reference existing TUI pattern: `docs/learned/tui/backend-aware-commands.md`\n- **Source:** Learn skill implementation in `src/erk/cli/commands/learn/learn_cmd.py`\n- **Verification:** Pattern matches actual usage in learn_cmd.py\n\n#### Step 6: Update draft-pr-plan-backend.md _(from #7764)_\n\n**File:** `docs/learned/planning/draft-pr-plan-backend.md`\n- Add \"Implementation Setup and .erk/impl-context/ Cleanup\" section\n- Document: cleanup pattern, idempotency considerations, rebase conflict handling\n- **Source:** PR #7762 implementation insights\n- **Verification:** New section aligns with actual cleanup flow\n\n### MEDIUM: Tripwire Additions (batched by target file)\n\n#### Step 7: Add tripwires to `docs/learned/architecture/tripwires.md` _(from #7776, #7766)_\n\nAdd these tripwires:\n1. **Sync before allocation** (score 8-9/10) — Pool sync must run BEFORE `find_branch_assignment` call; silent bugs if skipped _(from #7766)_\n2. **macOS sed syntax** (score 4/10) — macOS sed requires `sed -i ''` vs Linux `sed -i` _(from #7776)_\n3. **Stash side effects on code execution** (score 4/10) — `git stash` changes working tree state which affects running processes _(from #7776)_\n\n**Verification:** Run `erk docs sync` after editing to update tripwire counts\n\n#### Step 8: Add tripwires to `docs/learned/planning/tripwires.md` _(from #7776, #7764)_\n\nAdd these tripwires:\n1. **Dual backend service consistency** (score 6/10) — `RealPlanListService` and `DraftPRPlanListService` must handle parameters identically; interface contracts not enforced by type system _(from #7764)_\n2. **Git pull --rebase after impl-context cleanup** (score 4/10) — Required after cleanup commits to avoid merge conflicts _(from #7776)_\n3. **GitHub CLI routing for plan backends** — Using `gh issue view` on a draft-PR plan produces confusing 404; route to `gh pr view` based on backend _(from #7770)_\n\n**Verification:** Run `erk docs sync` after editing to update tripwire counts\n\n#### Step 9: Add tripwires to `docs/learned/ci/tripwires.md` _(from #7764)_\n\nAdd:\n1. **Git rebase modify/delete conflict resolution** (score 5/10) — In rebase, \"them\" = upstream (opposite to merge); use `git rm` for conflicted staged files _(from #7764)_\n\n**Verification:** Run `erk docs sync` after editing to update tripwire counts\n\n#### Step 10: Add tripwire to `docs/learned/erk/tripwires.md` _(from #7769)_\n\nAdd:\n1. **Graphite cache mismatch after raw git** (score 7/10) — Running raw git commands (checkout, branch) without `gt track` causes Graphite cache to diverge from actual branch state _(from #7769)_\n\n**Verification:** Run `erk docs sync` after editing to update tripwire counts\n\n### LOW PRIORITY: Deferred Items\n\nThese items from the source plans are deferred as lower impact:\n- Schema migration pattern doc (`docs/learned/architecture/schema-migrations.md`) _(from #7776)_\n- PR feedback workflow 5-phase structure _(from #7769)_\n- Subagent isolation via Task tool _(from #7769)_\n- False positive detection procedure _(from #7769)_\n- Silent command verification pattern _(from #7769)_\n- Plan-save output JSON schema doc _(from #7770)_\n- \"Branch tip\" vs \"stack tip\" glossary entries _(from #7766)_\n- Gist-related doc deprecation notices _(from #7776)_\n- Prettier version consistency tripwire _(from #7776)_\n- Git stash pattern tripwire _(from #7776)_\n- I/O optimization test patterns _(from #7766)_\n- FakeGit API documentation _(from #7776)_\n- Discriminated union field migration pattern _(from #7776)_\n- Gateway sub-gateway discovery pattern _(from #7776)_\n\n## Attribution\n\nItems by source:\n- **#7776**: Steps 1, 2 (partial), 7 (items 2-3), 8 (item 2)\n- **#7769**: Steps 2, 10\n- **#7770**: Steps 5, 8 (item 3)\n- **#7766**: Steps 3, 4, 7 (item 1)\n- **#7764**: Steps 6, 8 (item 1), 9\n\n## Verification\n\nAfter all steps:\n1. Run `erk docs sync` to regenerate tripwire counts and index\n2. Run `make fast-ci` to verify no formatting/lint issues\n3. Grep `docs/learned/` for stale gist references (should only appear in historical/reference context, not as \"current\" system)\n4. Verify new files have correct frontmatter format\n","numLines":158,"startLine":1,"totalLines":158}}}
{"parentUuid":"90417dce-c694-4b78-ace9-31fee1487386","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01V6ZgSDzRNXVMeaHwRhaCvr","type":"message","role":"assistant","content":[{"type":"text","text":"Good, the plan is synced and I've read it. Let me clean up `.erk/impl-context/` if it exists, then set up my todo list."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":3482,"cache_read_input_tokens":28431,"cache_creation":{"ephemeral_5m_input_tokens":3482,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4c3JtrQf2RWAgFoTxt","type":"assistant","uuid":"673dc98c-7e41-41b3-9d46-5da7b891f6cd","timestamp":"2026-02-21T23:13:59.177Z"}
{"parentUuid":"673dc98c-7e41-41b3-9d46-5da7b891f6cd","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01V6ZgSDzRNXVMeaHwRhaCvr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018fQqb2L8mz2eH7HmTnRBSj","name":"Bash","input":{"command":"if [ -d /home/runner/work/erk/erk/.erk/impl-context/ ]; then git rm -rf .erk/impl-context/ && git commit -m \"Remove .erk/impl-context/ before implementation\" && git push origin \"$(git branch --show-current)\"; else echo \"No .erk/impl-context/ to clean up\"; fi","description":"Clean up plan staging directory"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":3482,"cache_read_input_tokens":28431,"cache_creation":{"ephemeral_5m_input_tokens":3482,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4c3JtrQf2RWAgFoTxt","type":"assistant","uuid":"c9b8f45c-05c4-4d14-a6ef-5d3e7e6c914c","timestamp":"2026-02-21T23:14:01.011Z"}
{"parentUuid":"c9b8f45c-05c4-4d14-a6ef-5d3e7e6c914c","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018fQqb2L8mz2eH7HmTnRBSj","type":"tool_result","content":"No .erk/impl-context/ to clean up","is_error":false}]},"uuid":"0ac23a32-97ed-4281-943e-a53bc9c1118f","timestamp":"2026-02-21T23:14:02.679Z","toolUseResult":{"stdout":"No .erk/impl-context/ to clean up","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"0ac23a32-97ed-4281-943e-a53bc9c1118f","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01NYnh4EgZpdAuH3byij3Vua","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XEpAbV8xYCf3CyL8uC6YTv","name":"TodoWrite","input":{"todos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"pending","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"pending","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"pending","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"pending","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"pending","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"pending","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"pending","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":325,"cache_read_input_tokens":31913,"cache_creation":{"ephemeral_5m_input_tokens":325,"ephemeral_1h_input_tokens":0},"output_tokens":535,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4cWaEBpV2sS65zMQjV","type":"assistant","uuid":"a1c7c32d-9322-46f0-a842-b80f7f2c0dcb","timestamp":"2026-02-21T23:14:08.889Z"}
{"parentUuid":"a1c7c32d-9322-46f0-a842-b80f7f2c0dcb","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XEpAbV8xYCf3CyL8uC6YTv","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"46784318-6f58-4520-8ae2-f62ae0bdcf82","timestamp":"2026-02-21T23:14:08.908Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"pending","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"pending","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"pending","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"pending","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"pending","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"pending","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"pending","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]}}
{"parentUuid":"46784318-6f58-4520-8ae2-f62ae0bdcf82","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01VogxaVfVZ7XnKwRSXT2NSq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016Asf7Pv9DFcDjFYPs7FEno","name":"Bash","input":{"command":"erk exec impl-signal started --session-id \"${CLAUDE_SESSION_ID}\" 2>/dev/null || true","description":"Signal implementation started"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":563,"cache_read_input_tokens":32238,"cache_creation":{"ephemeral_5m_input_tokens":563,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4cyCs1sr1L4ce3nBna","type":"assistant","uuid":"afed2c0e-66cf-4aa4-9af9-a3f7eaa2013f","timestamp":"2026-02-21T23:14:11.913Z"}
{"parentUuid":"afed2c0e-66cf-4aa4-9af9-a3f7eaa2013f","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016Asf7Pv9DFcDjFYPs7FEno","type":"tool_result","content":"{\n  \"success\": false,\n  \"event\": \"started\",\n  \"error_type\": \"session-id-required\",\n  \"message\": \"Session ID required for impl-signal started. Ensure ${CLAUDE_SESSION_ID} is available in the command context.\"\n}","is_error":false}]},"uuid":"6fa697de-da08-41fc-b0aa-f9c21305caa2","timestamp":"2026-02-21T23:14:13.086Z","toolUseResult":{"stdout":"{\n  \"success\": false,\n  \"event\": \"started\",\n  \"error_type\": \"session-id-required\",\n  \"message\": \"Session ID required for impl-signal started. Ensure ${CLAUDE_SESSION_ID} is available in the command context.\"\n}","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"6fa697de-da08-41fc-b0aa-f9c21305caa2","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01AUQr6MsQGa3ytbJn373rUr","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me load the relevant docs and start reading the files I need to modify. Let me read them all in parallel:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":171,"cache_read_input_tokens":32801,"cache_creation":{"ephemeral_5m_input_tokens":171,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4dH59d5uDfNGj28bo9","type":"assistant","uuid":"bb0621c5-2c1d-4377-9146-dc0e928746be","timestamp":"2026-02-21T23:14:15.814Z"}
{"parentUuid":"bb0621c5-2c1d-4377-9146-dc0e928746be","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01AUQr6MsQGa3ytbJn373rUr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NjPeLChbk5LmffSroFWYjC","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/sessions/lifecycle.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":171,"cache_read_input_tokens":32801,"cache_creation":{"ephemeral_5m_input_tokens":171,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4dH59d5uDfNGj28bo9","type":"assistant","uuid":"1b95458a-ec46-4ea5-a22e-c3a87d4f5786","timestamp":"2026-02-21T23:14:16.314Z"}
{"parentUuid":"1b95458a-ec46-4ea5-a22e-c3a87d4f5786","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01AUQr6MsQGa3ytbJn373rUr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QXvpusmp3CdrBDMvv4VJnr","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/planning/branch-name-inference.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":171,"cache_read_input_tokens":32801,"cache_creation":{"ephemeral_5m_input_tokens":171,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4dH59d5uDfNGj28bo9","type":"assistant","uuid":"37e8ca83-75ac-42ac-b9a4-6519889b8e86","timestamp":"2026-02-21T23:14:16.692Z"}
{"parentUuid":"37e8ca83-75ac-42ac-b9a4-6519889b8e86","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01AUQr6MsQGa3ytbJn373rUr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01VMwaRzWmrbUSzYBSTuExEb","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/erk/slot-pool-architecture.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":171,"cache_read_input_tokens":32801,"cache_creation":{"ephemeral_5m_input_tokens":171,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4dH59d5uDfNGj28bo9","type":"assistant","uuid":"af6e9e32-378b-43ae-a181-0f9575cbd863","timestamp":"2026-02-21T23:14:17.162Z"}
{"parentUuid":"af6e9e32-378b-43ae-a181-0f9575cbd863","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01AUQr6MsQGa3ytbJn373rUr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WNb194ZUghC6VnEtx3Rboc","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/planning/draft-pr-plan-backend.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":171,"cache_read_input_tokens":32801,"cache_creation":{"ephemeral_5m_input_tokens":171,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4dH59d5uDfNGj28bo9","type":"assistant","uuid":"ae81f0e3-6721-4cb4-9008-97fa995d26e2","timestamp":"2026-02-21T23:14:17.662Z"}
{"parentUuid":"ae81f0e3-6721-4cb4-9008-97fa995d26e2","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01AUQr6MsQGa3ytbJn373rUr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01F4m5FsUAGcGfAeXF2LH7cY","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/architecture/tripwires.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":171,"cache_read_input_tokens":32801,"cache_creation":{"ephemeral_5m_input_tokens":171,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4dH59d5uDfNGj28bo9","type":"assistant","uuid":"888a94fa-6cab-428a-ba6e-68ead3cd8ca4","timestamp":"2026-02-21T23:14:18.105Z"}
{"parentUuid":"888a94fa-6cab-428a-ba6e-68ead3cd8ca4","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01AUQr6MsQGa3ytbJn373rUr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SUWnApKGmAp2JBexGuBMEm","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/planning/tripwires.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":171,"cache_read_input_tokens":32801,"cache_creation":{"ephemeral_5m_input_tokens":171,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4dH59d5uDfNGj28bo9","type":"assistant","uuid":"a5fe52c8-3484-43e1-bdb6-7816d4c288cb","timestamp":"2026-02-21T23:14:18.508Z"}
{"parentUuid":"a5fe52c8-3484-43e1-bdb6-7816d4c288cb","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01AUQr6MsQGa3ytbJn373rUr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TnjC1986C7wxMbRUBq1jXE","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/ci/tripwires.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":171,"cache_read_input_tokens":32801,"cache_creation":{"ephemeral_5m_input_tokens":171,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4dH59d5uDfNGj28bo9","type":"assistant","uuid":"d308be96-db7a-42b5-8f2a-92f2be188094","timestamp":"2026-02-21T23:14:18.926Z"}
{"parentUuid":"d308be96-db7a-42b5-8f2a-92f2be188094","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01AUQr6MsQGa3ytbJn373rUr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012fad8eeinKwnsKrahnWryZ","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/erk/tripwires.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":171,"cache_read_input_tokens":32801,"cache_creation":{"ephemeral_5m_input_tokens":171,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4dH59d5uDfNGj28bo9","type":"assistant","uuid":"8c9d8ead-45d9-4416-aa97-b9a364c3f655","timestamp":"2026-02-21T23:14:19.389Z"}
{"parentUuid":"8c9d8ead-45d9-4416-aa97-b9a364c3f655","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NjPeLChbk5LmffSroFWYjC","type":"tool_result","content":"     1→---\n     2→title: Session File Lifecycle and Persistence\n     3→read_when:\n     4→  - \"working with Claude Code session files across workflows\"\n     5→  - \"implementing learn or analysis workflows that consume session data\"\n     6→  - \"debugging missing session files in plan-based workflows\"\n     7→tripwires:\n     8→  - action: \"accessing a session by ID without checking existence first\"\n     9→    warning: \"Session files are session-scoped — Claude Code may clean them up at any time. Always use LBYL discovery (ClaudeInstallation.find_session_globally) before reading.\"\n    10→  - action: \"failing a workflow because a session file is missing\"\n    11→    warning: \"Missing sessions must never cause hard failure. Degrade through the fallback hierarchy: planning → implementation → gist → local scan → skip.\"\n    12→  - action: \"constructing session file paths manually\"\n    13→    warning: \"Use ClaudeInstallation ABC methods, not manual path construction. Storage layout is an implementation detail that may change.\"\n    14→last_audited: \"2026-02-16 14:20 PT\"\n    15→audit_result: edited\n    16→---\n    17→\n    18→# Session File Lifecycle and Persistence\n    19→\n    20→This document explains _why_ session file availability is unreliable and the architectural decisions that flow from that constraint. The core problem: erk workflows (learn, analysis) often need session data from _previous_ Claude Code sessions, but Claude Code owns the session storage lifecycle and may clean up files at any time. Erk cannot control this policy.\n    21→\n    22→## The Fundamental Constraint\n    23→\n    24→Session JSONL files are managed by Claude Code, not erk. Their lifetime is tied to the Claude Code session that created them, with no guaranteed persistence beyond that. This means a session ID stored in GitHub issue metadata (plan-header fields, issue comments) may point to a file that no longer exists on disk.\n    25→\n    26→This constraint drives two architectural decisions:\n    27→\n    28→1. **All session access must go through discovery** — never assume an ID maps to a file\n    29→2. **All session-consuming workflows must degrade gracefully** — missing data narrows scope but never causes failure\n    30→\n    31→## Three Storage Tiers\n    32→\n    33→Session data lives in three places with different persistence guarantees. Understanding which tier you're working with determines how you handle availability.\n    34→\n    35→| Tier               | Location                                 | Persistence                                  | Purpose                                                                     |\n    36→| ------------------ | ---------------------------------------- | -------------------------------------------- | --------------------------------------------------------------------------- |\n    37→| **Claude-managed** | `~/.claude/projects/<project>/sessions/` | Unpredictable — Claude Code controls cleanup | Primary session storage; most workflows start here                          |\n    38→| **Gist-uploaded**  | GitHub secret gist (URL in plan-header)  | Durable until manually deleted               | Cross-session persistence for learn workflows                               |\n    39→| **Scratch**        | `.erk/scratch/sessions/<session-id>/`    | 1 hour TTL, auto-cleaned                     | Inter-process file passing within a single session (e.g., preprocessed XML) |\n    40→\n    41→The key insight: scratch storage is _not_ a session archive — it exists for transient artifacts like preprocessed XML files that a hook produces for Claude to read. The 1-hour TTL is deliberately aggressive because scratch files become stale once the producing session ends.\n    42→\n    43→<!-- Source: packages/erk-shared/src/erk_shared/scratch/scratch.py, cleanup_stale_scratch -->\n    44→\n    45→See `cleanup_stale_scratch()` in `packages/erk-shared/src/erk_shared/scratch/scratch.py` for the TTL-based cleanup logic.\n    46→\n    47→## Why Gist-Based Persistence Exists\n    48→\n    49→The gist upload tier was added because learn workflows frequently run in a _different_ Claude Code session from the one that created or implemented the plan. By the time learn runs, the original session file is often gone. Uploading to a gist and recording the URL in the plan-header creates a durable reference that survives session cleanup.\n    50→\n    51→<!-- Source: src/erk/cli/commands/exec/scripts/upload_session.py, upload_session -->\n    52→\n    53→See `upload_session()` in `src/erk/cli/commands/exec/scripts/upload_session.py` for how gist creation and plan-header updates are coordinated.\n    54→\n    55→## Discovery Architecture\n    56→\n    57→Session discovery has two distinct paths because plan-aware and plan-unaware workflows need fundamentally different information.\n    58→\n    59→| Path             | Command                               | Starting point        | What it knows                                                           |\n    60→| ---------------- | ------------------------------------- | --------------------- | ----------------------------------------------------------------------- |\n    61→| **Plan-unaware** | `erk exec list-sessions`              | Local filesystem scan | Only what's on disk right now — no plan context                         |\n    62→| **Plan-aware**   | `erk exec get-learn-sessions <issue>` | GitHub issue metadata | All sessions ever tracked for a plan, plus which are currently readable |\n    63→\n    64→### Why two paths matter\n    65→\n    66→`list-sessions` can never find sessions from other machines or prior Claude Code lifecycles — it only sees the local project directory. `get-learn-sessions` starts from GitHub metadata and checks readability, so it can identify gist-based remote sessions that `list-sessions` would never discover. It also provides the categorization (planning vs. implementation vs. learn) that analysis workflows need.\n    67→\n    68→<!-- Source: packages/erk-shared/src/erk_shared/sessions/discovery.py, find_sessions_for_plan -->\n    69→\n    70→See `find_sessions_for_plan()` in `packages/erk-shared/src/erk_shared/sessions/discovery.py` for how plan-specific discovery extracts session IDs from multiple metadata sources (plan-header fields, impl-started/impl-ended comments, learn-invoked comments).\n    71→\n    72→### The local fallback decision\n    73→\n    74→<!-- Source: src/erk/cli/commands/exec/scripts/get_learn_sessions.py -->\n    75→\n    76→Local fallback scanning (implemented in `src/erk/cli/commands/exec/scripts/get_learn_sessions.py`) only triggers when **no** GitHub-tracked sessions are readable on disk. This is intentional: local scan results have no confirmed relationship to the plan, so mixing them with plan-tracked sessions would dilute signal. They're a last resort, not a supplement.\n    77→\n    78→When the local fallback triggers, it filters sessions by the current git branch to prevent worktree slot reuse contamination. Worktree slots are reused for different plans over time, so older sessions in the same project directory may belong to an entirely different branch. The `gitBranch` field in each session's JSONL log is matched against the current worktree branch to exclude stale sessions.\n    79→\n    80→## Graceful Degradation Hierarchy\n    81→\n    82→When a workflow needs session data, it walks a priority-ordered hierarchy. Each level represents less certainty about plan relevance but still provides value.\n    83→\n    84→| Priority | Source                                               | Why it might be missing                                                |\n    85→| -------- | ---------------------------------------------------- | ---------------------------------------------------------------------- |\n    86→| 1        | Planning session (from plan-header)                  | Created in a prior Claude Code session, since cleaned up               |\n    87→| 2        | Implementation session (from plan-header + comments) | Same lifecycle issue                                                   |\n    88→| 3        | Remote gist session                                  | Gist deleted; requires download step                                   |\n    89→| 4        | Legacy artifact session (GitHub Actions run)         | Artifacts expire after 90 days                                         |\n    90→| 5        | Local fallback scan                                  | No metadata link to plan — recent sessions may still be relevant       |\n    91→| 6        | Skip analysis                                        | Always available — produces no session insights but workflow continues |\n    92→\n    93→### Anti-pattern: hard failure on missing session\n    94→\n    95→Never `exit 1` or raise when a session file is unavailable. The entire hierarchy exists because session availability is _inherently unreliable_. Log a warning and degrade to the next level.\n    96→\n    97→### Anti-pattern: direct path construction\n    98→\n    99→Don't build session paths manually (e.g., `~/.claude/projects/.../sessions/{id}.jsonl`). The `ClaudeInstallation` ABC provides `find_session_globally()` for existence checks and `get_session_path()` for path resolution. Direct construction bypasses the abstraction and breaks if Claude Code changes its storage layout.\n   100→\n   101→## Preprocessing as a Cross-Cutting Concern\n   102→\n   103→Session preprocessing (JSONL-to-XML compression) sits at the boundary between session storage and session consumption. It achieves ~75-84% size reduction by stripping metadata, deduplicating command documentation, and truncating tool parameters. The key architectural choice: preprocessing writes to scratch storage, not back to the session tier, because compressed XML is a derived artifact with a short useful life.\n   104→\n   105→For preprocessing details (compression metrics, chunking algorithm, output modes), see [Session Preprocessing](preprocessing.md).\n   106→\n   107→## Related Documentation\n   108→\n   109→- [Session Discovery and Fallback](discovery-fallback.md) — Discovery commands, output schemas, and the fallback hierarchy in detail\n   110→- [Session Preprocessing](preprocessing.md) — Compression metrics, chunking algorithm, and output modes\n   111→- [Plan Lifecycle](../planning/lifecycle.md) — How plan-header metadata tracks session references\n   112→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"e2f5ad51-417d-4a25-b397-a70f8a1f59e1","timestamp":"2026-02-21T23:14:19.407Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/docs/learned/sessions/lifecycle.md","content":"---\ntitle: Session File Lifecycle and Persistence\nread_when:\n  - \"working with Claude Code session files across workflows\"\n  - \"implementing learn or analysis workflows that consume session data\"\n  - \"debugging missing session files in plan-based workflows\"\ntripwires:\n  - action: \"accessing a session by ID without checking existence first\"\n    warning: \"Session files are session-scoped — Claude Code may clean them up at any time. Always use LBYL discovery (ClaudeInstallation.find_session_globally) before reading.\"\n  - action: \"failing a workflow because a session file is missing\"\n    warning: \"Missing sessions must never cause hard failure. Degrade through the fallback hierarchy: planning → implementation → gist → local scan → skip.\"\n  - action: \"constructing session file paths manually\"\n    warning: \"Use ClaudeInstallation ABC methods, not manual path construction. Storage layout is an implementation detail that may change.\"\nlast_audited: \"2026-02-16 14:20 PT\"\naudit_result: edited\n---\n\n# Session File Lifecycle and Persistence\n\nThis document explains _why_ session file availability is unreliable and the architectural decisions that flow from that constraint. The core problem: erk workflows (learn, analysis) often need session data from _previous_ Claude Code sessions, but Claude Code owns the session storage lifecycle and may clean up files at any time. Erk cannot control this policy.\n\n## The Fundamental Constraint\n\nSession JSONL files are managed by Claude Code, not erk. Their lifetime is tied to the Claude Code session that created them, with no guaranteed persistence beyond that. This means a session ID stored in GitHub issue metadata (plan-header fields, issue comments) may point to a file that no longer exists on disk.\n\nThis constraint drives two architectural decisions:\n\n1. **All session access must go through discovery** — never assume an ID maps to a file\n2. **All session-consuming workflows must degrade gracefully** — missing data narrows scope but never causes failure\n\n## Three Storage Tiers\n\nSession data lives in three places with different persistence guarantees. Understanding which tier you're working with determines how you handle availability.\n\n| Tier               | Location                                 | Persistence                                  | Purpose                                                                     |\n| ------------------ | ---------------------------------------- | -------------------------------------------- | --------------------------------------------------------------------------- |\n| **Claude-managed** | `~/.claude/projects/<project>/sessions/` | Unpredictable — Claude Code controls cleanup | Primary session storage; most workflows start here                          |\n| **Gist-uploaded**  | GitHub secret gist (URL in plan-header)  | Durable until manually deleted               | Cross-session persistence for learn workflows                               |\n| **Scratch**        | `.erk/scratch/sessions/<session-id>/`    | 1 hour TTL, auto-cleaned                     | Inter-process file passing within a single session (e.g., preprocessed XML) |\n\nThe key insight: scratch storage is _not_ a session archive — it exists for transient artifacts like preprocessed XML files that a hook produces for Claude to read. The 1-hour TTL is deliberately aggressive because scratch files become stale once the producing session ends.\n\n<!-- Source: packages/erk-shared/src/erk_shared/scratch/scratch.py, cleanup_stale_scratch -->\n\nSee `cleanup_stale_scratch()` in `packages/erk-shared/src/erk_shared/scratch/scratch.py` for the TTL-based cleanup logic.\n\n## Why Gist-Based Persistence Exists\n\nThe gist upload tier was added because learn workflows frequently run in a _different_ Claude Code session from the one that created or implemented the plan. By the time learn runs, the original session file is often gone. Uploading to a gist and recording the URL in the plan-header creates a durable reference that survives session cleanup.\n\n<!-- Source: src/erk/cli/commands/exec/scripts/upload_session.py, upload_session -->\n\nSee `upload_session()` in `src/erk/cli/commands/exec/scripts/upload_session.py` for how gist creation and plan-header updates are coordinated.\n\n## Discovery Architecture\n\nSession discovery has two distinct paths because plan-aware and plan-unaware workflows need fundamentally different information.\n\n| Path             | Command                               | Starting point        | What it knows                                                           |\n| ---------------- | ------------------------------------- | --------------------- | ----------------------------------------------------------------------- |\n| **Plan-unaware** | `erk exec list-sessions`              | Local filesystem scan | Only what's on disk right now — no plan context                         |\n| **Plan-aware**   | `erk exec get-learn-sessions <issue>` | GitHub issue metadata | All sessions ever tracked for a plan, plus which are currently readable |\n\n### Why two paths matter\n\n`list-sessions` can never find sessions from other machines or prior Claude Code lifecycles — it only sees the local project directory. `get-learn-sessions` starts from GitHub metadata and checks readability, so it can identify gist-based remote sessions that `list-sessions` would never discover. It also provides the categorization (planning vs. implementation vs. learn) that analysis workflows need.\n\n<!-- Source: packages/erk-shared/src/erk_shared/sessions/discovery.py, find_sessions_for_plan -->\n\nSee `find_sessions_for_plan()` in `packages/erk-shared/src/erk_shared/sessions/discovery.py` for how plan-specific discovery extracts session IDs from multiple metadata sources (plan-header fields, impl-started/impl-ended comments, learn-invoked comments).\n\n### The local fallback decision\n\n<!-- Source: src/erk/cli/commands/exec/scripts/get_learn_sessions.py -->\n\nLocal fallback scanning (implemented in `src/erk/cli/commands/exec/scripts/get_learn_sessions.py`) only triggers when **no** GitHub-tracked sessions are readable on disk. This is intentional: local scan results have no confirmed relationship to the plan, so mixing them with plan-tracked sessions would dilute signal. They're a last resort, not a supplement.\n\nWhen the local fallback triggers, it filters sessions by the current git branch to prevent worktree slot reuse contamination. Worktree slots are reused for different plans over time, so older sessions in the same project directory may belong to an entirely different branch. The `gitBranch` field in each session's JSONL log is matched against the current worktree branch to exclude stale sessions.\n\n## Graceful Degradation Hierarchy\n\nWhen a workflow needs session data, it walks a priority-ordered hierarchy. Each level represents less certainty about plan relevance but still provides value.\n\n| Priority | Source                                               | Why it might be missing                                                |\n| -------- | ---------------------------------------------------- | ---------------------------------------------------------------------- |\n| 1        | Planning session (from plan-header)                  | Created in a prior Claude Code session, since cleaned up               |\n| 2        | Implementation session (from plan-header + comments) | Same lifecycle issue                                                   |\n| 3        | Remote gist session                                  | Gist deleted; requires download step                                   |\n| 4        | Legacy artifact session (GitHub Actions run)         | Artifacts expire after 90 days                                         |\n| 5        | Local fallback scan                                  | No metadata link to plan — recent sessions may still be relevant       |\n| 6        | Skip analysis                                        | Always available — produces no session insights but workflow continues |\n\n### Anti-pattern: hard failure on missing session\n\nNever `exit 1` or raise when a session file is unavailable. The entire hierarchy exists because session availability is _inherently unreliable_. Log a warning and degrade to the next level.\n\n### Anti-pattern: direct path construction\n\nDon't build session paths manually (e.g., `~/.claude/projects/.../sessions/{id}.jsonl`). The `ClaudeInstallation` ABC provides `find_session_globally()` for existence checks and `get_session_path()` for path resolution. Direct construction bypasses the abstraction and breaks if Claude Code changes its storage layout.\n\n## Preprocessing as a Cross-Cutting Concern\n\nSession preprocessing (JSONL-to-XML compression) sits at the boundary between session storage and session consumption. It achieves ~75-84% size reduction by stripping metadata, deduplicating command documentation, and truncating tool parameters. The key architectural choice: preprocessing writes to scratch storage, not back to the session tier, because compressed XML is a derived artifact with a short useful life.\n\nFor preprocessing details (compression metrics, chunking algorithm, output modes), see [Session Preprocessing](preprocessing.md).\n\n## Related Documentation\n\n- [Session Discovery and Fallback](discovery-fallback.md) — Discovery commands, output schemas, and the fallback hierarchy in detail\n- [Session Preprocessing](preprocessing.md) — Compression metrics, chunking algorithm, and output modes\n- [Plan Lifecycle](../planning/lifecycle.md) — How plan-header metadata tracks session references\n","numLines":112,"startLine":1,"totalLines":112}}}
{"parentUuid":"e2f5ad51-417d-4a25-b397-a70f8a1f59e1","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QXvpusmp3CdrBDMvv4VJnr","type":"tool_result","content":"     1→---\n     2→title: Branch Name Inference\n     3→last_audited: \"2026-02-08 00:00 PT\"\n     4→audit_result: clean\n     5→tripwires:\n     6→  - action: \"changing branch naming convention (P{issue}- or plan- prefix)\"\n     7→    warning: \"The P{issue}- prefix (issue-based) and plan- prefix (draft-PR) are cross-cutting contracts used by branch creation, extraction functions, and PR recovery. Changing either prefix format requires updating all consumers.\"\n     8→  - action: \"adding branch_name to plan-header at creation time\"\n     9→    warning: \"branch_name is intentionally omitted at creation because the branch doesn't exist yet. The plan-save → branch-create → impl-signal lifecycle requires this gap. See the temporal gap section below.\"\n    10→read_when:\n    11→  - \"debugging missing branch_name in plan issues\"\n    12→  - \"implementing PR lookup from plan issues\"\n    13→  - \"modifying branch creation or naming conventions\"\n    14→---\n    15→\n    16→# Branch Name Inference\n    17→\n    18→## The Temporal Gap Problem\n    19→\n    20→Plan metadata (`plan-header` block) intentionally omits `branch_name` at creation time because of a temporal gap in the plan lifecycle:\n    21→\n    22→1. **Plan saved** → GitHub issue created (no branch exists yet)\n    23→2. **Branch created** → User runs `erk br create --for-plan {issue}` (branch now exists)\n    24→3. **Implementation starts** → `impl-signal started` writes `branch_name` into the plan-header\n    25→\n    26→The gap between steps 1 and 2 is unavoidable: the plan must exist before the branch can be named after it (the branch name contains the issue number). Attempting to set `branch_name` during save would require either predicting the branch name (fragile — the user might choose a custom name) or creating the branch immediately (wrong — the user hasn't started work yet).\n    27→\n    28→## Two-Layer Resolution\n    29→\n    30→When code needs to look up a PR from a plan issue, `branch_name` may be missing from metadata. The system uses two layers:\n    31→\n    32→<!-- Source: src/erk/cli/commands/exec/scripts/get_pr_for_plan.py, get_pr_for_plan -->\n    33→\n    34→**Layer 1 — Metadata lookup**: Read `branch_name` from the `plan-header` block. This succeeds when `impl-signal started` ran successfully.\n    35→\n    36→**Layer 2 — Git context inference**: If `branch_name` is missing, check whether the current git branch matches the `P{issue_number}-` prefix. If it does, use it. This is a fail-open recovery that handles two scenarios:\n    37→\n    38→- `impl-signal` never ran (user created branch manually following the naming convention)\n    39→- `impl-signal` failed (command errored but user continued working)\n    40→\n    41→If neither layer produces a match, the command fails with an actionable error.\n    42→\n    43→## Branch Prefix Contracts\n    44→\n    45→The inference recovery depends on **cross-cutting naming contracts**. There are two branch patterns:\n    46→\n    47→### Issue-Based Branches: `P{issue}-`\n    48→\n    49→Branches for issue-based plans start with `P{issue_number}-`. This prefix is generated by two independent code paths that must stay in sync:\n    50→\n    51→<!-- Source: packages/erk-shared/src/erk_shared/naming.py, generate_issue_branch_name -->\n    52→\n    53→- **Branch creation**: `generate_issue_branch_name()` produces `P{issue}-{slug}-{timestamp}` format (with optional `O{objective_id}` segment)\n    54→\n    55→<!-- Source: src/erk/cli/commands/exec/scripts/get_pr_for_plan.py, get_pr_for_plan -->\n    56→\n    57→- **PR recovery**: `get_pr_for_plan` checks `current_branch.startswith(f\"P{issue_number}-\")`\n    58→\n    59→The prefix is the stable part of the contract. The slug and timestamp segments after the prefix vary, but inference only needs the prefix to establish the plan-to-branch mapping.\n    60→\n    61→### Draft-PR Branches: `plan-`\n    62→\n    63→Branches for draft-PR plans start with `plan-` and follow the pattern `plan-{slug}-{timestamp}` (with optional `O{objective_id}` segment). These branches have **no extractable plan ID** from the branch name alone.\n    64→\n    65→<!-- Source: packages/erk-shared/src/erk_shared/naming.py, generate_draft_pr_branch_name -->\n    66→\n    67→- **Branch creation**: `generate_draft_pr_branch_name()` produces `plan-{slug}-{timestamp}`\n    68→- **Plan ID resolution**: `DraftPRPlanBackend.resolve_plan_id_for_branch()` uses an API call, not regex\n    69→- **Source of truth**: `plan-ref.json` is the sole source of plan ID for draft-PR branches\n    70→- **Extraction functions**: `extract_leading_issue_number()` returns `None` for `plan-` branches; `extract_objective_number()` handles both `P{issue}-O{obj}-` and `plan-O{obj}-` patterns\n    71→\n    72→## When Inference Fails\n    73→\n    74→Common failure scenarios and their fixes:\n    75→\n    76→| Symptom                                | Cause                                                | Fix                                                                     |\n    77→| -------------------------------------- | ---------------------------------------------------- | ----------------------------------------------------------------------- |\n    78→| \"plan-header has no branch_name field\" | On wrong branch (e.g., `master`)                     | Switch to the plan's feature branch                                     |\n    79→| \"plan-header has no branch_name field\" | Branch uses non-standard name (e.g., `feature/1234`) | Rename branch to `P{issue}-...` or manually update plan-header metadata |\n    80→| \"No PR found for branch\"               | Branch exists but no PR was created                  | Push branch and create PR first                                         |\n    81→\n    82→## Relationship to Fail-Open Pattern\n    83→\n    84→This is an instance of the [fail-open pattern](../architecture/fail-open-patterns.md) with defense-in-depth:\n    85→\n    86→- **Primary mechanism**: `impl-signal started` explicitly writes `branch_name` into metadata (reliable when the full workflow runs)\n    87→- **Fallback mechanism**: Pattern matching against git context (enables manual workflows and recovers from signal failures)\n    88→- **Key distinction**: The fallback isn't just error recovery — it actively enables workflows where `impl-signal` was never intended to run (e.g., implementing a plan created by another developer, or plans created before `impl-signal` existed)\n    89→\n    90→## Related Documentation\n    91→\n    92→- [Fail-Open Patterns](../architecture/fail-open-patterns.md) — Defense-in-depth design pattern\n    93→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"7674cbed-2b8b-4ac2-b1d0-33bb62b723ea","timestamp":"2026-02-21T23:14:19.407Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/docs/learned/planning/branch-name-inference.md","content":"---\ntitle: Branch Name Inference\nlast_audited: \"2026-02-08 00:00 PT\"\naudit_result: clean\ntripwires:\n  - action: \"changing branch naming convention (P{issue}- or plan- prefix)\"\n    warning: \"The P{issue}- prefix (issue-based) and plan- prefix (draft-PR) are cross-cutting contracts used by branch creation, extraction functions, and PR recovery. Changing either prefix format requires updating all consumers.\"\n  - action: \"adding branch_name to plan-header at creation time\"\n    warning: \"branch_name is intentionally omitted at creation because the branch doesn't exist yet. The plan-save → branch-create → impl-signal lifecycle requires this gap. See the temporal gap section below.\"\nread_when:\n  - \"debugging missing branch_name in plan issues\"\n  - \"implementing PR lookup from plan issues\"\n  - \"modifying branch creation or naming conventions\"\n---\n\n# Branch Name Inference\n\n## The Temporal Gap Problem\n\nPlan metadata (`plan-header` block) intentionally omits `branch_name` at creation time because of a temporal gap in the plan lifecycle:\n\n1. **Plan saved** → GitHub issue created (no branch exists yet)\n2. **Branch created** → User runs `erk br create --for-plan {issue}` (branch now exists)\n3. **Implementation starts** → `impl-signal started` writes `branch_name` into the plan-header\n\nThe gap between steps 1 and 2 is unavoidable: the plan must exist before the branch can be named after it (the branch name contains the issue number). Attempting to set `branch_name` during save would require either predicting the branch name (fragile — the user might choose a custom name) or creating the branch immediately (wrong — the user hasn't started work yet).\n\n## Two-Layer Resolution\n\nWhen code needs to look up a PR from a plan issue, `branch_name` may be missing from metadata. The system uses two layers:\n\n<!-- Source: src/erk/cli/commands/exec/scripts/get_pr_for_plan.py, get_pr_for_plan -->\n\n**Layer 1 — Metadata lookup**: Read `branch_name` from the `plan-header` block. This succeeds when `impl-signal started` ran successfully.\n\n**Layer 2 — Git context inference**: If `branch_name` is missing, check whether the current git branch matches the `P{issue_number}-` prefix. If it does, use it. This is a fail-open recovery that handles two scenarios:\n\n- `impl-signal` never ran (user created branch manually following the naming convention)\n- `impl-signal` failed (command errored but user continued working)\n\nIf neither layer produces a match, the command fails with an actionable error.\n\n## Branch Prefix Contracts\n\nThe inference recovery depends on **cross-cutting naming contracts**. There are two branch patterns:\n\n### Issue-Based Branches: `P{issue}-`\n\nBranches for issue-based plans start with `P{issue_number}-`. This prefix is generated by two independent code paths that must stay in sync:\n\n<!-- Source: packages/erk-shared/src/erk_shared/naming.py, generate_issue_branch_name -->\n\n- **Branch creation**: `generate_issue_branch_name()` produces `P{issue}-{slug}-{timestamp}` format (with optional `O{objective_id}` segment)\n\n<!-- Source: src/erk/cli/commands/exec/scripts/get_pr_for_plan.py, get_pr_for_plan -->\n\n- **PR recovery**: `get_pr_for_plan` checks `current_branch.startswith(f\"P{issue_number}-\")`\n\nThe prefix is the stable part of the contract. The slug and timestamp segments after the prefix vary, but inference only needs the prefix to establish the plan-to-branch mapping.\n\n### Draft-PR Branches: `plan-`\n\nBranches for draft-PR plans start with `plan-` and follow the pattern `plan-{slug}-{timestamp}` (with optional `O{objective_id}` segment). These branches have **no extractable plan ID** from the branch name alone.\n\n<!-- Source: packages/erk-shared/src/erk_shared/naming.py, generate_draft_pr_branch_name -->\n\n- **Branch creation**: `generate_draft_pr_branch_name()` produces `plan-{slug}-{timestamp}`\n- **Plan ID resolution**: `DraftPRPlanBackend.resolve_plan_id_for_branch()` uses an API call, not regex\n- **Source of truth**: `plan-ref.json` is the sole source of plan ID for draft-PR branches\n- **Extraction functions**: `extract_leading_issue_number()` returns `None` for `plan-` branches; `extract_objective_number()` handles both `P{issue}-O{obj}-` and `plan-O{obj}-` patterns\n\n## When Inference Fails\n\nCommon failure scenarios and their fixes:\n\n| Symptom                                | Cause                                                | Fix                                                                     |\n| -------------------------------------- | ---------------------------------------------------- | ----------------------------------------------------------------------- |\n| \"plan-header has no branch_name field\" | On wrong branch (e.g., `master`)                     | Switch to the plan's feature branch                                     |\n| \"plan-header has no branch_name field\" | Branch uses non-standard name (e.g., `feature/1234`) | Rename branch to `P{issue}-...` or manually update plan-header metadata |\n| \"No PR found for branch\"               | Branch exists but no PR was created                  | Push branch and create PR first                                         |\n\n## Relationship to Fail-Open Pattern\n\nThis is an instance of the [fail-open pattern](../architecture/fail-open-patterns.md) with defense-in-depth:\n\n- **Primary mechanism**: `impl-signal started` explicitly writes `branch_name` into metadata (reliable when the full workflow runs)\n- **Fallback mechanism**: Pattern matching against git context (enables manual workflows and recovers from signal failures)\n- **Key distinction**: The fallback isn't just error recovery — it actively enables workflows where `impl-signal` was never intended to run (e.g., implementing a plan created by another developer, or plans created before `impl-signal` existed)\n\n## Related Documentation\n\n- [Fail-Open Patterns](../architecture/fail-open-patterns.md) — Defense-in-depth design pattern\n","numLines":93,"startLine":1,"totalLines":93}}}
{"parentUuid":"7674cbed-2b8b-4ac2-b1d0-33bb62b723ea","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01VMwaRzWmrbUSzYBSTuExEb","type":"tool_result","content":"     1→---\n     2→title: Slot Pool Architecture\n     3→read_when:\n     4→  - \"understanding slot pool design\"\n     5→  - \"implementing slot-related features\"\n     6→  - \"debugging slot assignment issues\"\n     7→last_audited: \"2026-02-16 14:20 PT\"\n     8→audit_result: clean\n     9→---\n    10→\n    11→# Slot Pool Architecture\n    12→\n    13→The worktree slot pool is a reusable pool of pre-allocated git worktrees for fast branch switching. Instead of creating and destroying worktrees on demand, erk maintains a fixed-size pool of worktree directories that can be reassigned to different branches.\n    14→\n    15→## Core Concepts\n    16→\n    17→### Pool Basics\n    18→\n    19→- **Pool size**: Default 4 slots, configurable via `[pool] max_slots` in `.erk/config.toml`\n    20→- **Slot names**: `erk-slot-NN` format (e.g., `erk-slot-01`, `erk-slot-02`)\n    21→- **Placeholder branches**: `__erk-slot-NN-br-stub__` for unassigned slots\n    22→- **Pool persistence**: `~/.erk/repos/{repo_name}/pool.json`\n    23→\n    24→### Why a Pool?\n    25→\n    26→Creating git worktrees is relatively slow (file system operations, git setup). The pool enables:\n    27→\n    28→1. **Fast branch switching**: Reuse existing worktrees instead of creating new ones\n    29→2. **Resource bounds**: Limit disk usage to a fixed number of worktrees\n    30→3. **Automatic eviction**: LRU eviction when pool is full\n    31→\n    32→## Data Structures\n    33→\n    34→### Data Model (`src/erk/core/worktree_pool.py`)\n    35→\n    36→**`PoolState`** — Top-level container with `version`, `pool_size`, `slots`, and `assignments` fields.\n    37→**`SlotInfo`** — Slot metadata (just a `name` field).\n    38→**`SlotAssignment`** — Maps a branch to a slot with `slot_name`, `branch_name`, `assigned_at`, and `worktree_path`.\n    39→\n    40→See `src/erk/core/worktree_pool.py` for full definitions.\n    41→\n    42→## Slot Allocation Algorithm\n    43→\n    44→The `allocate_slot_for_branch()` function in `src/erk/cli/commands/slot/common.py` implements the unified allocation strategy:\n    45→\n    46→### Step 1: Check Existing Assignment\n    47→\n    48→If the branch is already assigned to a slot, return that assignment immediately (idempotent).\n    49→\n    50→### Step 2: Fast Path - Reuse Inactive Slot\n    51→\n    52→`find_inactive_slot()` searches for worktrees that:\n    53→\n    54→- Exist in git's worktree registry\n    55→- Are not currently assigned to any branch\n    56→- Have no uncommitted changes\n    57→\n    58→This is the fast path because it reuses an existing worktree directory.\n    59→\n    60→### Step 3: Slow Path - Create New Slot\n    61→\n    62→`find_next_available_slot()` finds a slot number that:\n    63→\n    64→- Is within pool_size bounds\n    65→- Is not assigned to a branch\n    66→- Is not already initialized as a worktree\n    67→- Does not have an orphaned directory on disk\n    68→\n    69→### Step 4: Pool Full - Eviction\n    70→\n    71→If no slots are available, `handle_pool_full_interactive()` handles eviction:\n    72→\n    73→- **With `--force`**: Auto-evict oldest assignment (by `assigned_at` timestamp)\n    74→- **Interactive (TTY)**: Prompt user to confirm eviction\n    75→- **Non-interactive**: Error with instructions\n    76→\n    77→## Naming Conventions\n    78→\n    79→| Component           | Pattern                               | Example                           |\n    80→| ------------------- | ------------------------------------- | --------------------------------- |\n    81→| Slot name           | `erk-slot-NN`                         | `erk-slot-01`                     |\n    82→| Placeholder branch  | `__erk-slot-NN-br-stub__`             | `__erk-slot-01-br-stub__`         |\n    83→| Pool state file     | `pool.json`                           | `~/.erk/repos/my-repo/pool.json`  |\n    84→| Worktrees directory | `~/.erk/repos/{repo-name}/worktrees/` | `~/.erk/repos/my-repo/worktrees/` |\n    85→\n    86→## Artifact Cleanup\n    87→\n    88→When reusing a slot, `cleanup_worktree_artifacts()` removes stale data:\n    89→\n    90→- `.impl/` - Previous implementation plans\n    91→- `.erk/scratch/` - Session-specific scratch data\n    92→\n    93→These directories are in `.gitignore` so they persist across branch switches without cleanup.\n    94→\n    95→## Diagnostics & Repair\n    96→\n    97→### Sync Issues (`src/erk/cli/commands/slot/diagnostics.py`)\n    98→\n    99→The diagnostic system detects inconsistencies between:\n   100→\n   101→- Pool state (`pool.json`)\n   102→- Git worktree registry (`git worktree list`)\n   103→- Filesystem directories\n   104→\n   105→| Issue Code             | Description                                      |\n   106→| ---------------------- | ------------------------------------------------ |\n   107→| `orphan-state`         | Assignment exists but worktree directory missing |\n   108→| `orphan-dir`           | Directory exists but not in pool state           |\n   109→| `missing-branch`       | Assigned branch no longer exists in git          |\n   110→| `branch-mismatch`      | Worktree on different branch than pool says      |\n   111→| `git-registry-missing` | Pool assignment not in git worktree registry     |\n   112→| `untracked-worktree`   | Git worktree exists but not erk-managed          |\n   113→| `closed-pr`            | PR for assigned branch is closed or merged       |\n   114→\n   115→### Repair (`src/erk/cli/commands/slot/repair_cmd.py`)\n   116→\n   117→`erk slot repair` auto-fixes by removing stale assignments:\n   118→\n   119→- `orphan-state` - Remove assignment (worktree gone)\n   120→- `missing-branch` - Remove assignment (branch deleted)\n   121→- `branch-mismatch` - Remove assignment (let user re-assign)\n   122→- `git-registry-missing` - Remove assignment (not a valid worktree)\n   123→- `closed-pr` - Remove assignment (PR closed/merged)\n   124→\n   125→## Entry Points\n   126→\n   127→Commands that allocate slots via `allocate_slot_for_branch()`:\n   128→\n   129→| Command               | Description                          |\n   130→| --------------------- | ------------------------------------ |\n   131→| `erk branch create`   | Creates branch and assigns to slot   |\n   132→| `erk branch checkout` | Checks out existing branch into slot |\n   133→| `erk slot assign`     | Assigns existing branch to slot      |\n   134→| `erk pr checkout`     | Assigns branch when checking out PR  |\n   135→\n   136→## Configuration\n   137→\n   138→In `.erk/config.toml` (local config):\n   139→\n   140→```toml\n   141→[pool]\n   142→max_slots = 6  # Override default of 4\n   143→```\n   144→\n   145→## Key Source Files\n   146→\n   147→- [`src/erk/core/worktree_pool.py`](../../../src/erk/core/worktree_pool.py) - Data structures and persistence\n   148→- [`src/erk/cli/commands/slot/common.py`](../../../src/erk/cli/commands/slot/common.py) - Allocation algorithm\n   149→- [`src/erk/cli/commands/slot/diagnostics.py`](../../../src/erk/cli/commands/slot/diagnostics.py) - Health checks\n   150→- [`src/erk/cli/commands/slot/repair_cmd.py`](../../../src/erk/cli/commands/slot/repair_cmd.py) - Auto-repair\n   151→\n   152→## Related Topics\n   153→\n   154→- [Branch Cleanup](branch-cleanup.md) - Cleaning up branches and worktrees\n   155→- Load `gt-graphite` skill for worktree stack mental model\n   156→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"f802e5b8-dd0f-488c-8629-a5ba1b92b86c","timestamp":"2026-02-21T23:14:19.407Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/docs/learned/erk/slot-pool-architecture.md","content":"---\ntitle: Slot Pool Architecture\nread_when:\n  - \"understanding slot pool design\"\n  - \"implementing slot-related features\"\n  - \"debugging slot assignment issues\"\nlast_audited: \"2026-02-16 14:20 PT\"\naudit_result: clean\n---\n\n# Slot Pool Architecture\n\nThe worktree slot pool is a reusable pool of pre-allocated git worktrees for fast branch switching. Instead of creating and destroying worktrees on demand, erk maintains a fixed-size pool of worktree directories that can be reassigned to different branches.\n\n## Core Concepts\n\n### Pool Basics\n\n- **Pool size**: Default 4 slots, configurable via `[pool] max_slots` in `.erk/config.toml`\n- **Slot names**: `erk-slot-NN` format (e.g., `erk-slot-01`, `erk-slot-02`)\n- **Placeholder branches**: `__erk-slot-NN-br-stub__` for unassigned slots\n- **Pool persistence**: `~/.erk/repos/{repo_name}/pool.json`\n\n### Why a Pool?\n\nCreating git worktrees is relatively slow (file system operations, git setup). The pool enables:\n\n1. **Fast branch switching**: Reuse existing worktrees instead of creating new ones\n2. **Resource bounds**: Limit disk usage to a fixed number of worktrees\n3. **Automatic eviction**: LRU eviction when pool is full\n\n## Data Structures\n\n### Data Model (`src/erk/core/worktree_pool.py`)\n\n**`PoolState`** — Top-level container with `version`, `pool_size`, `slots`, and `assignments` fields.\n**`SlotInfo`** — Slot metadata (just a `name` field).\n**`SlotAssignment`** — Maps a branch to a slot with `slot_name`, `branch_name`, `assigned_at`, and `worktree_path`.\n\nSee `src/erk/core/worktree_pool.py` for full definitions.\n\n## Slot Allocation Algorithm\n\nThe `allocate_slot_for_branch()` function in `src/erk/cli/commands/slot/common.py` implements the unified allocation strategy:\n\n### Step 1: Check Existing Assignment\n\nIf the branch is already assigned to a slot, return that assignment immediately (idempotent).\n\n### Step 2: Fast Path - Reuse Inactive Slot\n\n`find_inactive_slot()` searches for worktrees that:\n\n- Exist in git's worktree registry\n- Are not currently assigned to any branch\n- Have no uncommitted changes\n\nThis is the fast path because it reuses an existing worktree directory.\n\n### Step 3: Slow Path - Create New Slot\n\n`find_next_available_slot()` finds a slot number that:\n\n- Is within pool_size bounds\n- Is not assigned to a branch\n- Is not already initialized as a worktree\n- Does not have an orphaned directory on disk\n\n### Step 4: Pool Full - Eviction\n\nIf no slots are available, `handle_pool_full_interactive()` handles eviction:\n\n- **With `--force`**: Auto-evict oldest assignment (by `assigned_at` timestamp)\n- **Interactive (TTY)**: Prompt user to confirm eviction\n- **Non-interactive**: Error with instructions\n\n## Naming Conventions\n\n| Component           | Pattern                               | Example                           |\n| ------------------- | ------------------------------------- | --------------------------------- |\n| Slot name           | `erk-slot-NN`                         | `erk-slot-01`                     |\n| Placeholder branch  | `__erk-slot-NN-br-stub__`             | `__erk-slot-01-br-stub__`         |\n| Pool state file     | `pool.json`                           | `~/.erk/repos/my-repo/pool.json`  |\n| Worktrees directory | `~/.erk/repos/{repo-name}/worktrees/` | `~/.erk/repos/my-repo/worktrees/` |\n\n## Artifact Cleanup\n\nWhen reusing a slot, `cleanup_worktree_artifacts()` removes stale data:\n\n- `.impl/` - Previous implementation plans\n- `.erk/scratch/` - Session-specific scratch data\n\nThese directories are in `.gitignore` so they persist across branch switches without cleanup.\n\n## Diagnostics & Repair\n\n### Sync Issues (`src/erk/cli/commands/slot/diagnostics.py`)\n\nThe diagnostic system detects inconsistencies between:\n\n- Pool state (`pool.json`)\n- Git worktree registry (`git worktree list`)\n- Filesystem directories\n\n| Issue Code             | Description                                      |\n| ---------------------- | ------------------------------------------------ |\n| `orphan-state`         | Assignment exists but worktree directory missing |\n| `orphan-dir`           | Directory exists but not in pool state           |\n| `missing-branch`       | Assigned branch no longer exists in git          |\n| `branch-mismatch`      | Worktree on different branch than pool says      |\n| `git-registry-missing` | Pool assignment not in git worktree registry     |\n| `untracked-worktree`   | Git worktree exists but not erk-managed          |\n| `closed-pr`            | PR for assigned branch is closed or merged       |\n\n### Repair (`src/erk/cli/commands/slot/repair_cmd.py`)\n\n`erk slot repair` auto-fixes by removing stale assignments:\n\n- `orphan-state` - Remove assignment (worktree gone)\n- `missing-branch` - Remove assignment (branch deleted)\n- `branch-mismatch` - Remove assignment (let user re-assign)\n- `git-registry-missing` - Remove assignment (not a valid worktree)\n- `closed-pr` - Remove assignment (PR closed/merged)\n\n## Entry Points\n\nCommands that allocate slots via `allocate_slot_for_branch()`:\n\n| Command               | Description                          |\n| --------------------- | ------------------------------------ |\n| `erk branch create`   | Creates branch and assigns to slot   |\n| `erk branch checkout` | Checks out existing branch into slot |\n| `erk slot assign`     | Assigns existing branch to slot      |\n| `erk pr checkout`     | Assigns branch when checking out PR  |\n\n## Configuration\n\nIn `.erk/config.toml` (local config):\n\n```toml\n[pool]\nmax_slots = 6  # Override default of 4\n```\n\n## Key Source Files\n\n- [`src/erk/core/worktree_pool.py`](../../../src/erk/core/worktree_pool.py) - Data structures and persistence\n- [`src/erk/cli/commands/slot/common.py`](../../../src/erk/cli/commands/slot/common.py) - Allocation algorithm\n- [`src/erk/cli/commands/slot/diagnostics.py`](../../../src/erk/cli/commands/slot/diagnostics.py) - Health checks\n- [`src/erk/cli/commands/slot/repair_cmd.py`](../../../src/erk/cli/commands/slot/repair_cmd.py) - Auto-repair\n\n## Related Topics\n\n- [Branch Cleanup](branch-cleanup.md) - Cleaning up branches and worktrees\n- Load `gt-graphite` skill for worktree stack mental model\n","numLines":156,"startLine":1,"totalLines":156}}}
{"parentUuid":"f802e5b8-dd0f-488c-8629-a5ba1b92b86c","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WNb194ZUghC6VnEtx3Rboc","type":"tool_result","content":"     1→---\n     2→title: Draft PR Plan Backend\n     3→read_when:\n     4→  - \"working with plan storage or plan backends\"\n     5→  - \"adding plan storage behavior without checking plan backend type\"\n     6→  - \"understanding how plans are stored as draft pull requests\"\n     7→  - \"modifying plan-save or land pipeline for plan handling\"\n     8→tripwires:\n     9→  - action: \"adding plan storage behavior without checking plan backend type\"\n    10→    warning: \"Two backends exist (github, draft_pr). Verify behavior works for both. See draft-pr-plan-backend.md.\"\n    11→  - action: \"validating plan_id in exec scripts without checking provider type\"\n    12→    warning: \"Draft-PR plan_id IS the PR number (not an issue number). Check provider type before assuming plan_id semantics. Issue-based plans use issue numbers; draft-PR plans use PR numbers.\"\n    13→    score: 4\n    14→  - action: \"reading ERK_PLAN_BACKEND env var inside inner functions when global_config is already in scope\"\n    15→    warning: \"Backend detection precedence: when GlobalConfig.plan_backend is available via context, use it. Never fall back to re-reading env vars inside inner functions if global_config is already in scope — the context value takes precedence and re-reading env vars bypasses context overrides.\"\n    16→    score: 8\n    17→  - action: \"spawning a GitHub Actions workflow from erk without passing plan_backend as an explicit input\"\n    18→    warning: \"Draft-PR backend propagation: GitHub Actions reusable workflows (workflow_call) do NOT inherit environment variables from the caller. ERK_PLAN_BACKEND must be declared as an explicit workflow input and passed by the caller. Ambient env vars are invisible to reusable workflows.\"\n    19→    score: 9\n    20→---\n    21→\n    22→# Draft PR Plan Backend\n    23→\n    24→DraftPRPlanBackend stores plans as GitHub draft pull requests instead of issues. It is an alternative to the default GitHubPlanStore (issue-based) backend.\n    25→\n    26→## Backend Selection\n    27→\n    28→Backend selection is controlled by the `ERK_PLAN_BACKEND` environment variable, read by `get_plan_backend()` in `packages/erk-shared/src/erk_shared/plan_store/__init__.py:19-24`:\n    29→\n    30→- `\"github\"` (default): Issue-based storage via GitHubPlanStore\n    31→- `\"draft_pr\"`: Draft PR-based storage via DraftPRPlanBackend\n    32→\n    33→Context creation in `src/erk/core/context.py:604-609` uses this to select both the plan store and plan list service:\n    34→\n    35→<!-- Source: src/erk/core/context.py, create_context -->\n    36→\n    37→See backend selection in `create_context()` in `src/erk/core/context.py` — dispatches on `get_plan_backend()` to select GitHubPlanStore or DraftPRPlanBackend.\n    38→\n    39→## Architecture\n    40→\n    41→DraftPRPlanBackend uses **composition** — it wraps the top-level GitHub gateway, not inheritance. The class is at `packages/erk-shared/src/erk_shared/plan_store/draft_pr.py`.\n    42→\n    43→Key design decisions:\n    44→\n    45→- **Lightweight init**: No I/O in `__init__`, dependencies injected (`github`, `time`)\n    46→- **Provider name**: `\"github-draft-pr\"` (used for conditional dispatch elsewhere)\n    47→- **Immutable metadata fields**: `schema_version`, `created_at`, `created_by` are protected from updates\n    48→\n    49→## PR Body Format\n    50→\n    51→Plan PRs use a structured body format: metadata block + separator + plan content.\n    52→\n    53→- **Separator**: `\"\\n\\n---\\n\\n\"`\n    54→- **Label**: `\"erk-plan\"`\n    55→- **Structure**: `<!-- plan-header metadata -->` + separator + `# Plan: Title` + content\n    56→\n    57→Helper functions `build_plan_stage_body()` and `extract_plan_content()` (public, in `draft_pr_lifecycle.py`) handle composition and extraction.\n    58→\n    59→## Plan File Commit\n    60→\n    61→Plans are committed to `.erk/plan/PLAN.md` on the draft PR branch. The `plan_save.py` script uses a try/finally pattern for branch restoration — see [plan-save-branch-restoration.md](../architecture/plan-save-branch-restoration.md).\n    62→\n    63→## Branch Naming\n    64→\n    65→Three branch name formats are supported:\n    66→\n    67→- **P-prefix**: `P{number}-{slug}` (issue-based plan branches)\n    68→- **Objective format**: `P{number}-O{objective}-{slug}` (plans linked to objectives)\n    69→- **Draft-PR**: `planned/{slug}-{MM-DD-HHMM}` or `planned/O{objective}-{slug}-{MM-DD-HHMM}` (draft-PR plans)\n    70→\n    71→See [branch-plan-resolution.md](branch-plan-resolution.md) for how branches resolve to plans.\n    72→\n    73→## Land Pipeline Integration\n    74→\n    75→The `close_review_pr()` function in `src/erk/cli/commands/land_pipeline.py:469-471` skips cleanup for draft-PR plans since they don't have separate review PRs:\n    76→\n    77→<!-- Source: src/erk/cli/commands/land_pipeline.py, close_review_pr -->\n    78→\n    79→See `close_review_pr()` in `src/erk/cli/commands/land_pipeline.py` — skips cleanup for draft-PR plans.\n    80→\n    81→## Type Narrowing\n    82→\n    83→The backend uses explicit `isinstance()` checks and conditional type conversion for metadata fields, following LBYL discipline rather than `cast()`.\n    84→\n    85→## Title Prefixing Behavior\n    86→\n    87→Draft PR titles (and issue-based plan titles) are prefixed with a label-based tag via `get_title_tag_from_labels()` in `packages/erk-shared/src/erk_shared/plan_utils.py:178-190`.\n    88→\n    89→<!-- Source: packages/erk-shared/src/erk_shared/plan_utils.py:178-190, get_title_tag_from_labels -->\n    90→\n    91→The function returns `\"[erk-learn]\"` if `\"erk-learn\"` is in the labels list, otherwise `\"[erk-plan]\"`. The prefix is prepended to the plan title during PR creation (e.g., `[erk-plan] My Feature`). For erk-learn plans, the prefix becomes `[erk-learn]` to distinguish documentation/learning plans from implementation plans in the PR list.\n    92→\n    93→## GraphQL Refactor: `list_plan_prs_with_details()`\n    94→\n    95→The plan data provider fetches PRs via a single GraphQL query (`list_plan_prs_with_details()`) instead of N+1 REST calls. This function lives in `packages/erk-shared/src/erk_shared/gateway/github/real.py:1588` and returns:\n    96→\n    97→- `list[PRDetails]` — for plan content extraction\n    98→- `dict[int, list[PullRequestInfo]]` — for display metadata (checks, review threads, merge status)\n    99→\n   100→The single query uses `GET_PLAN_PRS_WITH_DETAILS_QUERY` from `graphql_queries.py` and fetches review decision, conflict status, and CI checks in one round-trip, replacing the previous approach of fetching each PR individually.\n   101→\n   102→## Related Topics\n   103→\n   104→- [Branch Plan Resolution](branch-plan-resolution.md) - How branches resolve to plans\n   105→- [Plan Save Branch Restoration](../architecture/plan-save-branch-restoration.md) - Try/finally pattern for branch safety\n   106→- [Dual Backend Testing](../testing/dual-backend-testing.md) - Testing across both backends\n   107→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"a5c527b2-14d9-4336-ace7-7dc9b2817b3d","timestamp":"2026-02-21T23:14:19.407Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/docs/learned/planning/draft-pr-plan-backend.md","content":"---\ntitle: Draft PR Plan Backend\nread_when:\n  - \"working with plan storage or plan backends\"\n  - \"adding plan storage behavior without checking plan backend type\"\n  - \"understanding how plans are stored as draft pull requests\"\n  - \"modifying plan-save or land pipeline for plan handling\"\ntripwires:\n  - action: \"adding plan storage behavior without checking plan backend type\"\n    warning: \"Two backends exist (github, draft_pr). Verify behavior works for both. See draft-pr-plan-backend.md.\"\n  - action: \"validating plan_id in exec scripts without checking provider type\"\n    warning: \"Draft-PR plan_id IS the PR number (not an issue number). Check provider type before assuming plan_id semantics. Issue-based plans use issue numbers; draft-PR plans use PR numbers.\"\n    score: 4\n  - action: \"reading ERK_PLAN_BACKEND env var inside inner functions when global_config is already in scope\"\n    warning: \"Backend detection precedence: when GlobalConfig.plan_backend is available via context, use it. Never fall back to re-reading env vars inside inner functions if global_config is already in scope — the context value takes precedence and re-reading env vars bypasses context overrides.\"\n    score: 8\n  - action: \"spawning a GitHub Actions workflow from erk without passing plan_backend as an explicit input\"\n    warning: \"Draft-PR backend propagation: GitHub Actions reusable workflows (workflow_call) do NOT inherit environment variables from the caller. ERK_PLAN_BACKEND must be declared as an explicit workflow input and passed by the caller. Ambient env vars are invisible to reusable workflows.\"\n    score: 9\n---\n\n# Draft PR Plan Backend\n\nDraftPRPlanBackend stores plans as GitHub draft pull requests instead of issues. It is an alternative to the default GitHubPlanStore (issue-based) backend.\n\n## Backend Selection\n\nBackend selection is controlled by the `ERK_PLAN_BACKEND` environment variable, read by `get_plan_backend()` in `packages/erk-shared/src/erk_shared/plan_store/__init__.py:19-24`:\n\n- `\"github\"` (default): Issue-based storage via GitHubPlanStore\n- `\"draft_pr\"`: Draft PR-based storage via DraftPRPlanBackend\n\nContext creation in `src/erk/core/context.py:604-609` uses this to select both the plan store and plan list service:\n\n<!-- Source: src/erk/core/context.py, create_context -->\n\nSee backend selection in `create_context()` in `src/erk/core/context.py` — dispatches on `get_plan_backend()` to select GitHubPlanStore or DraftPRPlanBackend.\n\n## Architecture\n\nDraftPRPlanBackend uses **composition** — it wraps the top-level GitHub gateway, not inheritance. The class is at `packages/erk-shared/src/erk_shared/plan_store/draft_pr.py`.\n\nKey design decisions:\n\n- **Lightweight init**: No I/O in `__init__`, dependencies injected (`github`, `time`)\n- **Provider name**: `\"github-draft-pr\"` (used for conditional dispatch elsewhere)\n- **Immutable metadata fields**: `schema_version`, `created_at`, `created_by` are protected from updates\n\n## PR Body Format\n\nPlan PRs use a structured body format: metadata block + separator + plan content.\n\n- **Separator**: `\"\\n\\n---\\n\\n\"`\n- **Label**: `\"erk-plan\"`\n- **Structure**: `<!-- plan-header metadata -->` + separator + `# Plan: Title` + content\n\nHelper functions `build_plan_stage_body()` and `extract_plan_content()` (public, in `draft_pr_lifecycle.py`) handle composition and extraction.\n\n## Plan File Commit\n\nPlans are committed to `.erk/plan/PLAN.md` on the draft PR branch. The `plan_save.py` script uses a try/finally pattern for branch restoration — see [plan-save-branch-restoration.md](../architecture/plan-save-branch-restoration.md).\n\n## Branch Naming\n\nThree branch name formats are supported:\n\n- **P-prefix**: `P{number}-{slug}` (issue-based plan branches)\n- **Objective format**: `P{number}-O{objective}-{slug}` (plans linked to objectives)\n- **Draft-PR**: `planned/{slug}-{MM-DD-HHMM}` or `planned/O{objective}-{slug}-{MM-DD-HHMM}` (draft-PR plans)\n\nSee [branch-plan-resolution.md](branch-plan-resolution.md) for how branches resolve to plans.\n\n## Land Pipeline Integration\n\nThe `close_review_pr()` function in `src/erk/cli/commands/land_pipeline.py:469-471` skips cleanup for draft-PR plans since they don't have separate review PRs:\n\n<!-- Source: src/erk/cli/commands/land_pipeline.py, close_review_pr -->\n\nSee `close_review_pr()` in `src/erk/cli/commands/land_pipeline.py` — skips cleanup for draft-PR plans.\n\n## Type Narrowing\n\nThe backend uses explicit `isinstance()` checks and conditional type conversion for metadata fields, following LBYL discipline rather than `cast()`.\n\n## Title Prefixing Behavior\n\nDraft PR titles (and issue-based plan titles) are prefixed with a label-based tag via `get_title_tag_from_labels()` in `packages/erk-shared/src/erk_shared/plan_utils.py:178-190`.\n\n<!-- Source: packages/erk-shared/src/erk_shared/plan_utils.py:178-190, get_title_tag_from_labels -->\n\nThe function returns `\"[erk-learn]\"` if `\"erk-learn\"` is in the labels list, otherwise `\"[erk-plan]\"`. The prefix is prepended to the plan title during PR creation (e.g., `[erk-plan] My Feature`). For erk-learn plans, the prefix becomes `[erk-learn]` to distinguish documentation/learning plans from implementation plans in the PR list.\n\n## GraphQL Refactor: `list_plan_prs_with_details()`\n\nThe plan data provider fetches PRs via a single GraphQL query (`list_plan_prs_with_details()`) instead of N+1 REST calls. This function lives in `packages/erk-shared/src/erk_shared/gateway/github/real.py:1588` and returns:\n\n- `list[PRDetails]` — for plan content extraction\n- `dict[int, list[PullRequestInfo]]` — for display metadata (checks, review threads, merge status)\n\nThe single query uses `GET_PLAN_PRS_WITH_DETAILS_QUERY` from `graphql_queries.py` and fetches review decision, conflict status, and CI checks in one round-trip, replacing the previous approach of fetching each PR individually.\n\n## Related Topics\n\n- [Branch Plan Resolution](branch-plan-resolution.md) - How branches resolve to plans\n- [Plan Save Branch Restoration](../architecture/plan-save-branch-restoration.md) - Try/finally pattern for branch safety\n- [Dual Backend Testing](../testing/dual-backend-testing.md) - Testing across both backends\n","numLines":107,"startLine":1,"totalLines":107}}}
{"parentUuid":"a5c527b2-14d9-4336-ace7-7dc9b2817b3d","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TnjC1986C7wxMbRUBq1jXE","type":"tool_result","content":"     1→---\n     2→title: Ci Tripwires\n     3→read_when:\n     4→  - \"working on ci code\"\n     5→---\n     6→\n     7→<!-- AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY -->\n     8→<!-- Edit source frontmatter, then run 'erk docs sync' to regenerate. -->\n     9→<!-- Generated from ci/*.md frontmatter -->\n    10→\n    11→# Ci Tripwires\n    12→\n    13→Rules triggered by matching actions in code.\n    14→\n    15→**Add branches-ignore for ephemeral branch patterns** → Read [GitHub Actions Workflow Gating Patterns](workflow-gating-patterns.md) first. Label-based gating doesn't work on push events — use branches-ignore to prevent workflow queuing\n    16→\n    17→**Creating or modifying .prettierignore** → Read [Makefile Prettier Ignore Path](makefile-prettier-ignore-path.md) first. The Makefile uses `prettier --ignore-path .gitignore`, NOT `.prettierignore`. Adding rules to .prettierignore has no effect. Modify .gitignore to control what Prettier ignores.\n    18→\n    19→**GitHub Actions cannot interpolate Python constants** → Read [GitHub Actions Label Filtering Reference](github-actions-label-filtering.md) first. label strings must be hardcoded in YAML\n    20→\n    21→**GitHub Actions workflow needs to perform operations like gist creation, or session uploads fail in CI** → Read [GitHub CLI PR Comment Patterns](github-cli-comment-patterns.md) first. GitHub Actions GITHUB_TOKEN has restricted scope by default. Check token capabilities or use personal access token (PAT) for elevated permissions like gist creation.\n    22→\n    23→**Include cache keys for downloaded binaries** → Read [Composite Action Patterns](composite-action-patterns.md) first. NEVER skip cache keys for downloaded binaries — cache saves 10-20s per workflow run.\n    24→\n    25→**Label checks in push event workflows** → Read [GitHub Actions Label Queries](github-actions-label-queries.md) first. Job-level label access via github.event.pull_request.labels is ONLY available in pull_request events, NOT push events. For push events, you must use step-level GitHub API queries with gh cli or REST API.\n    26→\n    27→**Renaming a GitHub label used in CI automation** → Read [CI Label Rename Checklist](label-rename-checklist.md) first. Labels are referenced in multiple places: (1) Job-level if: conditions in all workflow files, (2) Step name descriptions and comments, (3) Documentation examples showing the label check. Missing any location will cause CI behavior to diverge from intent. Use the CI Label Rename Checklist to ensure comprehensive updates.\n    28→\n    29→**Use !contains() pattern for label-based gating** → Read [GitHub Actions Workflow Gating Patterns](workflow-gating-patterns.md) first. Negation is critical — contains() without ! skips all push events\n    30→\n    31→**Use direct GCS download for Claude Code installation** → Read [Composite Action Patterns](composite-action-patterns.md) first. NEVER use the curl | bash install script for Claude Code in CI — it hangs unpredictably. Use direct GCS download via setup-claude-code action.\n    32→\n    33→**Use erk-remote-setup for consolidated secret validation** → Read [Composite Action Patterns](composite-action-patterns.md) first. NEVER duplicate secret validation across workflows — use erk-remote-setup's consolidated validation.\n    34→\n    35→**Using escape sequences like `\\n` in GitHub Actions workflows** → Read [GitHub CLI PR Comment Patterns](github-cli-comment-patterns.md) first. Use `printf \"%b\"` instead of `echo -e` for reliable escape sequence handling. GitHub Actions uses dash/sh (POSIX standard), not bash, so `echo -e` behavior differs from local development.\n    36→\n    37→**Writing GitHub Actions workflow steps that pass large content to `gh` CLI commands (e.g., `gh pr comment --body \"$VAR\"`)** → Read [GitHub CLI PR Comment Patterns](github-cli-comment-patterns.md) first. Use `--body-file` or other file-based input to avoid Linux ARG_MAX limit (~2MB on command-line arguments). Large CI outputs like rebase logs can exceed this limit.\n    38→\n    39→**adding a new CI job that invokes Claude without checking CLAUDE_ENABLED** → Read [Claude Kill Switch](claude-kill-switch.md) first. All Claude CI jobs must check vars.CLAUDE_ENABLED != 'false' before invoking Claude. See claude-kill-switch.md.\n    40→\n    41→**adding a test job to autofix's needs list** → Read [Autofix Job Needs](autofix-job-needs.md) first. Test jobs (erkdesk-tests, unit-tests, integration-tests) must NEVER block autofix. Only jobs whose failures can be auto-resolved (format, lint, prettier, docs-check, ty) should be dependencies. Adding test jobs creates a deadlock: tests fail → autofix blocked → format/lint issues never fixed → developer must manually fix both.\n    42→\n    43→**adding new Claude-dependent exec scripts to workflows** → Read [Exec Script Environment Requirements](exec-script-environment-requirements.md) first. Check workflow environment: ANTHROPIC_API_KEY, GH_TOKEN, CLAUDE_CODE_OAUTH_TOKEN\n    44→\n    45→**adding or modifying exec scripts that use require_prompt_executor()** → Read [Exec Script Environment Requirements](exec-script-environment-requirements.md) first. Ensure workflow step has ANTHROPIC_API_KEY in environment. See exec-script-environment-requirements.md\n    46→\n    47→**asking devrun agent to fix errors** → Read [CI Iteration Pattern with devrun Agent](ci-iteration.md) first. devrun is READ-ONLY. Never prompt with 'fix errors' or 'make tests pass'. Use pattern: 'Run command and report results', then parent agent fixes based on output.\n    48→\n    49→**attempting to use prettier on Python files** → Read [Prettier Formatting for Claude Commands](claude-commands-prettier.md) first. Prettier only formats markdown in erk. Python uses ruff format. See formatter-tools.md for the complete matrix.\n    50→\n    51→**calling create_commit_status() immediately after git push** → Read [GitHub Commit Indexing Timing](github-commit-indexing-timing.md) first. GitHub's commit indexing has a race condition. Commits may not be immediately available for status updates after push. Use execute_gh_command_with_retry() wrapper, not direct subprocess calls.\n    52→\n    53→**composing conditions across multiple GitHub Actions workflow steps** → Read [GitHub Actions Workflow Patterns](github-actions-workflow-patterns.md) first. Verify each `steps.step_id.outputs.key` reference exists and matches actual step IDs.\n    54→\n    55→**creating .claude/ markdown commands without formatting** → Read [Prettier Formatting for Claude Commands](claude-commands-prettier.md) first. Run 'make prettier' via devrun after editing markdown. CI runs prettier-check as a separate job and will fail on unformatted files.\n    56→\n    57→**creating a new review without checking taxonomy** → Read [Review Types Taxonomy](review-types-taxonomy.md) first. Consult this taxonomy first. Creating overlapping reviews wastes CI resources and confuses PR status checks.\n    58→\n    59→**creating a new review without checking the review types taxonomy** → Read [Automated Review System](automated-review-system.md) first. Consult review-types-taxonomy.md first. Creating overlapping reviews wastes CI resources and confuses PR status checks.\n    60→\n    61→**creating or modifying a reusable GitHub Actions workflow (workflow_call) that depends on ERK_PLAN_BACKEND or other env vars** → Read [GitHub Actions Workflow Patterns](github-actions-workflow-patterns.md) first. Reusable workflow input forwarding: GitHub Actions reusable workflows (via workflow_call) do NOT inherit environment variables from the caller workflow. Declare ERK_PLAN_BACKEND (and any other required env vars) as explicit inputs in the reusable workflow, and pass them explicitly from the caller workflow. Ambient env vars are NOT forwarded automatically.\n    62→\n    63→**creating workflows that invoke Claude without specifying model** → Read [Workflow Model Policy](workflow-model-policy.md) first. All workflows MUST default to claude-opus-4-6. See workflow-model-policy.md for the standardization rationale.\n    64→\n    65→**editing markdown files in docs/** → Read [Markdown Formatting in CI Workflows](markdown-formatting.md) first. Run `make prettier` via devrun after markdown edits. Multi-line edits trigger Prettier failures. Never manually format - use the command.\n    66→\n    67→**implementing change detection without baseline capture** → Read [erk-impl Change Detection](plan-implement-change-detection.md) first. Read this doc first. Always capture baseline state BEFORE mutation, then compare AFTER.\n    68→\n    69→**interpolating ${{ }} expressions directly into shell command arguments** → Read [GitHub Actions Security Patterns](github-actions-security.md) first. Use environment variables instead. Direct interpolation allows shell injection. Read [GitHub Actions Security Patterns](ci/github-actions-security.md) first.\n    70→\n    71→**investigating a bot complaint about formatting** → Read [Prettier Formatting for Claude Commands](claude-commands-prettier.md) first. Prettier is the formatting authority for markdown/YAML/JSON files. If prettier --check passes locally, dismiss the bot complaint. See docs/learned/pr-operations/automated-review-handling.md.\n    72→\n    73→**placing test files outside both tests/ and packages/\\*/tests/ directories** → Read [Test Coverage Detection](test-coverage-detection.md) first. The test-coverage-review bot only searches tests/**/ and packages/\\*/tests/**/ for corresponding test files. Tests placed elsewhere will not be detected and will cause false 'no tests' flags.\n    74→\n    75→**reading statusCheckRollup results immediately after push** → Read [CI Iteration Pattern with devrun Agent](ci-iteration.md) first. After push, results show completed runs only, not in-progress. Wait for new check suite to appear before reading CI status.\n    76→\n    77→**running `git reset --hard` in workflows after staging cleanup** → Read [erk-impl Workflow Patterns](plan-implement-workflow-patterns.md) first. Verify all cleanup changes are committed BEFORE reset; staged changes without commit will be silently discarded.\n    78→\n    79→**running only prettier after editing Python files** → Read [Formatting Workflow Decision Tree](formatting-workflow.md) first. Prettier silently skips Python files. Always use 'make format' for .py files.\n    80→\n    81→**running prettier on Python files** → Read [Formatter Tools](formatter-tools.md) first. Prettier cannot format Python. Use `ruff format` or `make format` for Python. Prettier only handles Markdown in this project.\n    82→\n    83→**running prettier programmatically on content containing underscore emphasis** → Read [Formatter Tools](formatter-tools.md) first. Prettier converts `__text__` to `**text**` on first pass, then escapes asterisks on second pass. If programmatically applying prettier, run twice to reach stable output.\n    84→\n    85→**using Edit tool on Python files** → Read [Edit Tool Formatting Behavior](edit-tool-formatting.md) first. Edit tool preserves exact indentation without auto-formatting. Always run 'make format' after editing Python code.\n    86→\n    87→**using echo with multi-line content to GITHUB_OUTPUT** → Read [GitHub Actions Output Patterns](github-actions-output-patterns.md) first. Multi-line content requires heredoc syntax with EOF delimiter. Simple echo only works for single-line values.\n    88→\n    89→**using fnmatch for gitignore-style glob patterns** → Read [Convention-Based Code Reviews](convention-based-reviews.md) first. Use pathspec library instead. fnmatch doesn't support \\*\\* recursive globs. Example: pathspec.PathSpec.from_lines('gitignore', patterns)\n    90→\n    91→**using generic variable names in change detection logic** → Read [erk-impl Change Detection](plan-implement-change-detection.md) first. Use explicit names (UNCOMMITTED, NEW_COMMITS) not generic ones (CHANGES).\n    92→\n    93→**using heredoc (<<) syntax in GitHub Actions YAML** → Read [CI Prompt Patterns](prompt-patterns.md) first. Use `erk exec get-embedded-prompt` instead. Heredocs in YAML `run:` blocks have fragile indentation that causes silent failures.\n    94→\n    95→**using this pattern** → Read [GitHub Actions Label Filtering Reference](github-actions-label-filtering.md) first. Always use negation (!contains) for safe defaults on push events without PR context\n    96→\n    97→**using this pattern** → Read [Workflow Naming Conventions](workflow-naming-conventions.md) first. The CLI command name MUST match the workflow filename (without .yml)\n    98→\n    99→**using this pattern** → Read [Workflow Naming Conventions](workflow-naming-conventions.md) first. The workflow's name: field MUST match the CLI command name\n   100→\n   101→**using this pattern** → Read [Workflow Naming Conventions](workflow-naming-conventions.md) first. Update WORKFLOW_COMMAND_MAP when adding launchable workflows\n   102→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"ec57d5d8-6e1b-4f07-b607-eb4b698ff88a","timestamp":"2026-02-21T23:14:19.408Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/docs/learned/ci/tripwires.md","content":"---\ntitle: Ci Tripwires\nread_when:\n  - \"working on ci code\"\n---\n\n<!-- AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY -->\n<!-- Edit source frontmatter, then run 'erk docs sync' to regenerate. -->\n<!-- Generated from ci/*.md frontmatter -->\n\n# Ci Tripwires\n\nRules triggered by matching actions in code.\n\n**Add branches-ignore for ephemeral branch patterns** → Read [GitHub Actions Workflow Gating Patterns](workflow-gating-patterns.md) first. Label-based gating doesn't work on push events — use branches-ignore to prevent workflow queuing\n\n**Creating or modifying .prettierignore** → Read [Makefile Prettier Ignore Path](makefile-prettier-ignore-path.md) first. The Makefile uses `prettier --ignore-path .gitignore`, NOT `.prettierignore`. Adding rules to .prettierignore has no effect. Modify .gitignore to control what Prettier ignores.\n\n**GitHub Actions cannot interpolate Python constants** → Read [GitHub Actions Label Filtering Reference](github-actions-label-filtering.md) first. label strings must be hardcoded in YAML\n\n**GitHub Actions workflow needs to perform operations like gist creation, or session uploads fail in CI** → Read [GitHub CLI PR Comment Patterns](github-cli-comment-patterns.md) first. GitHub Actions GITHUB_TOKEN has restricted scope by default. Check token capabilities or use personal access token (PAT) for elevated permissions like gist creation.\n\n**Include cache keys for downloaded binaries** → Read [Composite Action Patterns](composite-action-patterns.md) first. NEVER skip cache keys for downloaded binaries — cache saves 10-20s per workflow run.\n\n**Label checks in push event workflows** → Read [GitHub Actions Label Queries](github-actions-label-queries.md) first. Job-level label access via github.event.pull_request.labels is ONLY available in pull_request events, NOT push events. For push events, you must use step-level GitHub API queries with gh cli or REST API.\n\n**Renaming a GitHub label used in CI automation** → Read [CI Label Rename Checklist](label-rename-checklist.md) first. Labels are referenced in multiple places: (1) Job-level if: conditions in all workflow files, (2) Step name descriptions and comments, (3) Documentation examples showing the label check. Missing any location will cause CI behavior to diverge from intent. Use the CI Label Rename Checklist to ensure comprehensive updates.\n\n**Use !contains() pattern for label-based gating** → Read [GitHub Actions Workflow Gating Patterns](workflow-gating-patterns.md) first. Negation is critical — contains() without ! skips all push events\n\n**Use direct GCS download for Claude Code installation** → Read [Composite Action Patterns](composite-action-patterns.md) first. NEVER use the curl | bash install script for Claude Code in CI — it hangs unpredictably. Use direct GCS download via setup-claude-code action.\n\n**Use erk-remote-setup for consolidated secret validation** → Read [Composite Action Patterns](composite-action-patterns.md) first. NEVER duplicate secret validation across workflows — use erk-remote-setup's consolidated validation.\n\n**Using escape sequences like `\\n` in GitHub Actions workflows** → Read [GitHub CLI PR Comment Patterns](github-cli-comment-patterns.md) first. Use `printf \"%b\"` instead of `echo -e` for reliable escape sequence handling. GitHub Actions uses dash/sh (POSIX standard), not bash, so `echo -e` behavior differs from local development.\n\n**Writing GitHub Actions workflow steps that pass large content to `gh` CLI commands (e.g., `gh pr comment --body \"$VAR\"`)** → Read [GitHub CLI PR Comment Patterns](github-cli-comment-patterns.md) first. Use `--body-file` or other file-based input to avoid Linux ARG_MAX limit (~2MB on command-line arguments). Large CI outputs like rebase logs can exceed this limit.\n\n**adding a new CI job that invokes Claude without checking CLAUDE_ENABLED** → Read [Claude Kill Switch](claude-kill-switch.md) first. All Claude CI jobs must check vars.CLAUDE_ENABLED != 'false' before invoking Claude. See claude-kill-switch.md.\n\n**adding a test job to autofix's needs list** → Read [Autofix Job Needs](autofix-job-needs.md) first. Test jobs (erkdesk-tests, unit-tests, integration-tests) must NEVER block autofix. Only jobs whose failures can be auto-resolved (format, lint, prettier, docs-check, ty) should be dependencies. Adding test jobs creates a deadlock: tests fail → autofix blocked → format/lint issues never fixed → developer must manually fix both.\n\n**adding new Claude-dependent exec scripts to workflows** → Read [Exec Script Environment Requirements](exec-script-environment-requirements.md) first. Check workflow environment: ANTHROPIC_API_KEY, GH_TOKEN, CLAUDE_CODE_OAUTH_TOKEN\n\n**adding or modifying exec scripts that use require_prompt_executor()** → Read [Exec Script Environment Requirements](exec-script-environment-requirements.md) first. Ensure workflow step has ANTHROPIC_API_KEY in environment. See exec-script-environment-requirements.md\n\n**asking devrun agent to fix errors** → Read [CI Iteration Pattern with devrun Agent](ci-iteration.md) first. devrun is READ-ONLY. Never prompt with 'fix errors' or 'make tests pass'. Use pattern: 'Run command and report results', then parent agent fixes based on output.\n\n**attempting to use prettier on Python files** → Read [Prettier Formatting for Claude Commands](claude-commands-prettier.md) first. Prettier only formats markdown in erk. Python uses ruff format. See formatter-tools.md for the complete matrix.\n\n**calling create_commit_status() immediately after git push** → Read [GitHub Commit Indexing Timing](github-commit-indexing-timing.md) first. GitHub's commit indexing has a race condition. Commits may not be immediately available for status updates after push. Use execute_gh_command_with_retry() wrapper, not direct subprocess calls.\n\n**composing conditions across multiple GitHub Actions workflow steps** → Read [GitHub Actions Workflow Patterns](github-actions-workflow-patterns.md) first. Verify each `steps.step_id.outputs.key` reference exists and matches actual step IDs.\n\n**creating .claude/ markdown commands without formatting** → Read [Prettier Formatting for Claude Commands](claude-commands-prettier.md) first. Run 'make prettier' via devrun after editing markdown. CI runs prettier-check as a separate job and will fail on unformatted files.\n\n**creating a new review without checking taxonomy** → Read [Review Types Taxonomy](review-types-taxonomy.md) first. Consult this taxonomy first. Creating overlapping reviews wastes CI resources and confuses PR status checks.\n\n**creating a new review without checking the review types taxonomy** → Read [Automated Review System](automated-review-system.md) first. Consult review-types-taxonomy.md first. Creating overlapping reviews wastes CI resources and confuses PR status checks.\n\n**creating or modifying a reusable GitHub Actions workflow (workflow_call) that depends on ERK_PLAN_BACKEND or other env vars** → Read [GitHub Actions Workflow Patterns](github-actions-workflow-patterns.md) first. Reusable workflow input forwarding: GitHub Actions reusable workflows (via workflow_call) do NOT inherit environment variables from the caller workflow. Declare ERK_PLAN_BACKEND (and any other required env vars) as explicit inputs in the reusable workflow, and pass them explicitly from the caller workflow. Ambient env vars are NOT forwarded automatically.\n\n**creating workflows that invoke Claude without specifying model** → Read [Workflow Model Policy](workflow-model-policy.md) first. All workflows MUST default to claude-opus-4-6. See workflow-model-policy.md for the standardization rationale.\n\n**editing markdown files in docs/** → Read [Markdown Formatting in CI Workflows](markdown-formatting.md) first. Run `make prettier` via devrun after markdown edits. Multi-line edits trigger Prettier failures. Never manually format - use the command.\n\n**implementing change detection without baseline capture** → Read [erk-impl Change Detection](plan-implement-change-detection.md) first. Read this doc first. Always capture baseline state BEFORE mutation, then compare AFTER.\n\n**interpolating ${{ }} expressions directly into shell command arguments** → Read [GitHub Actions Security Patterns](github-actions-security.md) first. Use environment variables instead. Direct interpolation allows shell injection. Read [GitHub Actions Security Patterns](ci/github-actions-security.md) first.\n\n**investigating a bot complaint about formatting** → Read [Prettier Formatting for Claude Commands](claude-commands-prettier.md) first. Prettier is the formatting authority for markdown/YAML/JSON files. If prettier --check passes locally, dismiss the bot complaint. See docs/learned/pr-operations/automated-review-handling.md.\n\n**placing test files outside both tests/ and packages/\\*/tests/ directories** → Read [Test Coverage Detection](test-coverage-detection.md) first. The test-coverage-review bot only searches tests/**/ and packages/\\*/tests/**/ for corresponding test files. Tests placed elsewhere will not be detected and will cause false 'no tests' flags.\n\n**reading statusCheckRollup results immediately after push** → Read [CI Iteration Pattern with devrun Agent](ci-iteration.md) first. After push, results show completed runs only, not in-progress. Wait for new check suite to appear before reading CI status.\n\n**running `git reset --hard` in workflows after staging cleanup** → Read [erk-impl Workflow Patterns](plan-implement-workflow-patterns.md) first. Verify all cleanup changes are committed BEFORE reset; staged changes without commit will be silently discarded.\n\n**running only prettier after editing Python files** → Read [Formatting Workflow Decision Tree](formatting-workflow.md) first. Prettier silently skips Python files. Always use 'make format' for .py files.\n\n**running prettier on Python files** → Read [Formatter Tools](formatter-tools.md) first. Prettier cannot format Python. Use `ruff format` or `make format` for Python. Prettier only handles Markdown in this project.\n\n**running prettier programmatically on content containing underscore emphasis** → Read [Formatter Tools](formatter-tools.md) first. Prettier converts `__text__` to `**text**` on first pass, then escapes asterisks on second pass. If programmatically applying prettier, run twice to reach stable output.\n\n**using Edit tool on Python files** → Read [Edit Tool Formatting Behavior](edit-tool-formatting.md) first. Edit tool preserves exact indentation without auto-formatting. Always run 'make format' after editing Python code.\n\n**using echo with multi-line content to GITHUB_OUTPUT** → Read [GitHub Actions Output Patterns](github-actions-output-patterns.md) first. Multi-line content requires heredoc syntax with EOF delimiter. Simple echo only works for single-line values.\n\n**using fnmatch for gitignore-style glob patterns** → Read [Convention-Based Code Reviews](convention-based-reviews.md) first. Use pathspec library instead. fnmatch doesn't support \\*\\* recursive globs. Example: pathspec.PathSpec.from_lines('gitignore', patterns)\n\n**using generic variable names in change detection logic** → Read [erk-impl Change Detection](plan-implement-change-detection.md) first. Use explicit names (UNCOMMITTED, NEW_COMMITS) not generic ones (CHANGES).\n\n**using heredoc (<<) syntax in GitHub Actions YAML** → Read [CI Prompt Patterns](prompt-patterns.md) first. Use `erk exec get-embedded-prompt` instead. Heredocs in YAML `run:` blocks have fragile indentation that causes silent failures.\n\n**using this pattern** → Read [GitHub Actions Label Filtering Reference](github-actions-label-filtering.md) first. Always use negation (!contains) for safe defaults on push events without PR context\n\n**using this pattern** → Read [Workflow Naming Conventions](workflow-naming-conventions.md) first. The CLI command name MUST match the workflow filename (without .yml)\n\n**using this pattern** → Read [Workflow Naming Conventions](workflow-naming-conventions.md) first. The workflow's name: field MUST match the CLI command name\n\n**using this pattern** → Read [Workflow Naming Conventions](workflow-naming-conventions.md) first. Update WORKFLOW_COMMAND_MAP when adding launchable workflows\n","numLines":102,"startLine":1,"totalLines":102}}}
{"parentUuid":"ec57d5d8-6e1b-4f07-b607-eb4b698ff88a","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012fad8eeinKwnsKrahnWryZ","type":"tool_result","content":"     1→---\n     2→title: Erk Tripwires\n     3→read_when:\n     4→  - \"working on erk code\"\n     5→---\n     6→\n     7→<!-- AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY -->\n     8→<!-- Edit source frontmatter, then run 'erk docs sync' to regenerate. -->\n     9→<!-- Generated from erk/*.md frontmatter -->\n    10→\n    11→# Erk Tripwires\n    12→\n    13→Rules triggered by matching actions in code.\n    14→\n    15→**adding a new step to the bootstrap sequence** → Read [Codespace Remote Execution Pattern](codespace-remote-execution.md) first. This affects ALL remote commands. The bootstrap runs on every SSH invocation, so added steps must be idempotent and fast.\n    16→\n    17→**checking thread count without comparing to dash count** → Read [PR Feedback Classifier Schema](pr-feedback-classifier-schema.md) first. Thread count in classifier output must equal erk dash count. Missing threads are silently dropped.\n    18→\n    19→**constructing a checkout footer string manually** → Read [PR Checkout Footer Validation Pattern](pr-commands.md) first. Use build_pr_body_footer() from the gateway layer. Manual construction risks format drift from the validator regex.\n    20→\n    21→**constructing branch names manually** → Read [Branch Naming Conventions](branch-naming.md) first. Use generate_issue_branch_name() for consistent objective ID encoding.\n    22→\n    23→**creating a placeholder branch with ctx.branch_manager.create_branch()** → Read [Placeholder Branches](placeholder-branches.md) first. Placeholder branches must bypass BranchManager. Use ctx.git.branch.create_branch() to avoid Graphite tracking. See branch-manager-decision-tree.md for the full decision framework.\n    24→\n    25→**deleting a placeholder branch with ctx.branch_manager.delete_branch()** → Read [Placeholder Branches](placeholder-branches.md) first. Placeholder branch deletion must also bypass BranchManager. Use ctx.git.branch.delete_branch() directly.\n    26→\n    27→**duplicating git pull / uv sync / venv activation in a codespace command** → Read [Codespace Remote Execution Pattern](codespace-remote-execution.md) first. Use build_codespace_ssh_command() — bootstrap logic is centralized there. See composable-remote-commands.md for the five-step pattern.\n    28→\n    29→**editing .claude/ markdown without running prettier** → Read [PR Feedback Classifier Schema](pr-feedback-classifier-schema.md) first. Run `prettier --write <file>` immediately after editing .claude/ markdown. `make fast-ci` fails otherwise.\n    30→\n    31→**embedding single quotes in a remote erk command argument** → Read [Codespace Remote Execution Pattern](codespace-remote-execution.md) first. The bootstrap wraps the entire command in single quotes. Single quotes in arguments will break the shell string.\n    32→\n    33→**pushing to a branch that may have been updated remotely without checking for divergence** → Read [Graphite Divergence Detection](graphite-divergence-detection.md) first. The Graphite-first flow pre-checks for divergence before gt submit. Check with branch_exists_on_remote -> fetch_branch -> is_branch_diverged_from_remote.\n    34→\n    35→**removing the uv pip install --no-deps line from activation** → Read [Workspace Activation and Package Refresh](workspace-activation.md) first. This line refreshes workspace editable packages on every activation. Without it, worktrees may use stale versions of erk, erk-shared, or erk-statusline after switching branches.\n    36→\n    37→**resolving a review thread when the comment is a discussion comment (not a review thread)** → Read [PR Address Workflows](pr-address-workflows.md) first. Review threads and discussion comments use different GitHub APIs. resolve-review-threads only handles review threads. Discussion comments are resolved differently (or not at all).\n    38→\n    39→**running gt commands without --no-interactive** → Read [Graphite Divergence Detection](graphite-divergence-detection.md) first. All gt commands MUST use --no-interactive. Without it, gt may prompt for input and hang indefinitely.\n    40→\n    41→**running gt sync without verifying clean working tree** → Read [Graphite Stack Troubleshooting](graphite-stack-troubleshooting.md) first. gt sync performs a rebase that can lose uncommitted changes. Commit or stash first. See docs/learned/workflows/git-sync-state-preservation.md\n    42→\n    43→**treating informational_count as including review threads** → Read [PR Feedback Classifier Schema](pr-feedback-classifier-schema.md) first. informational_count covers ONLY discussion comments, not review threads. All unresolved review threads must appear individually in actionable_threads.\n    44→\n    45→**using `gh codespace create` to create a codespace** → Read [Codespace Machine Types](codespace-machine-types.md) first. The machines endpoint returns HTTP 500 for this repo. Use `POST /user/codespaces` REST API directly. See the workaround section below.\n    46→\n    47→**using issue number in checkout footer instead of PR number** → Read [PR Checkout Footer Validation Pattern](pr-commands.md) first. Checkout footer requires the PR number (from gh pr create output), NOT the plan issue number from .impl/issue.json.\n    48→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"78698df8-d9ce-4b6a-9f2c-89d9f1c5056b","timestamp":"2026-02-21T23:14:19.408Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/docs/learned/erk/tripwires.md","content":"---\ntitle: Erk Tripwires\nread_when:\n  - \"working on erk code\"\n---\n\n<!-- AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY -->\n<!-- Edit source frontmatter, then run 'erk docs sync' to regenerate. -->\n<!-- Generated from erk/*.md frontmatter -->\n\n# Erk Tripwires\n\nRules triggered by matching actions in code.\n\n**adding a new step to the bootstrap sequence** → Read [Codespace Remote Execution Pattern](codespace-remote-execution.md) first. This affects ALL remote commands. The bootstrap runs on every SSH invocation, so added steps must be idempotent and fast.\n\n**checking thread count without comparing to dash count** → Read [PR Feedback Classifier Schema](pr-feedback-classifier-schema.md) first. Thread count in classifier output must equal erk dash count. Missing threads are silently dropped.\n\n**constructing a checkout footer string manually** → Read [PR Checkout Footer Validation Pattern](pr-commands.md) first. Use build_pr_body_footer() from the gateway layer. Manual construction risks format drift from the validator regex.\n\n**constructing branch names manually** → Read [Branch Naming Conventions](branch-naming.md) first. Use generate_issue_branch_name() for consistent objective ID encoding.\n\n**creating a placeholder branch with ctx.branch_manager.create_branch()** → Read [Placeholder Branches](placeholder-branches.md) first. Placeholder branches must bypass BranchManager. Use ctx.git.branch.create_branch() to avoid Graphite tracking. See branch-manager-decision-tree.md for the full decision framework.\n\n**deleting a placeholder branch with ctx.branch_manager.delete_branch()** → Read [Placeholder Branches](placeholder-branches.md) first. Placeholder branch deletion must also bypass BranchManager. Use ctx.git.branch.delete_branch() directly.\n\n**duplicating git pull / uv sync / venv activation in a codespace command** → Read [Codespace Remote Execution Pattern](codespace-remote-execution.md) first. Use build_codespace_ssh_command() — bootstrap logic is centralized there. See composable-remote-commands.md for the five-step pattern.\n\n**editing .claude/ markdown without running prettier** → Read [PR Feedback Classifier Schema](pr-feedback-classifier-schema.md) first. Run `prettier --write <file>` immediately after editing .claude/ markdown. `make fast-ci` fails otherwise.\n\n**embedding single quotes in a remote erk command argument** → Read [Codespace Remote Execution Pattern](codespace-remote-execution.md) first. The bootstrap wraps the entire command in single quotes. Single quotes in arguments will break the shell string.\n\n**pushing to a branch that may have been updated remotely without checking for divergence** → Read [Graphite Divergence Detection](graphite-divergence-detection.md) first. The Graphite-first flow pre-checks for divergence before gt submit. Check with branch_exists_on_remote -> fetch_branch -> is_branch_diverged_from_remote.\n\n**removing the uv pip install --no-deps line from activation** → Read [Workspace Activation and Package Refresh](workspace-activation.md) first. This line refreshes workspace editable packages on every activation. Without it, worktrees may use stale versions of erk, erk-shared, or erk-statusline after switching branches.\n\n**resolving a review thread when the comment is a discussion comment (not a review thread)** → Read [PR Address Workflows](pr-address-workflows.md) first. Review threads and discussion comments use different GitHub APIs. resolve-review-threads only handles review threads. Discussion comments are resolved differently (or not at all).\n\n**running gt commands without --no-interactive** → Read [Graphite Divergence Detection](graphite-divergence-detection.md) first. All gt commands MUST use --no-interactive. Without it, gt may prompt for input and hang indefinitely.\n\n**running gt sync without verifying clean working tree** → Read [Graphite Stack Troubleshooting](graphite-stack-troubleshooting.md) first. gt sync performs a rebase that can lose uncommitted changes. Commit or stash first. See docs/learned/workflows/git-sync-state-preservation.md\n\n**treating informational_count as including review threads** → Read [PR Feedback Classifier Schema](pr-feedback-classifier-schema.md) first. informational_count covers ONLY discussion comments, not review threads. All unresolved review threads must appear individually in actionable_threads.\n\n**using `gh codespace create` to create a codespace** → Read [Codespace Machine Types](codespace-machine-types.md) first. The machines endpoint returns HTTP 500 for this repo. Use `POST /user/codespaces` REST API directly. See the workaround section below.\n\n**using issue number in checkout footer instead of PR number** → Read [PR Checkout Footer Validation Pattern](pr-commands.md) first. Checkout footer requires the PR number (from gh pr create output), NOT the plan issue number from .impl/issue.json.\n","numLines":48,"startLine":1,"totalLines":48}}}
{"parentUuid":"78698df8-d9ce-4b6a-9f2c-89d9f1c5056b","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01F4m5FsUAGcGfAeXF2LH7cY","type":"tool_result","content":"     1→---\n     2→title: Architecture Tripwires\n     3→read_when:\n     4→  - \"working on architecture code\"\n     5→---\n     6→\n     7→<!-- AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY -->\n     8→<!-- Edit source frontmatter, then run 'erk docs sync' to regenerate. -->\n     9→<!-- Generated from architecture/*.md frontmatter -->\n    10→\n    11→# Architecture Tripwires\n    12→\n    13→Rules triggered by matching actions in code.\n    14→\n    15→**FakePromptExecutor tracks all calls via properties** → Read [Prompt Executor Gateway](prompt-executor-gateway.md) first. use .prompt_calls, .interactive_calls, .passthrough_calls for assertions\n    16→\n    17→**accessing ctx.obj directly without a require\\_\\*() helper** → Read [Click Context Dependency Injection Pattern](click-context-di-pattern.md) first. Use typed require\\_\\*() helpers (require_issues, require_git, require_cwd, etc.) instead of direct ctx.obj access. Helpers provide type narrowing and clear error messages.\n    18→\n    19→**accessing plan_ref.plan_id as int without checking** → Read [PlanRef Architecture](plan-ref-architecture.md) first. plan_id is a string. Use LBYL: `plan_ref.plan_id.isdigit()` before `int(plan_ref.plan_id)`. Supports future non-numeric providers like 'PROJ-123'.\n    20→\n    21→**accessing properties on a discriminated union result without isinstance() check** → Read [Discriminated Union Error Handling](discriminated-union-error-handling.md) first. Always check isinstance(result, ErrorType) before accessing success-variant properties. Without type narrowing, you may access .message on a success type or .data on an error type.\n    22→\n    23→**adding Closes #N for draft-PR backend** → Read [PR Body Assembly](pr-body-assembly.md) first. Set issue_number=None for draft-PR backend. The draft PR IS the plan — Closes #N would be self-referential.\n    24→\n    25→**adding HTML, badges, or GitHub-specific markup to commit messages** → Read [PR Body Formatting Pattern](pr-body-formatting.md) first. Use the two-target pattern: plain text pr_body for commits, enhanced pr_body_for_github for the PR. Never put GitHub-specific HTML into git commit messages.\n    26→\n    27→**adding a Claude subprocess call with --print mode** → Read [Subprocess Wrappers](subprocess-wrappers.md) first. Always include --no-session-persistence flag and use env=build_claude_subprocess_env() parameter. Both are required to prevent session persistence and CLAUDECODE context leakage. See the 'Claude Subprocess Environment' section.\n    28→\n    29→**adding a new field to ErkContext dataclass** → Read [Erk Architecture Patterns](erk-architecture.md) first. Update ALL factory functions. Grep: `grep -r 'ErkContext(' packages/erk-shared/src/ src/erk/core/context.py` to find all construction sites. Missing a factory causes runtime errors or silent None values.\n    30→\n    31→**adding a new field to agent-produced JSON without updating normalization** → Read [Agent Schema Enforcement](agent-schema-enforcement.md) first. Add the field to CANONICAL_FIELDS and any aliases to FIELD_ALIASES in the normalization script. Without this, the field may be stripped during normalization.\n    32→\n    33→**adding a new method to Git ABC** → Read [Gateway ABC Implementation Checklist](gateway-abc-implementation.md) first. Must implement in 5 places: abc.py, real.py, fake.py, dry_run.py, printing.py.\n    34→\n    35→**adding a new method to GitHub ABC** → Read [Gateway ABC Implementation Checklist](gateway-abc-implementation.md) first. Must implement in 5 places: abc.py, real.py, fake.py, dry_run.py, printing.py.\n    36→\n    37→**adding a new method to Graphite ABC** → Read [Gateway ABC Implementation Checklist](gateway-abc-implementation.md) first. Must implement in 5 places: abc.py, real.py, fake.py, dry_run.py, printing.py.\n    38→\n    39→**adding a parameter to an erk exec script without updating the calling slash command** → Read [Parameter Threading Pattern](parameter-threading-pattern.md) first. 3-layer parameter threading: When adding a parameter, update all three layers: skill SKILL.md argument-hint, slash command .md, and erk exec script. Verify all invocations thread the parameter through.\n    40→\n    41→**adding a subgateway property to a gateway ABC** → Read [Flatten Subgateway Pattern](flatten-subgateway-pattern.md) first. Must implement property in 5 places: ABC with TYPE_CHECKING import guard, Real with concrete instance, Fake with linked state, DryRun wrapping inner subgateway, Printing wrapping with script_mode/dry_run.\n    42→\n    43→**adding file I/O, network calls, or subprocess invocations to a class **init\\***\\* → Read [Erk Architecture Patterns](erk-architecture.md) first. Load `dignified-python` skill first. Class **init\\*\\* should be lightweight (just data assignment). Heavy operations belong in static factory methods like `from_config_path()` or `load()`. This enables direct instantiation in tests without I/O setup.\n    44→\n    45→**adding new file format support without read-then-fallback** → Read [Erk Architecture Patterns](erk-architecture.md) first. When adding new file formats, implement read-then-fallback: try new format first, fall back to old format transparently. See read_plan_ref() for the canonical pattern.\n    46→\n    47→**adding optional fields to pipeline state without defaults** → Read [State Threading Pattern](state-threading-pattern.md) first. New pipeline state fields must have defaults (usually None) to avoid breaking make_initial_state() factories. See optional-field-propagation.md for the pattern.\n    48→\n    49→**adding re-exports to gateway implementation modules** → Read [Re-Export Pattern](re-export-pattern.md) first. Only re-export types that genuinely improve public API. Add # noqa: F401 - re-exported for <reason> comment.\n    50→\n    51→**adding regex validation inline instead of module-level compilation** → Read [Validation Patterns](validation-patterns.md) first. Compile regex patterns at module level as named constants. See LAST_AUDITED_PATTERN in operations.py:30 for the canonical example.\n    52→\n    53→**adding subprocess.run or run_subprocess_with_context calls to a gateway real.py file** [pattern: `subprocess\\.run\\(|run_subprocess_with_context\\(`] → Read [Gateway ABC Implementation Checklist](gateway-abc-implementation.md) first. Must add integration tests in tests/integration/test*real*\\*.py. Real gateway methods with subprocess calls need tests that verify the actual subprocess behavior.\n    54→\n    55→**amending a commit when Graphite is enabled** → Read [Git and Graphite Edge Cases Catalog](git-graphite-quirks.md) first. After amending commits or running gt restack, Graphite's cache may not update, leaving branches diverged. Call retrack_branch() to fix tracking. The auto-fix is already implemented in sync_cmd and branch_manager.\n    56→\n    57→**archiving value to 'last\\_' variant BEFORE clearing** → Read [Archive-on-Clear Metadata Pattern](metadata-archival-pattern.md) first. Order matters — clear-then-archive loses the value silently\n    58→\n    59→**assuming GitHub API failures are transient without repository-specific testing** → Read [GitHub API Diagnostics](github-api-diagnostics.md) first. Test with a control repository first. Some GitHub bugs affect specific repos but not others. Follow the 3-step diagnostic methodology.\n    60→\n    61→**assuming cursor position will persist across DataTable.clear() calls** → Read [Selection Preservation by Value](selection-preservation-by-value.md) first. Save cursor position by row key before clear(), restore after repopulating. See textual/quirks.md for pattern.\n    62→\n    63→**calling GraphiteBranchManager.create_branch() without explicit checkout** → Read [Erk Architecture Patterns](erk-architecture.md) first. GraphiteBranchManager.create_branch() restores the original branch after tracking. Always call branch_manager.checkout_branch() afterward if you need to be on the new branch.\n    64→\n    65→**calling assemble_pr_body without metadata_prefix for draft-PR plans** → Read [PR Body Assembly](pr-body-assembly.md) first. Draft-PR plans require metadata_prefix from extract_metadata_prefix(). Without it, plan-header metadata is lost on every PR rewrite.\n    66→\n    67→**calling checkout_branch() in a multi-worktree repository** → Read [Multi-Worktree State Handling](multi-worktree-state.md) first. Verify the target branch is not already checked out in another worktree using `git.worktree.find_worktree_for_branch()`. Git enforces a single-checkout constraint - attempting to checkout a branch held elsewhere causes silent state corruption or unexpected failures.\n    68→\n    69→**calling create_branch() and assuming you're on the new branch** → Read [BranchManager Abstraction](branch-manager-abstraction.md) first. GraphiteBranchManager.create_branch() restores the original branch after Graphite tracking. Always call branch_manager.checkout_branch() afterward if you need to be on the new branch.\n    70→\n    71→**calling ctx.git mutation methods (create_branch, delete_branch, checkout_branch, checkout_detached, create_tracking_branch)** → Read [Erk Architecture Patterns](erk-architecture.md) first. Use ctx.branch_manager instead. Branch mutation methods are in GitBranchOps sub-gateway, accessible only through BranchManager. Query methods (get_current_branch, list_local_branches, etc.) remain on ctx.git.\n    72→\n    73→**calling ctx.git.branch mutation methods directly (create_branch, delete_branch, checkout_branch, checkout_detached, create_tracking_branch)** → Read [BranchManager Abstraction](branch-manager-abstraction.md) first. Use ctx.branch_manager instead for all user-facing branches. Only use ctx.git.branch directly for ephemeral/placeholder branches that should never be Graphite-tracked. See branch-manager-decision-tree.md.\n    74→\n    75→**calling ctx.graphite mutation methods (track_branch, delete_branch, submit_branch)** → Read [Erk Architecture Patterns](erk-architecture.md) first. Use ctx.branch_manager instead. Branch mutation methods are in GraphiteBranchOps sub-gateway, accessible only through BranchManager. Query methods (is_branch_tracked, get_parent_branch, etc.) remain on ctx.graphite.\n    76→\n    77→**calling ctx.graphite_branch_ops mutation methods directly (track_branch, delete_branch, submit_branch)** → Read [BranchManager Abstraction](branch-manager-abstraction.md) first. Use ctx.branch_manager instead. GraphiteBranchOps is a sub-gateway that BranchManager delegates to internally. Direct calls bypass the dual-mode abstraction.\n    78→\n    79→**calling delete_branch() without passing the force parameter through** → Read [BranchManager Abstraction](branch-manager-abstraction.md) first. The force flag controls -D (force) vs -d (safe) git delete. Dropping it silently changes behavior. Always flow force=force through all layers.\n    80→\n    81→**calling execute_gh_command() instead of execute_gh_command_with_retry() for network-sensitive operations** → Read [GitHub API Retry Mechanism](github-api-retry-mechanism.md) first. Use `execute_gh_command_with_retry()` for operations that may fail due to transient network errors. Pass `time_impl` for testability.\n    82→\n    83→**calling get_X() and handling IssueNotFound sentinel inline** → Read [LBYL Gateway Pattern](lbyl-gateway-pattern.md) first. Check with X_exists() first for cleaner error messages and LBYL compliance.\n    84→\n    85→**calling gh api directly in an exec script for plan metadata updates** → Read [PlanBackend Migration Pattern](plan-backend-migration.md) first. Use `require_plan_backend(ctx)` + backend methods instead. Direct gh calls bypass the abstraction and testability layers.\n    86→\n    87→**calling graphite.track_branch() with a remote ref like origin/main** → Read [Git and Graphite Edge Cases Catalog](git-graphite-quirks.md) first. Graphite's `gt track` only accepts local branch names, not remote refs. Use BranchManager.create_branch() which normalizes refs automatically, or strip `origin/` prefix before calling track_branch().\n    88→\n    89→**calling gt commands without --no-interactive flag** [pattern: `\\bgt\\s+(sync|submit|restack|create|modify)`] → Read [Git and Graphite Edge Cases Catalog](git-graphite-quirks.md) first. Always use `--no-interactive` with gt commands (gt sync, gt submit, gt restack, etc.). Without this flag, gt may prompt for user input and hang indefinitely. Note: `--force` does NOT prevent prompts - you must use `--no-interactive` separately.\n    90→\n    91→**calling os.chdir() in erk code** [pattern: `os\\.chdir\\(`] → Read [Erk Architecture Patterns](erk-architecture.md) first. After os.chdir(), regenerate context using regenerate_context(ctx). Stale ctx.cwd causes FileNotFoundError.\n    92→\n    93→**calling save_plan_ref with positional arguments** → Read [PlanRef Architecture](plan-ref-architecture.md) first. All parameters after `impl_dir` are keyword-only. Positional calls will fail at runtime.\n    94→\n    95→**changing a gateway method signature** → Read [Gateway Signature Migration](gateway-signature-migration.md) first. Search for ALL callers with grep before changing. PR #6329 migrated 8 call sites across 7 files. Missing a call site causes runtime errors.\n    96→\n    97→**changing config section names ([interactive-claude] or [interactive-agent])** → Read [Interactive Agent Configuration](interactive-agent-config.md) first. Maintain fallback from [interactive-agent] to [interactive-claude] for backward compatibility.\n    98→\n    99→**changing erk_shared function signatures** → Read [Gateway Signature Migration](gateway-signature-migration.md) first. Grep all callers across full repo before committing. Missed call sites cause CI failures.\n   100→\n   101→**changing gateway return type to discriminated union** → Read [Gateway ABC Implementation Checklist](gateway-abc-implementation.md) first. Verify all 5 implementations import the new types. Missing imports in abc.py, fake.py, dry_run.py, or printing.py break the gateway pattern.\n   102→\n   103→**changing permission_mode_to_claude() (or future permission_mode_to_codex()) implementations** → Read [PermissionMode Abstraction](permission-modes.md) first. Verify both Claude and Codex backend implementations maintain identical enum-to-mode mappings.\n   104→\n   105→**checking if get_pr_for_branch() returned a PR** [pattern: `get_pr_for_branch\\(`] → Read [Not-Found Sentinel Pattern](not-found-sentinel.md) first. Use `isinstance(pr, PRNotFound)` not `pr is not None`. PRNotFound is a sentinel object, not None.\n   106→\n   107→**checking isinstance after RetriesExhausted without type narrowing** → Read [GitHub API Retry Mechanism](github-api-retry-mechanism.md) first. After checking `isinstance(result, RetriesExhausted)`, the else branch is type-narrowed to the success type. Use `assert isinstance(result, T)` if needed for clarity.\n   108→\n   109→**checking isinstance(ctx.graphite, GraphiteDisabled) inline in command code** [pattern: `isinstance\\(.*GraphiteDisabled\\)`] → Read [Erk Architecture Patterns](erk-architecture.md) first. Use BranchManager abstraction instead. Add a method to BranchManager ABC that handles both Graphite and Git paths. This centralizes the branching logic and enables testing with FakeBranchManager.\n   110→\n   111→**checking out a branch in plan_save without restoring the original** → Read [Plan Save Branch Restoration](plan-save-branch-restoration.md) first. Plan save must always restore the original branch via try/finally. See plan-save-branch-restoration.md.\n   112→\n   113→**choosing between exceptions and discriminated unions for operation failures** → Read [Discriminated Union Error Handling](discriminated-union-error-handling.md) first. If callers branch on the error and continue the operation, use discriminated unions. If all callers just terminate and surface the message, use exceptions. Read the 'When to Use' section.\n   114→\n   115→**choosing between post_event and update_metadata** → Read [PlanBackend Migration Pattern](plan-backend-migration.md) first. post_event = metadata update + optional comment. update_metadata = metadata only. Use post_event when the operation should be visible to users in the issue timeline.\n   116→\n   117→**comparing git SHA to Graphite's tracked SHA for divergence detection** → Read [Git and Graphite Edge Cases Catalog](git-graphite-quirks.md) first. Ensure both `commit_sha` and `graphite_tracked_sha` are non-None before comparison. Returning False when either is None avoids false negatives on new branches.\n   118→\n   119→**comparing worktree path to repo_root to detect root worktree** → Read [Erk Architecture Patterns](erk-architecture.md) first. Use WorktreeInfo.is_root instead of path comparison. Path comparison fails when running from within a non-root worktree because ctx.cwd resolves differently.\n   120→\n   121→**constructing gist raw URLs with hardcoded filenames** → Read [GitHub Gist URL Patterns](github-gist-api.md) first. Use /raw/ without filename - GitHub redirects to first file.\n   122→\n   123→**creating Protocol with bare attributes for frozen dataclasses** → Read [Protocol vs ABC Interface Design Guide](protocol-vs-abc.md) first. Use @property decorators in Protocol for frozen dataclass compatibility. Bare attributes cause type errors.\n   124→\n   125→**creating a new ABC without deciding gateway vs backend pattern** → Read [Gateway vs Backend ABC Pattern](gateway-vs-backend.md) first. Read gateway-vs-backend.md first. Gateways wrap external tools (5-place: abc, real, fake, dry_run, printing). Backends abstract business logic (3-place: abc, real, fake). Wrong choice creates unnecessary boilerplate or missing test support.\n   126→\n   127→**creating a new complex command with multiple validation steps** → Read [Linear Pipeline Architecture](linear-pipelines.md) first. Consider two-pipeline pattern: validation pipeline (check preconditions) + execution pipeline (perform operations). Use discriminated unions (State | Error) for pipeline steps. Reference land_pipeline.py as exemplar.\n   128→\n   129→**creating branches in erk code** → Read [Branch Manager Decision Tree](branch-manager-decision-tree.md) first. Use the decision tree to determine whether to use ctx.branch_manager (with Graphite tracking) or ctx.git.branch (low-level git). Placeholder/ephemeral branches bypass branch_manager.\n   130→\n   131→**creating custom FakeGitHubIssues without passing to test context builder** → Read [Test Context Composition](test-context-composition.md) first. Always pass issues=issues to build_workspace_test_context when using custom FakeGitHubIssues. Without it, plan_backend operates on a different instance and metadata writes are invisible.\n   132→\n   133→**creating fake subgateway without shared state** → Read [Flatten Subgateway Pattern](flatten-subgateway-pattern.md) first. Fake subgateways must share state containers with parent via constructor parameters and call link_mutation_tracking(). Without this, mutations through subgateway won't be visible to parent queries.\n   134→\n   135→**deleting a gateway after consolidating into another** → Read [Gateway Removal Pattern](gateway-removal-pattern.md) first. Follow complete removal checklist: verify no references, delete all 5 layers, clean up compositions, update docs, run full test suite.\n   136→\n   137→**designing a new hook or reminder system** → Read [Context Injection Architecture](context-injection-tiers.md) first. Consider the three-tier context architecture and consolidation patterns. Read docs/learned/architecture/context-injection-tiers.md first.\n   138→\n   139→**designing error handling for a new gateway method** → Read [Gateway ABC Implementation Checklist](gateway-abc-implementation.md) first. Ask: does the caller continue after the failure? If yes, use discriminated union. If all callers terminate, use exceptions. See 'Non-Ideal State Decision Checklist' section.\n   140→\n   141→**detecting current worktree using path comparisons on cwd** → Read [Erk Architecture Patterns](erk-architecture.md) first. Use git.get_repository_root(cwd) to get the worktree root, then match exactly against known paths. Path comparisons with .exists()/.resolve()/is_relative_to() are fragile.\n   142→\n   143→**detecting mode after Phase 0 has already executed** → Read [Phase 0 Detection Pattern](phase-zero-detection-pattern.md) first. Late detection wastes work and creates scattered conditionals across all phases\n   144→\n   145→**duplicating environment setup in remote commands** → Read [Composable Remote Commands Pattern](composable-remote-commands.md) first. build_codespace_ssh_command() bootstraps the environment - don't duplicate setup\n   146→\n   147→**editing local plan files without syncing to GitHub** → Read [Plan File Sync Pattern](plan-file-sync-pattern.md) first. Sync is NOT automatic — GitHub issue will show stale content without explicit sync\n   148→\n   149→**execute_interactive() never returns in production** → Read [Prompt Executor Gateway](prompt-executor-gateway.md) first. it replaces the process via os.execvp\n   150→\n   151→**execute_prompt() supports both single-shot and streaming modes** → Read [Prompt Executor Gateway](prompt-executor-gateway.md) first. choose based on whether you need real-time updates\n   152→\n   153→**executing remote commands without calling start_codespace()** → Read [Composable Remote Commands Pattern](composable-remote-commands.md) first. Always start_codespace() before executing remote commands\n   154→\n   155→**expecting status to auto-update after manual PR edits** → Read [Roadmap Mutation Semantics](roadmap-mutation-semantics.md) first. Only the update-objective-node command writes computed status. Manual GitHub edits or direct body mutations leave status at its current value — you must explicitly set status to '-' to enable inference on next parse.\n   156→\n   157→**hand-constructing frozen dataclass instances with selective field copying** → Read [Optional Field Propagation](optional-field-propagation.md) first. Always use dataclasses.replace() to preserve all fields. Hand-construction with partial field copying silently drops optional fields (learn_status, learn_plan_issue, objective_issue, etc.).\n   158→\n   159→**implementing CLI flags that affect post-mutation behavior** → Read [Erk Architecture Patterns](erk-architecture.md) first. Validate flag preconditions BEFORE any mutations. Example: `--up` in `erk land` checks for child branches before merging PR. This prevents partial state (PR merged, worktree deleted, but no valid navigation target).\n   160→\n   161→**implementing a cleanup operation that modifies metadata based on external API success** → Read [Fail-Open Pattern](fail-open-patterns.md) first. Use fail-open pattern. If critical step fails, do NOT execute dependent steps that modify persistent state.\n   162→\n   163→**implementing a new `erk pr` command** → Read [PR Body Assembly](pr-body-assembly.md) first. Compare feature parity with `submit_pipeline.py`. Check: issue discovery, closing reference preservation, learn plan labels, footer construction, and plan details section. Use shared utilities from `shared.py` (`assemble_pr_body`, `discover_issue_for_footer`).\n   164→\n   165→**implementing idempotent operations that fail on missing resources** → Read [LBYL Gateway Pattern](lbyl-gateway-pattern.md) first. Use LBYL existence check to return early, making the operation truly idempotent.\n   166→\n   167→**implementing mtime-based cache invalidation** → Read [Graphite Cache Invalidation](graphite-cache-invalidation.md) first. Use triple-check guard pattern: (cache exists) AND (mtime exists) AND (mtime matches). Partial checks cause stale data bugs.\n   168→\n   169→**importing PlanBackendType or redeclaring it in a module other than erk_shared.context.types** → Read [erk_shared Package](erk-shared-package.md) first. PlanBackendType canonical import: import PlanBackendType only from erk_shared.context.types. Do not re-declare or shadow this type in other modules — erk_shared.context.types is the single source of truth. Shadowing creates hidden divergence that breaks isinstance checks and type narrowing.\n   170→\n   171→**importing time module or calling time.sleep() or datetime.now()** [pattern: `\\bimport time\\b|time\\.sleep\\(|datetime\\.now\\(`] → Read [Erk Architecture Patterns](erk-architecture.md) first. Use context.time.sleep() and context.time.now() for testability. Direct time.sleep() makes tests slow and datetime.now() makes tests non-deterministic.\n   172→\n   173→**injecting Time dependency into gateway real.py for lock-waiting or retry logic** → Read [Erk Architecture Patterns](erk-architecture.md) first. Accept optional Time in **init** with default to RealTime(). Use injected dependency in methods. This enables testing with FakeTime without blocking. See packages/erk-shared/src/erk_shared/gateway/git/lock.py for pattern.\n   174→\n   175→**migrating a gateway method to return discriminated union** → Read [Discriminated Union Error Handling](discriminated-union-error-handling.md) first. Update ALL 5 implementations (ABC, real, fake, dry_run, printing) AND all call sites AND tests. Incomplete migrations break type safety.\n   176→\n   177→**migrating git method calls after subgateway extraction** → Read [Gateway Decomposition Phases](gateway-decomposition-phases.md) first. The following methods have been moved from the Git ABC to subgateways: `git.fetch_branch()` → `git.remote.fetch_branch()` (Phase 3), `git.push_to_remote()` → `git.remote.push_to_remote()` (Phase 3), `git.commit()` → `git.commit.commit()` (Phase 4), `git.stage_files()` → `git.commit.stage_files()` (Phase 4), `git.has_staged_changes()` → `git.status.has_staged_changes()` (Phase 5), `git.rebase_onto()` → `git.rebase.rebase_onto()` (Phase 6), `git.tag_exists()` → `git.tag_exists()` (Phase 7), `git.create_tag()` → `git.tag.create_tag()` (Phase 7). Calling the old API will raise `AttributeError`. Always use the subgateway property.\n   178→\n   179→**mixing discriminated unions with exception-based cleanup in a single method** → Read [Mixed Exception/Union Pattern (Deprecated)](gateway-specific-patterns.md) first. This pattern was tried in PR #6347 and reverted in PR #6375. Message-only discriminated unions with no domain-meaningful variants add complexity without value. Use exceptions for all error cases, or use discriminated unions with meaningful variants throughout. Document why in the PR.\n   180→\n   181→**modifying Claude CLI error reporting or PromptResult.error format** → Read [Claude CLI Error Reporting](claude-cli-error-reporting.md) first. Error messages must maintain structured format with exit code, stderr, and context. Changes affect all callers of execute_prompt() and execute_command_streaming().\n   182→\n   183→**modifying InteractiveAgentConfig fields or config file format** → Read [Interactive Agent Configuration](interactive-agent-config.md) first. Update both config loading (RealErkInstallation.load_config) and usage sites. Check backward compatibility with [interactive-claude] section.\n   184→\n   185→**modifying PR footer format** → Read [PR Footer Format Validation](pr-footer-validation.md) first. Update generator, parser, AND validator in sync. Add support for new format BEFORE deprecating old format. Never break parsing of existing PRs.\n   186→\n   187→**modifying PermissionMode enum or permission mode mappings** → Read [PermissionMode Abstraction](permission-modes.md) first. permission_mode_to_claude() (and future permission_mode_to_codex()) must stay in sync. Update both when changing mappings.\n   188→\n   189→**modifying render_metadata_block() or parse_metadata_block_body()** → Read [Metadata Blocks Reference](metadata-blocks.md) first. Both metadata/core.py AND metadata_blocks.py contain identical implementations. Tests import from metadata_blocks.py. Changes to one must be mirrored in the other, or behavior diverges silently.\n   190→\n   191→**mutating pipeline state directly instead of using dataclasses.replace()** → Read [State Threading Pattern](state-threading-pattern.md) first. Pipeline state must be frozen. Use dataclasses.replace() to create new state at each step.\n   192→\n   193→**parsing CalledProcessError messages for git operations** → Read [Git Operation Patterns](git-operation-patterns.md) first. Avoid parsing git error messages to determine failure modes. Use LBYL with git show-ref --verify to check existence before operations, or design discriminated unions that handle all returncode cases explicitly.\n   194→\n   195→**passing array or object variables to gh api graphql with -F and json.dumps()** [pattern: `json\\.dumps\\(.*-F`] → Read [GitHub GraphQL API Patterns](github-graphql.md) first. Arrays and objects require special gh syntax: arrays use -f key[]=value1 -f key[]=value2, objects use -f key[subkey]=value. Using -F key=[...] or -F key={...} passes them as literal strings, not typed values.\n   196→\n   197→**passing dry_run boolean flags through business logic function parameters** → Read [Erk Architecture Patterns](erk-architecture.md) first. Use dependency injection with DryRunGit/DryRunGitHub wrappers for multi-step workflows. Simple CLI preview flags at the command level are acceptable for single-action commands.\n   198→\n   199→**passing secret values as command-line arguments** → Read [GitHub Admin Gateway](github-admin-gateway.md) first. Secret values must be passed via stdin (input= parameter) to avoid process list exposure. See github-admin-gateway.md.\n   200→\n   201→**passing variables to gh api graphql as JSON blob** [pattern: `gh\\s+api\\s+graphql`] → Read [GitHub GraphQL API Patterns](github-graphql.md) first. Variables must be passed individually with -f (strings) and -F (typed). The syntax `-f variables={...}` does NOT work.\n   202→\n   203→**reading agent output with TaskOutput then writing it to a file with Write** → Read [Context Efficiency Patterns](context-efficiency.md) first. This is the 'content relay' anti-pattern — it causes 2x context duplication. Instead, have agents accept an output_path parameter and write directly. See /erk:learn for the canonical implementation.\n   204→\n   205→**reading from or writing to ~/.claude/ paths using Path.home() directly** [pattern: `Path\\.home\\(\\).*\\.claude`] → Read [ClaudeInstallation Gateway](claude-installation-gateway.md) first. Use ClaudeInstallation gateway instead. All ~/.claude/ filesystem operations must go through this gateway for testability and storage abstraction.\n   206→\n   207→**relying solely on agent-level enforcement for critical rules** → Read [Defense-in-Depth Enforcement](defense-in-depth-enforcement.md) first. Add skill-level and PR-level enforcement layers. Only workflow/CI enforcement is truly reliable.\n   208→\n   209→**removing an abstract method from a gateway ABC** → Read [Gateway ABC Implementation Checklist](gateway-abc-implementation.md) first. Must remove from 5 places simultaneously: abc.py, real.py, fake.py, dry_run.py, printing.py. Partial removal causes type checker errors. Update all call sites to use subgateway property. Verify with grep across packages.\n   210→\n   211→**returning pre-rendered display strings from backend APIs** → Read [State Derivation Pattern](state-derivation-pattern.md) first. Return raw state fields instead. Derive display state in frontend pure functions for testability and reusability.\n   212→\n   213→**running tests immediately after rebase without checking for old symbols** → Read [Rebase Conflict Patterns](rebase-conflict-patterns.md) first. Hidden regressions can exist in non-conflicted files. Grep for old symbols that should have been renamed before running tests.\n   214→\n   215→**running tsc --noEmit from root in multi-config TypeScript project** → Read [TypeScript Multi-Config Project Checking](typescript-multi-config.md) first. tsc --noEmit from root breaks subdirectory configs. Use tsc -p <path> --noEmit for each tsconfig.json separately.\n   216→\n   217→**setting PR reference without providing --plan** → Read [Roadmap Mutation Semantics](roadmap-mutation-semantics.md) first. The CLI requires --plan when --pr is set (error: plan_required_with_pr). Use --plan '#NNN' to preserve or --plan '' to explicitly clear. Read roadmap-mutation-semantics.md for the None/empty/value semantics.\n   218→\n   219→**skipping fallback strategies when the selected item might disappear** → Read [Selection Preservation by Value](selection-preservation-by-value.md) first. Always provide fallback behavior when selected item not found in refreshed data (reset to 0, preserve index clamped, or clear selection).\n   220→\n   221→**suppressing F401 (unused import) warnings** → Read [Re-Export Pattern](re-export-pattern.md) first. Use # noqa: F401 comment per-import with reason, not global ruff config. Indicates intentional re-export vs actual unused import.\n   222→\n   223→**threading state through pipeline steps with mutable dataclasses** → Read [Land State Threading Pattern](land-state-threading.md) first. Use frozen dataclasses (@dataclass(frozen=True)) for pipeline state. Update fields with dataclasses.replace() to create new instances. Immutability enables caching, testability, and replay.\n   224→\n   225→**tracking selection by array index when the array can be mutated** → Read [Selection Preservation by Value](selection-preservation-by-value.md) first. Track selection by unique identifier (issue_number, row key), not array position. Array indices become unstable when rows are added, removed, or reordered.\n   226→\n   227→**trusting agent-produced JSON without normalization** → Read [Agent Schema Enforcement](agent-schema-enforcement.md) first. Agents drift from expected schemas over time. Always normalize at the boundary before validation. See normalize_tripwire_candidates.py for the pattern.\n   228→\n   229→**try/except in fake.py or dry_run.py** [pattern: `\\btry:|\\bexcept\\s`] → Read [Gateway Error Boundaries](gateway-error-boundaries.md) first. Gateway error handling (try/except) belongs ONLY in real.py. Fake and dry-run implementations return error discriminants based on constructor params, they don't catch exceptions.\n   230→\n   231→**updating a roadmap step's PR cell** → Read [Roadmap Mutation Semantics](roadmap-mutation-semantics.md) first. The update-objective-node command computes display status from the PR value and writes it directly into the status cell. Status inference only happens during parsing when status is '-' or empty.\n   232→\n   233→**using --force-with-lease in multi-step workflows where earlier steps push** → Read [Git and Graphite Edge Cases Catalog](git-graphite-quirks.md) first. Force-push silently overwrites intermediate commits from earlier workflow steps. Always `git pull --rebase` before pushing in multi-step workflows.\n   234→\n   235→**using LiveDisplay in watch loops without try/finally blocks** → Read [LiveDisplay Gateway](live-display-gateway.md) first. guard with try/finally to ensure stop() is called even on KeyboardInterrupt\n   236→\n   237→**using PlanContextProvider** → Read [Plan Context Integration](plan-context-integration.md) first. Read this doc first. PlanContextProvider returns None on any failure (graceful degradation). Always handle the None case.\n   238→\n   239→**using `--output-format stream-json` with `--print` in Claude CLI** [pattern: `--output-format\\s+stream-json`] → Read [Claude CLI Integration from Python](claude-cli-integration.md) first. Must also include `--verbose`. Without it, the command fails with 'stream-json requires --verbose'.\n   240→\n   241→**using `gt restack` to resolve branch divergence errors** [pattern: `gt\\s+restack`] → Read [Git and Graphite Edge Cases Catalog](git-graphite-quirks.md) first. gt restack only handles parent-child stack rebasing, NOT same-branch remote divergence. Use git rebase origin/$BRANCH first.\n   242→\n   243→**using bare subprocess.run with check=True** [pattern: `subprocess\\.run\\(`] → Read [Subprocess Wrappers](subprocess-wrappers.md) first. Use wrapper functions: run_subprocess_with_context() (gateway) or run_with_error_reporting() (CLI). Exception: Graceful degradation pattern with explicit CalledProcessError handling is acceptable for optional operations.\n   244→\n   245→**using bash heredocs for large agent outputs** → Read [Heredoc Quoting and Escaping in Agent-Generated Bash](bash-python-integration.md) first. heredocs fail silently with special characters; prefer the Write tool\n   246→\n   247→**using gh api or gh api graphql to fetch or resolve PR review threads** → Read [GitHub API Rate Limits](github-api-rate-limits.md) first. Load `pr-operations` skill first. Use `erk exec get-pr-review-comments` and `erk exec resolve-review-thread` instead. Raw gh api calls miss thread resolution functionality.\n   248→\n   249→**using gh codespace start** [pattern: `gh\\s+codespace\\s+start`] → Read [GitHub CLI Limits](github-cli-limits.md) first. gh codespace start does not exist. Use REST API POST /user/codespaces/{name}/start via gh api instead.\n   250→\n   251→**using gh gist create with --filename flag** [pattern: `gh\\s+gist\\s+create.*--filename`] → Read [GitHub CLI Quirks and Edge Cases](github-cli-quirks.md) first. --filename only works with stdin input (-), not file paths.\n   252→\n   253→**using gh issue create in production code** [pattern: `gh\\s+issue\\s+create`] → Read [GitHub API Rate Limits](github-api-rate-limits.md) first. Use REST API via `gh api repos/{owner}/{repo}/issues -X POST` instead. `gh issue create` uses GraphQL which has separate (often exhausted) rate limits.\n   254→\n   255→**using gh issue edit in command documentation** [pattern: `gh\\s+issue\\s+edit`] → Read [GitHub API Rate Limits](github-api-rate-limits.md) first. Use `erk exec update-issue-body` instead. `gh issue edit` uses GraphQL which has separate (often exhausted) rate limits.\n   256→\n   257→**using gh issue view in command documentation** [pattern: `gh\\s+issue\\s+view`] → Read [GitHub API Rate Limits](github-api-rate-limits.md) first. Use `erk exec get-issue-body` instead. `gh issue view` uses GraphQL which has separate (often exhausted) rate limits.\n   258→\n   259→**using gh pr create in production code** [pattern: `gh\\s+pr\\s+create`] → Read [GitHub API Rate Limits](github-api-rate-limits.md) first. Use REST API via `gh api repos/{owner}/{repo}/pulls -X POST` instead. `gh pr create` uses GraphQL which has separate (often exhausted) rate limits.\n   260→\n   261→**using gh pr diff --name-only in production code** [pattern: `gh\\s+pr\\s+diff\\s+--name-only`] → Read [GitHub CLI Limits](github-cli-limits.md) first. For PRs with 300+ files, gh pr diff fails with HTTP 406. Use REST API with pagination instead.\n   262→\n   263→**using gh pr view --json merged** [pattern: `gh\\s+pr\\s+view.*--json.*\\bmerged\\b`] → Read [GitHub API Rate Limits](github-api-rate-limits.md) first. The `merged` field doesn't exist. Use `mergedAt` instead. Run `gh pr view --help` or check error output for valid field names.\n   264→\n   265→**using git pull or git pull --rebase on a Graphite-managed branch** [pattern: `git\\s+pull`] → Read [Git and Graphite Edge Cases Catalog](git-graphite-quirks.md) first. Use /erk:sync-divergence instead. git pull --rebase rewrites commit SHAs outside Graphite's tracking, causing stack divergence that requires manual cleanup with gt sync --restack and force-push.\n   266→\n   267→**using mutable list fields directly for mutation tracking in fakes** → Read [Fake Mutation Tracking](fake-mutation-tracking.md) first. Expose mutation tracking via @property returning tuple or .copy(). Internal lists should be private. See fake-mutation-tracking.md.\n   268→\n   269→**using os.environ.get(\"CLAUDE_CODE_SESSION_ID\") in erk code** [pattern: `os\\.environ.*CLAUDE_CODE_SESSION_ID`] → Read [Erk Architecture Patterns](erk-architecture.md) first. Erk code NEVER has access to this environment variable. Session IDs must be passed via --session-id CLI flags. Hooks receive session ID via stdin JSON, not environment variables.\n   270→\n   271→**using run_ssh_command() for interactive commands** → Read [Composable Remote Commands Pattern](composable-remote-commands.md) first. Interactive commands need exec_ssh_interactive(), not run_ssh_command()\n   272→\n   273→**using subprocess.run with git command outside of a gateway** [pattern: `subprocess\\.run\\(\\s*\\[.*[\"']git`] → Read [Gateway ABC Implementation Checklist](gateway-abc-implementation.md) first. Use the Git gateway instead. Direct subprocess calls bypass testability (fakes) and dry-run support. The Git ABC (erk_shared.gateway.git.abc.Git) likely already has a method for this operation. Only use subprocess directly in real.py gateway implementations.\n   274→\n   275→**using this pattern** → Read [SSH Command Execution Patterns](ssh-command-execution.md) first. Using run_ssh_command() for interactive TUI processes causes apparent hangs\n   276→\n   277→**using this pattern** → Read [SSH Command Execution Patterns](ssh-command-execution.md) first. SSH command must be a single string argument, not multiple shell words\n   278→\n   279→**using this pattern** → Read [SSH Command Execution Patterns](ssh-command-execution.md) first. Missing -t flag prevents TTY allocation and breaks interactive programs\n   280→\n   281→**using unquoted heredoc delimiters (<<EOF) when the body contains $, \\, or backticks** [pattern: `<<\\s*EOF\\b`] → Read [Heredoc Quoting and Escaping in Agent-Generated Bash](bash-python-integration.md) first. bash silently expands them\n   282→\n   283→**validating object fields at every callsite instead of at construction** → Read [Erk Architecture Patterns](erk-architecture.md) first. Validate at the single construction point (factory/reader function). Callers should trust returned objects without re-validation. This is the construction boundary principle.\n   284→\n   285→**writing LiveDisplay output to stdout** → Read [LiveDisplay Gateway](live-display-gateway.md) first. RealLiveDisplay writes to stderr by default (matches erk's user_output convention) — stdout is reserved for structured data\n   286→\n   287→**writing complex business logic directly in Click command functions** → Read [CLI-to-Pipeline Boundary Pattern](cli-to-pipeline-boundary.md) first. Extract to pipeline layer when command has >3 distinct steps or complex state management. CLI layer should handle: Click decorators, parameter parsing, output formatting. Pipeline layer should handle: business logic, state management, error types.\n   288→\n   289→**writing multi-phase commands without testing in --print mode** → Read [Claude CLI Execution Modes](claude-cli-execution-modes.md) first. context: fork creates true isolation in interactive mode but loads inline in --print mode. Use Task tool for guaranteed isolation in all modes.\n   290→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"6315f06f-38c2-4d6a-888d-c284f2457766","timestamp":"2026-02-21T23:14:19.519Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/docs/learned/architecture/tripwires.md","content":"---\ntitle: Architecture Tripwires\nread_when:\n  - \"working on architecture code\"\n---\n\n<!-- AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY -->\n<!-- Edit source frontmatter, then run 'erk docs sync' to regenerate. -->\n<!-- Generated from architecture/*.md frontmatter -->\n\n# Architecture Tripwires\n\nRules triggered by matching actions in code.\n\n**FakePromptExecutor tracks all calls via properties** → Read [Prompt Executor Gateway](prompt-executor-gateway.md) first. use .prompt_calls, .interactive_calls, .passthrough_calls for assertions\n\n**accessing ctx.obj directly without a require\\_\\*() helper** → Read [Click Context Dependency Injection Pattern](click-context-di-pattern.md) first. Use typed require\\_\\*() helpers (require_issues, require_git, require_cwd, etc.) instead of direct ctx.obj access. Helpers provide type narrowing and clear error messages.\n\n**accessing plan_ref.plan_id as int without checking** → Read [PlanRef Architecture](plan-ref-architecture.md) first. plan_id is a string. Use LBYL: `plan_ref.plan_id.isdigit()` before `int(plan_ref.plan_id)`. Supports future non-numeric providers like 'PROJ-123'.\n\n**accessing properties on a discriminated union result without isinstance() check** → Read [Discriminated Union Error Handling](discriminated-union-error-handling.md) first. Always check isinstance(result, ErrorType) before accessing success-variant properties. Without type narrowing, you may access .message on a success type or .data on an error type.\n\n**adding Closes #N for draft-PR backend** → Read [PR Body Assembly](pr-body-assembly.md) first. Set issue_number=None for draft-PR backend. The draft PR IS the plan — Closes #N would be self-referential.\n\n**adding HTML, badges, or GitHub-specific markup to commit messages** → Read [PR Body Formatting Pattern](pr-body-formatting.md) first. Use the two-target pattern: plain text pr_body for commits, enhanced pr_body_for_github for the PR. Never put GitHub-specific HTML into git commit messages.\n\n**adding a Claude subprocess call with --print mode** → Read [Subprocess Wrappers](subprocess-wrappers.md) first. Always include --no-session-persistence flag and use env=build_claude_subprocess_env() parameter. Both are required to prevent session persistence and CLAUDECODE context leakage. See the 'Claude Subprocess Environment' section.\n\n**adding a new field to ErkContext dataclass** → Read [Erk Architecture Patterns](erk-architecture.md) first. Update ALL factory functions. Grep: `grep -r 'ErkContext(' packages/erk-shared/src/ src/erk/core/context.py` to find all construction sites. Missing a factory causes runtime errors or silent None values.\n\n**adding a new field to agent-produced JSON without updating normalization** → Read [Agent Schema Enforcement](agent-schema-enforcement.md) first. Add the field to CANONICAL_FIELDS and any aliases to FIELD_ALIASES in the normalization script. Without this, the field may be stripped during normalization.\n\n**adding a new method to Git ABC** → Read [Gateway ABC Implementation Checklist](gateway-abc-implementation.md) first. Must implement in 5 places: abc.py, real.py, fake.py, dry_run.py, printing.py.\n\n**adding a new method to GitHub ABC** → Read [Gateway ABC Implementation Checklist](gateway-abc-implementation.md) first. Must implement in 5 places: abc.py, real.py, fake.py, dry_run.py, printing.py.\n\n**adding a new method to Graphite ABC** → Read [Gateway ABC Implementation Checklist](gateway-abc-implementation.md) first. Must implement in 5 places: abc.py, real.py, fake.py, dry_run.py, printing.py.\n\n**adding a parameter to an erk exec script without updating the calling slash command** → Read [Parameter Threading Pattern](parameter-threading-pattern.md) first. 3-layer parameter threading: When adding a parameter, update all three layers: skill SKILL.md argument-hint, slash command .md, and erk exec script. Verify all invocations thread the parameter through.\n\n**adding a subgateway property to a gateway ABC** → Read [Flatten Subgateway Pattern](flatten-subgateway-pattern.md) first. Must implement property in 5 places: ABC with TYPE_CHECKING import guard, Real with concrete instance, Fake with linked state, DryRun wrapping inner subgateway, Printing wrapping with script_mode/dry_run.\n\n**adding file I/O, network calls, or subprocess invocations to a class **init\\***\\* → Read [Erk Architecture Patterns](erk-architecture.md) first. Load `dignified-python` skill first. Class **init\\*\\* should be lightweight (just data assignment). Heavy operations belong in static factory methods like `from_config_path()` or `load()`. This enables direct instantiation in tests without I/O setup.\n\n**adding new file format support without read-then-fallback** → Read [Erk Architecture Patterns](erk-architecture.md) first. When adding new file formats, implement read-then-fallback: try new format first, fall back to old format transparently. See read_plan_ref() for the canonical pattern.\n\n**adding optional fields to pipeline state without defaults** → Read [State Threading Pattern](state-threading-pattern.md) first. New pipeline state fields must have defaults (usually None) to avoid breaking make_initial_state() factories. See optional-field-propagation.md for the pattern.\n\n**adding re-exports to gateway implementation modules** → Read [Re-Export Pattern](re-export-pattern.md) first. Only re-export types that genuinely improve public API. Add # noqa: F401 - re-exported for <reason> comment.\n\n**adding regex validation inline instead of module-level compilation** → Read [Validation Patterns](validation-patterns.md) first. Compile regex patterns at module level as named constants. See LAST_AUDITED_PATTERN in operations.py:30 for the canonical example.\n\n**adding subprocess.run or run_subprocess_with_context calls to a gateway real.py file** [pattern: `subprocess\\.run\\(|run_subprocess_with_context\\(`] → Read [Gateway ABC Implementation Checklist](gateway-abc-implementation.md) first. Must add integration tests in tests/integration/test*real*\\*.py. Real gateway methods with subprocess calls need tests that verify the actual subprocess behavior.\n\n**amending a commit when Graphite is enabled** → Read [Git and Graphite Edge Cases Catalog](git-graphite-quirks.md) first. After amending commits or running gt restack, Graphite's cache may not update, leaving branches diverged. Call retrack_branch() to fix tracking. The auto-fix is already implemented in sync_cmd and branch_manager.\n\n**archiving value to 'last\\_' variant BEFORE clearing** → Read [Archive-on-Clear Metadata Pattern](metadata-archival-pattern.md) first. Order matters — clear-then-archive loses the value silently\n\n**assuming GitHub API failures are transient without repository-specific testing** → Read [GitHub API Diagnostics](github-api-diagnostics.md) first. Test with a control repository first. Some GitHub bugs affect specific repos but not others. Follow the 3-step diagnostic methodology.\n\n**assuming cursor position will persist across DataTable.clear() calls** → Read [Selection Preservation by Value](selection-preservation-by-value.md) first. Save cursor position by row key before clear(), restore after repopulating. See textual/quirks.md for pattern.\n\n**calling GraphiteBranchManager.create_branch() without explicit checkout** → Read [Erk Architecture Patterns](erk-architecture.md) first. GraphiteBranchManager.create_branch() restores the original branch after tracking. Always call branch_manager.checkout_branch() afterward if you need to be on the new branch.\n\n**calling assemble_pr_body without metadata_prefix for draft-PR plans** → Read [PR Body Assembly](pr-body-assembly.md) first. Draft-PR plans require metadata_prefix from extract_metadata_prefix(). Without it, plan-header metadata is lost on every PR rewrite.\n\n**calling checkout_branch() in a multi-worktree repository** → Read [Multi-Worktree State Handling](multi-worktree-state.md) first. Verify the target branch is not already checked out in another worktree using `git.worktree.find_worktree_for_branch()`. Git enforces a single-checkout constraint - attempting to checkout a branch held elsewhere causes silent state corruption or unexpected failures.\n\n**calling create_branch() and assuming you're on the new branch** → Read [BranchManager Abstraction](branch-manager-abstraction.md) first. GraphiteBranchManager.create_branch() restores the original branch after Graphite tracking. Always call branch_manager.checkout_branch() afterward if you need to be on the new branch.\n\n**calling ctx.git mutation methods (create_branch, delete_branch, checkout_branch, checkout_detached, create_tracking_branch)** → Read [Erk Architecture Patterns](erk-architecture.md) first. Use ctx.branch_manager instead. Branch mutation methods are in GitBranchOps sub-gateway, accessible only through BranchManager. Query methods (get_current_branch, list_local_branches, etc.) remain on ctx.git.\n\n**calling ctx.git.branch mutation methods directly (create_branch, delete_branch, checkout_branch, checkout_detached, create_tracking_branch)** → Read [BranchManager Abstraction](branch-manager-abstraction.md) first. Use ctx.branch_manager instead for all user-facing branches. Only use ctx.git.branch directly for ephemeral/placeholder branches that should never be Graphite-tracked. See branch-manager-decision-tree.md.\n\n**calling ctx.graphite mutation methods (track_branch, delete_branch, submit_branch)** → Read [Erk Architecture Patterns](erk-architecture.md) first. Use ctx.branch_manager instead. Branch mutation methods are in GraphiteBranchOps sub-gateway, accessible only through BranchManager. Query methods (is_branch_tracked, get_parent_branch, etc.) remain on ctx.graphite.\n\n**calling ctx.graphite_branch_ops mutation methods directly (track_branch, delete_branch, submit_branch)** → Read [BranchManager Abstraction](branch-manager-abstraction.md) first. Use ctx.branch_manager instead. GraphiteBranchOps is a sub-gateway that BranchManager delegates to internally. Direct calls bypass the dual-mode abstraction.\n\n**calling delete_branch() without passing the force parameter through** → Read [BranchManager Abstraction](branch-manager-abstraction.md) first. The force flag controls -D (force) vs -d (safe) git delete. Dropping it silently changes behavior. Always flow force=force through all layers.\n\n**calling execute_gh_command() instead of execute_gh_command_with_retry() for network-sensitive operations** → Read [GitHub API Retry Mechanism](github-api-retry-mechanism.md) first. Use `execute_gh_command_with_retry()` for operations that may fail due to transient network errors. Pass `time_impl` for testability.\n\n**calling get_X() and handling IssueNotFound sentinel inline** → Read [LBYL Gateway Pattern](lbyl-gateway-pattern.md) first. Check with X_exists() first for cleaner error messages and LBYL compliance.\n\n**calling gh api directly in an exec script for plan metadata updates** → Read [PlanBackend Migration Pattern](plan-backend-migration.md) first. Use `require_plan_backend(ctx)` + backend methods instead. Direct gh calls bypass the abstraction and testability layers.\n\n**calling graphite.track_branch() with a remote ref like origin/main** → Read [Git and Graphite Edge Cases Catalog](git-graphite-quirks.md) first. Graphite's `gt track` only accepts local branch names, not remote refs. Use BranchManager.create_branch() which normalizes refs automatically, or strip `origin/` prefix before calling track_branch().\n\n**calling gt commands without --no-interactive flag** [pattern: `\\bgt\\s+(sync|submit|restack|create|modify)`] → Read [Git and Graphite Edge Cases Catalog](git-graphite-quirks.md) first. Always use `--no-interactive` with gt commands (gt sync, gt submit, gt restack, etc.). Without this flag, gt may prompt for user input and hang indefinitely. Note: `--force` does NOT prevent prompts - you must use `--no-interactive` separately.\n\n**calling os.chdir() in erk code** [pattern: `os\\.chdir\\(`] → Read [Erk Architecture Patterns](erk-architecture.md) first. After os.chdir(), regenerate context using regenerate_context(ctx). Stale ctx.cwd causes FileNotFoundError.\n\n**calling save_plan_ref with positional arguments** → Read [PlanRef Architecture](plan-ref-architecture.md) first. All parameters after `impl_dir` are keyword-only. Positional calls will fail at runtime.\n\n**changing a gateway method signature** → Read [Gateway Signature Migration](gateway-signature-migration.md) first. Search for ALL callers with grep before changing. PR #6329 migrated 8 call sites across 7 files. Missing a call site causes runtime errors.\n\n**changing config section names ([interactive-claude] or [interactive-agent])** → Read [Interactive Agent Configuration](interactive-agent-config.md) first. Maintain fallback from [interactive-agent] to [interactive-claude] for backward compatibility.\n\n**changing erk_shared function signatures** → Read [Gateway Signature Migration](gateway-signature-migration.md) first. Grep all callers across full repo before committing. Missed call sites cause CI failures.\n\n**changing gateway return type to discriminated union** → Read [Gateway ABC Implementation Checklist](gateway-abc-implementation.md) first. Verify all 5 implementations import the new types. Missing imports in abc.py, fake.py, dry_run.py, or printing.py break the gateway pattern.\n\n**changing permission_mode_to_claude() (or future permission_mode_to_codex()) implementations** → Read [PermissionMode Abstraction](permission-modes.md) first. Verify both Claude and Codex backend implementations maintain identical enum-to-mode mappings.\n\n**checking if get_pr_for_branch() returned a PR** [pattern: `get_pr_for_branch\\(`] → Read [Not-Found Sentinel Pattern](not-found-sentinel.md) first. Use `isinstance(pr, PRNotFound)` not `pr is not None`. PRNotFound is a sentinel object, not None.\n\n**checking isinstance after RetriesExhausted without type narrowing** → Read [GitHub API Retry Mechanism](github-api-retry-mechanism.md) first. After checking `isinstance(result, RetriesExhausted)`, the else branch is type-narrowed to the success type. Use `assert isinstance(result, T)` if needed for clarity.\n\n**checking isinstance(ctx.graphite, GraphiteDisabled) inline in command code** [pattern: `isinstance\\(.*GraphiteDisabled\\)`] → Read [Erk Architecture Patterns](erk-architecture.md) first. Use BranchManager abstraction instead. Add a method to BranchManager ABC that handles both Graphite and Git paths. This centralizes the branching logic and enables testing with FakeBranchManager.\n\n**checking out a branch in plan_save without restoring the original** → Read [Plan Save Branch Restoration](plan-save-branch-restoration.md) first. Plan save must always restore the original branch via try/finally. See plan-save-branch-restoration.md.\n\n**choosing between exceptions and discriminated unions for operation failures** → Read [Discriminated Union Error Handling](discriminated-union-error-handling.md) first. If callers branch on the error and continue the operation, use discriminated unions. If all callers just terminate and surface the message, use exceptions. Read the 'When to Use' section.\n\n**choosing between post_event and update_metadata** → Read [PlanBackend Migration Pattern](plan-backend-migration.md) first. post_event = metadata update + optional comment. update_metadata = metadata only. Use post_event when the operation should be visible to users in the issue timeline.\n\n**comparing git SHA to Graphite's tracked SHA for divergence detection** → Read [Git and Graphite Edge Cases Catalog](git-graphite-quirks.md) first. Ensure both `commit_sha` and `graphite_tracked_sha` are non-None before comparison. Returning False when either is None avoids false negatives on new branches.\n\n**comparing worktree path to repo_root to detect root worktree** → Read [Erk Architecture Patterns](erk-architecture.md) first. Use WorktreeInfo.is_root instead of path comparison. Path comparison fails when running from within a non-root worktree because ctx.cwd resolves differently.\n\n**constructing gist raw URLs with hardcoded filenames** → Read [GitHub Gist URL Patterns](github-gist-api.md) first. Use /raw/ without filename - GitHub redirects to first file.\n\n**creating Protocol with bare attributes for frozen dataclasses** → Read [Protocol vs ABC Interface Design Guide](protocol-vs-abc.md) first. Use @property decorators in Protocol for frozen dataclass compatibility. Bare attributes cause type errors.\n\n**creating a new ABC without deciding gateway vs backend pattern** → Read [Gateway vs Backend ABC Pattern](gateway-vs-backend.md) first. Read gateway-vs-backend.md first. Gateways wrap external tools (5-place: abc, real, fake, dry_run, printing). Backends abstract business logic (3-place: abc, real, fake). Wrong choice creates unnecessary boilerplate or missing test support.\n\n**creating a new complex command with multiple validation steps** → Read [Linear Pipeline Architecture](linear-pipelines.md) first. Consider two-pipeline pattern: validation pipeline (check preconditions) + execution pipeline (perform operations). Use discriminated unions (State | Error) for pipeline steps. Reference land_pipeline.py as exemplar.\n\n**creating branches in erk code** → Read [Branch Manager Decision Tree](branch-manager-decision-tree.md) first. Use the decision tree to determine whether to use ctx.branch_manager (with Graphite tracking) or ctx.git.branch (low-level git). Placeholder/ephemeral branches bypass branch_manager.\n\n**creating custom FakeGitHubIssues without passing to test context builder** → Read [Test Context Composition](test-context-composition.md) first. Always pass issues=issues to build_workspace_test_context when using custom FakeGitHubIssues. Without it, plan_backend operates on a different instance and metadata writes are invisible.\n\n**creating fake subgateway without shared state** → Read [Flatten Subgateway Pattern](flatten-subgateway-pattern.md) first. Fake subgateways must share state containers with parent via constructor parameters and call link_mutation_tracking(). Without this, mutations through subgateway won't be visible to parent queries.\n\n**deleting a gateway after consolidating into another** → Read [Gateway Removal Pattern](gateway-removal-pattern.md) first. Follow complete removal checklist: verify no references, delete all 5 layers, clean up compositions, update docs, run full test suite.\n\n**designing a new hook or reminder system** → Read [Context Injection Architecture](context-injection-tiers.md) first. Consider the three-tier context architecture and consolidation patterns. Read docs/learned/architecture/context-injection-tiers.md first.\n\n**designing error handling for a new gateway method** → Read [Gateway ABC Implementation Checklist](gateway-abc-implementation.md) first. Ask: does the caller continue after the failure? If yes, use discriminated union. If all callers terminate, use exceptions. See 'Non-Ideal State Decision Checklist' section.\n\n**detecting current worktree using path comparisons on cwd** → Read [Erk Architecture Patterns](erk-architecture.md) first. Use git.get_repository_root(cwd) to get the worktree root, then match exactly against known paths. Path comparisons with .exists()/.resolve()/is_relative_to() are fragile.\n\n**detecting mode after Phase 0 has already executed** → Read [Phase 0 Detection Pattern](phase-zero-detection-pattern.md) first. Late detection wastes work and creates scattered conditionals across all phases\n\n**duplicating environment setup in remote commands** → Read [Composable Remote Commands Pattern](composable-remote-commands.md) first. build_codespace_ssh_command() bootstraps the environment - don't duplicate setup\n\n**editing local plan files without syncing to GitHub** → Read [Plan File Sync Pattern](plan-file-sync-pattern.md) first. Sync is NOT automatic — GitHub issue will show stale content without explicit sync\n\n**execute_interactive() never returns in production** → Read [Prompt Executor Gateway](prompt-executor-gateway.md) first. it replaces the process via os.execvp\n\n**execute_prompt() supports both single-shot and streaming modes** → Read [Prompt Executor Gateway](prompt-executor-gateway.md) first. choose based on whether you need real-time updates\n\n**executing remote commands without calling start_codespace()** → Read [Composable Remote Commands Pattern](composable-remote-commands.md) first. Always start_codespace() before executing remote commands\n\n**expecting status to auto-update after manual PR edits** → Read [Roadmap Mutation Semantics](roadmap-mutation-semantics.md) first. Only the update-objective-node command writes computed status. Manual GitHub edits or direct body mutations leave status at its current value — you must explicitly set status to '-' to enable inference on next parse.\n\n**hand-constructing frozen dataclass instances with selective field copying** → Read [Optional Field Propagation](optional-field-propagation.md) first. Always use dataclasses.replace() to preserve all fields. Hand-construction with partial field copying silently drops optional fields (learn_status, learn_plan_issue, objective_issue, etc.).\n\n**implementing CLI flags that affect post-mutation behavior** → Read [Erk Architecture Patterns](erk-architecture.md) first. Validate flag preconditions BEFORE any mutations. Example: `--up` in `erk land` checks for child branches before merging PR. This prevents partial state (PR merged, worktree deleted, but no valid navigation target).\n\n**implementing a cleanup operation that modifies metadata based on external API success** → Read [Fail-Open Pattern](fail-open-patterns.md) first. Use fail-open pattern. If critical step fails, do NOT execute dependent steps that modify persistent state.\n\n**implementing a new `erk pr` command** → Read [PR Body Assembly](pr-body-assembly.md) first. Compare feature parity with `submit_pipeline.py`. Check: issue discovery, closing reference preservation, learn plan labels, footer construction, and plan details section. Use shared utilities from `shared.py` (`assemble_pr_body`, `discover_issue_for_footer`).\n\n**implementing idempotent operations that fail on missing resources** → Read [LBYL Gateway Pattern](lbyl-gateway-pattern.md) first. Use LBYL existence check to return early, making the operation truly idempotent.\n\n**implementing mtime-based cache invalidation** → Read [Graphite Cache Invalidation](graphite-cache-invalidation.md) first. Use triple-check guard pattern: (cache exists) AND (mtime exists) AND (mtime matches). Partial checks cause stale data bugs.\n\n**importing PlanBackendType or redeclaring it in a module other than erk_shared.context.types** → Read [erk_shared Package](erk-shared-package.md) first. PlanBackendType canonical import: import PlanBackendType only from erk_shared.context.types. Do not re-declare or shadow this type in other modules — erk_shared.context.types is the single source of truth. Shadowing creates hidden divergence that breaks isinstance checks and type narrowing.\n\n**importing time module or calling time.sleep() or datetime.now()** [pattern: `\\bimport time\\b|time\\.sleep\\(|datetime\\.now\\(`] → Read [Erk Architecture Patterns](erk-architecture.md) first. Use context.time.sleep() and context.time.now() for testability. Direct time.sleep() makes tests slow and datetime.now() makes tests non-deterministic.\n\n**injecting Time dependency into gateway real.py for lock-waiting or retry logic** → Read [Erk Architecture Patterns](erk-architecture.md) first. Accept optional Time in **init** with default to RealTime(). Use injected dependency in methods. This enables testing with FakeTime without blocking. See packages/erk-shared/src/erk_shared/gateway/git/lock.py for pattern.\n\n**migrating a gateway method to return discriminated union** → Read [Discriminated Union Error Handling](discriminated-union-error-handling.md) first. Update ALL 5 implementations (ABC, real, fake, dry_run, printing) AND all call sites AND tests. Incomplete migrations break type safety.\n\n**migrating git method calls after subgateway extraction** → Read [Gateway Decomposition Phases](gateway-decomposition-phases.md) first. The following methods have been moved from the Git ABC to subgateways: `git.fetch_branch()` → `git.remote.fetch_branch()` (Phase 3), `git.push_to_remote()` → `git.remote.push_to_remote()` (Phase 3), `git.commit()` → `git.commit.commit()` (Phase 4), `git.stage_files()` → `git.commit.stage_files()` (Phase 4), `git.has_staged_changes()` → `git.status.has_staged_changes()` (Phase 5), `git.rebase_onto()` → `git.rebase.rebase_onto()` (Phase 6), `git.tag_exists()` → `git.tag_exists()` (Phase 7), `git.create_tag()` → `git.tag.create_tag()` (Phase 7). Calling the old API will raise `AttributeError`. Always use the subgateway property.\n\n**mixing discriminated unions with exception-based cleanup in a single method** → Read [Mixed Exception/Union Pattern (Deprecated)](gateway-specific-patterns.md) first. This pattern was tried in PR #6347 and reverted in PR #6375. Message-only discriminated unions with no domain-meaningful variants add complexity without value. Use exceptions for all error cases, or use discriminated unions with meaningful variants throughout. Document why in the PR.\n\n**modifying Claude CLI error reporting or PromptResult.error format** → Read [Claude CLI Error Reporting](claude-cli-error-reporting.md) first. Error messages must maintain structured format with exit code, stderr, and context. Changes affect all callers of execute_prompt() and execute_command_streaming().\n\n**modifying InteractiveAgentConfig fields or config file format** → Read [Interactive Agent Configuration](interactive-agent-config.md) first. Update both config loading (RealErkInstallation.load_config) and usage sites. Check backward compatibility with [interactive-claude] section.\n\n**modifying PR footer format** → Read [PR Footer Format Validation](pr-footer-validation.md) first. Update generator, parser, AND validator in sync. Add support for new format BEFORE deprecating old format. Never break parsing of existing PRs.\n\n**modifying PermissionMode enum or permission mode mappings** → Read [PermissionMode Abstraction](permission-modes.md) first. permission_mode_to_claude() (and future permission_mode_to_codex()) must stay in sync. Update both when changing mappings.\n\n**modifying render_metadata_block() or parse_metadata_block_body()** → Read [Metadata Blocks Reference](metadata-blocks.md) first. Both metadata/core.py AND metadata_blocks.py contain identical implementations. Tests import from metadata_blocks.py. Changes to one must be mirrored in the other, or behavior diverges silently.\n\n**mutating pipeline state directly instead of using dataclasses.replace()** → Read [State Threading Pattern](state-threading-pattern.md) first. Pipeline state must be frozen. Use dataclasses.replace() to create new state at each step.\n\n**parsing CalledProcessError messages for git operations** → Read [Git Operation Patterns](git-operation-patterns.md) first. Avoid parsing git error messages to determine failure modes. Use LBYL with git show-ref --verify to check existence before operations, or design discriminated unions that handle all returncode cases explicitly.\n\n**passing array or object variables to gh api graphql with -F and json.dumps()** [pattern: `json\\.dumps\\(.*-F`] → Read [GitHub GraphQL API Patterns](github-graphql.md) first. Arrays and objects require special gh syntax: arrays use -f key[]=value1 -f key[]=value2, objects use -f key[subkey]=value. Using -F key=[...] or -F key={...} passes them as literal strings, not typed values.\n\n**passing dry_run boolean flags through business logic function parameters** → Read [Erk Architecture Patterns](erk-architecture.md) first. Use dependency injection with DryRunGit/DryRunGitHub wrappers for multi-step workflows. Simple CLI preview flags at the command level are acceptable for single-action commands.\n\n**passing secret values as command-line arguments** → Read [GitHub Admin Gateway](github-admin-gateway.md) first. Secret values must be passed via stdin (input= parameter) to avoid process list exposure. See github-admin-gateway.md.\n\n**passing variables to gh api graphql as JSON blob** [pattern: `gh\\s+api\\s+graphql`] → Read [GitHub GraphQL API Patterns](github-graphql.md) first. Variables must be passed individually with -f (strings) and -F (typed). The syntax `-f variables={...}` does NOT work.\n\n**reading agent output with TaskOutput then writing it to a file with Write** → Read [Context Efficiency Patterns](context-efficiency.md) first. This is the 'content relay' anti-pattern — it causes 2x context duplication. Instead, have agents accept an output_path parameter and write directly. See /erk:learn for the canonical implementation.\n\n**reading from or writing to ~/.claude/ paths using Path.home() directly** [pattern: `Path\\.home\\(\\).*\\.claude`] → Read [ClaudeInstallation Gateway](claude-installation-gateway.md) first. Use ClaudeInstallation gateway instead. All ~/.claude/ filesystem operations must go through this gateway for testability and storage abstraction.\n\n**relying solely on agent-level enforcement for critical rules** → Read [Defense-in-Depth Enforcement](defense-in-depth-enforcement.md) first. Add skill-level and PR-level enforcement layers. Only workflow/CI enforcement is truly reliable.\n\n**removing an abstract method from a gateway ABC** → Read [Gateway ABC Implementation Checklist](gateway-abc-implementation.md) first. Must remove from 5 places simultaneously: abc.py, real.py, fake.py, dry_run.py, printing.py. Partial removal causes type checker errors. Update all call sites to use subgateway property. Verify with grep across packages.\n\n**returning pre-rendered display strings from backend APIs** → Read [State Derivation Pattern](state-derivation-pattern.md) first. Return raw state fields instead. Derive display state in frontend pure functions for testability and reusability.\n\n**running tests immediately after rebase without checking for old symbols** → Read [Rebase Conflict Patterns](rebase-conflict-patterns.md) first. Hidden regressions can exist in non-conflicted files. Grep for old symbols that should have been renamed before running tests.\n\n**running tsc --noEmit from root in multi-config TypeScript project** → Read [TypeScript Multi-Config Project Checking](typescript-multi-config.md) first. tsc --noEmit from root breaks subdirectory configs. Use tsc -p <path> --noEmit for each tsconfig.json separately.\n\n**setting PR reference without providing --plan** → Read [Roadmap Mutation Semantics](roadmap-mutation-semantics.md) first. The CLI requires --plan when --pr is set (error: plan_required_with_pr). Use --plan '#NNN' to preserve or --plan '' to explicitly clear. Read roadmap-mutation-semantics.md for the None/empty/value semantics.\n\n**skipping fallback strategies when the selected item might disappear** → Read [Selection Preservation by Value](selection-preservation-by-value.md) first. Always provide fallback behavior when selected item not found in refreshed data (reset to 0, preserve index clamped, or clear selection).\n\n**suppressing F401 (unused import) warnings** → Read [Re-Export Pattern](re-export-pattern.md) first. Use # noqa: F401 comment per-import with reason, not global ruff config. Indicates intentional re-export vs actual unused import.\n\n**threading state through pipeline steps with mutable dataclasses** → Read [Land State Threading Pattern](land-state-threading.md) first. Use frozen dataclasses (@dataclass(frozen=True)) for pipeline state. Update fields with dataclasses.replace() to create new instances. Immutability enables caching, testability, and replay.\n\n**tracking selection by array index when the array can be mutated** → Read [Selection Preservation by Value](selection-preservation-by-value.md) first. Track selection by unique identifier (issue_number, row key), not array position. Array indices become unstable when rows are added, removed, or reordered.\n\n**trusting agent-produced JSON without normalization** → Read [Agent Schema Enforcement](agent-schema-enforcement.md) first. Agents drift from expected schemas over time. Always normalize at the boundary before validation. See normalize_tripwire_candidates.py for the pattern.\n\n**try/except in fake.py or dry_run.py** [pattern: `\\btry:|\\bexcept\\s`] → Read [Gateway Error Boundaries](gateway-error-boundaries.md) first. Gateway error handling (try/except) belongs ONLY in real.py. Fake and dry-run implementations return error discriminants based on constructor params, they don't catch exceptions.\n\n**updating a roadmap step's PR cell** → Read [Roadmap Mutation Semantics](roadmap-mutation-semantics.md) first. The update-objective-node command computes display status from the PR value and writes it directly into the status cell. Status inference only happens during parsing when status is '-' or empty.\n\n**using --force-with-lease in multi-step workflows where earlier steps push** → Read [Git and Graphite Edge Cases Catalog](git-graphite-quirks.md) first. Force-push silently overwrites intermediate commits from earlier workflow steps. Always `git pull --rebase` before pushing in multi-step workflows.\n\n**using LiveDisplay in watch loops without try/finally blocks** → Read [LiveDisplay Gateway](live-display-gateway.md) first. guard with try/finally to ensure stop() is called even on KeyboardInterrupt\n\n**using PlanContextProvider** → Read [Plan Context Integration](plan-context-integration.md) first. Read this doc first. PlanContextProvider returns None on any failure (graceful degradation). Always handle the None case.\n\n**using `--output-format stream-json` with `--print` in Claude CLI** [pattern: `--output-format\\s+stream-json`] → Read [Claude CLI Integration from Python](claude-cli-integration.md) first. Must also include `--verbose`. Without it, the command fails with 'stream-json requires --verbose'.\n\n**using `gt restack` to resolve branch divergence errors** [pattern: `gt\\s+restack`] → Read [Git and Graphite Edge Cases Catalog](git-graphite-quirks.md) first. gt restack only handles parent-child stack rebasing, NOT same-branch remote divergence. Use git rebase origin/$BRANCH first.\n\n**using bare subprocess.run with check=True** [pattern: `subprocess\\.run\\(`] → Read [Subprocess Wrappers](subprocess-wrappers.md) first. Use wrapper functions: run_subprocess_with_context() (gateway) or run_with_error_reporting() (CLI). Exception: Graceful degradation pattern with explicit CalledProcessError handling is acceptable for optional operations.\n\n**using bash heredocs for large agent outputs** → Read [Heredoc Quoting and Escaping in Agent-Generated Bash](bash-python-integration.md) first. heredocs fail silently with special characters; prefer the Write tool\n\n**using gh api or gh api graphql to fetch or resolve PR review threads** → Read [GitHub API Rate Limits](github-api-rate-limits.md) first. Load `pr-operations` skill first. Use `erk exec get-pr-review-comments` and `erk exec resolve-review-thread` instead. Raw gh api calls miss thread resolution functionality.\n\n**using gh codespace start** [pattern: `gh\\s+codespace\\s+start`] → Read [GitHub CLI Limits](github-cli-limits.md) first. gh codespace start does not exist. Use REST API POST /user/codespaces/{name}/start via gh api instead.\n\n**using gh gist create with --filename flag** [pattern: `gh\\s+gist\\s+create.*--filename`] → Read [GitHub CLI Quirks and Edge Cases](github-cli-quirks.md) first. --filename only works with stdin input (-), not file paths.\n\n**using gh issue create in production code** [pattern: `gh\\s+issue\\s+create`] → Read [GitHub API Rate Limits](github-api-rate-limits.md) first. Use REST API via `gh api repos/{owner}/{repo}/issues -X POST` instead. `gh issue create` uses GraphQL which has separate (often exhausted) rate limits.\n\n**using gh issue edit in command documentation** [pattern: `gh\\s+issue\\s+edit`] → Read [GitHub API Rate Limits](github-api-rate-limits.md) first. Use `erk exec update-issue-body` instead. `gh issue edit` uses GraphQL which has separate (often exhausted) rate limits.\n\n**using gh issue view in command documentation** [pattern: `gh\\s+issue\\s+view`] → Read [GitHub API Rate Limits](github-api-rate-limits.md) first. Use `erk exec get-issue-body` instead. `gh issue view` uses GraphQL which has separate (often exhausted) rate limits.\n\n**using gh pr create in production code** [pattern: `gh\\s+pr\\s+create`] → Read [GitHub API Rate Limits](github-api-rate-limits.md) first. Use REST API via `gh api repos/{owner}/{repo}/pulls -X POST` instead. `gh pr create` uses GraphQL which has separate (often exhausted) rate limits.\n\n**using gh pr diff --name-only in production code** [pattern: `gh\\s+pr\\s+diff\\s+--name-only`] → Read [GitHub CLI Limits](github-cli-limits.md) first. For PRs with 300+ files, gh pr diff fails with HTTP 406. Use REST API with pagination instead.\n\n**using gh pr view --json merged** [pattern: `gh\\s+pr\\s+view.*--json.*\\bmerged\\b`] → Read [GitHub API Rate Limits](github-api-rate-limits.md) first. The `merged` field doesn't exist. Use `mergedAt` instead. Run `gh pr view --help` or check error output for valid field names.\n\n**using git pull or git pull --rebase on a Graphite-managed branch** [pattern: `git\\s+pull`] → Read [Git and Graphite Edge Cases Catalog](git-graphite-quirks.md) first. Use /erk:sync-divergence instead. git pull --rebase rewrites commit SHAs outside Graphite's tracking, causing stack divergence that requires manual cleanup with gt sync --restack and force-push.\n\n**using mutable list fields directly for mutation tracking in fakes** → Read [Fake Mutation Tracking](fake-mutation-tracking.md) first. Expose mutation tracking via @property returning tuple or .copy(). Internal lists should be private. See fake-mutation-tracking.md.\n\n**using os.environ.get(\"CLAUDE_CODE_SESSION_ID\") in erk code** [pattern: `os\\.environ.*CLAUDE_CODE_SESSION_ID`] → Read [Erk Architecture Patterns](erk-architecture.md) first. Erk code NEVER has access to this environment variable. Session IDs must be passed via --session-id CLI flags. Hooks receive session ID via stdin JSON, not environment variables.\n\n**using run_ssh_command() for interactive commands** → Read [Composable Remote Commands Pattern](composable-remote-commands.md) first. Interactive commands need exec_ssh_interactive(), not run_ssh_command()\n\n**using subprocess.run with git command outside of a gateway** [pattern: `subprocess\\.run\\(\\s*\\[.*[\"']git`] → Read [Gateway ABC Implementation Checklist](gateway-abc-implementation.md) first. Use the Git gateway instead. Direct subprocess calls bypass testability (fakes) and dry-run support. The Git ABC (erk_shared.gateway.git.abc.Git) likely already has a method for this operation. Only use subprocess directly in real.py gateway implementations.\n\n**using this pattern** → Read [SSH Command Execution Patterns](ssh-command-execution.md) first. Using run_ssh_command() for interactive TUI processes causes apparent hangs\n\n**using this pattern** → Read [SSH Command Execution Patterns](ssh-command-execution.md) first. SSH command must be a single string argument, not multiple shell words\n\n**using this pattern** → Read [SSH Command Execution Patterns](ssh-command-execution.md) first. Missing -t flag prevents TTY allocation and breaks interactive programs\n\n**using unquoted heredoc delimiters (<<EOF) when the body contains $, \\, or backticks** [pattern: `<<\\s*EOF\\b`] → Read [Heredoc Quoting and Escaping in Agent-Generated Bash](bash-python-integration.md) first. bash silently expands them\n\n**validating object fields at every callsite instead of at construction** → Read [Erk Architecture Patterns](erk-architecture.md) first. Validate at the single construction point (factory/reader function). Callers should trust returned objects without re-validation. This is the construction boundary principle.\n\n**writing LiveDisplay output to stdout** → Read [LiveDisplay Gateway](live-display-gateway.md) first. RealLiveDisplay writes to stderr by default (matches erk's user_output convention) — stdout is reserved for structured data\n\n**writing complex business logic directly in Click command functions** → Read [CLI-to-Pipeline Boundary Pattern](cli-to-pipeline-boundary.md) first. Extract to pipeline layer when command has >3 distinct steps or complex state management. CLI layer should handle: Click decorators, parameter parsing, output formatting. Pipeline layer should handle: business logic, state management, error types.\n\n**writing multi-phase commands without testing in --print mode** → Read [Claude CLI Execution Modes](claude-cli-execution-modes.md) first. context: fork creates true isolation in interactive mode but loads inline in --print mode. Use Task tool for guaranteed isolation in all modes.\n","numLines":290,"startLine":1,"totalLines":290}}}
{"parentUuid":"6315f06f-38c2-4d6a-888d-c284f2457766","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SUWnApKGmAp2JBexGuBMEm","type":"tool_result","content":"     1→---\n     2→title: Planning Tripwires\n     3→read_when:\n     4→  - \"working on planning code\"\n     5→---\n     6→\n     7→<!-- AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY -->\n     8→<!-- Edit source frontmatter, then run 'erk docs sync' to regenerate. -->\n     9→<!-- Generated from planning/*.md frontmatter -->\n    10→\n    11→# Planning Tripwires\n    12→\n    13→Rules triggered by matching actions in code.\n    14→\n    15→**adding <code> inside <summary> elements in PR bodies** → Read [Draft PR Lifecycle](draft-pr-lifecycle.md) first. Graphite doesn't render <code> inside <summary> — use plain text instead. GitHub renders it but Graphite does not. The correct format is <summary>original-plan</summary> not <summary><code>original-plan</code></summary>.\n    16→\n    17→**adding Closes #N to a draft PR footer** → Read [Draft PR Lifecycle](draft-pr-lifecycle.md) first. Draft PR IS the plan. Self-referential close would close the plan itself. Use issue_number=None for draft-PR backend.\n    18→\n    19→**adding a new PR-dependent step to trigger-async-learn** → Read [Learn Without PR Context](learn-without-pr-context.md) first. Any new PR-dependent step must handle the None case from \\_get_pr_for_plan_direct. The entire PR comment block is gated on pr_result not being None.\n    20→\n    21→**adding a new filtering step to preprocess_session.py** → Read [Session Preprocessing Architecture](session-preprocessing.md) first. There are TWO preprocessing implementations: the exec script (preprocess_session.py) and erk-shared (session_preprocessing.py). The exec script has the full filtering pipeline; erk-shared has only Stage 1 mechanical reduction. New filters go in the exec script. Read this doc first.\n    22→\n    23→**adding a new pipeline stage to trigger-async-learn** → Read [Learn Pipeline Workflow](learn-pipeline-workflow.md) first. New stages must be direct Python function calls, not subprocess invocations. The orchestrator uses tight coupling for performance. See the Direct-Call Architecture section in async-learn-local-preprocessing.md.\n    24→\n    25→**adding a new setup path to plan-implement without routing through Step 2d** → Read [Impl-Context Staging Directory](impl-context.md) first. Impl-context cleanup routing: all code paths that set up an implementation context must route through Step 2d in plan-implement.md, which is the single convergence point for .erk/impl-context/ cleanup. Adding a new setup path that bypasses Step 2d will silently skip cleanup, leaving .erk/impl-context/ files in the final PR diff.\n    26→\n    27→**adding branch_name to plan-header at creation time** → Read [Branch Name Inference](branch-name-inference.md) first. branch_name is intentionally omitted at creation because the branch doesn't exist yet. The plan-save → branch-create → impl-signal lifecycle requires this gap. See the temporal gap section below.\n    28→\n    29→**adding dry-run support to one-shot commands** → Read [One-Shot Workflow](one-shot-workflow.md) first. One-shot dry-run mode must NOT create skeleton issues\n    30→\n    31→**adding erk-consolidated label to a single-issue replan** → Read [Consolidation Labels](consolidation-labels.md) first. Only multi-plan consolidation gets the erk-consolidated label. Single-issue replans are updates, not consolidations.\n    32→\n    33→**adding footer before PR creation** → Read [Draft PR Lifecycle](draft-pr-lifecycle.md) first. PR footer needs the PR number, which isn't known until after create_pr returns. Add footer AFTER PR creation.\n    34→\n    35→**adding new agents to learn workflow** → Read [Learn Workflow](learn-workflow.md) first. Document input/output format and test file passing. Learn workflow uses stateless agents with file-based composition.\n    36→\n    37→**adding plan storage behavior without checking plan backend type** → Read [Draft PR Plan Backend](draft-pr-plan-backend.md) first. Two backends exist (github, draft_pr). Verify behavior works for both. See draft-pr-plan-backend.md.\n    38→\n    39→**adding post-dispatch operations without matching submit.py pattern** → Read [One-Shot Workflow](one-shot-workflow.md) first. dispatch_one_shot() and \\_submit_single_issue() in submit.py must stay synchronized. Both use write_dispatch_metadata() + create_submission_queued_block(). Changes to one must be mirrored in the other.\n    40→\n    41→**adding subprocess calls to trigger-async-learn** → Read [Async Learn Local Preprocessing](async-learn-local-preprocessing.md) first. This command uses direct Python function calls, not subprocess invocations. This is intentional — see the direct-call architecture section below.\n    42→\n    43→**after plan-implement execution completes** → Read [Plan Lifecycle](lifecycle.md) first. Always clean .worker-impl/ with `git rm -rf .worker-impl/` and commit. Transient artifacts cause CI formatter failures (Prettier).\n    44→\n    45→**analyzing sessions larger than 100k characters** → Read [Scratch Storage](scratch-storage.md) first. Use `erk exec preprocess-session` first. Achieves ~99% token reduction (e.g., 6.2M -> 67k chars). Critical for fitting large sessions in agent context windows.\n    46→\n    47→**assigning opus to a mechanical extraction agent** → Read [Multi-Tier Agent Orchestration](agent-orchestration.md) first. Model escalation: haiku/sonnet for extraction and rule-based work, opus only for creative authoring. See the model escalation decision table.\n    48→\n    49→**assuming branch names always follow the P-prefix format** → Read [Branch Plan Resolution](branch-plan-resolution.md) first. Branch resolution supports multiple formats (P-prefix, objective). Use resolve_plan_id_for_branch() rather than manual parsing. See branch-plan-resolution.md.\n    50→\n    51→**assuming branch_name is always present in plan-header metadata** → Read [PR Discovery Strategies for Plans](pr-discovery.md) first. branch_name is null until Phase 2 (plan submit). Check the plan metadata field lifecycle in lifecycle.md.\n    52→\n    53→**assuming plan content is in the issue body** → Read [Plan Content Extraction Fallback](metadata-block-fallback.md) first. Schema v2 stores plan content in the FIRST COMMENT, not the issue body. The body contains only the plan-header metadata block. See extract_plan_from_comment() for the extraction logic.\n    54→\n    55→**assuming remote sessions skip local preprocessing** → Read [Async Learn Local Preprocessing](async-learn-local-preprocessing.md) first. Since PR #6974, remote sessions go through the same \\_preprocess_session_direct() pipeline as local sessions. They are downloaded first, then preprocessed identically.\n    56→\n    57→**automatically removing .impl/ folder** → Read [.worker-impl/ vs .impl/ Cleanup Discipline](worktree-cleanup.md) first. NEVER auto-delete .impl/. It belongs to the user for plan-vs-implementation review. Only .worker-impl/ is auto-cleaned.\n    58→\n    59→**blocking implementation on review PR feedback** → Read [PR-Based Plan Review Workflow](pr-review-workflow.md) first. Review PRs are advisory and non-blocking. Implementation can proceed regardless of review PR state.\n    60→\n    61→**calling `create_worker_impl_folder()` without checking `worker_impl_folder_exists()` first** → Read [Impl-Context Staging Directory](impl-context.md) first. Both submit paths use LBYL: `if worker_impl_folder_exists(): remove_worker_impl_folder()` before creating. Stale .worker-impl/ from a prior failed submission causes errors.\n    62→\n    63→**calling commands that depend on `.impl/plan-ref.json` metadata** → Read [Plan Lifecycle](lifecycle.md) first. Verify metadata file exists in worktree; if missing, operations silently return empty values. read_plan_ref() tries plan-ref.json first, falls back to legacy issue.json.\n    64→\n    65→**calling preprocess_session functions from trigger_async_learn** → Read [Session Preprocessing Architecture](session-preprocessing.md) first. trigger_async_learn duplicates the exec script's filtering pipeline as \\_preprocess_session_direct(). If you change the exec script's pipeline, update the direct function too.\n    66→\n    67→**calling update_metadata() on PlanBackend** → Read [PlanBackend Migration Guide](plan-backend-migration.md) first. Always check isinstance(result, PlanNotFound) before calling update_metadata()\n    68→\n    69→**capturing subagent output inline when it may exceed 1KB** → Read [Agent Orchestration Safety Patterns](agent-orchestration-safety.md) first. Bash tool truncates output at ~10KB with no error. Use Write tool to save agent output to scratch storage, then pass the file path to dependent agents.\n    70→\n    71→**catching PlanHeaderNotFoundError** → Read [PlanBackend Migration Guide](plan-backend-migration.md) first. PlanHeaderNotFoundError is an exception; PlanNotFound is a result type - use LBYL for the latter\n    72→\n    73→**changing branch naming convention (P{issue}- or plan- prefix)** → Read [Branch Name Inference](branch-name-inference.md) first. The P{issue}- prefix (issue-based) and plan- prefix (draft-PR) are cross-cutting contracts used by branch creation, extraction functions, and PR recovery. Changing either prefix format requires updating all consumers.\n    74→\n    75→**changing how sessions are classified as planning vs impl** → Read [Learn Pipeline Workflow](learn-pipeline-workflow.md) first. Classification uses planning_session_id from GitHub metadata. The resulting prefix (planning- vs impl-) propagates into XML filenames and is used by downstream learn agents to weight insights differently.\n    76→\n    77→**checking only one location when extracting plan content** → Read [Plan Content Extraction Fallback](metadata-block-fallback.md) first. Always check both the first comment (plan-body metadata block) and the issue body before reporting 'no plan content found'. The replan command documents this explicitly in Step 4a.\n    78→\n    79→**classifying a single-artifact API reference as NEW_DOC** → Read [Cornerstone Enforcement in Learn Pipeline](cornerstone-enforcement.md) first. Apply the three-rule SHOULD_BE_CODE test first. Single-artifact knowledge belongs in code (types, docstrings, or comments), not docs/learned/.\n    80→\n    81→**closing a plan issue without verifying all items were addressed** → Read [Complete File Inventory Protocol](complete-inventory-protocol.md) first. Compare the file inventory against the plan's items before closing. Silent omissions are the most common failure mode.\n    82→\n    83→**committing to draft-PR plan branches after checkout without pulling remote** → Read [Draft PR Branch Sync](draft-pr-branch-sync.md) first. Both setup_impl_from_issue.py and submit.py use the same three-step sync: fetch_branch -> checkout/create_tracking -> pull_rebase. Skipping pull_rebase causes non-fast-forward push failures.\n    84→\n    85→**consolidating issues that already have erk-consolidated label** → Read [Consolidation Labels](consolidation-labels.md) first. Filter out erk-consolidated issues before consolidation. These are outputs of previous consolidation and should not be re-consolidated.\n    86→\n    87→**constructing a PR footer manually instead of using build_pr_body_footer()** → Read [PR Submission Patterns](pr-submission-patterns.md) first. The footer format includes checkout commands and closing references with specific patterns. Use the builder function to ensure validation passes.\n    88→\n    89→**creating a PR without first checking if one already exists for the branch** → Read [PR Submission Patterns](pr-submission-patterns.md) first. The submit pipeline is idempotent — it checks for existing PRs before creating. If building PR creation outside the pipeline, replicate this check to prevent duplicates.\n    90→\n    91→**creating a learn plan without setting learned_from_issue** → Read [Learn Plans vs. Implementation Plans](learn-vs-implementation-plans.md) first. Learn plans MUST set learned_from_issue to their parent implementation plan's issue number. Without it, base branch auto-detection fails and the learn plan lands on trunk instead of stacking on the parent.\n    92→\n    93→**creating a new branch for a draft-PR plan** → Read [Draft PR Branch Sync](draft-pr-branch-sync.md) first. Draft-PR plans already have a branch created during plan-save. Reuse the existing branch, don't create a new one.\n    94→\n    95→**creating a new plan-generating command without a pre-plan gathering step** → Read [Context Preservation Prompting Patterns](context-preservation-prompting.md) first. Without explicit context materialization before EnterPlanMode, agents produce sparse plans. Apply the two-phase pattern from this document.\n    96→\n    97→**creating erk-learn plan for an issue that already has erk-learn label** → Read [Learn Plan Validation](learn-plan-validation.md) first. Validate target issue has erk-plan label, NOT erk-learn. Learn plans analyze implementation plans, not other learn plans (cycle prevention).\n    98→\n    99→**creating temp files for AI workflows** → Read [Scratch Storage](scratch-storage.md) first. Use worktree-scoped scratch storage for session-specific data.\n   100→\n   101→**delegating batch file renames from a plan** → Read [Plan Lifecycle](lifecycle.md) first. Verify each file path exists before delegating. Wrong paths cause silent coverage gaps in rename operations.\n   102→\n   103→**delegating judgment steps to Haiku subagents** → Read [Command-Agent Delegation](agent-delegation.md) first. Prose reconciliation, design analysis, and architectural comparison need Opus-level reasoning. Delegating to a Haiku subagent loses quality. Also avoid delegating steps that require direct user interaction.\n   104→\n   105→**designing output routing for a multi-agent workflow** → Read [Agent Output Routing Strategies](agent-output-routing-strategies.md) first. Choose between embedded-prompt routing (in orchestrator Task prompts) and agent-file routing (in agent definitions). See this doc for the decision framework.\n   106→\n   107→**detecting plan backend by checking backend type directly** → Read [Draft PR Branch Sync](draft-pr-branch-sync.md) first. Use plan.header_fields.get(BRANCH_NAME) to detect draft-PR plans. This is backend-agnostic and works across all backends.\n   108→\n   109→**editing plan body content in plan creation, replan, or one-shot dispatch** → Read [One-Shot Workflow](one-shot-workflow.md) first. One-shot metadata block preservation: the metadata block in the plan body (HTML comment with erk:metadata-block markers) must survive all edits. Never strip or overwrite HTML comment blocks that contain erk:metadata-block markers.\n   110→\n   111→**editing plan content only in the PR branch without syncing** → Read [PR-Based Plan Review Workflow](pr-review-workflow.md) first. Plan content lives in two places (PR branch + issue comment). Edit the local file, then sync to the issue with `erk exec plan-update-from-feedback`. See plan-file-sync-pattern.md.\n   112→\n   113→**entering Plan Mode in replan or consolidation workflow** → Read [Context Preservation in Replan Workflow](context-preservation-in-replan.md) first. Gather investigation context FIRST (Step 6a). Enter plan mode only after collecting file paths, evidence, and discoveries. Sparse plans are destructive to downstream implementation.\n   114→\n   115→**estimating effort for a plan without checking actual files changed** → Read [Complete File Inventory Protocol](complete-inventory-protocol.md) first. Run a file inventory first. Plans that skip inventory systematically undercount configuration, test, and documentation changes.\n   116→\n   117→**fetching N large documents into parent agent context** → Read [Token Optimization Patterns](token-optimization-patterns.md) first. Delegate content fetching to child agents. Parent receives only analysis summaries, not raw content. Achieves O(1) parent context instead of O(n). See token-optimization-patterns.md.\n   118→\n   119→**gathering sessions for preprocessing** → Read [Learn Workflow](learn-workflow.md) first. Sessions >100k characters MUST be preprocessed first. Use erk exec preprocess-session for ~99% token reduction.\n   120→\n   121→**grepping only for the error message text** → Read [Source Investigation Over Trial-and-Error](debugging-patterns.md) first. Also grep for function names extracted from the error (e.g., 'checkout_footer' from 'Missing checkout footer'). Validator function names are more stable search targets than error message strings.\n   122→\n   123→**hardcoding next-steps command strings instead of using the dataclass properties** → Read [Next Steps Output Formatting](next-steps-output.md) first. Use IssueNextSteps or DraftPRNextSteps dataclasses from erk_shared.output.next_steps. They are the single source of truth for command formatting.\n   124→\n   125→**implementing PR body generation with checkout footers** → Read [Plan Lifecycle](lifecycle.md) first. HTML `<details>` tags will fail `has_checkout_footer_for_pr()` validation. Use plain text backtick format: `` `gh pr checkout <number>` ``\n   126→\n   127→**implementing custom PR/plan relevance assessment logic** → Read [Plan Lifecycle](lifecycle.md) first. Reference `/local:check-relevance` verdict classification system first. Use SUPERSEDED (80%+ overlap), PARTIALLY_IMPLEMENTED (30-80% overlap), DIFFERENT_APPROACH, STILL_RELEVANT, NEEDS_REVIEW categories for consistency.\n   128→\n   129→**implementing draft-PR plan without syncing with remote** → Read [Draft PR Branch Sync](draft-pr-branch-sync.md) first. Before implementing a draft-PR plan, always sync with remote: fetch_branch -> checkout/create_tracking -> pull_rebase\n   130→\n   131→**importing functions directly from plan_header.py** → Read [Plan Header Privatization](plan-header-privatization.md) first. plan_header.py functions are being privatized. Use PlanBackend methods instead for metadata operations.\n   132→\n   133→**including impl-signal or plan-save-to-issue in a Task tool sub-agent prompt** → Read [Sub-Agent Context Limitations](sub-agent-context-limitations.md) first. Sub-agents cannot access ${CLAUDE_SESSION_ID}. Session-dependent commands must run in the root agent context. See sub-agent-context-limitations.md.\n   134→\n   135→**launching a dependent agent that reads a file written by a prior agent** → Read [Agent Orchestration Safety Patterns](agent-orchestration-safety.md) first. Verify the file exists (ls) before launching. Write tool silently fails if the parent directory is missing, and the dependent agent wastes its entire context discovering the file isn't there.\n   136→\n   137→**launching parallel agents that return results inline instead of writing to files** → Read [Parallel Agent Orchestration for Bulk Operations](parallel-audit-pattern.md) first. Parallel agents must write results via Write tool to .erk/scratch/ files. Inline results can be truncated or lost. The parent agent reads files after completion.\n   138→\n   139→**making a third trial-and-error attempt at a validation fix** → Read [Source Investigation Over Trial-and-Error](debugging-patterns.md) first. After 2 failed attempts, stop guessing. Grep for the validator function and read the source to understand the exact requirement.\n   140→\n   141→**making objective-update-after-land exit non-zero** → Read [Objective Update After Land](objective-update-after-land.md) first. This script uses fail-open design. Failures must not block landing. See objective-update-after-land.md.\n   142→\n   143→**manually creating an erk-plan issue with gh issue create** → Read [Plan Lifecycle](lifecycle.md) first. Use `erk exec plan-save-to-issue --plan-file <path>` instead. Manual creation requires complex metadata block format (see Metadata Block Reference section).\n   144→\n   145→**manually setting the base branch for a learn plan submission** → Read [Learn Plans vs. Implementation Plans](learn-vs-implementation-plans.md) first. Learn plan base branch is auto-detected from learned_from_issue → parent branch. Only use --base to override if the parent branch is missing from the remote.\n   146→\n   147→**marking a draft-PR plan as 'implementation complete' and referencing itself as the implementing PR** → Read [Draft PR Lifecycle](draft-pr-lifecycle.md) first. Self-referential close prevention: when a draft PR IS the plan, it cannot close itself. The plan's implementation-complete event cannot reference the plan PR as the implementing PR. One-shot dispatch guards against this — do not remove the guard.\n   148→\n   149→**merging a plan review PR** → Read [PR-Based Plan Review Workflow](pr-review-workflow.md) first. Plan review PRs are NEVER merged. They exist only for inline review comments. Close without merging when review is complete.\n   150→\n   151→**migrating a plan without preserving operational metadata** → Read [Plan Migration to Draft PR](plan-migrate-to-draft-pr.md) first. create_plan() only sets a subset of fields. Use update_metadata() in a second phase to carry over operational fields like lifecycle_stage, last_dispatched_at, etc. See \\_FIELDS_HANDLED_BY_CREATE in plan_migrate_to_draft_pr.py.\n   152→\n   153→**modifying learn command to add/remove/reorder agents** → Read [Learn Workflow](learn-workflow.md) first. Verify tier placement before assigning model. Parallel extraction uses haiku, sequential synthesis may need opus for quality-critical output.\n   154→\n   155→**modifying marker deletion behavior in exit-plan-mode hook** → Read [Session-Based Plan Deduplication](session-deduplication.md) first. Reusable markers (plan-saved) must persist; one-time markers (implement-now, objective-context) are consumed. Deleting reusable markers breaks state machines and enables retry loops that create duplicates.\n   156→\n   157→**modifying one-shot dispatch or skeleton issue creation** → Read [One-Shot Workflow](one-shot-workflow.md) first. Skeleton plan issues must be created BEFORE generating branch names to get P<N>- prefix\n   158→\n   159→**modifying register-one-shot-plan exit behavior** → Read [One-Shot Workflow](one-shot-workflow.md) first. register-one-shot-plan uses best-effort: exit 0 if any operation succeeds\n   160→\n   161→**modifying the gist upload content format** → Read [Learn Pipeline Workflow](learn-pipeline-workflow.md) first. The download side (download-learn-materials) parses delimiters to split content back into files. Changes to the upload format must be mirrored in the download parser. See gist-materials-interchange.md.\n   162→\n   163→**moving gateway files without git mv** → Read [Gateway Consolidation Checklist](gateway-consolidation-checklist.md) first. Always use git mv to preserve file history. Plain mv + git add loses blame history, making future archaeology harder.\n   164→\n   165→**parsing plan content without backward compatibility** → Read [Draft PR Lifecycle](draft-pr-lifecycle.md) first. extract_plan_content() handles both details-wrapped and old flat format. Always use it instead of manual parsing.\n   166→\n   167→**passing ${CLAUDE_SESSION_ID} to a sub-agent via the prompt string** → Read [Sub-Agent Context Limitations](sub-agent-context-limitations.md) first. String substitution of ${CLAUDE_SESSION_ID} happens at the root agent level. By the time the sub-agent runs the bash command, the variable is not in its environment. The root agent must resolve the value and pass it as a literal.\n   168→\n   169→**passing session content to an analysis agent** → Read [Session Preprocessing Architecture](session-preprocessing.md) first. Raw JSONL sessions can be 6+ million characters. Always preprocess first. The learn workflow validates preprocessed output exists before spawning agents.\n   170→\n   171→**prompting an agent to 'include findings in the plan' without structuring them first** → Read [Context Preservation Prompting Patterns](context-preservation-prompting.md) first. Unstructured prompts don't work — agents summarize at too high a level. Use the four-category gathering step instead.\n   172→\n   173→**reading ERK_PLAN_BACKEND env var inside inner functions when global_config is already in scope** → Read [Draft PR Plan Backend](draft-pr-plan-backend.md) first. Backend detection precedence: when GlobalConfig.plan_backend is available via context, use it. Never fall back to re-reading env vars inside inner functions if global_config is already in scope — the context value takes precedence and re-reading env vars bypasses context overrides.\n   174→\n   175→**reading learn_plan_issue or learn_status** → Read [Learn Plan Metadata Preservation](learn-plan-metadata-fields.md) first. Verify field came through full pipeline. If null, check if filtered out earlier. Use gateway abstractions; never hand-construct Plan objects.\n   176→\n   177→**reading parallel agent output without verifying files exist** → Read [Parallel Agent Orchestration for Bulk Operations](parallel-audit-pattern.md) first. Always verify output files exist (ls -la) before reading. Agent failures may produce empty or missing files.\n   178→\n   179→**relying on agent instructions as the sole enforcement for a critical operation** → Read [Workflow Reliability Patterns](reliability-patterns.md) first. Agent behavior is non-deterministic. Critical operations need a deterministic workflow step as the final safety net.\n   180→\n   181→**removing .worker-impl/ during implementation (before CI passes)** → Read [.worker-impl/ vs .impl/ Cleanup Discipline](worktree-cleanup.md) first. The folder is load-bearing during implementation — Claude reads from it (via copy to .impl/). Only remove after implementation succeeds and CI passes.\n   182→\n   183→**removing git-tracked temporary directories in setup scripts** → Read [Impl-Context Staging Directory](impl-context.md) first. Defer deletion to the git cleanup phase (git rm + commit + push), not shutil.rmtree(). setup_impl_from_issue.py reads the files but deliberately does NOT delete them — see the comment at line 202. Deletion is handled by plan-implement.md Step 2d.\n   184→\n   185→**renaming a lifecycle stage value** → Read [Plan Lifecycle](lifecycle.md) first. Update 4 locations: LifecycleStageValue type, valid_stages set, \\_VALID_STAGES tuple, and color conditions in compute_lifecycle_display(). Missing any location causes silent validation failures or incorrect TUI colors.\n   186→\n   187→**renaming gateway files during a move without checking for non-standard naming** → Read [Gateway Consolidation Checklist](gateway-consolidation-checklist.md) first. Source files that don't follow standard naming (e.g., executor.py instead of abc.py) must be renamed to abc.py/real.py/fake.py during the move. The gateway directory convention requires standard file names.\n   188→\n   189→**reusing existing worktrees for remote implementation** → Read [Remote Implementation Idempotency](remote-implementation-idempotency.md) first. Check if worktree already has a branch before creating new one. Reusing worktrees without checking causes PR orphaning.\n   190→\n   191→**reviewing a PR that contains .erk/impl-context/ files** → Read [Impl-Context Staging Directory](impl-context.md) first. Leave a PR comment telling the author to remove .erk/impl-context/. This is an erk tooling error — the directory should have been cleaned up before implementation. Run: git rm -rf .erk/impl-context/ && git commit -m 'Remove leaked impl-context'\n   192→\n   193→**rewriting PR body without preserving metadata** → Read [Draft PR Lifecycle](draft-pr-lifecycle.md) first. Extract metadata prefix on every lifecycle transition via extract_metadata_prefix() to prevent metadata loss.\n   194→\n   195→**running /erk:learn in CI** → Read [Learn Workflow](learn-workflow.md) first. CI mode skips interactive prompts and auto-proceeds. Check CI/GITHUB_ACTIONS env vars. See CI Environment Behavior section.\n   196→\n   197→**running /erk:learn on an issue that already has the erk-learn label** → Read [Learn Plans vs. Implementation Plans](learn-vs-implementation-plans.md) first. Learn plans cannot generate additional learn plans — this creates documentation cycles. The learn command validates this upfront and rejects learn-on-learn.\n   198→\n   199→**running sequential analysis that could be parallelized** → Read [Multi-Tier Agent Orchestration](agent-orchestration.md) first. If agents analyze independent data sources, run them in parallel. Only use sequential execution when one agent's output is another's input.\n   200→\n   201→**saving a plan with --objective-issue flag** → Read [Plan Lifecycle](lifecycle.md) first. Always verify the link was saved correctly with `erk exec get-plan-metadata <issue> objective_issue`. Silent failures can leave plans unlinked from their objectives.\n   202→\n   203→**spawning a GitHub Actions workflow from erk without passing plan_backend as an explicit input** → Read [Draft PR Plan Backend](draft-pr-plan-backend.md) first. Draft-PR backend propagation: GitHub Actions reusable workflows (workflow_call) do NOT inherit environment variables from the caller. ERK_PLAN_BACKEND must be declared as an explicit workflow input and passed by the caller. Ambient env vars are invisible to reusable workflows.\n   204→\n   205→**staging .worker-impl/ deletion without an immediate commit** → Read [.worker-impl/ vs .impl/ Cleanup Discipline](worktree-cleanup.md) first. A downstream `git reset --hard` will silently discard staged-only deletions. Always commit+push cleanup atomically. See reliability-patterns.md.\n   206→\n   207→**staging git changes (git add/git rm) without an immediate commit before a git reset --hard** → Read [Workflow Reliability Patterns](reliability-patterns.md) first. git reset --hard silently discards staged changes. Commit and push cleanup BEFORE any reset step.\n   208→\n   209→**treating missing PR as an error in the learn pipeline** → Read [Learn Without PR Context](learn-without-pr-context.md) first. No-PR is a valid workflow state, not an error. The learn pipeline must degrade gracefully — sessions alone provide sufficient material for insight extraction.\n   210→\n   211→**updating imports one file at a time during gateway consolidation** → Read [Gateway Consolidation Checklist](gateway-consolidation-checklist.md) first. Use LibCST for systematic import updates. Manual editing misses call sites and creates partial migration states. See docs/learned/refactoring/libcst-systematic-imports.md.\n   212→\n   213→**using 'steps' instead of 'nodes' in new plan metadata code** → Read [Schema V3 Migration](schema-v3-migration.md) first. Schema v3 uses 'nodes' (not 'steps'). The parser accepts both for backward compatibility but the renderer always emits v3. See schema-v3-migration.md.\n   214→\n   215→**using `extract_metadata_prefix` or `extract_plan_content` without validating separator context** → Read [Draft PR Lifecycle](draft-pr-lifecycle.md) first. The content separator `\\n\\n---\\n\\n` can accidentally form from 'Remotely executed' notes + footer delimiter. extract_metadata_prefix() validates via `<!-- erk:metadata-block:` marker in the prefix. Never skip this validation.\n   216→\n   217→**using background agents without waiting for completion before dependent operations** → Read [Command-Agent Delegation](agent-delegation.md) first. Use TaskOutput with block=true to wait for all background agents to complete. Without synchronization, dependent agents may read incomplete outputs or missing files.\n   218→\n   219→**using issue number from .impl/issue.json in a checkout footer** → Read [PR Submission Patterns](pr-submission-patterns.md) first. Checkout footers require the PR number, not the issue number. The issue is the plan; the PR is the implementation. See the PR Number vs Issue Number section.\n   220→\n   221→**using issue timeline API as the primary PR lookup path** → Read [PR Discovery Strategies for Plans](pr-discovery.md) first. The primary path is branch_name from plan-header → get_pr_for_branch(). Timeline API is a separate strategy for when branch_name is unavailable.\n   222→\n   223→**using opus/sonnet for mechanical data fetching or formatting tasks** → Read [Token Optimization Patterns](token-optimization-patterns.md) first. Use haiku for mechanical work (fetch, parse, format). Reserve expensive models for synthesis and reasoning.\n   224→\n   225→**using session-scoped markers in exec scripts** → Read [Session-Based Plan Deduplication](session-deduplication.md) first. Session markers enable idempotency in command retries. Always write markers AFTER successful operation completion, never before. Use triple-check guard on marker read: file exists AND content is valid AND expected type (numeric for issue numbers).\n   226→\n   227→**validating plan_id in exec scripts without checking provider type** → Read [Draft PR Plan Backend](draft-pr-plan-backend.md) first. Draft-PR plan_id IS the PR number (not an issue number). Check provider type before assuming plan_id semantics. Issue-based plans use issue numbers; draft-PR plans use PR numbers.\n   228→\n   229→**writing a plan step that says 'update X' without a file path** → Read [Context Preservation Patterns](context-preservation-patterns.md) first. Generic references force re-discovery. Include the full path, line numbers, and evidence. See the five dimensions below.\n   230→\n   231→**writing post-dispatch operations without try/except guards** → Read [One-Shot Workflow](one-shot-workflow.md) first. Post-dispatch operations (metadata write, queued comment) are best-effort. Wrap in try/except with user-visible warnings. See write_dispatch_metadata() and create_submission_queued_block() in one_shot_dispatch.py.\n   232→\n   233→**writing to /tmp/** → Read [Scratch Storage](scratch-storage.md) first. AI workflow files belong in .erk/scratch/<session-id>/, NOT /tmp/.\n   234→\n   235→**writing verification criteria like 'documentation is complete'** → Read [Context Preservation Patterns](context-preservation-patterns.md) first. Vague verification is unverifiable. Criteria must be testable with grep, file inspection, or running code.\n   236→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"b34eef59-5db9-4aa9-9720-471c58a50d0e","timestamp":"2026-02-21T23:14:19.533Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/docs/learned/planning/tripwires.md","content":"---\ntitle: Planning Tripwires\nread_when:\n  - \"working on planning code\"\n---\n\n<!-- AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY -->\n<!-- Edit source frontmatter, then run 'erk docs sync' to regenerate. -->\n<!-- Generated from planning/*.md frontmatter -->\n\n# Planning Tripwires\n\nRules triggered by matching actions in code.\n\n**adding <code> inside <summary> elements in PR bodies** → Read [Draft PR Lifecycle](draft-pr-lifecycle.md) first. Graphite doesn't render <code> inside <summary> — use plain text instead. GitHub renders it but Graphite does not. The correct format is <summary>original-plan</summary> not <summary><code>original-plan</code></summary>.\n\n**adding Closes #N to a draft PR footer** → Read [Draft PR Lifecycle](draft-pr-lifecycle.md) first. Draft PR IS the plan. Self-referential close would close the plan itself. Use issue_number=None for draft-PR backend.\n\n**adding a new PR-dependent step to trigger-async-learn** → Read [Learn Without PR Context](learn-without-pr-context.md) first. Any new PR-dependent step must handle the None case from \\_get_pr_for_plan_direct. The entire PR comment block is gated on pr_result not being None.\n\n**adding a new filtering step to preprocess_session.py** → Read [Session Preprocessing Architecture](session-preprocessing.md) first. There are TWO preprocessing implementations: the exec script (preprocess_session.py) and erk-shared (session_preprocessing.py). The exec script has the full filtering pipeline; erk-shared has only Stage 1 mechanical reduction. New filters go in the exec script. Read this doc first.\n\n**adding a new pipeline stage to trigger-async-learn** → Read [Learn Pipeline Workflow](learn-pipeline-workflow.md) first. New stages must be direct Python function calls, not subprocess invocations. The orchestrator uses tight coupling for performance. See the Direct-Call Architecture section in async-learn-local-preprocessing.md.\n\n**adding a new setup path to plan-implement without routing through Step 2d** → Read [Impl-Context Staging Directory](impl-context.md) first. Impl-context cleanup routing: all code paths that set up an implementation context must route through Step 2d in plan-implement.md, which is the single convergence point for .erk/impl-context/ cleanup. Adding a new setup path that bypasses Step 2d will silently skip cleanup, leaving .erk/impl-context/ files in the final PR diff.\n\n**adding branch_name to plan-header at creation time** → Read [Branch Name Inference](branch-name-inference.md) first. branch_name is intentionally omitted at creation because the branch doesn't exist yet. The plan-save → branch-create → impl-signal lifecycle requires this gap. See the temporal gap section below.\n\n**adding dry-run support to one-shot commands** → Read [One-Shot Workflow](one-shot-workflow.md) first. One-shot dry-run mode must NOT create skeleton issues\n\n**adding erk-consolidated label to a single-issue replan** → Read [Consolidation Labels](consolidation-labels.md) first. Only multi-plan consolidation gets the erk-consolidated label. Single-issue replans are updates, not consolidations.\n\n**adding footer before PR creation** → Read [Draft PR Lifecycle](draft-pr-lifecycle.md) first. PR footer needs the PR number, which isn't known until after create_pr returns. Add footer AFTER PR creation.\n\n**adding new agents to learn workflow** → Read [Learn Workflow](learn-workflow.md) first. Document input/output format and test file passing. Learn workflow uses stateless agents with file-based composition.\n\n**adding plan storage behavior without checking plan backend type** → Read [Draft PR Plan Backend](draft-pr-plan-backend.md) first. Two backends exist (github, draft_pr). Verify behavior works for both. See draft-pr-plan-backend.md.\n\n**adding post-dispatch operations without matching submit.py pattern** → Read [One-Shot Workflow](one-shot-workflow.md) first. dispatch_one_shot() and \\_submit_single_issue() in submit.py must stay synchronized. Both use write_dispatch_metadata() + create_submission_queued_block(). Changes to one must be mirrored in the other.\n\n**adding subprocess calls to trigger-async-learn** → Read [Async Learn Local Preprocessing](async-learn-local-preprocessing.md) first. This command uses direct Python function calls, not subprocess invocations. This is intentional — see the direct-call architecture section below.\n\n**after plan-implement execution completes** → Read [Plan Lifecycle](lifecycle.md) first. Always clean .worker-impl/ with `git rm -rf .worker-impl/` and commit. Transient artifacts cause CI formatter failures (Prettier).\n\n**analyzing sessions larger than 100k characters** → Read [Scratch Storage](scratch-storage.md) first. Use `erk exec preprocess-session` first. Achieves ~99% token reduction (e.g., 6.2M -> 67k chars). Critical for fitting large sessions in agent context windows.\n\n**assigning opus to a mechanical extraction agent** → Read [Multi-Tier Agent Orchestration](agent-orchestration.md) first. Model escalation: haiku/sonnet for extraction and rule-based work, opus only for creative authoring. See the model escalation decision table.\n\n**assuming branch names always follow the P-prefix format** → Read [Branch Plan Resolution](branch-plan-resolution.md) first. Branch resolution supports multiple formats (P-prefix, objective). Use resolve_plan_id_for_branch() rather than manual parsing. See branch-plan-resolution.md.\n\n**assuming branch_name is always present in plan-header metadata** → Read [PR Discovery Strategies for Plans](pr-discovery.md) first. branch_name is null until Phase 2 (plan submit). Check the plan metadata field lifecycle in lifecycle.md.\n\n**assuming plan content is in the issue body** → Read [Plan Content Extraction Fallback](metadata-block-fallback.md) first. Schema v2 stores plan content in the FIRST COMMENT, not the issue body. The body contains only the plan-header metadata block. See extract_plan_from_comment() for the extraction logic.\n\n**assuming remote sessions skip local preprocessing** → Read [Async Learn Local Preprocessing](async-learn-local-preprocessing.md) first. Since PR #6974, remote sessions go through the same \\_preprocess_session_direct() pipeline as local sessions. They are downloaded first, then preprocessed identically.\n\n**automatically removing .impl/ folder** → Read [.worker-impl/ vs .impl/ Cleanup Discipline](worktree-cleanup.md) first. NEVER auto-delete .impl/. It belongs to the user for plan-vs-implementation review. Only .worker-impl/ is auto-cleaned.\n\n**blocking implementation on review PR feedback** → Read [PR-Based Plan Review Workflow](pr-review-workflow.md) first. Review PRs are advisory and non-blocking. Implementation can proceed regardless of review PR state.\n\n**calling `create_worker_impl_folder()` without checking `worker_impl_folder_exists()` first** → Read [Impl-Context Staging Directory](impl-context.md) first. Both submit paths use LBYL: `if worker_impl_folder_exists(): remove_worker_impl_folder()` before creating. Stale .worker-impl/ from a prior failed submission causes errors.\n\n**calling commands that depend on `.impl/plan-ref.json` metadata** → Read [Plan Lifecycle](lifecycle.md) first. Verify metadata file exists in worktree; if missing, operations silently return empty values. read_plan_ref() tries plan-ref.json first, falls back to legacy issue.json.\n\n**calling preprocess_session functions from trigger_async_learn** → Read [Session Preprocessing Architecture](session-preprocessing.md) first. trigger_async_learn duplicates the exec script's filtering pipeline as \\_preprocess_session_direct(). If you change the exec script's pipeline, update the direct function too.\n\n**calling update_metadata() on PlanBackend** → Read [PlanBackend Migration Guide](plan-backend-migration.md) first. Always check isinstance(result, PlanNotFound) before calling update_metadata()\n\n**capturing subagent output inline when it may exceed 1KB** → Read [Agent Orchestration Safety Patterns](agent-orchestration-safety.md) first. Bash tool truncates output at ~10KB with no error. Use Write tool to save agent output to scratch storage, then pass the file path to dependent agents.\n\n**catching PlanHeaderNotFoundError** → Read [PlanBackend Migration Guide](plan-backend-migration.md) first. PlanHeaderNotFoundError is an exception; PlanNotFound is a result type - use LBYL for the latter\n\n**changing branch naming convention (P{issue}- or plan- prefix)** → Read [Branch Name Inference](branch-name-inference.md) first. The P{issue}- prefix (issue-based) and plan- prefix (draft-PR) are cross-cutting contracts used by branch creation, extraction functions, and PR recovery. Changing either prefix format requires updating all consumers.\n\n**changing how sessions are classified as planning vs impl** → Read [Learn Pipeline Workflow](learn-pipeline-workflow.md) first. Classification uses planning_session_id from GitHub metadata. The resulting prefix (planning- vs impl-) propagates into XML filenames and is used by downstream learn agents to weight insights differently.\n\n**checking only one location when extracting plan content** → Read [Plan Content Extraction Fallback](metadata-block-fallback.md) first. Always check both the first comment (plan-body metadata block) and the issue body before reporting 'no plan content found'. The replan command documents this explicitly in Step 4a.\n\n**classifying a single-artifact API reference as NEW_DOC** → Read [Cornerstone Enforcement in Learn Pipeline](cornerstone-enforcement.md) first. Apply the three-rule SHOULD_BE_CODE test first. Single-artifact knowledge belongs in code (types, docstrings, or comments), not docs/learned/.\n\n**closing a plan issue without verifying all items were addressed** → Read [Complete File Inventory Protocol](complete-inventory-protocol.md) first. Compare the file inventory against the plan's items before closing. Silent omissions are the most common failure mode.\n\n**committing to draft-PR plan branches after checkout without pulling remote** → Read [Draft PR Branch Sync](draft-pr-branch-sync.md) first. Both setup_impl_from_issue.py and submit.py use the same three-step sync: fetch_branch -> checkout/create_tracking -> pull_rebase. Skipping pull_rebase causes non-fast-forward push failures.\n\n**consolidating issues that already have erk-consolidated label** → Read [Consolidation Labels](consolidation-labels.md) first. Filter out erk-consolidated issues before consolidation. These are outputs of previous consolidation and should not be re-consolidated.\n\n**constructing a PR footer manually instead of using build_pr_body_footer()** → Read [PR Submission Patterns](pr-submission-patterns.md) first. The footer format includes checkout commands and closing references with specific patterns. Use the builder function to ensure validation passes.\n\n**creating a PR without first checking if one already exists for the branch** → Read [PR Submission Patterns](pr-submission-patterns.md) first. The submit pipeline is idempotent — it checks for existing PRs before creating. If building PR creation outside the pipeline, replicate this check to prevent duplicates.\n\n**creating a learn plan without setting learned_from_issue** → Read [Learn Plans vs. Implementation Plans](learn-vs-implementation-plans.md) first. Learn plans MUST set learned_from_issue to their parent implementation plan's issue number. Without it, base branch auto-detection fails and the learn plan lands on trunk instead of stacking on the parent.\n\n**creating a new branch for a draft-PR plan** → Read [Draft PR Branch Sync](draft-pr-branch-sync.md) first. Draft-PR plans already have a branch created during plan-save. Reuse the existing branch, don't create a new one.\n\n**creating a new plan-generating command without a pre-plan gathering step** → Read [Context Preservation Prompting Patterns](context-preservation-prompting.md) first. Without explicit context materialization before EnterPlanMode, agents produce sparse plans. Apply the two-phase pattern from this document.\n\n**creating erk-learn plan for an issue that already has erk-learn label** → Read [Learn Plan Validation](learn-plan-validation.md) first. Validate target issue has erk-plan label, NOT erk-learn. Learn plans analyze implementation plans, not other learn plans (cycle prevention).\n\n**creating temp files for AI workflows** → Read [Scratch Storage](scratch-storage.md) first. Use worktree-scoped scratch storage for session-specific data.\n\n**delegating batch file renames from a plan** → Read [Plan Lifecycle](lifecycle.md) first. Verify each file path exists before delegating. Wrong paths cause silent coverage gaps in rename operations.\n\n**delegating judgment steps to Haiku subagents** → Read [Command-Agent Delegation](agent-delegation.md) first. Prose reconciliation, design analysis, and architectural comparison need Opus-level reasoning. Delegating to a Haiku subagent loses quality. Also avoid delegating steps that require direct user interaction.\n\n**designing output routing for a multi-agent workflow** → Read [Agent Output Routing Strategies](agent-output-routing-strategies.md) first. Choose between embedded-prompt routing (in orchestrator Task prompts) and agent-file routing (in agent definitions). See this doc for the decision framework.\n\n**detecting plan backend by checking backend type directly** → Read [Draft PR Branch Sync](draft-pr-branch-sync.md) first. Use plan.header_fields.get(BRANCH_NAME) to detect draft-PR plans. This is backend-agnostic and works across all backends.\n\n**editing plan body content in plan creation, replan, or one-shot dispatch** → Read [One-Shot Workflow](one-shot-workflow.md) first. One-shot metadata block preservation: the metadata block in the plan body (HTML comment with erk:metadata-block markers) must survive all edits. Never strip or overwrite HTML comment blocks that contain erk:metadata-block markers.\n\n**editing plan content only in the PR branch without syncing** → Read [PR-Based Plan Review Workflow](pr-review-workflow.md) first. Plan content lives in two places (PR branch + issue comment). Edit the local file, then sync to the issue with `erk exec plan-update-from-feedback`. See plan-file-sync-pattern.md.\n\n**entering Plan Mode in replan or consolidation workflow** → Read [Context Preservation in Replan Workflow](context-preservation-in-replan.md) first. Gather investigation context FIRST (Step 6a). Enter plan mode only after collecting file paths, evidence, and discoveries. Sparse plans are destructive to downstream implementation.\n\n**estimating effort for a plan without checking actual files changed** → Read [Complete File Inventory Protocol](complete-inventory-protocol.md) first. Run a file inventory first. Plans that skip inventory systematically undercount configuration, test, and documentation changes.\n\n**fetching N large documents into parent agent context** → Read [Token Optimization Patterns](token-optimization-patterns.md) first. Delegate content fetching to child agents. Parent receives only analysis summaries, not raw content. Achieves O(1) parent context instead of O(n). See token-optimization-patterns.md.\n\n**gathering sessions for preprocessing** → Read [Learn Workflow](learn-workflow.md) first. Sessions >100k characters MUST be preprocessed first. Use erk exec preprocess-session for ~99% token reduction.\n\n**grepping only for the error message text** → Read [Source Investigation Over Trial-and-Error](debugging-patterns.md) first. Also grep for function names extracted from the error (e.g., 'checkout_footer' from 'Missing checkout footer'). Validator function names are more stable search targets than error message strings.\n\n**hardcoding next-steps command strings instead of using the dataclass properties** → Read [Next Steps Output Formatting](next-steps-output.md) first. Use IssueNextSteps or DraftPRNextSteps dataclasses from erk_shared.output.next_steps. They are the single source of truth for command formatting.\n\n**implementing PR body generation with checkout footers** → Read [Plan Lifecycle](lifecycle.md) first. HTML `<details>` tags will fail `has_checkout_footer_for_pr()` validation. Use plain text backtick format: `` `gh pr checkout <number>` ``\n\n**implementing custom PR/plan relevance assessment logic** → Read [Plan Lifecycle](lifecycle.md) first. Reference `/local:check-relevance` verdict classification system first. Use SUPERSEDED (80%+ overlap), PARTIALLY_IMPLEMENTED (30-80% overlap), DIFFERENT_APPROACH, STILL_RELEVANT, NEEDS_REVIEW categories for consistency.\n\n**implementing draft-PR plan without syncing with remote** → Read [Draft PR Branch Sync](draft-pr-branch-sync.md) first. Before implementing a draft-PR plan, always sync with remote: fetch_branch -> checkout/create_tracking -> pull_rebase\n\n**importing functions directly from plan_header.py** → Read [Plan Header Privatization](plan-header-privatization.md) first. plan_header.py functions are being privatized. Use PlanBackend methods instead for metadata operations.\n\n**including impl-signal or plan-save-to-issue in a Task tool sub-agent prompt** → Read [Sub-Agent Context Limitations](sub-agent-context-limitations.md) first. Sub-agents cannot access ${CLAUDE_SESSION_ID}. Session-dependent commands must run in the root agent context. See sub-agent-context-limitations.md.\n\n**launching a dependent agent that reads a file written by a prior agent** → Read [Agent Orchestration Safety Patterns](agent-orchestration-safety.md) first. Verify the file exists (ls) before launching. Write tool silently fails if the parent directory is missing, and the dependent agent wastes its entire context discovering the file isn't there.\n\n**launching parallel agents that return results inline instead of writing to files** → Read [Parallel Agent Orchestration for Bulk Operations](parallel-audit-pattern.md) first. Parallel agents must write results via Write tool to .erk/scratch/ files. Inline results can be truncated or lost. The parent agent reads files after completion.\n\n**making a third trial-and-error attempt at a validation fix** → Read [Source Investigation Over Trial-and-Error](debugging-patterns.md) first. After 2 failed attempts, stop guessing. Grep for the validator function and read the source to understand the exact requirement.\n\n**making objective-update-after-land exit non-zero** → Read [Objective Update After Land](objective-update-after-land.md) first. This script uses fail-open design. Failures must not block landing. See objective-update-after-land.md.\n\n**manually creating an erk-plan issue with gh issue create** → Read [Plan Lifecycle](lifecycle.md) first. Use `erk exec plan-save-to-issue --plan-file <path>` instead. Manual creation requires complex metadata block format (see Metadata Block Reference section).\n\n**manually setting the base branch for a learn plan submission** → Read [Learn Plans vs. Implementation Plans](learn-vs-implementation-plans.md) first. Learn plan base branch is auto-detected from learned_from_issue → parent branch. Only use --base to override if the parent branch is missing from the remote.\n\n**marking a draft-PR plan as 'implementation complete' and referencing itself as the implementing PR** → Read [Draft PR Lifecycle](draft-pr-lifecycle.md) first. Self-referential close prevention: when a draft PR IS the plan, it cannot close itself. The plan's implementation-complete event cannot reference the plan PR as the implementing PR. One-shot dispatch guards against this — do not remove the guard.\n\n**merging a plan review PR** → Read [PR-Based Plan Review Workflow](pr-review-workflow.md) first. Plan review PRs are NEVER merged. They exist only for inline review comments. Close without merging when review is complete.\n\n**migrating a plan without preserving operational metadata** → Read [Plan Migration to Draft PR](plan-migrate-to-draft-pr.md) first. create_plan() only sets a subset of fields. Use update_metadata() in a second phase to carry over operational fields like lifecycle_stage, last_dispatched_at, etc. See \\_FIELDS_HANDLED_BY_CREATE in plan_migrate_to_draft_pr.py.\n\n**modifying learn command to add/remove/reorder agents** → Read [Learn Workflow](learn-workflow.md) first. Verify tier placement before assigning model. Parallel extraction uses haiku, sequential synthesis may need opus for quality-critical output.\n\n**modifying marker deletion behavior in exit-plan-mode hook** → Read [Session-Based Plan Deduplication](session-deduplication.md) first. Reusable markers (plan-saved) must persist; one-time markers (implement-now, objective-context) are consumed. Deleting reusable markers breaks state machines and enables retry loops that create duplicates.\n\n**modifying one-shot dispatch or skeleton issue creation** → Read [One-Shot Workflow](one-shot-workflow.md) first. Skeleton plan issues must be created BEFORE generating branch names to get P<N>- prefix\n\n**modifying register-one-shot-plan exit behavior** → Read [One-Shot Workflow](one-shot-workflow.md) first. register-one-shot-plan uses best-effort: exit 0 if any operation succeeds\n\n**modifying the gist upload content format** → Read [Learn Pipeline Workflow](learn-pipeline-workflow.md) first. The download side (download-learn-materials) parses delimiters to split content back into files. Changes to the upload format must be mirrored in the download parser. See gist-materials-interchange.md.\n\n**moving gateway files without git mv** → Read [Gateway Consolidation Checklist](gateway-consolidation-checklist.md) first. Always use git mv to preserve file history. Plain mv + git add loses blame history, making future archaeology harder.\n\n**parsing plan content without backward compatibility** → Read [Draft PR Lifecycle](draft-pr-lifecycle.md) first. extract_plan_content() handles both details-wrapped and old flat format. Always use it instead of manual parsing.\n\n**passing ${CLAUDE_SESSION_ID} to a sub-agent via the prompt string** → Read [Sub-Agent Context Limitations](sub-agent-context-limitations.md) first. String substitution of ${CLAUDE_SESSION_ID} happens at the root agent level. By the time the sub-agent runs the bash command, the variable is not in its environment. The root agent must resolve the value and pass it as a literal.\n\n**passing session content to an analysis agent** → Read [Session Preprocessing Architecture](session-preprocessing.md) first. Raw JSONL sessions can be 6+ million characters. Always preprocess first. The learn workflow validates preprocessed output exists before spawning agents.\n\n**prompting an agent to 'include findings in the plan' without structuring them first** → Read [Context Preservation Prompting Patterns](context-preservation-prompting.md) first. Unstructured prompts don't work — agents summarize at too high a level. Use the four-category gathering step instead.\n\n**reading ERK_PLAN_BACKEND env var inside inner functions when global_config is already in scope** → Read [Draft PR Plan Backend](draft-pr-plan-backend.md) first. Backend detection precedence: when GlobalConfig.plan_backend is available via context, use it. Never fall back to re-reading env vars inside inner functions if global_config is already in scope — the context value takes precedence and re-reading env vars bypasses context overrides.\n\n**reading learn_plan_issue or learn_status** → Read [Learn Plan Metadata Preservation](learn-plan-metadata-fields.md) first. Verify field came through full pipeline. If null, check if filtered out earlier. Use gateway abstractions; never hand-construct Plan objects.\n\n**reading parallel agent output without verifying files exist** → Read [Parallel Agent Orchestration for Bulk Operations](parallel-audit-pattern.md) first. Always verify output files exist (ls -la) before reading. Agent failures may produce empty or missing files.\n\n**relying on agent instructions as the sole enforcement for a critical operation** → Read [Workflow Reliability Patterns](reliability-patterns.md) first. Agent behavior is non-deterministic. Critical operations need a deterministic workflow step as the final safety net.\n\n**removing .worker-impl/ during implementation (before CI passes)** → Read [.worker-impl/ vs .impl/ Cleanup Discipline](worktree-cleanup.md) first. The folder is load-bearing during implementation — Claude reads from it (via copy to .impl/). Only remove after implementation succeeds and CI passes.\n\n**removing git-tracked temporary directories in setup scripts** → Read [Impl-Context Staging Directory](impl-context.md) first. Defer deletion to the git cleanup phase (git rm + commit + push), not shutil.rmtree(). setup_impl_from_issue.py reads the files but deliberately does NOT delete them — see the comment at line 202. Deletion is handled by plan-implement.md Step 2d.\n\n**renaming a lifecycle stage value** → Read [Plan Lifecycle](lifecycle.md) first. Update 4 locations: LifecycleStageValue type, valid_stages set, \\_VALID_STAGES tuple, and color conditions in compute_lifecycle_display(). Missing any location causes silent validation failures or incorrect TUI colors.\n\n**renaming gateway files during a move without checking for non-standard naming** → Read [Gateway Consolidation Checklist](gateway-consolidation-checklist.md) first. Source files that don't follow standard naming (e.g., executor.py instead of abc.py) must be renamed to abc.py/real.py/fake.py during the move. The gateway directory convention requires standard file names.\n\n**reusing existing worktrees for remote implementation** → Read [Remote Implementation Idempotency](remote-implementation-idempotency.md) first. Check if worktree already has a branch before creating new one. Reusing worktrees without checking causes PR orphaning.\n\n**reviewing a PR that contains .erk/impl-context/ files** → Read [Impl-Context Staging Directory](impl-context.md) first. Leave a PR comment telling the author to remove .erk/impl-context/. This is an erk tooling error — the directory should have been cleaned up before implementation. Run: git rm -rf .erk/impl-context/ && git commit -m 'Remove leaked impl-context'\n\n**rewriting PR body without preserving metadata** → Read [Draft PR Lifecycle](draft-pr-lifecycle.md) first. Extract metadata prefix on every lifecycle transition via extract_metadata_prefix() to prevent metadata loss.\n\n**running /erk:learn in CI** → Read [Learn Workflow](learn-workflow.md) first. CI mode skips interactive prompts and auto-proceeds. Check CI/GITHUB_ACTIONS env vars. See CI Environment Behavior section.\n\n**running /erk:learn on an issue that already has the erk-learn label** → Read [Learn Plans vs. Implementation Plans](learn-vs-implementation-plans.md) first. Learn plans cannot generate additional learn plans — this creates documentation cycles. The learn command validates this upfront and rejects learn-on-learn.\n\n**running sequential analysis that could be parallelized** → Read [Multi-Tier Agent Orchestration](agent-orchestration.md) first. If agents analyze independent data sources, run them in parallel. Only use sequential execution when one agent's output is another's input.\n\n**saving a plan with --objective-issue flag** → Read [Plan Lifecycle](lifecycle.md) first. Always verify the link was saved correctly with `erk exec get-plan-metadata <issue> objective_issue`. Silent failures can leave plans unlinked from their objectives.\n\n**spawning a GitHub Actions workflow from erk without passing plan_backend as an explicit input** → Read [Draft PR Plan Backend](draft-pr-plan-backend.md) first. Draft-PR backend propagation: GitHub Actions reusable workflows (workflow_call) do NOT inherit environment variables from the caller. ERK_PLAN_BACKEND must be declared as an explicit workflow input and passed by the caller. Ambient env vars are invisible to reusable workflows.\n\n**staging .worker-impl/ deletion without an immediate commit** → Read [.worker-impl/ vs .impl/ Cleanup Discipline](worktree-cleanup.md) first. A downstream `git reset --hard` will silently discard staged-only deletions. Always commit+push cleanup atomically. See reliability-patterns.md.\n\n**staging git changes (git add/git rm) without an immediate commit before a git reset --hard** → Read [Workflow Reliability Patterns](reliability-patterns.md) first. git reset --hard silently discards staged changes. Commit and push cleanup BEFORE any reset step.\n\n**treating missing PR as an error in the learn pipeline** → Read [Learn Without PR Context](learn-without-pr-context.md) first. No-PR is a valid workflow state, not an error. The learn pipeline must degrade gracefully — sessions alone provide sufficient material for insight extraction.\n\n**updating imports one file at a time during gateway consolidation** → Read [Gateway Consolidation Checklist](gateway-consolidation-checklist.md) first. Use LibCST for systematic import updates. Manual editing misses call sites and creates partial migration states. See docs/learned/refactoring/libcst-systematic-imports.md.\n\n**using 'steps' instead of 'nodes' in new plan metadata code** → Read [Schema V3 Migration](schema-v3-migration.md) first. Schema v3 uses 'nodes' (not 'steps'). The parser accepts both for backward compatibility but the renderer always emits v3. See schema-v3-migration.md.\n\n**using `extract_metadata_prefix` or `extract_plan_content` without validating separator context** → Read [Draft PR Lifecycle](draft-pr-lifecycle.md) first. The content separator `\\n\\n---\\n\\n` can accidentally form from 'Remotely executed' notes + footer delimiter. extract_metadata_prefix() validates via `<!-- erk:metadata-block:` marker in the prefix. Never skip this validation.\n\n**using background agents without waiting for completion before dependent operations** → Read [Command-Agent Delegation](agent-delegation.md) first. Use TaskOutput with block=true to wait for all background agents to complete. Without synchronization, dependent agents may read incomplete outputs or missing files.\n\n**using issue number from .impl/issue.json in a checkout footer** → Read [PR Submission Patterns](pr-submission-patterns.md) first. Checkout footers require the PR number, not the issue number. The issue is the plan; the PR is the implementation. See the PR Number vs Issue Number section.\n\n**using issue timeline API as the primary PR lookup path** → Read [PR Discovery Strategies for Plans](pr-discovery.md) first. The primary path is branch_name from plan-header → get_pr_for_branch(). Timeline API is a separate strategy for when branch_name is unavailable.\n\n**using opus/sonnet for mechanical data fetching or formatting tasks** → Read [Token Optimization Patterns](token-optimization-patterns.md) first. Use haiku for mechanical work (fetch, parse, format). Reserve expensive models for synthesis and reasoning.\n\n**using session-scoped markers in exec scripts** → Read [Session-Based Plan Deduplication](session-deduplication.md) first. Session markers enable idempotency in command retries. Always write markers AFTER successful operation completion, never before. Use triple-check guard on marker read: file exists AND content is valid AND expected type (numeric for issue numbers).\n\n**validating plan_id in exec scripts without checking provider type** → Read [Draft PR Plan Backend](draft-pr-plan-backend.md) first. Draft-PR plan_id IS the PR number (not an issue number). Check provider type before assuming plan_id semantics. Issue-based plans use issue numbers; draft-PR plans use PR numbers.\n\n**writing a plan step that says 'update X' without a file path** → Read [Context Preservation Patterns](context-preservation-patterns.md) first. Generic references force re-discovery. Include the full path, line numbers, and evidence. See the five dimensions below.\n\n**writing post-dispatch operations without try/except guards** → Read [One-Shot Workflow](one-shot-workflow.md) first. Post-dispatch operations (metadata write, queued comment) are best-effort. Wrap in try/except with user-visible warnings. See write_dispatch_metadata() and create_submission_queued_block() in one_shot_dispatch.py.\n\n**writing to /tmp/** → Read [Scratch Storage](scratch-storage.md) first. AI workflow files belong in .erk/scratch/<session-id>/, NOT /tmp/.\n\n**writing verification criteria like 'documentation is complete'** → Read [Context Preservation Patterns](context-preservation-patterns.md) first. Vague verification is unverifiable. Criteria must be testable with grep, file inspection, or running code.\n","numLines":236,"startLine":1,"totalLines":236}}}
{"parentUuid":"b34eef59-5db9-4aa9-9720-471c58a50d0e","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01KAr7zh7wuazy5YFEofVi8K","type":"message","role":"assistant","content":[{"type":"text","text":"I've read all the files. Now I also need to check the source code referenced by the plan for accuracy. Let me read the relevant source files and check for existing docs that might overlap."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4871,"cache_creation_input_tokens":30130,"cache_read_input_tokens":32972,"cache_creation":{"ephemeral_5m_input_tokens":30130,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4dkd6qBSYfHV5L4mj2","type":"assistant","uuid":"273f9d16-3236-4e0e-a08c-2271f9457597","timestamp":"2026-02-21T23:14:22.852Z"}
{"parentUuid":"273f9d16-3236-4e0e-a08c-2271f9457597","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01KAr7zh7wuazy5YFEofVi8K","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AS7DM4LWhCL2Eyqz1bRdVT","name":"TodoWrite","input":{"todos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"in_progress","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"pending","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"pending","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"pending","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"pending","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"pending","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"pending","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4871,"cache_creation_input_tokens":30130,"cache_read_input_tokens":32972,"cache_creation":{"ephemeral_5m_input_tokens":30130,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4dkd6qBSYfHV5L4mj2","type":"assistant","uuid":"385f2500-6c3d-44d4-8ea7-1ae5fcd594b3","timestamp":"2026-02-21T23:14:29.265Z"}
{"parentUuid":"385f2500-6c3d-44d4-8ea7-1ae5fcd594b3","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AS7DM4LWhCL2Eyqz1bRdVT","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"cfe40ce6-11af-4741-8f66-48021dcc2c9b","timestamp":"2026-02-21T23:14:29.289Z","toolUseResult":{"oldTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"pending","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"pending","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"pending","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"pending","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"pending","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"pending","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"pending","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}],"newTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"in_progress","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"pending","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"pending","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"pending","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"pending","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"pending","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"pending","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]}}
{"parentUuid":"cfe40ce6-11af-4741-8f66-48021dcc2c9b","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01MZfV6pcfweUHeGcubobHNU","type":"message","role":"assistant","content":[{"type":"text","text":"Let me check the source code for the session upload mechanism and the worktree pool sync, plus the learn command for backend-aware display patterns."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":5475,"cache_read_input_tokens":63102,"cache_creation":{"ephemeral_5m_input_tokens":5475,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4eUNpuqAhzoa3PbDWN","type":"assistant","uuid":"06293468-4187-42c0-b96d-85ed0d1f99c0","timestamp":"2026-02-21T23:14:32.048Z"}
{"parentUuid":"06293468-4187-42c0-b96d-85ed0d1f99c0","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01MZfV6pcfweUHeGcubobHNU","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QMKeapcTUBHgigdcVhppWN","name":"Task","input":{"description":"Check session upload source","prompt":"Read the file `src/erk/cli/commands/exec/scripts/upload_session.py` and tell me:\n1. Does it still use gist-based storage, or has it been changed to branch-based storage?\n2. What is the current storage mechanism?\n3. Provide the key function names and a brief summary.\n\nWorking directory: /home/runner/work/erk/erk","subagent_type":"Explore","run_in_background":true},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":5475,"cache_read_input_tokens":63102,"cache_creation":{"ephemeral_5m_input_tokens":5475,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4eUNpuqAhzoa3PbDWN","type":"assistant","uuid":"42553cff-b431-47a1-97c1-921d06ea9664","timestamp":"2026-02-21T23:14:35.110Z"}
{"parentUuid":"42553cff-b431-47a1-97c1-921d06ea9664","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01MZfV6pcfweUHeGcubobHNU","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Mu4xTYpqeaa52AkpXKjcnv","name":"Task","input":{"description":"Check worktree pool sync","prompt":"FIRST check docs/learned/index.md for existing documentation on this topic.\nRead relevant docs before exploring raw files.\n\nLook at `src/erk/core/worktree_pool.py` for any sync-related functions. I need to understand:\n1. Is there a lazy sync algorithm?\n2. When does sync run (after pool load, before allocation)?\n3. How does mtime preservation work when no changes?\n4. What edge cases does it handle?\n\nWorking directory: /home/runner/work/erk/erk","subagent_type":"Explore","run_in_background":true},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":5475,"cache_read_input_tokens":63102,"cache_creation":{"ephemeral_5m_input_tokens":5475,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4eUNpuqAhzoa3PbDWN","type":"assistant","uuid":"f773c467-b423-460d-97b8-3ed03645560a","timestamp":"2026-02-21T23:14:39.001Z"}
{"parentUuid":"f773c467-b423-460d-97b8-3ed03645560a","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01MZfV6pcfweUHeGcubobHNU","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01V2Bz3DmA4Nxa72Ruigs4pX","name":"Task","input":{"description":"Check learn cmd backend routing","prompt":"FIRST check docs/learned/index.md for existing documentation on this topic.\nRead relevant docs before exploring raw files.\n\nRead `src/erk/cli/commands/learn/learn_cmd.py` and look for backend-aware display patterns, specifically:\n1. How does it route between `gh issue view` vs `gh pr view`?\n2. How does it use `plan_backend` or backend type to determine behavior?\n3. What terminology differences exist (\"draft PR\" vs \"issue\")?\n\nAlso check if `docs/learned/tui/backend-aware-commands.md` exists and what patterns it documents.\n\nWorking directory: /home/runner/work/erk/erk","subagent_type":"Explore","run_in_background":true},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":5475,"cache_read_input_tokens":63102,"cache_creation":{"ephemeral_5m_input_tokens":5475,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4eUNpuqAhzoa3PbDWN","type":"assistant","uuid":"122e1d98-2748-4d83-ac7d-995d0b631afc","timestamp":"2026-02-21T23:14:42.886Z"}
{"parentUuid":"122e1d98-2748-4d83-ac7d-995d0b631afc","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01MZfV6pcfweUHeGcubobHNU","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GvDDJWyUrLdGZhGVmXg75H","name":"Task","input":{"description":"Check naming.py for branch prefix","prompt":"Read `packages/erk-shared/src/erk_shared/naming.py` and find the `generate_draft_pr_branch_name` function. What prefix does it use - `plan-` or `planned/`? \n\nAlso check `docs/learned/erk/branch-naming.md` lines 50-62 to confirm the actual prefix convention.\n\nWorking directory: /home/runner/work/erk/erk","subagent_type":"Explore","run_in_background":true},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":5475,"cache_read_input_tokens":63102,"cache_creation":{"ephemeral_5m_input_tokens":5475,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4eUNpuqAhzoa3PbDWN","type":"assistant","uuid":"82189a8f-c7b5-4ec4-b73e-0f63a48e1074","timestamp":"2026-02-21T23:14:45.506Z"}
{"parentUuid":"82189a8f-c7b5-4ec4-b73e-0f63a48e1074","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QMKeapcTUBHgigdcVhppWN","type":"tool_result","content":[{"type":"text","text":"Async agent launched successfully.\nagentId: a5ada53 (This is an internal ID for your use, do not mention it to the user. Use this ID to retrieve results with TaskOutput when the agent finishes).\nThe agent is currently working in the background. If you have other tasks you you should continue working on them now. Wait to call TaskOutput until either:\n- If you want to check on the agent's progress - call TaskOutput with block=false to get an immediate update on the agent's status\n- If you run out of things to do and the agent is still running - call TaskOutput with block=true to idle and wait for the agent's result (do not use block=true unless you completely run out of things to do as it will waste time)."}]}]},"uuid":"8ccabe66-32fa-4b2f-a567-8960e9ca3c7a","timestamp":"2026-02-21T23:14:45.551Z","toolUseResult":{"isAsync":true,"status":"async_launched","agentId":"a5ada53","description":"Check session upload source","prompt":"Read the file `src/erk/cli/commands/exec/scripts/upload_session.py` and tell me:\n1. Does it still use gist-based storage, or has it been changed to branch-based storage?\n2. What is the current storage mechanism?\n3. Provide the key function names and a brief summary.\n\nWorking directory: /home/runner/work/erk/erk","outputFile":"/tmp/claude/tasks/a5ada53.output"}}
{"parentUuid":"8ccabe66-32fa-4b2f-a567-8960e9ca3c7a","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Mu4xTYpqeaa52AkpXKjcnv","type":"tool_result","content":[{"type":"text","text":"Async agent launched successfully.\nagentId: a3660da (This is an internal ID for your use, do not mention it to the user. Use this ID to retrieve results with TaskOutput when the agent finishes).\nThe agent is currently working in the background. If you have other tasks you you should continue working on them now. Wait to call TaskOutput until either:\n- If you want to check on the agent's progress - call TaskOutput with block=false to get an immediate update on the agent's status\n- If you run out of things to do and the agent is still running - call TaskOutput with block=true to idle and wait for the agent's result (do not use block=true unless you completely run out of things to do as it will waste time)."}]}]},"uuid":"57f060f2-3592-4577-a7dc-7f745cdfef43","timestamp":"2026-02-21T23:14:45.554Z","toolUseResult":{"isAsync":true,"status":"async_launched","agentId":"a3660da","description":"Check worktree pool sync","prompt":"FIRST check docs/learned/index.md for existing documentation on this topic.\nRead relevant docs before exploring raw files.\n\nLook at `src/erk/core/worktree_pool.py` for any sync-related functions. I need to understand:\n1. Is there a lazy sync algorithm?\n2. When does sync run (after pool load, before allocation)?\n3. How does mtime preservation work when no changes?\n4. What edge cases does it handle?\n\nWorking directory: /home/runner/work/erk/erk","outputFile":"/tmp/claude/tasks/a3660da.output"}}
{"parentUuid":"57f060f2-3592-4577-a7dc-7f745cdfef43","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01V2Bz3DmA4Nxa72Ruigs4pX","type":"tool_result","content":[{"type":"text","text":"Async agent launched successfully.\nagentId: a426311 (This is an internal ID for your use, do not mention it to the user. Use this ID to retrieve results with TaskOutput when the agent finishes).\nThe agent is currently working in the background. If you have other tasks you you should continue working on them now. Wait to call TaskOutput until either:\n- If you want to check on the agent's progress - call TaskOutput with block=false to get an immediate update on the agent's status\n- If you run out of things to do and the agent is still running - call TaskOutput with block=true to idle and wait for the agent's result (do not use block=true unless you completely run out of things to do as it will waste time)."}]}]},"uuid":"4899f8ea-8167-444b-a176-9edcc58ab534","timestamp":"2026-02-21T23:14:45.559Z","toolUseResult":{"isAsync":true,"status":"async_launched","agentId":"a426311","description":"Check learn cmd backend routing","prompt":"FIRST check docs/learned/index.md for existing documentation on this topic.\nRead relevant docs before exploring raw files.\n\nRead `src/erk/cli/commands/learn/learn_cmd.py` and look for backend-aware display patterns, specifically:\n1. How does it route between `gh issue view` vs `gh pr view`?\n2. How does it use `plan_backend` or backend type to determine behavior?\n3. What terminology differences exist (\"draft PR\" vs \"issue\")?\n\nAlso check if `docs/learned/tui/backend-aware-commands.md` exists and what patterns it documents.\n\nWorking directory: /home/runner/work/erk/erk","outputFile":"/tmp/claude/tasks/a426311.output"}}
{"parentUuid":"4899f8ea-8167-444b-a176-9edcc58ab534","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GvDDJWyUrLdGZhGVmXg75H","type":"tool_result","content":[{"type":"text","text":"Async agent launched successfully.\nagentId: a18c6d8 (This is an internal ID for your use, do not mention it to the user. Use this ID to retrieve results with TaskOutput when the agent finishes).\nThe agent is currently working in the background. If you have other tasks you you should continue working on them now. Wait to call TaskOutput until either:\n- If you want to check on the agent's progress - call TaskOutput with block=false to get an immediate update on the agent's status\n- If you run out of things to do and the agent is still running - call TaskOutput with block=true to idle and wait for the agent's result (do not use block=true unless you completely run out of things to do as it will waste time)."}]}]},"uuid":"a311eb27-8921-4f9f-821c-30d22bae764c","timestamp":"2026-02-21T23:14:45.561Z","toolUseResult":{"isAsync":true,"status":"async_launched","agentId":"a18c6d8","description":"Check naming.py for branch prefix","prompt":"Read `packages/erk-shared/src/erk_shared/naming.py` and find the `generate_draft_pr_branch_name` function. What prefix does it use - `plan-` or `planned/`? \n\nAlso check `docs/learned/erk/branch-naming.md` lines 50-62 to confirm the actual prefix convention.\n\nWorking directory: /home/runner/work/erk/erk","outputFile":"/tmp/claude/tasks/a18c6d8.output"}}
{"parentUuid":"a311eb27-8921-4f9f-821c-30d22bae764c","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01FiSQhxopFYLMxrkFpt64NP","type":"message","role":"assistant","content":[{"type":"text","text":"While those agents are running, let me also check the `draft-pr-learn-pipeline.md` and existing `backend-aware-commands.md` to understand what's already documented:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1673,"cache_read_input_tokens":68577,"cache_creation":{"ephemeral_5m_input_tokens":1673,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4fgAGZV1z8o4j522U9","type":"assistant","uuid":"2d90ca2d-da4e-42a5-8ef9-2b8aff0d3136","timestamp":"2026-02-21T23:14:48.788Z"}
{"parentUuid":"2d90ca2d-da4e-42a5-8ef9-2b8aff0d3136","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01FiSQhxopFYLMxrkFpt64NP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011S4pUyeSPBpvG35Rn4XDgo","name":"Glob","input":{"pattern":"docs/learned/**/draft-pr-learn-pipeline.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1673,"cache_read_input_tokens":68577,"cache_creation":{"ephemeral_5m_input_tokens":1673,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4fgAGZV1z8o4j522U9","type":"assistant","uuid":"6445bd7a-b4e0-4e3f-8ae3-db8acf02d863","timestamp":"2026-02-21T23:14:49.255Z"}
{"parentUuid":"6445bd7a-b4e0-4e3f-8ae3-db8acf02d863","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01FiSQhxopFYLMxrkFpt64NP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012z3mXXj7723CnnYPN6nrod","name":"Glob","input":{"pattern":"docs/learned/**/backend-aware*.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1673,"cache_read_input_tokens":68577,"cache_creation":{"ephemeral_5m_input_tokens":1673,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4fgAGZV1z8o4j522U9","type":"assistant","uuid":"58dbbc91-4f1a-4378-8c1d-18bfc8491f2e","timestamp":"2026-02-21T23:14:49.508Z"}
{"parentUuid":"58dbbc91-4f1a-4378-8c1d-18bfc8491f2e","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011S4pUyeSPBpvG35Rn4XDgo","type":"tool_result","content":"/home/runner/work/erk/erk/docs/learned/planning/draft-pr-learn-pipeline.md"}]},"uuid":"6c1e58a8-ab14-4709-afb2-8019950cfd05","timestamp":"2026-02-21T23:14:50.109Z","toolUseResult":{"filenames":["/home/runner/work/erk/erk/docs/learned/planning/draft-pr-learn-pipeline.md"],"durationMs":585,"numFiles":1,"truncated":false}}
{"parentUuid":"6c1e58a8-ab14-4709-afb2-8019950cfd05","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012z3mXXj7723CnnYPN6nrod","type":"tool_result","content":"/home/runner/work/erk/erk/docs/learned/tui/backend-aware-commands.md"}]},"uuid":"2f4830df-c536-4687-9ba6-3cc0f799157e","timestamp":"2026-02-21T23:14:50.111Z","toolUseResult":{"filenames":["/home/runner/work/erk/erk/docs/learned/tui/backend-aware-commands.md"],"durationMs":587,"numFiles":1,"truncated":false}}
{"type":"queue-operation","operation":"enqueue","timestamp":"2026-02-21T23:14:50.757Z","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","content":"<agent-notification>\n<agent-id>a18c6d8</agent-id>\n<output-file>/tmp/claude/tasks/a18c6d8.output</output-file>\n<status>completed</status>\n<summary>Agent \"Check naming.py for branch prefix\" completed.</summary>\nRead the output file to retrieve the full result.\n</agent-notification>"}
{"type":"queue-operation","operation":"remove","timestamp":"2026-02-21T23:14:51.025Z","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce"}
{"type":"queue-operation","operation":"remove","timestamp":"2026-02-21T23:14:51.538Z","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce"}
{"type":"queue-operation","operation":"enqueue","timestamp":"2026-02-21T23:14:51.785Z","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","content":"<agent-notification>\n<agent-id>a5ada53</agent-id>\n<output-file>/tmp/claude/tasks/a5ada53.output</output-file>\n<status>completed</status>\n<summary>Agent \"Check session upload source\" completed.</summary>\nRead the output file to retrieve the full result.\n</agent-notification>"}
{"parentUuid":"2f4830df-c536-4687-9ba6-3cc0f799157e","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_016igfFnnDMWrCaq8K7ey3L8","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014xSqK9QrkQpwSxdoyYwW9U","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/tui/backend-aware-commands.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":815,"cache_read_input_tokens":70250,"cache_creation":{"ephemeral_5m_input_tokens":815,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4g1PfAVHPrmrqQLYVM","type":"assistant","uuid":"4131cb58-ee3d-4e08-b887-343a2fbc1ade","timestamp":"2026-02-21T23:14:52.203Z"}
{"parentUuid":"4131cb58-ee3d-4e08-b887-343a2fbc1ade","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014xSqK9QrkQpwSxdoyYwW9U","type":"tool_result","content":"     1→---\n     2→title: Backend-Aware TUI Commands\n     3→read_when:\n     4→  - \"adding new TUI commands to the command palette\"\n     5→  - \"debugging why a command is not visible in the command palette\"\n     6→  - \"understanding which commands are hidden in draft-PR mode\"\n     7→tripwires:\n     8→  - action: \"adding a new TUI command that should only show in certain plan backends\"\n     9→    warning: \"Commands have THREE filter dimensions: view mode, data availability, AND plan backend. If the command is backend-specific, add _is_github_backend() or a similar predicate to is_available. See backend-aware-commands.md.\"\n    10→    score: 8\n    11→---\n    12→\n    13→# Backend-Aware TUI Commands\n    14→\n    15→The TUI command palette filters commands along three independent dimensions:\n    16→\n    17→1. **View mode** — Which view is active (plans, learn, objectives). Checked via `_is_plan_view()`, `_is_objectives_view()`, etc.\n    18→2. **Data availability** — Whether required data exists (e.g., a PR URL, an issue number). Checked in `is_available` lambda.\n    19→3. **Plan backend** — Which plan backend is active (`github` vs `github-draft-pr`). Checked via `_is_github_backend()`.\n    20→\n    21→Missing any dimension means a command can appear when it shouldn't, or be invisible when it should be visible.\n    22→\n    23→## `_is_github_backend()` Predicate\n    24→\n    25→<!-- Source: src/erk/tui/commands/registry.py:31-33, _is_github_backend -->\n    26→\n    27→The function checks `ctx.plan_backend == \"github\"` and returns `True` for issue-based plans. See `src/erk/tui/commands/registry.py:31-33` for the implementation.\n    28→\n    29→The `plan_backend` field is a `PlanBackendType` value (`\"github\"` or `\"github-draft-pr\"`).\n    30→\n    31→## `CommandContext` with `plan_backend`\n    32→\n    33→<!-- Source: src/erk/tui/commands/types.py:23-35, CommandContext -->\n    34→\n    35→The `CommandContext` frozen dataclass at `src/erk/tui/commands/types.py:23-35` carries `row`, `view_mode`, and `plan_backend` fields. The `plan_backend` field is set from the app's active backend configuration and passed to every command's `is_available` and `get_display_name` functions.\n    36→\n    37→## Commands Hidden in `draft_pr` Mode\n    38→\n    39→Two commands are hidden when the backend is `github-draft-pr`:\n    40→\n    41→| Command ID              | Shortcut | Reason hidden in draft-PR mode                              |\n    42→| ----------------------- | -------- | ----------------------------------------------------------- |\n    43→| `copy_prepare`          | `1`      | \"Prepare\" uses issue numbers; draft-PR uses branch checkout |\n    44→| `copy_prepare_activate` | `4`      | Same reason — prepare workflow doesn't apply to draft-PR    |\n    45→\n    46→**Registry entry pattern** (`registry.py:314-329`):\n    47→\n    48→<!-- Source: src/erk/tui/commands/registry.py:319, copy_prepare command -->\n    49→\n    50→The `is_available` lambda combines `_is_plan_view(ctx) and _is_github_backend(ctx)`. See `registry.py:319` for the exact expression.\n    51→\n    52→## Adding Backend-Filtered Commands\n    53→\n    54→When adding a command that should only appear in one backend:\n    55→\n    56→1. Use `_is_github_backend(ctx)` in `is_available` for issue-only commands\n    57→2. Use `not _is_github_backend(ctx)` for draft-PR-only commands\n    58→3. Combine with view mode checks: `_is_plan_view(ctx) and _is_github_backend(ctx)`\n    59→\n    60→## Related Documentation\n    61→\n    62→- [View-Aware Commands](view-aware-commands.md) — The first two filter dimensions\n    63→- [Adding Commands](adding-commands.md) — Full guide for adding commands to the palette\n    64→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"70dc2fdf-1dca-4f0e-bd80-fab2194be9db","timestamp":"2026-02-21T23:14:52.216Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/docs/learned/tui/backend-aware-commands.md","content":"---\ntitle: Backend-Aware TUI Commands\nread_when:\n  - \"adding new TUI commands to the command palette\"\n  - \"debugging why a command is not visible in the command palette\"\n  - \"understanding which commands are hidden in draft-PR mode\"\ntripwires:\n  - action: \"adding a new TUI command that should only show in certain plan backends\"\n    warning: \"Commands have THREE filter dimensions: view mode, data availability, AND plan backend. If the command is backend-specific, add _is_github_backend() or a similar predicate to is_available. See backend-aware-commands.md.\"\n    score: 8\n---\n\n# Backend-Aware TUI Commands\n\nThe TUI command palette filters commands along three independent dimensions:\n\n1. **View mode** — Which view is active (plans, learn, objectives). Checked via `_is_plan_view()`, `_is_objectives_view()`, etc.\n2. **Data availability** — Whether required data exists (e.g., a PR URL, an issue number). Checked in `is_available` lambda.\n3. **Plan backend** — Which plan backend is active (`github` vs `github-draft-pr`). Checked via `_is_github_backend()`.\n\nMissing any dimension means a command can appear when it shouldn't, or be invisible when it should be visible.\n\n## `_is_github_backend()` Predicate\n\n<!-- Source: src/erk/tui/commands/registry.py:31-33, _is_github_backend -->\n\nThe function checks `ctx.plan_backend == \"github\"` and returns `True` for issue-based plans. See `src/erk/tui/commands/registry.py:31-33` for the implementation.\n\nThe `plan_backend` field is a `PlanBackendType` value (`\"github\"` or `\"github-draft-pr\"`).\n\n## `CommandContext` with `plan_backend`\n\n<!-- Source: src/erk/tui/commands/types.py:23-35, CommandContext -->\n\nThe `CommandContext` frozen dataclass at `src/erk/tui/commands/types.py:23-35` carries `row`, `view_mode`, and `plan_backend` fields. The `plan_backend` field is set from the app's active backend configuration and passed to every command's `is_available` and `get_display_name` functions.\n\n## Commands Hidden in `draft_pr` Mode\n\nTwo commands are hidden when the backend is `github-draft-pr`:\n\n| Command ID              | Shortcut | Reason hidden in draft-PR mode                              |\n| ----------------------- | -------- | ----------------------------------------------------------- |\n| `copy_prepare`          | `1`      | \"Prepare\" uses issue numbers; draft-PR uses branch checkout |\n| `copy_prepare_activate` | `4`      | Same reason — prepare workflow doesn't apply to draft-PR    |\n\n**Registry entry pattern** (`registry.py:314-329`):\n\n<!-- Source: src/erk/tui/commands/registry.py:319, copy_prepare command -->\n\nThe `is_available` lambda combines `_is_plan_view(ctx) and _is_github_backend(ctx)`. See `registry.py:319` for the exact expression.\n\n## Adding Backend-Filtered Commands\n\nWhen adding a command that should only appear in one backend:\n\n1. Use `_is_github_backend(ctx)` in `is_available` for issue-only commands\n2. Use `not _is_github_backend(ctx)` for draft-PR-only commands\n3. Combine with view mode checks: `_is_plan_view(ctx) and _is_github_backend(ctx)`\n\n## Related Documentation\n\n- [View-Aware Commands](view-aware-commands.md) — The first two filter dimensions\n- [Adding Commands](adding-commands.md) — Full guide for adding commands to the palette\n","numLines":64,"startLine":1,"totalLines":64}}}
{"type":"queue-operation","operation":"remove","timestamp":"2026-02-21T23:14:52.221Z","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce"}
{"type":"queue-operation","operation":"remove","timestamp":"2026-02-21T23:14:52.221Z","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce"}
{"parentUuid":"70dc2fdf-1dca-4f0e-bd80-fab2194be9db","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_012T1hEePVTTCSJtwSGcCzGt","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me retrieve results from the background agents:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1294,"cache_read_input_tokens":71065,"cache_creation":{"ephemeral_5m_input_tokens":1294,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4gAPQAcKuPYqF3SpyS","type":"assistant","uuid":"f4895e33-f3ae-4f32-9d34-f5ce4fade090","timestamp":"2026-02-21T23:14:54.324Z"}
{"parentUuid":"f4895e33-f3ae-4f32-9d34-f5ce4fade090","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_012T1hEePVTTCSJtwSGcCzGt","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CL56xCyhtpy27h5M5y8cSs","name":"TaskOutput","input":{"task_id":"a5ada53","block":true,"timeout":30000},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1294,"cache_read_input_tokens":71065,"cache_creation":{"ephemeral_5m_input_tokens":1294,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4gAPQAcKuPYqF3SpyS","type":"assistant","uuid":"6c24ceaf-057a-4e5a-a0ef-cb343791c48e","timestamp":"2026-02-21T23:14:54.841Z"}
{"parentUuid":"6c24ceaf-057a-4e5a-a0ef-cb343791c48e","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_012T1hEePVTTCSJtwSGcCzGt","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TWKi5HBoxmocMQA5s5j276","name":"TaskOutput","input":{"task_id":"a18c6d8","block":true,"timeout":30000},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1294,"cache_read_input_tokens":71065,"cache_creation":{"ephemeral_5m_input_tokens":1294,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4gAPQAcKuPYqF3SpyS","type":"assistant","uuid":"813bc011-e762-4b2b-853f-f6b4ea49eeb3","timestamp":"2026-02-21T23:14:55.286Z"}
{"parentUuid":"813bc011-e762-4b2b-853f-f6b4ea49eeb3","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CL56xCyhtpy27h5M5y8cSs","type":"tool_result","content":"<retrieval_status>success</retrieval_status>\n\n<task_id>a5ada53</task_id>\n\n<task_type>local_agent</task_type>\n\n<status>completed</status>\n\n<output>\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/exec/scripts/upload_session.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/exec/scripts/upload_session.py\"}\n\n--- RESULT ---\nBased on my analysis of the file, here are the answers to your questions:\n\n## 1. Storage Mechanism: Branch-Based (NOT Gist-Based)\n\nThe file **has been changed to branch-based storage**. The code no longer uses gists—it uses git branches to store sessions.\n\n## 2. Current Storage Mechanism\n\n**Branch-based storage with the following characteristics:**\n\n- Creates a branch named `session/{plan_id}` from `origin/master`\n- Commits the session JSONL file to `.erk/session/{session_id}.jsonl` on that branch\n- Force-pushes the branch to origin\n- Updates plan metadata with branch information (last_session_branch, last_session_id, last_session_at, last_session_source)\n\n## 3. Key Functions and Summary\n\n| Function | Purpose |\n|----------|---------|\n| **`upload_session()`** | Main Click command that orchestrates the entire upload workflow |\n| **`git.branch.create_branch()`** | Creates the session branch from origin/master |\n| **`git.commit.stage_files()`** | Stages the session JSONL file |\n| **`git.commit.commit()`** | Commits with a descriptive message |\n| **`git.remote.push_to_remote()`** | Force-pushes the branch upstream |\n| **`backend.update_metadata()`** | Updates the plan metadata in the backend |\n\n**Workflow Summary:**\n1. Validates plan_id is provided\n2. Creates/deletes a `session/{plan_id}` branch from origin/master\n3. Copies the session JSONL file to `.erk/session/{session_id}.jsonl`\n4. Commits and force-pushes to origin\n5. Updates plan metadata with session branch information and timestamp\n6. Returns structured JSON with success status and metadata\n\nThe command uses **LBYL error handling** (check before use) to verify the plan exists before updating metadata, following erk conventions.\n</output>"}]},"uuid":"2c7d871c-fe9f-4916-ab0c-3cf7d10bb551","timestamp":"2026-02-21T23:14:55.309Z","toolUseResult":{"retrieval_status":"success","task":{"task_id":"a5ada53","task_type":"local_agent","status":"completed","description":"Check session upload source","output":"[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/exec/scripts/upload_session.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/exec/scripts/upload_session.py\"}\n\n--- RESULT ---\nBased on my analysis of the file, here are the answers to your questions:\n\n## 1. Storage Mechanism: Branch-Based (NOT Gist-Based)\n\nThe file **has been changed to branch-based storage**. The code no longer uses gists—it uses git branches to store sessions.\n\n## 2. Current Storage Mechanism\n\n**Branch-based storage with the following characteristics:**\n\n- Creates a branch named `session/{plan_id}` from `origin/master`\n- Commits the session JSONL file to `.erk/session/{session_id}.jsonl` on that branch\n- Force-pushes the branch to origin\n- Updates plan metadata with branch information (last_session_branch, last_session_id, last_session_at, last_session_source)\n\n## 3. Key Functions and Summary\n\n| Function | Purpose |\n|----------|---------|\n| **`upload_session()`** | Main Click command that orchestrates the entire upload workflow |\n| **`git.branch.create_branch()`** | Creates the session branch from origin/master |\n| **`git.commit.stage_files()`** | Stages the session JSONL file |\n| **`git.commit.commit()`** | Commits with a descriptive message |\n| **`git.remote.push_to_remote()`** | Force-pushes the branch upstream |\n| **`backend.update_metadata()`** | Updates the plan metadata in the backend |\n\n**Workflow Summary:**\n1. Validates plan_id is provided\n2. Creates/deletes a `session/{plan_id}` branch from origin/master\n3. Copies the session JSONL file to `.erk/session/{session_id}.jsonl`\n4. Commits and force-pushes to origin\n5. Updates plan metadata with session branch information and timestamp\n6. Returns structured JSON with success status and metadata\n\nThe command uses **LBYL error handling** (check before use) to verify the plan exists before updating metadata, following erk conventions.\n","prompt":"Read the file `src/erk/cli/commands/exec/scripts/upload_session.py` and tell me:\n1. Does it still use gist-based storage, or has it been changed to branch-based storage?\n2. What is the current storage mechanism?\n3. Provide the key function names and a brief summary.\n\nWorking directory: /home/runner/work/erk/erk","result":"[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/exec/scripts/upload_session.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/exec/scripts/upload_session.py\"}\n\n--- RESULT ---\nBased on my analysis of the file, here are the answers to your questions:\n\n## 1. Storage Mechanism: Branch-Based (NOT Gist-Based)\n\nThe file **has been changed to branch-based storage**. The code no longer uses gists—it uses git branches to store sessions.\n\n## 2. Current Storage Mechanism\n\n**Branch-based storage with the following characteristics:**\n\n- Creates a branch named `session/{plan_id}` from `origin/master`\n- Commits the session JSONL file to `.erk/session/{session_id}.jsonl` on that branch\n- Force-pushes the branch to origin\n- Updates plan metadata with branch information (last_session_branch, last_session_id, last_session_at, last_session_source)\n\n## 3. Key Functions and Summary\n\n| Function | Purpose |\n|----------|---------|\n| **`upload_session()`** | Main Click command that orchestrates the entire upload workflow |\n| **`git.branch.create_branch()`** | Creates the session branch from origin/master |\n| **`git.commit.stage_files()`** | Stages the session JSONL file |\n| **`git.commit.commit()`** | Commits with a descriptive message |\n| **`git.remote.push_to_remote()`** | Force-pushes the branch upstream |\n| **`backend.update_metadata()`** | Updates the plan metadata in the backend |\n\n**Workflow Summary:**\n1. Validates plan_id is provided\n2. Creates/deletes a `session/{plan_id}` branch from origin/master\n3. Copies the session JSONL file to `.erk/session/{session_id}.jsonl`\n4. Commits and force-pushes to origin\n5. Updates plan metadata with session branch information and timestamp\n6. Returns structured JSON with success status and metadata\n\nThe command uses **LBYL error handling** (check before use) to verify the plan exists before updating metadata, following erk conventions.\n"}}}
{"parentUuid":"2c7d871c-fe9f-4916-ab0c-3cf7d10bb551","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TWKi5HBoxmocMQA5s5j276","type":"tool_result","content":"<retrieval_status>success</retrieval_status>\n\n<task_id>a18c6d8</task_id>\n\n<task_type>local_agent</task_type>\n\n<status>completed</status>\n\n<output>\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/packages/erk-shared/src/erk_shared/naming.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/docs/learned/erk/branch-naming.md\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/docs/learned/erk/branch-naming.md\"}\n\n--- RESULT ---\nBased on my analysis of the code and documentation:\n\n## Answer\n\nThe `generate_draft_pr_branch_name` function uses the prefix **`planned/`** (with a slash, not a hyphen).\n\n**From the code** (line 642 in `/home/runner/work/erk/erk/packages/erk-shared/src/erk_shared/naming.py`):\n\n```python\ndef generate_draft_pr_branch_name(\n    title: str,\n    timestamp: datetime,\n    *,\n    objective_id: int | None,\n) -> str:\n    \"\"\"Generate branch name for draft-PR-backed plans.\n    \n    Format: planned/{sanitized_title}-{timestamp}\n    Or with objective: planned/O{objective_id}-{sanitized_title}-{timestamp}\n    Example: planned/fix-auth-bug-01-15-1430\n    Example with objective: planned/O456-fix-auth-bug-01-15-1430\n    \"\"\"\n    prefix = \"planned/\"  # <-- HERE\n```\n\n**Documentation confirmation** (lines 50-62 in `/home/runner/work/erk/erk/docs/learned/erk/branch-naming.md`):\n\n```markdown\n### Draft-PR Branches\n\n**Without objective:**\n\n```\nplanned/{slug}-{MM-DD-HHMM}\n```\n\n**With objective:**\n\n```\nplanned/O{objective}-{slug}-{MM-DD-HHMM}\n```\n\n**Examples:**\n\n- `planned/fix-auth-bug-01-15-1430`\n- `planned/O456-fix-auth-bug-01-15-1430`\n```\n\nBoth the implementation and documentation are consistent: the prefix is **`planned/`** (not `plan-` or `plan/`).\n</output>"}]},"uuid":"24be2b62-bbec-4d7d-98a5-c3e747452c43","timestamp":"2026-02-21T23:14:55.309Z","toolUseResult":{"retrieval_status":"success","task":{"task_id":"a18c6d8","task_type":"local_agent","status":"completed","description":"Check naming.py for branch prefix","output":"[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/packages/erk-shared/src/erk_shared/naming.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/docs/learned/erk/branch-naming.md\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/docs/learned/erk/branch-naming.md\"}\n\n--- RESULT ---\nBased on my analysis of the code and documentation:\n\n## Answer\n\nThe `generate_draft_pr_branch_name` function uses the prefix **`planned/`** (with a slash, not a hyphen).\n\n**From the code** (line 642 in `/home/runner/work/erk/erk/packages/erk-shared/src/erk_shared/naming.py`):\n\n```python\ndef generate_draft_pr_branch_name(\n    title: str,\n    timestamp: datetime,\n    *,\n    objective_id: int | None,\n) -> str:\n    \"\"\"Generate branch name for draft-PR-backed plans.\n    \n    Format: planned/{sanitized_title}-{timestamp}\n    Or with objective: planned/O{objective_id}-{sanitized_title}-{timestamp}\n    Example: planned/fix-auth-bug-01-15-1430\n    Example with objective: planned/O456-fix-auth-bug-01-15-1430\n    \"\"\"\n    prefix = \"planned/\"  # <-- HERE\n```\n\n**Documentation confirmation** (lines 50-62 in `/home/runner/work/erk/erk/docs/learned/erk/branch-naming.md`):\n\n```markdown\n### Draft-PR Branches\n\n**Without objective:**\n\n```\nplanned/{slug}-{MM-DD-HHMM}\n```\n\n**With objective:**\n\n```\nplanned/O{objective}-{slug}-{MM-DD-HHMM}\n```\n\n**Examples:**\n\n- `planned/fix-auth-bug-01-15-1430`\n- `planned/O456-fix-auth-bug-01-15-1430`\n```\n\nBoth the implementation and documentation are consistent: the prefix is **`planned/`** (not `plan-` or `plan/`).\n","prompt":"Read `packages/erk-shared/src/erk_shared/naming.py` and find the `generate_draft_pr_branch_name` function. What prefix does it use - `plan-` or `planned/`? \n\nAlso check `docs/learned/erk/branch-naming.md` lines 50-62 to confirm the actual prefix convention.\n\nWorking directory: /home/runner/work/erk/erk","result":"[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/packages/erk-shared/src/erk_shared/naming.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/docs/learned/erk/branch-naming.md\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/docs/learned/erk/branch-naming.md\"}\n\n--- RESULT ---\nBased on my analysis of the code and documentation:\n\n## Answer\n\nThe `generate_draft_pr_branch_name` function uses the prefix **`planned/`** (with a slash, not a hyphen).\n\n**From the code** (line 642 in `/home/runner/work/erk/erk/packages/erk-shared/src/erk_shared/naming.py`):\n\n```python\ndef generate_draft_pr_branch_name(\n    title: str,\n    timestamp: datetime,\n    *,\n    objective_id: int | None,\n) -> str:\n    \"\"\"Generate branch name for draft-PR-backed plans.\n    \n    Format: planned/{sanitized_title}-{timestamp}\n    Or with objective: planned/O{objective_id}-{sanitized_title}-{timestamp}\n    Example: planned/fix-auth-bug-01-15-1430\n    Example with objective: planned/O456-fix-auth-bug-01-15-1430\n    \"\"\"\n    prefix = \"planned/\"  # <-- HERE\n```\n\n**Documentation confirmation** (lines 50-62 in `/home/runner/work/erk/erk/docs/learned/erk/branch-naming.md`):\n\n```markdown\n### Draft-PR Branches\n\n**Without objective:**\n\n```\nplanned/{slug}-{MM-DD-HHMM}\n```\n\n**With objective:**\n\n```\nplanned/O{objective}-{slug}-{MM-DD-HHMM}\n```\n\n**Examples:**\n\n- `planned/fix-auth-bug-01-15-1430`\n- `planned/O456-fix-auth-bug-01-15-1430`\n```\n\nBoth the implementation and documentation are consistent: the prefix is **`planned/`** (not `plan-` or `plan/`).\n"}}}
{"parentUuid":"24be2b62-bbec-4d7d-98a5-c3e747452c43","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_016QmLnrxhGfNDi9xJ1VkWQZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013wzH7HaDyycUyK1t5KswTB","name":"TaskOutput","input":{"task_id":"a3660da","block":true,"timeout":30000},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1896,"cache_read_input_tokens":72359,"cache_creation":{"ephemeral_5m_input_tokens":1896,"ephemeral_1h_input_tokens":0},"output_tokens":19,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4gPcdZorDmJGDkCCHj","type":"assistant","uuid":"7c0e29e1-94ac-441f-923d-8698413fadfe","timestamp":"2026-02-21T23:14:57.530Z"}
{"parentUuid":"7c0e29e1-94ac-441f-923d-8698413fadfe","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_016QmLnrxhGfNDi9xJ1VkWQZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01C7864WaCPheMS6LNEQPPqv","name":"TaskOutput","input":{"task_id":"a426311","block":true,"timeout":30000},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1896,"cache_read_input_tokens":72359,"cache_creation":{"ephemeral_5m_input_tokens":1896,"ephemeral_1h_input_tokens":0},"output_tokens":19,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4gPcdZorDmJGDkCCHj","type":"assistant","uuid":"9e9eff30-079f-4b55-9f00-88ea2348237b","timestamp":"2026-02-21T23:14:57.961Z"}
{"type":"queue-operation","operation":"enqueue","timestamp":"2026-02-21T23:15:20.684Z","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","content":"<agent-notification>\n<agent-id>a426311</agent-id>\n<output-file>/tmp/claude/tasks/a426311.output</output-file>\n<status>completed</status>\n<summary>Agent \"Check learn cmd backend routing\" completed.</summary>\nRead the output file to retrieve the full result.\n</agent-notification>"}
{"parentUuid":"9e9eff30-079f-4b55-9f00-88ea2348237b","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01C7864WaCPheMS6LNEQPPqv","type":"tool_result","content":"<retrieval_status>success</retrieval_status>\n\n<task_id>a426311</task_id>\n\n<task_type>local_agent</task_type>\n\n<status>completed</status>\n\n<output>\n[Tool: Grep] {\"pattern\":\"backend\",\"path\":\"/home/runner/work/erk/erk/docs/learned\",\"glob\":\"*.md\",\"output_mode\":\"files_with_matches\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/learn/learn_cmd.py\"}\n[Tool: Glob] {\"pattern\":\"docs/learned/tui/backend-aware-commands.md\"}\n[Tool: Glob] {\"pattern\":\"docs/learned/tui/backend-aware-commands.md\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/docs/learned/tui/backend-aware-commands.md\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/docs/learned/tui/view-aware-commands.md\"}\n[Tool: Grep] {\"pattern\":\"gh (issue|pr) view\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/learn\",\"output_mode\":\"content\",\"type\":\"py\"}\n[Tool: Grep] {\"pattern\":\"gh (issue|pr) view\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/learn\",\"output_mode\":\"content\",\"type\":\"py\"}\n[Tool: Grep] {\"pattern\":\"plan_backend|github|draft\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/learn\",\"output_mode\":\"content\",\"type\":\"py\"}\n[Tool: Glob] {\"pattern\":\"src/erk/cli/commands/**/*view*.py\"}\n[Tool: Grep] {\"pattern\":\"issue view|pr view\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli\",\"output_mode\":\"files_with_matches\",\"type\":\"py\"}\n[Tool: Grep] {\"pattern\":\"issue view|pr view\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli\",\"output_mode\":\"files_with_matches\",\"type\":\"py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/plan/view.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/objective/view_cmd.py\"}\n[Tool: Grep] {\"pattern\":\"plan_backend|PlanBackendType\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/plan\",\"output_mode\":\"files_with_matches\",\"type\":\"py\"}\n[Tool: Grep] {\"pattern\":\"plan_backend|PlanBackendType\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/plan\",\"output_mode\":\"files_with_matches\",\"type\":\"py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/docs/learned/planning/draft-pr-plan-backend.md\"}\n[Tool: Grep] {\"pattern\":\"draft|github.*backend|plan_backend\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/learn/learn_cmd.py\",\"output_mode\":\"content\"}\n[Tool: Grep] {\"pattern\":\"draft|github.*backend|plan_backend\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/learn/learn_cmd.py\",\"output_mode\":\"content\"}\n[Tool: Bash] {\"command\":\"grep -r \\\"github.*backend\\\\|plan_backend\\\\|github-draft-pr\\\" /home/runner/work/erk/erk/src/erk/cli/commands --include=\\\"*.py\\\" | head -40\",\"description\":\"Search for backend-aware patterns in CLI commands\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/tui/commands/registry.py\",\"offset\":1,\"limit\":100}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/tui/commands/registry.py\",\"offset\":1,\"limit\":100}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/exec/scripts/handle_no_changes.py\",\"offset\":1,\"limit\":100}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/exec/scripts/update_pr_description.py\",\"offset\":1,\"limit\":80}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/exec/scripts/update_pr_description.py\",\"offset\":1,\"limit\":80}\n\n--- RESULT ---\nPerfect! Now I have enough information. Let me compile a comprehensive report.\n\n## Report: Backend-Aware Display Patterns in `learn_cmd.py`\n\nBased on my analysis of `/home/runner/work/erk/erk/src/erk/cli/commands/learn/learn_cmd.py` and supporting documentation, here are the findings:\n\n### 1. **How Backend Routing Works**\n\nThe `learn_cmd.py` **does NOT** currently route between `gh issue view` vs `gh pr view` at the command level. Instead, it delegates to the abstract `plan_backend` interface:\n\n**Key lines:**\n- **Line 117**: `plan_id = ctx.plan_backend.resolve_plan_id_for_branch(ctx.cwd, branch_name)`\n- **Line 152**: `sessions_for_plan = ctx.plan_backend.find_sessions_for_plan(repo_root, plan_id,)`\n- **Line 252**: `result = ctx.plan_backend.get_metadata_field(repo_root, plan_id, \"learn_materials_branch\")`\n\nThe `plan_backend` is an **abstract interface** (from `erk_shared.plan_store`) that has two implementations:\n- **`GitHubPlanStore`** (for `github` backend) — uses issue-based storage\n- **`DraftPRPlanBackend`** (for `github-draft-pr` backend) — uses draft PR-based storage\n\n### 2. **Backend Type Detection Patterns**\n\nAcross the codebase, backend type is detected via:\n\n**Pattern 1 - Direct comparison** (used in TUI commands at `/home/runner/work/erk/erk/src/erk/tui/commands/registry.py:31-33`):\n```python\ndef _is_github_backend(ctx: CommandContext) -> bool:\n    \"\"\"True when the plan backend is github (not draft_pr).\"\"\"\n    return ctx.plan_backend == \"github\"\n```\n\n**Pattern 2 - Provider name check** (used in exec scripts):\n```python\n# From handle_no_changes.py line 79 and update_pr_description.py\nbackend = require_plan_backend(ctx)\nis_draft_pr = backend.get_provider_name() == \"github-draft-pr\"\n```\n\n**Pattern 3 - Context method dispatch** (learn_cmd.py pattern):\n```python\n# Lines 117, 152, 252 - delegates to the backend object\nctx.plan_backend.resolve_plan_id_for_branch(...)\nctx.plan_backend.find_sessions_for_plan(...)\nctx.plan_backend.get_metadata_field(...)\n```\n\n### 3. **Key Terminology Differences**\n\nFrom `/home/runner/work/erk/erk/docs/learned/planning/draft-pr-plan-backend.md` (lines 22-24):\n\n**GitHub Backend (Issue-based)**:\n- Plans are stored as **GitHub issues**\n- `plan_id` = **issue number** (e.g., `#123`)\n- Uses `gh issue view` conceptually\n\n**Draft-PR Backend (PR-based)**:\n- Plans are stored as **GitHub draft pull requests**\n- `plan_id` = **PR number** (the PR itself, not a separate issue)\n- Uses `gh pr view` conceptually\n- Branch names use `planned/{slug}-{MM-DD-HHMM}` format instead of `P{number}-{slug}`\n- Provider name: `\"github-draft-pr\"`\n\n**Critical Warning from docs** (tripwire #12, line 11-13):\n> \"Draft-PR plan_id IS the PR number (not an issue number). Check provider type before assuming plan_id semantics. Issue-based plans use issue numbers; draft-PR plans use PR numbers.\"\n\n### 4. **Backend-Aware Command Examples**\n\n**From TUI command registry** (`src/erk/tui/commands/registry.py:314-329`):\n\nTwo commands are **hidden in draft-PR mode** because they depend on issue-based workflows:\n\n```python\n# copy_prepare and copy_prepare_activate hidden when github-draft-pr\nis_available=lambda ctx: _is_plan_view(ctx) and _is_github_backend(ctx)\n```\n\n**From handle_no_changes.py** (line 79):\n```python\nbackend = require_plan_backend(ctx)\nis_draft_pr = backend.get_provider_name() == \"github-draft-pr\"\n# Then branches behavior based on is_draft_pr flag\n```\n\n### 5. **Documentation Index**\n\nThe following docs contain backend-aware patterns:\n\n| File | Key Content |\n|------|------------|\n| `/home/runner/work/erk/erk/docs/learned/tui/backend-aware-commands.md` | TUI command filtering by `_is_github_backend()` predicate, commands hidden in draft-PR mode |\n| `/home/runner/work/erk/erk/docs/learned/tui/view-aware-commands.md` | View mode filtering (distinct from backend filtering) |\n| `/home/runner/work/erk/erk/docs/learned/planning/draft-pr-plan-backend.md` | Complete backend architecture, tripwires for `plan_id` semantics |\n| `/home/runner/work/erk/erk/docs/learned/planning/branch-plan-resolution.md` | How branch names resolve to plan IDs (differs by backend) |\n\n### 6. **Why `learn_cmd.py` Uses Interface Delegation**\n\nThe `learn_cmd.py` doesn't need explicit `github` vs `draft_pr` checks because:\n\n1. **Session discovery is backend-agnostic** — both backends track sessions in issue/PR metadata\n2. **The `plan_backend` interface abstracts away the storage mechanism** — same method calls work for both\n3. **Metadata fields are identical** — `learn_materials_branch` exists on both backends\n\nHowever, if `learn_cmd` were to **open the plan directly** (e.g., `gh issue view` vs `gh pr view`), it would need:\n\n```python\n# Hypothetical pattern (not currently in code):\nif ctx.plan_backend == \"github\":\n    # Use: gh issue view {plan_id}\nelse:  # github-draft-pr\n    # Use: gh pr view {plan_id}\n```\n\n### Summary\n\n`learn_cmd.py` exemplifies the **interface delegation pattern** — it doesn't need backend-aware branching because the `plan_backend` abstraction handles both issue and draft-PR storage uniformly. Backend awareness emerges when commands need to:\n- Conditionally hide/show features (TUI command filtering)\n- Interpret `plan_id` semantics differently (exec scripts)\n- Use different GitHub CLI commands (`gh issue` vs `gh pr`)\n\nThe codebase provides **two primary patterns**:\n1. **TUI**: `_is_github_backend(ctx)` predicate for availability filtering\n2. **Exec scripts**: `backend.get_provider_name() == \"github-draft-pr\"` for behavior branching\n</output>"}]},"uuid":"f0e26f1a-75c7-4456-afac-ba3541a7fb9c","timestamp":"2026-02-21T23:15:20.713Z","toolUseResult":{"retrieval_status":"success","task":{"task_id":"a426311","task_type":"local_agent","status":"completed","description":"Check learn cmd backend routing","output":"[Tool: Grep] {\"pattern\":\"backend\",\"path\":\"/home/runner/work/erk/erk/docs/learned\",\"glob\":\"*.md\",\"output_mode\":\"files_with_matches\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/learn/learn_cmd.py\"}\n[Tool: Glob] {\"pattern\":\"docs/learned/tui/backend-aware-commands.md\"}\n[Tool: Glob] {\"pattern\":\"docs/learned/tui/backend-aware-commands.md\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/docs/learned/tui/backend-aware-commands.md\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/docs/learned/tui/view-aware-commands.md\"}\n[Tool: Grep] {\"pattern\":\"gh (issue|pr) view\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/learn\",\"output_mode\":\"content\",\"type\":\"py\"}\n[Tool: Grep] {\"pattern\":\"gh (issue|pr) view\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/learn\",\"output_mode\":\"content\",\"type\":\"py\"}\n[Tool: Grep] {\"pattern\":\"plan_backend|github|draft\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/learn\",\"output_mode\":\"content\",\"type\":\"py\"}\n[Tool: Glob] {\"pattern\":\"src/erk/cli/commands/**/*view*.py\"}\n[Tool: Grep] {\"pattern\":\"issue view|pr view\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli\",\"output_mode\":\"files_with_matches\",\"type\":\"py\"}\n[Tool: Grep] {\"pattern\":\"issue view|pr view\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli\",\"output_mode\":\"files_with_matches\",\"type\":\"py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/plan/view.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/objective/view_cmd.py\"}\n[Tool: Grep] {\"pattern\":\"plan_backend|PlanBackendType\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/plan\",\"output_mode\":\"files_with_matches\",\"type\":\"py\"}\n[Tool: Grep] {\"pattern\":\"plan_backend|PlanBackendType\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/plan\",\"output_mode\":\"files_with_matches\",\"type\":\"py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/docs/learned/planning/draft-pr-plan-backend.md\"}\n[Tool: Grep] {\"pattern\":\"draft|github.*backend|plan_backend\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/learn/learn_cmd.py\",\"output_mode\":\"content\"}\n[Tool: Grep] {\"pattern\":\"draft|github.*backend|plan_backend\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/learn/learn_cmd.py\",\"output_mode\":\"content\"}\n[Tool: Bash] {\"command\":\"grep -r \\\"github.*backend\\\\|plan_backend\\\\|github-draft-pr\\\" /home/runner/work/erk/erk/src/erk/cli/commands --include=\\\"*.py\\\" | head -40\",\"description\":\"Search for backend-aware patterns in CLI commands\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/tui/commands/registry.py\",\"offset\":1,\"limit\":100}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/tui/commands/registry.py\",\"offset\":1,\"limit\":100}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/exec/scripts/handle_no_changes.py\",\"offset\":1,\"limit\":100}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/exec/scripts/update_pr_description.py\",\"offset\":1,\"limit\":80}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/exec/scripts/update_pr_description.py\",\"offset\":1,\"limit\":80}\n\n--- RESULT ---\nPerfect! Now I have enough information. Let me compile a comprehensive report.\n\n## Report: Backend-Aware Display Patterns in `learn_cmd.py`\n\nBased on my analysis of `/home/runner/work/erk/erk/src/erk/cli/commands/learn/learn_cmd.py` and supporting documentation, here are the findings:\n\n### 1. **How Backend Routing Works**\n\nThe `learn_cmd.py` **does NOT** currently route between `gh issue view` vs `gh pr view` at the command level. Instead, it delegates to the abstract `plan_backend` interface:\n\n**Key lines:**\n- **Line 117**: `plan_id = ctx.plan_backend.resolve_plan_id_for_branch(ctx.cwd, branch_name)`\n- **Line 152**: `sessions_for_plan = ctx.plan_backend.find_sessions_for_plan(repo_root, plan_id,)`\n- **Line 252**: `result = ctx.plan_backend.get_metadata_field(repo_root, plan_id, \"learn_materials_branch\")`\n\nThe `plan_backend` is an **abstract interface** (from `erk_shared.plan_store`) that has two implementations:\n- **`GitHubPlanStore`** (for `github` backend) — uses issue-based storage\n- **`DraftPRPlanBackend`** (for `github-draft-pr` backend) — uses draft PR-based storage\n\n### 2. **Backend Type Detection Patterns**\n\nAcross the codebase, backend type is detected via:\n\n**Pattern 1 - Direct comparison** (used in TUI commands at `/home/runner/work/erk/erk/src/erk/tui/commands/registry.py:31-33`):\n```python\ndef _is_github_backend(ctx: CommandContext) -> bool:\n    \"\"\"True when the plan backend is github (not draft_pr).\"\"\"\n    return ctx.plan_backend == \"github\"\n```\n\n**Pattern 2 - Provider name check** (used in exec scripts):\n```python\n# From handle_no_changes.py line 79 and update_pr_description.py\nbackend = require_plan_backend(ctx)\nis_draft_pr = backend.get_provider_name() == \"github-draft-pr\"\n```\n\n**Pattern 3 - Context method dispatch** (learn_cmd.py pattern):\n```python\n# Lines 117, 152, 252 - delegates to the backend object\nctx.plan_backend.resolve_plan_id_for_branch(...)\nctx.plan_backend.find_sessions_for_plan(...)\nctx.plan_backend.get_metadata_field(...)\n```\n\n### 3. **Key Terminology Differences**\n\nFrom `/home/runner/work/erk/erk/docs/learned/planning/draft-pr-plan-backend.md` (lines 22-24):\n\n**GitHub Backend (Issue-based)**:\n- Plans are stored as **GitHub issues**\n- `plan_id` = **issue number** (e.g., `#123`)\n- Uses `gh issue view` conceptually\n\n**Draft-PR Backend (PR-based)**:\n- Plans are stored as **GitHub draft pull requests**\n- `plan_id` = **PR number** (the PR itself, not a separate issue)\n- Uses `gh pr view` conceptually\n- Branch names use `planned/{slug}-{MM-DD-HHMM}` format instead of `P{number}-{slug}`\n- Provider name: `\"github-draft-pr\"`\n\n**Critical Warning from docs** (tripwire #12, line 11-13):\n> \"Draft-PR plan_id IS the PR number (not an issue number). Check provider type before assuming plan_id semantics. Issue-based plans use issue numbers; draft-PR plans use PR numbers.\"\n\n### 4. **Backend-Aware Command Examples**\n\n**From TUI command registry** (`src/erk/tui/commands/registry.py:314-329`):\n\nTwo commands are **hidden in draft-PR mode** because they depend on issue-based workflows:\n\n```python\n# copy_prepare and copy_prepare_activate hidden when github-draft-pr\nis_available=lambda ctx: _is_plan_view(ctx) and _is_github_backend(ctx)\n```\n\n**From handle_no_changes.py** (line 79):\n```python\nbackend = require_plan_backend(ctx)\nis_draft_pr = backend.get_provider_name() == \"github-draft-pr\"\n# Then branches behavior based on is_draft_pr flag\n```\n\n### 5. **Documentation Index**\n\nThe following docs contain backend-aware patterns:\n\n| File | Key Content |\n|------|------------|\n| `/home/runner/work/erk/erk/docs/learned/tui/backend-aware-commands.md` | TUI command filtering by `_is_github_backend()` predicate, commands hidden in draft-PR mode |\n| `/home/runner/work/erk/erk/docs/learned/tui/view-aware-commands.md` | View mode filtering (distinct from backend filtering) |\n| `/home/runner/work/erk/erk/docs/learned/planning/draft-pr-plan-backend.md` | Complete backend architecture, tripwires for `plan_id` semantics |\n| `/home/runner/work/erk/erk/docs/learned/planning/branch-plan-resolution.md` | How branch names resolve to plan IDs (differs by backend) |\n\n### 6. **Why `learn_cmd.py` Uses Interface Delegation**\n\nThe `learn_cmd.py` doesn't need explicit `github` vs `draft_pr` checks because:\n\n1. **Session discovery is backend-agnostic** — both backends track sessions in issue/PR metadata\n2. **The `plan_backend` interface abstracts away the storage mechanism** — same method calls work for both\n3. **Metadata fields are identical** — `learn_materials_branch` exists on both backends\n\nHowever, if `learn_cmd` were to **open the plan directly** (e.g., `gh issue view` vs `gh pr view`), it would need:\n\n```python\n# Hypothetical pattern (not currently in code):\nif ctx.plan_backend == \"github\":\n    # Use: gh issue view {plan_id}\nelse:  # github-draft-pr\n    # Use: gh pr view {plan_id}\n```\n\n### Summary\n\n`learn_cmd.py` exemplifies the **interface delegation pattern** — it doesn't need backend-aware branching because the `plan_backend` abstraction handles both issue and draft-PR storage uniformly. Backend awareness emerges when commands need to:\n- Conditionally hide/show features (TUI command filtering)\n- Interpret `plan_id` semantics differently (exec scripts)\n- Use different GitHub CLI commands (`gh issue` vs `gh pr`)\n\nThe codebase provides **two primary patterns**:\n1. **TUI**: `_is_github_backend(ctx)` predicate for availability filtering\n2. **Exec scripts**: `backend.get_provider_name() == \"github-draft-pr\"` for behavior branching\n","prompt":"FIRST check docs/learned/index.md for existing documentation on this topic.\nRead relevant docs before exploring raw files.\n\nRead `src/erk/cli/commands/learn/learn_cmd.py` and look for backend-aware display patterns, specifically:\n1. How does it route between `gh issue view` vs `gh pr view`?\n2. How does it use `plan_backend` or backend type to determine behavior?\n3. What terminology differences exist (\"draft PR\" vs \"issue\")?\n\nAlso check if `docs/learned/tui/backend-aware-commands.md` exists and what patterns it documents.\n\nWorking directory: /home/runner/work/erk/erk","result":"[Tool: Grep] {\"pattern\":\"backend\",\"path\":\"/home/runner/work/erk/erk/docs/learned\",\"glob\":\"*.md\",\"output_mode\":\"files_with_matches\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/learn/learn_cmd.py\"}\n[Tool: Glob] {\"pattern\":\"docs/learned/tui/backend-aware-commands.md\"}\n[Tool: Glob] {\"pattern\":\"docs/learned/tui/backend-aware-commands.md\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/docs/learned/tui/backend-aware-commands.md\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/docs/learned/tui/view-aware-commands.md\"}\n[Tool: Grep] {\"pattern\":\"gh (issue|pr) view\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/learn\",\"output_mode\":\"content\",\"type\":\"py\"}\n[Tool: Grep] {\"pattern\":\"gh (issue|pr) view\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/learn\",\"output_mode\":\"content\",\"type\":\"py\"}\n[Tool: Grep] {\"pattern\":\"plan_backend|github|draft\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/learn\",\"output_mode\":\"content\",\"type\":\"py\"}\n[Tool: Glob] {\"pattern\":\"src/erk/cli/commands/**/*view*.py\"}\n[Tool: Grep] {\"pattern\":\"issue view|pr view\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli\",\"output_mode\":\"files_with_matches\",\"type\":\"py\"}\n[Tool: Grep] {\"pattern\":\"issue view|pr view\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli\",\"output_mode\":\"files_with_matches\",\"type\":\"py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/plan/view.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/objective/view_cmd.py\"}\n[Tool: Grep] {\"pattern\":\"plan_backend|PlanBackendType\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/plan\",\"output_mode\":\"files_with_matches\",\"type\":\"py\"}\n[Tool: Grep] {\"pattern\":\"plan_backend|PlanBackendType\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/plan\",\"output_mode\":\"files_with_matches\",\"type\":\"py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/docs/learned/planning/draft-pr-plan-backend.md\"}\n[Tool: Grep] {\"pattern\":\"draft|github.*backend|plan_backend\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/learn/learn_cmd.py\",\"output_mode\":\"content\"}\n[Tool: Grep] {\"pattern\":\"draft|github.*backend|plan_backend\",\"path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/learn/learn_cmd.py\",\"output_mode\":\"content\"}\n[Tool: Bash] {\"command\":\"grep -r \\\"github.*backend\\\\|plan_backend\\\\|github-draft-pr\\\" /home/runner/work/erk/erk/src/erk/cli/commands --include=\\\"*.py\\\" | head -40\",\"description\":\"Search for backend-aware patterns in CLI commands\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/tui/commands/registry.py\",\"offset\":1,\"limit\":100}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/tui/commands/registry.py\",\"offset\":1,\"limit\":100}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/exec/scripts/handle_no_changes.py\",\"offset\":1,\"limit\":100}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/exec/scripts/update_pr_description.py\",\"offset\":1,\"limit\":80}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/exec/scripts/update_pr_description.py\",\"offset\":1,\"limit\":80}\n\n--- RESULT ---\nPerfect! Now I have enough information. Let me compile a comprehensive report.\n\n## Report: Backend-Aware Display Patterns in `learn_cmd.py`\n\nBased on my analysis of `/home/runner/work/erk/erk/src/erk/cli/commands/learn/learn_cmd.py` and supporting documentation, here are the findings:\n\n### 1. **How Backend Routing Works**\n\nThe `learn_cmd.py` **does NOT** currently route between `gh issue view` vs `gh pr view` at the command level. Instead, it delegates to the abstract `plan_backend` interface:\n\n**Key lines:**\n- **Line 117**: `plan_id = ctx.plan_backend.resolve_plan_id_for_branch(ctx.cwd, branch_name)`\n- **Line 152**: `sessions_for_plan = ctx.plan_backend.find_sessions_for_plan(repo_root, plan_id,)`\n- **Line 252**: `result = ctx.plan_backend.get_metadata_field(repo_root, plan_id, \"learn_materials_branch\")`\n\nThe `plan_backend` is an **abstract interface** (from `erk_shared.plan_store`) that has two implementations:\n- **`GitHubPlanStore`** (for `github` backend) — uses issue-based storage\n- **`DraftPRPlanBackend`** (for `github-draft-pr` backend) — uses draft PR-based storage\n\n### 2. **Backend Type Detection Patterns**\n\nAcross the codebase, backend type is detected via:\n\n**Pattern 1 - Direct comparison** (used in TUI commands at `/home/runner/work/erk/erk/src/erk/tui/commands/registry.py:31-33`):\n```python\ndef _is_github_backend(ctx: CommandContext) -> bool:\n    \"\"\"True when the plan backend is github (not draft_pr).\"\"\"\n    return ctx.plan_backend == \"github\"\n```\n\n**Pattern 2 - Provider name check** (used in exec scripts):\n```python\n# From handle_no_changes.py line 79 and update_pr_description.py\nbackend = require_plan_backend(ctx)\nis_draft_pr = backend.get_provider_name() == \"github-draft-pr\"\n```\n\n**Pattern 3 - Context method dispatch** (learn_cmd.py pattern):\n```python\n# Lines 117, 152, 252 - delegates to the backend object\nctx.plan_backend.resolve_plan_id_for_branch(...)\nctx.plan_backend.find_sessions_for_plan(...)\nctx.plan_backend.get_metadata_field(...)\n```\n\n### 3. **Key Terminology Differences**\n\nFrom `/home/runner/work/erk/erk/docs/learned/planning/draft-pr-plan-backend.md` (lines 22-24):\n\n**GitHub Backend (Issue-based)**:\n- Plans are stored as **GitHub issues**\n- `plan_id` = **issue number** (e.g., `#123`)\n- Uses `gh issue view` conceptually\n\n**Draft-PR Backend (PR-based)**:\n- Plans are stored as **GitHub draft pull requests**\n- `plan_id` = **PR number** (the PR itself, not a separate issue)\n- Uses `gh pr view` conceptually\n- Branch names use `planned/{slug}-{MM-DD-HHMM}` format instead of `P{number}-{slug}`\n- Provider name: `\"github-draft-pr\"`\n\n**Critical Warning from docs** (tripwire #12, line 11-13):\n> \"Draft-PR plan_id IS the PR number (not an issue number). Check provider type before assuming plan_id semantics. Issue-based plans use issue numbers; draft-PR plans use PR numbers.\"\n\n### 4. **Backend-Aware Command Examples**\n\n**From TUI command registry** (`src/erk/tui/commands/registry.py:314-329`):\n\nTwo commands are **hidden in draft-PR mode** because they depend on issue-based workflows:\n\n```python\n# copy_prepare and copy_prepare_activate hidden when github-draft-pr\nis_available=lambda ctx: _is_plan_view(ctx) and _is_github_backend(ctx)\n```\n\n**From handle_no_changes.py** (line 79):\n```python\nbackend = require_plan_backend(ctx)\nis_draft_pr = backend.get_provider_name() == \"github-draft-pr\"\n# Then branches behavior based on is_draft_pr flag\n```\n\n### 5. **Documentation Index**\n\nThe following docs contain backend-aware patterns:\n\n| File | Key Content |\n|------|------------|\n| `/home/runner/work/erk/erk/docs/learned/tui/backend-aware-commands.md` | TUI command filtering by `_is_github_backend()` predicate, commands hidden in draft-PR mode |\n| `/home/runner/work/erk/erk/docs/learned/tui/view-aware-commands.md` | View mode filtering (distinct from backend filtering) |\n| `/home/runner/work/erk/erk/docs/learned/planning/draft-pr-plan-backend.md` | Complete backend architecture, tripwires for `plan_id` semantics |\n| `/home/runner/work/erk/erk/docs/learned/planning/branch-plan-resolution.md` | How branch names resolve to plan IDs (differs by backend) |\n\n### 6. **Why `learn_cmd.py` Uses Interface Delegation**\n\nThe `learn_cmd.py` doesn't need explicit `github` vs `draft_pr` checks because:\n\n1. **Session discovery is backend-agnostic** — both backends track sessions in issue/PR metadata\n2. **The `plan_backend` interface abstracts away the storage mechanism** — same method calls work for both\n3. **Metadata fields are identical** — `learn_materials_branch` exists on both backends\n\nHowever, if `learn_cmd` were to **open the plan directly** (e.g., `gh issue view` vs `gh pr view`), it would need:\n\n```python\n# Hypothetical pattern (not currently in code):\nif ctx.plan_backend == \"github\":\n    # Use: gh issue view {plan_id}\nelse:  # github-draft-pr\n    # Use: gh pr view {plan_id}\n```\n\n### Summary\n\n`learn_cmd.py` exemplifies the **interface delegation pattern** — it doesn't need backend-aware branching because the `plan_backend` abstraction handles both issue and draft-PR storage uniformly. Backend awareness emerges when commands need to:\n- Conditionally hide/show features (TUI command filtering)\n- Interpret `plan_id` semantics differently (exec scripts)\n- Use different GitHub CLI commands (`gh issue` vs `gh pr`)\n\nThe codebase provides **two primary patterns**:\n1. **TUI**: `_is_github_backend(ctx)` predicate for availability filtering\n2. **Exec scripts**: `backend.get_provider_name() == \"github-draft-pr\"` for behavior branching\n"}}}
{"type":"queue-operation","operation":"enqueue","timestamp":"2026-02-21T23:15:27.899Z","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","content":"<agent-notification>\n<agent-id>a3660da</agent-id>\n<output-file>/tmp/claude/tasks/a3660da.output</output-file>\n<status>completed</status>\n<summary>Agent \"Check worktree pool sync\" completed.</summary>\nRead the output file to retrieve the full result.\n</agent-notification>"}
{"parentUuid":"f0e26f1a-75c7-4456-afac-ba3541a7fb9c","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013wzH7HaDyycUyK1t5KswTB","type":"tool_result","content":"<retrieval_status>success</retrieval_status>\n\n<task_id>a3660da</task_id>\n\n<task_type>local_agent</task_type>\n\n<status>completed</status>\n\n<output>\n[Tool: Grep] {\"pattern\":\"sync|lazy|mtime|preserve\",\"path\":\"/home/runner/work/erk/erk/docs/learned\",\"glob\":\"*.md\",\"output_mode\":\"files_with_matches\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/core/worktree_pool.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/core/worktree_pool.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/docs/learned/workflows/git-sync-state-preservation.md\"}\n[Tool: Grep] {\"pattern\":\"sync|lazy|mtime|preserve\",\"path\":\"/home/runner/work/erk/erk/src/erk/core\",\"type\":\"py\",\"output_mode\":\"files_with_matches\"}\n[Tool: Grep] {\"pattern\":\"sync|lazy|mtime|preserve\",\"path\":\"/home/runner/work/erk/erk/src/erk/core\",\"type\":\"py\",\"output_mode\":\"files_with_matches\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/core/worktree_utils.py\"}\n[Tool: Bash] {\"command\":\"grep -r \\\"def.*sync\\\\|lazy.*sync\\\\|mtime\\\" /home/runner/work/erk/erk/src/erk/core --include=\\\"*.py\\\" -n\",\"description\":\"Search for sync functions and mtime handling\"}\n[Tool: Bash] {\"command\":\"grep -r \\\"def.*sync\\\\|lazy.*sync\\\\|mtime\\\" /home/runner/work/erk/erk/src/erk/core --include=\\\"*.py\\\" -n\",\"description\":\"Search for sync functions and mtime handling\"}\n[Tool: Bash] {\"command\":\"find /home/runner/work/erk/erk -type f -name \\\"*.py\\\" -exec grep -l \\\"def.*sync\\\\|lazy\\\\|preserve.*mtime\\\" {} \\\\; 2>/dev/null | head -20\",\"description\":\"Find all Python files with sync or mtime functions\"}\n[Tool: Glob] {\"pattern\":\"src/erk/**/*pool*.py\"}\n[Tool: Glob] {\"pattern\":\"src/erk/**/*pool*.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/tests/artifacts/test_sync.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/slot/init_pool_cmd.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/slot/init_pool_cmd.py\"}\n[Tool: Bash] {\"command\":\"grep -r \\\"class.*Pool\\\\|def.*sync.*pool\\\\|def.*lazy\\\" /home/runner/work/erk/erk/src/erk --include=\\\"*.py\\\" -n | head -40\",\"description\":\"Search for pool-related classes and sync functions\"}\n[Tool: Glob] {\"pattern\":\"src/erk/**/*slot*.py\"}\n[Tool: Glob] {\"pattern\":\"src/erk/**/*slot*.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py\"}\n[Tool: Bash] {\"command\":\"grep -r \\\"sync_pool_assignments\\\\|lazy.*sync\\\\|mtime\\\" /home/runner/work/erk/erk/tests --include=\\\"*.py\\\" -l\",\"description\":\"Find tests for pool sync functions\"}\n[Tool: Grep] {\"pattern\":\"sync|detached|placeholder|stale\",\"path\":\"/home/runner/work/erk/erk/docs/learned\",\"glob\":\"*.md\",\"output_mode\":\"files_with_matches\",\"head_limit\":10}\n[Tool: Grep] {\"pattern\":\"sync|detached|placeholder|stale\",\"path\":\"/home/runner/work/erk/erk/docs/learned\",\"glob\":\"*.md\",\"output_mode\":\"files_with_matches\",\"head_limit\":10}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/tests/unit/cli/commands/slot/test_common.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/tests/unit/cli/commands/slot/test_common.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py\",\"offset\":223,\"limit\":65}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py\",\"offset\":223,\"limit\":65}\n\n--- RESULT ---\nPerfect! I now have all the information needed to provide a comprehensive answer. Let me compile the detailed analysis.\n\n## Summary: Worktree Pool Sync Functions in `src/erk/core/worktree_pool.py`\n\nBased on my investigation of the codebase, here are the key findings:\n\n### 1. **Lazy Sync Algorithm - YES**\n\nThe pool uses a **lazy sync strategy** implemented in `/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py`:\n\n**Function: `sync_pool_assignments()` (lines 223-287)**\n\nThe sync algorithm is **lazy** because:\n- It runs **on-demand** before critical operations (allocation, eviction decisions)\n- It **only scans assignments**, not all slots\n- It **defers writes** - only saves to disk if changes are detected (line 277-278)\n\n**When Sync Runs:**\n- Called at the beginning of `allocate_slot_for_branch()` (line 609) before making allocation decisions\n- This ensures accurate state before checking if a branch is already assigned or if slots are available\n\n### 2. **mtime Preservation - YES**\n\nThe implementation explicitly preserves file modification time when no changes occur:\n\n**Test Evidence** (from `/home/runner/work/erk/erk/tests/unit/cli/commands/slot/test_common.py`, lines 710-730):\n\n```python\ndef test_sync_does_not_save_when_unchanged(tmp_path: Path) -> None:\n    \"\"\"pool.json mtime is unchanged when no sync needed.\"\"\"\n    # ...\n    if synced_count == 0:\n        return PoolSyncResult(state=state, synced_count=0)  # Early return\n    \n    # Only writes if synced_count > 0\n    save_pool_state(pool_json_path, new_state)\n```\n\n**Mechanism:**\n- Lines 277-278 in `sync_pool_assignments()`: Early return without writing if `synced_count == 0`\n- This prevents unnecessary disk writes and preserves the original mtime\n\n### 3. **Edge Cases Handled**\n\nThe sync function handles five important edge cases:\n\n| Edge Case | Handling | Code |\n|-----------|----------|------|\n| **Missing worktree directory** | Skip, leave unchanged | Line 247-249 |\n| **Detached HEAD** | Skip, leave unchanged | Line 253-256 |\n| **Branch hasn't changed** | Skip, leave unchanged | Line 258-260 |\n| **Placeholder branches** | Skip, leave unchanged (don't update to stub) | Line 262-264 |\n| **Branch actually changed** | Update `branch_name`, preserve `assigned_at` | Line 266-275 |\n\n### 4. **Core Data Structures**\n\nFrom `/home/runner/work/erk/erk/src/erk/core/worktree_pool.py` (lines 46-119):\n\n- **PoolState**: Immutable frozen dataclass containing `version`, `pool_size`, `slots`, `assignments`\n- **SlotAssignment**: Contains `slot_name`, `branch_name`, `assigned_at` (ISO timestamp), `worktree_path`\n- **PoolSyncResult**: Returns `state` and `synced_count` for tracking changes\n\n### 5. **Key Design Insights**\n\n**Assigned_at Preservation:**\n- When a branch changes, the `assigned_at` timestamp is preserved (line 271)\n- This tracks when the assignment was originally made, not when the branch changed\n- Used for eviction ordering (oldest assignments get evicted first)\n\n**State-of-Truth Hierarchy:**\n1. Git worktree state (actual branches checked out) - **primary source**\n2. pool.json assignments (recorded state) - **secondary**\n3. Sync reconciles them by reading git and updating pool.json\n\n**Orphaned Worktree Handling:**\n- Test case `test_finds_orphaned_worktree_not_in_state()` (lines 217-243) shows that orphaned worktrees discovered by git are made available for reuse even if not in state.slots\n\n### 6. **File Locations**\n\n- **Main sync function**: `/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py` (lines 223-287)\n- **Data structures**: `/home/runner/work/erk/erk/src/erk/core/worktree_pool.py` (lines 14-119)\n- **Comprehensive tests**: `/home/runner/work/erk/erk/tests/unit/cli/commands/slot/test_common.py` (lines 644-890)\n- **Integration with allocation**: `/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py` (line 609 in `allocate_slot_for_branch()`)\n\nThe sync algorithm is well-designed for lazy evaluation with explicit mtime preservation and comprehensive edge case handling.\n</output>"}]},"uuid":"6c2886c4-0951-4028-b530-88589f20977e","timestamp":"2026-02-21T23:15:27.978Z","toolUseResult":{"retrieval_status":"success","task":{"task_id":"a3660da","task_type":"local_agent","status":"completed","description":"Check worktree pool sync","output":"[Tool: Grep] {\"pattern\":\"sync|lazy|mtime|preserve\",\"path\":\"/home/runner/work/erk/erk/docs/learned\",\"glob\":\"*.md\",\"output_mode\":\"files_with_matches\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/core/worktree_pool.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/core/worktree_pool.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/docs/learned/workflows/git-sync-state-preservation.md\"}\n[Tool: Grep] {\"pattern\":\"sync|lazy|mtime|preserve\",\"path\":\"/home/runner/work/erk/erk/src/erk/core\",\"type\":\"py\",\"output_mode\":\"files_with_matches\"}\n[Tool: Grep] {\"pattern\":\"sync|lazy|mtime|preserve\",\"path\":\"/home/runner/work/erk/erk/src/erk/core\",\"type\":\"py\",\"output_mode\":\"files_with_matches\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/core/worktree_utils.py\"}\n[Tool: Bash] {\"command\":\"grep -r \\\"def.*sync\\\\|lazy.*sync\\\\|mtime\\\" /home/runner/work/erk/erk/src/erk/core --include=\\\"*.py\\\" -n\",\"description\":\"Search for sync functions and mtime handling\"}\n[Tool: Bash] {\"command\":\"grep -r \\\"def.*sync\\\\|lazy.*sync\\\\|mtime\\\" /home/runner/work/erk/erk/src/erk/core --include=\\\"*.py\\\" -n\",\"description\":\"Search for sync functions and mtime handling\"}\n[Tool: Bash] {\"command\":\"find /home/runner/work/erk/erk -type f -name \\\"*.py\\\" -exec grep -l \\\"def.*sync\\\\|lazy\\\\|preserve.*mtime\\\" {} \\\\; 2>/dev/null | head -20\",\"description\":\"Find all Python files with sync or mtime functions\"}\n[Tool: Glob] {\"pattern\":\"src/erk/**/*pool*.py\"}\n[Tool: Glob] {\"pattern\":\"src/erk/**/*pool*.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/tests/artifacts/test_sync.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/slot/init_pool_cmd.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/slot/init_pool_cmd.py\"}\n[Tool: Bash] {\"command\":\"grep -r \\\"class.*Pool\\\\|def.*sync.*pool\\\\|def.*lazy\\\" /home/runner/work/erk/erk/src/erk --include=\\\"*.py\\\" -n | head -40\",\"description\":\"Search for pool-related classes and sync functions\"}\n[Tool: Glob] {\"pattern\":\"src/erk/**/*slot*.py\"}\n[Tool: Glob] {\"pattern\":\"src/erk/**/*slot*.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py\"}\n[Tool: Bash] {\"command\":\"grep -r \\\"sync_pool_assignments\\\\|lazy.*sync\\\\|mtime\\\" /home/runner/work/erk/erk/tests --include=\\\"*.py\\\" -l\",\"description\":\"Find tests for pool sync functions\"}\n[Tool: Grep] {\"pattern\":\"sync|detached|placeholder|stale\",\"path\":\"/home/runner/work/erk/erk/docs/learned\",\"glob\":\"*.md\",\"output_mode\":\"files_with_matches\",\"head_limit\":10}\n[Tool: Grep] {\"pattern\":\"sync|detached|placeholder|stale\",\"path\":\"/home/runner/work/erk/erk/docs/learned\",\"glob\":\"*.md\",\"output_mode\":\"files_with_matches\",\"head_limit\":10}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/tests/unit/cli/commands/slot/test_common.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/tests/unit/cli/commands/slot/test_common.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py\",\"offset\":223,\"limit\":65}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py\",\"offset\":223,\"limit\":65}\n\n--- RESULT ---\nPerfect! I now have all the information needed to provide a comprehensive answer. Let me compile the detailed analysis.\n\n## Summary: Worktree Pool Sync Functions in `src/erk/core/worktree_pool.py`\n\nBased on my investigation of the codebase, here are the key findings:\n\n### 1. **Lazy Sync Algorithm - YES**\n\nThe pool uses a **lazy sync strategy** implemented in `/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py`:\n\n**Function: `sync_pool_assignments()` (lines 223-287)**\n\nThe sync algorithm is **lazy** because:\n- It runs **on-demand** before critical operations (allocation, eviction decisions)\n- It **only scans assignments**, not all slots\n- It **defers writes** - only saves to disk if changes are detected (line 277-278)\n\n**When Sync Runs:**\n- Called at the beginning of `allocate_slot_for_branch()` (line 609) before making allocation decisions\n- This ensures accurate state before checking if a branch is already assigned or if slots are available\n\n### 2. **mtime Preservation - YES**\n\nThe implementation explicitly preserves file modification time when no changes occur:\n\n**Test Evidence** (from `/home/runner/work/erk/erk/tests/unit/cli/commands/slot/test_common.py`, lines 710-730):\n\n```python\ndef test_sync_does_not_save_when_unchanged(tmp_path: Path) -> None:\n    \"\"\"pool.json mtime is unchanged when no sync needed.\"\"\"\n    # ...\n    if synced_count == 0:\n        return PoolSyncResult(state=state, synced_count=0)  # Early return\n    \n    # Only writes if synced_count > 0\n    save_pool_state(pool_json_path, new_state)\n```\n\n**Mechanism:**\n- Lines 277-278 in `sync_pool_assignments()`: Early return without writing if `synced_count == 0`\n- This prevents unnecessary disk writes and preserves the original mtime\n\n### 3. **Edge Cases Handled**\n\nThe sync function handles five important edge cases:\n\n| Edge Case | Handling | Code |\n|-----------|----------|------|\n| **Missing worktree directory** | Skip, leave unchanged | Line 247-249 |\n| **Detached HEAD** | Skip, leave unchanged | Line 253-256 |\n| **Branch hasn't changed** | Skip, leave unchanged | Line 258-260 |\n| **Placeholder branches** | Skip, leave unchanged (don't update to stub) | Line 262-264 |\n| **Branch actually changed** | Update `branch_name`, preserve `assigned_at` | Line 266-275 |\n\n### 4. **Core Data Structures**\n\nFrom `/home/runner/work/erk/erk/src/erk/core/worktree_pool.py` (lines 46-119):\n\n- **PoolState**: Immutable frozen dataclass containing `version`, `pool_size`, `slots`, `assignments`\n- **SlotAssignment**: Contains `slot_name`, `branch_name`, `assigned_at` (ISO timestamp), `worktree_path`\n- **PoolSyncResult**: Returns `state` and `synced_count` for tracking changes\n\n### 5. **Key Design Insights**\n\n**Assigned_at Preservation:**\n- When a branch changes, the `assigned_at` timestamp is preserved (line 271)\n- This tracks when the assignment was originally made, not when the branch changed\n- Used for eviction ordering (oldest assignments get evicted first)\n\n**State-of-Truth Hierarchy:**\n1. Git worktree state (actual branches checked out) - **primary source**\n2. pool.json assignments (recorded state) - **secondary**\n3. Sync reconciles them by reading git and updating pool.json\n\n**Orphaned Worktree Handling:**\n- Test case `test_finds_orphaned_worktree_not_in_state()` (lines 217-243) shows that orphaned worktrees discovered by git are made available for reuse even if not in state.slots\n\n### 6. **File Locations**\n\n- **Main sync function**: `/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py` (lines 223-287)\n- **Data structures**: `/home/runner/work/erk/erk/src/erk/core/worktree_pool.py` (lines 14-119)\n- **Comprehensive tests**: `/home/runner/work/erk/erk/tests/unit/cli/commands/slot/test_common.py` (lines 644-890)\n- **Integration with allocation**: `/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py` (line 609 in `allocate_slot_for_branch()`)\n\nThe sync algorithm is well-designed for lazy evaluation with explicit mtime preservation and comprehensive edge case handling.\n","prompt":"FIRST check docs/learned/index.md for existing documentation on this topic.\nRead relevant docs before exploring raw files.\n\nLook at `src/erk/core/worktree_pool.py` for any sync-related functions. I need to understand:\n1. Is there a lazy sync algorithm?\n2. When does sync run (after pool load, before allocation)?\n3. How does mtime preservation work when no changes?\n4. What edge cases does it handle?\n\nWorking directory: /home/runner/work/erk/erk","result":"[Tool: Grep] {\"pattern\":\"sync|lazy|mtime|preserve\",\"path\":\"/home/runner/work/erk/erk/docs/learned\",\"glob\":\"*.md\",\"output_mode\":\"files_with_matches\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/core/worktree_pool.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/core/worktree_pool.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/docs/learned/workflows/git-sync-state-preservation.md\"}\n[Tool: Grep] {\"pattern\":\"sync|lazy|mtime|preserve\",\"path\":\"/home/runner/work/erk/erk/src/erk/core\",\"type\":\"py\",\"output_mode\":\"files_with_matches\"}\n[Tool: Grep] {\"pattern\":\"sync|lazy|mtime|preserve\",\"path\":\"/home/runner/work/erk/erk/src/erk/core\",\"type\":\"py\",\"output_mode\":\"files_with_matches\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/core/worktree_utils.py\"}\n[Tool: Bash] {\"command\":\"grep -r \\\"def.*sync\\\\|lazy.*sync\\\\|mtime\\\" /home/runner/work/erk/erk/src/erk/core --include=\\\"*.py\\\" -n\",\"description\":\"Search for sync functions and mtime handling\"}\n[Tool: Bash] {\"command\":\"grep -r \\\"def.*sync\\\\|lazy.*sync\\\\|mtime\\\" /home/runner/work/erk/erk/src/erk/core --include=\\\"*.py\\\" -n\",\"description\":\"Search for sync functions and mtime handling\"}\n[Tool: Bash] {\"command\":\"find /home/runner/work/erk/erk -type f -name \\\"*.py\\\" -exec grep -l \\\"def.*sync\\\\|lazy\\\\|preserve.*mtime\\\" {} \\\\; 2>/dev/null | head -20\",\"description\":\"Find all Python files with sync or mtime functions\"}\n[Tool: Glob] {\"pattern\":\"src/erk/**/*pool*.py\"}\n[Tool: Glob] {\"pattern\":\"src/erk/**/*pool*.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/tests/artifacts/test_sync.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/slot/init_pool_cmd.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/slot/init_pool_cmd.py\"}\n[Tool: Bash] {\"command\":\"grep -r \\\"class.*Pool\\\\|def.*sync.*pool\\\\|def.*lazy\\\" /home/runner/work/erk/erk/src/erk --include=\\\"*.py\\\" -n | head -40\",\"description\":\"Search for pool-related classes and sync functions\"}\n[Tool: Glob] {\"pattern\":\"src/erk/**/*slot*.py\"}\n[Tool: Glob] {\"pattern\":\"src/erk/**/*slot*.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py\"}\n[Tool: Bash] {\"command\":\"grep -r \\\"sync_pool_assignments\\\\|lazy.*sync\\\\|mtime\\\" /home/runner/work/erk/erk/tests --include=\\\"*.py\\\" -l\",\"description\":\"Find tests for pool sync functions\"}\n[Tool: Grep] {\"pattern\":\"sync|detached|placeholder|stale\",\"path\":\"/home/runner/work/erk/erk/docs/learned\",\"glob\":\"*.md\",\"output_mode\":\"files_with_matches\",\"head_limit\":10}\n[Tool: Grep] {\"pattern\":\"sync|detached|placeholder|stale\",\"path\":\"/home/runner/work/erk/erk/docs/learned\",\"glob\":\"*.md\",\"output_mode\":\"files_with_matches\",\"head_limit\":10}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/tests/unit/cli/commands/slot/test_common.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/tests/unit/cli/commands/slot/test_common.py\"}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py\",\"offset\":223,\"limit\":65}\n[Tool: Read] {\"file_path\":\"/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py\",\"offset\":223,\"limit\":65}\n\n--- RESULT ---\nPerfect! I now have all the information needed to provide a comprehensive answer. Let me compile the detailed analysis.\n\n## Summary: Worktree Pool Sync Functions in `src/erk/core/worktree_pool.py`\n\nBased on my investigation of the codebase, here are the key findings:\n\n### 1. **Lazy Sync Algorithm - YES**\n\nThe pool uses a **lazy sync strategy** implemented in `/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py`:\n\n**Function: `sync_pool_assignments()` (lines 223-287)**\n\nThe sync algorithm is **lazy** because:\n- It runs **on-demand** before critical operations (allocation, eviction decisions)\n- It **only scans assignments**, not all slots\n- It **defers writes** - only saves to disk if changes are detected (line 277-278)\n\n**When Sync Runs:**\n- Called at the beginning of `allocate_slot_for_branch()` (line 609) before making allocation decisions\n- This ensures accurate state before checking if a branch is already assigned or if slots are available\n\n### 2. **mtime Preservation - YES**\n\nThe implementation explicitly preserves file modification time when no changes occur:\n\n**Test Evidence** (from `/home/runner/work/erk/erk/tests/unit/cli/commands/slot/test_common.py`, lines 710-730):\n\n```python\ndef test_sync_does_not_save_when_unchanged(tmp_path: Path) -> None:\n    \"\"\"pool.json mtime is unchanged when no sync needed.\"\"\"\n    # ...\n    if synced_count == 0:\n        return PoolSyncResult(state=state, synced_count=0)  # Early return\n    \n    # Only writes if synced_count > 0\n    save_pool_state(pool_json_path, new_state)\n```\n\n**Mechanism:**\n- Lines 277-278 in `sync_pool_assignments()`: Early return without writing if `synced_count == 0`\n- This prevents unnecessary disk writes and preserves the original mtime\n\n### 3. **Edge Cases Handled**\n\nThe sync function handles five important edge cases:\n\n| Edge Case | Handling | Code |\n|-----------|----------|------|\n| **Missing worktree directory** | Skip, leave unchanged | Line 247-249 |\n| **Detached HEAD** | Skip, leave unchanged | Line 253-256 |\n| **Branch hasn't changed** | Skip, leave unchanged | Line 258-260 |\n| **Placeholder branches** | Skip, leave unchanged (don't update to stub) | Line 262-264 |\n| **Branch actually changed** | Update `branch_name`, preserve `assigned_at` | Line 266-275 |\n\n### 4. **Core Data Structures**\n\nFrom `/home/runner/work/erk/erk/src/erk/core/worktree_pool.py` (lines 46-119):\n\n- **PoolState**: Immutable frozen dataclass containing `version`, `pool_size`, `slots`, `assignments`\n- **SlotAssignment**: Contains `slot_name`, `branch_name`, `assigned_at` (ISO timestamp), `worktree_path`\n- **PoolSyncResult**: Returns `state` and `synced_count` for tracking changes\n\n### 5. **Key Design Insights**\n\n**Assigned_at Preservation:**\n- When a branch changes, the `assigned_at` timestamp is preserved (line 271)\n- This tracks when the assignment was originally made, not when the branch changed\n- Used for eviction ordering (oldest assignments get evicted first)\n\n**State-of-Truth Hierarchy:**\n1. Git worktree state (actual branches checked out) - **primary source**\n2. pool.json assignments (recorded state) - **secondary**\n3. Sync reconciles them by reading git and updating pool.json\n\n**Orphaned Worktree Handling:**\n- Test case `test_finds_orphaned_worktree_not_in_state()` (lines 217-243) shows that orphaned worktrees discovered by git are made available for reuse even if not in state.slots\n\n### 6. **File Locations**\n\n- **Main sync function**: `/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py` (lines 223-287)\n- **Data structures**: `/home/runner/work/erk/erk/src/erk/core/worktree_pool.py` (lines 14-119)\n- **Comprehensive tests**: `/home/runner/work/erk/erk/tests/unit/cli/commands/slot/test_common.py` (lines 644-890)\n- **Integration with allocation**: `/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py` (line 609 in `allocate_slot_for_branch()`)\n\nThe sync algorithm is well-designed for lazy evaluation with explicit mtime preservation and comprehensive edge case handling.\n"}}}
{"type":"queue-operation","operation":"remove","timestamp":"2026-02-21T23:15:27.984Z","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce"}
{"type":"queue-operation","operation":"remove","timestamp":"2026-02-21T23:15:27.984Z","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce"}
{"parentUuid":"6c2886c4-0951-4028-b530-88589f20977e","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01H52wPx7wJVh2et7x3zHC4G","type":"message","role":"assistant","content":[{"type":"text","text":"Excellent, now I have comprehensive research from all agents. Let me begin the actual implementation. Starting with Step 1.\n\n## Step 1: Rewrite session lifecycle gist references"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2968,"cache_creation_input_tokens":2690,"cache_read_input_tokens":74255,"cache_creation":{"ephemeral_5m_input_tokens":2690,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4ioHyMTxB2BJ6CFUia","type":"assistant","uuid":"2ed28e1e-024f-4cbf-962d-8c620e511240","timestamp":"2026-02-21T23:15:30.699Z"}
{"parentUuid":"2ed28e1e-024f-4cbf-962d-8c620e511240","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01H52wPx7wJVh2et7x3zHC4G","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0166QeHuuZUtpqVFjP1KXSax","name":"Edit","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/sessions/lifecycle.md","old_string":"## Why Gist-Based Persistence Exists\n\nThe gist upload tier was added because learn workflows frequently run in a _different_ Claude Code session from the one that created or implemented the plan. By the time learn runs, the original session file is often gone. Uploading to a gist and recording the URL in the plan-header creates a durable reference that survives session cleanup.\n\n<!-- Source: src/erk/cli/commands/exec/scripts/upload_session.py, upload_session -->\n\nSee `upload_session()` in `src/erk/cli/commands/exec/scripts/upload_session.py` for how gist creation and plan-header updates are coordinated.","new_string":"## Why Branch-Based Persistence Exists\n\nThe branch upload tier was added because learn workflows frequently run in a _different_ Claude Code session from the one that created or implemented the plan. By the time learn runs, the original session file is often gone. Uploading to a `session/{plan_id}` branch and recording the branch reference in the plan-header creates a durable reference that survives session cleanup.\n\n<!-- Source: src/erk/cli/commands/exec/scripts/upload_session.py, upload_session -->\n\nSee `upload_session()` in `src/erk/cli/commands/exec/scripts/upload_session.py` for how branch-based storage and plan-header updates are coordinated. The upload creates a branch from `origin/master`, commits the session JSONL to `.erk/session/{session_id}.jsonl`, force-pushes the branch, and updates plan metadata with `last_session_branch`, `last_session_id`, `last_session_at`, and `last_session_source` fields."},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2968,"cache_creation_input_tokens":2690,"cache_read_input_tokens":74255,"cache_creation":{"ephemeral_5m_input_tokens":2690,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4ioHyMTxB2BJ6CFUia","type":"assistant","uuid":"51783777-2229-4076-b435-cfed7c3fa556","timestamp":"2026-02-21T23:15:39.725Z"}
{"parentUuid":"51783777-2229-4076-b435-cfed7c3fa556","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0166QeHuuZUtpqVFjP1KXSax","type":"tool_result","content":"The file /home/runner/work/erk/erk/docs/learned/sessions/lifecycle.md has been updated successfully."}]},"uuid":"8583dc15-8ced-4369-9c45-16d2f18bb5ed","timestamp":"2026-02-21T23:15:40.460Z","toolUseResult":{"filePath":"/home/runner/work/erk/erk/docs/learned/sessions/lifecycle.md","oldString":"## Why Gist-Based Persistence Exists\n\nThe gist upload tier was added because learn workflows frequently run in a _different_ Claude Code session from the one that created or implemented the plan. By the time learn runs, the original session file is often gone. Uploading to a gist and recording the URL in the plan-header creates a durable reference that survives session cleanup.\n\n<!-- Source: src/erk/cli/commands/exec/scripts/upload_session.py, upload_session -->\n\nSee `upload_session()` in `src/erk/cli/commands/exec/scripts/upload_session.py` for how gist creation and plan-header updates are coordinated.","newString":"## Why Branch-Based Persistence Exists\n\nThe branch upload tier was added because learn workflows frequently run in a _different_ Claude Code session from the one that created or implemented the plan. By the time learn runs, the original session file is often gone. Uploading to a `session/{plan_id}` branch and recording the branch reference in the plan-header creates a durable reference that survives session cleanup.\n\n<!-- Source: src/erk/cli/commands/exec/scripts/upload_session.py, upload_session -->\n\nSee `upload_session()` in `src/erk/cli/commands/exec/scripts/upload_session.py` for how branch-based storage and plan-header updates are coordinated. The upload creates a branch from `origin/master`, commits the session JSONL to `.erk/session/{session_id}.jsonl`, force-pushes the branch, and updates plan metadata with `last_session_branch`, `last_session_id`, `last_session_at`, and `last_session_source` fields.","originalFile":"---\ntitle: Session File Lifecycle and Persistence\nread_when:\n  - \"working with Claude Code session files across workflows\"\n  - \"implementing learn or analysis workflows that consume session data\"\n  - \"debugging missing session files in plan-based workflows\"\ntripwires:\n  - action: \"accessing a session by ID without checking existence first\"\n    warning: \"Session files are session-scoped — Claude Code may clean them up at any time. Always use LBYL discovery (ClaudeInstallation.find_session_globally) before reading.\"\n  - action: \"failing a workflow because a session file is missing\"\n    warning: \"Missing sessions must never cause hard failure. Degrade through the fallback hierarchy: planning → implementation → gist → local scan → skip.\"\n  - action: \"constructing session file paths manually\"\n    warning: \"Use ClaudeInstallation ABC methods, not manual path construction. Storage layout is an implementation detail that may change.\"\nlast_audited: \"2026-02-16 14:20 PT\"\naudit_result: edited\n---\n\n# Session File Lifecycle and Persistence\n\nThis document explains _why_ session file availability is unreliable and the architectural decisions that flow from that constraint. The core problem: erk workflows (learn, analysis) often need session data from _previous_ Claude Code sessions, but Claude Code owns the session storage lifecycle and may clean up files at any time. Erk cannot control this policy.\n\n## The Fundamental Constraint\n\nSession JSONL files are managed by Claude Code, not erk. Their lifetime is tied to the Claude Code session that created them, with no guaranteed persistence beyond that. This means a session ID stored in GitHub issue metadata (plan-header fields, issue comments) may point to a file that no longer exists on disk.\n\nThis constraint drives two architectural decisions:\n\n1. **All session access must go through discovery** — never assume an ID maps to a file\n2. **All session-consuming workflows must degrade gracefully** — missing data narrows scope but never causes failure\n\n## Three Storage Tiers\n\nSession data lives in three places with different persistence guarantees. Understanding which tier you're working with determines how you handle availability.\n\n| Tier               | Location                                 | Persistence                                  | Purpose                                                                     |\n| ------------------ | ---------------------------------------- | -------------------------------------------- | --------------------------------------------------------------------------- |\n| **Claude-managed** | `~/.claude/projects/<project>/sessions/` | Unpredictable — Claude Code controls cleanup | Primary session storage; most workflows start here                          |\n| **Gist-uploaded**  | GitHub secret gist (URL in plan-header)  | Durable until manually deleted               | Cross-session persistence for learn workflows                               |\n| **Scratch**        | `.erk/scratch/sessions/<session-id>/`    | 1 hour TTL, auto-cleaned                     | Inter-process file passing within a single session (e.g., preprocessed XML) |\n\nThe key insight: scratch storage is _not_ a session archive — it exists for transient artifacts like preprocessed XML files that a hook produces for Claude to read. The 1-hour TTL is deliberately aggressive because scratch files become stale once the producing session ends.\n\n<!-- Source: packages/erk-shared/src/erk_shared/scratch/scratch.py, cleanup_stale_scratch -->\n\nSee `cleanup_stale_scratch()` in `packages/erk-shared/src/erk_shared/scratch/scratch.py` for the TTL-based cleanup logic.\n\n## Why Gist-Based Persistence Exists\n\nThe gist upload tier was added because learn workflows frequently run in a _different_ Claude Code session from the one that created or implemented the plan. By the time learn runs, the original session file is often gone. Uploading to a gist and recording the URL in the plan-header creates a durable reference that survives session cleanup.\n\n<!-- Source: src/erk/cli/commands/exec/scripts/upload_session.py, upload_session -->\n\nSee `upload_session()` in `src/erk/cli/commands/exec/scripts/upload_session.py` for how gist creation and plan-header updates are coordinated.\n\n## Discovery Architecture\n\nSession discovery has two distinct paths because plan-aware and plan-unaware workflows need fundamentally different information.\n\n| Path             | Command                               | Starting point        | What it knows                                                           |\n| ---------------- | ------------------------------------- | --------------------- | ----------------------------------------------------------------------- |\n| **Plan-unaware** | `erk exec list-sessions`              | Local filesystem scan | Only what's on disk right now — no plan context                         |\n| **Plan-aware**   | `erk exec get-learn-sessions <issue>` | GitHub issue metadata | All sessions ever tracked for a plan, plus which are currently readable |\n\n### Why two paths matter\n\n`list-sessions` can never find sessions from other machines or prior Claude Code lifecycles — it only sees the local project directory. `get-learn-sessions` starts from GitHub metadata and checks readability, so it can identify gist-based remote sessions that `list-sessions` would never discover. It also provides the categorization (planning vs. implementation vs. learn) that analysis workflows need.\n\n<!-- Source: packages/erk-shared/src/erk_shared/sessions/discovery.py, find_sessions_for_plan -->\n\nSee `find_sessions_for_plan()` in `packages/erk-shared/src/erk_shared/sessions/discovery.py` for how plan-specific discovery extracts session IDs from multiple metadata sources (plan-header fields, impl-started/impl-ended comments, learn-invoked comments).\n\n### The local fallback decision\n\n<!-- Source: src/erk/cli/commands/exec/scripts/get_learn_sessions.py -->\n\nLocal fallback scanning (implemented in `src/erk/cli/commands/exec/scripts/get_learn_sessions.py`) only triggers when **no** GitHub-tracked sessions are readable on disk. This is intentional: local scan results have no confirmed relationship to the plan, so mixing them with plan-tracked sessions would dilute signal. They're a last resort, not a supplement.\n\nWhen the local fallback triggers, it filters sessions by the current git branch to prevent worktree slot reuse contamination. Worktree slots are reused for different plans over time, so older sessions in the same project directory may belong to an entirely different branch. The `gitBranch` field in each session's JSONL log is matched against the current worktree branch to exclude stale sessions.\n\n## Graceful Degradation Hierarchy\n\nWhen a workflow needs session data, it walks a priority-ordered hierarchy. Each level represents less certainty about plan relevance but still provides value.\n\n| Priority | Source                                               | Why it might be missing                                                |\n| -------- | ---------------------------------------------------- | ---------------------------------------------------------------------- |\n| 1        | Planning session (from plan-header)                  | Created in a prior Claude Code session, since cleaned up               |\n| 2        | Implementation session (from plan-header + comments) | Same lifecycle issue                                                   |\n| 3        | Remote gist session                                  | Gist deleted; requires download step                                   |\n| 4        | Legacy artifact session (GitHub Actions run)         | Artifacts expire after 90 days                                         |\n| 5        | Local fallback scan                                  | No metadata link to plan — recent sessions may still be relevant       |\n| 6        | Skip analysis                                        | Always available — produces no session insights but workflow continues |\n\n### Anti-pattern: hard failure on missing session\n\nNever `exit 1` or raise when a session file is unavailable. The entire hierarchy exists because session availability is _inherently unreliable_. Log a warning and degrade to the next level.\n\n### Anti-pattern: direct path construction\n\nDon't build session paths manually (e.g., `~/.claude/projects/.../sessions/{id}.jsonl`). The `ClaudeInstallation` ABC provides `find_session_globally()` for existence checks and `get_session_path()` for path resolution. Direct construction bypasses the abstraction and breaks if Claude Code changes its storage layout.\n\n## Preprocessing as a Cross-Cutting Concern\n\nSession preprocessing (JSONL-to-XML compression) sits at the boundary between session storage and session consumption. It achieves ~75-84% size reduction by stripping metadata, deduplicating command documentation, and truncating tool parameters. The key architectural choice: preprocessing writes to scratch storage, not back to the session tier, because compressed XML is a derived artifact with a short useful life.\n\nFor preprocessing details (compression metrics, chunking algorithm, output modes), see [Session Preprocessing](preprocessing.md).\n\n## Related Documentation\n\n- [Session Discovery and Fallback](discovery-fallback.md) — Discovery commands, output schemas, and the fallback hierarchy in detail\n- [Session Preprocessing](preprocessing.md) — Compression metrics, chunking algorithm, and output modes\n- [Plan Lifecycle](../planning/lifecycle.md) — How plan-header metadata tracks session references\n","structuredPatch":[{"oldStart":44,"oldLines":13,"newStart":44,"newLines":13,"lines":[" "," See `cleanup_stale_scratch()` in `packages/erk-shared/src/erk_shared/scratch/scratch.py` for the TTL-based cleanup logic."," ","-## Why Gist-Based Persistence Exists","+## Why Branch-Based Persistence Exists"," ","-The gist upload tier was added because learn workflows frequently run in a _different_ Claude Code session from the one that created or implemented the plan. By the time learn runs, the original session file is often gone. Uploading to a gist and recording the URL in the plan-header creates a durable reference that survives session cleanup.","+The branch upload tier was added because learn workflows frequently run in a _different_ Claude Code session from the one that created or implemented the plan. By the time learn runs, the original session file is often gone. Uploading to a `session/{plan_id}` branch and recording the branch reference in the plan-header creates a durable reference that survives session cleanup."," "," <!-- Source: src/erk/cli/commands/exec/scripts/upload_session.py, upload_session -->"," ","-See `upload_session()` in `src/erk/cli/commands/exec/scripts/upload_session.py` for how gist creation and plan-header updates are coordinated.","+See `upload_session()` in `src/erk/cli/commands/exec/scripts/upload_session.py` for how branch-based storage and plan-header updates are coordinated. The upload creates a branch from `origin/master`, commits the session JSONL to `.erk/session/{session_id}.jsonl`, force-pushes the branch, and updates plan metadata with `last_session_branch`, `last_session_id`, `last_session_at`, and `last_session_source` fields."," "," ## Discovery Architecture"," "]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"8583dc15-8ced-4369-9c45-16d2f18bb5ed","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01JyGHDe1ackCZti9N74LbtD","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me update the storage tiers table to match. The \"Gist-uploaded\" tier needs to be updated to \"Branch-uploaded\":"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":3876,"cache_read_input_tokens":76945,"cache_creation":{"ephemeral_5m_input_tokens":3876,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4jiggaizqbfXAdnJM3","type":"assistant","uuid":"6e2dbd6e-c92b-4d59-98a6-d0391197c1a2","timestamp":"2026-02-21T23:15:43.153Z"}
{"parentUuid":"6e2dbd6e-c92b-4d59-98a6-d0391197c1a2","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01JyGHDe1ackCZti9N74LbtD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016rpLGtLSz1yHzcXDNPqvMS","name":"Edit","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/sessions/lifecycle.md","old_string":"| **Gist-uploaded**  | GitHub secret gist (URL in plan-header)  | Durable until manually deleted               | Cross-session persistence for learn workflows                               |","new_string":"| **Branch-uploaded** | `session/{plan_id}` branch on origin     | Durable until branch deleted                  | Cross-session persistence for learn workflows                               |"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":3876,"cache_read_input_tokens":76945,"cache_creation":{"ephemeral_5m_input_tokens":3876,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4jiggaizqbfXAdnJM3","type":"assistant","uuid":"2db3efd5-ec63-441c-81da-0a49c2f836f8","timestamp":"2026-02-21T23:15:45.720Z"}
{"parentUuid":"2db3efd5-ec63-441c-81da-0a49c2f836f8","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016rpLGtLSz1yHzcXDNPqvMS","type":"tool_result","content":"The file /home/runner/work/erk/erk/docs/learned/sessions/lifecycle.md has been updated successfully."}]},"uuid":"97e66162-95c7-4b82-8da7-ff2a3b20b939","timestamp":"2026-02-21T23:15:46.460Z","toolUseResult":{"filePath":"/home/runner/work/erk/erk/docs/learned/sessions/lifecycle.md","oldString":"| **Gist-uploaded**  | GitHub secret gist (URL in plan-header)  | Durable until manually deleted               | Cross-session persistence for learn workflows                               |","newString":"| **Branch-uploaded** | `session/{plan_id}` branch on origin     | Durable until branch deleted                  | Cross-session persistence for learn workflows                               |","originalFile":"---\ntitle: Session File Lifecycle and Persistence\nread_when:\n  - \"working with Claude Code session files across workflows\"\n  - \"implementing learn or analysis workflows that consume session data\"\n  - \"debugging missing session files in plan-based workflows\"\ntripwires:\n  - action: \"accessing a session by ID without checking existence first\"\n    warning: \"Session files are session-scoped — Claude Code may clean them up at any time. Always use LBYL discovery (ClaudeInstallation.find_session_globally) before reading.\"\n  - action: \"failing a workflow because a session file is missing\"\n    warning: \"Missing sessions must never cause hard failure. Degrade through the fallback hierarchy: planning → implementation → gist → local scan → skip.\"\n  - action: \"constructing session file paths manually\"\n    warning: \"Use ClaudeInstallation ABC methods, not manual path construction. Storage layout is an implementation detail that may change.\"\nlast_audited: \"2026-02-16 14:20 PT\"\naudit_result: edited\n---\n\n# Session File Lifecycle and Persistence\n\nThis document explains _why_ session file availability is unreliable and the architectural decisions that flow from that constraint. The core problem: erk workflows (learn, analysis) often need session data from _previous_ Claude Code sessions, but Claude Code owns the session storage lifecycle and may clean up files at any time. Erk cannot control this policy.\n\n## The Fundamental Constraint\n\nSession JSONL files are managed by Claude Code, not erk. Their lifetime is tied to the Claude Code session that created them, with no guaranteed persistence beyond that. This means a session ID stored in GitHub issue metadata (plan-header fields, issue comments) may point to a file that no longer exists on disk.\n\nThis constraint drives two architectural decisions:\n\n1. **All session access must go through discovery** — never assume an ID maps to a file\n2. **All session-consuming workflows must degrade gracefully** — missing data narrows scope but never causes failure\n\n## Three Storage Tiers\n\nSession data lives in three places with different persistence guarantees. Understanding which tier you're working with determines how you handle availability.\n\n| Tier               | Location                                 | Persistence                                  | Purpose                                                                     |\n| ------------------ | ---------------------------------------- | -------------------------------------------- | --------------------------------------------------------------------------- |\n| **Claude-managed** | `~/.claude/projects/<project>/sessions/` | Unpredictable — Claude Code controls cleanup | Primary session storage; most workflows start here                          |\n| **Gist-uploaded**  | GitHub secret gist (URL in plan-header)  | Durable until manually deleted               | Cross-session persistence for learn workflows                               |\n| **Scratch**        | `.erk/scratch/sessions/<session-id>/`    | 1 hour TTL, auto-cleaned                     | Inter-process file passing within a single session (e.g., preprocessed XML) |\n\nThe key insight: scratch storage is _not_ a session archive — it exists for transient artifacts like preprocessed XML files that a hook produces for Claude to read. The 1-hour TTL is deliberately aggressive because scratch files become stale once the producing session ends.\n\n<!-- Source: packages/erk-shared/src/erk_shared/scratch/scratch.py, cleanup_stale_scratch -->\n\nSee `cleanup_stale_scratch()` in `packages/erk-shared/src/erk_shared/scratch/scratch.py` for the TTL-based cleanup logic.\n\n## Why Branch-Based Persistence Exists\n\nThe branch upload tier was added because learn workflows frequently run in a _different_ Claude Code session from the one that created or implemented the plan. By the time learn runs, the original session file is often gone. Uploading to a `session/{plan_id}` branch and recording the branch reference in the plan-header creates a durable reference that survives session cleanup.\n\n<!-- Source: src/erk/cli/commands/exec/scripts/upload_session.py, upload_session -->\n\nSee `upload_session()` in `src/erk/cli/commands/exec/scripts/upload_session.py` for how branch-based storage and plan-header updates are coordinated. The upload creates a branch from `origin/master`, commits the session JSONL to `.erk/session/{session_id}.jsonl`, force-pushes the branch, and updates plan metadata with `last_session_branch`, `last_session_id`, `last_session_at`, and `last_session_source` fields.\n\n## Discovery Architecture\n\nSession discovery has two distinct paths because plan-aware and plan-unaware workflows need fundamentally different information.\n\n| Path             | Command                               | Starting point        | What it knows                                                           |\n| ---------------- | ------------------------------------- | --------------------- | ----------------------------------------------------------------------- |\n| **Plan-unaware** | `erk exec list-sessions`              | Local filesystem scan | Only what's on disk right now — no plan context                         |\n| **Plan-aware**   | `erk exec get-learn-sessions <issue>` | GitHub issue metadata | All sessions ever tracked for a plan, plus which are currently readable |\n\n### Why two paths matter\n\n`list-sessions` can never find sessions from other machines or prior Claude Code lifecycles — it only sees the local project directory. `get-learn-sessions` starts from GitHub metadata and checks readability, so it can identify gist-based remote sessions that `list-sessions` would never discover. It also provides the categorization (planning vs. implementation vs. learn) that analysis workflows need.\n\n<!-- Source: packages/erk-shared/src/erk_shared/sessions/discovery.py, find_sessions_for_plan -->\n\nSee `find_sessions_for_plan()` in `packages/erk-shared/src/erk_shared/sessions/discovery.py` for how plan-specific discovery extracts session IDs from multiple metadata sources (plan-header fields, impl-started/impl-ended comments, learn-invoked comments).\n\n### The local fallback decision\n\n<!-- Source: src/erk/cli/commands/exec/scripts/get_learn_sessions.py -->\n\nLocal fallback scanning (implemented in `src/erk/cli/commands/exec/scripts/get_learn_sessions.py`) only triggers when **no** GitHub-tracked sessions are readable on disk. This is intentional: local scan results have no confirmed relationship to the plan, so mixing them with plan-tracked sessions would dilute signal. They're a last resort, not a supplement.\n\nWhen the local fallback triggers, it filters sessions by the current git branch to prevent worktree slot reuse contamination. Worktree slots are reused for different plans over time, so older sessions in the same project directory may belong to an entirely different branch. The `gitBranch` field in each session's JSONL log is matched against the current worktree branch to exclude stale sessions.\n\n## Graceful Degradation Hierarchy\n\nWhen a workflow needs session data, it walks a priority-ordered hierarchy. Each level represents less certainty about plan relevance but still provides value.\n\n| Priority | Source                                               | Why it might be missing                                                |\n| -------- | ---------------------------------------------------- | ---------------------------------------------------------------------- |\n| 1        | Planning session (from plan-header)                  | Created in a prior Claude Code session, since cleaned up               |\n| 2        | Implementation session (from plan-header + comments) | Same lifecycle issue                                                   |\n| 3        | Remote gist session                                  | Gist deleted; requires download step                                   |\n| 4        | Legacy artifact session (GitHub Actions run)         | Artifacts expire after 90 days                                         |\n| 5        | Local fallback scan                                  | No metadata link to plan — recent sessions may still be relevant       |\n| 6        | Skip analysis                                        | Always available — produces no session insights but workflow continues |\n\n### Anti-pattern: hard failure on missing session\n\nNever `exit 1` or raise when a session file is unavailable. The entire hierarchy exists because session availability is _inherently unreliable_. Log a warning and degrade to the next level.\n\n### Anti-pattern: direct path construction\n\nDon't build session paths manually (e.g., `~/.claude/projects/.../sessions/{id}.jsonl`). The `ClaudeInstallation` ABC provides `find_session_globally()` for existence checks and `get_session_path()` for path resolution. Direct construction bypasses the abstraction and breaks if Claude Code changes its storage layout.\n\n## Preprocessing as a Cross-Cutting Concern\n\nSession preprocessing (JSONL-to-XML compression) sits at the boundary between session storage and session consumption. It achieves ~75-84% size reduction by stripping metadata, deduplicating command documentation, and truncating tool parameters. The key architectural choice: preprocessing writes to scratch storage, not back to the session tier, because compressed XML is a derived artifact with a short useful life.\n\nFor preprocessing details (compression metrics, chunking algorithm, output modes), see [Session Preprocessing](preprocessing.md).\n\n## Related Documentation\n\n- [Session Discovery and Fallback](discovery-fallback.md) — Discovery commands, output schemas, and the fallback hierarchy in detail\n- [Session Preprocessing](preprocessing.md) — Compression metrics, chunking algorithm, and output modes\n- [Plan Lifecycle](../planning/lifecycle.md) — How plan-header metadata tracks session references\n","structuredPatch":[{"oldStart":35,"oldLines":7,"newStart":35,"newLines":7,"lines":[" | Tier               | Location                                 | Persistence                                  | Purpose                                                                     |"," | ------------------ | ---------------------------------------- | -------------------------------------------- | --------------------------------------------------------------------------- |"," | **Claude-managed** | `~/.claude/projects/<project>/sessions/` | Unpredictable — Claude Code controls cleanup | Primary session storage; most workflows start here                          |","-| **Gist-uploaded**  | GitHub secret gist (URL in plan-header)  | Durable until manually deleted               | Cross-session persistence for learn workflows                               |","+| **Branch-uploaded** | `session/{plan_id}` branch on origin     | Durable until branch deleted                  | Cross-session persistence for learn workflows                               |"," | **Scratch**        | `.erk/scratch/sessions/<session-id>/`    | 1 hour TTL, auto-cleaned                     | Inter-process file passing within a single session (e.g., preprocessed XML) |"," "," The key insight: scratch storage is _not_ a session archive — it exists for transient artifacts like preprocessed XML files that a hook produces for Claude to read. The 1-hour TTL is deliberately aggressive because scratch files become stale once the producing session ends."]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"97e66162-95c7-4b82-8da7-ff2a3b20b939","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01WvR57uceKMLuRmNEUMYNKc","type":"message","role":"assistant","content":[{"type":"text","text":"Now check for other gist references in the file. Let me also update the discovery table and degradation hierarchy:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":262,"cache_read_input_tokens":80821,"cache_creation":{"ephemeral_5m_input_tokens":262,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4kAKo35PFM6BLM4FGt","type":"assistant","uuid":"114a7764-a080-47da-959e-02cdb92bc7ba","timestamp":"2026-02-21T23:15:49.150Z"}
{"parentUuid":"114a7764-a080-47da-959e-02cdb92bc7ba","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01WvR57uceKMLuRmNEUMYNKc","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Tyib319MCPcnMBCXq6vxdV","name":"Grep","input":{"pattern":"gist","path":"/home/runner/work/erk/erk/docs/learned/sessions/lifecycle.md","output_mode":"content","-n":true},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":262,"cache_read_input_tokens":80821,"cache_creation":{"ephemeral_5m_input_tokens":262,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4kAKo35PFM6BLM4FGt","type":"assistant","uuid":"57dd2a7e-89c7-494a-8125-bb2823413196","timestamp":"2026-02-21T23:15:50.064Z"}
{"parentUuid":"57dd2a7e-89c7-494a-8125-bb2823413196","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Tyib319MCPcnMBCXq6vxdV","type":"tool_result","content":"11:    warning: \"Missing sessions must never cause hard failure. Degrade through the fallback hierarchy: planning → implementation → gist → local scan → skip.\"\n66:`list-sessions` can never find sessions from other machines or prior Claude Code lifecycles — it only sees the local project directory. `get-learn-sessions` starts from GitHub metadata and checks readability, so it can identify gist-based remote sessions that `list-sessions` would never discover. It also provides the categorization (planning vs. implementation vs. learn) that analysis workflows need.\n88:| 3        | Remote gist session                                  | Gist deleted; requires download step                                   |"}]},"uuid":"09ad0cde-b52d-48a1-b1e5-be975d8244c1","timestamp":"2026-02-21T23:15:50.622Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"11:    warning: \"Missing sessions must never cause hard failure. Degrade through the fallback hierarchy: planning → implementation → gist → local scan → skip.\"\n66:`list-sessions` can never find sessions from other machines or prior Claude Code lifecycles — it only sees the local project directory. `get-learn-sessions` starts from GitHub metadata and checks readability, so it can identify gist-based remote sessions that `list-sessions` would never discover. It also provides the categorization (planning vs. implementation vs. learn) that analysis workflows need.\n88:| 3        | Remote gist session                                  | Gist deleted; requires download step                                   |","numLines":3}}
{"parentUuid":"09ad0cde-b52d-48a1-b1e5-be975d8244c1","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01WnHzs5CFjHfUQFFELXU755","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MstEKCn7SEWkXGnHj6DYA7","name":"Edit","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/sessions/lifecycle.md","old_string":"    warning: \"Missing sessions must never cause hard failure. Degrade through the fallback hierarchy: planning → implementation → gist → local scan → skip.\"","new_string":"    warning: \"Missing sessions must never cause hard failure. Degrade through the fallback hierarchy: planning → implementation → branch → local scan → skip.\""},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":646,"cache_read_input_tokens":81083,"cache_creation":{"ephemeral_5m_input_tokens":646,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4kU6sRz9CR5D7YYeE2","type":"assistant","uuid":"441603e7-2f26-47c7-8a68-beff94947ae7","timestamp":"2026-02-21T23:15:53.620Z"}
{"parentUuid":"441603e7-2f26-47c7-8a68-beff94947ae7","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MstEKCn7SEWkXGnHj6DYA7","type":"tool_result","content":"The file /home/runner/work/erk/erk/docs/learned/sessions/lifecycle.md has been updated successfully."}]},"uuid":"deaebaec-a5a4-47a1-aa90-6301ed0e403a","timestamp":"2026-02-21T23:15:54.361Z","toolUseResult":{"filePath":"/home/runner/work/erk/erk/docs/learned/sessions/lifecycle.md","oldString":"    warning: \"Missing sessions must never cause hard failure. Degrade through the fallback hierarchy: planning → implementation → gist → local scan → skip.\"","newString":"    warning: \"Missing sessions must never cause hard failure. Degrade through the fallback hierarchy: planning → implementation → branch → local scan → skip.\"","originalFile":"---\ntitle: Session File Lifecycle and Persistence\nread_when:\n  - \"working with Claude Code session files across workflows\"\n  - \"implementing learn or analysis workflows that consume session data\"\n  - \"debugging missing session files in plan-based workflows\"\ntripwires:\n  - action: \"accessing a session by ID without checking existence first\"\n    warning: \"Session files are session-scoped — Claude Code may clean them up at any time. Always use LBYL discovery (ClaudeInstallation.find_session_globally) before reading.\"\n  - action: \"failing a workflow because a session file is missing\"\n    warning: \"Missing sessions must never cause hard failure. Degrade through the fallback hierarchy: planning → implementation → gist → local scan → skip.\"\n  - action: \"constructing session file paths manually\"\n    warning: \"Use ClaudeInstallation ABC methods, not manual path construction. Storage layout is an implementation detail that may change.\"\nlast_audited: \"2026-02-16 14:20 PT\"\naudit_result: edited\n---\n\n# Session File Lifecycle and Persistence\n\nThis document explains _why_ session file availability is unreliable and the architectural decisions that flow from that constraint. The core problem: erk workflows (learn, analysis) often need session data from _previous_ Claude Code sessions, but Claude Code owns the session storage lifecycle and may clean up files at any time. Erk cannot control this policy.\n\n## The Fundamental Constraint\n\nSession JSONL files are managed by Claude Code, not erk. Their lifetime is tied to the Claude Code session that created them, with no guaranteed persistence beyond that. This means a session ID stored in GitHub issue metadata (plan-header fields, issue comments) may point to a file that no longer exists on disk.\n\nThis constraint drives two architectural decisions:\n\n1. **All session access must go through discovery** — never assume an ID maps to a file\n2. **All session-consuming workflows must degrade gracefully** — missing data narrows scope but never causes failure\n\n## Three Storage Tiers\n\nSession data lives in three places with different persistence guarantees. Understanding which tier you're working with determines how you handle availability.\n\n| Tier               | Location                                 | Persistence                                  | Purpose                                                                     |\n| ------------------ | ---------------------------------------- | -------------------------------------------- | --------------------------------------------------------------------------- |\n| **Claude-managed** | `~/.claude/projects/<project>/sessions/` | Unpredictable — Claude Code controls cleanup | Primary session storage; most workflows start here                          |\n| **Branch-uploaded** | `session/{plan_id}` branch on origin     | Durable until branch deleted                  | Cross-session persistence for learn workflows                               |\n| **Scratch**        | `.erk/scratch/sessions/<session-id>/`    | 1 hour TTL, auto-cleaned                     | Inter-process file passing within a single session (e.g., preprocessed XML) |\n\nThe key insight: scratch storage is _not_ a session archive — it exists for transient artifacts like preprocessed XML files that a hook produces for Claude to read. The 1-hour TTL is deliberately aggressive because scratch files become stale once the producing session ends.\n\n<!-- Source: packages/erk-shared/src/erk_shared/scratch/scratch.py, cleanup_stale_scratch -->\n\nSee `cleanup_stale_scratch()` in `packages/erk-shared/src/erk_shared/scratch/scratch.py` for the TTL-based cleanup logic.\n\n## Why Branch-Based Persistence Exists\n\nThe branch upload tier was added because learn workflows frequently run in a _different_ Claude Code session from the one that created or implemented the plan. By the time learn runs, the original session file is often gone. Uploading to a `session/{plan_id}` branch and recording the branch reference in the plan-header creates a durable reference that survives session cleanup.\n\n<!-- Source: src/erk/cli/commands/exec/scripts/upload_session.py, upload_session -->\n\nSee `upload_session()` in `src/erk/cli/commands/exec/scripts/upload_session.py` for how branch-based storage and plan-header updates are coordinated. The upload creates a branch from `origin/master`, commits the session JSONL to `.erk/session/{session_id}.jsonl`, force-pushes the branch, and updates plan metadata with `last_session_branch`, `last_session_id`, `last_session_at`, and `last_session_source` fields.\n\n## Discovery Architecture\n\nSession discovery has two distinct paths because plan-aware and plan-unaware workflows need fundamentally different information.\n\n| Path             | Command                               | Starting point        | What it knows                                                           |\n| ---------------- | ------------------------------------- | --------------------- | ----------------------------------------------------------------------- |\n| **Plan-unaware** | `erk exec list-sessions`              | Local filesystem scan | Only what's on disk right now — no plan context                         |\n| **Plan-aware**   | `erk exec get-learn-sessions <issue>` | GitHub issue metadata | All sessions ever tracked for a plan, plus which are currently readable |\n\n### Why two paths matter\n\n`list-sessions` can never find sessions from other machines or prior Claude Code lifecycles — it only sees the local project directory. `get-learn-sessions` starts from GitHub metadata and checks readability, so it can identify gist-based remote sessions that `list-sessions` would never discover. It also provides the categorization (planning vs. implementation vs. learn) that analysis workflows need.\n\n<!-- Source: packages/erk-shared/src/erk_shared/sessions/discovery.py, find_sessions_for_plan -->\n\nSee `find_sessions_for_plan()` in `packages/erk-shared/src/erk_shared/sessions/discovery.py` for how plan-specific discovery extracts session IDs from multiple metadata sources (plan-header fields, impl-started/impl-ended comments, learn-invoked comments).\n\n### The local fallback decision\n\n<!-- Source: src/erk/cli/commands/exec/scripts/get_learn_sessions.py -->\n\nLocal fallback scanning (implemented in `src/erk/cli/commands/exec/scripts/get_learn_sessions.py`) only triggers when **no** GitHub-tracked sessions are readable on disk. This is intentional: local scan results have no confirmed relationship to the plan, so mixing them with plan-tracked sessions would dilute signal. They're a last resort, not a supplement.\n\nWhen the local fallback triggers, it filters sessions by the current git branch to prevent worktree slot reuse contamination. Worktree slots are reused for different plans over time, so older sessions in the same project directory may belong to an entirely different branch. The `gitBranch` field in each session's JSONL log is matched against the current worktree branch to exclude stale sessions.\n\n## Graceful Degradation Hierarchy\n\nWhen a workflow needs session data, it walks a priority-ordered hierarchy. Each level represents less certainty about plan relevance but still provides value.\n\n| Priority | Source                                               | Why it might be missing                                                |\n| -------- | ---------------------------------------------------- | ---------------------------------------------------------------------- |\n| 1        | Planning session (from plan-header)                  | Created in a prior Claude Code session, since cleaned up               |\n| 2        | Implementation session (from plan-header + comments) | Same lifecycle issue                                                   |\n| 3        | Remote gist session                                  | Gist deleted; requires download step                                   |\n| 4        | Legacy artifact session (GitHub Actions run)         | Artifacts expire after 90 days                                         |\n| 5        | Local fallback scan                                  | No metadata link to plan — recent sessions may still be relevant       |\n| 6        | Skip analysis                                        | Always available — produces no session insights but workflow continues |\n\n### Anti-pattern: hard failure on missing session\n\nNever `exit 1` or raise when a session file is unavailable. The entire hierarchy exists because session availability is _inherently unreliable_. Log a warning and degrade to the next level.\n\n### Anti-pattern: direct path construction\n\nDon't build session paths manually (e.g., `~/.claude/projects/.../sessions/{id}.jsonl`). The `ClaudeInstallation` ABC provides `find_session_globally()` for existence checks and `get_session_path()` for path resolution. Direct construction bypasses the abstraction and breaks if Claude Code changes its storage layout.\n\n## Preprocessing as a Cross-Cutting Concern\n\nSession preprocessing (JSONL-to-XML compression) sits at the boundary between session storage and session consumption. It achieves ~75-84% size reduction by stripping metadata, deduplicating command documentation, and truncating tool parameters. The key architectural choice: preprocessing writes to scratch storage, not back to the session tier, because compressed XML is a derived artifact with a short useful life.\n\nFor preprocessing details (compression metrics, chunking algorithm, output modes), see [Session Preprocessing](preprocessing.md).\n\n## Related Documentation\n\n- [Session Discovery and Fallback](discovery-fallback.md) — Discovery commands, output schemas, and the fallback hierarchy in detail\n- [Session Preprocessing](preprocessing.md) — Compression metrics, chunking algorithm, and output modes\n- [Plan Lifecycle](../planning/lifecycle.md) — How plan-header metadata tracks session references\n","structuredPatch":[{"oldStart":8,"oldLines":7,"newStart":8,"newLines":7,"lines":["   - action: \"accessing a session by ID without checking existence first\"","     warning: \"Session files are session-scoped — Claude Code may clean them up at any time. Always use LBYL discovery (ClaudeInstallation.find_session_globally) before reading.\"","   - action: \"failing a workflow because a session file is missing\"","-    warning: \"Missing sessions must never cause hard failure. Degrade through the fallback hierarchy: planning → implementation → gist → local scan → skip.\"","+    warning: \"Missing sessions must never cause hard failure. Degrade through the fallback hierarchy: planning → implementation → branch → local scan → skip.\"","   - action: \"constructing session file paths manually\"","     warning: \"Use ClaudeInstallation ABC methods, not manual path construction. Storage layout is an implementation detail that may change.\""," last_audited: \"2026-02-16 14:20 PT\""]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"deaebaec-a5a4-47a1-aa90-6301ed0e403a","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01USwyTMreeb8FFMCzQu9Nue","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0166TeVB9vaPg1WDL5owryWQ","name":"Edit","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/sessions/lifecycle.md","old_string":"`list-sessions` can never find sessions from other machines or prior Claude Code lifecycles — it only sees the local project directory. `get-learn-sessions` starts from GitHub metadata and checks readability, so it can identify gist-based remote sessions that `list-sessions` would never discover. It also provides the categorization (planning vs. implementation vs. learn) that analysis workflows need.","new_string":"`list-sessions` can never find sessions from other machines or prior Claude Code lifecycles — it only sees the local project directory. `get-learn-sessions` starts from GitHub metadata and checks readability, so it can identify branch-based remote sessions that `list-sessions` would never discover. It also provides the categorization (planning vs. implementation vs. learn) that analysis workflows need."},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":215,"cache_read_input_tokens":81729,"cache_creation":{"ephemeral_5m_input_tokens":215,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4kk6YiGsmkaPZa9vVD","type":"assistant","uuid":"588ed86a-e5fe-4a12-8c9d-b9e28b1f1d5e","timestamp":"2026-02-21T23:15:58.143Z"}
{"parentUuid":"588ed86a-e5fe-4a12-8c9d-b9e28b1f1d5e","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0166TeVB9vaPg1WDL5owryWQ","type":"tool_result","content":"The file /home/runner/work/erk/erk/docs/learned/sessions/lifecycle.md has been updated successfully."}]},"uuid":"24216cc6-0a12-4f20-9ae7-63be98676305","timestamp":"2026-02-21T23:15:58.863Z","toolUseResult":{"filePath":"/home/runner/work/erk/erk/docs/learned/sessions/lifecycle.md","oldString":"`list-sessions` can never find sessions from other machines or prior Claude Code lifecycles — it only sees the local project directory. `get-learn-sessions` starts from GitHub metadata and checks readability, so it can identify gist-based remote sessions that `list-sessions` would never discover. It also provides the categorization (planning vs. implementation vs. learn) that analysis workflows need.","newString":"`list-sessions` can never find sessions from other machines or prior Claude Code lifecycles — it only sees the local project directory. `get-learn-sessions` starts from GitHub metadata and checks readability, so it can identify branch-based remote sessions that `list-sessions` would never discover. It also provides the categorization (planning vs. implementation vs. learn) that analysis workflows need.","originalFile":"---\ntitle: Session File Lifecycle and Persistence\nread_when:\n  - \"working with Claude Code session files across workflows\"\n  - \"implementing learn or analysis workflows that consume session data\"\n  - \"debugging missing session files in plan-based workflows\"\ntripwires:\n  - action: \"accessing a session by ID without checking existence first\"\n    warning: \"Session files are session-scoped — Claude Code may clean them up at any time. Always use LBYL discovery (ClaudeInstallation.find_session_globally) before reading.\"\n  - action: \"failing a workflow because a session file is missing\"\n    warning: \"Missing sessions must never cause hard failure. Degrade through the fallback hierarchy: planning → implementation → branch → local scan → skip.\"\n  - action: \"constructing session file paths manually\"\n    warning: \"Use ClaudeInstallation ABC methods, not manual path construction. Storage layout is an implementation detail that may change.\"\nlast_audited: \"2026-02-16 14:20 PT\"\naudit_result: edited\n---\n\n# Session File Lifecycle and Persistence\n\nThis document explains _why_ session file availability is unreliable and the architectural decisions that flow from that constraint. The core problem: erk workflows (learn, analysis) often need session data from _previous_ Claude Code sessions, but Claude Code owns the session storage lifecycle and may clean up files at any time. Erk cannot control this policy.\n\n## The Fundamental Constraint\n\nSession JSONL files are managed by Claude Code, not erk. Their lifetime is tied to the Claude Code session that created them, with no guaranteed persistence beyond that. This means a session ID stored in GitHub issue metadata (plan-header fields, issue comments) may point to a file that no longer exists on disk.\n\nThis constraint drives two architectural decisions:\n\n1. **All session access must go through discovery** — never assume an ID maps to a file\n2. **All session-consuming workflows must degrade gracefully** — missing data narrows scope but never causes failure\n\n## Three Storage Tiers\n\nSession data lives in three places with different persistence guarantees. Understanding which tier you're working with determines how you handle availability.\n\n| Tier               | Location                                 | Persistence                                  | Purpose                                                                     |\n| ------------------ | ---------------------------------------- | -------------------------------------------- | --------------------------------------------------------------------------- |\n| **Claude-managed** | `~/.claude/projects/<project>/sessions/` | Unpredictable — Claude Code controls cleanup | Primary session storage; most workflows start here                          |\n| **Branch-uploaded** | `session/{plan_id}` branch on origin     | Durable until branch deleted                  | Cross-session persistence for learn workflows                               |\n| **Scratch**        | `.erk/scratch/sessions/<session-id>/`    | 1 hour TTL, auto-cleaned                     | Inter-process file passing within a single session (e.g., preprocessed XML) |\n\nThe key insight: scratch storage is _not_ a session archive — it exists for transient artifacts like preprocessed XML files that a hook produces for Claude to read. The 1-hour TTL is deliberately aggressive because scratch files become stale once the producing session ends.\n\n<!-- Source: packages/erk-shared/src/erk_shared/scratch/scratch.py, cleanup_stale_scratch -->\n\nSee `cleanup_stale_scratch()` in `packages/erk-shared/src/erk_shared/scratch/scratch.py` for the TTL-based cleanup logic.\n\n## Why Branch-Based Persistence Exists\n\nThe branch upload tier was added because learn workflows frequently run in a _different_ Claude Code session from the one that created or implemented the plan. By the time learn runs, the original session file is often gone. Uploading to a `session/{plan_id}` branch and recording the branch reference in the plan-header creates a durable reference that survives session cleanup.\n\n<!-- Source: src/erk/cli/commands/exec/scripts/upload_session.py, upload_session -->\n\nSee `upload_session()` in `src/erk/cli/commands/exec/scripts/upload_session.py` for how branch-based storage and plan-header updates are coordinated. The upload creates a branch from `origin/master`, commits the session JSONL to `.erk/session/{session_id}.jsonl`, force-pushes the branch, and updates plan metadata with `last_session_branch`, `last_session_id`, `last_session_at`, and `last_session_source` fields.\n\n## Discovery Architecture\n\nSession discovery has two distinct paths because plan-aware and plan-unaware workflows need fundamentally different information.\n\n| Path             | Command                               | Starting point        | What it knows                                                           |\n| ---------------- | ------------------------------------- | --------------------- | ----------------------------------------------------------------------- |\n| **Plan-unaware** | `erk exec list-sessions`              | Local filesystem scan | Only what's on disk right now — no plan context                         |\n| **Plan-aware**   | `erk exec get-learn-sessions <issue>` | GitHub issue metadata | All sessions ever tracked for a plan, plus which are currently readable |\n\n### Why two paths matter\n\n`list-sessions` can never find sessions from other machines or prior Claude Code lifecycles — it only sees the local project directory. `get-learn-sessions` starts from GitHub metadata and checks readability, so it can identify gist-based remote sessions that `list-sessions` would never discover. It also provides the categorization (planning vs. implementation vs. learn) that analysis workflows need.\n\n<!-- Source: packages/erk-shared/src/erk_shared/sessions/discovery.py, find_sessions_for_plan -->\n\nSee `find_sessions_for_plan()` in `packages/erk-shared/src/erk_shared/sessions/discovery.py` for how plan-specific discovery extracts session IDs from multiple metadata sources (plan-header fields, impl-started/impl-ended comments, learn-invoked comments).\n\n### The local fallback decision\n\n<!-- Source: src/erk/cli/commands/exec/scripts/get_learn_sessions.py -->\n\nLocal fallback scanning (implemented in `src/erk/cli/commands/exec/scripts/get_learn_sessions.py`) only triggers when **no** GitHub-tracked sessions are readable on disk. This is intentional: local scan results have no confirmed relationship to the plan, so mixing them with plan-tracked sessions would dilute signal. They're a last resort, not a supplement.\n\nWhen the local fallback triggers, it filters sessions by the current git branch to prevent worktree slot reuse contamination. Worktree slots are reused for different plans over time, so older sessions in the same project directory may belong to an entirely different branch. The `gitBranch` field in each session's JSONL log is matched against the current worktree branch to exclude stale sessions.\n\n## Graceful Degradation Hierarchy\n\nWhen a workflow needs session data, it walks a priority-ordered hierarchy. Each level represents less certainty about plan relevance but still provides value.\n\n| Priority | Source                                               | Why it might be missing                                                |\n| -------- | ---------------------------------------------------- | ---------------------------------------------------------------------- |\n| 1        | Planning session (from plan-header)                  | Created in a prior Claude Code session, since cleaned up               |\n| 2        | Implementation session (from plan-header + comments) | Same lifecycle issue                                                   |\n| 3        | Remote gist session                                  | Gist deleted; requires download step                                   |\n| 4        | Legacy artifact session (GitHub Actions run)         | Artifacts expire after 90 days                                         |\n| 5        | Local fallback scan                                  | No metadata link to plan — recent sessions may still be relevant       |\n| 6        | Skip analysis                                        | Always available — produces no session insights but workflow continues |\n\n### Anti-pattern: hard failure on missing session\n\nNever `exit 1` or raise when a session file is unavailable. The entire hierarchy exists because session availability is _inherently unreliable_. Log a warning and degrade to the next level.\n\n### Anti-pattern: direct path construction\n\nDon't build session paths manually (e.g., `~/.claude/projects/.../sessions/{id}.jsonl`). The `ClaudeInstallation` ABC provides `find_session_globally()` for existence checks and `get_session_path()` for path resolution. Direct construction bypasses the abstraction and breaks if Claude Code changes its storage layout.\n\n## Preprocessing as a Cross-Cutting Concern\n\nSession preprocessing (JSONL-to-XML compression) sits at the boundary between session storage and session consumption. It achieves ~75-84% size reduction by stripping metadata, deduplicating command documentation, and truncating tool parameters. The key architectural choice: preprocessing writes to scratch storage, not back to the session tier, because compressed XML is a derived artifact with a short useful life.\n\nFor preprocessing details (compression metrics, chunking algorithm, output modes), see [Session Preprocessing](preprocessing.md).\n\n## Related Documentation\n\n- [Session Discovery and Fallback](discovery-fallback.md) — Discovery commands, output schemas, and the fallback hierarchy in detail\n- [Session Preprocessing](preprocessing.md) — Compression metrics, chunking algorithm, and output modes\n- [Plan Lifecycle](../planning/lifecycle.md) — How plan-header metadata tracks session references\n","structuredPatch":[{"oldStart":63,"oldLines":7,"newStart":63,"newLines":7,"lines":[" "," ### Why two paths matter"," ","-`list-sessions` can never find sessions from other machines or prior Claude Code lifecycles — it only sees the local project directory. `get-learn-sessions` starts from GitHub metadata and checks readability, so it can identify gist-based remote sessions that `list-sessions` would never discover. It also provides the categorization (planning vs. implementation vs. learn) that analysis workflows need.","+`list-sessions` can never find sessions from other machines or prior Claude Code lifecycles — it only sees the local project directory. `get-learn-sessions` starts from GitHub metadata and checks readability, so it can identify branch-based remote sessions that `list-sessions` would never discover. It also provides the categorization (planning vs. implementation vs. learn) that analysis workflows need."," "," <!-- Source: packages/erk-shared/src/erk_shared/sessions/discovery.py, find_sessions_for_plan -->"," "]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"24216cc6-0a12-4f20-9ae7-63be98676305","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_018TFmDsJcxzy7BwdfEEU7rP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0123jQeNpAEuex6sYWjgpyWJ","name":"Edit","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/sessions/lifecycle.md","old_string":"| 3        | Remote gist session                                  | Gist deleted; requires download step                                   |","new_string":"| 3        | Remote branch session                                | Branch deleted; requires checkout step                                 |"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":313,"cache_read_input_tokens":81944,"cache_creation":{"ephemeral_5m_input_tokens":313,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4m5KSJ9rgLDMB4Lzhx","type":"assistant","uuid":"5eb5385d-2c6a-4943-be47-39c3f1991896","timestamp":"2026-02-21T23:16:01.622Z"}
{"parentUuid":"5eb5385d-2c6a-4943-be47-39c3f1991896","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0123jQeNpAEuex6sYWjgpyWJ","type":"tool_result","content":"The file /home/runner/work/erk/erk/docs/learned/sessions/lifecycle.md has been updated successfully."}]},"uuid":"f3c69b4d-c937-4fe8-87aa-cce16eee6702","timestamp":"2026-02-21T23:16:02.358Z","toolUseResult":{"filePath":"/home/runner/work/erk/erk/docs/learned/sessions/lifecycle.md","oldString":"| 3        | Remote gist session                                  | Gist deleted; requires download step                                   |","newString":"| 3        | Remote branch session                                | Branch deleted; requires checkout step                                 |","originalFile":"---\ntitle: Session File Lifecycle and Persistence\nread_when:\n  - \"working with Claude Code session files across workflows\"\n  - \"implementing learn or analysis workflows that consume session data\"\n  - \"debugging missing session files in plan-based workflows\"\ntripwires:\n  - action: \"accessing a session by ID without checking existence first\"\n    warning: \"Session files are session-scoped — Claude Code may clean them up at any time. Always use LBYL discovery (ClaudeInstallation.find_session_globally) before reading.\"\n  - action: \"failing a workflow because a session file is missing\"\n    warning: \"Missing sessions must never cause hard failure. Degrade through the fallback hierarchy: planning → implementation → branch → local scan → skip.\"\n  - action: \"constructing session file paths manually\"\n    warning: \"Use ClaudeInstallation ABC methods, not manual path construction. Storage layout is an implementation detail that may change.\"\nlast_audited: \"2026-02-16 14:20 PT\"\naudit_result: edited\n---\n\n# Session File Lifecycle and Persistence\n\nThis document explains _why_ session file availability is unreliable and the architectural decisions that flow from that constraint. The core problem: erk workflows (learn, analysis) often need session data from _previous_ Claude Code sessions, but Claude Code owns the session storage lifecycle and may clean up files at any time. Erk cannot control this policy.\n\n## The Fundamental Constraint\n\nSession JSONL files are managed by Claude Code, not erk. Their lifetime is tied to the Claude Code session that created them, with no guaranteed persistence beyond that. This means a session ID stored in GitHub issue metadata (plan-header fields, issue comments) may point to a file that no longer exists on disk.\n\nThis constraint drives two architectural decisions:\n\n1. **All session access must go through discovery** — never assume an ID maps to a file\n2. **All session-consuming workflows must degrade gracefully** — missing data narrows scope but never causes failure\n\n## Three Storage Tiers\n\nSession data lives in three places with different persistence guarantees. Understanding which tier you're working with determines how you handle availability.\n\n| Tier               | Location                                 | Persistence                                  | Purpose                                                                     |\n| ------------------ | ---------------------------------------- | -------------------------------------------- | --------------------------------------------------------------------------- |\n| **Claude-managed** | `~/.claude/projects/<project>/sessions/` | Unpredictable — Claude Code controls cleanup | Primary session storage; most workflows start here                          |\n| **Branch-uploaded** | `session/{plan_id}` branch on origin     | Durable until branch deleted                  | Cross-session persistence for learn workflows                               |\n| **Scratch**        | `.erk/scratch/sessions/<session-id>/`    | 1 hour TTL, auto-cleaned                     | Inter-process file passing within a single session (e.g., preprocessed XML) |\n\nThe key insight: scratch storage is _not_ a session archive — it exists for transient artifacts like preprocessed XML files that a hook produces for Claude to read. The 1-hour TTL is deliberately aggressive because scratch files become stale once the producing session ends.\n\n<!-- Source: packages/erk-shared/src/erk_shared/scratch/scratch.py, cleanup_stale_scratch -->\n\nSee `cleanup_stale_scratch()` in `packages/erk-shared/src/erk_shared/scratch/scratch.py` for the TTL-based cleanup logic.\n\n## Why Branch-Based Persistence Exists\n\nThe branch upload tier was added because learn workflows frequently run in a _different_ Claude Code session from the one that created or implemented the plan. By the time learn runs, the original session file is often gone. Uploading to a `session/{plan_id}` branch and recording the branch reference in the plan-header creates a durable reference that survives session cleanup.\n\n<!-- Source: src/erk/cli/commands/exec/scripts/upload_session.py, upload_session -->\n\nSee `upload_session()` in `src/erk/cli/commands/exec/scripts/upload_session.py` for how branch-based storage and plan-header updates are coordinated. The upload creates a branch from `origin/master`, commits the session JSONL to `.erk/session/{session_id}.jsonl`, force-pushes the branch, and updates plan metadata with `last_session_branch`, `last_session_id`, `last_session_at`, and `last_session_source` fields.\n\n## Discovery Architecture\n\nSession discovery has two distinct paths because plan-aware and plan-unaware workflows need fundamentally different information.\n\n| Path             | Command                               | Starting point        | What it knows                                                           |\n| ---------------- | ------------------------------------- | --------------------- | ----------------------------------------------------------------------- |\n| **Plan-unaware** | `erk exec list-sessions`              | Local filesystem scan | Only what's on disk right now — no plan context                         |\n| **Plan-aware**   | `erk exec get-learn-sessions <issue>` | GitHub issue metadata | All sessions ever tracked for a plan, plus which are currently readable |\n\n### Why two paths matter\n\n`list-sessions` can never find sessions from other machines or prior Claude Code lifecycles — it only sees the local project directory. `get-learn-sessions` starts from GitHub metadata and checks readability, so it can identify branch-based remote sessions that `list-sessions` would never discover. It also provides the categorization (planning vs. implementation vs. learn) that analysis workflows need.\n\n<!-- Source: packages/erk-shared/src/erk_shared/sessions/discovery.py, find_sessions_for_plan -->\n\nSee `find_sessions_for_plan()` in `packages/erk-shared/src/erk_shared/sessions/discovery.py` for how plan-specific discovery extracts session IDs from multiple metadata sources (plan-header fields, impl-started/impl-ended comments, learn-invoked comments).\n\n### The local fallback decision\n\n<!-- Source: src/erk/cli/commands/exec/scripts/get_learn_sessions.py -->\n\nLocal fallback scanning (implemented in `src/erk/cli/commands/exec/scripts/get_learn_sessions.py`) only triggers when **no** GitHub-tracked sessions are readable on disk. This is intentional: local scan results have no confirmed relationship to the plan, so mixing them with plan-tracked sessions would dilute signal. They're a last resort, not a supplement.\n\nWhen the local fallback triggers, it filters sessions by the current git branch to prevent worktree slot reuse contamination. Worktree slots are reused for different plans over time, so older sessions in the same project directory may belong to an entirely different branch. The `gitBranch` field in each session's JSONL log is matched against the current worktree branch to exclude stale sessions.\n\n## Graceful Degradation Hierarchy\n\nWhen a workflow needs session data, it walks a priority-ordered hierarchy. Each level represents less certainty about plan relevance but still provides value.\n\n| Priority | Source                                               | Why it might be missing                                                |\n| -------- | ---------------------------------------------------- | ---------------------------------------------------------------------- |\n| 1        | Planning session (from plan-header)                  | Created in a prior Claude Code session, since cleaned up               |\n| 2        | Implementation session (from plan-header + comments) | Same lifecycle issue                                                   |\n| 3        | Remote gist session                                  | Gist deleted; requires download step                                   |\n| 4        | Legacy artifact session (GitHub Actions run)         | Artifacts expire after 90 days                                         |\n| 5        | Local fallback scan                                  | No metadata link to plan — recent sessions may still be relevant       |\n| 6        | Skip analysis                                        | Always available — produces no session insights but workflow continues |\n\n### Anti-pattern: hard failure on missing session\n\nNever `exit 1` or raise when a session file is unavailable. The entire hierarchy exists because session availability is _inherently unreliable_. Log a warning and degrade to the next level.\n\n### Anti-pattern: direct path construction\n\nDon't build session paths manually (e.g., `~/.claude/projects/.../sessions/{id}.jsonl`). The `ClaudeInstallation` ABC provides `find_session_globally()` for existence checks and `get_session_path()` for path resolution. Direct construction bypasses the abstraction and breaks if Claude Code changes its storage layout.\n\n## Preprocessing as a Cross-Cutting Concern\n\nSession preprocessing (JSONL-to-XML compression) sits at the boundary between session storage and session consumption. It achieves ~75-84% size reduction by stripping metadata, deduplicating command documentation, and truncating tool parameters. The key architectural choice: preprocessing writes to scratch storage, not back to the session tier, because compressed XML is a derived artifact with a short useful life.\n\nFor preprocessing details (compression metrics, chunking algorithm, output modes), see [Session Preprocessing](preprocessing.md).\n\n## Related Documentation\n\n- [Session Discovery and Fallback](discovery-fallback.md) — Discovery commands, output schemas, and the fallback hierarchy in detail\n- [Session Preprocessing](preprocessing.md) — Compression metrics, chunking algorithm, and output modes\n- [Plan Lifecycle](../planning/lifecycle.md) — How plan-header metadata tracks session references\n","structuredPatch":[{"oldStart":85,"oldLines":7,"newStart":85,"newLines":7,"lines":[" | -------- | ---------------------------------------------------- | ---------------------------------------------------------------------- |"," | 1        | Planning session (from plan-header)                  | Created in a prior Claude Code session, since cleaned up               |"," | 2        | Implementation session (from plan-header + comments) | Same lifecycle issue                                                   |","-| 3        | Remote gist session                                  | Gist deleted; requires download step                                   |","+| 3        | Remote branch session                                | Branch deleted; requires checkout step                                 |"," | 4        | Legacy artifact session (GitHub Actions run)         | Artifacts expire after 90 days                                         |"," | 5        | Local fallback scan                                  | No metadata link to plan — recent sessions may still be relevant       |"," | 6        | Skip analysis                                        | Always available — produces no session insights but workflow continues |"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"f3c69b4d-c937-4fe8-87aa-cce16eee6702","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01D8CXNJ9kCuJDoSvmFxUBpv","type":"message","role":"assistant","content":[{"type":"text","text":"Let me verify no more gist references remain as \"current\" system description:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":531,"cache_read_input_tokens":82257,"cache_creation":{"ephemeral_5m_input_tokens":531,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4mLK67zcNbJnn6VaVp","type":"assistant","uuid":"3bbc9849-5601-4927-9362-eb81a6737dfc","timestamp":"2026-02-21T23:16:04.830Z"}
{"parentUuid":"3bbc9849-5601-4927-9362-eb81a6737dfc","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01D8CXNJ9kCuJDoSvmFxUBpv","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LSwJDkS5LM2wiqy9yXFGMb","name":"Grep","input":{"pattern":"gist","path":"/home/runner/work/erk/erk/docs/learned/sessions/lifecycle.md","output_mode":"content","-n":true},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":531,"cache_read_input_tokens":82257,"cache_creation":{"ephemeral_5m_input_tokens":531,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4mLK67zcNbJnn6VaVp","type":"assistant","uuid":"33f42c36-c341-48b3-ae35-b4bc53fd8a43","timestamp":"2026-02-21T23:16:05.693Z"}
{"parentUuid":"33f42c36-c341-48b3-ae35-b4bc53fd8a43","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LSwJDkS5LM2wiqy9yXFGMb","type":"tool_result","content":"No matches found"}]},"uuid":"f265a2d2-07ce-4338-9915-60219aa3bc1b","timestamp":"2026-02-21T23:16:06.221Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"","numLines":0}}
{"parentUuid":"f265a2d2-07ce-4338-9915-60219aa3bc1b","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01RCqHUVuagRUgHEZnGnXWQT","type":"message","role":"assistant","content":[{"type":"text","text":"Step 1 complete. Now Step 2."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":160,"cache_read_input_tokens":82788,"cache_creation":{"ephemeral_5m_input_tokens":160,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4mczBz8FPfBMbEwKG4","type":"assistant","uuid":"bfb4526e-2c5d-4903-9d72-367bf653c229","timestamp":"2026-02-21T23:16:08.533Z"}
{"parentUuid":"bfb4526e-2c5d-4903-9d72-367bf653c229","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01RCqHUVuagRUgHEZnGnXWQT","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0188RbJkxgMtGM9aAcZozWwH","name":"TodoWrite","input":{"todos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"in_progress","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"pending","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"pending","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"pending","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"pending","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"pending","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":160,"cache_read_input_tokens":82788,"cache_creation":{"ephemeral_5m_input_tokens":160,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4mczBz8FPfBMbEwKG4","type":"assistant","uuid":"b3898442-9300-4069-be2b-61915c408331","timestamp":"2026-02-21T23:16:12.490Z"}
{"parentUuid":"b3898442-9300-4069-be2b-61915c408331","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0188RbJkxgMtGM9aAcZozWwH","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"5aa046e5-d161-4edb-a1dc-d80896ac9493","timestamp":"2026-02-21T23:16:12.509Z","toolUseResult":{"oldTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"in_progress","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"pending","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"pending","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"pending","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"pending","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"pending","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"pending","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}],"newTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"in_progress","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"pending","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"pending","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"pending","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"pending","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"pending","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]}}
{"parentUuid":"5aa046e5-d161-4edb-a1dc-d80896ac9493","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01UpShj9TwEfqyPK2W3A2jUn","type":"message","role":"assistant","content":[{"type":"text","text":"## Step 2: Fix branch naming inconsistency\n\nThe plan says to change `plan-` prefix reference to `planned/` on line 6 of `branch-name-inference.md`. Let me look at the tripwires section:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":577,"cache_read_input_tokens":82948,"cache_creation":{"ephemeral_5m_input_tokens":577,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4n5g3iMmuLzZ5v6ani","type":"assistant","uuid":"cbefaa11-9487-4947-b3b9-b282152d25f8","timestamp":"2026-02-21T23:16:15.791Z"}
{"parentUuid":"cbefaa11-9487-4947-b3b9-b282152d25f8","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01UpShj9TwEfqyPK2W3A2jUn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017w49dpYdTitKAiF6fy8nUp","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/planning/branch-name-inference.md","limit":10},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":577,"cache_read_input_tokens":82948,"cache_creation":{"ephemeral_5m_input_tokens":577,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4n5g3iMmuLzZ5v6ani","type":"assistant","uuid":"a5384b7c-600f-4f29-bff7-109f135b2826","timestamp":"2026-02-21T23:16:16.363Z"}
{"parentUuid":"a5384b7c-600f-4f29-bff7-109f135b2826","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017w49dpYdTitKAiF6fy8nUp","type":"tool_result","content":"     1→---\n     2→title: Branch Name Inference\n     3→last_audited: \"2026-02-08 00:00 PT\"\n     4→audit_result: clean\n     5→tripwires:\n     6→  - action: \"changing branch naming convention (P{issue}- or plan- prefix)\"\n     7→    warning: \"The P{issue}- prefix (issue-based) and plan- prefix (draft-PR) are cross-cutting contracts used by branch creation, extraction functions, and PR recovery. Changing either prefix format requires updating all consumers.\"\n     8→  - action: \"adding branch_name to plan-header at creation time\"\n     9→    warning: \"branch_name is intentionally omitted at creation because the branch doesn't exist yet. The plan-save → branch-create → impl-signal lifecycle requires this gap. See the temporal gap section below.\"\n    10→read_when:\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"5ba86811-8aae-437f-82f4-d40e48cd64f6","timestamp":"2026-02-21T23:16:16.385Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/docs/learned/planning/branch-name-inference.md","content":"---\ntitle: Branch Name Inference\nlast_audited: \"2026-02-08 00:00 PT\"\naudit_result: clean\ntripwires:\n  - action: \"changing branch naming convention (P{issue}- or plan- prefix)\"\n    warning: \"The P{issue}- prefix (issue-based) and plan- prefix (draft-PR) are cross-cutting contracts used by branch creation, extraction functions, and PR recovery. Changing either prefix format requires updating all consumers.\"\n  - action: \"adding branch_name to plan-header at creation time\"\n    warning: \"branch_name is intentionally omitted at creation because the branch doesn't exist yet. The plan-save → branch-create → impl-signal lifecycle requires this gap. See the temporal gap section below.\"\nread_when:","numLines":10,"startLine":1,"totalLines":93}}}
{"parentUuid":"5ba86811-8aae-437f-82f4-d40e48cd64f6","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01EURp119ZBjm96vdAw8xJdA","type":"message","role":"assistant","content":[{"type":"text","text":"The tripwire on line 6 says `plan-` prefix, but the actual code uses `planned/`. Let me also check the \"Draft-PR Branches\" section which is on line 61:\n\nThe file content at lines 61-69 already says `plan-` in the section heading on line 61 (\"Draft-PR Branches: `plan-`\"), but the actual code uses `planned/`. Let me fix both the tripwire and the section heading:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":452,"cache_read_input_tokens":83525,"cache_creation":{"ephemeral_5m_input_tokens":452,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4nNFT5cTYnyzgLHsr6","type":"assistant","uuid":"7d76007b-e4cc-44c4-bbfc-89dd5b6d1cc6","timestamp":"2026-02-21T23:16:20.476Z"}
{"parentUuid":"7d76007b-e4cc-44c4-bbfc-89dd5b6d1cc6","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01EURp119ZBjm96vdAw8xJdA","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SMQ2FFSTCF3QDk6e8CgMAn","name":"Edit","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/planning/branch-name-inference.md","old_string":"  - action: \"changing branch naming convention (P{issue}- or plan- prefix)\"\n    warning: \"The P{issue}- prefix (issue-based) and plan- prefix (draft-PR) are cross-cutting contracts used by branch creation, extraction functions, and PR recovery. Changing either prefix format requires updating all consumers.\"","new_string":"  - action: \"changing branch naming convention (P{issue}- or planned/ prefix)\"\n    warning: \"The P{issue}- prefix (issue-based) and planned/ prefix (draft-PR) are cross-cutting contracts used by branch creation, extraction functions, and PR recovery. Changing either prefix format requires updating all consumers.\""},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":452,"cache_read_input_tokens":83525,"cache_creation":{"ephemeral_5m_input_tokens":452,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4nNFT5cTYnyzgLHsr6","type":"assistant","uuid":"1de5cc7d-74a6-4150-a0bc-8195dfaa7a9d","timestamp":"2026-02-21T23:16:22.344Z"}
{"parentUuid":"1de5cc7d-74a6-4150-a0bc-8195dfaa7a9d","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SMQ2FFSTCF3QDk6e8CgMAn","type":"tool_result","content":"The file /home/runner/work/erk/erk/docs/learned/planning/branch-name-inference.md has been updated successfully."}]},"uuid":"c714462c-c9d8-4134-bfe8-9f6e8535871b","timestamp":"2026-02-21T23:16:23.074Z","toolUseResult":{"filePath":"/home/runner/work/erk/erk/docs/learned/planning/branch-name-inference.md","oldString":"  - action: \"changing branch naming convention (P{issue}- or plan- prefix)\"\n    warning: \"The P{issue}- prefix (issue-based) and plan- prefix (draft-PR) are cross-cutting contracts used by branch creation, extraction functions, and PR recovery. Changing either prefix format requires updating all consumers.\"","newString":"  - action: \"changing branch naming convention (P{issue}- or planned/ prefix)\"\n    warning: \"The P{issue}- prefix (issue-based) and planned/ prefix (draft-PR) are cross-cutting contracts used by branch creation, extraction functions, and PR recovery. Changing either prefix format requires updating all consumers.\"","originalFile":"---\ntitle: Branch Name Inference\nlast_audited: \"2026-02-08 00:00 PT\"\naudit_result: clean\ntripwires:\n  - action: \"changing branch naming convention (P{issue}- or plan- prefix)\"\n    warning: \"The P{issue}- prefix (issue-based) and plan- prefix (draft-PR) are cross-cutting contracts used by branch creation, extraction functions, and PR recovery. Changing either prefix format requires updating all consumers.\"\n  - action: \"adding branch_name to plan-header at creation time\"\n    warning: \"branch_name is intentionally omitted at creation because the branch doesn't exist yet. The plan-save → branch-create → impl-signal lifecycle requires this gap. See the temporal gap section below.\"\nread_when:\n  - \"debugging missing branch_name in plan issues\"\n  - \"implementing PR lookup from plan issues\"\n  - \"modifying branch creation or naming conventions\"\n---\n\n# Branch Name Inference\n\n## The Temporal Gap Problem\n\nPlan metadata (`plan-header` block) intentionally omits `branch_name` at creation time because of a temporal gap in the plan lifecycle:\n\n1. **Plan saved** → GitHub issue created (no branch exists yet)\n2. **Branch created** → User runs `erk br create --for-plan {issue}` (branch now exists)\n3. **Implementation starts** → `impl-signal started` writes `branch_name` into the plan-header\n\nThe gap between steps 1 and 2 is unavoidable: the plan must exist before the branch can be named after it (the branch name contains the issue number). Attempting to set `branch_name` during save would require either predicting the branch name (fragile — the user might choose a custom name) or creating the branch immediately (wrong — the user hasn't started work yet).\n\n## Two-Layer Resolution\n\nWhen code needs to look up a PR from a plan issue, `branch_name` may be missing from metadata. The system uses two layers:\n\n<!-- Source: src/erk/cli/commands/exec/scripts/get_pr_for_plan.py, get_pr_for_plan -->\n\n**Layer 1 — Metadata lookup**: Read `branch_name` from the `plan-header` block. This succeeds when `impl-signal started` ran successfully.\n\n**Layer 2 — Git context inference**: If `branch_name` is missing, check whether the current git branch matches the `P{issue_number}-` prefix. If it does, use it. This is a fail-open recovery that handles two scenarios:\n\n- `impl-signal` never ran (user created branch manually following the naming convention)\n- `impl-signal` failed (command errored but user continued working)\n\nIf neither layer produces a match, the command fails with an actionable error.\n\n## Branch Prefix Contracts\n\nThe inference recovery depends on **cross-cutting naming contracts**. There are two branch patterns:\n\n### Issue-Based Branches: `P{issue}-`\n\nBranches for issue-based plans start with `P{issue_number}-`. This prefix is generated by two independent code paths that must stay in sync:\n\n<!-- Source: packages/erk-shared/src/erk_shared/naming.py, generate_issue_branch_name -->\n\n- **Branch creation**: `generate_issue_branch_name()` produces `P{issue}-{slug}-{timestamp}` format (with optional `O{objective_id}` segment)\n\n<!-- Source: src/erk/cli/commands/exec/scripts/get_pr_for_plan.py, get_pr_for_plan -->\n\n- **PR recovery**: `get_pr_for_plan` checks `current_branch.startswith(f\"P{issue_number}-\")`\n\nThe prefix is the stable part of the contract. The slug and timestamp segments after the prefix vary, but inference only needs the prefix to establish the plan-to-branch mapping.\n\n### Draft-PR Branches: `plan-`\n\nBranches for draft-PR plans start with `plan-` and follow the pattern `plan-{slug}-{timestamp}` (with optional `O{objective_id}` segment). These branches have **no extractable plan ID** from the branch name alone.\n\n<!-- Source: packages/erk-shared/src/erk_shared/naming.py, generate_draft_pr_branch_name -->\n\n- **Branch creation**: `generate_draft_pr_branch_name()` produces `plan-{slug}-{timestamp}`\n- **Plan ID resolution**: `DraftPRPlanBackend.resolve_plan_id_for_branch()` uses an API call, not regex\n- **Source of truth**: `plan-ref.json` is the sole source of plan ID for draft-PR branches\n- **Extraction functions**: `extract_leading_issue_number()` returns `None` for `plan-` branches; `extract_objective_number()` handles both `P{issue}-O{obj}-` and `plan-O{obj}-` patterns\n\n## When Inference Fails\n\nCommon failure scenarios and their fixes:\n\n| Symptom                                | Cause                                                | Fix                                                                     |\n| -------------------------------------- | ---------------------------------------------------- | ----------------------------------------------------------------------- |\n| \"plan-header has no branch_name field\" | On wrong branch (e.g., `master`)                     | Switch to the plan's feature branch                                     |\n| \"plan-header has no branch_name field\" | Branch uses non-standard name (e.g., `feature/1234`) | Rename branch to `P{issue}-...` or manually update plan-header metadata |\n| \"No PR found for branch\"               | Branch exists but no PR was created                  | Push branch and create PR first                                         |\n\n## Relationship to Fail-Open Pattern\n\nThis is an instance of the [fail-open pattern](../architecture/fail-open-patterns.md) with defense-in-depth:\n\n- **Primary mechanism**: `impl-signal started` explicitly writes `branch_name` into metadata (reliable when the full workflow runs)\n- **Fallback mechanism**: Pattern matching against git context (enables manual workflows and recovers from signal failures)\n- **Key distinction**: The fallback isn't just error recovery — it actively enables workflows where `impl-signal` was never intended to run (e.g., implementing a plan created by another developer, or plans created before `impl-signal` existed)\n\n## Related Documentation\n\n- [Fail-Open Patterns](../architecture/fail-open-patterns.md) — Defense-in-depth design pattern\n","structuredPatch":[{"oldStart":3,"oldLines":8,"newStart":3,"newLines":8,"lines":[" last_audited: \"2026-02-08 00:00 PT\""," audit_result: clean"," tripwires:","-  - action: \"changing branch naming convention (P{issue}- or plan- prefix)\"","-    warning: \"The P{issue}- prefix (issue-based) and plan- prefix (draft-PR) are cross-cutting contracts used by branch creation, extraction functions, and PR recovery. Changing either prefix format requires updating all consumers.\"","+  - action: \"changing branch naming convention (P{issue}- or planned/ prefix)\"","+    warning: \"The P{issue}- prefix (issue-based) and planned/ prefix (draft-PR) are cross-cutting contracts used by branch creation, extraction functions, and PR recovery. Changing either prefix format requires updating all consumers.\"","   - action: \"adding branch_name to plan-header at creation time\"","     warning: \"branch_name is intentionally omitted at creation because the branch doesn't exist yet. The plan-save → branch-create → impl-signal lifecycle requires this gap. See the temporal gap section below.\""," read_when:"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"c714462c-c9d8-4134-bfe8-9f6e8535871b","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01Pni8fEqex7ypQcdR7JSLBw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Hcv6K2UapwNpGYixQjpBe1","name":"Edit","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/planning/branch-name-inference.md","old_string":"### Draft-PR Branches: `plan-`\n\nBranches for draft-PR plans start with `plan-` and follow the pattern `plan-{slug}-{timestamp}` (with optional `O{objective_id}` segment). These branches have **no extractable plan ID** from the branch name alone.\n\n<!-- Source: packages/erk-shared/src/erk_shared/naming.py, generate_draft_pr_branch_name -->\n\n- **Branch creation**: `generate_draft_pr_branch_name()` produces `plan-{slug}-{timestamp}`","new_string":"### Draft-PR Branches: `planned/`\n\nBranches for draft-PR plans start with `planned/` and follow the pattern `planned/{slug}-{timestamp}` (with optional `O{objective_id}` segment). These branches have **no extractable plan ID** from the branch name alone.\n\n<!-- Source: packages/erk-shared/src/erk_shared/naming.py, generate_draft_pr_branch_name -->\n\n- **Branch creation**: `generate_draft_pr_branch_name()` produces `planned/{slug}-{timestamp}`"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":406,"cache_read_input_tokens":83977,"cache_creation":{"ephemeral_5m_input_tokens":406,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4nrseGNjc3rupHVw89","type":"assistant","uuid":"5682ade5-2c83-4807-89ec-87b495a4ed3c","timestamp":"2026-02-21T23:16:29.274Z"}
{"parentUuid":"5682ade5-2c83-4807-89ec-87b495a4ed3c","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Hcv6K2UapwNpGYixQjpBe1","type":"tool_result","content":"The file /home/runner/work/erk/erk/docs/learned/planning/branch-name-inference.md has been updated successfully."}]},"uuid":"d8c113dd-a254-4f8c-a441-afefa99eaec4","timestamp":"2026-02-21T23:16:30.009Z","toolUseResult":{"filePath":"/home/runner/work/erk/erk/docs/learned/planning/branch-name-inference.md","oldString":"### Draft-PR Branches: `plan-`\n\nBranches for draft-PR plans start with `plan-` and follow the pattern `plan-{slug}-{timestamp}` (with optional `O{objective_id}` segment). These branches have **no extractable plan ID** from the branch name alone.\n\n<!-- Source: packages/erk-shared/src/erk_shared/naming.py, generate_draft_pr_branch_name -->\n\n- **Branch creation**: `generate_draft_pr_branch_name()` produces `plan-{slug}-{timestamp}`","newString":"### Draft-PR Branches: `planned/`\n\nBranches for draft-PR plans start with `planned/` and follow the pattern `planned/{slug}-{timestamp}` (with optional `O{objective_id}` segment). These branches have **no extractable plan ID** from the branch name alone.\n\n<!-- Source: packages/erk-shared/src/erk_shared/naming.py, generate_draft_pr_branch_name -->\n\n- **Branch creation**: `generate_draft_pr_branch_name()` produces `planned/{slug}-{timestamp}`","originalFile":"---\ntitle: Branch Name Inference\nlast_audited: \"2026-02-08 00:00 PT\"\naudit_result: clean\ntripwires:\n  - action: \"changing branch naming convention (P{issue}- or planned/ prefix)\"\n    warning: \"The P{issue}- prefix (issue-based) and planned/ prefix (draft-PR) are cross-cutting contracts used by branch creation, extraction functions, and PR recovery. Changing either prefix format requires updating all consumers.\"\n  - action: \"adding branch_name to plan-header at creation time\"\n    warning: \"branch_name is intentionally omitted at creation because the branch doesn't exist yet. The plan-save → branch-create → impl-signal lifecycle requires this gap. See the temporal gap section below.\"\nread_when:\n  - \"debugging missing branch_name in plan issues\"\n  - \"implementing PR lookup from plan issues\"\n  - \"modifying branch creation or naming conventions\"\n---\n\n# Branch Name Inference\n\n## The Temporal Gap Problem\n\nPlan metadata (`plan-header` block) intentionally omits `branch_name` at creation time because of a temporal gap in the plan lifecycle:\n\n1. **Plan saved** → GitHub issue created (no branch exists yet)\n2. **Branch created** → User runs `erk br create --for-plan {issue}` (branch now exists)\n3. **Implementation starts** → `impl-signal started` writes `branch_name` into the plan-header\n\nThe gap between steps 1 and 2 is unavoidable: the plan must exist before the branch can be named after it (the branch name contains the issue number). Attempting to set `branch_name` during save would require either predicting the branch name (fragile — the user might choose a custom name) or creating the branch immediately (wrong — the user hasn't started work yet).\n\n## Two-Layer Resolution\n\nWhen code needs to look up a PR from a plan issue, `branch_name` may be missing from metadata. The system uses two layers:\n\n<!-- Source: src/erk/cli/commands/exec/scripts/get_pr_for_plan.py, get_pr_for_plan -->\n\n**Layer 1 — Metadata lookup**: Read `branch_name` from the `plan-header` block. This succeeds when `impl-signal started` ran successfully.\n\n**Layer 2 — Git context inference**: If `branch_name` is missing, check whether the current git branch matches the `P{issue_number}-` prefix. If it does, use it. This is a fail-open recovery that handles two scenarios:\n\n- `impl-signal` never ran (user created branch manually following the naming convention)\n- `impl-signal` failed (command errored but user continued working)\n\nIf neither layer produces a match, the command fails with an actionable error.\n\n## Branch Prefix Contracts\n\nThe inference recovery depends on **cross-cutting naming contracts**. There are two branch patterns:\n\n### Issue-Based Branches: `P{issue}-`\n\nBranches for issue-based plans start with `P{issue_number}-`. This prefix is generated by two independent code paths that must stay in sync:\n\n<!-- Source: packages/erk-shared/src/erk_shared/naming.py, generate_issue_branch_name -->\n\n- **Branch creation**: `generate_issue_branch_name()` produces `P{issue}-{slug}-{timestamp}` format (with optional `O{objective_id}` segment)\n\n<!-- Source: src/erk/cli/commands/exec/scripts/get_pr_for_plan.py, get_pr_for_plan -->\n\n- **PR recovery**: `get_pr_for_plan` checks `current_branch.startswith(f\"P{issue_number}-\")`\n\nThe prefix is the stable part of the contract. The slug and timestamp segments after the prefix vary, but inference only needs the prefix to establish the plan-to-branch mapping.\n\n### Draft-PR Branches: `plan-`\n\nBranches for draft-PR plans start with `plan-` and follow the pattern `plan-{slug}-{timestamp}` (with optional `O{objective_id}` segment). These branches have **no extractable plan ID** from the branch name alone.\n\n<!-- Source: packages/erk-shared/src/erk_shared/naming.py, generate_draft_pr_branch_name -->\n\n- **Branch creation**: `generate_draft_pr_branch_name()` produces `plan-{slug}-{timestamp}`\n- **Plan ID resolution**: `DraftPRPlanBackend.resolve_plan_id_for_branch()` uses an API call, not regex\n- **Source of truth**: `plan-ref.json` is the sole source of plan ID for draft-PR branches\n- **Extraction functions**: `extract_leading_issue_number()` returns `None` for `plan-` branches; `extract_objective_number()` handles both `P{issue}-O{obj}-` and `plan-O{obj}-` patterns\n\n## When Inference Fails\n\nCommon failure scenarios and their fixes:\n\n| Symptom                                | Cause                                                | Fix                                                                     |\n| -------------------------------------- | ---------------------------------------------------- | ----------------------------------------------------------------------- |\n| \"plan-header has no branch_name field\" | On wrong branch (e.g., `master`)                     | Switch to the plan's feature branch                                     |\n| \"plan-header has no branch_name field\" | Branch uses non-standard name (e.g., `feature/1234`) | Rename branch to `P{issue}-...` or manually update plan-header metadata |\n| \"No PR found for branch\"               | Branch exists but no PR was created                  | Push branch and create PR first                                         |\n\n## Relationship to Fail-Open Pattern\n\nThis is an instance of the [fail-open pattern](../architecture/fail-open-patterns.md) with defense-in-depth:\n\n- **Primary mechanism**: `impl-signal started` explicitly writes `branch_name` into metadata (reliable when the full workflow runs)\n- **Fallback mechanism**: Pattern matching against git context (enables manual workflows and recovers from signal failures)\n- **Key distinction**: The fallback isn't just error recovery — it actively enables workflows where `impl-signal` was never intended to run (e.g., implementing a plan created by another developer, or plans created before `impl-signal` existed)\n\n## Related Documentation\n\n- [Fail-Open Patterns](../architecture/fail-open-patterns.md) — Defense-in-depth design pattern\n","structuredPatch":[{"oldStart":58,"oldLines":13,"newStart":58,"newLines":13,"lines":[" "," The prefix is the stable part of the contract. The slug and timestamp segments after the prefix vary, but inference only needs the prefix to establish the plan-to-branch mapping."," ","-### Draft-PR Branches: `plan-`","+### Draft-PR Branches: `planned/`"," ","-Branches for draft-PR plans start with `plan-` and follow the pattern `plan-{slug}-{timestamp}` (with optional `O{objective_id}` segment). These branches have **no extractable plan ID** from the branch name alone.","+Branches for draft-PR plans start with `planned/` and follow the pattern `planned/{slug}-{timestamp}` (with optional `O{objective_id}` segment). These branches have **no extractable plan ID** from the branch name alone."," "," <!-- Source: packages/erk-shared/src/erk_shared/naming.py, generate_draft_pr_branch_name -->"," ","-- **Branch creation**: `generate_draft_pr_branch_name()` produces `plan-{slug}-{timestamp}`","+- **Branch creation**: `generate_draft_pr_branch_name()` produces `planned/{slug}-{timestamp}`"," - **Plan ID resolution**: `DraftPRPlanBackend.resolve_plan_id_for_branch()` uses an API call, not regex"," - **Source of truth**: `plan-ref.json` is the sole source of plan ID for draft-PR branches"," - **Extraction functions**: `extract_leading_issue_number()` returns `None` for `plan-` branches; `extract_objective_number()` handles both `P{issue}-O{obj}-` and `plan-O{obj}-` patterns"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"d8c113dd-a254-4f8c-a441-afefa99eaec4","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01KQBMeivAqp7f8EZBb197bk","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check the extraction functions line to see if it also references `plan-`:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":412,"cache_read_input_tokens":84383,"cache_creation":{"ephemeral_5m_input_tokens":412,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4oNWc7aDshoDaUtsyQ","type":"assistant","uuid":"755ddeb7-0ea8-47bb-af90-45f085de7adb","timestamp":"2026-02-21T23:16:32.176Z"}
{"parentUuid":"755ddeb7-0ea8-47bb-af90-45f085de7adb","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01KQBMeivAqp7f8EZBb197bk","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014yyS5WnJgFzEbLXud2GykG","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/planning/branch-name-inference.md","offset":68,"limit":10},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":412,"cache_read_input_tokens":84383,"cache_creation":{"ephemeral_5m_input_tokens":412,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4oNWc7aDshoDaUtsyQ","type":"assistant","uuid":"942f9c96-4e8a-49c6-aea9-3cce04b14281","timestamp":"2026-02-21T23:16:32.916Z"}
{"parentUuid":"942f9c96-4e8a-49c6-aea9-3cce04b14281","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014yyS5WnJgFzEbLXud2GykG","type":"tool_result","content":"    68→- **Plan ID resolution**: `DraftPRPlanBackend.resolve_plan_id_for_branch()` uses an API call, not regex\n    69→- **Source of truth**: `plan-ref.json` is the sole source of plan ID for draft-PR branches\n    70→- **Extraction functions**: `extract_leading_issue_number()` returns `None` for `plan-` branches; `extract_objective_number()` handles both `P{issue}-O{obj}-` and `plan-O{obj}-` patterns\n    71→\n    72→## When Inference Fails\n    73→\n    74→Common failure scenarios and their fixes:\n    75→\n    76→| Symptom                                | Cause                                                | Fix                                                                     |\n    77→| -------------------------------------- | ---------------------------------------------------- | ----------------------------------------------------------------------- |\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"1896570a-33ff-414d-965a-0786314c45f4","timestamp":"2026-02-21T23:16:32.942Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/docs/learned/planning/branch-name-inference.md","content":"- **Plan ID resolution**: `DraftPRPlanBackend.resolve_plan_id_for_branch()` uses an API call, not regex\n- **Source of truth**: `plan-ref.json` is the sole source of plan ID for draft-PR branches\n- **Extraction functions**: `extract_leading_issue_number()` returns `None` for `plan-` branches; `extract_objective_number()` handles both `P{issue}-O{obj}-` and `plan-O{obj}-` patterns\n\n## When Inference Fails\n\nCommon failure scenarios and their fixes:\n\n| Symptom                                | Cause                                                | Fix                                                                     |\n| -------------------------------------- | ---------------------------------------------------- | ----------------------------------------------------------------------- |","numLines":10,"startLine":68,"totalLines":93}}}
{"parentUuid":"1896570a-33ff-414d-965a-0786314c45f4","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_0146AhZLJjh9jqXUZuzgywhx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UergATton1rgRbryS35w7m","name":"Edit","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/planning/branch-name-inference.md","old_string":"- **Extraction functions**: `extract_leading_issue_number()` returns `None` for `plan-` branches; `extract_objective_number()` handles both `P{issue}-O{obj}-` and `plan-O{obj}-` patterns","new_string":"- **Extraction functions**: `extract_leading_issue_number()` returns `None` for `planned/` branches; `extract_objective_number()` handles both `P{issue}-O{obj}-` and `planned/O{obj}-` patterns"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":756,"cache_read_input_tokens":84795,"cache_creation":{"ephemeral_5m_input_tokens":756,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4ob2vEjKmcqtHR3ryQ","type":"assistant","uuid":"c24e4b64-def7-484a-8f3f-218b838ac544","timestamp":"2026-02-21T23:16:36.299Z"}
{"parentUuid":"c24e4b64-def7-484a-8f3f-218b838ac544","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UergATton1rgRbryS35w7m","type":"tool_result","content":"The file /home/runner/work/erk/erk/docs/learned/planning/branch-name-inference.md has been updated successfully."}]},"uuid":"f2ae2004-151d-465b-a7ca-7945bb9076ef","timestamp":"2026-02-21T23:16:37.025Z","toolUseResult":{"filePath":"/home/runner/work/erk/erk/docs/learned/planning/branch-name-inference.md","oldString":"- **Extraction functions**: `extract_leading_issue_number()` returns `None` for `plan-` branches; `extract_objective_number()` handles both `P{issue}-O{obj}-` and `plan-O{obj}-` patterns","newString":"- **Extraction functions**: `extract_leading_issue_number()` returns `None` for `planned/` branches; `extract_objective_number()` handles both `P{issue}-O{obj}-` and `planned/O{obj}-` patterns","originalFile":"---\ntitle: Branch Name Inference\nlast_audited: \"2026-02-08 00:00 PT\"\naudit_result: clean\ntripwires:\n  - action: \"changing branch naming convention (P{issue}- or planned/ prefix)\"\n    warning: \"The P{issue}- prefix (issue-based) and planned/ prefix (draft-PR) are cross-cutting contracts used by branch creation, extraction functions, and PR recovery. Changing either prefix format requires updating all consumers.\"\n  - action: \"adding branch_name to plan-header at creation time\"\n    warning: \"branch_name is intentionally omitted at creation because the branch doesn't exist yet. The plan-save → branch-create → impl-signal lifecycle requires this gap. See the temporal gap section below.\"\nread_when:\n  - \"debugging missing branch_name in plan issues\"\n  - \"implementing PR lookup from plan issues\"\n  - \"modifying branch creation or naming conventions\"\n---\n\n# Branch Name Inference\n\n## The Temporal Gap Problem\n\nPlan metadata (`plan-header` block) intentionally omits `branch_name` at creation time because of a temporal gap in the plan lifecycle:\n\n1. **Plan saved** → GitHub issue created (no branch exists yet)\n2. **Branch created** → User runs `erk br create --for-plan {issue}` (branch now exists)\n3. **Implementation starts** → `impl-signal started` writes `branch_name` into the plan-header\n\nThe gap between steps 1 and 2 is unavoidable: the plan must exist before the branch can be named after it (the branch name contains the issue number). Attempting to set `branch_name` during save would require either predicting the branch name (fragile — the user might choose a custom name) or creating the branch immediately (wrong — the user hasn't started work yet).\n\n## Two-Layer Resolution\n\nWhen code needs to look up a PR from a plan issue, `branch_name` may be missing from metadata. The system uses two layers:\n\n<!-- Source: src/erk/cli/commands/exec/scripts/get_pr_for_plan.py, get_pr_for_plan -->\n\n**Layer 1 — Metadata lookup**: Read `branch_name` from the `plan-header` block. This succeeds when `impl-signal started` ran successfully.\n\n**Layer 2 — Git context inference**: If `branch_name` is missing, check whether the current git branch matches the `P{issue_number}-` prefix. If it does, use it. This is a fail-open recovery that handles two scenarios:\n\n- `impl-signal` never ran (user created branch manually following the naming convention)\n- `impl-signal` failed (command errored but user continued working)\n\nIf neither layer produces a match, the command fails with an actionable error.\n\n## Branch Prefix Contracts\n\nThe inference recovery depends on **cross-cutting naming contracts**. There are two branch patterns:\n\n### Issue-Based Branches: `P{issue}-`\n\nBranches for issue-based plans start with `P{issue_number}-`. This prefix is generated by two independent code paths that must stay in sync:\n\n<!-- Source: packages/erk-shared/src/erk_shared/naming.py, generate_issue_branch_name -->\n\n- **Branch creation**: `generate_issue_branch_name()` produces `P{issue}-{slug}-{timestamp}` format (with optional `O{objective_id}` segment)\n\n<!-- Source: src/erk/cli/commands/exec/scripts/get_pr_for_plan.py, get_pr_for_plan -->\n\n- **PR recovery**: `get_pr_for_plan` checks `current_branch.startswith(f\"P{issue_number}-\")`\n\nThe prefix is the stable part of the contract. The slug and timestamp segments after the prefix vary, but inference only needs the prefix to establish the plan-to-branch mapping.\n\n### Draft-PR Branches: `planned/`\n\nBranches for draft-PR plans start with `planned/` and follow the pattern `planned/{slug}-{timestamp}` (with optional `O{objective_id}` segment). These branches have **no extractable plan ID** from the branch name alone.\n\n<!-- Source: packages/erk-shared/src/erk_shared/naming.py, generate_draft_pr_branch_name -->\n\n- **Branch creation**: `generate_draft_pr_branch_name()` produces `planned/{slug}-{timestamp}`\n- **Plan ID resolution**: `DraftPRPlanBackend.resolve_plan_id_for_branch()` uses an API call, not regex\n- **Source of truth**: `plan-ref.json` is the sole source of plan ID for draft-PR branches\n- **Extraction functions**: `extract_leading_issue_number()` returns `None` for `plan-` branches; `extract_objective_number()` handles both `P{issue}-O{obj}-` and `plan-O{obj}-` patterns\n\n## When Inference Fails\n\nCommon failure scenarios and their fixes:\n\n| Symptom                                | Cause                                                | Fix                                                                     |\n| -------------------------------------- | ---------------------------------------------------- | ----------------------------------------------------------------------- |\n| \"plan-header has no branch_name field\" | On wrong branch (e.g., `master`)                     | Switch to the plan's feature branch                                     |\n| \"plan-header has no branch_name field\" | Branch uses non-standard name (e.g., `feature/1234`) | Rename branch to `P{issue}-...` or manually update plan-header metadata |\n| \"No PR found for branch\"               | Branch exists but no PR was created                  | Push branch and create PR first                                         |\n\n## Relationship to Fail-Open Pattern\n\nThis is an instance of the [fail-open pattern](../architecture/fail-open-patterns.md) with defense-in-depth:\n\n- **Primary mechanism**: `impl-signal started` explicitly writes `branch_name` into metadata (reliable when the full workflow runs)\n- **Fallback mechanism**: Pattern matching against git context (enables manual workflows and recovers from signal failures)\n- **Key distinction**: The fallback isn't just error recovery — it actively enables workflows where `impl-signal` was never intended to run (e.g., implementing a plan created by another developer, or plans created before `impl-signal` existed)\n\n## Related Documentation\n\n- [Fail-Open Patterns](../architecture/fail-open-patterns.md) — Defense-in-depth design pattern\n","structuredPatch":[{"oldStart":67,"oldLines":7,"newStart":67,"newLines":7,"lines":[" - **Branch creation**: `generate_draft_pr_branch_name()` produces `planned/{slug}-{timestamp}`"," - **Plan ID resolution**: `DraftPRPlanBackend.resolve_plan_id_for_branch()` uses an API call, not regex"," - **Source of truth**: `plan-ref.json` is the sole source of plan ID for draft-PR branches","-- **Extraction functions**: `extract_leading_issue_number()` returns `None` for `plan-` branches; `extract_objective_number()` handles both `P{issue}-O{obj}-` and `plan-O{obj}-` patterns","+- **Extraction functions**: `extract_leading_issue_number()` returns `None` for `planned/` branches; `extract_objective_number()` handles both `P{issue}-O{obj}-` and `planned/O{obj}-` patterns"," "," ## When Inference Fails"," "]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"f2ae2004-151d-465b-a7ca-7945bb9076ef","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01RHe6A2KGDkPgH7Gwf15uTd","type":"message","role":"assistant","content":[{"type":"text","text":"Also need to check if the planning tripwires file references `plan-` for draft-PR:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":272,"cache_read_input_tokens":85551,"cache_creation":{"ephemeral_5m_input_tokens":272,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4otVQJ4Zq6jGKdXADi","type":"assistant","uuid":"4674a2cd-4b0f-45aa-bc5d-de3f6bda31d0","timestamp":"2026-02-21T23:16:39.264Z"}
{"parentUuid":"4674a2cd-4b0f-45aa-bc5d-de3f6bda31d0","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01RHe6A2KGDkPgH7Gwf15uTd","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QrXcJBjAPnAo94HZ6RmYuV","name":"Grep","input":{"pattern":"plan- prefix","path":"/home/runner/work/erk/erk/docs/learned/planning/tripwires.md","output_mode":"content","-n":true},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":272,"cache_read_input_tokens":85551,"cache_creation":{"ephemeral_5m_input_tokens":272,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4otVQJ4Zq6jGKdXADi","type":"assistant","uuid":"283de1a7-fecd-4dde-88d4-a72ececed497","timestamp":"2026-02-21T23:16:40.157Z"}
{"parentUuid":"283de1a7-fecd-4dde-88d4-a72ececed497","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QrXcJBjAPnAo94HZ6RmYuV","type":"tool_result","content":"73:**changing branch naming convention (P{issue}- or plan- prefix)** → Read [Branch Name Inference](branch-name-inference.md) first. The P{issue}- prefix (issue-based) and plan- prefix (draft-PR) are cross-cutting contracts used by branch creation, extraction functions, and PR recovery. Changing either prefix format requires updating all consumers."}]},"uuid":"128e0d6e-70f7-43dd-9f3c-3bd367ccdbd7","timestamp":"2026-02-21T23:16:40.663Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"73:**changing branch naming convention (P{issue}- or plan- prefix)** → Read [Branch Name Inference](branch-name-inference.md) first. The P{issue}- prefix (issue-based) and plan- prefix (draft-PR) are cross-cutting contracts used by branch creation, extraction functions, and PR recovery. Changing either prefix format requires updating all consumers.","numLines":1}}
{"parentUuid":"128e0d6e-70f7-43dd-9f3c-3bd367ccdbd7","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01LhfFif4iiqvmGTNRhfL485","type":"message","role":"assistant","content":[{"type":"text","text":"This line is in the auto-generated `tripwires.md` file, so it will be updated by `erk docs sync`. The source tripwire in `branch-name-inference.md` has already been fixed. Step 2 done."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":581,"cache_read_input_tokens":85823,"cache_creation":{"ephemeral_5m_input_tokens":581,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4pA3nMPkkXcJunYvEc","type":"assistant","uuid":"413b3e1a-582d-4f3e-8700-09e702929450","timestamp":"2026-02-21T23:16:43.674Z"}
{"parentUuid":"413b3e1a-582d-4f3e-8700-09e702929450","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01LhfFif4iiqvmGTNRhfL485","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HDDfPcHtz68FbRkxR1jEra","name":"TodoWrite","input":{"todos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"in_progress","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"pending","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"pending","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"pending","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"pending","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":581,"cache_read_input_tokens":85823,"cache_creation":{"ephemeral_5m_input_tokens":581,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4pA3nMPkkXcJunYvEc","type":"assistant","uuid":"f50f4094-7b1e-4b84-8634-79ac54de6d9d","timestamp":"2026-02-21T23:16:47.233Z"}
{"parentUuid":"f50f4094-7b1e-4b84-8634-79ac54de6d9d","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HDDfPcHtz68FbRkxR1jEra","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"db7049f7-42fd-4ee6-819a-642568f7144f","timestamp":"2026-02-21T23:16:47.251Z","toolUseResult":{"oldTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"in_progress","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"pending","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"pending","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"pending","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"pending","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"pending","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}],"newTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"in_progress","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"pending","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"pending","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"pending","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"pending","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]}}
{"parentUuid":"db7049f7-42fd-4ee6-819a-642568f7144f","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01PpvtKgZfjb7axM3iBBcUrN","type":"message","role":"assistant","content":[{"type":"text","text":"## Step 3: Create lazy pool sync pattern doc\n\nI need to check the existing frontmatter format used in docs/learned/architecture/ to match the pattern:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":621,"cache_read_input_tokens":86404,"cache_creation":{"ephemeral_5m_input_tokens":621,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4peJA31jjwcNnTYitR","type":"assistant","uuid":"dfb88dc5-575c-4f14-ac39-835a339d4408","timestamp":"2026-02-21T23:16:49.912Z"}
{"parentUuid":"dfb88dc5-575c-4f14-ac39-835a339d4408","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01PpvtKgZfjb7axM3iBBcUrN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TMWZ6GDhptFMPZasbXZXXo","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/architecture/erk-architecture.md","limit":15},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":621,"cache_read_input_tokens":86404,"cache_creation":{"ephemeral_5m_input_tokens":621,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4peJA31jjwcNnTYitR","type":"assistant","uuid":"fdff7501-624d-4fe8-bf2a-650e073b3b25","timestamp":"2026-02-21T23:16:50.601Z"}
{"parentUuid":"fdff7501-624d-4fe8-bf2a-650e073b3b25","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TMWZ6GDhptFMPZasbXZXXo","type":"tool_result","content":"     1→---\n     2→last_audited: \"2026-02-16 00:00 PT\"\n     3→audit_result: clean\n     4→title: Erk Architecture Patterns\n     5→read_when:\n     6→  - \"understanding erk architecture\"\n     7→  - \"implementing dry-run patterns\"\n     8→  - \"regenerating context after os.chdir\"\n     9→  - \"detecting root worktree\"\n    10→  - \"detecting worktree location\"\n    11→  - \"adding composing template methods to ABC\"\n    12→tripwires:\n    13→  - action: \"passing dry_run boolean flags through business logic function parameters\"\n    14→    warning: \"Use dependency injection with DryRunGit/DryRunGitHub wrappers for multi-step workflows. Simple CLI preview flags at the command level are acceptable for single-action commands.\"\n    15→  - action: \"calling os.chdir() in erk code\"\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"e04a3538-647c-418d-adda-b893066c3dc9","timestamp":"2026-02-21T23:16:50.636Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/docs/learned/architecture/erk-architecture.md","content":"---\nlast_audited: \"2026-02-16 00:00 PT\"\naudit_result: clean\ntitle: Erk Architecture Patterns\nread_when:\n  - \"understanding erk architecture\"\n  - \"implementing dry-run patterns\"\n  - \"regenerating context after os.chdir\"\n  - \"detecting root worktree\"\n  - \"detecting worktree location\"\n  - \"adding composing template methods to ABC\"\ntripwires:\n  - action: \"passing dry_run boolean flags through business logic function parameters\"\n    warning: \"Use dependency injection with DryRunGit/DryRunGitHub wrappers for multi-step workflows. Simple CLI preview flags at the command level are acceptable for single-action commands.\"\n  - action: \"calling os.chdir() in erk code\"","numLines":15,"startLine":1,"totalLines":1137}}}
{"parentUuid":"e04a3538-647c-418d-adda-b893066c3dc9","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01FbgsF1PhFEcn8eGxLYqVEe","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me create the new doc. Based on the research from the Explore agent, the sync function is in `src/erk/cli/commands/slot/common.py` (lines 223-287):"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":458,"cache_read_input_tokens":87025,"cache_creation":{"ephemeral_5m_input_tokens":458,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4pth62aaotA2EPGHnY","type":"assistant","uuid":"50ad216d-9521-4818-ac19-253f85c57ba4","timestamp":"2026-02-21T23:16:55.396Z"}
{"parentUuid":"50ad216d-9521-4818-ac19-253f85c57ba4","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01FbgsF1PhFEcn8eGxLYqVEe","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GqjsZDpaTZ3tdcgKcmYNTr","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py","offset":223,"limit":70},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":458,"cache_read_input_tokens":87025,"cache_creation":{"ephemeral_5m_input_tokens":458,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4pth62aaotA2EPGHnY","type":"assistant","uuid":"1099025a-6e53-4b3c-b2b4-12b46d1df64f","timestamp":"2026-02-21T23:16:56.180Z"}
{"parentUuid":"1099025a-6e53-4b3c-b2b4-12b46d1df64f","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GqjsZDpaTZ3tdcgKcmYNTr","type":"tool_result","content":"   223→def sync_pool_assignments(\n   224→    state: PoolState,\n   225→    git: Git,\n   226→    pool_json_path: Path,\n   227→) -> PoolSyncResult:\n   228→    \"\"\"Sync pool assignments with actual git branch state.\n   229→\n   230→    For each assignment, checks the actual branch in the worktree and\n   231→    updates pool.json when mismatches are detected. This handles the case\n   232→    where users manually run ``gt create`` or ``git checkout`` in a pool\n   233→    slot, causing the recorded branch to diverge from the actual branch.\n   234→\n   235→    Args:\n   236→        state: Current pool state\n   237→        git: Git gateway for branch operations\n   238→        pool_json_path: Path to pool.json for saving updated state\n   239→\n   240→    Returns:\n   241→        PoolSyncResult with potentially updated state and count of synced assignments\n   242→    \"\"\"\n   243→    updated_assignments: list[SlotAssignment] = []\n   244→    synced_count = 0\n   245→\n   246→    for assignment in state.assignments:\n   247→        if not assignment.worktree_path.exists():\n   248→            updated_assignments.append(assignment)\n   249→            continue\n   250→\n   251→        actual_branch = git.branch.get_current_branch(assignment.worktree_path)\n   252→\n   253→        if actual_branch is None:\n   254→            # Detached HEAD — leave assignment unchanged\n   255→            updated_assignments.append(assignment)\n   256→            continue\n   257→\n   258→        if actual_branch == assignment.branch_name:\n   259→            updated_assignments.append(assignment)\n   260→            continue\n   261→\n   262→        if is_placeholder_branch(actual_branch):\n   263→            updated_assignments.append(assignment)\n   264→            continue\n   265→\n   266→        # Branch changed — update assignment, preserve original assigned_at\n   267→        updated_assignments.append(\n   268→            SlotAssignment(\n   269→                slot_name=assignment.slot_name,\n   270→                branch_name=actual_branch,\n   271→                assigned_at=assignment.assigned_at,\n   272→                worktree_path=assignment.worktree_path,\n   273→            )\n   274→        )\n   275→        synced_count += 1\n   276→\n   277→    if synced_count == 0:\n   278→        return PoolSyncResult(state=state, synced_count=0)\n   279→\n   280→    new_state = PoolState(\n   281→        version=state.version,\n   282→        pool_size=state.pool_size,\n   283→        slots=state.slots,\n   284→        assignments=tuple(updated_assignments),\n   285→    )\n   286→    save_pool_state(pool_json_path, new_state)\n   287→    return PoolSyncResult(state=new_state, synced_count=synced_count)\n   288→\n   289→\n   290→@dataclass(frozen=True)\n   291→class ExistingAssignmentValidation:\n   292→    \"\"\"Result of validating an existing branch assignment.\"\"\"\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"cd64b906-4569-4d2e-9c59-105cf3b1fd3e","timestamp":"2026-02-21T23:16:56.208Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py","content":"def sync_pool_assignments(\n    state: PoolState,\n    git: Git,\n    pool_json_path: Path,\n) -> PoolSyncResult:\n    \"\"\"Sync pool assignments with actual git branch state.\n\n    For each assignment, checks the actual branch in the worktree and\n    updates pool.json when mismatches are detected. This handles the case\n    where users manually run ``gt create`` or ``git checkout`` in a pool\n    slot, causing the recorded branch to diverge from the actual branch.\n\n    Args:\n        state: Current pool state\n        git: Git gateway for branch operations\n        pool_json_path: Path to pool.json for saving updated state\n\n    Returns:\n        PoolSyncResult with potentially updated state and count of synced assignments\n    \"\"\"\n    updated_assignments: list[SlotAssignment] = []\n    synced_count = 0\n\n    for assignment in state.assignments:\n        if not assignment.worktree_path.exists():\n            updated_assignments.append(assignment)\n            continue\n\n        actual_branch = git.branch.get_current_branch(assignment.worktree_path)\n\n        if actual_branch is None:\n            # Detached HEAD — leave assignment unchanged\n            updated_assignments.append(assignment)\n            continue\n\n        if actual_branch == assignment.branch_name:\n            updated_assignments.append(assignment)\n            continue\n\n        if is_placeholder_branch(actual_branch):\n            updated_assignments.append(assignment)\n            continue\n\n        # Branch changed — update assignment, preserve original assigned_at\n        updated_assignments.append(\n            SlotAssignment(\n                slot_name=assignment.slot_name,\n                branch_name=actual_branch,\n                assigned_at=assignment.assigned_at,\n                worktree_path=assignment.worktree_path,\n            )\n        )\n        synced_count += 1\n\n    if synced_count == 0:\n        return PoolSyncResult(state=state, synced_count=0)\n\n    new_state = PoolState(\n        version=state.version,\n        pool_size=state.pool_size,\n        slots=state.slots,\n        assignments=tuple(updated_assignments),\n    )\n    save_pool_state(pool_json_path, new_state)\n    return PoolSyncResult(state=new_state, synced_count=synced_count)\n\n\n@dataclass(frozen=True)\nclass ExistingAssignmentValidation:\n    \"\"\"Result of validating an existing branch assignment.\"\"\"","numLines":70,"startLine":223,"totalLines":728}}}
{"parentUuid":"cd64b906-4569-4d2e-9c59-105cf3b1fd3e","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01JmVP9uGNyaX9sNbAWoL4yF","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me also check where `sync_pool_assignments` is called in `allocate_slot_for_branch`:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1076,"cache_read_input_tokens":87483,"cache_creation":{"ephemeral_5m_input_tokens":1076,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4qJWZ3pBCDcfiRWZjh","type":"assistant","uuid":"e7297ca0-72e1-418b-9e6a-4eb887b67231","timestamp":"2026-02-21T23:16:58.738Z"}
{"parentUuid":"e7297ca0-72e1-418b-9e6a-4eb887b67231","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01JmVP9uGNyaX9sNbAWoL4yF","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013yPXpLa6tTgGh8wq9aPsQw","name":"Grep","input":{"pattern":"sync_pool_assignments","path":"/home/runner/work/erk/erk/src/erk/cli/commands/slot/common.py","output_mode":"content","-n":true},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1076,"cache_read_input_tokens":87483,"cache_creation":{"ephemeral_5m_input_tokens":1076,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4qJWZ3pBCDcfiRWZjh","type":"assistant","uuid":"319e8909-c270-463a-9d7b-b8804a07fa1d","timestamp":"2026-02-21T23:16:59.636Z"}
{"parentUuid":"319e8909-c270-463a-9d7b-b8804a07fa1d","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013yPXpLa6tTgGh8wq9aPsQw","type":"tool_result","content":"223:def sync_pool_assignments(\n609:    sync_result = sync_pool_assignments(state, ctx.git, repo.pool_json_path)"}]},"uuid":"4b0aa268-c145-47be-878b-8fb7bb0f82e2","timestamp":"2026-02-21T23:17:00.133Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"223:def sync_pool_assignments(\n609:    sync_result = sync_pool_assignments(state, ctx.git, repo.pool_json_path)","numLines":2}}
{"parentUuid":"4b0aa268-c145-47be-878b-8fb7bb0f82e2","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_015XC3KnRzPz7chBg1p7MHUq","type":"message","role":"assistant","content":[{"type":"text","text":"Good. Now let me create the new doc:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":546,"cache_read_input_tokens":88559,"cache_creation":{"ephemeral_5m_input_tokens":546,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4qbHrXq4CaYQWqZ8U5","type":"assistant","uuid":"bbc974b6-d1f7-4052-b175-90a5c52306d2","timestamp":"2026-02-21T23:17:02.484Z"}
{"parentUuid":"bbc974b6-d1f7-4052-b175-90a5c52306d2","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_015XC3KnRzPz7chBg1p7MHUq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SSY8FtHVTtRgSa4pS5Jbeb","name":"Skill","input":{"skill":"learned-docs"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":546,"cache_read_input_tokens":88559,"cache_creation":{"ephemeral_5m_input_tokens":546,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4qbHrXq4CaYQWqZ8U5","type":"assistant","uuid":"3f3abd05-6209-42fb-bb76-6c46c4c992d6","timestamp":"2026-02-21T23:17:02.866Z"}
{"parentUuid":"3f3abd05-6209-42fb-bb76-6c46c4c992d6","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"type":"tool_result","tool_use_id":"toolu_01SSY8FtHVTtRgSa4pS5Jbeb","content":"Launching skill: learned-docs"}]},"uuid":"99234d29-e145-4a91-91d1-af967e433f57","timestamp":"2026-02-21T23:17:02.909Z","toolUseResult":{"success":true,"commandName":"learned-docs"}}
{"parentUuid":"99234d29-e145-4a91-91d1-af967e433f57","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"type":"text","text":"Base directory for this skill: /home/runner/work/erk/erk/.claude/skills/learned-docs\n\n# Learned Documentation Guide\n\nOverview: `docs/learned/` contains agent-focused documentation with:\n\n- YAML frontmatter for routing and discovery\n- Hierarchical category organization (categories listed in index below)\n- Index files for category navigation\n- Routing tables in AGENTS.md\n\n## Core Knowledge (ALWAYS Loaded)\n\n@learned-docs-core.md\n\n## Document Registry (Auto-Generated)\n\n@docs/learned/index.md\n\n## Frontmatter Requirements\n\nEvery markdown file (except index.md) MUST have:\n\n```yaml\n---\ntitle: Document Title\nread_when:\n  - \"first condition\"\n  - \"second condition\"\n---\n```\n\n### Required Fields\n\n| Field       | Type         | Purpose                                    |\n| ----------- | ------------ | ------------------------------------------ |\n| `title`     | string       | Human-readable title for index tables      |\n| `read_when` | list[string] | Conditions when agent should read this doc |\n\n### Writing Effective read_when Values\n\n- Use gerund phrases: \"creating a plan\", \"styling CLI output\"\n- Be specific: \"fixing merge conflicts in tests\" not \"tests\"\n- Include 2-4 conditions covering primary use cases\n- Think: \"An agent should read this when they are...\"\n\nGood:\n\n```yaml\nread_when:\n  - \"creating or closing plans\"\n  - \"understanding plan states\"\n  - \"working with .impl/ folders\"\n```\n\nBad:\n\n```yaml\nread_when:\n  - \"plans\" # Too vague\n  - \"the user asks\" # Not descriptive\n```\n\n## Documentation Structure\n\n**Read the master index for current categories and documents:**\n\n`docs/learned/index.md`\n\nThe index contains:\n\n- All category paths and descriptions\n- Root-level documents\n- Document listings with \"Read when...\" conditions\n\n## Category Placement Guidelines\n\n1. **Match by topic** - Does the doc clearly fit one category? (see index above for categories)\n2. **Match by related docs** - Are similar docs already in a category?\n3. **When unclear** - Place at root level; categorize later when patterns emerge\n4. **Create new category** - When 3+ related docs exist at root level\n\n### Distinguishing cli/ vs architecture/\n\nThis is the most common confusion:\n\n- **cli/**: Patterns for **building CLI commands** - how users interact with the tool\n  - Fast-path patterns (skipping expensive ops)\n  - Output formatting and styling\n  - Script mode behavior\n  - Command organization\n\n- **architecture/**: **Internal implementation patterns** - how the code works\n  - Gateway ABCs and dependency injection\n  - Dry-run via wrapper classes\n  - Shell integration constraints\n  - Protocol vs ABC decisions\n\n## Document Structure Template\n\n```markdown\n---\ntitle: [Clear Document Title]\nread_when:\n  - \"[first condition]\"\n  - \"[second condition]\"\n---\n\n# [Title Matching Frontmatter]\n\n[1-2 sentence overview]\n\n## [Main Content Sections]\n\n[Organized content with clear headers]\n\n## Related Topics\n\n- [Link to related docs](../category/doc.md) - Brief description\n```\n\n## Index File Template\n\nEach category has an `index.md` following this pattern:\n\n```markdown\n---\ntitle: [Category] Documentation\nread_when:\n  - \"[when to browse this category]\"\n---\n\n# [Category] Documentation\n\n[Brief category description]\n\n## Quick Navigation\n\n| When you need to... | Read this        |\n| ------------------- | ---------------- |\n| [specific task]     | [doc.md](doc.md) |\n\n## Documents in This Category\n\n### [Document Title]\n\n**File:** [doc.md](doc.md)\n\n[1-2 sentence description]\n\n## Related Topics\n\n- [Other Category](../other/) - Brief relevance\n```\n\n## Reorganizing Documentation\n\nWhen moving files between categories:\n\n### Step 1: Move Files with git mv\n\n```bash\ncd docs/learned\ngit mv old-location/doc.md new-category/doc.md\n```\n\n### Step 2: Update Cross-References\n\nFind all references to moved files:\n\n```bash\ngrep -r \"old-filename.md\" docs/learned/\n```\n\nUpdate relative links:\n\n- Same category: `[doc.md](doc.md)`\n- Different category: `[doc.md](../category/doc.md)`\n- To category index: `[Category](../category/)`\n\n### Step 3: Update Index Files\n\nUpdate Quick Navigation tables in affected index files.\n\n### Step 4: Update AGENTS.md\n\nIf the doc was in the routing table, update the path.\n\n### Step 5: Validate\n\nRun `make fast-ci` to catch broken links and formatting issues.\n\n## Updating Routing Tables\n\nAGENTS.md contains the Quick Routing Table for agent navigation.\n\n### When to Add Entries\n\n- New category additions\n- High-frequency tasks\n- Tasks where wrong approach is common\n\n### Entry Format\n\n```markdown\n| [Task description] | → [Link or skill] |\n```\n\nExamples:\n\n- `| Understand project architecture | → [Architecture](docs/learned/architecture/) |`\n- `| Write Python code | → Load \\`dignified-python\\` skill FIRST |`\n\n## Validation\n\nRun before committing:\n\n```bash\nmake fast-ci\n```\n\nThis validates:\n\n- YAML frontmatter syntax\n- Required fields present\n- Markdown formatting (prettier)\n\n## ⚠️ Generated Files - Do Not Edit Directly\n\nThe following files are **auto-generated** from frontmatter metadata:\n\n| File                                   | Source                                |\n| -------------------------------------- | ------------------------------------- |\n| `docs/learned/index.md`                | Frontmatter from all docs             |\n| `docs/learned/<category>/index.md`     | Frontmatter from category             |\n| `docs/learned/<category>/tripwires.md` | `tripwires:` field in category docs   |\n| `docs/learned/tripwires-index.md`      | Category tripwires with routing hints |\n\n**Never edit these files directly.** Changes will be overwritten.\n\n### Workflow for Changes\n\n1. **Edit the source frontmatter** in the relevant documentation file(s)\n2. **Run sync**: `erk docs sync`\n3. **Verify changes** in the generated files\n4. **Commit both** the source and generated files\n\n### Adding a New Tripwire\n\nTo add a tripwire rule:\n\n1. Add to the `tripwires:` field in the relevant doc's frontmatter:\n   ```yaml\n   tripwires:\n     - action: \"doing something dangerous\"\n       warning: \"Do this instead.\"\n   ```\n2. Run `erk docs sync` to regenerate `tripwires.md`\n\n## Quick Reference\n\n- Full navigation: [docs/learned/guide.md](docs/learned/guide.md)\n- Category index: [docs/learned/index.md](docs/learned/index.md)\n- Regenerate indexes: `erk docs sync`\n- Run validation: `make fast-ci`\n"}]},"isMeta":true,"uuid":"9d52d12c-6748-46c7-aa3e-a2136b4f4d67","timestamp":"2026-02-21T23:17:02.908Z","sourceToolUseID":"toolu_01SSY8FtHVTtRgSa4pS5Jbeb"}
{"parentUuid":"9d52d12c-6748-46c7-aa3e-a2136b4f4d67","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01LzSSQCxP5xyYkBx71kVi58","type":"message","role":"assistant","content":[{"type":"text","text":"Now I have the learned-docs skill loaded. Let me create the new doc for Step 3:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":2934,"cache_read_input_tokens":89105,"cache_creation":{"ephemeral_5m_input_tokens":2934,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4qoCDNCvKHgNaivURH","type":"assistant","uuid":"d4a20043-a764-4b4d-b433-ea1dfc94702e","timestamp":"2026-02-21T23:17:05.862Z"}
{"parentUuid":"d4a20043-a764-4b4d-b433-ea1dfc94702e","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01LzSSQCxP5xyYkBx71kVi58","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012E97z5Ryshh6z1hAwjohAi","name":"Write","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/architecture/slot-pool-state-sync.md","content":"---\ntitle: Slot Pool State Sync\nread_when:\n  - \"modifying slot pool allocation or assignment logic\"\n  - \"debugging branch mismatches in pool slots\"\n  - \"understanding how manual git operations interact with the pool\"\ntripwires:\n  - action: \"calling allocate_slot_for_branch without sync_pool_assignments running first\"\n    warning: \"Pool sync must run BEFORE find_branch_assignment call. Without it, stale pool.json entries cause silent misassignment — a slot may appear free when it's actually occupied by a different branch.\"\n    score: 9\n---\n\n# Slot Pool State Sync\n\nThe pool sync algorithm reconciles `pool.json` assignments with actual git worktree branch state. It runs lazily — only before allocation decisions — and skips disk writes when no changes are detected.\n\n## Why Sync Exists\n\nUsers may run `gt create` or `git checkout` directly inside a pool slot worktree, causing the recorded branch in `pool.json` to diverge from the actual branch. Without sync, the pool would make allocation decisions based on stale data: a slot might appear assigned to branch A when it's actually on branch B.\n\n## Sync Timing\n\n<!-- Source: src/erk/cli/commands/slot/common.py:609, allocate_slot_for_branch -->\n\n`sync_pool_assignments()` is called at the beginning of `allocate_slot_for_branch()` (line 609 in `common.py`), before any allocation decisions. This ensures the pool state reflects reality before checking if a branch is already assigned or if slots are available.\n\n## Algorithm\n\n<!-- Source: src/erk/cli/commands/slot/common.py:223-287, sync_pool_assignments -->\n\nFor each assignment in `pool.json`:\n\n1. **Missing worktree directory** — skip, leave unchanged\n2. **Detached HEAD** — skip, leave unchanged (user may be mid-operation)\n3. **Branch matches recorded** — skip, no correction needed\n4. **Placeholder branch** (`__erk-slot-NN-br-stub__`) — skip, don't update to stub name\n5. **Branch actually changed** — update `branch_name`, preserve original `assigned_at`\n\nThe `assigned_at` timestamp is deliberately preserved when a branch changes. It tracks when the slot was originally assigned, not when the branch changed. This ordering is used for LRU eviction decisions.\n\n## I/O Optimization: mtime Preservation\n\nIf no assignments were corrected (`synced_count == 0`), the function returns early without calling `save_pool_state()`. This avoids unnecessary disk writes and preserves the file's modification time, which matters for tools that watch `pool.json` for changes.\n\n```python\nif synced_count == 0:\n    return PoolSyncResult(state=state, synced_count=0)\n```\n\nOnly when at least one assignment was corrected does the function write the updated state to disk.\n\n## State-of-Truth Hierarchy\n\n1. **Git worktree state** (actual branches checked out) — primary source\n2. **pool.json assignments** (recorded state) — secondary\n3. **Sync** reconciles them by reading git and updating pool.json\n\nThe pool never overrides git state. It only updates its own records to match what git reports.\n\n## Key Source Files\n\n- [`src/erk/cli/commands/slot/common.py`](../../../src/erk/cli/commands/slot/common.py) — `sync_pool_assignments()` (lines 223-287), called from `allocate_slot_for_branch()` (line 609)\n- [`src/erk/core/worktree_pool.py`](../../../src/erk/core/worktree_pool.py) — `PoolState`, `SlotAssignment`, `PoolSyncResult` data structures\n- [`tests/unit/cli/commands/slot/test_common.py`](../../../tests/unit/cli/commands/slot/test_common.py) — sync tests (lines 644-890)\n\n## Related Topics\n\n- [Slot Pool Architecture](../erk/slot-pool-architecture.md) — Overall pool design, allocation algorithm, diagnostics\n"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":2934,"cache_read_input_tokens":89105,"cache_creation":{"ephemeral_5m_input_tokens":2934,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4qoCDNCvKHgNaivURH","type":"assistant","uuid":"9317aec8-1ded-4aa3-874d-2cd33d92b24a","timestamp":"2026-02-21T23:17:28.009Z"}
{"parentUuid":"9317aec8-1ded-4aa3-874d-2cd33d92b24a","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012E97z5Ryshh6z1hAwjohAi","type":"tool_result","content":"File created successfully at: /home/runner/work/erk/erk/docs/learned/architecture/slot-pool-state-sync.md"}]},"uuid":"052ca7b5-9e01-4179-87f7-0494a1bbfc7a","timestamp":"2026-02-21T23:17:29.253Z","toolUseResult":{"type":"create","filePath":"/home/runner/work/erk/erk/docs/learned/architecture/slot-pool-state-sync.md","content":"---\ntitle: Slot Pool State Sync\nread_when:\n  - \"modifying slot pool allocation or assignment logic\"\n  - \"debugging branch mismatches in pool slots\"\n  - \"understanding how manual git operations interact with the pool\"\ntripwires:\n  - action: \"calling allocate_slot_for_branch without sync_pool_assignments running first\"\n    warning: \"Pool sync must run BEFORE find_branch_assignment call. Without it, stale pool.json entries cause silent misassignment — a slot may appear free when it's actually occupied by a different branch.\"\n    score: 9\n---\n\n# Slot Pool State Sync\n\nThe pool sync algorithm reconciles `pool.json` assignments with actual git worktree branch state. It runs lazily — only before allocation decisions — and skips disk writes when no changes are detected.\n\n## Why Sync Exists\n\nUsers may run `gt create` or `git checkout` directly inside a pool slot worktree, causing the recorded branch in `pool.json` to diverge from the actual branch. Without sync, the pool would make allocation decisions based on stale data: a slot might appear assigned to branch A when it's actually on branch B.\n\n## Sync Timing\n\n<!-- Source: src/erk/cli/commands/slot/common.py:609, allocate_slot_for_branch -->\n\n`sync_pool_assignments()` is called at the beginning of `allocate_slot_for_branch()` (line 609 in `common.py`), before any allocation decisions. This ensures the pool state reflects reality before checking if a branch is already assigned or if slots are available.\n\n## Algorithm\n\n<!-- Source: src/erk/cli/commands/slot/common.py:223-287, sync_pool_assignments -->\n\nFor each assignment in `pool.json`:\n\n1. **Missing worktree directory** — skip, leave unchanged\n2. **Detached HEAD** — skip, leave unchanged (user may be mid-operation)\n3. **Branch matches recorded** — skip, no correction needed\n4. **Placeholder branch** (`__erk-slot-NN-br-stub__`) — skip, don't update to stub name\n5. **Branch actually changed** — update `branch_name`, preserve original `assigned_at`\n\nThe `assigned_at` timestamp is deliberately preserved when a branch changes. It tracks when the slot was originally assigned, not when the branch changed. This ordering is used for LRU eviction decisions.\n\n## I/O Optimization: mtime Preservation\n\nIf no assignments were corrected (`synced_count == 0`), the function returns early without calling `save_pool_state()`. This avoids unnecessary disk writes and preserves the file's modification time, which matters for tools that watch `pool.json` for changes.\n\n```python\nif synced_count == 0:\n    return PoolSyncResult(state=state, synced_count=0)\n```\n\nOnly when at least one assignment was corrected does the function write the updated state to disk.\n\n## State-of-Truth Hierarchy\n\n1. **Git worktree state** (actual branches checked out) — primary source\n2. **pool.json assignments** (recorded state) — secondary\n3. **Sync** reconciles them by reading git and updating pool.json\n\nThe pool never overrides git state. It only updates its own records to match what git reports.\n\n## Key Source Files\n\n- [`src/erk/cli/commands/slot/common.py`](../../../src/erk/cli/commands/slot/common.py) — `sync_pool_assignments()` (lines 223-287), called from `allocate_slot_for_branch()` (line 609)\n- [`src/erk/core/worktree_pool.py`](../../../src/erk/core/worktree_pool.py) — `PoolState`, `SlotAssignment`, `PoolSyncResult` data structures\n- [`tests/unit/cli/commands/slot/test_common.py`](../../../tests/unit/cli/commands/slot/test_common.py) — sync tests (lines 644-890)\n\n## Related Topics\n\n- [Slot Pool Architecture](../erk/slot-pool-architecture.md) — Overall pool design, allocation algorithm, diagnostics\n","structuredPatch":[],"originalFile":null}}
{"parentUuid":"052ca7b5-9e01-4179-87f7-0494a1bbfc7a","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01AZxTf81EzmqELKoUiRmg6j","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01EbTnLa7BVuKvzEFMaAKCCk","name":"TodoWrite","input":{"todos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"in_progress","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"pending","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"pending","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"pending","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1482,"cache_read_input_tokens":92039,"cache_creation":{"ephemeral_5m_input_tokens":1482,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4sjosnRMMGwQtqFXqj","type":"assistant","uuid":"9cab359a-868f-495c-9e20-b9df271435c3","timestamp":"2026-02-21T23:17:35.432Z"}
{"parentUuid":"9cab359a-868f-495c-9e20-b9df271435c3","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01EbTnLa7BVuKvzEFMaAKCCk","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"1bf684f9-a72c-411e-9478-a18ce44c0d7f","timestamp":"2026-02-21T23:17:35.447Z","toolUseResult":{"oldTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"in_progress","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"pending","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"pending","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"pending","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"pending","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}],"newTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"in_progress","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"pending","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"pending","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"pending","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]}}
{"parentUuid":"1bf684f9-a72c-411e-9478-a18ce44c0d7f","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01DcSA38CrVnQtTYXKdB42Nv","type":"message","role":"assistant","content":[{"type":"text","text":"## Step 4: Update slot pool architecture doc"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":565,"cache_read_input_tokens":93521,"cache_creation":{"ephemeral_5m_input_tokens":565,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4tCHqQkEtsr3z2LX34","type":"assistant","uuid":"42b4e62c-cbd3-4818-915f-6efa87a720a9","timestamp":"2026-02-21T23:17:37.770Z"}
{"parentUuid":"42b4e62c-cbd3-4818-915f-6efa87a720a9","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01DcSA38CrVnQtTYXKdB42Nv","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RsgKb1PjAKVFzV5VxeZUzT","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/erk/slot-pool-architecture.md","offset":93,"limit":65},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":565,"cache_read_input_tokens":93521,"cache_creation":{"ephemeral_5m_input_tokens":565,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4tCHqQkEtsr3z2LX34","type":"assistant","uuid":"573db873-3022-4528-9d01-a9ed2afe384f","timestamp":"2026-02-21T23:17:38.553Z"}
{"parentUuid":"573db873-3022-4528-9d01-a9ed2afe384f","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RsgKb1PjAKVFzV5VxeZUzT","type":"tool_result","content":"    93→These directories are in `.gitignore` so they persist across branch switches without cleanup.\n    94→\n    95→## Diagnostics & Repair\n    96→\n    97→### Sync Issues (`src/erk/cli/commands/slot/diagnostics.py`)\n    98→\n    99→The diagnostic system detects inconsistencies between:\n   100→\n   101→- Pool state (`pool.json`)\n   102→- Git worktree registry (`git worktree list`)\n   103→- Filesystem directories\n   104→\n   105→| Issue Code             | Description                                      |\n   106→| ---------------------- | ------------------------------------------------ |\n   107→| `orphan-state`         | Assignment exists but worktree directory missing |\n   108→| `orphan-dir`           | Directory exists but not in pool state           |\n   109→| `missing-branch`       | Assigned branch no longer exists in git          |\n   110→| `branch-mismatch`      | Worktree on different branch than pool says      |\n   111→| `git-registry-missing` | Pool assignment not in git worktree registry     |\n   112→| `untracked-worktree`   | Git worktree exists but not erk-managed          |\n   113→| `closed-pr`            | PR for assigned branch is closed or merged       |\n   114→\n   115→### Repair (`src/erk/cli/commands/slot/repair_cmd.py`)\n   116→\n   117→`erk slot repair` auto-fixes by removing stale assignments:\n   118→\n   119→- `orphan-state` - Remove assignment (worktree gone)\n   120→- `missing-branch` - Remove assignment (branch deleted)\n   121→- `branch-mismatch` - Remove assignment (let user re-assign)\n   122→- `git-registry-missing` - Remove assignment (not a valid worktree)\n   123→- `closed-pr` - Remove assignment (PR closed/merged)\n   124→\n   125→## Entry Points\n   126→\n   127→Commands that allocate slots via `allocate_slot_for_branch()`:\n   128→\n   129→| Command               | Description                          |\n   130→| --------------------- | ------------------------------------ |\n   131→| `erk branch create`   | Creates branch and assigns to slot   |\n   132→| `erk branch checkout` | Checks out existing branch into slot |\n   133→| `erk slot assign`     | Assigns existing branch to slot      |\n   134→| `erk pr checkout`     | Assigns branch when checking out PR  |\n   135→\n   136→## Configuration\n   137→\n   138→In `.erk/config.toml` (local config):\n   139→\n   140→```toml\n   141→[pool]\n   142→max_slots = 6  # Override default of 4\n   143→```\n   144→\n   145→## Key Source Files\n   146→\n   147→- [`src/erk/core/worktree_pool.py`](../../../src/erk/core/worktree_pool.py) - Data structures and persistence\n   148→- [`src/erk/cli/commands/slot/common.py`](../../../src/erk/cli/commands/slot/common.py) - Allocation algorithm\n   149→- [`src/erk/cli/commands/slot/diagnostics.py`](../../../src/erk/cli/commands/slot/diagnostics.py) - Health checks\n   150→- [`src/erk/cli/commands/slot/repair_cmd.py`](../../../src/erk/cli/commands/slot/repair_cmd.py) - Auto-repair\n   151→\n   152→## Related Topics\n   153→\n   154→- [Branch Cleanup](branch-cleanup.md) - Cleaning up branches and worktrees\n   155→- Load `gt-graphite` skill for worktree stack mental model\n   156→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"a0272f9f-4136-489b-acd2-b87fb85a16ce","timestamp":"2026-02-21T23:17:38.585Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/docs/learned/erk/slot-pool-architecture.md","content":"These directories are in `.gitignore` so they persist across branch switches without cleanup.\n\n## Diagnostics & Repair\n\n### Sync Issues (`src/erk/cli/commands/slot/diagnostics.py`)\n\nThe diagnostic system detects inconsistencies between:\n\n- Pool state (`pool.json`)\n- Git worktree registry (`git worktree list`)\n- Filesystem directories\n\n| Issue Code             | Description                                      |\n| ---------------------- | ------------------------------------------------ |\n| `orphan-state`         | Assignment exists but worktree directory missing |\n| `orphan-dir`           | Directory exists but not in pool state           |\n| `missing-branch`       | Assigned branch no longer exists in git          |\n| `branch-mismatch`      | Worktree on different branch than pool says      |\n| `git-registry-missing` | Pool assignment not in git worktree registry     |\n| `untracked-worktree`   | Git worktree exists but not erk-managed          |\n| `closed-pr`            | PR for assigned branch is closed or merged       |\n\n### Repair (`src/erk/cli/commands/slot/repair_cmd.py`)\n\n`erk slot repair` auto-fixes by removing stale assignments:\n\n- `orphan-state` - Remove assignment (worktree gone)\n- `missing-branch` - Remove assignment (branch deleted)\n- `branch-mismatch` - Remove assignment (let user re-assign)\n- `git-registry-missing` - Remove assignment (not a valid worktree)\n- `closed-pr` - Remove assignment (PR closed/merged)\n\n## Entry Points\n\nCommands that allocate slots via `allocate_slot_for_branch()`:\n\n| Command               | Description                          |\n| --------------------- | ------------------------------------ |\n| `erk branch create`   | Creates branch and assigns to slot   |\n| `erk branch checkout` | Checks out existing branch into slot |\n| `erk slot assign`     | Assigns existing branch to slot      |\n| `erk pr checkout`     | Assigns branch when checking out PR  |\n\n## Configuration\n\nIn `.erk/config.toml` (local config):\n\n```toml\n[pool]\nmax_slots = 6  # Override default of 4\n```\n\n## Key Source Files\n\n- [`src/erk/core/worktree_pool.py`](../../../src/erk/core/worktree_pool.py) - Data structures and persistence\n- [`src/erk/cli/commands/slot/common.py`](../../../src/erk/cli/commands/slot/common.py) - Allocation algorithm\n- [`src/erk/cli/commands/slot/diagnostics.py`](../../../src/erk/cli/commands/slot/diagnostics.py) - Health checks\n- [`src/erk/cli/commands/slot/repair_cmd.py`](../../../src/erk/cli/commands/slot/repair_cmd.py) - Auto-repair\n\n## Related Topics\n\n- [Branch Cleanup](branch-cleanup.md) - Cleaning up branches and worktrees\n- Load `gt-graphite` skill for worktree stack mental model\n","numLines":64,"startLine":93,"totalLines":156}}}
{"parentUuid":"a0272f9f-4136-489b-acd2-b87fb85a16ce","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_0151rfNYjCdDefrTYTiNxbKN","type":"message","role":"assistant","content":[{"type":"text","text":"I need to add a section about transparent state correction before the Diagnostics section:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1174,"cache_read_input_tokens":94086,"cache_creation":{"ephemeral_5m_input_tokens":1174,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4tRhjMHGd9SgTJHiXc","type":"assistant","uuid":"d9729dfb-9eea-4400-9492-641845dbb4bf","timestamp":"2026-02-21T23:17:41.220Z"}
{"parentUuid":"d9729dfb-9eea-4400-9492-641845dbb4bf","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_0151rfNYjCdDefrTYTiNxbKN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DrAcq3mpfvGm3vsinUvFKj","name":"Edit","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/erk/slot-pool-architecture.md","old_string":"## Diagnostics & Repair","new_string":"## Transparent State Correction\n\nThe pool treats manual `git checkout` and `gt create` operations in pool slots as valid. When a user changes branches directly inside a worktree slot, the pool silently corrects its state on the next allocation call rather than raising an error.\n\n<!-- Source: src/erk/cli/commands/slot/common.py:223-287, sync_pool_assignments -->\n\n`sync_pool_assignments()` runs before every allocation decision. It compares each assignment's recorded branch against the actual git branch in the worktree and updates `pool.json` when mismatches are detected. If no corrections are needed, it skips the disk write entirely (preserving file mtime).\n\nEdge cases handled:\n\n- **Missing worktree directory** — assignment preserved (may be temporarily unmounted)\n- **Detached HEAD** — assignment preserved (user may be mid-operation)\n- **Placeholder branches** — assignment preserved (don't record stub branch names)\n- **Branch changed** — assignment updated with actual branch, original `assigned_at` preserved for LRU ordering\n\nFor full details on the sync algorithm, see [Slot Pool State Sync](../architecture/slot-pool-state-sync.md).\n\n## Diagnostics & Repair"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1174,"cache_read_input_tokens":94086,"cache_creation":{"ephemeral_5m_input_tokens":1174,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4tRhjMHGd9SgTJHiXc","type":"assistant","uuid":"b3fba413-945b-418a-a026-a3032b0a4c47","timestamp":"2026-02-21T23:17:47.301Z"}
{"parentUuid":"b3fba413-945b-418a-a026-a3032b0a4c47","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DrAcq3mpfvGm3vsinUvFKj","type":"tool_result","content":"The file /home/runner/work/erk/erk/docs/learned/erk/slot-pool-architecture.md has been updated successfully."}]},"uuid":"482b3d1b-6d7c-4434-96bb-ba020fb79cae","timestamp":"2026-02-21T23:17:48.034Z","toolUseResult":{"filePath":"/home/runner/work/erk/erk/docs/learned/erk/slot-pool-architecture.md","oldString":"## Diagnostics & Repair","newString":"## Transparent State Correction\n\nThe pool treats manual `git checkout` and `gt create` operations in pool slots as valid. When a user changes branches directly inside a worktree slot, the pool silently corrects its state on the next allocation call rather than raising an error.\n\n<!-- Source: src/erk/cli/commands/slot/common.py:223-287, sync_pool_assignments -->\n\n`sync_pool_assignments()` runs before every allocation decision. It compares each assignment's recorded branch against the actual git branch in the worktree and updates `pool.json` when mismatches are detected. If no corrections are needed, it skips the disk write entirely (preserving file mtime).\n\nEdge cases handled:\n\n- **Missing worktree directory** — assignment preserved (may be temporarily unmounted)\n- **Detached HEAD** — assignment preserved (user may be mid-operation)\n- **Placeholder branches** — assignment preserved (don't record stub branch names)\n- **Branch changed** — assignment updated with actual branch, original `assigned_at` preserved for LRU ordering\n\nFor full details on the sync algorithm, see [Slot Pool State Sync](../architecture/slot-pool-state-sync.md).\n\n## Diagnostics & Repair","originalFile":"---\ntitle: Slot Pool Architecture\nread_when:\n  - \"understanding slot pool design\"\n  - \"implementing slot-related features\"\n  - \"debugging slot assignment issues\"\nlast_audited: \"2026-02-16 14:20 PT\"\naudit_result: clean\n---\n\n# Slot Pool Architecture\n\nThe worktree slot pool is a reusable pool of pre-allocated git worktrees for fast branch switching. Instead of creating and destroying worktrees on demand, erk maintains a fixed-size pool of worktree directories that can be reassigned to different branches.\n\n## Core Concepts\n\n### Pool Basics\n\n- **Pool size**: Default 4 slots, configurable via `[pool] max_slots` in `.erk/config.toml`\n- **Slot names**: `erk-slot-NN` format (e.g., `erk-slot-01`, `erk-slot-02`)\n- **Placeholder branches**: `__erk-slot-NN-br-stub__` for unassigned slots\n- **Pool persistence**: `~/.erk/repos/{repo_name}/pool.json`\n\n### Why a Pool?\n\nCreating git worktrees is relatively slow (file system operations, git setup). The pool enables:\n\n1. **Fast branch switching**: Reuse existing worktrees instead of creating new ones\n2. **Resource bounds**: Limit disk usage to a fixed number of worktrees\n3. **Automatic eviction**: LRU eviction when pool is full\n\n## Data Structures\n\n### Data Model (`src/erk/core/worktree_pool.py`)\n\n**`PoolState`** — Top-level container with `version`, `pool_size`, `slots`, and `assignments` fields.\n**`SlotInfo`** — Slot metadata (just a `name` field).\n**`SlotAssignment`** — Maps a branch to a slot with `slot_name`, `branch_name`, `assigned_at`, and `worktree_path`.\n\nSee `src/erk/core/worktree_pool.py` for full definitions.\n\n## Slot Allocation Algorithm\n\nThe `allocate_slot_for_branch()` function in `src/erk/cli/commands/slot/common.py` implements the unified allocation strategy:\n\n### Step 1: Check Existing Assignment\n\nIf the branch is already assigned to a slot, return that assignment immediately (idempotent).\n\n### Step 2: Fast Path - Reuse Inactive Slot\n\n`find_inactive_slot()` searches for worktrees that:\n\n- Exist in git's worktree registry\n- Are not currently assigned to any branch\n- Have no uncommitted changes\n\nThis is the fast path because it reuses an existing worktree directory.\n\n### Step 3: Slow Path - Create New Slot\n\n`find_next_available_slot()` finds a slot number that:\n\n- Is within pool_size bounds\n- Is not assigned to a branch\n- Is not already initialized as a worktree\n- Does not have an orphaned directory on disk\n\n### Step 4: Pool Full - Eviction\n\nIf no slots are available, `handle_pool_full_interactive()` handles eviction:\n\n- **With `--force`**: Auto-evict oldest assignment (by `assigned_at` timestamp)\n- **Interactive (TTY)**: Prompt user to confirm eviction\n- **Non-interactive**: Error with instructions\n\n## Naming Conventions\n\n| Component           | Pattern                               | Example                           |\n| ------------------- | ------------------------------------- | --------------------------------- |\n| Slot name           | `erk-slot-NN`                         | `erk-slot-01`                     |\n| Placeholder branch  | `__erk-slot-NN-br-stub__`             | `__erk-slot-01-br-stub__`         |\n| Pool state file     | `pool.json`                           | `~/.erk/repos/my-repo/pool.json`  |\n| Worktrees directory | `~/.erk/repos/{repo-name}/worktrees/` | `~/.erk/repos/my-repo/worktrees/` |\n\n## Artifact Cleanup\n\nWhen reusing a slot, `cleanup_worktree_artifacts()` removes stale data:\n\n- `.impl/` - Previous implementation plans\n- `.erk/scratch/` - Session-specific scratch data\n\nThese directories are in `.gitignore` so they persist across branch switches without cleanup.\n\n## Diagnostics & Repair\n\n### Sync Issues (`src/erk/cli/commands/slot/diagnostics.py`)\n\nThe diagnostic system detects inconsistencies between:\n\n- Pool state (`pool.json`)\n- Git worktree registry (`git worktree list`)\n- Filesystem directories\n\n| Issue Code             | Description                                      |\n| ---------------------- | ------------------------------------------------ |\n| `orphan-state`         | Assignment exists but worktree directory missing |\n| `orphan-dir`           | Directory exists but not in pool state           |\n| `missing-branch`       | Assigned branch no longer exists in git          |\n| `branch-mismatch`      | Worktree on different branch than pool says      |\n| `git-registry-missing` | Pool assignment not in git worktree registry     |\n| `untracked-worktree`   | Git worktree exists but not erk-managed          |\n| `closed-pr`            | PR for assigned branch is closed or merged       |\n\n### Repair (`src/erk/cli/commands/slot/repair_cmd.py`)\n\n`erk slot repair` auto-fixes by removing stale assignments:\n\n- `orphan-state` - Remove assignment (worktree gone)\n- `missing-branch` - Remove assignment (branch deleted)\n- `branch-mismatch` - Remove assignment (let user re-assign)\n- `git-registry-missing` - Remove assignment (not a valid worktree)\n- `closed-pr` - Remove assignment (PR closed/merged)\n\n## Entry Points\n\nCommands that allocate slots via `allocate_slot_for_branch()`:\n\n| Command               | Description                          |\n| --------------------- | ------------------------------------ |\n| `erk branch create`   | Creates branch and assigns to slot   |\n| `erk branch checkout` | Checks out existing branch into slot |\n| `erk slot assign`     | Assigns existing branch to slot      |\n| `erk pr checkout`     | Assigns branch when checking out PR  |\n\n## Configuration\n\nIn `.erk/config.toml` (local config):\n\n```toml\n[pool]\nmax_slots = 6  # Override default of 4\n```\n\n## Key Source Files\n\n- [`src/erk/core/worktree_pool.py`](../../../src/erk/core/worktree_pool.py) - Data structures and persistence\n- [`src/erk/cli/commands/slot/common.py`](../../../src/erk/cli/commands/slot/common.py) - Allocation algorithm\n- [`src/erk/cli/commands/slot/diagnostics.py`](../../../src/erk/cli/commands/slot/diagnostics.py) - Health checks\n- [`src/erk/cli/commands/slot/repair_cmd.py`](../../../src/erk/cli/commands/slot/repair_cmd.py) - Auto-repair\n\n## Related Topics\n\n- [Branch Cleanup](branch-cleanup.md) - Cleaning up branches and worktrees\n- Load `gt-graphite` skill for worktree stack mental model\n","structuredPatch":[{"oldStart":92,"oldLines":6,"newStart":92,"newLines":23,"lines":[" "," These directories are in `.gitignore` so they persist across branch switches without cleanup."," ","+## Transparent State Correction","+","+The pool treats manual `git checkout` and `gt create` operations in pool slots as valid. When a user changes branches directly inside a worktree slot, the pool silently corrects its state on the next allocation call rather than raising an error.","+","+<!-- Source: src/erk/cli/commands/slot/common.py:223-287, sync_pool_assignments -->","+","+`sync_pool_assignments()` runs before every allocation decision. It compares each assignment's recorded branch against the actual git branch in the worktree and updates `pool.json` when mismatches are detected. If no corrections are needed, it skips the disk write entirely (preserving file mtime).","+","+Edge cases handled:","+","+- **Missing worktree directory** — assignment preserved (may be temporarily unmounted)","+- **Detached HEAD** — assignment preserved (user may be mid-operation)","+- **Placeholder branches** — assignment preserved (don't record stub branch names)","+- **Branch changed** — assignment updated with actual branch, original `assigned_at` preserved for LRU ordering","+","+For full details on the sync algorithm, see [Slot Pool State Sync](../architecture/slot-pool-state-sync.md).","+"," ## Diagnostics & Repair"," "," ### Sync Issues (`src/erk/cli/commands/slot/diagnostics.py`)"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"482b3d1b-6d7c-4434-96bb-ba020fb79cae","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01NHMDoTH4KZJkceiQSXk6dP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018jDq1LeMFH9qZKhixL3XBS","name":"TodoWrite","input":{"todos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"in_progress","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"pending","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"pending","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":465,"cache_read_input_tokens":95260,"cache_creation":{"ephemeral_5m_input_tokens":465,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4u86qmh7AXy5AKbdCs","type":"assistant","uuid":"f4203b3a-960b-4f91-8458-7e300b073f0d","timestamp":"2026-02-21T23:17:53.618Z"}
{"parentUuid":"f4203b3a-960b-4f91-8458-7e300b073f0d","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018jDq1LeMFH9qZKhixL3XBS","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"078456c4-fd4b-4780-997d-cdc3378a936b","timestamp":"2026-02-21T23:17:53.633Z","toolUseResult":{"oldTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"in_progress","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"pending","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"pending","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"pending","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}],"newTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"in_progress","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"pending","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"pending","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]}}
{"parentUuid":"078456c4-fd4b-4780-997d-cdc3378a936b","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01Lsg5mE6KeqcukMLg8gHCG1","type":"message","role":"assistant","content":[{"type":"text","text":"## Step 5: Create CLI backend-aware display pattern doc"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":565,"cache_read_input_tokens":95725,"cache_creation":{"ephemeral_5m_input_tokens":565,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4uY2GDN9yAWheSMSLP","type":"assistant","uuid":"ee0732c9-597f-4f73-8130-b594692dcb60","timestamp":"2026-02-21T23:17:55.699Z"}
{"parentUuid":"ee0732c9-597f-4f73-8130-b594692dcb60","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01Lsg5mE6KeqcukMLg8gHCG1","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TXrsoHeXXK9R5tJmrEABSq","name":"Write","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/cli/backend-aware-display.md","content":"---\ntitle: CLI Backend-Aware Display Patterns\nread_when:\n  - \"adding CLI commands that behave differently for issue vs draft-PR plans\"\n  - \"routing between gh issue and gh pr commands based on plan backend\"\n  - \"understanding how plan_backend affects CLI output\"\ntripwires:\n  - action: \"using gh issue view on a plan without checking plan backend type\"\n    warning: \"Draft-PR plan IDs are PR numbers, not issue numbers. Using gh issue view on a draft-PR plan produces a confusing 404. Route to gh pr view based on backend type.\"\n    score: 7\n---\n\n# CLI Backend-Aware Display Patterns\n\nCLI commands that interact with plans must handle two backends: `github` (issue-based) and `github-draft-pr` (draft PR-based). This document covers the patterns for routing behavior based on backend type.\n\n## Three Detection Patterns\n\nThe codebase uses three approaches to detect the active backend, each suited to different contexts:\n\n### Pattern 1: Interface Delegation (Preferred)\n\n<!-- Source: src/erk/cli/commands/learn/learn_cmd.py -->\n\nCommands that operate on plan metadata should use the `plan_backend` abstract interface without checking the type. Both backends implement the same methods:\n\n```python\n# learn_cmd.py — no backend branching needed\nplan_id = ctx.plan_backend.resolve_plan_id_for_branch(ctx.cwd, branch_name)\nsessions = ctx.plan_backend.find_sessions_for_plan(repo_root, plan_id)\nvalue = ctx.plan_backend.get_metadata_field(repo_root, plan_id, \"learn_materials_branch\")\n```\n\nUse this when the operation is the same regardless of backend — the abstraction handles routing internally.\n\n### Pattern 2: Provider Name Check (Exec Scripts)\n\n<!-- Source: src/erk/cli/commands/exec/scripts/handle_no_changes.py:79 -->\n\nExec scripts that need different behavior use the provider name:\n\n```python\nbackend = require_plan_backend(ctx)\nis_draft_pr = backend.get_provider_name() == \"github-draft-pr\"\n```\n\nUse this in exec scripts where `require_plan_backend()` is already in scope.\n\n### Pattern 3: Direct Comparison (TUI)\n\n<!-- Source: src/erk/tui/commands/registry.py:31-33, _is_github_backend -->\n\nThe TUI command palette uses a simple predicate:\n\n```python\ndef _is_github_backend(ctx: CommandContext) -> bool:\n    return ctx.plan_backend == \"github\"\n```\n\nUse this for availability filtering where you need a boolean check.\n\n## Terminology Routing\n\nWhen displaying plan information to users, use backend-appropriate terminology:\n\n| Concept      | Issue Backend  | Draft-PR Backend |\n| ------------ | -------------- | ---------------- |\n| Plan storage | \"issue\"        | \"draft PR\"       |\n| Plan ID      | Issue number   | PR number        |\n| View command | `gh issue view` | `gh pr view`     |\n| Plan label   | `erk-plan`     | `erk-plan`       |\n\n## When to Use Each Pattern\n\n| Scenario                              | Pattern                  |\n| ------------------------------------- | ------------------------ |\n| Metadata reads/writes                 | Interface delegation     |\n| Different GitHub CLI commands needed  | Provider name check      |\n| Command visibility filtering          | Direct comparison        |\n| Output text differences (\"issue\" vs \"draft PR\") | Provider name check |\n\n## Related Topics\n\n- [Backend-Aware TUI Commands](../tui/backend-aware-commands.md) — TUI-specific command filtering by backend\n- [Draft PR Plan Backend](../planning/draft-pr-plan-backend.md) — Backend architecture and selection\n"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":565,"cache_read_input_tokens":95725,"cache_creation":{"ephemeral_5m_input_tokens":565,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4uY2GDN9yAWheSMSLP","type":"assistant","uuid":"385dce47-53ef-4080-b6f8-22d75091f6e2","timestamp":"2026-02-21T23:18:16.229Z"}
{"parentUuid":"385dce47-53ef-4080-b6f8-22d75091f6e2","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TXrsoHeXXK9R5tJmrEABSq","type":"tool_result","content":"File created successfully at: /home/runner/work/erk/erk/docs/learned/cli/backend-aware-display.md"}]},"uuid":"4b6438df-bb80-4444-9951-4a58517fd1dd","timestamp":"2026-02-21T23:18:16.944Z","toolUseResult":{"type":"create","filePath":"/home/runner/work/erk/erk/docs/learned/cli/backend-aware-display.md","content":"---\ntitle: CLI Backend-Aware Display Patterns\nread_when:\n  - \"adding CLI commands that behave differently for issue vs draft-PR plans\"\n  - \"routing between gh issue and gh pr commands based on plan backend\"\n  - \"understanding how plan_backend affects CLI output\"\ntripwires:\n  - action: \"using gh issue view on a plan without checking plan backend type\"\n    warning: \"Draft-PR plan IDs are PR numbers, not issue numbers. Using gh issue view on a draft-PR plan produces a confusing 404. Route to gh pr view based on backend type.\"\n    score: 7\n---\n\n# CLI Backend-Aware Display Patterns\n\nCLI commands that interact with plans must handle two backends: `github` (issue-based) and `github-draft-pr` (draft PR-based). This document covers the patterns for routing behavior based on backend type.\n\n## Three Detection Patterns\n\nThe codebase uses three approaches to detect the active backend, each suited to different contexts:\n\n### Pattern 1: Interface Delegation (Preferred)\n\n<!-- Source: src/erk/cli/commands/learn/learn_cmd.py -->\n\nCommands that operate on plan metadata should use the `plan_backend` abstract interface without checking the type. Both backends implement the same methods:\n\n```python\n# learn_cmd.py — no backend branching needed\nplan_id = ctx.plan_backend.resolve_plan_id_for_branch(ctx.cwd, branch_name)\nsessions = ctx.plan_backend.find_sessions_for_plan(repo_root, plan_id)\nvalue = ctx.plan_backend.get_metadata_field(repo_root, plan_id, \"learn_materials_branch\")\n```\n\nUse this when the operation is the same regardless of backend — the abstraction handles routing internally.\n\n### Pattern 2: Provider Name Check (Exec Scripts)\n\n<!-- Source: src/erk/cli/commands/exec/scripts/handle_no_changes.py:79 -->\n\nExec scripts that need different behavior use the provider name:\n\n```python\nbackend = require_plan_backend(ctx)\nis_draft_pr = backend.get_provider_name() == \"github-draft-pr\"\n```\n\nUse this in exec scripts where `require_plan_backend()` is already in scope.\n\n### Pattern 3: Direct Comparison (TUI)\n\n<!-- Source: src/erk/tui/commands/registry.py:31-33, _is_github_backend -->\n\nThe TUI command palette uses a simple predicate:\n\n```python\ndef _is_github_backend(ctx: CommandContext) -> bool:\n    return ctx.plan_backend == \"github\"\n```\n\nUse this for availability filtering where you need a boolean check.\n\n## Terminology Routing\n\nWhen displaying plan information to users, use backend-appropriate terminology:\n\n| Concept      | Issue Backend  | Draft-PR Backend |\n| ------------ | -------------- | ---------------- |\n| Plan storage | \"issue\"        | \"draft PR\"       |\n| Plan ID      | Issue number   | PR number        |\n| View command | `gh issue view` | `gh pr view`     |\n| Plan label   | `erk-plan`     | `erk-plan`       |\n\n## When to Use Each Pattern\n\n| Scenario                              | Pattern                  |\n| ------------------------------------- | ------------------------ |\n| Metadata reads/writes                 | Interface delegation     |\n| Different GitHub CLI commands needed  | Provider name check      |\n| Command visibility filtering          | Direct comparison        |\n| Output text differences (\"issue\" vs \"draft PR\") | Provider name check |\n\n## Related Topics\n\n- [Backend-Aware TUI Commands](../tui/backend-aware-commands.md) — TUI-specific command filtering by backend\n- [Draft PR Plan Backend](../planning/draft-pr-plan-backend.md) — Backend architecture and selection\n","structuredPatch":[],"originalFile":null}}
{"parentUuid":"4b6438df-bb80-4444-9951-4a58517fd1dd","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01AuhTQTaPsJ9Hpq1wyFodL7","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KUWDEkqoFPSKZ3jYN3hGkE","name":"TodoWrite","input":{"todos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"in_progress","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"pending","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1042,"cache_read_input_tokens":96290,"cache_creation":{"ephemeral_5m_input_tokens":1042,"ephemeral_1h_input_tokens":0},"output_tokens":19,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4wFmGaHnzCcrxc6KTy","type":"assistant","uuid":"13489c8b-a7af-4bf4-b964-55df3cb94253","timestamp":"2026-02-21T23:18:23.137Z"}
{"parentUuid":"13489c8b-a7af-4bf4-b964-55df3cb94253","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KUWDEkqoFPSKZ3jYN3hGkE","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"8b40a2e0-a1a3-4e19-a72e-5058ecea0dc2","timestamp":"2026-02-21T23:18:23.180Z","toolUseResult":{"oldTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"in_progress","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"pending","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"pending","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}],"newTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"in_progress","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"pending","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]}}
{"parentUuid":"8b40a2e0-a1a3-4e19-a72e-5058ecea0dc2","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01Czg9vdviWJ5RhUnzC4cENy","type":"message","role":"assistant","content":[{"type":"text","text":"## Step 6: Update draft-pr-plan-backend.md\n\nI need to add a section on implementation setup and `.erk/impl-context/` cleanup. Let me first check the impl-context doc for accurate details:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":565,"cache_read_input_tokens":97332,"cache_creation":{"ephemeral_5m_input_tokens":565,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4wiNurzDwSbT6UJA3t","type":"assistant","uuid":"7d1ff27d-eeab-4cd8-af05-ce7e9924f404","timestamp":"2026-02-21T23:18:26.120Z"}
{"parentUuid":"7d1ff27d-eeab-4cd8-af05-ce7e9924f404","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01Czg9vdviWJ5RhUnzC4cENy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018bDWq41Zv3H6JF847bcYrg","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/planning/impl-context.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":565,"cache_read_input_tokens":97332,"cache_creation":{"ephemeral_5m_input_tokens":565,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4wiNurzDwSbT6UJA3t","type":"assistant","uuid":"fad3ae1c-dcaf-4534-91d2-6819cc799cc5","timestamp":"2026-02-21T23:18:26.742Z"}
{"parentUuid":"fad3ae1c-dcaf-4534-91d2-6819cc799cc5","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018bDWq41Zv3H6JF847bcYrg","type":"tool_result","content":"     1→---\n     2→title: Impl-Context Staging Directory\n     3→read_when:\n     4→  - \"working with .erk/impl-context/ files\"\n     5→  - \"debugging plan content missing from a draft-PR implementation\"\n     6→  - \"reviewing a PR that contains .erk/impl-context/ files\"\n     7→  - \"understanding how draft-PR plans transfer content to .impl/\"\n     8→tripwires:\n     9→  - action: \"reviewing a PR that contains .erk/impl-context/ files\"\n    10→    warning: \"Leave a PR comment telling the author to remove .erk/impl-context/. This is an erk tooling error — the directory should have been cleaned up before implementation. Run: git rm -rf .erk/impl-context/ && git commit -m 'Remove leaked impl-context'\"\n    11→  - action: \"removing git-tracked temporary directories in setup scripts\"\n    12→    warning: \"Defer deletion to the git cleanup phase (git rm + commit + push), not shutil.rmtree(). setup_impl_from_issue.py reads the files but deliberately does NOT delete them — see the comment at line 202. Deletion is handled by plan-implement.md Step 2d.\"\n    13→    score: 8\n    14→  - action: \"adding a new setup path to plan-implement without routing through Step 2d\"\n    15→    warning: \"Impl-context cleanup routing: all code paths that set up an implementation context must route through Step 2d in plan-implement.md, which is the single convergence point for .erk/impl-context/ cleanup. Adding a new setup path that bypasses Step 2d will silently skip cleanup, leaving .erk/impl-context/ files in the final PR diff.\"\n    16→    score: 9\n    17→  - action: \"calling `create_worker_impl_folder()` without checking `worker_impl_folder_exists()` first\"\n    18→    warning: \"Both submit paths use LBYL: `if worker_impl_folder_exists(): remove_worker_impl_folder()` before creating. Stale .worker-impl/ from a prior failed submission causes errors.\"\n    19→---\n    20→\n    21→# Impl-Context Staging Directory\n    22→\n    23→`.erk/impl-context/` is a temporary staging directory used during draft-PR plan saving. It exists on the plan branch between plan creation and the start of implementation, then gets cleaned up.\n    24→\n    25→## Lifecycle\n    26→\n    27→### Creation\n    28→\n    29→During `plan_save.py`, after creating the plan branch, the script:\n    30→\n    31→1. Checks out the plan branch\n    32→2. Creates `.erk/impl-context/` and writes `plan.md` (plan content) and `ref.json` (plan reference metadata)\n    33→3. Stages and commits both files\n    34→4. Pushes to remote\n    35→5. Checks out the original branch\n    36→\n    37→This commit gives the draft PR a non-empty diff (GitHub rejects PRs with no file changes) and enables inline plan review via the \"Files Changed\" tab.\n    38→\n    39→See: `src/erk/cli/commands/exec/scripts/plan_save.py:163-182`\n    40→\n    41→### Cleanup\n    42→\n    43→The directory is cleaned up before implementation begins via a two-phase deferred cleanup pattern. All five setup paths converge at **Step 2d** in `plan-implement.md`, which is the single cleanup point:\n    44→\n    45→1. **`setup_impl_from_issue.py`** (Phase 1, read-only) — Reads `plan.md` and `ref.json`, copies content into `.impl/`, but deliberately does NOT delete the directory. See comment at `src/erk/cli/commands/exec/scripts/setup_impl_from_issue.py:202`: \"Do not delete here — Step 2d in plan-implement.md handles git rm + commit + push\"\n    46→\n    47→2. **`plan-implement.md` Step 2d** (Phase 2, git cleanup — convergence point) — All five setup paths (ISSUE_ARG, FILE_ARG, existing `.impl/` with issue tracking, existing `.impl/` without issue tracking, fallback plan-save) reach this step. Performs the actual deletion with `git rm -rf .erk/impl-context/ && git commit && git push`. This deferred approach ensures removal is committed, not just deleted from the local filesystem. The step is **idempotent** — safe to run even when the directory doesn't exist.\n    48→\n    49→3. **`plan-implement.yml` CI workflow** — Cleans up before the implementation agent runs, as a safety net for remote execution.\n    50→\n    51→### Why It Could Leak (Historical)\n    52→\n    53→Prior to PR #7747 (#7752), cleanup was not guaranteed across all setup paths — if a path bypassed Step 2d, the files would persist on the branch and appear in the final PR diff. This has been fixed: all paths now converge at Step 2d.\n    54→\n    55→The key failure mode was confusing \"delete from disk\" (shutil.rmtree) with \"remove from git tracking\" (git rm + commit + push). When adding a new setup path, always route through the Step 2d convergence point — skipping it silently bypasses cleanup.\n    56→\n    57→## Prevention Strategies\n    58→\n    59→### Worker-Impl Cleanup\n    60→\n    61→Both submit paths use the LBYL pattern to clean up stale `.worker-impl/` before creating a new one:\n    62→\n    63→<!-- Source: src/erk/cli/commands/submit.py, worker_impl_folder_exists -->\n    64→\n    65→See the `worker_impl_folder_exists()` / `remove_worker_impl_folder()` LBYL guard in `src/erk/cli/commands/submit.py`. Both submit paths use this pattern to prevent errors from a prior failed submission leaving a stale `.worker-impl/` directory behind (fixed in PR #7687).\n    66→\n    67→### Deferred Impl-Context Deletion\n    68→\n    69→`setup_impl_from_issue.py:202` reads the impl-context files but deliberately does NOT delete them. The comment is explicit:\n    70→\n    71→> \"Do not delete here — Step 2d in plan-implement.md handles git rm + commit + push\"\n    72→\n    73→This deferred pattern exists because filesystem deletion (`shutil.rmtree`) only removes the local copy. The files remain in git tracking and appear in the PR diff. Only `git rm` + commit + push removes them from the branch history.\n    74→\n    75→## Related Documentation\n    76→\n    77→- [Draft PR Plan Backend](draft-pr-plan-backend.md) — Backend that uses impl-context\n    78→- [Draft PR Lifecycle](draft-pr-lifecycle.md) — Full lifecycle of draft-PR plans\n    79→- [Draft PR Branch Sync](draft-pr-branch-sync.md) — Branch sync before implementation\n    80→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"f19a04c1-a168-4f3c-ab5b-089ea0175735","timestamp":"2026-02-21T23:18:26.756Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/docs/learned/planning/impl-context.md","content":"---\ntitle: Impl-Context Staging Directory\nread_when:\n  - \"working with .erk/impl-context/ files\"\n  - \"debugging plan content missing from a draft-PR implementation\"\n  - \"reviewing a PR that contains .erk/impl-context/ files\"\n  - \"understanding how draft-PR plans transfer content to .impl/\"\ntripwires:\n  - action: \"reviewing a PR that contains .erk/impl-context/ files\"\n    warning: \"Leave a PR comment telling the author to remove .erk/impl-context/. This is an erk tooling error — the directory should have been cleaned up before implementation. Run: git rm -rf .erk/impl-context/ && git commit -m 'Remove leaked impl-context'\"\n  - action: \"removing git-tracked temporary directories in setup scripts\"\n    warning: \"Defer deletion to the git cleanup phase (git rm + commit + push), not shutil.rmtree(). setup_impl_from_issue.py reads the files but deliberately does NOT delete them — see the comment at line 202. Deletion is handled by plan-implement.md Step 2d.\"\n    score: 8\n  - action: \"adding a new setup path to plan-implement without routing through Step 2d\"\n    warning: \"Impl-context cleanup routing: all code paths that set up an implementation context must route through Step 2d in plan-implement.md, which is the single convergence point for .erk/impl-context/ cleanup. Adding a new setup path that bypasses Step 2d will silently skip cleanup, leaving .erk/impl-context/ files in the final PR diff.\"\n    score: 9\n  - action: \"calling `create_worker_impl_folder()` without checking `worker_impl_folder_exists()` first\"\n    warning: \"Both submit paths use LBYL: `if worker_impl_folder_exists(): remove_worker_impl_folder()` before creating. Stale .worker-impl/ from a prior failed submission causes errors.\"\n---\n\n# Impl-Context Staging Directory\n\n`.erk/impl-context/` is a temporary staging directory used during draft-PR plan saving. It exists on the plan branch between plan creation and the start of implementation, then gets cleaned up.\n\n## Lifecycle\n\n### Creation\n\nDuring `plan_save.py`, after creating the plan branch, the script:\n\n1. Checks out the plan branch\n2. Creates `.erk/impl-context/` and writes `plan.md` (plan content) and `ref.json` (plan reference metadata)\n3. Stages and commits both files\n4. Pushes to remote\n5. Checks out the original branch\n\nThis commit gives the draft PR a non-empty diff (GitHub rejects PRs with no file changes) and enables inline plan review via the \"Files Changed\" tab.\n\nSee: `src/erk/cli/commands/exec/scripts/plan_save.py:163-182`\n\n### Cleanup\n\nThe directory is cleaned up before implementation begins via a two-phase deferred cleanup pattern. All five setup paths converge at **Step 2d** in `plan-implement.md`, which is the single cleanup point:\n\n1. **`setup_impl_from_issue.py`** (Phase 1, read-only) — Reads `plan.md` and `ref.json`, copies content into `.impl/`, but deliberately does NOT delete the directory. See comment at `src/erk/cli/commands/exec/scripts/setup_impl_from_issue.py:202`: \"Do not delete here — Step 2d in plan-implement.md handles git rm + commit + push\"\n\n2. **`plan-implement.md` Step 2d** (Phase 2, git cleanup — convergence point) — All five setup paths (ISSUE_ARG, FILE_ARG, existing `.impl/` with issue tracking, existing `.impl/` without issue tracking, fallback plan-save) reach this step. Performs the actual deletion with `git rm -rf .erk/impl-context/ && git commit && git push`. This deferred approach ensures removal is committed, not just deleted from the local filesystem. The step is **idempotent** — safe to run even when the directory doesn't exist.\n\n3. **`plan-implement.yml` CI workflow** — Cleans up before the implementation agent runs, as a safety net for remote execution.\n\n### Why It Could Leak (Historical)\n\nPrior to PR #7747 (#7752), cleanup was not guaranteed across all setup paths — if a path bypassed Step 2d, the files would persist on the branch and appear in the final PR diff. This has been fixed: all paths now converge at Step 2d.\n\nThe key failure mode was confusing \"delete from disk\" (shutil.rmtree) with \"remove from git tracking\" (git rm + commit + push). When adding a new setup path, always route through the Step 2d convergence point — skipping it silently bypasses cleanup.\n\n## Prevention Strategies\n\n### Worker-Impl Cleanup\n\nBoth submit paths use the LBYL pattern to clean up stale `.worker-impl/` before creating a new one:\n\n<!-- Source: src/erk/cli/commands/submit.py, worker_impl_folder_exists -->\n\nSee the `worker_impl_folder_exists()` / `remove_worker_impl_folder()` LBYL guard in `src/erk/cli/commands/submit.py`. Both submit paths use this pattern to prevent errors from a prior failed submission leaving a stale `.worker-impl/` directory behind (fixed in PR #7687).\n\n### Deferred Impl-Context Deletion\n\n`setup_impl_from_issue.py:202` reads the impl-context files but deliberately does NOT delete them. The comment is explicit:\n\n> \"Do not delete here — Step 2d in plan-implement.md handles git rm + commit + push\"\n\nThis deferred pattern exists because filesystem deletion (`shutil.rmtree`) only removes the local copy. The files remain in git tracking and appear in the PR diff. Only `git rm` + commit + push removes them from the branch history.\n\n## Related Documentation\n\n- [Draft PR Plan Backend](draft-pr-plan-backend.md) — Backend that uses impl-context\n- [Draft PR Lifecycle](draft-pr-lifecycle.md) — Full lifecycle of draft-PR plans\n- [Draft PR Branch Sync](draft-pr-branch-sync.md) — Branch sync before implementation\n","numLines":80,"startLine":1,"totalLines":80}}}
{"parentUuid":"f19a04c1-a168-4f3c-ab5b-089ea0175735","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01Hv848PvyXnXxi2vzrK7BPK","type":"message","role":"assistant","content":[{"type":"text","text":"Good, the impl-context doc is comprehensive. Now I'll add the section to `draft-pr-plan-backend.md`:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1975,"cache_read_input_tokens":97897,"cache_creation":{"ephemeral_5m_input_tokens":1975,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4wyfBFDru3vkyKgir6","type":"assistant","uuid":"77bfeddb-4382-41dc-a21a-7fb05cc4e0b4","timestamp":"2026-02-21T23:18:29.425Z"}
{"parentUuid":"77bfeddb-4382-41dc-a21a-7fb05cc4e0b4","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01Hv848PvyXnXxi2vzrK7BPK","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019i47wpjiJxPk4LcfhiFEjA","name":"Edit","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/planning/draft-pr-plan-backend.md","old_string":"## Related Topics\n\n- [Branch Plan Resolution](branch-plan-resolution.md) - How branches resolve to plans\n- [Plan Save Branch Restoration](../architecture/plan-save-branch-restoration.md) - Try/finally pattern for branch safety\n- [Dual Backend Testing](../testing/dual-backend-testing.md) - Testing across both backends","new_string":"## Implementation Setup and .erk/impl-context/ Cleanup\n\nWhen implementing a draft-PR plan, the `.erk/impl-context/` staging directory must be cleaned up before implementation begins. This directory contains `plan.md` and `ref.json` committed during plan-save to give the draft PR a non-empty diff.\n\n**Cleanup pattern:**\n\n1. `setup_impl_from_issue.py` reads the files into `.impl/` but does NOT delete them (deferred cleanup)\n2. `plan-implement.md` Step 2d performs the actual `git rm -rf .erk/impl-context/ && git commit && git push`\n3. The step is **idempotent** — safe to run when the directory doesn't exist\n\n**Rebase conflict handling:** After cleanup commits on the plan branch, a `git pull --rebase` may be needed before pushing further implementation commits. Skipping this can cause non-fast-forward push failures when the remote branch has diverged.\n\nFor full details, see [Impl-Context Staging Directory](impl-context.md).\n\n## Related Topics\n\n- [Branch Plan Resolution](branch-plan-resolution.md) - How branches resolve to plans\n- [Plan Save Branch Restoration](../architecture/plan-save-branch-restoration.md) - Try/finally pattern for branch safety\n- [Dual Backend Testing](../testing/dual-backend-testing.md) - Testing across both backends\n- [Impl-Context Staging Directory](impl-context.md) - Staging directory lifecycle and cleanup"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1975,"cache_read_input_tokens":97897,"cache_creation":{"ephemeral_5m_input_tokens":1975,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4wyfBFDru3vkyKgir6","type":"assistant","uuid":"d7dfa29c-96c9-474b-8bee-878fc90d97f6","timestamp":"2026-02-21T23:18:37.594Z"}
{"parentUuid":"d7dfa29c-96c9-474b-8bee-878fc90d97f6","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019i47wpjiJxPk4LcfhiFEjA","type":"tool_result","content":"The file /home/runner/work/erk/erk/docs/learned/planning/draft-pr-plan-backend.md has been updated successfully."}]},"uuid":"aa9f1f68-59d0-4383-9a83-06e3eb541fae","timestamp":"2026-02-21T23:18:38.330Z","toolUseResult":{"filePath":"/home/runner/work/erk/erk/docs/learned/planning/draft-pr-plan-backend.md","oldString":"## Related Topics\n\n- [Branch Plan Resolution](branch-plan-resolution.md) - How branches resolve to plans\n- [Plan Save Branch Restoration](../architecture/plan-save-branch-restoration.md) - Try/finally pattern for branch safety\n- [Dual Backend Testing](../testing/dual-backend-testing.md) - Testing across both backends","newString":"## Implementation Setup and .erk/impl-context/ Cleanup\n\nWhen implementing a draft-PR plan, the `.erk/impl-context/` staging directory must be cleaned up before implementation begins. This directory contains `plan.md` and `ref.json` committed during plan-save to give the draft PR a non-empty diff.\n\n**Cleanup pattern:**\n\n1. `setup_impl_from_issue.py` reads the files into `.impl/` but does NOT delete them (deferred cleanup)\n2. `plan-implement.md` Step 2d performs the actual `git rm -rf .erk/impl-context/ && git commit && git push`\n3. The step is **idempotent** — safe to run when the directory doesn't exist\n\n**Rebase conflict handling:** After cleanup commits on the plan branch, a `git pull --rebase` may be needed before pushing further implementation commits. Skipping this can cause non-fast-forward push failures when the remote branch has diverged.\n\nFor full details, see [Impl-Context Staging Directory](impl-context.md).\n\n## Related Topics\n\n- [Branch Plan Resolution](branch-plan-resolution.md) - How branches resolve to plans\n- [Plan Save Branch Restoration](../architecture/plan-save-branch-restoration.md) - Try/finally pattern for branch safety\n- [Dual Backend Testing](../testing/dual-backend-testing.md) - Testing across both backends\n- [Impl-Context Staging Directory](impl-context.md) - Staging directory lifecycle and cleanup","originalFile":"---\ntitle: Draft PR Plan Backend\nread_when:\n  - \"working with plan storage or plan backends\"\n  - \"adding plan storage behavior without checking plan backend type\"\n  - \"understanding how plans are stored as draft pull requests\"\n  - \"modifying plan-save or land pipeline for plan handling\"\ntripwires:\n  - action: \"adding plan storage behavior without checking plan backend type\"\n    warning: \"Two backends exist (github, draft_pr). Verify behavior works for both. See draft-pr-plan-backend.md.\"\n  - action: \"validating plan_id in exec scripts without checking provider type\"\n    warning: \"Draft-PR plan_id IS the PR number (not an issue number). Check provider type before assuming plan_id semantics. Issue-based plans use issue numbers; draft-PR plans use PR numbers.\"\n    score: 4\n  - action: \"reading ERK_PLAN_BACKEND env var inside inner functions when global_config is already in scope\"\n    warning: \"Backend detection precedence: when GlobalConfig.plan_backend is available via context, use it. Never fall back to re-reading env vars inside inner functions if global_config is already in scope — the context value takes precedence and re-reading env vars bypasses context overrides.\"\n    score: 8\n  - action: \"spawning a GitHub Actions workflow from erk without passing plan_backend as an explicit input\"\n    warning: \"Draft-PR backend propagation: GitHub Actions reusable workflows (workflow_call) do NOT inherit environment variables from the caller. ERK_PLAN_BACKEND must be declared as an explicit workflow input and passed by the caller. Ambient env vars are invisible to reusable workflows.\"\n    score: 9\n---\n\n# Draft PR Plan Backend\n\nDraftPRPlanBackend stores plans as GitHub draft pull requests instead of issues. It is an alternative to the default GitHubPlanStore (issue-based) backend.\n\n## Backend Selection\n\nBackend selection is controlled by the `ERK_PLAN_BACKEND` environment variable, read by `get_plan_backend()` in `packages/erk-shared/src/erk_shared/plan_store/__init__.py:19-24`:\n\n- `\"github\"` (default): Issue-based storage via GitHubPlanStore\n- `\"draft_pr\"`: Draft PR-based storage via DraftPRPlanBackend\n\nContext creation in `src/erk/core/context.py:604-609` uses this to select both the plan store and plan list service:\n\n<!-- Source: src/erk/core/context.py, create_context -->\n\nSee backend selection in `create_context()` in `src/erk/core/context.py` — dispatches on `get_plan_backend()` to select GitHubPlanStore or DraftPRPlanBackend.\n\n## Architecture\n\nDraftPRPlanBackend uses **composition** — it wraps the top-level GitHub gateway, not inheritance. The class is at `packages/erk-shared/src/erk_shared/plan_store/draft_pr.py`.\n\nKey design decisions:\n\n- **Lightweight init**: No I/O in `__init__`, dependencies injected (`github`, `time`)\n- **Provider name**: `\"github-draft-pr\"` (used for conditional dispatch elsewhere)\n- **Immutable metadata fields**: `schema_version`, `created_at`, `created_by` are protected from updates\n\n## PR Body Format\n\nPlan PRs use a structured body format: metadata block + separator + plan content.\n\n- **Separator**: `\"\\n\\n---\\n\\n\"`\n- **Label**: `\"erk-plan\"`\n- **Structure**: `<!-- plan-header metadata -->` + separator + `# Plan: Title` + content\n\nHelper functions `build_plan_stage_body()` and `extract_plan_content()` (public, in `draft_pr_lifecycle.py`) handle composition and extraction.\n\n## Plan File Commit\n\nPlans are committed to `.erk/plan/PLAN.md` on the draft PR branch. The `plan_save.py` script uses a try/finally pattern for branch restoration — see [plan-save-branch-restoration.md](../architecture/plan-save-branch-restoration.md).\n\n## Branch Naming\n\nThree branch name formats are supported:\n\n- **P-prefix**: `P{number}-{slug}` (issue-based plan branches)\n- **Objective format**: `P{number}-O{objective}-{slug}` (plans linked to objectives)\n- **Draft-PR**: `planned/{slug}-{MM-DD-HHMM}` or `planned/O{objective}-{slug}-{MM-DD-HHMM}` (draft-PR plans)\n\nSee [branch-plan-resolution.md](branch-plan-resolution.md) for how branches resolve to plans.\n\n## Land Pipeline Integration\n\nThe `close_review_pr()` function in `src/erk/cli/commands/land_pipeline.py:469-471` skips cleanup for draft-PR plans since they don't have separate review PRs:\n\n<!-- Source: src/erk/cli/commands/land_pipeline.py, close_review_pr -->\n\nSee `close_review_pr()` in `src/erk/cli/commands/land_pipeline.py` — skips cleanup for draft-PR plans.\n\n## Type Narrowing\n\nThe backend uses explicit `isinstance()` checks and conditional type conversion for metadata fields, following LBYL discipline rather than `cast()`.\n\n## Title Prefixing Behavior\n\nDraft PR titles (and issue-based plan titles) are prefixed with a label-based tag via `get_title_tag_from_labels()` in `packages/erk-shared/src/erk_shared/plan_utils.py:178-190`.\n\n<!-- Source: packages/erk-shared/src/erk_shared/plan_utils.py:178-190, get_title_tag_from_labels -->\n\nThe function returns `\"[erk-learn]\"` if `\"erk-learn\"` is in the labels list, otherwise `\"[erk-plan]\"`. The prefix is prepended to the plan title during PR creation (e.g., `[erk-plan] My Feature`). For erk-learn plans, the prefix becomes `[erk-learn]` to distinguish documentation/learning plans from implementation plans in the PR list.\n\n## GraphQL Refactor: `list_plan_prs_with_details()`\n\nThe plan data provider fetches PRs via a single GraphQL query (`list_plan_prs_with_details()`) instead of N+1 REST calls. This function lives in `packages/erk-shared/src/erk_shared/gateway/github/real.py:1588` and returns:\n\n- `list[PRDetails]` — for plan content extraction\n- `dict[int, list[PullRequestInfo]]` — for display metadata (checks, review threads, merge status)\n\nThe single query uses `GET_PLAN_PRS_WITH_DETAILS_QUERY` from `graphql_queries.py` and fetches review decision, conflict status, and CI checks in one round-trip, replacing the previous approach of fetching each PR individually.\n\n## Related Topics\n\n- [Branch Plan Resolution](branch-plan-resolution.md) - How branches resolve to plans\n- [Plan Save Branch Restoration](../architecture/plan-save-branch-restoration.md) - Try/finally pattern for branch safety\n- [Dual Backend Testing](../testing/dual-backend-testing.md) - Testing across both backends\n","structuredPatch":[{"oldStart":99,"oldLines":8,"newStart":99,"newLines":23,"lines":[" "," The single query uses `GET_PLAN_PRS_WITH_DETAILS_QUERY` from `graphql_queries.py` and fetches review decision, conflict status, and CI checks in one round-trip, replacing the previous approach of fetching each PR individually."," ","+## Implementation Setup and .erk/impl-context/ Cleanup","+","+When implementing a draft-PR plan, the `.erk/impl-context/` staging directory must be cleaned up before implementation begins. This directory contains `plan.md` and `ref.json` committed during plan-save to give the draft PR a non-empty diff.","+","+**Cleanup pattern:**","+","+1. `setup_impl_from_issue.py` reads the files into `.impl/` but does NOT delete them (deferred cleanup)","+2. `plan-implement.md` Step 2d performs the actual `git rm -rf .erk/impl-context/ && git commit && git push`","+3. The step is **idempotent** — safe to run when the directory doesn't exist","+","+**Rebase conflict handling:** After cleanup commits on the plan branch, a `git pull --rebase` may be needed before pushing further implementation commits. Skipping this can cause non-fast-forward push failures when the remote branch has diverged.","+","+For full details, see [Impl-Context Staging Directory](impl-context.md).","+"," ## Related Topics"," "," - [Branch Plan Resolution](branch-plan-resolution.md) - How branches resolve to plans"," - [Plan Save Branch Restoration](../architecture/plan-save-branch-restoration.md) - Try/finally pattern for branch safety"," - [Dual Backend Testing](../testing/dual-backend-testing.md) - Testing across both backends","+- [Impl-Context Staging Directory](impl-context.md) - Staging directory lifecycle and cleanup"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"aa9f1f68-59d0-4383-9a83-06e3eb541fae","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01Wpbmc5ryBJyst9y89xkLP9","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JcxeVt4fJYrhNbweBjg6Uu","name":"TodoWrite","input":{"todos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"completed","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"in_progress","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":617,"cache_read_input_tokens":99872,"cache_creation":{"ephemeral_5m_input_tokens":617,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4xq7zkbQm9mu9opMWi","type":"assistant","uuid":"cdcebb6b-019d-43b2-9b17-c77bce08da35","timestamp":"2026-02-21T23:18:43.893Z"}
{"parentUuid":"cdcebb6b-019d-43b2-9b17-c77bce08da35","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JcxeVt4fJYrhNbweBjg6Uu","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"66cdc846-dedf-475c-a4c5-8318d79e524d","timestamp":"2026-02-21T23:18:43.907Z","toolUseResult":{"oldTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"in_progress","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"pending","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}],"newTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"completed","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"in_progress","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]}}
{"parentUuid":"66cdc846-dedf-475c-a4c5-8318d79e524d","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_0165iZkA2rFfB5pxwAdSuFay","type":"message","role":"assistant","content":[{"type":"text","text":"## Steps 7-10: Tripwire Additions\n\nNow I need to add tripwires to the **source frontmatter files** (not the auto-generated tripwires.md files). The auto-generated files will be updated by `erk docs sync`. Let me add the tripwires to the correct source docs.\n\nFor Step 7 (architecture tripwires), the tripwire about \"sync before allocation\" is already in `slot-pool-state-sync.md` which I just created. The macOS sed and stash side effects tripwires need to go in appropriate source docs. Let me find or create suitable homes:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":565,"cache_read_input_tokens":100489,"cache_creation":{"ephemeral_5m_input_tokens":565,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4yExTQHrSzKiDL6smu","type":"assistant","uuid":"ac99e44c-878a-4433-8ab3-4611be84179b","timestamp":"2026-02-21T23:18:49.329Z"}
{"parentUuid":"ac99e44c-878a-4433-8ab3-4611be84179b","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_0165iZkA2rFfB5pxwAdSuFay","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AYyhHG2C71KsMr1aHQ5fXe","name":"Grep","input":{"pattern":"macOS|sed -i","path":"/home/runner/work/erk/erk/docs/learned/architecture","output_mode":"files_with_matches"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":565,"cache_read_input_tokens":100489,"cache_creation":{"ephemeral_5m_input_tokens":565,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4yExTQHrSzKiDL6smu","type":"assistant","uuid":"9d0bed72-503c-4a92-ac02-f6f0aa10b8f0","timestamp":"2026-02-21T23:18:50.617Z"}
{"parentUuid":"9d0bed72-503c-4a92-ac02-f6f0aa10b8f0","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_0165iZkA2rFfB5pxwAdSuFay","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NsLQ1VwSmk9GGroTXtWCmC","name":"Grep","input":{"pattern":"git stash","path":"/home/runner/work/erk/erk/docs/learned/architecture","output_mode":"files_with_matches"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":565,"cache_read_input_tokens":100489,"cache_creation":{"ephemeral_5m_input_tokens":565,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4yExTQHrSzKiDL6smu","type":"assistant","uuid":"838da44a-8781-4e52-bc57-9e05bf26a0d9","timestamp":"2026-02-21T23:18:51.306Z"}
{"parentUuid":"838da44a-8781-4e52-bc57-9e05bf26a0d9","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NsLQ1VwSmk9GGroTXtWCmC","type":"tool_result","content":"No files found"}]},"uuid":"db1a96f1-f1c1-41fc-8fc5-3f0eadb96943","timestamp":"2026-02-21T23:18:51.883Z","toolUseResult":{"mode":"files_with_matches","filenames":[],"numFiles":0}}
{"parentUuid":"db1a96f1-f1c1-41fc-8fc5-3f0eadb96943","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AYyhHG2C71KsMr1aHQ5fXe","type":"tool_result","content":"No files found"}]},"uuid":"f9515743-2efe-4ef8-8619-6bb94abb1793","timestamp":"2026-02-21T23:18:51.899Z","toolUseResult":{"mode":"files_with_matches","filenames":[],"numFiles":0}}
{"parentUuid":"f9515743-2efe-4ef8-8619-6bb94abb1793","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01Vbu3UveTcfFSRynT3mnVnc","type":"message","role":"assistant","content":[{"type":"text","text":"The macOS sed and git stash tripwires are lower-score items (4/10 each). Per the plan, they go into architecture/tripwires.md. But since tripwires.md is auto-generated from frontmatter, I need to add them to an existing architecture doc's frontmatter. Let me find the most appropriate doc - perhaps `subprocess-wrappers.md` for sed and `git-operation-patterns.md` for stash:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":34,"cache_creation_input_tokens":384,"cache_read_input_tokens":101054,"cache_creation":{"ephemeral_5m_input_tokens":384,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4yqMv2bJuC557wZFEn","type":"assistant","uuid":"f12568bd-0f1c-4501-967e-e89c481563fc","timestamp":"2026-02-21T23:18:57.084Z"}
{"parentUuid":"f12568bd-0f1c-4501-967e-e89c481563fc","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01Vbu3UveTcfFSRynT3mnVnc","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DkXJ4WnYwjJjAVuyD51Ayn","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/architecture/subprocess-wrappers.md","limit":20},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":34,"cache_creation_input_tokens":384,"cache_read_input_tokens":101054,"cache_creation":{"ephemeral_5m_input_tokens":384,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4yqMv2bJuC557wZFEn","type":"assistant","uuid":"a19ab764-6551-4903-9939-17afb7dffca3","timestamp":"2026-02-21T23:18:57.758Z"}
{"parentUuid":"a19ab764-6551-4903-9939-17afb7dffca3","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01Vbu3UveTcfFSRynT3mnVnc","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01EqoPiygbSuhUQBkWrLbk7i","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/architecture/git-operation-patterns.md","limit":20},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":34,"cache_creation_input_tokens":384,"cache_read_input_tokens":101054,"cache_creation":{"ephemeral_5m_input_tokens":384,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4yqMv2bJuC557wZFEn","type":"assistant","uuid":"a71fcde5-5453-4b4c-9c2b-6e20e7b66887","timestamp":"2026-02-21T23:18:58.352Z"}
{"parentUuid":"a71fcde5-5453-4b4c-9c2b-6e20e7b66887","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DkXJ4WnYwjJjAVuyD51Ayn","type":"tool_result","content":"     1→---\n     2→title: Subprocess Wrappers\n     3→last_audited: \"2026-02-16 00:00 PT\"\n     4→audit_result: edited\n     5→read_when:\n     6→  - \"using subprocess wrappers\"\n     7→  - \"executing shell commands\"\n     8→  - \"understanding subprocess patterns\"\n     9→tripwires:\n    10→  - action: \"using bare subprocess.run with check=True\"\n    11→    warning: \"Use wrapper functions: run_subprocess_with_context() (gateway) or run_with_error_reporting() (CLI). Exception: Graceful degradation pattern with explicit CalledProcessError handling is acceptable for optional operations.\"\n    12→    pattern: \"subprocess\\\\.run\\\\(\"\n    13→  - action: \"adding a Claude subprocess call with --print mode\"\n    14→    warning: \"Always include --no-session-persistence flag and use env=build_claude_subprocess_env() parameter. Both are required to prevent session persistence and CLAUDECODE context leakage. See the 'Claude Subprocess Environment' section.\"\n    15→---\n    16→\n    17→# Subprocess Execution Wrappers\n    18→\n    19→**NEVER use bare `subprocess.run(..., check=True)`. ALWAYS use wrapper functions.**\n    20→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"231560cf-cda9-4335-b1c1-ee0d3b6f4a32","timestamp":"2026-02-21T23:18:58.414Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/docs/learned/architecture/subprocess-wrappers.md","content":"---\ntitle: Subprocess Wrappers\nlast_audited: \"2026-02-16 00:00 PT\"\naudit_result: edited\nread_when:\n  - \"using subprocess wrappers\"\n  - \"executing shell commands\"\n  - \"understanding subprocess patterns\"\ntripwires:\n  - action: \"using bare subprocess.run with check=True\"\n    warning: \"Use wrapper functions: run_subprocess_with_context() (gateway) or run_with_error_reporting() (CLI). Exception: Graceful degradation pattern with explicit CalledProcessError handling is acceptable for optional operations.\"\n    pattern: \"subprocess\\\\.run\\\\(\"\n  - action: \"adding a Claude subprocess call with --print mode\"\n    warning: \"Always include --no-session-persistence flag and use env=build_claude_subprocess_env() parameter. Both are required to prevent session persistence and CLAUDECODE context leakage. See the 'Claude Subprocess Environment' section.\"\n---\n\n# Subprocess Execution Wrappers\n\n**NEVER use bare `subprocess.run(..., check=True)`. ALWAYS use wrapper functions.**\n","numLines":20,"startLine":1,"totalLines":376}}}
{"parentUuid":"231560cf-cda9-4335-b1c1-ee0d3b6f4a32","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01EqoPiygbSuhUQBkWrLbk7i","type":"tool_result","content":"     1→---\n     2→title: Git Operation Patterns\n     3→last_audited: \"2026-02-16 14:20 PT\"\n     4→audit_result: clean\n     5→read_when:\n     6→  - \"implementing git operations in gateways\"\n     7→  - \"checking if git branches or refs exist\"\n     8→  - \"deciding between LBYL and EAFP for git commands\"\n     9→tripwires:\n    10→  - score: 7\n    11→    action: \"parsing CalledProcessError messages for git operations\"\n    12→    warning: \"Avoid parsing git error messages to determine failure modes. Use LBYL with git show-ref --verify to check existence before operations, or design discriminated unions that handle all returncode cases explicitly.\"\n    13→    context: \"Git error message parsing is fragile (messages can change across versions, localization issues). LBYL with git show-ref is more reliable. For operations with multiple failure modes, use discriminated unions based on returncode patterns.\"\n    14→---\n    15→\n    16→# Git Operation Patterns\n    17→\n    18→## The LBYL Principle for Git Operations\n    19→\n    20→Erk's LBYL-first philosophy extends to git operations: **check existence before acting** rather than catching and parsing error messages. This pattern leverages git's stable exit code contracts instead of brittle string matching.\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"b18f26b4-91ed-42be-8acf-0d675538a150","timestamp":"2026-02-21T23:18:58.414Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/docs/learned/architecture/git-operation-patterns.md","content":"---\ntitle: Git Operation Patterns\nlast_audited: \"2026-02-16 14:20 PT\"\naudit_result: clean\nread_when:\n  - \"implementing git operations in gateways\"\n  - \"checking if git branches or refs exist\"\n  - \"deciding between LBYL and EAFP for git commands\"\ntripwires:\n  - score: 7\n    action: \"parsing CalledProcessError messages for git operations\"\n    warning: \"Avoid parsing git error messages to determine failure modes. Use LBYL with git show-ref --verify to check existence before operations, or design discriminated unions that handle all returncode cases explicitly.\"\n    context: \"Git error message parsing is fragile (messages can change across versions, localization issues). LBYL with git show-ref is more reliable. For operations with multiple failure modes, use discriminated unions based on returncode patterns.\"\n---\n\n# Git Operation Patterns\n\n## The LBYL Principle for Git Operations\n\nErk's LBYL-first philosophy extends to git operations: **check existence before acting** rather than catching and parsing error messages. This pattern leverages git's stable exit code contracts instead of brittle string matching.","numLines":20,"startLine":1,"totalLines":145}}}
{"parentUuid":"b18f26b4-91ed-42be-8acf-0d675538a150","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01P8zYVhGeC6vUJuVdEzzFdt","type":"message","role":"assistant","content":[{"type":"text","text":"The \"sync before allocation\" tripwire is already in `slot-pool-state-sync.md` (score 9). The macOS sed (score 4) and stash side effects (score 4) are lower-priority. Let me add macOS sed to `subprocess-wrappers.md` and stash side effects to `git-operation-patterns.md`:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1522,"cache_read_input_tokens":101438,"cache_creation":{"ephemeral_5m_input_tokens":1522,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4zK24eDwXBq7x334wN","type":"assistant","uuid":"9c44c76c-e365-468e-be53-732cba0f0e3c","timestamp":"2026-02-21T23:19:01.701Z"}
{"parentUuid":"9c44c76c-e365-468e-be53-732cba0f0e3c","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01P8zYVhGeC6vUJuVdEzzFdt","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JHfDz2xJy6MEVBCXBGi69B","name":"Edit","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/architecture/subprocess-wrappers.md","old_string":"  - action: \"adding a Claude subprocess call with --print mode\"\n    warning: \"Always include --no-session-persistence flag and use env=build_claude_subprocess_env() parameter. Both are required to prevent session persistence and CLAUDECODE context leakage. See the 'Claude Subprocess Environment' section.\"","new_string":"  - action: \"adding a Claude subprocess call with --print mode\"\n    warning: \"Always include --no-session-persistence flag and use env=build_claude_subprocess_env() parameter. Both are required to prevent session persistence and CLAUDECODE context leakage. See the 'Claude Subprocess Environment' section.\"\n  - action: \"using sed -i in scripts that run on both macOS and Linux\"\n    warning: \"macOS sed requires `sed -i ''` (empty string argument) while Linux sed uses `sed -i` (no argument). Scripts that use sed -i without handling this difference will fail silently on one platform.\"\n    score: 4"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1522,"cache_read_input_tokens":101438,"cache_creation":{"ephemeral_5m_input_tokens":1522,"ephemeral_1h_input_tokens":0},"output_tokens":416,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4zK24eDwXBq7x334wN","type":"assistant","uuid":"bb78debf-ce90-475e-8ff2-c04905bcb0bb","timestamp":"2026-02-21T23:19:05.512Z"}
{"parentUuid":"bb78debf-ce90-475e-8ff2-c04905bcb0bb","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JHfDz2xJy6MEVBCXBGi69B","type":"tool_result","content":"The file /home/runner/work/erk/erk/docs/learned/architecture/subprocess-wrappers.md has been updated successfully."}]},"uuid":"b0466cfc-2631-4178-8078-cecf897abe08","timestamp":"2026-02-21T23:19:06.249Z","toolUseResult":{"filePath":"/home/runner/work/erk/erk/docs/learned/architecture/subprocess-wrappers.md","oldString":"  - action: \"adding a Claude subprocess call with --print mode\"\n    warning: \"Always include --no-session-persistence flag and use env=build_claude_subprocess_env() parameter. Both are required to prevent session persistence and CLAUDECODE context leakage. See the 'Claude Subprocess Environment' section.\"","newString":"  - action: \"adding a Claude subprocess call with --print mode\"\n    warning: \"Always include --no-session-persistence flag and use env=build_claude_subprocess_env() parameter. Both are required to prevent session persistence and CLAUDECODE context leakage. See the 'Claude Subprocess Environment' section.\"\n  - action: \"using sed -i in scripts that run on both macOS and Linux\"\n    warning: \"macOS sed requires `sed -i ''` (empty string argument) while Linux sed uses `sed -i` (no argument). Scripts that use sed -i without handling this difference will fail silently on one platform.\"\n    score: 4","originalFile":"---\ntitle: Subprocess Wrappers\nlast_audited: \"2026-02-16 00:00 PT\"\naudit_result: edited\nread_when:\n  - \"using subprocess wrappers\"\n  - \"executing shell commands\"\n  - \"understanding subprocess patterns\"\ntripwires:\n  - action: \"using bare subprocess.run with check=True\"\n    warning: \"Use wrapper functions: run_subprocess_with_context() (gateway) or run_with_error_reporting() (CLI). Exception: Graceful degradation pattern with explicit CalledProcessError handling is acceptable for optional operations.\"\n    pattern: \"subprocess\\\\.run\\\\(\"\n  - action: \"adding a Claude subprocess call with --print mode\"\n    warning: \"Always include --no-session-persistence flag and use env=build_claude_subprocess_env() parameter. Both are required to prevent session persistence and CLAUDECODE context leakage. See the 'Claude Subprocess Environment' section.\"\n---\n\n# Subprocess Execution Wrappers\n\n**NEVER use bare `subprocess.run(..., check=True)`. ALWAYS use wrapper functions.**\n\nThis guide explains the two-layer pattern for subprocess execution in erk: gateway layer and CLI layer wrappers.\n\n## Scope\n\n**These rules apply to production erk code** in `src/erk/` and `packages/erk-shared/`.\n\n**Exception: erk-dev** (`packages/erk-dev/`) is developer tooling and is exempt from these rules. Direct `subprocess.run` is acceptable in erk-dev commands since they don't need the testability/dry-run benefits of wrapper functions.\n\n## Two-Layer Pattern\n\nErk uses a two-layer design for subprocess execution to provide consistent error handling across different boundaries:\n\n- **Gateway layer**: `run_subprocess_with_context()` - Raises RuntimeError for business logic\n- **CLI layer**: `run_with_error_reporting()` - Prints user-friendly message and raises SystemExit\n\n## Wrapper Functions\n\n### run_subprocess_with_context (Gateway Layer)\n\n**When to use**: In business logic, gateway classes, and core functionality that may be called from multiple contexts.\n\n**Import**: `from erk_shared.subprocess_utils import run_subprocess_with_context`\n\n**Behavior**: Raises `RuntimeError` with rich context on failure\n\n**Usage**: Pass `cmd` (the command list), `operation_context` (human-readable description), and `cwd` (working directory). On failure, raises `RuntimeError` with the operation context, command, exit code, and stderr.\n\n<!-- Source: packages/erk-shared/src/erk_shared/subprocess_utils.py, run_subprocess_with_context -->\n\nSee `run_subprocess_with_context()` in `packages/erk-shared/src/erk_shared/subprocess_utils.py` for the full signature and implementation.\n\n**Why use this**:\n\n- **Rich error messages**: Includes operation context, command, exit code, stderr\n- **Exception chaining**: Preserves original CalledProcessError for debugging\n- **Testable**: Can be caught and handled in tests\n\n### run_with_error_reporting (CLI Layer)\n\n**When to use**: In CLI command handlers where you want to immediately exit on failure with a user-friendly message.\n\n**Import**: `from erk.cli.subprocess_utils import run_with_error_reporting`\n\n**Behavior**: Prints error message to stderr and raises `SystemExit` on failure\n\n**Example**:\n\n```python\nfrom erk.cli.subprocess_utils import run_with_error_reporting\n\n# ✅ CORRECT: User-friendly error messages + SystemExit\nrun_with_error_reporting(\n    [\"gh\", \"pr\", \"view\", str(pr_number)],\n    operation_context=\"view pull request\",\n    cwd=repo_root,\n)\n```\n\n**Why use this**:\n\n- **User-friendly**: Error messages are clear and actionable\n- **CLI semantics**: Exits immediately with non-zero code\n- **No exception handling needed**: Wrapper handles everything\n\n## Why This Matters\n\n- **Rich error messages**: Both wrappers include operation context, command, exit code, and stderr\n- **Exception chaining**: Preserves original CalledProcessError for debugging\n- **Consistent patterns**: Two clear boundaries with appropriate error handling\n- **Debugging support**: Full context available in error messages and logs\n\n## LBYL Patterns to Keep\n\n**DO NOT migrate check=False LBYL patterns** - these are intentional:\n\n```python\n# ✅ CORRECT: Intentional LBYL pattern (keep as-is)\nresult = subprocess.run(cmd, check=False, capture_output=True, text=True)\nif result.returncode != 0:\n    return None  # Graceful degradation\n```\n\nWhen code explicitly uses `check=False` and checks the return code, this is a Look Before You Leap (LBYL) pattern for graceful degradation. Do not refactor these to use wrappers.\n\n## Graceful Degradation Pattern\n\nNot all subprocess calls should use `run_with_error_reporting()`. Use explicit exception handling when:\n\n1. **The operation is optional** - Failure should not stop the main workflow\n2. **Fire-and-forget semantics** - The result is informational, not critical\n3. **Warning vs Error** - You want to show a warning and continue, not exit\n\n### Example: Async Learn Trigger in Land Command\n\n```python\n# Pattern: check=True with explicit CalledProcessError handling\ntry:\n    result = subprocess.run(cmd, check=True, capture_output=True, text=True)\n    # Handle success\nexcept subprocess.CalledProcessError as e:\n    # Show warning, continue execution\n    user_output(click.style(\"⚠ \", fg=\"yellow\") + f\"Optional operation failed: {e}\")\nexcept FileNotFoundError:\n    # Handle missing command gracefully\n    user_output(click.style(\"⚠ \", fg=\"yellow\") + \"Command not found\")\n```\n\n### Decision Table\n\n| Scenario                       | Pattern                         | Reason                           |\n| ------------------------------ | ------------------------------- | -------------------------------- |\n| CLI command that must succeed  | `run_with_error_reporting()`    | SystemExit on failure is correct |\n| Optional background operation  | Explicit exception handling     | Main operation should continue   |\n| Gateway real.py implementation | `run_subprocess_with_context()` | Consistent error wrapping        |\n\n## GitHub API Commands with Retry\n\nFor GitHub API commands that may fail due to transient network errors, use `execute_gh_command_with_retry()`:\n\n```python\nfrom erk_shared.subprocess_utils import execute_gh_command_with_retry\n\nresult = execute_gh_command_with_retry(cmd, cwd, time_impl)\n```\n\nThis builds on `run_subprocess_with_context()` and adds:\n\n- Automatic retry on transient errors (network timeouts, connection failures)\n- Exponential backoff delays (0.5s, 1.0s by default)\n- Time injection for testability\n\nSee [GitHub API Retry Mechanism](github-api-retry-mechanism.md) for the full pattern.\n\n## Error Accumulation Pattern\n\nWhen streaming stdout line-by-line with `subprocess.Popen()`, stderr must be captured in a background thread to avoid deadlock. This pattern is used in `ClaudePromptExecutor.execute_command_streaming()`.\n\n### Why Background Thread for Stderr?\n\nThe problem:\n\n1. Process writes to both stdout and stderr\n2. Main thread blocks on `for line in process.stdout`\n3. If stderr buffer fills, process blocks waiting for it to drain\n4. Deadlock: main thread waits for stdout, process waits for stderr\n\nThe solution:\n\n```\nMain Thread                          Background Thread\n───────────────────────────────      ──────────────────────────\nprocess = Popen(stdout=PIPE,\n                stderr=PIPE)\n                                     for line in process.stderr:\nfor line in process.stdout:              stderr_parts.append(line)\n    yield parse_event(line)\n\nprocess.wait()\nstderr_thread.join(timeout=5.0)\n# Use accumulated stderr in error msg\n```\n\n### Implementation Notes\n\n- Use `daemon=True` so thread doesn't prevent process exit\n- Use a timeout on `join()` to avoid hanging on pathological cases\n- Stderr is accumulated as list, joined only when needed for error message\n- See `src/erk/core/prompt_executor.py` for the canonical implementation\n\n### When to Use This Pattern\n\n- Streaming stdout with `Popen(stdout=PIPE)` while also capturing stderr\n- Long-running processes where stderr could fill its buffer\n- Real-time event processing that must not block\n\n### When NOT to Use This Pattern\n\n- Simple `subprocess.run(capture_output=True)` - handles this automatically\n- Fire-and-forget processes where stderr is ignored\n- Short-lived commands that complete quickly\n\n## Temporary File Lifecycle Pattern in Shell\n\nWhen passing large or formatted content to external CLI tools (like `gh pr comment`), use the standard Unix temp file pattern to avoid command-line argument limits and escape sequence issues.\n\n### The Pattern\n\n```bash\n# 1. Create temp file\nTEMP_FILE=$(mktemp)\n\n# 2. Write content with proper formatting\nprintf \"%b\\n\" \"$CONTENT\" > \"$TEMP_FILE\"\n\n# 3. Pass filename to command\ngh pr comment \"$PR_NUMBER\" --body-file \"$TEMP_FILE\"\n\n# 4. Cleanup\nrm \"$TEMP_FILE\"\n```\n\n### Why This Pattern?\n\n1. **Bypasses ARG_MAX**: Linux kernel limits command-line argument length to ~2MB. File I/O has no such limit.\n2. **Reliable escape sequences**: `printf \"%b\"` is POSIX standard for interpreting backslash escape sequences (`\\n`, `\\t`, etc.).\n3. **Clean resource management**: Explicit cleanup prevents temp file accumulation.\n\n### When to Use\n\n- GitHub Actions workflows posting CI outputs (rebase logs, test results)\n- Any CLI tool accepting file-based input (`--body-file`, `--input-file`, etc.)\n- Content that could potentially be large (>1KB as rule of thumb)\n- Multi-line content with escape sequences\n\n### Real-World Example\n\nFrom `.github/workflows/pr-fix-conflicts.yml`:\n\n```yaml\nBODY=\"## Conflict Resolution Failed\\n\\nRebase output:\\n\\`\\`\\`\\n$REBASE_OUTPUT\\n\\`\\`\\`\"\nTEMP_FILE=$(mktemp)\nprintf \"%b\\n\" \"$BODY\" > \"$TEMP_FILE\"\ngh pr comment \"$PR_NUMBER\" --body-file \"$TEMP_FILE\"\nrm \"$TEMP_FILE\"\n```\n\nThis pattern is especially important in CI where large content is common and shell behavior differs from local development (GitHub Actions uses dash/sh, not bash).\n\n### See Also\n\n- [GitHub CLI PR Comment Patterns](../ci/github-cli-comment-patterns.md) - Full guide to CI comment posting patterns\n- [GitHub Actions Output Patterns](../ci/github-actions-output-patterns.md) - For `$GITHUB_OUTPUT` (different context)\n\n## Lenient vs. Strict Handlers\n\nSome subprocess operations should fail gracefully while others should fail fast. The `_get_pr_for_plan_direct()` pattern from `trigger-async-learn` demonstrates the lenient approach.\n\n### Decision Matrix\n\n| Aspect                    | Lenient Handler                        | Strict Handler                         |\n| ------------------------- | -------------------------------------- | -------------------------------------- |\n| **Error handling**        | Returns `None` on any failure          | Raises exception or returns error type |\n| **Return type**           | `T \\| None`                            | `T` or discriminated union             |\n| **Use case**              | Optional operations, fail-open         | Critical operations, fail-closed       |\n| **Caller responsibility** | Check for `None`, decide how to handle | Catch exception or check error type    |\n\n### Lenient Pattern\n\nUse when the operation is **optional** and the caller should decide how to handle absence:\n\n<!-- Source: src/erk/cli/commands/exec/scripts/trigger_async_learn.py, _get_pr_for_plan_direct -->\n\nSee `_get_pr_for_plan_direct()` in `src/erk/cli/commands/exec/scripts/trigger_async_learn.py`. Returns `dict[str, object] | None` — `None` on any failure (missing issue, metadata, branch, or PR).\n\n**Characteristics:**\n\n- **No exceptions** - Never raises, always returns `None` on failure\n- **No error messages** - Caller decides what to log\n- **Uniform failure** - All failure modes return `None` consistently\n\n**When to use:**\n\n- Background operations that shouldn't block main workflow\n- Optional data fetching (e.g., review comments for learn)\n- Exploratory queries where absence is expected\n\n### Strict Pattern\n\nUse when the operation is **critical** and failure should be explicit:\n\nSee `get_pr_for_plan()` in `src/erk/cli/commands/exec/scripts/get_pr_for_plan.py` for the full implementation. It is a Click command that raises `SystemExit(1)` with JSON error output on any failure, and attempts branch_name recovery via pattern matching.\n\n**Characteristics:**\n\n- **Explicit errors** - Each failure mode has specific error message\n- **Recovery attempts** - May try to infer missing data before failing\n- **Clear contract** - Caller knows exceptions mean critical failure\n\n**When to use:**\n\n- User-facing commands where failure needs explanation\n- Critical path operations that cannot continue without the data\n- CLI commands that should exit with error message\n\n### Real-World Example: trigger-async-learn\n\nThe `trigger-async-learn` command uses **lenient handler** for PR lookup:\n\n```python\n# Lenient: Try to get PR info, but don't fail if unavailable\npr_info = _get_pr_for_plan_direct(...)\nif pr_info is None:\n    # No PR found - that's OK, just skip review comments\n    click.echo(\"No PR found for plan, skipping review comments\", err=True)\n    review_comments = None\nelse:\n    # PR found - fetch review comments\n    pr_number = pr_info[\"pr_number\"]\n    review_comments = fetch_review_comments(repo_root, pr_number)\n\n# Continue with learn workflow (with or without review comments)\nupload_materials(sessions, review_comments)\ntrigger_workflow(...)\n```\n\n**Why lenient?**\n\n- Learn can succeed without review comments\n- PR might not exist yet (plan created before implementation)\n- Running from GitHub Actions (no current branch for recovery)\n\n**Contrast with strict handler:**\n\nThe same PR lookup in `get_pr_for_plan.py` is **strict** because it's a user-facing command where the user explicitly asked for the PR and expects either the answer or a clear error message.\n\n### See Also\n\n- [Fail-Open Patterns](fail-open-patterns.md) - When to allow graceful degradation\n- [Branch Name Inference](../planning/branch-name-inference.md) - Recovery mechanism for missing branch_name\n\n## Claude Subprocess Environment\n\nWhen spawning Claude as a subprocess (using `--print` mode), two protections are required at every call site:\n\n1. **`--no-session-persistence` flag**: Prevents the subprocess Claude from creating persistent session artifacts that leak state between invocations.\n2. **`env=build_claude_subprocess_env()` parameter**: Strips the `CLAUDECODE` environment variable from the subprocess environment, preventing nested Claude instances from inheriting the parent's session context.\n\nSee `build_claude_subprocess_env()` in `packages/erk-shared/src/erk_shared/subprocess_utils.py` for the shared utility.\n\n### When to Use\n\n- Every `subprocess.run()` or `subprocess.Popen()` call that invokes `claude` with `--print`\n- Every `run_subprocess_with_context()` call targeting the Claude CLI\n- Both streaming (`Popen`) and single-shot (`subprocess.run`) invocations\n\n### Required Pattern\n\nBoth protections must be applied together. Applying only one leaves a gap:\n\n- Flag without env stripping: session won't persist but CLAUDECODE context leaks\n- Env stripping without flag: CLAUDECODE is clean but sessions still persist\n\n### Call Sites\n\nAll Claude subprocess calls across the codebase use this pattern. Grep for `--no-session-persistence` to see the canonical call sites, which span `src/erk/`, `packages/erk-shared/`, `packages/erk-dev/`, and `scripts/`.\n\n## Summary\n\n- **Gateway layer**: Use `run_subprocess_with_context()` for business logic\n- **CLI layer**: Use `run_with_error_reporting()` for command handlers\n- **GitHub with retry**: Use `execute_gh_command_with_retry()` for network-sensitive operations\n- **Streaming with stderr**: Use background thread accumulation pattern\n- **Temp file pattern**: Use `mktemp` → `printf \"%b\"` → file-based input → `rm` for large/formatted content\n- **Keep LBYL**: Don't migrate intentional `check=False` patterns\n- **Never use bare check=True**: Always use one of the wrapper functions\n","structuredPatch":[{"oldStart":12,"oldLines":6,"newStart":12,"newLines":9,"lines":["     pattern: \"subprocess\\\\.run\\\\(\"","   - action: \"adding a Claude subprocess call with --print mode\"","     warning: \"Always include --no-session-persistence flag and use env=build_claude_subprocess_env() parameter. Both are required to prevent session persistence and CLAUDECODE context leakage. See the 'Claude Subprocess Environment' section.\"","+  - action: \"using sed -i in scripts that run on both macOS and Linux\"","+    warning: \"macOS sed requires `sed -i ''` (empty string argument) while Linux sed uses `sed -i` (no argument). Scripts that use sed -i without handling this difference will fail silently on one platform.\"","+    score: 4"," ---"," "," # Subprocess Execution Wrappers"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"b0466cfc-2631-4178-8078-cecf897abe08","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01CWdFciuhJBXZpyta7t7AWy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DBons3tJcGLQh5nUo49Wi7","name":"Edit","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/architecture/git-operation-patterns.md","old_string":"  - score: 7\n    action: \"parsing CalledProcessError messages for git operations\"\n    warning: \"Avoid parsing git error messages to determine failure modes. Use LBYL with git show-ref --verify to check existence before operations, or design discriminated unions that handle all returncode cases explicitly.\"\n    context: \"Git error message parsing is fragile (messages can change across versions, localization issues). LBYL with git show-ref is more reliable. For operations with multiple failure modes, use discriminated unions based on returncode patterns.\"","new_string":"  - score: 7\n    action: \"parsing CalledProcessError messages for git operations\"\n    warning: \"Avoid parsing git error messages to determine failure modes. Use LBYL with git show-ref --verify to check existence before operations, or design discriminated unions that handle all returncode cases explicitly.\"\n    context: \"Git error message parsing is fragile (messages can change across versions, localization issues). LBYL with git show-ref is more reliable. For operations with multiple failure modes, use discriminated unions based on returncode patterns.\"\n  - action: \"using git stash in scripts that have running processes dependent on working tree state\"\n    warning: \"git stash changes working tree state which affects running processes. If code is executing from the working tree (e.g., Python scripts), stashing can cause import errors or missing file errors in the running process.\"\n    score: 4"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":460,"cache_read_input_tokens":102960,"cache_creation":{"ephemeral_5m_input_tokens":460,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN4ztVTa1P1BtQSzX3bW","type":"assistant","uuid":"af15df9e-69a3-4de5-a3e6-12e4b5ecb470","timestamp":"2026-02-21T23:19:12.047Z"}
{"parentUuid":"af15df9e-69a3-4de5-a3e6-12e4b5ecb470","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DBons3tJcGLQh5nUo49Wi7","type":"tool_result","content":"The file /home/runner/work/erk/erk/docs/learned/architecture/git-operation-patterns.md has been updated successfully."}]},"uuid":"be8188fd-0d91-4749-a382-8dec09412531","timestamp":"2026-02-21T23:19:12.784Z","toolUseResult":{"filePath":"/home/runner/work/erk/erk/docs/learned/architecture/git-operation-patterns.md","oldString":"  - score: 7\n    action: \"parsing CalledProcessError messages for git operations\"\n    warning: \"Avoid parsing git error messages to determine failure modes. Use LBYL with git show-ref --verify to check existence before operations, or design discriminated unions that handle all returncode cases explicitly.\"\n    context: \"Git error message parsing is fragile (messages can change across versions, localization issues). LBYL with git show-ref is more reliable. For operations with multiple failure modes, use discriminated unions based on returncode patterns.\"","newString":"  - score: 7\n    action: \"parsing CalledProcessError messages for git operations\"\n    warning: \"Avoid parsing git error messages to determine failure modes. Use LBYL with git show-ref --verify to check existence before operations, or design discriminated unions that handle all returncode cases explicitly.\"\n    context: \"Git error message parsing is fragile (messages can change across versions, localization issues). LBYL with git show-ref is more reliable. For operations with multiple failure modes, use discriminated unions based on returncode patterns.\"\n  - action: \"using git stash in scripts that have running processes dependent on working tree state\"\n    warning: \"git stash changes working tree state which affects running processes. If code is executing from the working tree (e.g., Python scripts), stashing can cause import errors or missing file errors in the running process.\"\n    score: 4","originalFile":"---\ntitle: Git Operation Patterns\nlast_audited: \"2026-02-16 14:20 PT\"\naudit_result: clean\nread_when:\n  - \"implementing git operations in gateways\"\n  - \"checking if git branches or refs exist\"\n  - \"deciding between LBYL and EAFP for git commands\"\ntripwires:\n  - score: 7\n    action: \"parsing CalledProcessError messages for git operations\"\n    warning: \"Avoid parsing git error messages to determine failure modes. Use LBYL with git show-ref --verify to check existence before operations, or design discriminated unions that handle all returncode cases explicitly.\"\n    context: \"Git error message parsing is fragile (messages can change across versions, localization issues). LBYL with git show-ref is more reliable. For operations with multiple failure modes, use discriminated unions based on returncode patterns.\"\n---\n\n# Git Operation Patterns\n\n## The LBYL Principle for Git Operations\n\nErk's LBYL-first philosophy extends to git operations: **check existence before acting** rather than catching and parsing error messages. This pattern leverages git's stable exit code contracts instead of brittle string matching.\n\n## Why git show-ref --verify Is the Right Check\n\n`git show-ref --verify` has a clear, version-stable returncode contract:\n\n- **returncode 0** = ref exists\n- **returncode non-zero** = ref doesn't exist\n\nThis is superior to parsing error messages from `git branch` or `git checkout` because:\n\n1. **Immune to localization** — error messages translate, returncodes don't\n2. **Stable across versions** — exit codes are API contracts, messages are UI\n3. **Single purpose** — explicitly designed for existence checks, not operation side effects\n4. **Matches erk's LBYL principle** — check condition first, act second\n\n<!-- Source: packages/erk-shared/src/erk_shared/gateway/git/branch_ops/real.py, RealGitBranchOps.create_branch, RealGitBranchOps.delete_branch -->\n\nSee `RealGitBranchOps.create_branch()` and `RealGitBranchOps.delete_branch()` in `packages/erk-shared/src/erk_shared/gateway/git/branch_ops/real.py` for the production pattern: both methods use `git show-ref --verify` to check existence before proceeding.\n\n## Decision Framework: LBYL vs Exception Handling\n\n| Scenario                                 | Pattern                           | Rationale                                                         |\n| ---------------------------------------- | --------------------------------- | ----------------------------------------------------------------- |\n| Branch/ref existence check               | LBYL with `git show-ref --verify` | Clear returncode contract, no message parsing                     |\n| Atomic operations (merge, rebase, fetch) | try/except in real.py only        | No meaningful pre-check, multiple failure modes, subprocess risks |\n| File existence before git operation      | LBYL with `Path.exists()`         | Follows erk's Pathlib-first + LBYL standards                      |\n| Multiple expected failure modes          | Discriminated unions              | Enable caller branching logic on specific error types             |\n\n**Key insight**: LBYL applies when a pre-check is semantically meaningful and actionable. For operations where the check IS the operation (atomic commands like merge), use try/except in real.py only.\n\n## Why Not Parse Error Messages\n\n**WRONG — Error message parsing:**\n\n```python\n# DON'T DO THIS\ntry:\n    result = run_subprocess([\"git\", \"branch\", name, start_point], ...)\nexcept CalledProcessError as e:\n    # FRAGILE: Message can change in new git versions or be localized\n    if \"already exists\" in e.stderr:\n        return BranchAlreadyExists(...)\n    raise\n```\n\n**Problems:**\n\n- Git error messages change across versions (2.30 vs 2.40+ have different phrasing)\n- Messages may be localized (`git config core.language`)\n- String matching is brittle to minor wording changes\n- Violates LBYL: you're catching the operation failure instead of checking first\n\n**RIGHT — Pre-check with stable exit codes:**\n\n<!-- Source: packages/erk-shared/src/erk_shared/gateway/git/branch_ops/real.py, RealGitBranchOps.create_branch -->\n\nSee `RealGitBranchOps.create_branch()` in `packages/erk-shared/src/erk_shared/gateway/git/branch_ops/real.py`:\n\nThe implementation uses `git show-ref --verify refs/heads/{branch_name}` before attempting creation. Returncode 0 means \"exists, return BranchAlreadyExists\". Non-zero returncode proceeds to creation.\n\n## When Exception Handling IS Appropriate\n\nGateway methods use try/except **only in real.py** to catch subprocess and system-level failures that cannot be pre-checked. This converts unpredictable runtime errors into structured discriminated unions.\n\n<!-- Source: packages/erk-shared/src/erk_shared/gateway/git/branch_ops/types.py, BranchCreated, BranchAlreadyExists -->\n\nSee `BranchCreated` and `BranchAlreadyExists` in `packages/erk-shared/src/erk_shared/gateway/git/branch_ops/types.py` for the discriminated union pattern: empty success marker + error type with message field.\n\n**Use try/except in real.py when:**\n\n1. **No meaningful LBYL check exists** — operations like `gh pr merge` can't be pre-validated without actually attempting the merge\n2. **Multiple subprocess-level failure modes** — distinguish between \"command not found\", \"permission denied\", \"merge conflict\"\n3. **Unpredictable system errors** — disk full, network timeout, process killed\n\n**What to catch:**\n\n- `CalledProcessError` from subprocess commands\n- `FileNotFoundError` for missing executables (gh, git)\n- `OSError` for system-level failures (permissions, disk space)\n\n**What NOT to catch:**\n\n- Programming errors (`AttributeError`, `TypeError`) — these should crash\n- Validation failures that caller should check via LBYL\n\n## The Gateway Error Boundary Pattern\n\nError handling responsibilities differ by implementation file:\n\n| File          | Error Handling Mechanism                                               | Uses try/except? |\n| ------------- | ---------------------------------------------------------------------- | ---------------- |\n| `real.py`     | Catches subprocess/system exceptions, converts to discriminated unions | **Yes**          |\n| `fake.py`     | Returns error discriminants based on constructor params                | No               |\n| `dry_run.py`  | Always returns success discriminants                                   | No               |\n| `abc.py`      | Defines return type signatures only                                    | No               |\n| `printing.py` | Delegates transparently                                                | No               |\n\n**Why this split?** Real implementations interact with unpredictable external systems. Fake implementations simulate pre-configured failure scenarios for tests. The error boundary belongs at the subprocess interface, not in test infrastructure.\n\nSee [Gateway Error Boundaries](gateway-error-boundaries.md) for the complete rationale and implementation patterns.\n\n## Relation to Discriminated Unions\n\nThe LBYL pattern with `git show-ref` complements discriminated union error handling:\n\n1. **Pre-check detects expected failures** (branch exists, ref doesn't exist)\n2. **Discriminated unions encode these as type-safe return values** (`BranchCreated | BranchAlreadyExists`)\n3. **try/except catches unexpected failures** (subprocess crash, git not installed)\n4. **Callers use isinstance() checks** for type-safe branching logic\n\n<!-- Source: packages/erk-shared/src/erk_shared/gateway/git/branch_ops/real.py, RealGitBranchOps.create_branch -->\n\nExample flow in `RealGitBranchOps.create_branch()`:\n\n- LBYL check with `git show-ref` detects \"branch exists\" → return `BranchAlreadyExists`\n- Creation attempt via subprocess (wrapped in try/except in real.py's caller context)\n- Success → return `BranchCreated`\n- Unexpected failure (process crash) → try/except converts to `RuntimeError`\n\n## Related Patterns\n\n- [Discriminated Union Error Handling](discriminated-union-error-handling.md) — When to use unions vs exceptions, pattern structure\n- [Gateway Error Boundaries](gateway-error-boundaries.md) — Where try/except belongs in the 5-file gateway pattern\n- [Subprocess Wrappers](subprocess-wrappers.md) — Using `run_subprocess_with_context()` correctly\n","structuredPatch":[{"oldStart":11,"oldLines":6,"newStart":11,"newLines":9,"lines":["     action: \"parsing CalledProcessError messages for git operations\"","     warning: \"Avoid parsing git error messages to determine failure modes. Use LBYL with git show-ref --verify to check existence before operations, or design discriminated unions that handle all returncode cases explicitly.\"","     context: \"Git error message parsing is fragile (messages can change across versions, localization issues). LBYL with git show-ref is more reliable. For operations with multiple failure modes, use discriminated unions based on returncode patterns.\"","+  - action: \"using git stash in scripts that have running processes dependent on working tree state\"","+    warning: \"git stash changes working tree state which affects running processes. If code is executing from the working tree (e.g., Python scripts), stashing can cause import errors or missing file errors in the running process.\"","+    score: 4"," ---"," "," # Git Operation Patterns"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"be8188fd-0d91-4749-a382-8dec09412531","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01ELs53ZgknGy5KJVCkxWRnV","type":"message","role":"assistant","content":[{"type":"text","text":"Step 7 done. Now Steps 8-10 for the remaining tripwires."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":811,"cache_read_input_tokens":103420,"cache_creation":{"ephemeral_5m_input_tokens":811,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN51NSireZyvPhW291Kj","type":"assistant","uuid":"98b1eb1d-d351-462e-9a0c-81d2ea160e9d","timestamp":"2026-02-21T23:19:15.149Z"}
{"parentUuid":"98b1eb1d-d351-462e-9a0c-81d2ea160e9d","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01ELs53ZgknGy5KJVCkxWRnV","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AQUnK8Zk1w5uGFGmGaXcub","name":"TodoWrite","input":{"todos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"completed","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"completed","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"in_progress","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":811,"cache_read_input_tokens":103420,"cache_creation":{"ephemeral_5m_input_tokens":811,"ephemeral_1h_input_tokens":0},"output_tokens":544,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN51NSireZyvPhW291Kj","type":"assistant","uuid":"63517de2-3920-4bb3-bf4e-802cb77903ba","timestamp":"2026-02-21T23:19:18.780Z"}
{"parentUuid":"63517de2-3920-4bb3-bf4e-802cb77903ba","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AQUnK8Zk1w5uGFGmGaXcub","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"70ce2e23-56e1-491d-a4e5-fc9078b733f7","timestamp":"2026-02-21T23:19:18.796Z","toolUseResult":{"oldTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"completed","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"in_progress","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"pending","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}],"newTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"completed","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"completed","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"in_progress","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]}}
{"parentUuid":"70ce2e23-56e1-491d-a4e5-fc9078b733f7","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01Pyq3NZ2bTPBaKUvkLsQfdm","type":"message","role":"assistant","content":[{"type":"text","text":"## Step 8: Add tripwires to planning source docs\n\nI need to add 3 tripwires:\n1. **Dual backend service consistency** (score 6) — to `draft-pr-plan-backend.md`\n2. **Git pull --rebase after impl-context cleanup** (score 4) — to `impl-context.md`\n3. **GitHub CLI routing for plan backends** — to `draft-pr-plan-backend.md`\n\nThe first and third fit naturally in `draft-pr-plan-backend.md`. The second fits in `impl-context.md`:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":586,"cache_read_input_tokens":104231,"cache_creation":{"ephemeral_5m_input_tokens":586,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN51pAHYSm34KhnVougK","type":"assistant","uuid":"1f5c1f0f-80f4-4c2f-825a-8f9b7c0a18df","timestamp":"2026-02-21T23:19:23.220Z"}
{"parentUuid":"1f5c1f0f-80f4-4c2f-825a-8f9b7c0a18df","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01Pyq3NZ2bTPBaKUvkLsQfdm","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CCWUwxcvPJ8Pyb1azNNv5a","name":"Edit","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/planning/draft-pr-plan-backend.md","old_string":"  - action: \"spawning a GitHub Actions workflow from erk without passing plan_backend as an explicit input\"\n    warning: \"Draft-PR backend propagation: GitHub Actions reusable workflows (workflow_call) do NOT inherit environment variables from the caller. ERK_PLAN_BACKEND must be declared as an explicit workflow input and passed by the caller. Ambient env vars are invisible to reusable workflows.\"\n    score: 9","new_string":"  - action: \"spawning a GitHub Actions workflow from erk without passing plan_backend as an explicit input\"\n    warning: \"Draft-PR backend propagation: GitHub Actions reusable workflows (workflow_call) do NOT inherit environment variables from the caller. ERK_PLAN_BACKEND must be declared as an explicit workflow input and passed by the caller. Ambient env vars are invisible to reusable workflows.\"\n    score: 9\n  - action: \"implementing RealPlanListService or DraftPRPlanListService without checking the other for parity\"\n    warning: \"Both plan list services must handle parameters identically. Interface contracts are not enforced by the type system — behavioral divergence between the two services causes subtle bugs when switching backends.\"\n    score: 6\n  - action: \"using gh issue view on a plan ID without checking plan backend type\"\n    warning: \"Draft-PR plan IDs are PR numbers. Using gh issue view on a draft-PR plan produces a confusing 404. Route to gh pr view based on backend type.\"\n    score: 7"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":586,"cache_read_input_tokens":104231,"cache_creation":{"ephemeral_5m_input_tokens":586,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN51pAHYSm34KhnVougK","type":"assistant","uuid":"86b859f4-3138-428b-ba8a-e94b26de9614","timestamp":"2026-02-21T23:19:31.354Z"}
{"parentUuid":"86b859f4-3138-428b-ba8a-e94b26de9614","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"<tool_use_error>File has not been read yet. Read it first before writing to it.</tool_use_error>","is_error":true,"tool_use_id":"toolu_01CCWUwxcvPJ8Pyb1azNNv5a"}]},"uuid":"af10d3b6-469f-4b5f-9140-8584dea17674","timestamp":"2026-02-21T23:19:31.363Z","toolUseResult":"Error: File has not been read yet. Read it first before writing to it."}
{"parentUuid":"af10d3b6-469f-4b5f-9140-8584dea17674","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01D9NkJNWL2BWeVQWJgad4TA","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PsuBwpSStcHcVfHNnErTUi","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/planning/draft-pr-plan-backend.md","limit":25},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":635,"cache_read_input_tokens":104817,"cache_creation":{"ephemeral_5m_input_tokens":635,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN52jtbG9DwGeuvceiWu","type":"assistant","uuid":"6e020c1d-fee3-4498-a4bc-5d1d87264151","timestamp":"2026-02-21T23:19:35.038Z"}
{"parentUuid":"6e020c1d-fee3-4498-a4bc-5d1d87264151","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PsuBwpSStcHcVfHNnErTUi","type":"tool_result","content":"     1→---\n     2→title: Draft PR Plan Backend\n     3→read_when:\n     4→  - \"working with plan storage or plan backends\"\n     5→  - \"adding plan storage behavior without checking plan backend type\"\n     6→  - \"understanding how plans are stored as draft pull requests\"\n     7→  - \"modifying plan-save or land pipeline for plan handling\"\n     8→tripwires:\n     9→  - action: \"adding plan storage behavior without checking plan backend type\"\n    10→    warning: \"Two backends exist (github, draft_pr). Verify behavior works for both. See draft-pr-plan-backend.md.\"\n    11→  - action: \"validating plan_id in exec scripts without checking provider type\"\n    12→    warning: \"Draft-PR plan_id IS the PR number (not an issue number). Check provider type before assuming plan_id semantics. Issue-based plans use issue numbers; draft-PR plans use PR numbers.\"\n    13→    score: 4\n    14→  - action: \"reading ERK_PLAN_BACKEND env var inside inner functions when global_config is already in scope\"\n    15→    warning: \"Backend detection precedence: when GlobalConfig.plan_backend is available via context, use it. Never fall back to re-reading env vars inside inner functions if global_config is already in scope — the context value takes precedence and re-reading env vars bypasses context overrides.\"\n    16→    score: 8\n    17→  - action: \"spawning a GitHub Actions workflow from erk without passing plan_backend as an explicit input\"\n    18→    warning: \"Draft-PR backend propagation: GitHub Actions reusable workflows (workflow_call) do NOT inherit environment variables from the caller. ERK_PLAN_BACKEND must be declared as an explicit workflow input and passed by the caller. Ambient env vars are invisible to reusable workflows.\"\n    19→    score: 9\n    20→---\n    21→\n    22→# Draft PR Plan Backend\n    23→\n    24→DraftPRPlanBackend stores plans as GitHub draft pull requests instead of issues. It is an alternative to the default GitHubPlanStore (issue-based) backend.\n    25→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"5e07922d-e7ff-4c62-a021-dd52464d8e4e","timestamp":"2026-02-21T23:19:35.268Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/docs/learned/planning/draft-pr-plan-backend.md","content":"---\ntitle: Draft PR Plan Backend\nread_when:\n  - \"working with plan storage or plan backends\"\n  - \"adding plan storage behavior without checking plan backend type\"\n  - \"understanding how plans are stored as draft pull requests\"\n  - \"modifying plan-save or land pipeline for plan handling\"\ntripwires:\n  - action: \"adding plan storage behavior without checking plan backend type\"\n    warning: \"Two backends exist (github, draft_pr). Verify behavior works for both. See draft-pr-plan-backend.md.\"\n  - action: \"validating plan_id in exec scripts without checking provider type\"\n    warning: \"Draft-PR plan_id IS the PR number (not an issue number). Check provider type before assuming plan_id semantics. Issue-based plans use issue numbers; draft-PR plans use PR numbers.\"\n    score: 4\n  - action: \"reading ERK_PLAN_BACKEND env var inside inner functions when global_config is already in scope\"\n    warning: \"Backend detection precedence: when GlobalConfig.plan_backend is available via context, use it. Never fall back to re-reading env vars inside inner functions if global_config is already in scope — the context value takes precedence and re-reading env vars bypasses context overrides.\"\n    score: 8\n  - action: \"spawning a GitHub Actions workflow from erk without passing plan_backend as an explicit input\"\n    warning: \"Draft-PR backend propagation: GitHub Actions reusable workflows (workflow_call) do NOT inherit environment variables from the caller. ERK_PLAN_BACKEND must be declared as an explicit workflow input and passed by the caller. Ambient env vars are invisible to reusable workflows.\"\n    score: 9\n---\n\n# Draft PR Plan Backend\n\nDraftPRPlanBackend stores plans as GitHub draft pull requests instead of issues. It is an alternative to the default GitHubPlanStore (issue-based) backend.\n","numLines":25,"startLine":1,"totalLines":122}}}
{"parentUuid":"5e07922d-e7ff-4c62-a021-dd52464d8e4e","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_018xqArXrqotFAreK6uMQWxY","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011L6jfpoB6c1JEa2S6xa5qg","name":"Edit","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/planning/draft-pr-plan-backend.md","old_string":"  - action: \"spawning a GitHub Actions workflow from erk without passing plan_backend as an explicit input\"\n    warning: \"Draft-PR backend propagation: GitHub Actions reusable workflows (workflow_call) do NOT inherit environment variables from the caller. ERK_PLAN_BACKEND must be declared as an explicit workflow input and passed by the caller. Ambient env vars are invisible to reusable workflows.\"\n    score: 9\n---","new_string":"  - action: \"spawning a GitHub Actions workflow from erk without passing plan_backend as an explicit input\"\n    warning: \"Draft-PR backend propagation: GitHub Actions reusable workflows (workflow_call) do NOT inherit environment variables from the caller. ERK_PLAN_BACKEND must be declared as an explicit workflow input and passed by the caller. Ambient env vars are invisible to reusable workflows.\"\n    score: 9\n  - action: \"implementing RealPlanListService or DraftPRPlanListService without checking the other for parity\"\n    warning: \"Both plan list services must handle parameters identically. Interface contracts are not enforced by the type system — behavioral divergence between the two services causes subtle bugs when switching backends.\"\n    score: 6\n  - action: \"using gh issue view on a plan ID without checking plan backend type\"\n    warning: \"Draft-PR plan IDs are PR numbers. Using gh issue view on a draft-PR plan produces a confusing 404. Route to gh pr view based on backend type.\"\n    score: 7\n---"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":707,"cache_read_input_tokens":105452,"cache_creation":{"ephemeral_5m_input_tokens":707,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN532aS8NMSs4P7HsV1B","type":"assistant","uuid":"d029acf6-c2ec-4fa1-9e5c-bcb91107bff5","timestamp":"2026-02-21T23:19:40.442Z"}
{"parentUuid":"d029acf6-c2ec-4fa1-9e5c-bcb91107bff5","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011L6jfpoB6c1JEa2S6xa5qg","type":"tool_result","content":"The file /home/runner/work/erk/erk/docs/learned/planning/draft-pr-plan-backend.md has been updated successfully."}]},"uuid":"d54e9f62-160e-44cf-b7c5-7cda896cbdb2","timestamp":"2026-02-21T23:19:41.156Z","toolUseResult":{"filePath":"/home/runner/work/erk/erk/docs/learned/planning/draft-pr-plan-backend.md","oldString":"  - action: \"spawning a GitHub Actions workflow from erk without passing plan_backend as an explicit input\"\n    warning: \"Draft-PR backend propagation: GitHub Actions reusable workflows (workflow_call) do NOT inherit environment variables from the caller. ERK_PLAN_BACKEND must be declared as an explicit workflow input and passed by the caller. Ambient env vars are invisible to reusable workflows.\"\n    score: 9\n---","newString":"  - action: \"spawning a GitHub Actions workflow from erk without passing plan_backend as an explicit input\"\n    warning: \"Draft-PR backend propagation: GitHub Actions reusable workflows (workflow_call) do NOT inherit environment variables from the caller. ERK_PLAN_BACKEND must be declared as an explicit workflow input and passed by the caller. Ambient env vars are invisible to reusable workflows.\"\n    score: 9\n  - action: \"implementing RealPlanListService or DraftPRPlanListService without checking the other for parity\"\n    warning: \"Both plan list services must handle parameters identically. Interface contracts are not enforced by the type system — behavioral divergence between the two services causes subtle bugs when switching backends.\"\n    score: 6\n  - action: \"using gh issue view on a plan ID without checking plan backend type\"\n    warning: \"Draft-PR plan IDs are PR numbers. Using gh issue view on a draft-PR plan produces a confusing 404. Route to gh pr view based on backend type.\"\n    score: 7\n---","originalFile":"---\ntitle: Draft PR Plan Backend\nread_when:\n  - \"working with plan storage or plan backends\"\n  - \"adding plan storage behavior without checking plan backend type\"\n  - \"understanding how plans are stored as draft pull requests\"\n  - \"modifying plan-save or land pipeline for plan handling\"\ntripwires:\n  - action: \"adding plan storage behavior without checking plan backend type\"\n    warning: \"Two backends exist (github, draft_pr). Verify behavior works for both. See draft-pr-plan-backend.md.\"\n  - action: \"validating plan_id in exec scripts without checking provider type\"\n    warning: \"Draft-PR plan_id IS the PR number (not an issue number). Check provider type before assuming plan_id semantics. Issue-based plans use issue numbers; draft-PR plans use PR numbers.\"\n    score: 4\n  - action: \"reading ERK_PLAN_BACKEND env var inside inner functions when global_config is already in scope\"\n    warning: \"Backend detection precedence: when GlobalConfig.plan_backend is available via context, use it. Never fall back to re-reading env vars inside inner functions if global_config is already in scope — the context value takes precedence and re-reading env vars bypasses context overrides.\"\n    score: 8\n  - action: \"spawning a GitHub Actions workflow from erk without passing plan_backend as an explicit input\"\n    warning: \"Draft-PR backend propagation: GitHub Actions reusable workflows (workflow_call) do NOT inherit environment variables from the caller. ERK_PLAN_BACKEND must be declared as an explicit workflow input and passed by the caller. Ambient env vars are invisible to reusable workflows.\"\n    score: 9\n---\n\n# Draft PR Plan Backend\n\nDraftPRPlanBackend stores plans as GitHub draft pull requests instead of issues. It is an alternative to the default GitHubPlanStore (issue-based) backend.\n\n## Backend Selection\n\nBackend selection is controlled by the `ERK_PLAN_BACKEND` environment variable, read by `get_plan_backend()` in `packages/erk-shared/src/erk_shared/plan_store/__init__.py:19-24`:\n\n- `\"github\"` (default): Issue-based storage via GitHubPlanStore\n- `\"draft_pr\"`: Draft PR-based storage via DraftPRPlanBackend\n\nContext creation in `src/erk/core/context.py:604-609` uses this to select both the plan store and plan list service:\n\n<!-- Source: src/erk/core/context.py, create_context -->\n\nSee backend selection in `create_context()` in `src/erk/core/context.py` — dispatches on `get_plan_backend()` to select GitHubPlanStore or DraftPRPlanBackend.\n\n## Architecture\n\nDraftPRPlanBackend uses **composition** — it wraps the top-level GitHub gateway, not inheritance. The class is at `packages/erk-shared/src/erk_shared/plan_store/draft_pr.py`.\n\nKey design decisions:\n\n- **Lightweight init**: No I/O in `__init__`, dependencies injected (`github`, `time`)\n- **Provider name**: `\"github-draft-pr\"` (used for conditional dispatch elsewhere)\n- **Immutable metadata fields**: `schema_version`, `created_at`, `created_by` are protected from updates\n\n## PR Body Format\n\nPlan PRs use a structured body format: metadata block + separator + plan content.\n\n- **Separator**: `\"\\n\\n---\\n\\n\"`\n- **Label**: `\"erk-plan\"`\n- **Structure**: `<!-- plan-header metadata -->` + separator + `# Plan: Title` + content\n\nHelper functions `build_plan_stage_body()` and `extract_plan_content()` (public, in `draft_pr_lifecycle.py`) handle composition and extraction.\n\n## Plan File Commit\n\nPlans are committed to `.erk/plan/PLAN.md` on the draft PR branch. The `plan_save.py` script uses a try/finally pattern for branch restoration — see [plan-save-branch-restoration.md](../architecture/plan-save-branch-restoration.md).\n\n## Branch Naming\n\nThree branch name formats are supported:\n\n- **P-prefix**: `P{number}-{slug}` (issue-based plan branches)\n- **Objective format**: `P{number}-O{objective}-{slug}` (plans linked to objectives)\n- **Draft-PR**: `planned/{slug}-{MM-DD-HHMM}` or `planned/O{objective}-{slug}-{MM-DD-HHMM}` (draft-PR plans)\n\nSee [branch-plan-resolution.md](branch-plan-resolution.md) for how branches resolve to plans.\n\n## Land Pipeline Integration\n\nThe `close_review_pr()` function in `src/erk/cli/commands/land_pipeline.py:469-471` skips cleanup for draft-PR plans since they don't have separate review PRs:\n\n<!-- Source: src/erk/cli/commands/land_pipeline.py, close_review_pr -->\n\nSee `close_review_pr()` in `src/erk/cli/commands/land_pipeline.py` — skips cleanup for draft-PR plans.\n\n## Type Narrowing\n\nThe backend uses explicit `isinstance()` checks and conditional type conversion for metadata fields, following LBYL discipline rather than `cast()`.\n\n## Title Prefixing Behavior\n\nDraft PR titles (and issue-based plan titles) are prefixed with a label-based tag via `get_title_tag_from_labels()` in `packages/erk-shared/src/erk_shared/plan_utils.py:178-190`.\n\n<!-- Source: packages/erk-shared/src/erk_shared/plan_utils.py:178-190, get_title_tag_from_labels -->\n\nThe function returns `\"[erk-learn]\"` if `\"erk-learn\"` is in the labels list, otherwise `\"[erk-plan]\"`. The prefix is prepended to the plan title during PR creation (e.g., `[erk-plan] My Feature`). For erk-learn plans, the prefix becomes `[erk-learn]` to distinguish documentation/learning plans from implementation plans in the PR list.\n\n## GraphQL Refactor: `list_plan_prs_with_details()`\n\nThe plan data provider fetches PRs via a single GraphQL query (`list_plan_prs_with_details()`) instead of N+1 REST calls. This function lives in `packages/erk-shared/src/erk_shared/gateway/github/real.py:1588` and returns:\n\n- `list[PRDetails]` — for plan content extraction\n- `dict[int, list[PullRequestInfo]]` — for display metadata (checks, review threads, merge status)\n\nThe single query uses `GET_PLAN_PRS_WITH_DETAILS_QUERY` from `graphql_queries.py` and fetches review decision, conflict status, and CI checks in one round-trip, replacing the previous approach of fetching each PR individually.\n\n## Implementation Setup and .erk/impl-context/ Cleanup\n\nWhen implementing a draft-PR plan, the `.erk/impl-context/` staging directory must be cleaned up before implementation begins. This directory contains `plan.md` and `ref.json` committed during plan-save to give the draft PR a non-empty diff.\n\n**Cleanup pattern:**\n\n1. `setup_impl_from_issue.py` reads the files into `.impl/` but does NOT delete them (deferred cleanup)\n2. `plan-implement.md` Step 2d performs the actual `git rm -rf .erk/impl-context/ && git commit && git push`\n3. The step is **idempotent** — safe to run when the directory doesn't exist\n\n**Rebase conflict handling:** After cleanup commits on the plan branch, a `git pull --rebase` may be needed before pushing further implementation commits. Skipping this can cause non-fast-forward push failures when the remote branch has diverged.\n\nFor full details, see [Impl-Context Staging Directory](impl-context.md).\n\n## Related Topics\n\n- [Branch Plan Resolution](branch-plan-resolution.md) - How branches resolve to plans\n- [Plan Save Branch Restoration](../architecture/plan-save-branch-restoration.md) - Try/finally pattern for branch safety\n- [Dual Backend Testing](../testing/dual-backend-testing.md) - Testing across both backends\n- [Impl-Context Staging Directory](impl-context.md) - Staging directory lifecycle and cleanup\n","structuredPatch":[{"oldStart":17,"oldLines":6,"newStart":17,"newLines":12,"lines":["   - action: \"spawning a GitHub Actions workflow from erk without passing plan_backend as an explicit input\"","     warning: \"Draft-PR backend propagation: GitHub Actions reusable workflows (workflow_call) do NOT inherit environment variables from the caller. ERK_PLAN_BACKEND must be declared as an explicit workflow input and passed by the caller. Ambient env vars are invisible to reusable workflows.\"","     score: 9","+  - action: \"implementing RealPlanListService or DraftPRPlanListService without checking the other for parity\"","+    warning: \"Both plan list services must handle parameters identically. Interface contracts are not enforced by the type system — behavioral divergence between the two services causes subtle bugs when switching backends.\"","+    score: 6","+  - action: \"using gh issue view on a plan ID without checking plan backend type\"","+    warning: \"Draft-PR plan IDs are PR numbers. Using gh issue view on a draft-PR plan produces a confusing 404. Route to gh pr view based on backend type.\"","+    score: 7"," ---"," "," # Draft PR Plan Backend"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"d54e9f62-160e-44cf-b7c5-7cda896cbdb2","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_016U4SnMMgKvz7PNx6jCZ6Si","type":"message","role":"assistant","content":[{"type":"text","text":"Now add the git pull --rebase tripwire to `impl-context.md`:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":502,"cache_read_input_tokens":106159,"cache_creation":{"ephemeral_5m_input_tokens":502,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN53TmFtVCNsgrq4PoWt","type":"assistant","uuid":"5a4284c2-8157-412e-a8bb-011f7cade334","timestamp":"2026-02-21T23:19:43.473Z"}
{"parentUuid":"5a4284c2-8157-412e-a8bb-011f7cade334","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_016U4SnMMgKvz7PNx6jCZ6Si","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013gKzUEGiTXP8ngk3zD6PHD","name":"Edit","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/planning/impl-context.md","old_string":"  - action: \"calling `create_worker_impl_folder()` without checking `worker_impl_folder_exists()` first\"\n    warning: \"Both submit paths use LBYL: `if worker_impl_folder_exists(): remove_worker_impl_folder()` before creating. Stale .worker-impl/ from a prior failed submission causes errors.\"","new_string":"  - action: \"calling `create_worker_impl_folder()` without checking `worker_impl_folder_exists()` first\"\n    warning: \"Both submit paths use LBYL: `if worker_impl_folder_exists(): remove_worker_impl_folder()` before creating. Stale .worker-impl/ from a prior failed submission causes errors.\"\n  - action: \"pushing implementation commits after impl-context cleanup without git pull --rebase\"\n    warning: \"After git rm + commit + push of .erk/impl-context/, the local branch may diverge from remote if other commits were pushed. Run git pull --rebase before pushing further implementation commits to avoid non-fast-forward push failures.\"\n    score: 4"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":502,"cache_read_input_tokens":106159,"cache_creation":{"ephemeral_5m_input_tokens":502,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN53TmFtVCNsgrq4PoWt","type":"assistant","uuid":"8b9695d9-a393-4b84-9a21-69e2d325f1a9","timestamp":"2026-02-21T23:19:49.102Z"}
{"parentUuid":"8b9695d9-a393-4b84-9a21-69e2d325f1a9","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013gKzUEGiTXP8ngk3zD6PHD","type":"tool_result","content":"The file /home/runner/work/erk/erk/docs/learned/planning/impl-context.md has been updated successfully."}]},"uuid":"305f86df-c3c4-45a5-ae81-4addff8135c8","timestamp":"2026-02-21T23:19:49.838Z","toolUseResult":{"filePath":"/home/runner/work/erk/erk/docs/learned/planning/impl-context.md","oldString":"  - action: \"calling `create_worker_impl_folder()` without checking `worker_impl_folder_exists()` first\"\n    warning: \"Both submit paths use LBYL: `if worker_impl_folder_exists(): remove_worker_impl_folder()` before creating. Stale .worker-impl/ from a prior failed submission causes errors.\"","newString":"  - action: \"calling `create_worker_impl_folder()` without checking `worker_impl_folder_exists()` first\"\n    warning: \"Both submit paths use LBYL: `if worker_impl_folder_exists(): remove_worker_impl_folder()` before creating. Stale .worker-impl/ from a prior failed submission causes errors.\"\n  - action: \"pushing implementation commits after impl-context cleanup without git pull --rebase\"\n    warning: \"After git rm + commit + push of .erk/impl-context/, the local branch may diverge from remote if other commits were pushed. Run git pull --rebase before pushing further implementation commits to avoid non-fast-forward push failures.\"\n    score: 4","originalFile":"---\ntitle: Impl-Context Staging Directory\nread_when:\n  - \"working with .erk/impl-context/ files\"\n  - \"debugging plan content missing from a draft-PR implementation\"\n  - \"reviewing a PR that contains .erk/impl-context/ files\"\n  - \"understanding how draft-PR plans transfer content to .impl/\"\ntripwires:\n  - action: \"reviewing a PR that contains .erk/impl-context/ files\"\n    warning: \"Leave a PR comment telling the author to remove .erk/impl-context/. This is an erk tooling error — the directory should have been cleaned up before implementation. Run: git rm -rf .erk/impl-context/ && git commit -m 'Remove leaked impl-context'\"\n  - action: \"removing git-tracked temporary directories in setup scripts\"\n    warning: \"Defer deletion to the git cleanup phase (git rm + commit + push), not shutil.rmtree(). setup_impl_from_issue.py reads the files but deliberately does NOT delete them — see the comment at line 202. Deletion is handled by plan-implement.md Step 2d.\"\n    score: 8\n  - action: \"adding a new setup path to plan-implement without routing through Step 2d\"\n    warning: \"Impl-context cleanup routing: all code paths that set up an implementation context must route through Step 2d in plan-implement.md, which is the single convergence point for .erk/impl-context/ cleanup. Adding a new setup path that bypasses Step 2d will silently skip cleanup, leaving .erk/impl-context/ files in the final PR diff.\"\n    score: 9\n  - action: \"calling `create_worker_impl_folder()` without checking `worker_impl_folder_exists()` first\"\n    warning: \"Both submit paths use LBYL: `if worker_impl_folder_exists(): remove_worker_impl_folder()` before creating. Stale .worker-impl/ from a prior failed submission causes errors.\"\n---\n\n# Impl-Context Staging Directory\n\n`.erk/impl-context/` is a temporary staging directory used during draft-PR plan saving. It exists on the plan branch between plan creation and the start of implementation, then gets cleaned up.\n\n## Lifecycle\n\n### Creation\n\nDuring `plan_save.py`, after creating the plan branch, the script:\n\n1. Checks out the plan branch\n2. Creates `.erk/impl-context/` and writes `plan.md` (plan content) and `ref.json` (plan reference metadata)\n3. Stages and commits both files\n4. Pushes to remote\n5. Checks out the original branch\n\nThis commit gives the draft PR a non-empty diff (GitHub rejects PRs with no file changes) and enables inline plan review via the \"Files Changed\" tab.\n\nSee: `src/erk/cli/commands/exec/scripts/plan_save.py:163-182`\n\n### Cleanup\n\nThe directory is cleaned up before implementation begins via a two-phase deferred cleanup pattern. All five setup paths converge at **Step 2d** in `plan-implement.md`, which is the single cleanup point:\n\n1. **`setup_impl_from_issue.py`** (Phase 1, read-only) — Reads `plan.md` and `ref.json`, copies content into `.impl/`, but deliberately does NOT delete the directory. See comment at `src/erk/cli/commands/exec/scripts/setup_impl_from_issue.py:202`: \"Do not delete here — Step 2d in plan-implement.md handles git rm + commit + push\"\n\n2. **`plan-implement.md` Step 2d** (Phase 2, git cleanup — convergence point) — All five setup paths (ISSUE_ARG, FILE_ARG, existing `.impl/` with issue tracking, existing `.impl/` without issue tracking, fallback plan-save) reach this step. Performs the actual deletion with `git rm -rf .erk/impl-context/ && git commit && git push`. This deferred approach ensures removal is committed, not just deleted from the local filesystem. The step is **idempotent** — safe to run even when the directory doesn't exist.\n\n3. **`plan-implement.yml` CI workflow** — Cleans up before the implementation agent runs, as a safety net for remote execution.\n\n### Why It Could Leak (Historical)\n\nPrior to PR #7747 (#7752), cleanup was not guaranteed across all setup paths — if a path bypassed Step 2d, the files would persist on the branch and appear in the final PR diff. This has been fixed: all paths now converge at Step 2d.\n\nThe key failure mode was confusing \"delete from disk\" (shutil.rmtree) with \"remove from git tracking\" (git rm + commit + push). When adding a new setup path, always route through the Step 2d convergence point — skipping it silently bypasses cleanup.\n\n## Prevention Strategies\n\n### Worker-Impl Cleanup\n\nBoth submit paths use the LBYL pattern to clean up stale `.worker-impl/` before creating a new one:\n\n<!-- Source: src/erk/cli/commands/submit.py, worker_impl_folder_exists -->\n\nSee the `worker_impl_folder_exists()` / `remove_worker_impl_folder()` LBYL guard in `src/erk/cli/commands/submit.py`. Both submit paths use this pattern to prevent errors from a prior failed submission leaving a stale `.worker-impl/` directory behind (fixed in PR #7687).\n\n### Deferred Impl-Context Deletion\n\n`setup_impl_from_issue.py:202` reads the impl-context files but deliberately does NOT delete them. The comment is explicit:\n\n> \"Do not delete here — Step 2d in plan-implement.md handles git rm + commit + push\"\n\nThis deferred pattern exists because filesystem deletion (`shutil.rmtree`) only removes the local copy. The files remain in git tracking and appear in the PR diff. Only `git rm` + commit + push removes them from the branch history.\n\n## Related Documentation\n\n- [Draft PR Plan Backend](draft-pr-plan-backend.md) — Backend that uses impl-context\n- [Draft PR Lifecycle](draft-pr-lifecycle.md) — Full lifecycle of draft-PR plans\n- [Draft PR Branch Sync](draft-pr-branch-sync.md) — Branch sync before implementation\n","structuredPatch":[{"oldStart":16,"oldLines":6,"newStart":16,"newLines":9,"lines":["     score: 9","   - action: \"calling `create_worker_impl_folder()` without checking `worker_impl_folder_exists()` first\"","     warning: \"Both submit paths use LBYL: `if worker_impl_folder_exists(): remove_worker_impl_folder()` before creating. Stale .worker-impl/ from a prior failed submission causes errors.\"","+  - action: \"pushing implementation commits after impl-context cleanup without git pull --rebase\"","+    warning: \"After git rm + commit + push of .erk/impl-context/, the local branch may diverge from remote if other commits were pushed. Run git pull --rebase before pushing further implementation commits to avoid non-fast-forward push failures.\"","+    score: 4"," ---"," "," # Impl-Context Staging Directory"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"305f86df-c3c4-45a5-ae81-4addff8135c8","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01TpxvrCn4WCF3aCvfNAmnYq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015TFEsTNdV1wC2eFkEwuBkM","name":"TodoWrite","input":{"todos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"completed","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"completed","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"completed","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"in_progress","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":756,"cache_read_input_tokens":106661,"cache_creation":{"ephemeral_5m_input_tokens":756,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN546sgQJVYkRYvfQChu","type":"assistant","uuid":"04a8ab34-e683-45fa-bf79-d47dfa31221c","timestamp":"2026-02-21T23:19:55.552Z"}
{"parentUuid":"04a8ab34-e683-45fa-bf79-d47dfa31221c","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015TFEsTNdV1wC2eFkEwuBkM","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"0a15b9b8-4198-485c-aa62-d24dacd4a21d","timestamp":"2026-02-21T23:19:55.566Z","toolUseResult":{"oldTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"completed","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"completed","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"in_progress","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"pending","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}],"newTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"completed","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"completed","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"completed","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"in_progress","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]}}
{"parentUuid":"0a15b9b8-4198-485c-aa62-d24dacd4a21d","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01WRnvqSwCJR7HKHiti4DeXe","type":"message","role":"assistant","content":[{"type":"text","text":"## Step 9: Add tripwire to ci source doc\n\nI need to add a \"git rebase modify/delete conflict resolution\" tripwire. Let me find the right source doc - perhaps the rebase conflict patterns doc:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":565,"cache_read_input_tokens":107417,"cache_creation":{"ephemeral_5m_input_tokens":565,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN54XNKpxbVAdsFKrQDe","type":"assistant","uuid":"a7811f1f-faf7-4694-a900-8848823b45f4","timestamp":"2026-02-21T23:19:58.880Z"}
{"parentUuid":"a7811f1f-faf7-4694-a900-8848823b45f4","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01WRnvqSwCJR7HKHiti4DeXe","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TBdSRYRC5d41VaCAp8jNGC","name":"Glob","input":{"pattern":"docs/learned/ci/rebase*.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":565,"cache_read_input_tokens":107417,"cache_creation":{"ephemeral_5m_input_tokens":565,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN54XNKpxbVAdsFKrQDe","type":"assistant","uuid":"61151cdd-e718-4d2b-b3aa-428f1b71bae3","timestamp":"2026-02-21T23:19:59.460Z"}
{"parentUuid":"61151cdd-e718-4d2b-b3aa-428f1b71bae3","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01WRnvqSwCJR7HKHiti4DeXe","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012aMqWeB6QfyVshxQch7X5u","name":"Glob","input":{"pattern":"docs/learned/**/rebase-conflict*.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":565,"cache_read_input_tokens":107417,"cache_creation":{"ephemeral_5m_input_tokens":565,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN54XNKpxbVAdsFKrQDe","type":"assistant","uuid":"f0289d35-a88b-4bae-9e12-390c94c39df3","timestamp":"2026-02-21T23:19:59.741Z"}
{"parentUuid":"f0289d35-a88b-4bae-9e12-390c94c39df3","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012aMqWeB6QfyVshxQch7X5u","type":"tool_result","content":"/home/runner/work/erk/erk/docs/learned/architecture/rebase-conflict-patterns.md\n/home/runner/work/erk/erk/docs/learned/testing/rebase-conflicts.md"}]},"uuid":"25be869c-d2b3-4834-b10d-20e92da6495b","timestamp":"2026-02-21T23:20:00.306Z","toolUseResult":{"filenames":["/home/runner/work/erk/erk/docs/learned/architecture/rebase-conflict-patterns.md","/home/runner/work/erk/erk/docs/learned/testing/rebase-conflicts.md"],"durationMs":543,"numFiles":2,"truncated":false}}
{"parentUuid":"25be869c-d2b3-4834-b10d-20e92da6495b","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TBdSRYRC5d41VaCAp8jNGC","type":"tool_result","content":"No files found"}]},"uuid":"b8af7c99-cae7-48f3-956f-e56935663681","timestamp":"2026-02-21T23:20:00.323Z","toolUseResult":{"filenames":[],"durationMs":561,"numFiles":0,"truncated":false}}
{"parentUuid":"b8af7c99-cae7-48f3-956f-e56935663681","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01GYafeHDWV7ayMqbTDsHehC","type":"message","role":"assistant","content":[{"type":"text","text":"The plan says to add to `ci/tripwires.md`, but since that's auto-generated, the tripwire about git rebase modify/delete conflict resolution should go in a CI source doc. Let me check what CI docs exist that could house this:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":83,"cache_creation_input_tokens":190,"cache_read_input_tokens":107982,"cache_creation":{"ephemeral_5m_input_tokens":190,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN54strFA3kfwZoRxShs","type":"assistant","uuid":"c86a9615-4e04-4ea0-b745-31964bca5a69","timestamp":"2026-02-21T23:20:03.694Z"}
{"parentUuid":"c86a9615-4e04-4ea0-b745-31964bca5a69","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01GYafeHDWV7ayMqbTDsHehC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CMwLGtHUXnimivWiRARBbS","name":"Glob","input":{"pattern":"docs/learned/ci/plan-implement*.md"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":83,"cache_creation_input_tokens":190,"cache_read_input_tokens":107982,"cache_creation":{"ephemeral_5m_input_tokens":190,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN54strFA3kfwZoRxShs","type":"assistant","uuid":"3f421e33-b0f5-44c7-883c-19678130a596","timestamp":"2026-02-21T23:20:04.183Z"}
{"parentUuid":"3f421e33-b0f5-44c7-883c-19678130a596","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CMwLGtHUXnimivWiRARBbS","type":"tool_result","content":"/home/runner/work/erk/erk/docs/learned/ci/plan-implement-customization.md\n/home/runner/work/erk/erk/docs/learned/ci/plan-implement-change-detection.md\n/home/runner/work/erk/erk/docs/learned/ci/plan-implement-workflow-patterns.md"}]},"uuid":"ba442180-cce4-450f-8c3d-3264f440d0b7","timestamp":"2026-02-21T23:20:04.678Z","toolUseResult":{"filenames":["/home/runner/work/erk/erk/docs/learned/ci/plan-implement-customization.md","/home/runner/work/erk/erk/docs/learned/ci/plan-implement-change-detection.md","/home/runner/work/erk/erk/docs/learned/ci/plan-implement-workflow-patterns.md"],"durationMs":478,"numFiles":3,"truncated":false}}
{"parentUuid":"ba442180-cce4-450f-8c3d-3264f440d0b7","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01F1f9FsG6xudFrFVSzV72BB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013XXpTKb8KU2u38Svn5whrV","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/ci/plan-implement-workflow-patterns.md","limit":20},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":297,"cache_read_input_tokens":108172,"cache_creation":{"ephemeral_5m_input_tokens":297,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN55CJPFw13GTn7ET69g","type":"assistant","uuid":"a7be7611-8ebb-4872-9bc6-1c4f9c0dc2a0","timestamp":"2026-02-21T23:20:07.386Z"}
{"parentUuid":"a7be7611-8ebb-4872-9bc6-1c4f9c0dc2a0","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013XXpTKb8KU2u38Svn5whrV","type":"tool_result","content":"     1→---\n     2→title: erk-impl Workflow Patterns\n     3→read_when:\n     4→  - \"modifying erk-impl workflow\"\n     5→  - \"adding cleanup steps to GitHub Actions\"\n     6→  - \"working with git reset in workflows\"\n     7→tripwires:\n     8→  - action: \"running `git reset --hard` in workflows after staging cleanup\"\n     9→    warning: \"Verify all cleanup changes are committed BEFORE reset; staged changes without commit will be silently discarded.\"\n    10→last_audited: \"2026-02-17 16:00 PT\"\n    11→audit_result: clean\n    12→---\n    13→\n    14→# erk-impl Workflow Patterns\n    15→\n    16→This document covers critical patterns for the erk-impl GitHub Actions workflow, with particular focus on cleanup operations and step ordering.\n    17→\n    18→## Critical: Cleanup Before Reset\n    19→\n    20→**The Most Important Rule:** Commit cleanup changes BEFORE any `git reset --hard` operation.\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"86daf756-1692-4715-b9e6-58bd1f5c7094","timestamp":"2026-02-21T23:20:07.411Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/docs/learned/ci/plan-implement-workflow-patterns.md","content":"---\ntitle: erk-impl Workflow Patterns\nread_when:\n  - \"modifying erk-impl workflow\"\n  - \"adding cleanup steps to GitHub Actions\"\n  - \"working with git reset in workflows\"\ntripwires:\n  - action: \"running `git reset --hard` in workflows after staging cleanup\"\n    warning: \"Verify all cleanup changes are committed BEFORE reset; staged changes without commit will be silently discarded.\"\nlast_audited: \"2026-02-17 16:00 PT\"\naudit_result: clean\n---\n\n# erk-impl Workflow Patterns\n\nThis document covers critical patterns for the erk-impl GitHub Actions workflow, with particular focus on cleanup operations and step ordering.\n\n## Critical: Cleanup Before Reset\n\n**The Most Important Rule:** Commit cleanup changes BEFORE any `git reset --hard` operation.","numLines":20,"startLine":1,"totalLines":126}}}
{"parentUuid":"86daf756-1692-4715-b9e6-58bd1f5c7094","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01AAm881yAdXGW6CLx7KW8iA","type":"message","role":"assistant","content":[{"type":"text","text":"This doc is about workflow patterns including conflict handling. Let me add the rebase tripwire here:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":781,"cache_read_input_tokens":108469,"cache_creation":{"ephemeral_5m_input_tokens":781,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN55Q16KFcKwoVt4EEyK","type":"assistant","uuid":"543eab74-c093-453a-987c-413d783bc013","timestamp":"2026-02-21T23:20:10.036Z"}
{"parentUuid":"543eab74-c093-453a-987c-413d783bc013","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01AAm881yAdXGW6CLx7KW8iA","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NgcH7Akvmbyudet2eXEaWk","name":"Edit","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/ci/plan-implement-workflow-patterns.md","old_string":"tripwires:\n  - action: \"running `git reset --hard` in workflows after staging cleanup\"\n    warning: \"Verify all cleanup changes are committed BEFORE reset; staged changes without commit will be silently discarded.\"","new_string":"tripwires:\n  - action: \"running `git reset --hard` in workflows after staging cleanup\"\n    warning: \"Verify all cleanup changes are committed BEFORE reset; staged changes without commit will be silently discarded.\"\n  - action: \"resolving git rebase modify/delete conflicts using merge-style terminology\"\n    warning: \"In rebase, 'them' = upstream (opposite to merge). For modify/delete conflicts where the file was deleted upstream, use `git rm <file>` on the conflicted staged files, then `git rebase --continue`. Do not use `git checkout --theirs` which has inverted semantics during rebase.\"\n    score: 5"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":781,"cache_read_input_tokens":108469,"cache_creation":{"ephemeral_5m_input_tokens":781,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN55Q16KFcKwoVt4EEyK","type":"assistant","uuid":"b3ec88bb-78a1-4b28-b4ce-f33e0e83318b","timestamp":"2026-02-21T23:20:14.554Z"}
{"parentUuid":"b3ec88bb-78a1-4b28-b4ce-f33e0e83318b","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NgcH7Akvmbyudet2eXEaWk","type":"tool_result","content":"The file /home/runner/work/erk/erk/docs/learned/ci/plan-implement-workflow-patterns.md has been updated successfully."}]},"uuid":"7746c642-7e42-43ea-adaa-f0ad70486b0f","timestamp":"2026-02-21T23:20:15.283Z","toolUseResult":{"filePath":"/home/runner/work/erk/erk/docs/learned/ci/plan-implement-workflow-patterns.md","oldString":"tripwires:\n  - action: \"running `git reset --hard` in workflows after staging cleanup\"\n    warning: \"Verify all cleanup changes are committed BEFORE reset; staged changes without commit will be silently discarded.\"","newString":"tripwires:\n  - action: \"running `git reset --hard` in workflows after staging cleanup\"\n    warning: \"Verify all cleanup changes are committed BEFORE reset; staged changes without commit will be silently discarded.\"\n  - action: \"resolving git rebase modify/delete conflicts using merge-style terminology\"\n    warning: \"In rebase, 'them' = upstream (opposite to merge). For modify/delete conflicts where the file was deleted upstream, use `git rm <file>` on the conflicted staged files, then `git rebase --continue`. Do not use `git checkout --theirs` which has inverted semantics during rebase.\"\n    score: 5","originalFile":"---\ntitle: erk-impl Workflow Patterns\nread_when:\n  - \"modifying erk-impl workflow\"\n  - \"adding cleanup steps to GitHub Actions\"\n  - \"working with git reset in workflows\"\ntripwires:\n  - action: \"running `git reset --hard` in workflows after staging cleanup\"\n    warning: \"Verify all cleanup changes are committed BEFORE reset; staged changes without commit will be silently discarded.\"\nlast_audited: \"2026-02-17 16:00 PT\"\naudit_result: clean\n---\n\n# erk-impl Workflow Patterns\n\nThis document covers critical patterns for the erk-impl GitHub Actions workflow, with particular focus on cleanup operations and step ordering.\n\n## Critical: Cleanup Before Reset\n\n**The Most Important Rule:** Commit cleanup changes BEFORE any `git reset --hard` operation.\n\n### Why This Matters\n\n`git reset --hard` discards all staged but uncommitted changes. In the erk-impl workflow, this manifests as:\n\n1. Workflow stages `.worker-impl/` deletion with `git add`\n2. Later step runs `git reset --hard` (e.g., for conflict resolution)\n3. The staged deletion is silently discarded\n4. `.worker-impl/` artifacts appear in the final PR\n\n### Correct Pattern\n\n```yaml\n# 1. First: Commit and push cleanup\n- name: Clean up .worker-impl/\n  run: |\n    if [ -d .worker-impl/ ]; then\n      git rm -rf .worker-impl/\n      git commit -m \"Remove .worker-impl/ after implementation\"\n      git push\n    fi\n\n# 2. Then: Any operations that might reset\n- name: Sync with remote\n  run: |\n    git fetch origin\n    git reset --hard origin/$BRANCH  # Safe now - cleanup already pushed\n```\n\n### Incorrect Pattern (Silent Failure)\n\n```yaml\n# WRONG: Staging without commit before reset\n- name: Stage cleanup\n  run: git rm -rf .worker-impl/ && git add -A\n\n- name: Sync with remote\n  run: git reset --hard origin/$BRANCH # Discards the staged cleanup!\n```\n\n## Multi-Layer Cleanup Resilience\n\nThe erk-impl workflow uses multiple cleanup mechanisms for reliability:\n\n| Layer               | Mechanism                    | Reliability       |\n| ------------------- | ---------------------------- | ----------------- |\n| 1. Agent cleanup    | Claude's /erk:plan-implement | Non-deterministic |\n| 2. Workflow staging | `git rm` + `git add`         | Fragile           |\n| 3. Workflow commit  | Dedicated cleanup step       | Deterministic     |\n\n**Lesson learned:** Only layer 3 (dedicated commit step) is reliable. Agent behavior varies based on context limits and interpretation. Staging without commit is fragile due to reset interactions.\n\n## Step Output Validation\n\nWhen composing conditions across multiple workflow steps, validate each reference:\n\n### Common Validation Errors\n\n1. **Typos in step IDs**: `steps.implentation.outcome` vs `steps.implementation.outcome`\n2. **Missing step IDs**: Step doesn't have an `id:` field\n3. **Wrong output key**: `steps.foo.outputs.result` when step outputs `outcome`\n\n### Validation Checklist\n\nBefore using a compound condition:\n\n- [ ] Each step referenced has an `id:` field\n- [ ] Step ID spelling matches exactly (case-sensitive)\n- [ ] Output key exists (use `steps.*.outcome` for job status)\n- [ ] Condition logic handles all states (success/failure/skipped)\n\n### Example: Correct Step Reference\n\n```yaml\n- name: Run implementation\n  id: impl\n  run: |\n    # ... implementation logic\n    echo \"has_changes=true\" >> $GITHUB_OUTPUT\n\n- name: Handle results\n  if: steps.impl.outcome == 'success' && steps.impl.outputs.has_changes == 'true'\n  run: |\n    # Only runs when impl succeeded AND has changes\n```\n\n## Workflow Step Ordering\n\nCritical ordering dependencies in erk-impl:\n\n```\n1. Checkout & setup\n2. Find/create PR\n3. Implementation (Claude)\n4. Commit implementation changes  ← Must happen before cleanup\n5. Clean up .worker-impl/         ← Must commit before any reset\n6. Push changes\n7. Mark PR ready\n```\n\n**Key insight:** Steps 4-6 must maintain this exact order. Interleaving cleanup with implementation commits causes silent failures.\n\n## Related Documentation\n\n- [GitHub Actions Output Patterns](github-actions-output-patterns.md) - Multi-line outputs and step communication\n","structuredPatch":[{"oldStart":7,"oldLines":6,"newStart":7,"newLines":9,"lines":[" tripwires:","   - action: \"running `git reset --hard` in workflows after staging cleanup\"","     warning: \"Verify all cleanup changes are committed BEFORE reset; staged changes without commit will be silently discarded.\"","+  - action: \"resolving git rebase modify/delete conflicts using merge-style terminology\"","+    warning: \"In rebase, 'them' = upstream (opposite to merge). For modify/delete conflicts where the file was deleted upstream, use `git rm <file>` on the conflicted staged files, then `git rebase --continue`. Do not use `git checkout --theirs` which has inverted semantics during rebase.\"","+    score: 5"," last_audited: \"2026-02-17 16:00 PT\""," audit_result: clean"," ---"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"7746c642-7e42-43ea-adaa-f0ad70486b0f","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01C3QQ46D9Cisx1DUMZNpUFj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018AMyXEYL1orKnhJWemhs3p","name":"TodoWrite","input":{"todos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"completed","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"completed","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"completed","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"completed","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"in_progress","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":386,"cache_read_input_tokens":109250,"cache_creation":{"ephemeral_5m_input_tokens":386,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN55yef8KDjxvfT4v1Qh","type":"assistant","uuid":"c5f14063-9d67-439a-a253-750f4b7851a9","timestamp":"2026-02-21T23:20:20.872Z"}
{"parentUuid":"c5f14063-9d67-439a-a253-750f4b7851a9","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018AMyXEYL1orKnhJWemhs3p","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"24491cc4-b9d8-4627-b4b6-032dcdda5f8c","timestamp":"2026-02-21T23:20:20.888Z","toolUseResult":{"oldTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"completed","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"completed","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"completed","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"in_progress","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"pending","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}],"newTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"completed","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"completed","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"completed","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"completed","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"in_progress","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]}}
{"parentUuid":"24491cc4-b9d8-4627-b4b6-032dcdda5f8c","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01BRKhwtWMtUwhsQiPKoxxJ5","type":"message","role":"assistant","content":[{"type":"text","text":"## Step 10: Add tripwire to erk source doc\n\nI need to add: \"Graphite cache mismatch after raw git\" (score 7). Let me check if `graphite-divergence-detection.md` or `graphite-stack-troubleshooting.md` exists:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":565,"cache_read_input_tokens":109636,"cache_creation":{"ephemeral_5m_input_tokens":565,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN56PdnwRAa2VjYsUxo5","type":"assistant","uuid":"46a0e773-5d34-405d-93d3-9727bdca2069","timestamp":"2026-02-21T23:20:24.430Z"}
{"parentUuid":"46a0e773-5d34-405d-93d3-9727bdca2069","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01BRKhwtWMtUwhsQiPKoxxJ5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XudZa5a8GBgipnjmdX6B1A","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/erk/graphite-divergence-detection.md","limit":20},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":565,"cache_read_input_tokens":109636,"cache_creation":{"ephemeral_5m_input_tokens":565,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN56PdnwRAa2VjYsUxo5","type":"assistant","uuid":"e714d54c-2daa-4f88-8e75-2e41b52fcc91","timestamp":"2026-02-21T23:20:25.026Z"}
{"parentUuid":"e714d54c-2daa-4f88-8e75-2e41b52fcc91","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XudZa5a8GBgipnjmdX6B1A","type":"tool_result","content":"     1→---\n     2→title: Graphite Divergence Detection\n     3→read_when:\n     4→  - \"debugging remote divergence errors during erk pr submit\"\n     5→  - \"understanding the Graphite-first submit flow's pre-checks\"\n     6→  - \"resolving 'branch is behind remote' errors\"\n     7→  - \"using --force flag with erk pr submit\"\n     8→tripwires:\n     9→  - action: \"running gt commands without --no-interactive\"\n    10→    warning: \"All gt commands MUST use --no-interactive. Without it, gt may prompt for input and hang indefinitely.\"\n    11→  - action: \"pushing to a branch that may have been updated remotely without checking for divergence\"\n    12→    warning: \"The Graphite-first flow pre-checks for divergence before gt submit. Check with branch_exists_on_remote -> fetch_branch -> is_branch_diverged_from_remote.\"\n    13→---\n    14→\n    15→# Graphite Divergence Detection\n    16→\n    17→The Graphite-first submit flow includes proactive divergence detection before running `gt submit`. This prevents cryptic failures when the remote branch has been updated by CI, another session, or a prior submission.\n    18→\n    19→## Guard Chain\n    20→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"d93a7cd8-5167-4b55-b714-d19fe5f1b264","timestamp":"2026-02-21T23:20:25.111Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/docs/learned/erk/graphite-divergence-detection.md","content":"---\ntitle: Graphite Divergence Detection\nread_when:\n  - \"debugging remote divergence errors during erk pr submit\"\n  - \"understanding the Graphite-first submit flow's pre-checks\"\n  - \"resolving 'branch is behind remote' errors\"\n  - \"using --force flag with erk pr submit\"\ntripwires:\n  - action: \"running gt commands without --no-interactive\"\n    warning: \"All gt commands MUST use --no-interactive. Without it, gt may prompt for input and hang indefinitely.\"\n  - action: \"pushing to a branch that may have been updated remotely without checking for divergence\"\n    warning: \"The Graphite-first flow pre-checks for divergence before gt submit. Check with branch_exists_on_remote -> fetch_branch -> is_branch_diverged_from_remote.\"\n---\n\n# Graphite Divergence Detection\n\nThe Graphite-first submit flow includes proactive divergence detection before running `gt submit`. This prevents cryptic failures when the remote branch has been updated by CI, another session, or a prior submission.\n\n## Guard Chain\n","numLines":20,"startLine":1,"totalLines":70}}}
{"parentUuid":"d93a7cd8-5167-4b55-b714-d19fe5f1b264","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_012s15B5uYYQNwUCSNH68Dr5","type":"message","role":"assistant","content":[{"type":"text","text":"This is a good home for the Graphite cache mismatch tripwire:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":579,"cache_read_input_tokens":110201,"cache_creation":{"ephemeral_5m_input_tokens":579,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN56hgVeUhewGmhVEq2j","type":"assistant","uuid":"c2c66ecc-41ef-4078-9f1d-a6a9bffa50d2","timestamp":"2026-02-21T23:20:28.027Z"}
{"parentUuid":"c2c66ecc-41ef-4078-9f1d-a6a9bffa50d2","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_012s15B5uYYQNwUCSNH68Dr5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AdksVUwNsRZxaiUzW9aoSo","name":"Edit","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/erk/graphite-divergence-detection.md","old_string":"  - action: \"pushing to a branch that may have been updated remotely without checking for divergence\"\n    warning: \"The Graphite-first flow pre-checks for divergence before gt submit. Check with branch_exists_on_remote -> fetch_branch -> is_branch_diverged_from_remote.\"","new_string":"  - action: \"pushing to a branch that may have been updated remotely without checking for divergence\"\n    warning: \"The Graphite-first flow pre-checks for divergence before gt submit. Check with branch_exists_on_remote -> fetch_branch -> is_branch_diverged_from_remote.\"\n  - action: \"running raw git commands (checkout, branch) without gt track on a Graphite-managed branch\"\n    warning: \"Raw git commands (checkout, branch) without `gt track` cause Graphite's cache to diverge from actual branch state. Use BranchManager which handles Graphite tracking automatically, or call `gt track` after raw git operations.\"\n    score: 7"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":579,"cache_read_input_tokens":110201,"cache_creation":{"ephemeral_5m_input_tokens":579,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN56hgVeUhewGmhVEq2j","type":"assistant","uuid":"158251cc-7402-4bf0-acb7-54f7a3a69dfd","timestamp":"2026-02-21T23:20:32.545Z"}
{"parentUuid":"158251cc-7402-4bf0-acb7-54f7a3a69dfd","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AdksVUwNsRZxaiUzW9aoSo","type":"tool_result","content":"The file /home/runner/work/erk/erk/docs/learned/erk/graphite-divergence-detection.md has been updated successfully."}]},"uuid":"ec5512df-2389-4546-90b7-22d52901475a","timestamp":"2026-02-21T23:20:33.290Z","toolUseResult":{"filePath":"/home/runner/work/erk/erk/docs/learned/erk/graphite-divergence-detection.md","oldString":"  - action: \"pushing to a branch that may have been updated remotely without checking for divergence\"\n    warning: \"The Graphite-first flow pre-checks for divergence before gt submit. Check with branch_exists_on_remote -> fetch_branch -> is_branch_diverged_from_remote.\"","newString":"  - action: \"pushing to a branch that may have been updated remotely without checking for divergence\"\n    warning: \"The Graphite-first flow pre-checks for divergence before gt submit. Check with branch_exists_on_remote -> fetch_branch -> is_branch_diverged_from_remote.\"\n  - action: \"running raw git commands (checkout, branch) without gt track on a Graphite-managed branch\"\n    warning: \"Raw git commands (checkout, branch) without `gt track` cause Graphite's cache to diverge from actual branch state. Use BranchManager which handles Graphite tracking automatically, or call `gt track` after raw git operations.\"\n    score: 7","originalFile":"---\ntitle: Graphite Divergence Detection\nread_when:\n  - \"debugging remote divergence errors during erk pr submit\"\n  - \"understanding the Graphite-first submit flow's pre-checks\"\n  - \"resolving 'branch is behind remote' errors\"\n  - \"using --force flag with erk pr submit\"\ntripwires:\n  - action: \"running gt commands without --no-interactive\"\n    warning: \"All gt commands MUST use --no-interactive. Without it, gt may prompt for input and hang indefinitely.\"\n  - action: \"pushing to a branch that may have been updated remotely without checking for divergence\"\n    warning: \"The Graphite-first flow pre-checks for divergence before gt submit. Check with branch_exists_on_remote -> fetch_branch -> is_branch_diverged_from_remote.\"\n---\n\n# Graphite Divergence Detection\n\nThe Graphite-first submit flow includes proactive divergence detection before running `gt submit`. This prevents cryptic failures when the remote branch has been updated by CI, another session, or a prior submission.\n\n## Guard Chain\n\n<!-- Source: src/erk/cli/commands/pr/submit_pipeline.py:200-230 -->\n\nThe `_graphite_first_flow()` function in `submit_pipeline.py` runs a four-step guard chain before `gt submit`:\n\n```\nbranch_exists_on_remote() → fetch_branch() → is_branch_diverged_from_remote() → check behind > 0\n```\n\n1. **`branch_exists_on_remote()`**: Skip divergence check entirely for new branches (no remote to diverge from)\n2. **`fetch_branch()`**: Fetch the remote branch so local git knows the remote state\n3. **`is_branch_diverged_from_remote()`**: Returns a divergence object with `ahead` and `behind` counts\n4. **Check `behind > 0`**: If the local branch is behind remote AND `effective_force` is `False`, return a `SubmitError` with `error_type=\"remote_diverged\"`. Note: `effective_force = state.force or is_plan_impl`, so plan implementations (`state.issue_number is not None`) auto-force and never hit this guard — it only applies to non-plan `erk pr submit` invocations.\n\n## Core vs Graphite-First Difference\n\n| Aspect           | Core flow            | Graphite-first flow         |\n| ---------------- | -------------------- | --------------------------- |\n| Divergence check | None (auto-rebases)  | Pre-checks and blocks       |\n| Push mechanism   | `git push`           | `gt submit`                 |\n| On divergence    | Rebase automatically | Error with resolution steps |\n\nThe core flow can auto-rebase because it controls the push directly. The Graphite-first flow delegates pushing to `gt submit`, which may behave unpredictably with diverged branches, so it pre-checks and blocks.\n\n## Resolution Steps\n\nWhen divergence is detected, the error message suggests two options:\n\n1. **`erk pr sync-divergence --dangerous`**: Fetch, rebase onto remote, resolve any conflicts\n2. **`erk pr submit -f`**: Force push, overriding whatever is on remote\n\n## Graphite Tracking Divergence After Setup\n\nA separate divergence scenario occurs when Graphite's internal tracking gets out of sync (e.g., after branch setup or manual git operations). Resolution:\n\n```bash\ngt track --no-interactive && gt restack --no-interactive && git push --force-with-lease\n```\n\nThe `--no-interactive` flag is required on all `gt` commands to prevent hanging on prompts.\n\n## The --force Escape Hatch\n\nWhen `state.force` is `True` (from `erk pr submit -f`), the divergence check is bypassed entirely. The guard chain still runs `fetch_branch()` but skips the error return when `behind > 0`. This allows force-pushing over remote changes when the user explicitly opts in.\n\n## Related Topics\n\n- [Draft PR Branch Sync](../planning/draft-pr-branch-sync.md) - Branch sync before implementation\n- [Graphite Stack Troubleshooting](graphite-stack-troubleshooting.md) - General Graphite troubleshooting\n- [Draft PR Handling — Troubleshooting](../pr-operations/draft-pr-handling.md#troubleshooting-common-failures) - Related failure modes\n","structuredPatch":[{"oldStart":10,"oldLines":6,"newStart":10,"newLines":9,"lines":["     warning: \"All gt commands MUST use --no-interactive. Without it, gt may prompt for input and hang indefinitely.\"","   - action: \"pushing to a branch that may have been updated remotely without checking for divergence\"","     warning: \"The Graphite-first flow pre-checks for divergence before gt submit. Check with branch_exists_on_remote -> fetch_branch -> is_branch_diverged_from_remote.\"","+  - action: \"running raw git commands (checkout, branch) without gt track on a Graphite-managed branch\"","+    warning: \"Raw git commands (checkout, branch) without `gt track` cause Graphite's cache to diverge from actual branch state. Use BranchManager which handles Graphite tracking automatically, or call `gt track` after raw git operations.\"","+    score: 7"," ---"," "," # Graphite Divergence Detection"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"ec5512df-2389-4546-90b7-22d52901475a","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_014ZnjfPMPtFWjCEVP51Jdz9","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HCNUnqbMGQK8FX5xp9mf5w","name":"TodoWrite","input":{"todos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"completed","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"completed","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"completed","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"completed","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"completed","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"in_progress","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":410,"cache_read_input_tokens":110780,"cache_creation":{"ephemeral_5m_input_tokens":410,"ephemeral_1h_input_tokens":0},"output_tokens":19,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN57JeBdJK7jTJvTz4zA","type":"assistant","uuid":"22689a73-79dc-482e-9a32-f0ff9ba824ba","timestamp":"2026-02-21T23:20:39.113Z"}
{"parentUuid":"22689a73-79dc-482e-9a32-f0ff9ba824ba","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HCNUnqbMGQK8FX5xp9mf5w","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"fcd829b0-d13a-4b4d-b215-19ac881fa8ec","timestamp":"2026-02-21T23:20:39.129Z","toolUseResult":{"oldTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"completed","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"completed","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"completed","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"completed","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"in_progress","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"pending","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}],"newTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"completed","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"completed","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"completed","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"completed","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"completed","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"in_progress","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}]}}
{"parentUuid":"fcd829b0-d13a-4b4d-b215-19ac881fa8ec","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_014DuJ7Xs7KSvDPgYkHUky5i","type":"message","role":"assistant","content":[{"type":"text","text":"## Run erk docs sync"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":565,"cache_read_input_tokens":111190,"cache_creation":{"ephemeral_5m_input_tokens":565,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN57je6hthNpQoKtjZdo","type":"assistant","uuid":"9441b98c-c0a1-4a01-8f37-8e58b29e3bb0","timestamp":"2026-02-21T23:20:41.183Z"}
{"parentUuid":"9441b98c-c0a1-4a01-8f37-8e58b29e3bb0","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_014DuJ7Xs7KSvDPgYkHUky5i","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YYykiz9fLsLcPLniD8L55h","name":"Task","input":{"description":"Run erk docs sync","prompt":"Run `erk docs sync` in /home/runner/work/erk/erk and report the results. This regenerates auto-generated index and tripwire files from frontmatter.","subagent_type":"devrun"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":565,"cache_read_input_tokens":111190,"cache_creation":{"ephemeral_5m_input_tokens":565,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN57je6hthNpQoKtjZdo","type":"assistant","uuid":"17111b2e-9b30-4eca-9490-1c4a378c997a","timestamp":"2026-02-21T23:20:42.736Z"}
{"parentUuid":"17111b2e-9b30-4eca-9490-1c4a378c997a","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YYykiz9fLsLcPLniD8L55h","type":"tool_result","content":[{"type":"text","text":"erk docs sync passed: Successfully regenerated 9 auto-generated documentation files\n\n**Summary:**\n- Updated 9 files including category indexes, tripwire files, and the main tripwires index\n- 47 files remained unchanged\n- Collected 733 total tripwires across 33 categories\n- Notable changes:\n  - architecture/tripwires.md: 141 tripwires (25 with patterns)\n  - planning/tripwires.md: 114 tripwires\n  - testing/tripwires.md: 58 tripwires (5 with patterns)\n  - cli/tripwires.md: 66 tripwires\n  - erk/tripwires.md: 18 tripwires\n\nAll documentation indexes and tripwire files have been regenerated from frontmatter successfully."},{"type":"text","text":"agentId: aee5150 (for resuming to continue this agent's work if needed)"}]}]},"uuid":"0d3f3681-33b2-4455-be21-4a5b5f90fb45","timestamp":"2026-02-21T23:21:11.149Z","toolUseResult":{"status":"completed","prompt":"Run `erk docs sync` in /home/runner/work/erk/erk and report the results. This regenerates auto-generated index and tripwire files from frontmatter.","agentId":"aee5150","content":[{"type":"text","text":"erk docs sync passed: Successfully regenerated 9 auto-generated documentation files\n\n**Summary:**\n- Updated 9 files including category indexes, tripwire files, and the main tripwires index\n- 47 files remained unchanged\n- Collected 733 total tripwires across 33 categories\n- Notable changes:\n  - architecture/tripwires.md: 141 tripwires (25 with patterns)\n  - planning/tripwires.md: 114 tripwires\n  - testing/tripwires.md: 58 tripwires (5 with patterns)\n  - cli/tripwires.md: 66 tripwires\n  - erk/tripwires.md: 18 tripwires\n\nAll documentation indexes and tripwire files have been regenerated from frontmatter successfully."}],"totalDurationMs":28394,"totalTokens":13178,"totalToolUseCount":1,"usage":{"input_tokens":5,"cache_creation_input_tokens":733,"cache_read_input_tokens":12247,"cache_creation":{"ephemeral_5m_input_tokens":733,"ephemeral_1h_input_tokens":0},"output_tokens":193,"service_tier":"standard","inference_geo":"not_available"}}}
{"parentUuid":"0d3f3681-33b2-4455-be21-4a5b5f90fb45","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01J4cujuas8h37uGxtKZhmFs","type":"message","role":"assistant","content":[{"type":"text","text":"Good, the sync completed. Now let me verify no stale gist references remain:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":364,"cache_read_input_tokens":111755,"cache_creation":{"ephemeral_5m_input_tokens":364,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5A6X1evoyFtojCNqVQ","type":"assistant","uuid":"013659ce-a183-4665-a29d-80d11b117d9a","timestamp":"2026-02-21T23:21:14.167Z"}
{"parentUuid":"013659ce-a183-4665-a29d-80d11b117d9a","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01J4cujuas8h37uGxtKZhmFs","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GQHwqUsAbt1Lj4qXVCv9Hn","name":"Grep","input":{"pattern":"gist","path":"/home/runner/work/erk/erk/docs/learned/sessions","output_mode":"content","-n":true,"-i":true},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":364,"cache_read_input_tokens":111755,"cache_creation":{"ephemeral_5m_input_tokens":364,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5A6X1evoyFtojCNqVQ","type":"assistant","uuid":"d0bf7458-c5a2-4e28-8039-24e1e6d981a1","timestamp":"2026-02-21T23:21:15.427Z"}
{"parentUuid":"d0bf7458-c5a2-4e28-8039-24e1e6d981a1","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GQHwqUsAbt1Lj4qXVCv9Hn","type":"tool_result","content":"docs/learned/sessions/discovery-fallback.md:33:`list-sessions` knows nothing about plans — it scans the local Claude Code project directory and returns what's there. `get-learn-sessions` starts from a plan issue, extracts session IDs from GitHub metadata (plan-header fields and issue comments), then checks which ones are actually readable on disk. It also discovers remote sessions (gist-based or legacy artifact-based) that `list-sessions` would never find.\ndocs/learned/sessions/discovery-fallback.md:77:| 3        | Remote session (gist)     | `last_session_gist_url` in plan-header                                                  | Gist may have been deleted; requires download step                  |"}]},"uuid":"5fc4535a-4b59-440f-876b-2b7d695620be","timestamp":"2026-02-21T23:21:15.950Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"docs/learned/sessions/discovery-fallback.md:33:`list-sessions` knows nothing about plans — it scans the local Claude Code project directory and returns what's there. `get-learn-sessions` starts from a plan issue, extracts session IDs from GitHub metadata (plan-header fields and issue comments), then checks which ones are actually readable on disk. It also discovers remote sessions (gist-based or legacy artifact-based) that `list-sessions` would never find.\ndocs/learned/sessions/discovery-fallback.md:77:| 3        | Remote session (gist)     | `last_session_gist_url` in plan-header                                                  | Gist may have been deleted; requires download step                  |","numLines":2}}
{"parentUuid":"5fc4535a-4b59-440f-876b-2b7d695620be","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_016fogsugg1y8gasseUNAiSp","type":"message","role":"assistant","content":[{"type":"text","text":"There are still some gist references in `discovery-fallback.md` but these may be accurate if they describe the fallback hierarchy and historical context. Let me check what that doc says more broadly:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":340,"cache_read_input_tokens":112119,"cache_creation":{"ephemeral_5m_input_tokens":340,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5AT3J3a1E2FJWrXcqf","type":"assistant","uuid":"1a2afabb-8285-41f1-9776-d495e05c984a","timestamp":"2026-02-21T23:21:19.030Z"}
{"parentUuid":"1a2afabb-8285-41f1-9776-d495e05c984a","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_016fogsugg1y8gasseUNAiSp","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SpR7XpwQb4E99vCyCCumft","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/sessions/discovery-fallback.md","offset":30,"limit":55},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":340,"cache_read_input_tokens":112119,"cache_creation":{"ephemeral_5m_input_tokens":340,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5AT3J3a1E2FJWrXcqf","type":"assistant","uuid":"5558bb48-0007-4088-96a9-068faebc5a8a","timestamp":"2026-02-21T23:21:19.811Z"}
{"parentUuid":"5558bb48-0007-4088-96a9-068faebc5a8a","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SpR7XpwQb4E99vCyCCumft","type":"tool_result","content":"    30→\n    31→### Why two commands?\n    32→\n    33→`list-sessions` knows nothing about plans — it scans the local Claude Code project directory and returns what's there. `get-learn-sessions` starts from a plan issue, extracts session IDs from GitHub metadata (plan-header fields and issue comments), then checks which ones are actually readable on disk. It also discovers remote sessions (gist-based or legacy artifact-based) that `list-sessions` would never find.\n    34→\n    35→<!-- Source: packages/erk-shared/src/erk_shared/sessions/discovery.py, find_sessions_for_plan -->\n    36→\n    37→See `find_sessions_for_plan()` in `packages/erk-shared/src/erk_shared/sessions/discovery.py` for how plan-specific discovery extracts session IDs from multiple metadata sources (plan-header fields, impl-started/impl-ended comments, learn-invoked comments).\n    38→\n    39→## Output Schema (list-sessions)\n    40→\n    41→The `erk exec list-sessions` command returns a JSON object. Key structure:\n    42→\n    43→```json\n    44→{\n    45→  \"success\": true,\n    46→  \"branch_context\": {\n    47→    \"current_branch\": \"feature-xyz\",\n    48→    \"trunk_branch\": \"master\",\n    49→    \"is_on_trunk\": false\n    50→  },\n    51→  \"current_session_id\": \"abc123-def456\",\n    52→  \"sessions\": [\n    53→    {\n    54→      \"session_id\": \"abc123-def456\",\n    55→      \"mtime_display\": \"Feb 5, 10:30 AM\",\n    56→      \"mtime_relative\": \"2h ago\",\n    57→      \"mtime_unix\": 1738764600.0,\n    58→      \"size_bytes\": 157000,\n    59→      \"summary\": \"First 60 chars of first user message...\",\n    60→      \"is_current\": true,\n    61→      \"branch\": \"feature-xyz\",\n    62→      \"session_path\": \"/path/to/session.jsonl\"\n    63→    }\n    64→  ],\n    65→  \"filtered_count\": 3\n    66→}\n    67→```\n    68→\n    69→## Fallback Hierarchy for Learn Workflows\n    70→\n    71→When a learn workflow needs session data, the ideal source (planning session) is often unavailable because it was created in a different Claude Code session. The discovery system degrades through multiple levels rather than failing.\n    72→\n    73→| Priority | Source                    | How discovered                                                                          | Why it might be missing                                             |\n    74→| -------- | ------------------------- | --------------------------------------------------------------------------------------- | ------------------------------------------------------------------- |\n    75→| 1        | Planning session          | `created_from_session` in plan-header                                                   | Created in a prior Claude Code session, since cleaned up            |\n    76→| 2        | Implementation session    | `last_local_impl_session` in plan-header + issue comments                               | Same reason — different session lifecycle                           |\n    77→| 3        | Remote session (gist)     | `last_session_gist_url` in plan-header                                                  | Gist may have been deleted; requires download step                  |\n    78→| 4        | Remote session (artifact) | `last_remote_impl_run_id` in plan-header                                                | Legacy path; GitHub Actions artifacts expire after 90 days          |\n    79→| 5        | Local fallback scan       | `find_local_sessions_for_project()` scans project directory, filtered by current branch | No metadata link to plan, but recent sessions may still be relevant |\n    80→| 6        | Skip analysis             | Always available                                                                        | Produces no session insights, but workflow continues                |\n    81→\n    82→<!-- Source: src/erk/cli/commands/exec/scripts/get_learn_sessions.py, _discover_sessions -->\n    83→\n    84→The fallback logic is implemented in `_discover_sessions()` in `src/erk/cli/commands/exec/scripts/get_learn_sessions.py`. The critical design decision: local fallback scanning only triggers when **no** GitHub-tracked sessions are readable on disk, preventing noisy irrelevant sessions from diluting plan-specific results.\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"194cef19-4cae-42d5-abe6-afaf1c21079d","timestamp":"2026-02-21T23:21:19.837Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/docs/learned/sessions/discovery-fallback.md","content":"\n### Why two commands?\n\n`list-sessions` knows nothing about plans — it scans the local Claude Code project directory and returns what's there. `get-learn-sessions` starts from a plan issue, extracts session IDs from GitHub metadata (plan-header fields and issue comments), then checks which ones are actually readable on disk. It also discovers remote sessions (gist-based or legacy artifact-based) that `list-sessions` would never find.\n\n<!-- Source: packages/erk-shared/src/erk_shared/sessions/discovery.py, find_sessions_for_plan -->\n\nSee `find_sessions_for_plan()` in `packages/erk-shared/src/erk_shared/sessions/discovery.py` for how plan-specific discovery extracts session IDs from multiple metadata sources (plan-header fields, impl-started/impl-ended comments, learn-invoked comments).\n\n## Output Schema (list-sessions)\n\nThe `erk exec list-sessions` command returns a JSON object. Key structure:\n\n```json\n{\n  \"success\": true,\n  \"branch_context\": {\n    \"current_branch\": \"feature-xyz\",\n    \"trunk_branch\": \"master\",\n    \"is_on_trunk\": false\n  },\n  \"current_session_id\": \"abc123-def456\",\n  \"sessions\": [\n    {\n      \"session_id\": \"abc123-def456\",\n      \"mtime_display\": \"Feb 5, 10:30 AM\",\n      \"mtime_relative\": \"2h ago\",\n      \"mtime_unix\": 1738764600.0,\n      \"size_bytes\": 157000,\n      \"summary\": \"First 60 chars of first user message...\",\n      \"is_current\": true,\n      \"branch\": \"feature-xyz\",\n      \"session_path\": \"/path/to/session.jsonl\"\n    }\n  ],\n  \"filtered_count\": 3\n}\n```\n\n## Fallback Hierarchy for Learn Workflows\n\nWhen a learn workflow needs session data, the ideal source (planning session) is often unavailable because it was created in a different Claude Code session. The discovery system degrades through multiple levels rather than failing.\n\n| Priority | Source                    | How discovered                                                                          | Why it might be missing                                             |\n| -------- | ------------------------- | --------------------------------------------------------------------------------------- | ------------------------------------------------------------------- |\n| 1        | Planning session          | `created_from_session` in plan-header                                                   | Created in a prior Claude Code session, since cleaned up            |\n| 2        | Implementation session    | `last_local_impl_session` in plan-header + issue comments                               | Same reason — different session lifecycle                           |\n| 3        | Remote session (gist)     | `last_session_gist_url` in plan-header                                                  | Gist may have been deleted; requires download step                  |\n| 4        | Remote session (artifact) | `last_remote_impl_run_id` in plan-header                                                | Legacy path; GitHub Actions artifacts expire after 90 days          |\n| 5        | Local fallback scan       | `find_local_sessions_for_project()` scans project directory, filtered by current branch | No metadata link to plan, but recent sessions may still be relevant |\n| 6        | Skip analysis             | Always available                                                                        | Produces no session insights, but workflow continues                |\n\n<!-- Source: src/erk/cli/commands/exec/scripts/get_learn_sessions.py, _discover_sessions -->\n\nThe fallback logic is implemented in `_discover_sessions()` in `src/erk/cli/commands/exec/scripts/get_learn_sessions.py`. The critical design decision: local fallback scanning only triggers when **no** GitHub-tracked sessions are readable on disk, preventing noisy irrelevant sessions from diluting plan-specific results.","numLines":55,"startLine":30,"totalLines":102}}}
{"parentUuid":"194cef19-4cae-42d5-abe6-afaf1c21079d","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01TNb5SBjrZD1jkn66ekR8tE","type":"message","role":"assistant","content":[{"type":"text","text":"The `discovery-fallback.md` still references \"gist\" — these references describe the fallback hierarchy where gist is a legacy tier. I should update these to reflect branch-based storage since the code was changed. Let me check if `last_session_gist_url` is still used in the code:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1658,"cache_read_input_tokens":112459,"cache_creation":{"ephemeral_5m_input_tokens":1658,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5AjevPh3egEakiNXdh","type":"assistant","uuid":"e4055004-7bef-4210-9b50-f935482e7674","timestamp":"2026-02-21T23:21:23.195Z"}
{"parentUuid":"e4055004-7bef-4210-9b50-f935482e7674","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01TNb5SBjrZD1jkn66ekR8tE","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WE8PRFY7DqVLWFoXJhk3Cv","name":"Grep","input":{"pattern":"last_session_gist_url|gist_url","path":"/home/runner/work/erk/erk/src","output_mode":"files_with_matches"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1658,"cache_read_input_tokens":112459,"cache_creation":{"ephemeral_5m_input_tokens":1658,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5AjevPh3egEakiNXdh","type":"assistant","uuid":"06c4a67b-7280-4b0b-8782-a07aac8346ef","timestamp":"2026-02-21T23:21:24.238Z"}
{"parentUuid":"06c4a67b-7280-4b0b-8782-a07aac8346ef","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WE8PRFY7DqVLWFoXJhk3Cv","type":"tool_result","content":"No files found"}]},"uuid":"d95c1c81-bfdf-4d50-ae2c-8fc524f86ce2","timestamp":"2026-02-21T23:21:24.715Z","toolUseResult":{"mode":"files_with_matches","filenames":[],"numFiles":0}}
{"parentUuid":"d95c1c81-bfdf-4d50-ae2c-8fc524f86ce2","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_019HU7mn1VvEKaKZNFHf8veR","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TNNj7dpNNUnN7Htfq1iYym","name":"Grep","input":{"pattern":"last_session_gist|gist","path":"/home/runner/work/erk/erk/src/erk/cli/commands/exec/scripts/get_learn_sessions.py","output_mode":"content","-n":true},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":201,"cache_read_input_tokens":114117,"cache_creation":{"ephemeral_5m_input_tokens":201,"ephemeral_1h_input_tokens":0},"output_tokens":19,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5B6VoRYz8x418MLft2","type":"assistant","uuid":"eba24dc2-3b0b-4bf1-8fa9-d36c1d461210","timestamp":"2026-02-21T23:21:28.007Z"}
{"parentUuid":"eba24dc2-3b0b-4bf1-8fa9-d36c1d461210","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TNNj7dpNNUnN7Htfq1iYym","type":"tool_result","content":"No matches found"}]},"uuid":"b650aaed-25fd-4d10-b02d-b38cd03d9aca","timestamp":"2026-02-21T23:21:28.527Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"","numLines":0}}
{"parentUuid":"b650aaed-25fd-4d10-b02d-b38cd03d9aca","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_016dLh42SBr5kJsyznHZ4avx","type":"message","role":"assistant","content":[{"type":"text","text":"The gist references are gone from the code. Let me update `discovery-fallback.md` to reflect branch-based storage:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":495,"cache_read_input_tokens":114318,"cache_creation":{"ephemeral_5m_input_tokens":495,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5BNs3kJdUVXgGhjZjx","type":"assistant","uuid":"328a970b-dbe8-428a-850a-ec0ff546b350","timestamp":"2026-02-21T23:21:31.358Z"}
{"parentUuid":"328a970b-dbe8-428a-850a-ec0ff546b350","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_016dLh42SBr5kJsyznHZ4avx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KkaB58q58PXyjaRQ3Kqjah","name":"Read","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/sessions/discovery-fallback.md","limit":10},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":495,"cache_read_input_tokens":114318,"cache_creation":{"ephemeral_5m_input_tokens":495,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5BNs3kJdUVXgGhjZjx","type":"assistant","uuid":"cf1e9132-85da-4d9f-9950-0760a0d2598a","timestamp":"2026-02-21T23:21:31.916Z"}
{"parentUuid":"cf1e9132-85da-4d9f-9950-0760a0d2598a","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KkaB58q58PXyjaRQ3Kqjah","type":"tool_result","content":"     1→---\n     2→title: Session Discovery and Fallback Patterns\n     3→read_when:\n     4→  - \"implementing session analysis or learn workflows\"\n     5→  - \"handling missing or unavailable session files\"\n     6→  - \"choosing between session discovery commands\"\n     7→tripwires:\n     8→  - action: \"using get-session-metadata or get-session-for-issue exec commands\"\n     9→    warning: \"These commands do not exist. Use 'erk exec list-sessions' for general enumeration or 'erk exec get-learn-sessions' for plan-specific discovery.\"\n    10→  - action: \"assuming a session ID from metadata corresponds to a file on disk\"\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"d6068173-3a41-4778-93de-e4e73f5f1d0f","timestamp":"2026-02-21T23:21:31.950Z","toolUseResult":{"type":"text","file":{"filePath":"/home/runner/work/erk/erk/docs/learned/sessions/discovery-fallback.md","content":"---\ntitle: Session Discovery and Fallback Patterns\nread_when:\n  - \"implementing session analysis or learn workflows\"\n  - \"handling missing or unavailable session files\"\n  - \"choosing between session discovery commands\"\ntripwires:\n  - action: \"using get-session-metadata or get-session-for-issue exec commands\"\n    warning: \"These commands do not exist. Use 'erk exec list-sessions' for general enumeration or 'erk exec get-learn-sessions' for plan-specific discovery.\"\n  - action: \"assuming a session ID from metadata corresponds to a file on disk\"","numLines":10,"startLine":1,"totalLines":102}}}
{"parentUuid":"d6068173-3a41-4778-93de-e4e73f5f1d0f","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01FCA8kTT1YEu8x9Bqi5mGDC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SMncfeqXcYoS2ZFLMi3VkL","name":"Edit","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/sessions/discovery-fallback.md","old_string":"`list-sessions` knows nothing about plans — it scans the local Claude Code project directory and returns what's there. `get-learn-sessions` starts from a plan issue, extracts session IDs from GitHub metadata (plan-header fields and issue comments), then checks which ones are actually readable on disk. It also discovers remote sessions (gist-based or legacy artifact-based) that `list-sessions` would never find.","new_string":"`list-sessions` knows nothing about plans — it scans the local Claude Code project directory and returns what's there. `get-learn-sessions` starts from a plan issue, extracts session IDs from GitHub metadata (plan-header fields and issue comments), then checks which ones are actually readable on disk. It also discovers remote sessions (branch-based or legacy artifact-based) that `list-sessions` would never find."},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":385,"cache_read_input_tokens":114813,"cache_creation":{"ephemeral_5m_input_tokens":385,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5BdV8FsAsmsGLJX6w6","type":"assistant","uuid":"a5c48b6d-2641-47d0-b87b-88a8d07cecb8","timestamp":"2026-02-21T23:21:38.297Z"}
{"parentUuid":"a5c48b6d-2641-47d0-b87b-88a8d07cecb8","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SMncfeqXcYoS2ZFLMi3VkL","type":"tool_result","content":"The file /home/runner/work/erk/erk/docs/learned/sessions/discovery-fallback.md has been updated successfully."}]},"uuid":"14a6eca8-1221-4fa8-8f4f-a4c782955943","timestamp":"2026-02-21T23:21:39.028Z","toolUseResult":{"filePath":"/home/runner/work/erk/erk/docs/learned/sessions/discovery-fallback.md","oldString":"`list-sessions` knows nothing about plans — it scans the local Claude Code project directory and returns what's there. `get-learn-sessions` starts from a plan issue, extracts session IDs from GitHub metadata (plan-header fields and issue comments), then checks which ones are actually readable on disk. It also discovers remote sessions (gist-based or legacy artifact-based) that `list-sessions` would never find.","newString":"`list-sessions` knows nothing about plans — it scans the local Claude Code project directory and returns what's there. `get-learn-sessions` starts from a plan issue, extracts session IDs from GitHub metadata (plan-header fields and issue comments), then checks which ones are actually readable on disk. It also discovers remote sessions (branch-based or legacy artifact-based) that `list-sessions` would never find.","originalFile":"---\ntitle: Session Discovery and Fallback Patterns\nread_when:\n  - \"implementing session analysis or learn workflows\"\n  - \"handling missing or unavailable session files\"\n  - \"choosing between session discovery commands\"\ntripwires:\n  - action: \"using get-session-metadata or get-session-for-issue exec commands\"\n    warning: \"These commands do not exist. Use 'erk exec list-sessions' for general enumeration or 'erk exec get-learn-sessions' for plan-specific discovery.\"\n  - action: \"assuming a session ID from metadata corresponds to a file on disk\"\n    warning: \"Claude Code manages session lifecycle; old sessions may be cleaned up. Always use LBYL discovery before reading.\"\nlast_audited: \"2026-02-16 14:20 PT\"\naudit_result: clean\n---\n\n# Session Discovery and Fallback Patterns\n\n## Core Principle\n\n**Always discover what's available before assuming availability.** Session files are session-scoped — Claude Code may clean them up at any time, so a session ID from GitHub metadata may not correspond to a file on disk. Discovery commands exist specifically to bridge this gap.\n\n## Two Discovery Paths\n\nErk has two distinct session discovery commands that serve different purposes. Choosing the wrong one wastes tokens or misses available sessions.\n\n| Command                               | Purpose                                             | Output                                        | When to use                                                |\n| ------------------------------------- | --------------------------------------------------- | --------------------------------------------- | ---------------------------------------------------------- |\n| `erk exec list-sessions`              | Enumerate all sessions for the current project      | JSON with branch context and session metadata | General session browsing, selecting sessions interactively |\n| `erk exec get-learn-sessions <issue>` | Find sessions associated with a specific plan issue | JSON with categorized session IDs and paths   | Learn workflows, plan-specific analysis                    |\n\n### Why two commands?\n\n`list-sessions` knows nothing about plans — it scans the local Claude Code project directory and returns what's there. `get-learn-sessions` starts from a plan issue, extracts session IDs from GitHub metadata (plan-header fields and issue comments), then checks which ones are actually readable on disk. It also discovers remote sessions (gist-based or legacy artifact-based) that `list-sessions` would never find.\n\n<!-- Source: packages/erk-shared/src/erk_shared/sessions/discovery.py, find_sessions_for_plan -->\n\nSee `find_sessions_for_plan()` in `packages/erk-shared/src/erk_shared/sessions/discovery.py` for how plan-specific discovery extracts session IDs from multiple metadata sources (plan-header fields, impl-started/impl-ended comments, learn-invoked comments).\n\n## Output Schema (list-sessions)\n\nThe `erk exec list-sessions` command returns a JSON object. Key structure:\n\n```json\n{\n  \"success\": true,\n  \"branch_context\": {\n    \"current_branch\": \"feature-xyz\",\n    \"trunk_branch\": \"master\",\n    \"is_on_trunk\": false\n  },\n  \"current_session_id\": \"abc123-def456\",\n  \"sessions\": [\n    {\n      \"session_id\": \"abc123-def456\",\n      \"mtime_display\": \"Feb 5, 10:30 AM\",\n      \"mtime_relative\": \"2h ago\",\n      \"mtime_unix\": 1738764600.0,\n      \"size_bytes\": 157000,\n      \"summary\": \"First 60 chars of first user message...\",\n      \"is_current\": true,\n      \"branch\": \"feature-xyz\",\n      \"session_path\": \"/path/to/session.jsonl\"\n    }\n  ],\n  \"filtered_count\": 3\n}\n```\n\n## Fallback Hierarchy for Learn Workflows\n\nWhen a learn workflow needs session data, the ideal source (planning session) is often unavailable because it was created in a different Claude Code session. The discovery system degrades through multiple levels rather than failing.\n\n| Priority | Source                    | How discovered                                                                          | Why it might be missing                                             |\n| -------- | ------------------------- | --------------------------------------------------------------------------------------- | ------------------------------------------------------------------- |\n| 1        | Planning session          | `created_from_session` in plan-header                                                   | Created in a prior Claude Code session, since cleaned up            |\n| 2        | Implementation session    | `last_local_impl_session` in plan-header + issue comments                               | Same reason — different session lifecycle                           |\n| 3        | Remote session (gist)     | `last_session_gist_url` in plan-header                                                  | Gist may have been deleted; requires download step                  |\n| 4        | Remote session (artifact) | `last_remote_impl_run_id` in plan-header                                                | Legacy path; GitHub Actions artifacts expire after 90 days          |\n| 5        | Local fallback scan       | `find_local_sessions_for_project()` scans project directory, filtered by current branch | No metadata link to plan, but recent sessions may still be relevant |\n| 6        | Skip analysis             | Always available                                                                        | Produces no session insights, but workflow continues                |\n\n<!-- Source: src/erk/cli/commands/exec/scripts/get_learn_sessions.py, _discover_sessions -->\n\nThe fallback logic is implemented in `_discover_sessions()` in `src/erk/cli/commands/exec/scripts/get_learn_sessions.py`. The critical design decision: local fallback scanning only triggers when **no** GitHub-tracked sessions are readable on disk, preventing noisy irrelevant sessions from diluting plan-specific results.\n\n### Branch Filtering in Local Fallback\n\nWhen the local fallback scan activates, sessions are filtered by the current git branch name. Each session's JSONL log contains a `gitBranch` field, and only sessions whose branch matches the current worktree branch are included. This prevents worktree slot reuse from contaminating results — when a worktree is reused for a different plan, old sessions from a previous branch are excluded even though they exist in the same project directory.\n\n### Anti-pattern: Hard failure on missing session\n\nNever `exit 1` or raise when a session file is unavailable. The entire fallback hierarchy exists because session availability is inherently unreliable. Log a warning and degrade to the next level.\n\n### Anti-pattern: Skipping discovery and reading session files directly\n\nDon't construct session paths manually (e.g., `~/.claude/projects/.../sessions/{id}.jsonl`). The `ClaudeInstallation` ABC provides `find_session_globally()` for existence checks — use it. Direct path construction bypasses the abstraction and breaks if Claude Code changes its storage layout.\n\n## Related Documentation\n\n- [Session Lifecycle](lifecycle.md) — Session file persistence, availability patterns, and LBYL principles\n- [Session Preprocessing](preprocessing.md) — Token limits and multi-part file handling\n","structuredPatch":[{"oldStart":30,"oldLines":7,"newStart":30,"newLines":7,"lines":[" "," ### Why two commands?"," ","-`list-sessions` knows nothing about plans — it scans the local Claude Code project directory and returns what's there. `get-learn-sessions` starts from a plan issue, extracts session IDs from GitHub metadata (plan-header fields and issue comments), then checks which ones are actually readable on disk. It also discovers remote sessions (gist-based or legacy artifact-based) that `list-sessions` would never find.","+`list-sessions` knows nothing about plans — it scans the local Claude Code project directory and returns what's there. `get-learn-sessions` starts from a plan issue, extracts session IDs from GitHub metadata (plan-header fields and issue comments), then checks which ones are actually readable on disk. It also discovers remote sessions (branch-based or legacy artifact-based) that `list-sessions` would never find."," "," <!-- Source: packages/erk-shared/src/erk_shared/sessions/discovery.py, find_sessions_for_plan -->"," "]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"14a6eca8-1221-4fa8-8f4f-a4c782955943","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01CBFDqYDg8vd8r7afg8mHYu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PQ36AucbmJ1SxwwaYLqkbq","name":"Edit","input":{"file_path":"/home/runner/work/erk/erk/docs/learned/sessions/discovery-fallback.md","old_string":"| 3        | Remote session (gist)     | `last_session_gist_url` in plan-header                                                  | Gist may have been deleted; requires download step                  |","new_string":"| 3        | Remote session (branch)   | `last_session_branch` in plan-header                                                    | Branch may have been deleted; requires checkout step                |"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":670,"cache_read_input_tokens":115198,"cache_creation":{"ephemeral_5m_input_tokens":670,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5C9iZ63KycMXvYsu1R","type":"assistant","uuid":"40b39e69-e686-4c79-bb94-f4c2fb94f956","timestamp":"2026-02-21T23:21:42.654Z"}
{"parentUuid":"40b39e69-e686-4c79-bb94-f4c2fb94f956","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PQ36AucbmJ1SxwwaYLqkbq","type":"tool_result","content":"The file /home/runner/work/erk/erk/docs/learned/sessions/discovery-fallback.md has been updated successfully."}]},"uuid":"553ec9bc-0bb8-457a-8246-ff99d8f3a897","timestamp":"2026-02-21T23:21:43.377Z","toolUseResult":{"filePath":"/home/runner/work/erk/erk/docs/learned/sessions/discovery-fallback.md","oldString":"| 3        | Remote session (gist)     | `last_session_gist_url` in plan-header                                                  | Gist may have been deleted; requires download step                  |","newString":"| 3        | Remote session (branch)   | `last_session_branch` in plan-header                                                    | Branch may have been deleted; requires checkout step                |","originalFile":"---\ntitle: Session Discovery and Fallback Patterns\nread_when:\n  - \"implementing session analysis or learn workflows\"\n  - \"handling missing or unavailable session files\"\n  - \"choosing between session discovery commands\"\ntripwires:\n  - action: \"using get-session-metadata or get-session-for-issue exec commands\"\n    warning: \"These commands do not exist. Use 'erk exec list-sessions' for general enumeration or 'erk exec get-learn-sessions' for plan-specific discovery.\"\n  - action: \"assuming a session ID from metadata corresponds to a file on disk\"\n    warning: \"Claude Code manages session lifecycle; old sessions may be cleaned up. Always use LBYL discovery before reading.\"\nlast_audited: \"2026-02-16 14:20 PT\"\naudit_result: clean\n---\n\n# Session Discovery and Fallback Patterns\n\n## Core Principle\n\n**Always discover what's available before assuming availability.** Session files are session-scoped — Claude Code may clean them up at any time, so a session ID from GitHub metadata may not correspond to a file on disk. Discovery commands exist specifically to bridge this gap.\n\n## Two Discovery Paths\n\nErk has two distinct session discovery commands that serve different purposes. Choosing the wrong one wastes tokens or misses available sessions.\n\n| Command                               | Purpose                                             | Output                                        | When to use                                                |\n| ------------------------------------- | --------------------------------------------------- | --------------------------------------------- | ---------------------------------------------------------- |\n| `erk exec list-sessions`              | Enumerate all sessions for the current project      | JSON with branch context and session metadata | General session browsing, selecting sessions interactively |\n| `erk exec get-learn-sessions <issue>` | Find sessions associated with a specific plan issue | JSON with categorized session IDs and paths   | Learn workflows, plan-specific analysis                    |\n\n### Why two commands?\n\n`list-sessions` knows nothing about plans — it scans the local Claude Code project directory and returns what's there. `get-learn-sessions` starts from a plan issue, extracts session IDs from GitHub metadata (plan-header fields and issue comments), then checks which ones are actually readable on disk. It also discovers remote sessions (branch-based or legacy artifact-based) that `list-sessions` would never find.\n\n<!-- Source: packages/erk-shared/src/erk_shared/sessions/discovery.py, find_sessions_for_plan -->\n\nSee `find_sessions_for_plan()` in `packages/erk-shared/src/erk_shared/sessions/discovery.py` for how plan-specific discovery extracts session IDs from multiple metadata sources (plan-header fields, impl-started/impl-ended comments, learn-invoked comments).\n\n## Output Schema (list-sessions)\n\nThe `erk exec list-sessions` command returns a JSON object. Key structure:\n\n```json\n{\n  \"success\": true,\n  \"branch_context\": {\n    \"current_branch\": \"feature-xyz\",\n    \"trunk_branch\": \"master\",\n    \"is_on_trunk\": false\n  },\n  \"current_session_id\": \"abc123-def456\",\n  \"sessions\": [\n    {\n      \"session_id\": \"abc123-def456\",\n      \"mtime_display\": \"Feb 5, 10:30 AM\",\n      \"mtime_relative\": \"2h ago\",\n      \"mtime_unix\": 1738764600.0,\n      \"size_bytes\": 157000,\n      \"summary\": \"First 60 chars of first user message...\",\n      \"is_current\": true,\n      \"branch\": \"feature-xyz\",\n      \"session_path\": \"/path/to/session.jsonl\"\n    }\n  ],\n  \"filtered_count\": 3\n}\n```\n\n## Fallback Hierarchy for Learn Workflows\n\nWhen a learn workflow needs session data, the ideal source (planning session) is often unavailable because it was created in a different Claude Code session. The discovery system degrades through multiple levels rather than failing.\n\n| Priority | Source                    | How discovered                                                                          | Why it might be missing                                             |\n| -------- | ------------------------- | --------------------------------------------------------------------------------------- | ------------------------------------------------------------------- |\n| 1        | Planning session          | `created_from_session` in plan-header                                                   | Created in a prior Claude Code session, since cleaned up            |\n| 2        | Implementation session    | `last_local_impl_session` in plan-header + issue comments                               | Same reason — different session lifecycle                           |\n| 3        | Remote session (gist)     | `last_session_gist_url` in plan-header                                                  | Gist may have been deleted; requires download step                  |\n| 4        | Remote session (artifact) | `last_remote_impl_run_id` in plan-header                                                | Legacy path; GitHub Actions artifacts expire after 90 days          |\n| 5        | Local fallback scan       | `find_local_sessions_for_project()` scans project directory, filtered by current branch | No metadata link to plan, but recent sessions may still be relevant |\n| 6        | Skip analysis             | Always available                                                                        | Produces no session insights, but workflow continues                |\n\n<!-- Source: src/erk/cli/commands/exec/scripts/get_learn_sessions.py, _discover_sessions -->\n\nThe fallback logic is implemented in `_discover_sessions()` in `src/erk/cli/commands/exec/scripts/get_learn_sessions.py`. The critical design decision: local fallback scanning only triggers when **no** GitHub-tracked sessions are readable on disk, preventing noisy irrelevant sessions from diluting plan-specific results.\n\n### Branch Filtering in Local Fallback\n\nWhen the local fallback scan activates, sessions are filtered by the current git branch name. Each session's JSONL log contains a `gitBranch` field, and only sessions whose branch matches the current worktree branch are included. This prevents worktree slot reuse from contaminating results — when a worktree is reused for a different plan, old sessions from a previous branch are excluded even though they exist in the same project directory.\n\n### Anti-pattern: Hard failure on missing session\n\nNever `exit 1` or raise when a session file is unavailable. The entire fallback hierarchy exists because session availability is inherently unreliable. Log a warning and degrade to the next level.\n\n### Anti-pattern: Skipping discovery and reading session files directly\n\nDon't construct session paths manually (e.g., `~/.claude/projects/.../sessions/{id}.jsonl`). The `ClaudeInstallation` ABC provides `find_session_globally()` for existence checks — use it. Direct path construction bypasses the abstraction and breaks if Claude Code changes its storage layout.\n\n## Related Documentation\n\n- [Session Lifecycle](lifecycle.md) — Session file persistence, availability patterns, and LBYL principles\n- [Session Preprocessing](preprocessing.md) — Token limits and multi-part file handling\n","structuredPatch":[{"oldStart":74,"oldLines":7,"newStart":74,"newLines":7,"lines":[" | -------- | ------------------------- | --------------------------------------------------------------------------------------- | ------------------------------------------------------------------- |"," | 1        | Planning session          | `created_from_session` in plan-header                                                   | Created in a prior Claude Code session, since cleaned up            |"," | 2        | Implementation session    | `last_local_impl_session` in plan-header + issue comments                               | Same reason — different session lifecycle                           |","-| 3        | Remote session (gist)     | `last_session_gist_url` in plan-header                                                  | Gist may have been deleted; requires download step                  |","+| 3        | Remote session (branch)   | `last_session_branch` in plan-header                                                    | Branch may have been deleted; requires checkout step                |"," | 4        | Remote session (artifact) | `last_remote_impl_run_id` in plan-header                                                | Legacy path; GitHub Actions artifacts expire after 90 days          |"," | 5        | Local fallback scan       | `find_local_sessions_for_project()` scans project directory, filtered by current branch | No metadata link to plan, but recent sessions may still be relevant |"," | 6        | Skip analysis             | Always available                                                                        | Produces no session insights, but workflow continues                |"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"553ec9bc-0bb8-457a-8246-ff99d8f3a897","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_014LU2pYWD1FxYEAyS5hbrwX","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me verify the new files have correct frontmatter and run sync again to pick up the discovery-fallback changes:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":241,"cache_read_input_tokens":115868,"cache_creation":{"ephemeral_5m_input_tokens":241,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5CUJFSPCJuHhTk32xz","type":"assistant","uuid":"8f41014d-779d-4a8f-ab1f-5b9707adadb2","timestamp":"2026-02-21T23:21:45.884Z"}
{"parentUuid":"8f41014d-779d-4a8f-ab1f-5b9707adadb2","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_014LU2pYWD1FxYEAyS5hbrwX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015PvGiiJn32QA9u9Zr6xP2Z","name":"Task","input":{"description":"Run erk docs sync again","prompt":"Run `erk docs sync` in /home/runner/work/erk/erk and report the results.","subagent_type":"devrun"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":241,"cache_read_input_tokens":115868,"cache_creation":{"ephemeral_5m_input_tokens":241,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5CUJFSPCJuHhTk32xz","type":"assistant","uuid":"12d248d7-ed31-4f81-9349-70d1715ace8e","timestamp":"2026-02-21T23:21:46.983Z"}
{"parentUuid":"12d248d7-ed31-4f81-9349-70d1715ace8e","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015PvGiiJn32QA9u9Zr6xP2Z","type":"tool_result","content":[{"type":"text","text":"**erk docs sync passed**: Documentation synchronization completed successfully.\n\nSummary:\n- 56 files unchanged\n- 733 total tripwires collected across all categories\n- All documentation files up to date\n\nThe command scanned the documentation structure, generated indexes for the root and categories, collected tripwires from the codebase, and verified that all generated files are current. No changes were needed."},{"type":"text","text":"agentId: a9cc0d3 (for resuming to continue this agent's work if needed)"}]}]},"uuid":"d3c3348d-06c8-40eb-b292-9aad3ddec7e9","timestamp":"2026-02-21T23:22:10.189Z","toolUseResult":{"status":"completed","prompt":"Run `erk docs sync` in /home/runner/work/erk/erk and report the results.","agentId":"a9cc0d3","content":[{"type":"text","text":"**erk docs sync passed**: Documentation synchronization completed successfully.\n\nSummary:\n- 56 files unchanged\n- 733 total tripwires collected across all categories\n- All documentation files up to date\n\nThe command scanned the documentation structure, generated indexes for the root and categories, collected tripwires from the codebase, and verified that all generated files are current. No changes were needed."}],"totalDurationMs":23180,"totalTokens":12705,"totalToolUseCount":1,"usage":{"input_tokens":6,"cache_creation_input_tokens":381,"cache_read_input_tokens":12230,"cache_creation":{"ephemeral_5m_input_tokens":381,"ephemeral_1h_input_tokens":0},"output_tokens":88,"service_tier":"standard","inference_geo":"not_available"}}}
{"parentUuid":"d3c3348d-06c8-40eb-b292-9aad3ddec7e9","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_019bU3M48CqeaneG4U4grHmT","type":"message","role":"assistant","content":[{"type":"text","text":"Good, docs sync is clean. Now let me verify `.impl/` is preserved, then run CI."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":602,"cache_read_input_tokens":116109,"cache_creation":{"ephemeral_5m_input_tokens":602,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5ESvxRnMZ7fThdaGJ4","type":"assistant","uuid":"4f5607d2-be24-4b42-b68c-6f4a20d63c9d","timestamp":"2026-02-21T23:22:12.987Z"}
{"parentUuid":"4f5607d2-be24-4b42-b68c-6f4a20d63c9d","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_019bU3M48CqeaneG4U4grHmT","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Lheg5an6r7pMj25UeYRMoc","name":"Bash","input":{"command":"erk exec impl-verify 2>&1","description":"Verify .impl/ folder preserved"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":602,"cache_read_input_tokens":116109,"cache_creation":{"ephemeral_5m_input_tokens":602,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5ESvxRnMZ7fThdaGJ4","type":"assistant","uuid":"94cdc9b9-a3d8-4f78-a9ae-e9e8e51acdbf","timestamp":"2026-02-21T23:22:13.759Z"}
{"parentUuid":"94cdc9b9-a3d8-4f78-a9ae-e9e8e51acdbf","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Lheg5an6r7pMj25UeYRMoc","type":"tool_result","content":"{\"valid\": true, \"impl_dir\": \"/home/runner/work/erk/erk/.impl\"}","is_error":false}]},"uuid":"a84b884a-5caf-4e7a-a4f2-8b0a7c59cb0b","timestamp":"2026-02-21T23:22:14.903Z","toolUseResult":{"stdout":"{\"valid\": true, \"impl_dir\": \"/home/runner/work/erk/erk/.impl\"}","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"a84b884a-5caf-4e7a-a4f2-8b0a7c59cb0b","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01RTPiV9ZGNCHoeNbarK3Xy5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XZPUtzGfys6v5V6JSCBXYb","name":"TodoWrite","input":{"todos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"completed","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"completed","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"completed","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"completed","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"completed","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"completed","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"in_progress","activeForm":"Running CI and submitting PR"}]},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":146,"cache_read_input_tokens":116711,"cache_creation":{"ephemeral_5m_input_tokens":146,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5Eo5ARjDfBCs5JBBUJ","type":"assistant","uuid":"6d141168-972d-4514-8185-5f859edff087","timestamp":"2026-02-21T23:22:20.972Z"}
{"parentUuid":"6d141168-972d-4514-8185-5f859edff087","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XZPUtzGfys6v5V6JSCBXYb","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"32e58c4b-8dc2-4375-aca1-41d38a9e225d","timestamp":"2026-02-21T23:22:20.986Z","toolUseResult":{"oldTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"completed","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"completed","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"completed","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"completed","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"completed","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"in_progress","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"pending","activeForm":"Running CI and submitting PR"}],"newTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"completed","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"completed","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"completed","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"completed","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"completed","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"completed","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"in_progress","activeForm":"Running CI and submitting PR"}]}}
{"parentUuid":"32e58c4b-8dc2-4375-aca1-41d38a9e225d","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01XxwfPyEDKaTEsffoC7ZsQg","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me run the fast CI checks. First, let me run prettier since I edited markdown files:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":565,"cache_read_input_tokens":116857,"cache_creation":{"ephemeral_5m_input_tokens":565,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5FF6qXBBH6kHzngAVQ","type":"assistant","uuid":"b8e35bf1-d27f-4163-b6d0-2b6ab318f58a","timestamp":"2026-02-21T23:22:23.732Z"}
{"parentUuid":"b8e35bf1-d27f-4163-b6d0-2b6ab318f58a","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01XxwfPyEDKaTEsffoC7ZsQg","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019uhmEgXc54JfDBVpfm4wxn","name":"Task","input":{"description":"Run make prettier","prompt":"Run `make prettier` in /home/runner/work/erk/erk and report the results. This formats markdown files.","subagent_type":"devrun"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":565,"cache_read_input_tokens":116857,"cache_creation":{"ephemeral_5m_input_tokens":565,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5FF6qXBBH6kHzngAVQ","type":"assistant","uuid":"64467e45-6cff-4e38-922d-019b1824338e","timestamp":"2026-02-21T23:22:24.614Z"}
{"parentUuid":"64467e45-6cff-4e38-922d-019b1824338e","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019uhmEgXc54JfDBVpfm4wxn","type":"tool_result","content":[{"type":"text","text":"prettier passed: All matched files use Prettier code style!\n\nThe formatter checked 361 markdown files. Most files were already properly formatted (unchanged). There was one file that needed formatting:\n\n- docs/learned/cli/backend-aware-display.md (6ms)\n\nThis file has been automatically formatted by prettier and is now compliant with the project's markdown style standards."},{"type":"text","text":"agentId: aef5b53 (for resuming to continue this agent's work if needed)"}]}]},"uuid":"17ee0057-d4d6-4e47-8cf3-22ab81ae428b","timestamp":"2026-02-21T23:22:40.711Z","toolUseResult":{"status":"completed","prompt":"Run `make prettier` in /home/runner/work/erk/erk and report the results. This formats markdown files.","agentId":"aef5b53","content":[{"type":"text","text":"prettier passed: All matched files use Prettier code style!\n\nThe formatter checked 361 markdown files. Most files were already properly formatted (unchanged). There was one file that needed formatting:\n\n- docs/learned/cli/backend-aware-display.md (6ms)\n\nThis file has been automatically formatted by prettier and is now compliant with the project's markdown style standards."}],"totalDurationMs":16081,"totalTokens":23402,"totalToolUseCount":1,"usage":{"input_tokens":6,"cache_creation_input_tokens":11080,"cache_read_input_tokens":12233,"cache_creation":{"ephemeral_5m_input_tokens":11080,"ephemeral_1h_input_tokens":0},"output_tokens":83,"service_tier":"standard","inference_geo":"not_available"}}}
{"parentUuid":"17ee0057-d4d6-4e47-8cf3-22ab81ae428b","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01VVNqJ5H3gQcpV8b3Kmet66","type":"message","role":"assistant","content":[{"type":"text","text":"Prettier formatted one file. Now let me run the full fast CI:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":737,"cache_read_input_tokens":117422,"cache_creation":{"ephemeral_5m_input_tokens":737,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5GhVNL2L8qgGbNYLNi","type":"assistant","uuid":"636254ce-e6ba-44f6-bf77-d7ffc149cbfd","timestamp":"2026-02-21T23:22:42.932Z"}
{"parentUuid":"636254ce-e6ba-44f6-bf77-d7ffc149cbfd","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01VVNqJ5H3gQcpV8b3Kmet66","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FQFcLYcrYG3Ckaeft8yAwM","name":"Task","input":{"description":"Run fast CI checks","prompt":"Run `make fast-ci` in /home/runner/work/erk/erk and report the results. This runs linting, formatting checks, type checking, and unit tests.","subagent_type":"devrun"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":737,"cache_read_input_tokens":117422,"cache_creation":{"ephemeral_5m_input_tokens":737,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5GhVNL2L8qgGbNYLNi","type":"assistant","uuid":"23fec662-95fc-4cdc-b63e-48199eea2231","timestamp":"2026-02-21T23:22:44.022Z"}
{"parentUuid":"23fec662-95fc-4cdc-b63e-48199eea2231","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FQFcLYcrYG3Ckaeft8yAwM","type":"tool_result","content":[{"type":"text","text":"Excellent! The `make fast-ci` command has passed completely. Here's a summary of the results:\n\n## Fast CI Results: PASSED\n\n### Linting & Code Quality\n- **Lint**: All checks passed\n- **Format Check**: 1500 files already formatted\n- **Prettier Check**: All matched files use Prettier code style\n- **Type Checking (ty)**: All checks passed\n\n### Tests\n- **Unit Tests (erk)**: 5294 passed in 22.13s\n- **Tests (erk-dev)**: 136 passed in 4.36s\n- **Tests (erk-statusline)**: 126 passed in 0.88s\n\n### Documentation\n- **Exec Reference Check**: `.claude/skills/erk-exec/reference.md` is up to date\n- **CLAUDE.md/AGENTS.md Standard**: PASSED\n  - 19 CLAUDE.md files checked\n  - 0 violations\n\n**Total: All checks passed successfully with 5,556 tests passing across all packages.**"},{"type":"text","text":"agentId: a20e92b (for resuming to continue this agent's work if needed)"}]}]},"uuid":"9c5e0e51-7ab0-4b89-826f-ff34f942f939","timestamp":"2026-02-21T23:23:33.086Z","toolUseResult":{"status":"completed","prompt":"Run `make fast-ci` in /home/runner/work/erk/erk and report the results. This runs linting, formatting checks, type checking, and unit tests.","agentId":"a20e92b","content":[{"type":"text","text":"Excellent! The `make fast-ci` command has passed completely. Here's a summary of the results:\n\n## Fast CI Results: PASSED\n\n### Linting & Code Quality\n- **Lint**: All checks passed\n- **Format Check**: 1500 files already formatted\n- **Prettier Check**: All matched files use Prettier code style\n- **Type Checking (ty)**: All checks passed\n\n### Tests\n- **Unit Tests (erk)**: 5294 passed in 22.13s\n- **Tests (erk-dev)**: 136 passed in 4.36s\n- **Tests (erk-statusline)**: 126 passed in 0.88s\n\n### Documentation\n- **Exec Reference Check**: `.claude/skills/erk-exec/reference.md` is up to date\n- **CLAUDE.md/AGENTS.md Standard**: PASSED\n  - 19 CLAUDE.md files checked\n  - 0 violations\n\n**Total: All checks passed successfully with 5,556 tests passing across all packages.**"}],"totalDurationMs":48992,"totalTokens":13536,"totalToolUseCount":1,"usage":{"input_tokens":6,"cache_creation_input_tokens":1042,"cache_read_input_tokens":12245,"cache_creation":{"ephemeral_5m_input_tokens":1042,"ephemeral_1h_input_tokens":0},"output_tokens":243,"service_tier":"standard","inference_geo":"not_available"}}}
{"parentUuid":"9c5e0e51-7ab0-4b89-826f-ff34f942f939","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01YNoJsxaghpKNHiQyriDiKU","type":"message","role":"assistant","content":[{"type":"text","text":"All CI checks pass. Now let me submit the PR:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":422,"cache_read_input_tokens":118159,"cache_creation":{"ephemeral_5m_input_tokens":422,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5LZM5km4CKbgRkoRQ9","type":"assistant","uuid":"767b05b1-ce2f-400a-9533-91b5d685bb10","timestamp":"2026-02-21T23:23:35.459Z"}
{"parentUuid":"767b05b1-ce2f-400a-9533-91b5d685bb10","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01YNoJsxaghpKNHiQyriDiKU","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SYzPLVjbLzoTEa4mGxZKUB","name":"Bash","input":{"command":"git status","description":"Check git status"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":422,"cache_read_input_tokens":118159,"cache_creation":{"ephemeral_5m_input_tokens":422,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5LZM5km4CKbgRkoRQ9","type":"assistant","uuid":"f31e7b92-b620-4ce3-977d-e7b0a7bae290","timestamp":"2026-02-21T23:23:36.089Z"}
{"parentUuid":"f31e7b92-b620-4ce3-977d-e7b0a7bae290","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SYzPLVjbLzoTEa4mGxZKUB","type":"tool_result","content":"On branch planned/plan-consolidated-docum-02-21-1809\nYour branch is up to date with 'origin/planned/plan-consolidated-docum-02-21-1809'.\n\nChanges not staged for commit:\n  (use \"git add <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   docs/learned/architecture/git-operation-patterns.md\n\tmodified:   docs/learned/architecture/index.md\n\tmodified:   docs/learned/architecture/subprocess-wrappers.md\n\tmodified:   docs/learned/architecture/tripwires.md\n\tmodified:   docs/learned/ci/plan-implement-workflow-patterns.md\n\tmodified:   docs/learned/ci/tripwires.md\n\tmodified:   docs/learned/cli/index.md\n\tmodified:   docs/learned/cli/tripwires.md\n\tmodified:   docs/learned/erk/graphite-divergence-detection.md\n\tmodified:   docs/learned/erk/slot-pool-architecture.md\n\tmodified:   docs/learned/erk/tripwires.md\n\tmodified:   docs/learned/integrations/github-review-decision.md\n\tmodified:   docs/learned/planning/branch-name-inference.md\n\tmodified:   docs/learned/planning/draft-pr-plan-backend.md\n\tmodified:   docs/learned/planning/impl-context.md\n\tmodified:   docs/learned/planning/tripwires.md\n\tmodified:   docs/learned/sessions/discovery-fallback.md\n\tmodified:   docs/learned/sessions/lifecycle.md\n\tmodified:   docs/learned/sessions/tripwires.md\n\tmodified:   docs/learned/tripwires-index.md\n\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n\tdocs/learned/architecture/slot-pool-state-sync.md\n\tdocs/learned/cli/backend-aware-display.md\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")","is_error":false}]},"uuid":"69cefcb0-db0f-4ed9-88d4-63afdd6b0ac0","timestamp":"2026-02-21T23:23:36.547Z","toolUseResult":{"stdout":"On branch planned/plan-consolidated-docum-02-21-1809\nYour branch is up to date with 'origin/planned/plan-consolidated-docum-02-21-1809'.\n\nChanges not staged for commit:\n  (use \"git add <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   docs/learned/architecture/git-operation-patterns.md\n\tmodified:   docs/learned/architecture/index.md\n\tmodified:   docs/learned/architecture/subprocess-wrappers.md\n\tmodified:   docs/learned/architecture/tripwires.md\n\tmodified:   docs/learned/ci/plan-implement-workflow-patterns.md\n\tmodified:   docs/learned/ci/tripwires.md\n\tmodified:   docs/learned/cli/index.md\n\tmodified:   docs/learned/cli/tripwires.md\n\tmodified:   docs/learned/erk/graphite-divergence-detection.md\n\tmodified:   docs/learned/erk/slot-pool-architecture.md\n\tmodified:   docs/learned/erk/tripwires.md\n\tmodified:   docs/learned/integrations/github-review-decision.md\n\tmodified:   docs/learned/planning/branch-name-inference.md\n\tmodified:   docs/learned/planning/draft-pr-plan-backend.md\n\tmodified:   docs/learned/planning/impl-context.md\n\tmodified:   docs/learned/planning/tripwires.md\n\tmodified:   docs/learned/sessions/discovery-fallback.md\n\tmodified:   docs/learned/sessions/lifecycle.md\n\tmodified:   docs/learned/sessions/tripwires.md\n\tmodified:   docs/learned/tripwires-index.md\n\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n\tdocs/learned/architecture/slot-pool-state-sync.md\n\tdocs/learned/cli/backend-aware-display.md\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"69cefcb0-db0f-4ed9-88d4-63afdd6b0ac0","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01MWUxpsrfc5zfu6uJG4UAKk","type":"message","role":"assistant","content":[{"type":"text","text":"I notice `docs/learned/integrations/github-review-decision.md` is also modified — that's unexpected. Let me check what changed there:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":940,"cache_read_input_tokens":118581,"cache_creation":{"ephemeral_5m_input_tokens":940,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5LpAZmYKCchc251jcR","type":"assistant","uuid":"e8bf9dc3-5a1e-4f63-8ef0-aca76f5ec89b","timestamp":"2026-02-21T23:23:39.502Z"}
{"parentUuid":"e8bf9dc3-5a1e-4f63-8ef0-aca76f5ec89b","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01MWUxpsrfc5zfu6uJG4UAKk","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013uRzpmHgvzHuENjPZgxVF2","name":"Bash","input":{"command":"git diff docs/learned/integrations/github-review-decision.md","description":"Check unexpected change"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":940,"cache_read_input_tokens":118581,"cache_creation":{"ephemeral_5m_input_tokens":940,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5LpAZmYKCchc251jcR","type":"assistant","uuid":"24c8196f-0610-4c64-841b-f7ded1e9eb46","timestamp":"2026-02-21T23:23:40.016Z"}
{"parentUuid":"24c8196f-0610-4c64-841b-f7ded1e9eb46","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013uRzpmHgvzHuENjPZgxVF2","type":"tool_result","content":"diff --git a/docs/learned/integrations/github-review-decision.md b/docs/learned/integrations/github-review-decision.md\nindex e7c32e396..0a67b4b00 100644\n--- a/docs/learned/integrations/github-review-decision.md\n+++ b/docs/learned/integrations/github-review-decision.md\n@@ -50,7 +50,7 @@ The `review_decision: str | None` field at `packages/erk-shared/src/erk_shared/g\n \n | `review_decision` value | Indicator added |\n | ----------------------- | --------------- |\n-| `\"APPROVED\"`            | `✔` suffix     |\n+| `\"APPROVED\"`            | `✔` suffix      |\n | `\"CHANGES_REQUESTED\"`   | `❌` suffix     |\n | `\"REVIEW_REQUIRED\"`     | No indicator    |\n | `None`                  | No indicator    |","is_error":false}]},"uuid":"38db4075-25bd-47b1-bfea-6db87b448b42","timestamp":"2026-02-21T23:23:40.456Z","toolUseResult":{"stdout":"diff --git a/docs/learned/integrations/github-review-decision.md b/docs/learned/integrations/github-review-decision.md\nindex e7c32e396..0a67b4b00 100644\n--- a/docs/learned/integrations/github-review-decision.md\n+++ b/docs/learned/integrations/github-review-decision.md\n@@ -50,7 +50,7 @@ The `review_decision: str | None` field at `packages/erk-shared/src/erk_shared/g\n \n | `review_decision` value | Indicator added |\n | ----------------------- | --------------- |\n-| `\"APPROVED\"`            | `✔` suffix     |\n+| `\"APPROVED\"`            | `✔` suffix      |\n | `\"CHANGES_REQUESTED\"`   | `❌` suffix     |\n | `\"REVIEW_REQUIRED\"`     | No indicator    |\n | `None`                  | No indicator    |","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"38db4075-25bd-47b1-bfea-6db87b448b42","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01KRgYZ29SWZpo9Ez87CeAVL","type":"message","role":"assistant","content":[{"type":"text","text":"That's just a whitespace formatting change from prettier. All good. Let me commit and submit:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":376,"cache_read_input_tokens":119521,"cache_creation":{"ephemeral_5m_input_tokens":376,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5M6rQfhf1R87u9gcsp","type":"assistant","uuid":"3fdad701-62d9-46bb-96dd-ae7a2da3e173","timestamp":"2026-02-21T23:23:43.405Z"}
{"parentUuid":"3fdad701-62d9-46bb-96dd-ae7a2da3e173","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01KRgYZ29SWZpo9Ez87CeAVL","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018WhbK8XLmnFQuHUvsw4rEy","name":"Bash","input":{"command":"git add -A && git commit -m \"$(cat <<'EOF'\nConsolidated documentation for Feb 21 learn sessions (batch 2)\n\nConsolidates documentation gaps from plans #7776, #7770, #7769, #7766, #7764.\n\nKey changes:\n- Rewrite session lifecycle docs: gist-based → branch-based storage\n- Fix branch naming: plan- → planned/ prefix consistency\n- New doc: slot pool state sync algorithm (architecture/)\n- New doc: CLI backend-aware display patterns (cli/)\n- Update slot pool architecture with transparent state correction\n- Update draft-pr-plan-backend with impl-context cleanup section\n- Add 8 tripwires across architecture, planning, CI, and erk categories\n- Update discovery-fallback.md gist references to branch-based\n\n🤖 Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Claude <noreply@anthropic.com>\nEOF\n)\"","description":"Commit all documentation changes"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":376,"cache_read_input_tokens":119521,"cache_creation":{"ephemeral_5m_input_tokens":376,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5M6rQfhf1R87u9gcsp","type":"assistant","uuid":"136bcec2-7866-4ac5-aa4c-182a3501ebf7","timestamp":"2026-02-21T23:23:50.019Z"}
{"parentUuid":"136bcec2-7866-4ac5-aa4c-182a3501ebf7","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018WhbK8XLmnFQuHUvsw4rEy","type":"tool_result","content":"[planned/plan-consolidated-docum-02-21-1809 65ca6d801] Consolidated documentation for Feb 21 learn sessions (batch 2)\n 22 files changed, 253 insertions(+), 27 deletions(-)\n create mode 100644 docs/learned/architecture/slot-pool-state-sync.md\n create mode 100644 docs/learned/cli/backend-aware-display.md","is_error":false}]},"uuid":"79900316-5a1e-4e61-a3e5-9dcb94465948","timestamp":"2026-02-21T23:23:51.416Z","toolUseResult":{"stdout":"[planned/plan-consolidated-docum-02-21-1809 65ca6d801] Consolidated documentation for Feb 21 learn sessions (batch 2)\n 22 files changed, 253 insertions(+), 27 deletions(-)\n create mode 100644 docs/learned/architecture/slot-pool-state-sync.md\n create mode 100644 docs/learned/cli/backend-aware-display.md","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"79900316-5a1e-4e61-a3e5-9dcb94465948","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01JZZpi3LYVCNKus6LKfp1TA","type":"message","role":"assistant","content":[{"type":"text","text":"Now submit the PR:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":770,"cache_read_input_tokens":119897,"cache_creation":{"ephemeral_5m_input_tokens":770,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5MukhSD26PbhRhFoKB","type":"assistant","uuid":"10399994-69a3-495c-a574-e36fa85a34cf","timestamp":"2026-02-21T23:23:53.441Z"}
{"parentUuid":"10399994-69a3-495c-a574-e36fa85a34cf","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01JZZpi3LYVCNKus6LKfp1TA","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BeNH6Ht73K6a3n7dmErS9r","name":"Bash","input":{"command":"erk pr submit 2>&1","description":"Submit PR via erk","timeout":120000},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":770,"cache_read_input_tokens":119897,"cache_creation":{"ephemeral_5m_input_tokens":770,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5MukhSD26PbhRhFoKB","type":"assistant","uuid":"c97c86ad-b823-4a67-8e0e-9974e06fcad4","timestamp":"2026-02-21T23:23:54.386Z"}
{"parentUuid":"c97c86ad-b823-4a67-8e0e-9974e06fcad4","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BeNH6Ht73K6a3n7dmErS9r","type":"tool_result","content":"🚀 Submitting PR...\n\nPhase 1: Creating or Updating PR\n   PR #7780 found (already exists)\n\nPhase 2: Getting diff\n\nPhase 3: Fetching plan context\n   Incorporating plan from issue #7780\n\nPhase 4: Generating PR description\n   Reading diff file...\n   Diff loaded (53,921 chars)\n   Analyzing changes with Claude...\n   PR description generated\n\nPhase 5: Graphite enhancement\n\nPhase 6: Updating PR metadata\n   Publishing draft PR...\n   PR metadata updated\n\n✅ \u001b]8;;https://github.com/dagster-io/erk/pull/7780\u001b\\https://github.com/dagster-io/erk/pull/7780\u001b]8;;\u001b\\","is_error":false}]},"uuid":"8ba6c094-3401-44cf-afab-51f29ea88b29","timestamp":"2026-02-21T23:24:10.970Z","toolUseResult":{"stdout":"🚀 Submitting PR...\n\nPhase 1: Creating or Updating PR\n   PR #7780 found (already exists)\n\nPhase 2: Getting diff\n\nPhase 3: Fetching plan context\n   Incorporating plan from issue #7780\n\nPhase 4: Generating PR description\n   Reading diff file...\n   Diff loaded (53,921 chars)\n   Analyzing changes with Claude...\n   PR description generated\n\nPhase 5: Graphite enhancement\n\nPhase 6: Updating PR metadata\n   Publishing draft PR...\n   PR metadata updated\n\n✅ \u001b]8;;https://github.com/dagster-io/erk/pull/7780\u001b\\https://github.com/dagster-io/erk/pull/7780\u001b]8;;\u001b\\","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"8ba6c094-3401-44cf-afab-51f29ea88b29","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01BUdYVwL9E9TGSJtuiKKgWu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QxL4QXucqDqWyYKowqUEsQ","name":"Bash","input":{"command":"erk exec impl-signal submitted 2>/dev/null || true","description":"Signal implementation submitted"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":291,"cache_read_input_tokens":120667,"cache_creation":{"ephemeral_5m_input_tokens":291,"ephemeral_1h_input_tokens":0},"output_tokens":19,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5PMLMW6NoRmY8Xt6gd","type":"assistant","uuid":"272a7ee4-e922-4a97-9d5e-ab242b0dc1e6","timestamp":"2026-02-21T23:24:13.760Z"}
{"parentUuid":"272a7ee4-e922-4a97-9d5e-ab242b0dc1e6","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QxL4QXucqDqWyYKowqUEsQ","type":"tool_result","content":"{\n  \"success\": true,\n  \"event\": \"submitted\",\n  \"issue_number\": 7780\n}","is_error":false}]},"uuid":"55448011-3b65-40a3-b9c0-125ba1095705","timestamp":"2026-02-21T23:24:16.343Z","toolUseResult":{"stdout":"{\n  \"success\": true,\n  \"event\": \"submitted\",\n  \"issue_number\": 7780\n}","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"55448011-3b65-40a3-b9c0-125ba1095705","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01WsdM2YwsScLsCrWh66aQHx","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me run `erk pr check` and signal completion:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":458,"cache_read_input_tokens":120958,"cache_creation":{"ephemeral_5m_input_tokens":458,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5PkKDiq1w6pBTrh6kK","type":"assistant","uuid":"59cb118f-1899-412d-b7c1-18d399cc837a","timestamp":"2026-02-21T23:24:18.871Z"}
{"parentUuid":"59cb118f-1899-412d-b7c1-18d399cc837a","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01WsdM2YwsScLsCrWh66aQHx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FaUQB3fqisKRjXqmnxk5sc","name":"Bash","input":{"command":"erk pr check 2>&1","description":"Validate PR rules"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":458,"cache_read_input_tokens":120958,"cache_creation":{"ephemeral_5m_input_tokens":458,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5PkKDiq1w6pBTrh6kK","type":"assistant","uuid":"70c32559-5413-4a76-bb31-37a7274afad8","timestamp":"2026-02-21T23:24:19.499Z"}
{"parentUuid":"70c32559-5413-4a76-bb31-37a7274afad8","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01WsdM2YwsScLsCrWh66aQHx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019tuniKh3CBupuLCkFUfYBS","name":"Bash","input":{"command":"erk exec impl-signal ended 2>/dev/null || true","description":"Signal implementation ended"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":458,"cache_read_input_tokens":120958,"cache_creation":{"ephemeral_5m_input_tokens":458,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5PkKDiq1w6pBTrh6kK","type":"assistant","uuid":"cf919d64-fe6e-4fb6-9244-58e62b1bea4e","timestamp":"2026-02-21T23:24:19.958Z"}
{"parentUuid":"cf919d64-fe6e-4fb6-9244-58e62b1bea4e","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FaUQB3fqisKRjXqmnxk5sc","type":"tool_result","content":"Checking PR #7780 for branch planned/plan-consolidated-docum-02-21-1809...\n\n[PASS] Branch name and plan reference agree (#7780)\n[PASS] Draft PR plan — no closing reference needed\n[PASS] PR body contains checkout footer\n\nAll checks passed","is_error":false}]},"uuid":"d14136c2-432d-4db6-897b-90d3a6abc7ea","timestamp":"2026-02-21T23:24:21.301Z","toolUseResult":{"stdout":"Checking PR #7780 for branch planned/plan-consolidated-docum-02-21-1809...\n\n[PASS] Branch name and plan reference agree (#7780)\n[PASS] Draft PR plan — no closing reference needed\n[PASS] PR body contains checkout footer\n\nAll checks passed","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"d14136c2-432d-4db6-897b-90d3a6abc7ea","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019tuniKh3CBupuLCkFUfYBS","type":"tool_result","content":"{\n  \"success\": true,\n  \"event\": \"ended\",\n  \"issue_number\": 7780\n}","is_error":false}]},"uuid":"4b560ec6-4ed5-4651-a585-ddc65c1cd440","timestamp":"2026-02-21T23:24:23.596Z","toolUseResult":{"stdout":"{\n  \"success\": true,\n  \"event\": \"ended\",\n  \"issue_number\": 7780\n}","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"4b560ec6-4ed5-4651-a585-ddc65c1cd440","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01567vaxdvCddWE4Lcd25P7v","type":"message","role":"assistant","content":[{"type":"text","text":"All PR checks pass. Let me verify `.impl/` is still preserved:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":651,"cache_read_input_tokens":121416,"cache_creation":{"ephemeral_5m_input_tokens":651,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5QHKnf7MPeeapAKaEn","type":"assistant","uuid":"a5366719-8237-45e7-ad95-8d822b86bbb5","timestamp":"2026-02-21T23:24:27.567Z"}
{"parentUuid":"a5366719-8237-45e7-ad95-8d822b86bbb5","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01567vaxdvCddWE4Lcd25P7v","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016guyxYKjnmJHUssvjUEBEp","name":"Bash","input":{"command":"erk exec impl-verify 2>&1","description":"Final .impl/ verification"},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":651,"cache_read_input_tokens":121416,"cache_creation":{"ephemeral_5m_input_tokens":651,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5QHKnf7MPeeapAKaEn","type":"assistant","uuid":"7fa094a0-1fcf-4ad4-b0e8-ea0c9debed4f","timestamp":"2026-02-21T23:24:28.271Z"}
{"parentUuid":"7fa094a0-1fcf-4ad4-b0e8-ea0c9debed4f","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016guyxYKjnmJHUssvjUEBEp","type":"tool_result","content":"{\"valid\": true, \"impl_dir\": \"/home/runner/work/erk/erk/.impl\"}","is_error":false}]},"uuid":"047fe359-a706-4498-bd3b-b6716a48ee1b","timestamp":"2026-02-21T23:24:29.472Z","toolUseResult":{"stdout":"{\"valid\": true, \"impl_dir\": \"/home/runner/work/erk/erk/.impl\"}","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"047fe359-a706-4498-bd3b-b6716a48ee1b","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01X68PMqRMg6qx2p7bTtJe9E","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019BB5B82c6Nk7zvEkKwykwf","name":"TodoWrite","input":{"todos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"completed","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"completed","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"completed","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"completed","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"completed","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"completed","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"completed","activeForm":"Running CI and submitting PR"}]},"caller":{"type":"direct"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":136,"cache_read_input_tokens":122067,"cache_creation":{"ephemeral_5m_input_tokens":136,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5QiS9DuMsQUhTC8rqr","type":"assistant","uuid":"42262a16-634b-4752-aef5-38ed62979873","timestamp":"2026-02-21T23:24:35.514Z"}
{"parentUuid":"42262a16-634b-4752-aef5-38ed62979873","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019BB5B82c6Nk7zvEkKwykwf","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"08861be2-f4ec-446a-af7a-83d1310d2c7d","timestamp":"2026-02-21T23:24:35.531Z","toolUseResult":{"oldTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"completed","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"completed","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"completed","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"completed","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"completed","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"completed","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"in_progress","activeForm":"Running CI and submitting PR"}],"newTodos":[{"content":"Step 1: Rewrite session lifecycle gist references","status":"completed","activeForm":"Rewriting session lifecycle gist references"},{"content":"Step 2: Fix branch naming inconsistency","status":"completed","activeForm":"Fixing branch naming inconsistency"},{"content":"Step 3: Create lazy pool sync pattern doc","status":"completed","activeForm":"Creating lazy pool sync pattern doc"},{"content":"Step 4: Update slot pool architecture doc","status":"completed","activeForm":"Updating slot pool architecture doc"},{"content":"Step 5: Create CLI backend-aware display pattern doc","status":"completed","activeForm":"Creating CLI backend-aware display pattern doc"},{"content":"Step 6: Update draft-pr-plan-backend.md","status":"completed","activeForm":"Updating draft-pr-plan-backend.md"},{"content":"Step 7: Add tripwires to architecture/tripwires.md","status":"completed","activeForm":"Adding tripwires to architecture/tripwires.md"},{"content":"Step 8: Add tripwires to planning/tripwires.md","status":"completed","activeForm":"Adding tripwires to planning/tripwires.md"},{"content":"Step 9: Add tripwires to ci/tripwires.md","status":"completed","activeForm":"Adding tripwires to ci/tripwires.md"},{"content":"Step 10: Add tripwire to erk/tripwires.md","status":"completed","activeForm":"Adding tripwire to erk/tripwires.md"},{"content":"Run erk docs sync and verify","status":"completed","activeForm":"Running erk docs sync and verifying"},{"content":"Run CI and submit PR","status":"completed","activeForm":"Running CI and submitting PR"}]}}
{"parentUuid":"08861be2-f4ec-446a-af7a-83d1310d2c7d","isSidechain":false,"userType":"external","cwd":"/home/runner/work/erk/erk","sessionId":"7b8354d5-48e1-4b17-bfce-1aecab6f43ce","version":"2.0.67","gitBranch":"planned/plan-consolidated-docum-02-21-1809","slug":"tranquil-sleeping-nova","message":{"model":"claude-opus-4-6","id":"msg_01TVSzoG8FkXeNkxzSxDketw","type":"message","role":"assistant","content":[{"type":"text","text":"Plan execution complete. Here's a summary of what was implemented:\n\n## Summary\n\n**PR:** https://github.com/dagster-io/erk/pull/7780\n**22 files changed**, 253 insertions, 27 deletions\n\n### CRITICAL fixes (stale docs)\n- **Session lifecycle**: Rewrote gist-based persistence to branch-based storage in `lifecycle.md` and `discovery-fallback.md`\n- **Branch naming**: Fixed `plan-` → `planned/` prefix throughout `branch-name-inference.md`\n\n### New documentation\n- **`architecture/slot-pool-state-sync.md`**: Documents the lazy sync algorithm, timing, edge cases, and mtime preservation\n- **`cli/backend-aware-display.md`**: Documents three CLI patterns for backend-aware routing (interface delegation, provider name check, direct comparison)\n\n### Updated documentation\n- **`erk/slot-pool-architecture.md`**: Added transparent state correction section\n- **`planning/draft-pr-plan-backend.md`**: Added impl-context cleanup section and 2 new tripwires\n\n### Tripwires added (8 total)\n- Architecture: sync before allocation (score 9), macOS sed syntax (4), git stash side effects (4)\n- Planning: dual backend service consistency (6), git pull after cleanup (4), gh issue view routing (7)\n- CI: rebase modify/delete conflict resolution (5)\n- Erk: Graphite cache mismatch after raw git (7)"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":563,"cache_read_input_tokens":122203,"cache_creation":{"ephemeral_5m_input_tokens":563,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"global"}},"requestId":"req_011CYN5RAN7V36oeEMDaX5kT","type":"assistant","uuid":"8e375c19-fd04-40e2-9c05-946edceec5b0","timestamp":"2026-02-21T23:24:45.382Z"}
