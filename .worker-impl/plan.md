# Plan: Create Slot Pool Architecture Documentation

## Overview

Create `docs/learned/erk/slot-pool-architecture.md` documenting the worktree slot pool system. All underlying code is fully implemented - this is a documentation-only task.

## Context

The slot pool is a critical architectural component managing reusable pre-allocated worktrees for fast branch switching. Key concepts:

- **Pool size**: Default 4 slots, configurable via `local_config.pool_size`
- **Slot names**: `erk-slot-NN` format (e.g., `erk-slot-01`)
- **Placeholder branches**: `__erk-slot-NN-br-stub__` for unassigned slots
- **Pool persistence**: `~/.erk/repos/{repo_name}/pool.json`

## Implementation Steps

### Step 1: Create the documentation file

**File:** `docs/learned/erk/slot-pool-architecture.md` (NEW)

Structure should include:

```markdown
---
read_when:
  - "understanding slot pool design"
  - "implementing slot-related features"
  - "debugging slot assignment issues"
---

# Slot Pool Architecture

## Overview
[Brief description of the worktree slot pool system]

## Data Structures

### PoolState (`src/erk/core/worktree_pool.py`)
- `pool_size: int` - Number of slots in the pool
- `assignments: list[SlotAssignment]` - Branch-to-slot mappings

### SlotAssignment
- `slot_name: str` - e.g., "erk-slot-01"
- `branch_name: str` - Branch assigned to this slot
- `assigned_at: datetime` - Timestamp for eviction ordering
- `last_objective_issue: int | None` - For objective tracking

### SlotInfo
- Slot metadata with objective tracking

## Key Functions

### Allocation (`src/erk/cli/commands/slot/common.py`)
- `allocate_slot_for_branch()` - Unified entry point (lines 333+)
- `find_inactive_slot()` - Fast path: reuse unassigned slot
- `find_next_available_slot()` - Slow path: create new slot
- `find_oldest_assignment()` - Eviction selection for pool-full

### Assignment Management
- `find_branch_assignment()` - Locate branch in slot
- `handle_pool_full_interactive()` - UX for pool-full with --force

### Cleanup
- `cleanup_worktree_artifacts()` - Cleans .impl/ and .erk/scratch/

## Naming Conventions

| Component | Pattern | Example |
|-----------|---------|---------|
| Slot name | `erk-slot-NN` | `erk-slot-01` |
| Placeholder branch | `__erk-slot-NN-br-stub__` | `__erk-slot-01-br-stub__` |
| Pool state file | `pool.json` | `~/.erk/repos/erk/pool.json` |

## Diagnostics & Repair

### Issue Types (`src/erk/cli/commands/slot/diagnostics.py`)
1. `orphan-state` - Assignment in pool.json but no worktree
2. `orphan-dir` - Worktree exists but not in pool.json
3. `missing-branch` - Assigned branch doesn't exist
4. `branch-mismatch` - Worktree on different branch than assigned
5. `git-registry-missing` - Worktree not in git's registry
6. `untracked-worktree` - Worktree in git but not erk-managed

### Repair (`src/erk/cli/commands/slot/repair_cmd.py`)
- Auto-fix stale assignments

## Entry Points

Commands that allocate slots:
- `erk branch create`
- `erk slot assign`
- `erk plan start`
- `erk implement`
- `erk pr checkout`

## See Also

- [worktree_pool.py](../../../src/erk/core/worktree_pool.py)
- [slot/common.py](../../../src/erk/cli/commands/slot/common.py)
```

### Step 2: Regenerate index

After creating the file, run:
```bash
erk docs sync
```

This will regenerate `docs/learned/erk/index.md` with the new file.

## Files to Create/Modify

| File | Change |
|------|--------|
| `docs/learned/erk/slot-pool-architecture.md` | NEW - Complete documentation |
| `docs/learned/erk/index.md` | AUTO - Regenerated by `erk docs sync` |

## Verification

1. Check file exists: `cat docs/learned/erk/slot-pool-architecture.md`
2. Run `erk docs sync` to update index
3. Verify index updated: `grep slot-pool docs/learned/erk/index.md`
4. Run prettier via devrun: `prettier --check docs/learned/erk/`