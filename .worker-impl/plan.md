# Documentation Plan: Activation Script System

## Context

This PR introduces a new activation script system for worktrees as part of Objective #4954 (Make Shell Integration Opt-In). The system generates `.erk/activate.sh` scripts that can be sourced to set up a worktree environment.

**Key files:**
- `src/erk/cli/activation.py` - Core module with script generation and writing functions
- `src/erk/cli/commands/wt/create_cmd.py` - Integration points in worktree creation

**Related objective:** https://github.com/dagster-io/erk/issues/4954

## Raw Materials

https://gist.github.com/schrockn/0bd3c3656b1e4a4f743580df8c751d85

## Documentation Items

### 1. Activation Script System Overview

**Location:** `docs/learned/cli/activation-scripts.md`
**Action:** Create new document

**Draft content:**
```markdown
# Activation Scripts

## Overview

Erk generates `.erk/activate.sh` scripts in worktrees to provide a shell-sourceable environment setup. This enables opt-in shell integration where users explicitly source the script rather than relying on automatic shell manipulation.

## What the Script Does

When sourced, `.erk/activate.sh`:
1. CDs to the worktree directory
2. Creates `.venv` with `uv sync` if not present
3. Sources `.venv/bin/activate` if present
4. Loads `.env` file (using `set -a` for allexport)
5. Runs configured post-create commands
6. Displays activation confirmation

## Key Functions

- `render_activation_script()` - Generates script content (used for navigation too)
- `write_worktree_activate_script()` - Writes `.erk/activate.sh`, creates directory if needed
- `ensure_worktree_activate_script()` - Idempotent version (create only if missing)

## When Scripts Are Generated

Scripts are generated during worktree creation:
- `erk wt create` - writes script after creating worktree
- `run_post_worktree_setup()` - shared function for all worktree creation paths

## Configuration

Post-create commands from `.erk/config.toml` are embedded in the script:

```toml
[post_create]
shell = "bash"
commands = [
  "uv run make dev_install",
]
```

## Transparency Logging

Scripts include `__erk_log()` helpers respecting:
- `ERK_QUIET=1` - Suppresses output
- `ERK_VERBOSE=1` - Shows detailed paths
```

**Source:** [Impl] - Direct implementation in activation.py

### 2. Speculative Feature Pattern

**Location:** `docs/learned/conventions.md` (update existing)
**Action:** Add new section

**Draft content:**
```markdown
## Speculative Feature Pattern

For features that may be removed, use this pattern for easy reversal:

1. **Feature constant** at module top:
   ```python
   # SPECULATIVE: feature-name - set to False to disable
   ENABLE_FEATURE_NAME = True
   ```

2. **Guard call sites** with the constant:
   ```python
   # SPECULATIVE: feature-name - description
   if ENABLE_FEATURE_NAME:
       do_speculative_thing()
   ```

3. **Document in module docstring:**
   ```python
   """Module description.

   SPECULATIVE: feature-name (objective #XXXX)
   This feature is speculative. Set ENABLE_FEATURE_NAME to False to disable.
   Grep for "SPECULATIVE: feature-name" to find all related code.
   """
   ```

**To disable:** Set constant to `False`
**To find all code:** `grep -r "SPECULATIVE: feature-name" src/`
**To remove:** Delete the module and guarded blocks
```

**Source:** [Impl] - Pattern added during this session

### 3. Glossary Entry

**Location:** `docs/learned/glossary.md`
**Action:** Add entry

**Draft content:**
```markdown
### activate.sh

A shell script at `.erk/activate.sh` in each worktree that sets up the development environment when sourced. Generated by `write_worktree_activate_script()`. See [Activation Scripts](cli/activation-scripts.md).
```

**Source:** [Impl] - New concept introduced